/*
 * xeoEngine V0.1.0
 *
 * A WebGL-based 3D visualization engine from xeoLabs
 * http://xeoengine.org/
 *
 * Built on 2016-04-20
 *
 * MIT License
 * Copyright 2016, Lindsay Kay
 * http://xeolabs.com/
 *
 */

!function(){"use strict";var a=function(){this.version=null,this.WEBGL_INFO=function(){var a={WEBGL:!1},b=document.createElement("canvas");if(!b)return a;var c=b.getContext("webgl",{antialias:!0})||b.getContext("experimental-webgl",{antialias:!0});return a.WEBGL=!!c,a.WEBGL?(a.ANTIALIAS=c.getContextAttributes().antialias,c.getShaderPrecisionFormat?c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.HIGH_FLOAT).precision>0?a.FS_MAX_FLOAT_PRECISION="highp":c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.MEDIUM_FLOAT).precision>0?a.FS_MAX_FLOAT_PRECISION="mediump":a.FS_MAX_FLOAT_PRECISION="lowp":a.FS_MAX_FLOAT_PRECISION="mediump",a.DEPTH_BUFFER_BITS=c.getParameter(c.DEPTH_BITS),a.MAX_TEXTURE_SIZE=c.getParameter(c.MAX_TEXTURE_SIZE),a.MAX_CUBE_MAP_SIZE=c.getParameter(c.MAX_CUBE_MAP_TEXTURE_SIZE),a.MAX_RENDERBUFFER_SIZE=c.getParameter(c.MAX_RENDERBUFFER_SIZE),a.MAX_TEXTURE_UNITS=c.getParameter(c.MAX_COMBINED_TEXTURE_IMAGE_UNITS),a.MAX_VERTEX_ATTRIBS=c.getParameter(c.MAX_VERTEX_ATTRIBS),a.MAX_VERTEX_UNIFORM_VECTORS=c.getParameter(c.MAX_VERTEX_UNIFORM_VECTORS),a.MAX_FRAGMENT_UNIFORM_VECTORS=c.getParameter(c.MAX_FRAGMENT_UNIFORM_VECTORS),a.MAX_VARYING_VECTORS=c.getParameter(c.MAX_VARYING_VECTORS),a.SUPPORTED_EXTENSIONS={},c.getSupportedExtensions().forEach(function(b){a.SUPPORTED_EXTENSIONS[b]=!0}),a):a}(),this.stats={build:{version:a.version},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,entities:0},memory:{meshes:0,positions:0,colors:0,normals:0,tangents:0,uvs:0,indices:0,textures:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,setUniform:0,setUniformCacheHits:0,bindTexture:0,bindArray:0,drawElements:0,drawChunks:0}},this._sceneIDMap=null,this._scene=null,this.scenes={},this._taskQueue=[];var b=this;!function(){function a(){g=Date.now(),b._runScheduledTasks(g+k),j.time=g;for(h in b.scenes)b.scenes.hasOwnProperty(h)&&(i=b.scenes[h],j.sceneId=h,j.startTime=i.startTime,j.deltaTime=null!=j.prevTime?j.time-j.prevTime:0,i.fire("tick",j,!0));j.prevTime=g}function c(){var a=b.scenes;for(h in a)a.hasOwnProperty(h)&&a[h].render()}var d,e,f,g,h,i,j={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},k=8,l=0,m=[],n=30,o=0,p=function(){d=Date.now(),l>0&&(e=d-l,f=1e3/e,o+=f,m.push(f),m.length>=n&&(o-=m.shift()),b.stats.frame.fps=Math.round(o/m.length)),a(),c(),l=d,window.requestAnimationFrame(p)};window.requestAnimationFrame(p)}()};a.prototype={constructor:a,get scene(){return this._scene||(this._scene=new window.XEO.Scene({id:"default.scene"}))},_addScene:function(b){if(this._sceneIDMap=this._sceneIDMap||new window.XEO.utils.Map,b.id){if(this.scenes[b.id])return void console.error("[ERROR] Scene "+a._inQuotes(b.id)+" already exists")}else b.id=this._sceneIDMap.addItem(b);this.scenes[b.id]=b;var c=this;b.on("destroyed",function(){c._sceneIDMap.removeItem(b.id),delete c.scenes[b.id]})},scheduleTask:function(a,b){this._taskQueue.push(a),this._taskQueue.push(b)},deferTask:function(a,b){b?a.call(b):a()},_runScheduledTasks:function(a){for(var b,c,d=(new Date).getTime(),e=this._taskQueue;e.length>0&&a>d;)b=e.shift(),c=e.shift(),c?b.call(c):b(),d=(new Date).getTime()},clear:function(){var a;for(var b in this.scenes)this.scenes.hasOwnProperty(b)&&(a=this.scenes[b],"default.scene"===b?a.clear():a.destroy());this.scenes={}},_isArray:function(a){return a&&!a.propertyIsEnumerable("length")&&"object"==typeof a&&"number"==typeof a.length},_isString:function(a){return"string"==typeof a||a instanceof String},_isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},_isID:function(b){return a._isString(b)||a._isNumeric(b)},_isSameComponent:function(b,c){if(!b||!c)return!1;var d=a.prototype._isNumeric(b)||a.prototype._isString(b)?""+b:b.id,e=a.prototype._isNumeric(c)||a.prototype._isString(c)?""+c:c.id;return d===e},_isFunction:function(a){return"function"==typeof a},_copy:function(a){return this._apply(a,{})},_apply:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_apply2:function(a,b){for(var c in a)a.hasOwnProperty(c)&&void 0!==a[c]&&null!==a[c]&&(b[c]=a[c]);return b},_applyIf:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(void 0===b[c]||null===b[c])&&(b[c]=a[c]);return b},_isEmptyObject:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},_inQuotes:function(a){return this._isNumeric(a)?""+a:"'"+a+"'"}},window.XEO=window.XEO=new a}();var Canvas2Image=function(){var a=document.createElement("canvas"),b=String.fromCharCode,c="image/octet-stream",d=!1;if(!a.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var e=!!a.getContext("2d").getImageData,f=!!a.toDataURL,g=!!window.btoa,h=function(a){var b=parseInt(a.width),c=parseInt(a.height);return a.getContext("2d").getImageData(0,0,b,c)},i=function(a){var c,d,e="";if("string"==typeof a)e=a;else for(d=a,c=0;c<d.length;c++)e+=b(d[c]);return btoa(e)},j=function(a){var c="",d=a.width,e=a.height;c+="BM";var f=d*e*4+54;c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),c+=b(0,0,0,0,54,0,0,0),c+=b(40,0,0,0);var g=d;c+=b(g%256),g=Math.floor(g/256),c+=b(g%256),g=Math.floor(g/256),c+=b(g%256),g=Math.floor(g/256),c+=b(g%256);var h=e;c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),c+=b(1,0,32,0),c+=b(0,0,0,0);var j=d*e*4;c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),c+=b(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var k,l,m,n,o=a.data,p="",q=e;do{for(m=d*(q-1)*4,n="",k=0;d>k;k++)l=4*k,n+=b(o[m+l+2],o[m+l+1],o[m+l],o[m+l+3]);p+=n}while(--q);return i(c+p)},k=function(a){window.open(a)||(document.location.href=a)},l=function(a,b){return"data:"+b+";base64,"+a},m=function(a){var b=document.createElement("img");return b.src=a,b},n=function(a,b,c){if(b&&c){var d=document.createElement("canvas");d.width=b,d.height=c,d.style.width=b+"px",d.style.height=c+"px";var e=d.getContext("2d");return e.drawImage(a,0,0,a.width,a.height,0,0,b,b),d}return a};return{saveAsPNG:function(a,b,e,g){if(!f)return!1;var h=n(a,e,g),i="image/png",j=h.toDataURL(i);return b?m(j):(k(d?j.replace(i,c):j),!0)},saveAsJPEG:function(a,b,e,g){if(!f)return!1;var h=n(a,e,g),i="image/jpeg",j=h.toDataURL(i);return 5!=j.indexOf(i)?!1:b?m(j):(k(d?j.replace(i,c):j),!0)},saveAsBMP:function(a,b,c,d){if(!(f&&e&&g))return!1;var i=n(a,c,d),o="image/bmp",p=h(i),q=j(p);return b?m(l(q,o)):(k(l(q,o)),!0)}}}();!function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){!a&&this.__init&&this.__init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)if("_props"!==g)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];else{var h,i=c[g];for(var j in i)h=i[j],h.set||!function(){var a=j;h.set=function(){this.warn("Property '"+a+"' is read-only, ignoring assignment")}}(),h.enumerable=!0,Object.defineProperty(f,j,h)}return c.type&&(f.superTypes=e.superTypes?e.superTypes.concat(e.type):[]),d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(),function(){"use strict";XEO.utils=XEO.utils||{},XEO.utils.Map=function(a,b){this.items=a||[],b=b||0;var c=b+1;this.addItem=function(){var a;if(2===arguments.length){var b=arguments[0];if(a=arguments[1],this.items[b])throw"ID clash: '"+b+"'";return this.items[b]=a,b}for(;;){a=arguments[0]||{};var d=c++;if(!this.items[d])return this.items[d]=a,d}},this.removeItem=function(a){var b=this.items[a];return delete this.items[a],b}}}(),function(){"use strict";XEO.renderer=XEO.renderer||{},XEO.renderer.Renderer=function(a,b){this.stats=a||{},this._canvas=b.canvas,this._programFactory=new XEO.renderer.ProgramFactory(this.stats,{canvas:b.canvas}),this._objectFactory=new XEO.renderer.ObjectFactory,this._chunkFactory=new XEO.renderer.ChunkFactory,this._extraChunks=[],this._numExtraChunks=0,this.transparent=b.transparent===!0,this.objects={},this._ambient=null,this._objectList=[],this._objectListLen=0,this._objectPickList=[],this._objectPickListLen=0,this._drawChunkList=[],this._drawChunkListLen=0,this._pickObjectChunkList=[],this._pickObjectChunkListLen=0,this._frameCtx={pickObjects:[],canvas:this._canvas},this.visibility=null,this.cull=null,this.modes=null,this.layer=null,this.stage=null,this.depthBuf=null,this.colorBuf=null,this.lights=null,this.material=null,this.reflect=null,this.modelTransform=null,this.viewTransform=null,this.projTransform=null,this.billboard=null,this.stationary=null,this.colorTarget=null,this.depthTarget=null,this.clips=null,this.morphTargets=null,this.shader=null,this.shaderParams=null,this.geometry=null,this.viewport=null,this.objectListDirty=!0,this.stateOrderDirty=!0,this.stateSortDirty=!0,this.drawListDirty=!0,this.imageDirty=!0},XEO.renderer.Renderer.prototype.webglRestored=function(){this._programFactory.webglRestored(),this._chunkFactory.webglRestored();var a=this._canvas.gl;this.pickBuf&&this.pickBuf.webglRestored(a),this.imageDirty=!0},XEO.renderer.Renderer.prototype.buildObject=function(a){var b=this.objects[a];b||(b=this._objectFactory.get(a)),b.stage=this.stage,b.layer=this.layer,b.colorTarget=this.colorTarget,b.depthTarget=this.depthTarget,b.material=this.material,b.reflect=this.reflect,b.geometry=this.geometry,b.visibility=this.visibility,b.cull=this.cull,b.modes=this.modes,b.billboard=this.billboard,b.stationary=this.stationary,b.viewport=this.viewport;var c=[this.geometry.hash,this.shader.hash,this.clips.hash,this.material.hash,this.lights.hash,this.billboard.hash,this.stationary.hash].join(";");b.program&&c===b.hash||(b.program&&this._programFactory.put(b.program),b.program=this._programFactory.get(c,this),b.hash=c);var d=b.program;if(d){var e=d.program;if(!(e.allocated&&e.compiled&&e.validated&&e.linked))return this.objects[a]&&this.removeObject(a),{error:!0,errorLog:e.errorLog}}return this._setChunk(b,0,"program",b.program),this._setChunk(b,1,"modelTransform",this.modelTransform),this._setChunk(b,2,"viewTransform",this.viewTransform),this._setChunk(b,3,"projTransform",this.projTransform),this._setChunk(b,4,"modes",this.modes),this._setChunk(b,5,"shader",this.shader),this._setChunk(b,6,"shaderParams",this.shaderParams),this._setChunk(b,7,"depthBuf",this.depthBuf),this._setChunk(b,8,"colorBuf",this.colorBuf),this._setChunk(b,9,"lights",this.lights),this._setChunk(b,10,this.material.type,this.material),this._setChunk(b,11,"clips",this.clips),this._setChunk(b,12,"viewport",this.viewport),this._setChunk(b,13,"geometry",this.geometry),this._setChunk(b,14,"draw",this.geometry,!0),this.objects[a]?this.stateOrderDirty=!0:(this.objects[a]=b,this.objectListDirty=!0),b},XEO.renderer.Renderer.prototype._setChunk=function(a,b,c,d,e){var f,g=this._chunkFactory.types[c];f="program"===c?1e8*(a.program.id+1):g.constructor.prototype.programGlobal?d.id:1e8*(a.program.id+1)+(d.id+1),e&&(f*=1e5);var h=a.chunks[b];h&&this._chunkFactory.putChunk(h),a.chunks[b]=this._chunkFactory.getChunk(f,c,a.program.program,d),"lights"===c&&this._setAmbient(d)},XEO.renderer.Renderer.prototype._setAmbient=function(a){for(var b,c=a.lights,d=0,e=c.length;e>d;d++)b=c[d],"ambient"===b.type&&(this._ambient=b)},XEO.renderer.Renderer.prototype.removeObject=function(a){var b=this.objects[a];if(b){for(var c=b.chunks,d=0,e=c.length;e>d;d++)this._chunkFactory.putChunk(c[d]);this._programFactory.put(b.program),b.program=null,b.hash=null,this._objectFactory.put(b),delete this.objects[a],this.objectListDirty=!0}},XEO.renderer.Renderer.prototype.render=function(a){a=a||{},this.objectListDirty&&(this._buildObjectList(),this.objectListDirty=!1,this.stateOrderDirty=!0),this.stateOrderDirty&&(this._makeStateSortKeys(),this.stateOrderDirty=!1,this.stateSortDirty=!0),this.stateSortDirty&&(this._stateSort(),this.stateSortDirty=!1,this.drawListDirty=!0),this.drawListDirty&&(this._buildDrawList(),this.imageDirty=!0),(this.imageDirty||a.force)&&(this._doDrawList({clear:a.clear!==!1}),this.stats.frame.frameCount++,this.imageDirty=!1)},XEO.renderer.Renderer.prototype._buildObjectList=function(){this._objectListLen=0;for(var a in this.objects)this.objects.hasOwnProperty(a)&&(this._objectList[this._objectListLen++]=this.objects[a])},XEO.renderer.Renderer.prototype._makeStateSortKeys=function(){for(var a,b=0,c=this._objectListLen;c>b;b++)a=this._objectList[b],a.program?a.sortKey=1e16*(a.stage.priority+1)+1e14*(a.modes.transparent?2:1)+1e13*(a.layer.priority+1)+1e8*(a.program.id+1)+1e4*(a.material.id+1)+a.geometry.id:a.sortKey=-1},XEO.renderer.Renderer.prototype._stateSort=function(){this._objectList.length=this._objectListLen,this._objectList.sort(function(a,b){return a.sortKey-b.sortKey})},XEO.renderer.Renderer.prototype._logObjectList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._objectListLen+" objects");for(var a=0,b=this._objectListLen;b>a;a++){var c=this._objectList[a];console.log("XEO.Renderer : object["+a+"] sortKey = "+c.sortKey)}console.log("--------------------------------------------------------------------------------------------------")},XEO.renderer.Renderer.prototype._buildDrawList=function(){this._clearExtraChunks(),this._lastDrawChunkId=this._lastDrawChunkId||[],this._lastPickObjectChunkId=this._lastPickObjectChunkId||[];var a,b;for(a=0;20>a;a++)this._lastDrawChunkId[a]=null,this._lastPickObjectChunkId[a]=null;this._drawChunkListLen=0,this._pickObjectChunkListLen=0;var c,d,e,f,g,h,i,j={},k=[],l=[];for(this._objectDrawList=this._objectDrawList||[],this._objectDrawListLen=0,this._objectPickListLen=0,a=0,b=this._objectListLen;b>a;a++)c=this._objectList[a],c.cull.culled!==!0&&c.visibility.visible!==!1&&(d=c.colorTarget?c.colorTarget.renderBuf:null,e=c.depthTarget?c.depthTarget.renderBuf:null,d?(f=c.colorTarget,h=j[f.id],h||(h=[],j[f.id]=h,k.push(h),i=-this._numExtraChunks,g=this._chunkFactory.getChunk(i,"renderTarget",c.program.program,f),this._extraChunks[this._numExtraChunks++]=g,l.push(g)),h.push(c)):e?(f=c.depthTarget,h=j[f.id],h||(h=[],j[f.id]=h,k.push(h),i=-this._numExtraChunks,g=this._chunkFactory.getChunk(i,"renderTarget",c.program.program,f),this._extraChunks[this._numExtraChunks++]=g,l.push(g)),h.push(c)):this._objectDrawList[this._objectDrawListLen++]=c);var m,n=!1;for(a=0,b=k.length;b>a;a++){g=l[a],h=k[a],this._appendRenderTargetChunk(g);for(var o=0,p=h.length;p>o;o++)c=h[o],m=c.stage&&c.stage.pickable,this._appendObjectToDrawChunkLists(c,m),n=!0}for(n&&(i=-1e3*this._numExtraChunks,this._appendRenderTargetChunk(this._chunkFactory.getChunk(i,"renderTarget",c.program.program,{})),this._extraChunks[this._numExtraChunks++]=g),a=0,b=this._objectDrawListLen;b>a;a++)c=this._objectDrawList[a],m=!c.stage||c.stage&&c.stage.pickable,this._appendObjectToDrawChunkLists(c,m);this.drawListDirty=!1},XEO.renderer.Renderer.prototype._clearExtraChunks=function(){for(var a=0,b=this._numExtraChunks;b>a;a++)this._chunkFactory.putChunk(this._extraChunks[a]);this._numExtraChunks=0},XEO.renderer.Renderer.prototype._appendRenderTargetChunk=function(a){this._drawChunkList[this._drawChunkListLen++]=a},XEO.renderer.Renderer.prototype._appendObjectToDrawChunkLists=function(a,b){b=b&&a.modes.pickable;for(var c,d=a.chunks,e=0,f=d.length;f>e;e++)c=d[e],c&&(c.draw&&(c.unique||this._lastDrawChunkId[e]!==c.id)&&(this._drawChunkList[this._drawChunkListLen++]=c,this._lastDrawChunkId[e]=c.id),c.pickObject&&b&&(c.unique||this._lastPickObjectChunkId[e]!==c.id)&&(this._pickObjectChunkList[this._pickObjectChunkListLen++]=c,this._lastPickObjectChunkId[e]=c.id));b&&(this._objectPickList[this._objectPickListLen++]=a)},XEO.renderer.Renderer.prototype._logDrawList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._drawChunkListLen+" draw list chunks");for(var a=0,b=this._drawChunkListLen;b>a;a++){var c=this._drawChunkList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" type = renderTarget")}}console.log("--------------------------------------------------------------------------------------------------")},XEO.renderer.Renderer.prototype._logPickList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._pickObjectChunkListLen+" pick list chunks");for(var a=0,b=this._pickObjectChunkListLen;b>a;a++){var c=this._pickObjectChunkList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" type = renderTarget")}}console.log("--------------------------------------------------------------------------------------------------")},XEO.renderer.Renderer.prototype.pick=function(a){var b=this._canvas.gl,c=null,d=a.canvasPos[0],e=a.canvasPos[1],f=this.pickBuf;f||(f=new XEO.renderer.webgl.RenderBuffer({gl:this._canvas.gl,canvas:this._canvas.canvas}),this.pickBuf=f),this.render(),f.bind(),f.clear(),this._doDrawList({pickObject:!0,clear:!0});var g=f.read(d,e),h=g[0]+256*g[1]+65536*g[2];h=h>=1?h-1:-1;var i=this._objectPickList[h];if(i&&(c={entity:i.id,canvasPos:[d,e]},a.rayPick)){f.clear(),this._doDrawList({rayPick:!0,object:i,clear:!0}),b.finish(),g=f.read(d,e);var j=g[0]+256*g[1]+256*g[2]*256+256*g[3]*256*256;j*=3,c.primitiveIndex=j}return f.unbind(),c},XEO.renderer.Renderer.prototype._doDrawList=function(a){var b,c,d,e=this._canvas.gl,f=this._ambient;if(f){var g=f.color,h=f.intensity;d=[g[0]*h,g[1]*h,g[2]*h,1]}else d=[0,0,0];var i=this._frameCtx;if(i.renderTarget=null,i.renderBuf=null,i.depthbufEnabled=null,i.clearDepth=null,i.depthFunc=e.LESS,i.blendEnabled=!1,i.backfaces=!0,i.frontface=!0,i.pickIndex=0,i.textureUnit=0,i.transparent=!1,i.ambientColor=d,i.drawElements=0,i.useProgram=0,i.bindTexture=0,i.bindArray=0,XEO.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&e.getExtension("OES_element_index_uint"),this.stats.frame.setUniform=0,this.stats.frame.setUniformCacheHits=0,e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.enable(e.DEPTH_TEST),this.transparent||a.pickObject||a.rayPick?e.clearColor(0,0,0,0):e.clearColor(d[0],d[1],d[2],1),a.clear&&e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.frontFace(e.CCW),e.disable(e.CULL_FACE),e.disable(e.BLEND),a.pickObject)for(b=0,c=this._pickObjectChunkListLen;c>b;b++)this._pickObjectChunkList[b].pickObject(i);else if(a.rayPick){if(a.object){var j,k=a.object.chunks;for(b=0,c=k.length;c>b;b++)j=k[b],j.pickPrimitive&&j.pickPrimitive(i)}}else{var l=(new Date).getTime();for(b=0,c=this._drawChunkListLen;c>b;b++)this._drawChunkList[b].draw(i);var m=(new Date).getTime();this.stats.frame.renderTime=(m-l)/1e3,this.stats.frame.drawElements=i.drawElements,this.stats.frame.useProgram=i.useProgram,this.stats.frame.bindTexture=i.bindTexture,this.stats.frame.bindArray=i.bindArray}e.flush(),i.renderBuf&&i.renderBuf.unbind();for(var n=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),o=0;n>o;++o)e.activeTexture(e.TEXTURE0+o),e.bindTexture(e.TEXTURE_CUBE_MAP,null),e.bindTexture(e.TEXTURE_2D,null);this.stats.frame.drawChunks=this._drawChunkListLen},XEO.renderer.Renderer.prototype.destroy=function(){this._programFactory.destroy()}}(),function(){"use strict";XEO.renderer=XEO.renderer||{},XEO.renderer.State=Class.extend({__init:function(a){this.id=this._ids.addItem({}),this.hash=a.hash||""+this.id;for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])},destroy:function(){this._ids.removeItem(this.id)}}),XEO.renderer.Visibility=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Cull=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Modes=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Layer=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Stage=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.DepthBuf=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.ColorBuf=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Lights=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.PhongMaterial=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Reflect=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.ModelTransform=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.ViewTransform=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.ProjTransform=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Billboard=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Stationary=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.RenderTarget=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.RenderTarget.DEPTH=0,XEO.renderer.RenderTarget.COLOR=1,XEO.renderer.Clips=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.MorphTargets=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Shader=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.ShaderParams=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Texture=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Fresnel=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Geometry=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.ProgramState=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Viewport=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})})}(),function(){"use strict";XEO.renderer.Object=function(a){this.id=a,this.hash=null,this.sortKey=null,this.chunks=[],this.program=null,this.stage=null,this.modes=null,this.layer=null,this.material=null}}(),function(){"use strict";XEO.renderer.ObjectFactory=function(){var a=[],b=0;this.get=function(c){var d;return b>0?(d=a[--b],d.id=c,d):new XEO.renderer.Object(c)},this.put=function(c){a[b++]=c}}}(),function(){"use strict";XEO.renderer=XEO.renderer||{},XEO.renderer.Program=function(a,b,c,d){this.stats=a,this.hash=c.hash,this.source=c,this.gl=d,this.draw=null,this.pickObject=null,this.pickPrimitive=null,this.useCount=0,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.build(d)},XEO.renderer.Program.prototype.build=function(a){return this.gl=a,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.draw=new XEO.renderer.webgl.Program(this.stats,a,this.source.vertexDraw,this.source.fragmentDraw),this.pickObject=new XEO.renderer.webgl.Program(this.stats,a,this.source.vertexPickObject,this.source.fragmentPickObject),this.pickPrimitive=new XEO.renderer.webgl.Program(this.stats,a,this.source.vertexPickPrimitive,this.source.fragmentPickPrimitive),this.draw.allocated?this.pickObject.allocated?this.pickPrimitive.allocated?(this.allocated=!0,this.draw.compiled?this.pickObject.compiled?this.pickPrimitive.compiled?(this.compiled=!0,this.draw.linked?this.pickObject.linked?this.pickPrimitive.linked?(this.linked=!0,this.draw.validated?this.pickObject.validated?this.pickPrimitive.validated?void(this.validated=!0):void(this.errorLog=["Primitive-picking program failed to validate"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to validate"].concat(this.pickObject.errorLog)):void(this.errorLog=["Draw program failed to validate"].concat(this.draw.errorLog))):void(this.errorLog=["Primitive-picking program failed to link"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to link"].concat(this.pickObject.errorLog)):void(this.errorLog=["Draw program failed to link"].concat(this.draw.errorLog))):void(this.errorLog=["Primitive-picking program failed to compile"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to compile"].concat(this.pickObject.errorLog)):void(this.errorLog=["Draw program failed to compile"].concat(this.draw.errorLog))):void(this.errorLog=["Primitive-picking program failed to allocate"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to allocate"].concat(this.pickObject.errorLog)):void(this.errorLog=["Draw program failed to allocate"].concat(this.draw.errorLog))}}(),function(){"use strict";XEO.renderer.ProgramFactory=function(a,b){this.stats=a,this._canvas=b.canvas,this._programStates={}},XEO.renderer.ProgramFactory.prototype.get=function(a,b){var c=this._programStates[a];if(!c){var d=XEO.renderer.ProgramSourceFactory.getSource(a,b),e=new XEO.renderer.Program(this.stats,a,d,this._canvas.gl);c=new XEO.renderer.ProgramState({program:e,useCount:1}),this._programStates[a]=c,this.stats.memory.programs++}return c.useCount++,c},XEO.renderer.ProgramFactory.prototype.put=function(a){var b=a.program;--b.useCount<=0&&(b.draw.destroy(),b.pickObject.destroy(),b.pickPrimitive.destroy(),XEO.renderer.ProgramSourceFactory.putSource(b.hash),delete this._programStates[b.hash],this.stats.memory.programs--)},XEO.renderer.ProgramFactory.prototype.webglRestored=function(){var a=this._canvas.gl;for(var b in this._programStates)this._programStates.hasOwnProperty(b)&&this._programStates[b].build(a)},XEO.renderer.ProgramFactory.prototype.destroy=function(){}}(),function(){"use strict";XEO.renderer.ProgramSource=function(a,b,c,d,e,f,g){this.hash=a,this.vertexPickObject=b,this.fragmentPickObject=c,this.vertexPickPrimitive=d,this.fragmentPickPrimitive=e,this.vertexDraw=f,this.fragmentDraw=g,this.useCount=0}}(),function(){"use strict";XEO.renderer.ProgramSourceFactory=new function(){function a(){if(!p.geometry.uv)return!1;var a=p.material;return a.ambientMap||a.diffuseMap||a.specularMap||a.emissiveMap||a.opacityMap||a.reflectivityMap||p.material.normalMap}function b(){return!1}function c(){var a=p.geometry.primitiveName;return!p.geometry.normals||"triangles"!==a&&"triangle-strip"!==a&&"triangle-fan"!==a?!1:!0}function d(){var a=p.geometry;return a.positions&&a.indices&&a.normals&&a.uv&&p.material.normalMap}function e(){return k(),l("// Object picking vertex shader"),l("attribute vec3 xeo_aPosition;"),l("uniform mat4 xeo_uModelMatrix;"),l("uniform mat4 xeo_uViewMatrix;"),l("uniform mat4 xeo_uViewNormalMatrix;"),l("uniform mat4 xeo_uProjMatrix;"),l("varying vec4 xeo_vWorldPosition;"),l("varying vec4 xeo_vViewPosition;"),l("void main(void) {"),l("   vec4 tmpVertex = vec4(xeo_aPosition, 1.0); "),l("   xeo_vWorldPosition = xeo_uModelMatrix * tmpVertex; "),l("   xeo_vViewPosition = xeo_uViewMatrix * xeo_vWorldPosition;"),l("   gl_Position = xeo_uProjMatrix * xeo_vViewPosition;"),l("}"),n()}function f(){return k(),l("// Object picking fragment shader"),l("precision "+o(p._canvas.gl)+" float;"),l("uniform vec4 xeo_uPickColor;"),l("void main(void) {"),l("   gl_FragColor = xeo_uPickColor; "),l("}"),n()}function g(){return k(),l("// Triangle picking vertex shader"),l("attribute vec3 xeo_aPosition;"),l("attribute vec4 xeo_aColor;"),l("uniform vec3 xeo_uPickColor;"),l("uniform mat4 xeo_uModelMatrix;"),l("uniform mat4 xeo_uViewMatrix;"),l("uniform mat4 xeo_uProjMatrix;"),l("varying vec4 xeo_vWorldPosition;"),l("varying vec4 xeo_vViewPosition;"),l("varying vec4 xeo_vColor;"),l("void main(void) {"),l("   vec4 tmpVertex = vec4(xeo_aPosition, 1.0); "),l("   vec4 worldPosition = xeo_uModelMatrix * tmpVertex; "),l("   vec4 viewPosition = xeo_uViewMatrix * worldPosition;"),l("   xeo_vColor = xeo_aColor;"),l("   gl_Position = xeo_uProjMatrix * viewPosition;"),l("}"),n()}function h(){return k(),l("// Triangle picking fragment shader"),l("precision "+o(p._canvas.gl)+" float;"),l("varying vec4 xeo_vColor;"),l("void main(void) {"),l("   gl_FragColor = xeo_vColor;"),l("}"),n()}function i(){var a=p.shader.vertex;if(a)return a;var b,c,d;if(k(),l("// Drawing vertex shader"),l("uniform mat4 xeo_uModelMatrix;          // Modeling matrix"),l("uniform mat4 xeo_uViewMatrix;           // Viewing matrix"),l("uniform mat4 xeo_uProjMatrix;           // Projection matrix"),l("attribute vec3 xeo_aPosition;           // Local-space vertex position"),l(),l("varying vec4 xeo_vViewPosition;         // Output: View-space fragment position"),r)for(l(),l("attribute vec3 xeo_aNormal;             // Local-space vertex normal"),l("uniform mat4 xeo_uModelNormalMatrix;    // Modeling normal matrix"),l("uniform mat4 xeo_uViewNormalMatrix;     // Viewing normal matrix"),l("varying vec3 xeo_vViewEyeVec;           // Output: View-space vector from fragment position to eye"),l("varying vec3 xeo_vViewNormal;           // Output: View-space normal"),b=0,c=p.lights.lights.length;c>b;b++)d=p.lights.lights[b],"ambient"!==d.type&&("dir"===d.type&&l("uniform vec3 xeo_uLightDir"+b+";   // Directional light direction"),"point"===d.type&&l("uniform vec3 xeo_uLightPos"+b+";   // Positional light position"),"spot"===d.type&&l("uniform vec3 xeo_uLightPos"+b+";   // Spot light position"),l("varying vec4 xeo_vViewLightVecAndDist"+b+"; // Output: Vector from vertex to light, packaged with the pre-computed length of that vector"));if(s&&l("attribute vec3 xeo_aTangent;"),q&&(l(),l("attribute vec2 xeo_aUV;"),l("varying vec2 xeo_vUV;")),p.geometry.colors&&(l("attribute vec4 xeo_aColor;"),l("varying vec4 xeo_vColor;")),"points"===p.geometry.primitiveName&&l("uniform float xeo_uPointSize;"),p.billboard.active&&(l("void billboard(inout mat4 mat) {"),l("   mat[0][0] = -1.0;"),l("   mat[0][1] = 0.0;"),l("   mat[0][2] = 0.0;"),p.billboard.spherical&&(l("   mat[1][0] = 0.0;"),l("   mat[1][1] = 1.0;"),l("   mat[1][2] = 0.0;")),l("   mat[2][0] = 0.0;"),l("   mat[2][1] = 0.0;"),l("   mat[2][2] =1.0;"),l("}")),l(),l("void main(void) {"),l(),l("   vec4 localPosition = vec4(xeo_aPosition, 1.0); "),r&&(l("   vec4 localNormal = vec4(xeo_aNormal, 0.0); "),l("   mat4 modelNormalMatrix = xeo_uModelNormalMatrix;"),l("   mat4 viewNormalMatrix = xeo_uViewNormalMatrix;")),l("   mat4 modelMatrix = xeo_uModelMatrix;"),l("   mat4 viewMatrix = xeo_uViewMatrix;"),l("   vec4 worldPosition;"),p.stationary.active&&l("   viewMatrix[3][0] = viewMatrix[3][1] = viewMatrix[3][2] = 0.0;"),p.billboard.active?(l("   mat4 modelViewMatrix =  xeo_uViewMatrix * xeo_uModelMatrix;"),l("   billboard(modelMatrix);"),l("   billboard(viewMatrix);"),l("   billboard(modelViewMatrix);"),r&&(l("   mat4 modelViewNormalMatrix =  xeo_uViewNormalMatrix * xeo_uModelNormalMatrix;"),l("   billboard(modelNormalMatrix);"),l("   billboard(viewNormalMatrix);"),l("   billboard(modelViewNormalMatrix);")),l("   worldPosition = modelMatrix * localPosition;"),l("   vec4 viewPosition = modelViewMatrix * localPosition;")):(l("   worldPosition = modelMatrix * localPosition;"),l("   vec4 viewPosition  = viewMatrix * worldPosition; ")),r){for(l("   vec3 worldNormal = (modelNormalMatrix * localNormal).xyz; "),l("   xeo_vViewNormal = normalize((viewNormalMatrix * vec4(worldNormal, 1.0)).xyz);"),s&&(l("   vec3 tangent = normalize((xeo_uViewNormalMatrix * xeo_uModelNormalMatrix * vec4(xeo_aTangent, 1.0)).xyz);"),l("   vec3 bitangent = cross(xeo_vViewNormal, tangent);"),l("   mat3 TBN = mat3(tangent, bitangent, xeo_vViewNormal);")),l("   vec3 tmpVec3;"),l("   float lightDist;"),b=0,c=p.lights.lights.length;c>b;b++)d=p.lights.lights[b],"ambient"!==d.type&&("dir"===d.type&&("world"===d.space?(l("   tmpVec3 = xeo_uLightDir"+b+";"),l("   tmpVec3 = vec3(viewMatrix * vec4(tmpVec3, 1.0)).xyz;"),s&&l("   tmpVec3 *= TBN;")):(l("   tmpVec3 = xeo_uLightDir"+b+";"),s&&l("   tmpVec3 *= TBN;")),l("   xeo_vViewLightVecAndDist"+b+" = vec4(tmpVec3, 0.0);")),"point"===d.type&&("world"===d.space?(l("   tmpVec3 = (viewMatrix * vec4(xeo_uLightPos"+b+", 1.0)).xyz - viewPosition.xyz;"),l("   lightDist = abs(length(tmpVec3));"),s&&l("   tmpVec3 *= TBN;")):(l("   tmpVec3 = xeo_uLightPos"+b+".xyz - viewPosition.xyz;"),l("   lightDist = abs(length(tmpVec3));"),
s&&l("   tmpVec3 *= TBN;")),l("   xeo_vViewLightVecAndDist"+b+" = vec4(tmpVec3, lightDist);")));l("   xeo_vViewEyeVec = -viewPosition.xyz;"),s&&l("   xeo_vViewEyeVec *= TBN;")}return q&&l("   xeo_vUV = xeo_aUV;"),p.geometry.colors&&l("   xeo_vColor = xeo_aColor;"),"points"===p.geometry.primitiveName&&l("   gl_PointSize = xeo_uPointSize;"),l("   xeo_vViewPosition = viewPosition;"),l("   gl_Position = xeo_uProjMatrix * viewPosition;"),l("}"),n()}function j(){var a=p.shader.fragment;if(a)return a;var b,c,d;if(k(),l("// Drawing fragment shader"),l("precision "+o(p._canvas.gl)+" float;"),l(),r&&(l("varying vec4 xeo_vViewPosition;"),l(),l("uniform vec3 xeo_uSpecular;"),l("uniform float xeo_uShininess;"),l("uniform float xeo_uReflectivity;")),l("uniform vec3 xeo_uEmissive;"),l("uniform float xeo_uOpacity;"),l("uniform vec3 xeo_uDiffuse;"),l(),p.geometry.colors&&l("varying vec4 xeo_vColor;"),q&&(l(),m("Texture variables"),l(),p.geometry.uv&&l("varying vec2 xeo_vUV;"),p.material.emissiveMap&&(l("uniform sampler2D xeo_uEmissiveMap;"),p.material.emissiveMap.matrix&&l("uniform mat4 xeo_uEmissiveMapMatrix;")),p.material.opacityMap&&(l("uniform sampler2D xeo_uOpacityMap;"),p.material.opacityMap.matrix&&l("uniform mat4 xeo_uOpacityMapMatrix;")),p.material.ambientMap&&(l("uniform sampler2D xeo_uAmbientMap;"),p.material.ambientMap.matrix&&l("uniform mat4 xeo_uAmbientMapMatrix;")),p.material.diffuseMap&&(l("uniform sampler2D xeo_uDiffuseMap;"),p.material.diffuseMap.matrix&&l("uniform mat4 xeo_uDiffuseMapMatrix;")),r&&(p.material.specularMap&&(l("uniform sampler2D xeo_uSpecularMap;"),p.material.specularMap.matrix&&l("uniform mat4 xeo_uSpecularMapMatrix;")),p.material.reflectivityMap&&(l("uniform sampler2D xeo_uTextureReflectivity;"),p.material.reflectivityMap.matrix&&l("uniform mat4 xeo_uTextureReflectivityMatrix;")),s&&(l("uniform sampler2D xeo_uNormalMap;"),p.material.normalMap.matrix&&l("uniform mat4 xeo_uNormalMapMatrix;")))),l("uniform vec3 xeo_uLightAmbientColor;"),l("uniform float xeo_uLightAmbientIntensity;"),r){for(l("varying vec3 xeo_vViewEyeVec;"),l("varying vec3 xeo_vViewNormal;"),b=0,c=p.lights.lights.length;c>b;b++)d=p.lights.lights[b],"ambient"!==d.type&&(l("uniform vec3 xeo_uLightColor"+b+";"),l("uniform float xeo_uLightIntensity"+b+";"),"point"===d.type&&l("uniform vec3 xeo_uLightAttenuation"+b+";"),l("varying vec4 xeo_vViewLightVecAndDist"+b+";"));(u||v||w||y||x)&&(l(),m("Fresnel variables"),l(),u&&(l("uniform float xeo_uDiffuseFresnelCenterBias;"),l("uniform float xeo_uDiffuseFresnelEdgeBias;"),l("uniform float xeo_uDiffuseFresnelPower;"),l("uniform vec3 xeo_uDiffuseFresnelCenterColor;"),l("uniform vec3 xeo_uDiffuseFresnelEdgeColor;"),l()),v&&(l("uniform float xeo_uSpecularFresnelCenterBias;"),l("uniform float xeo_uSpecularFresnelEdgeBias;"),l("uniform float xeo_uSpecularFresnelPower;"),l("uniform vec3 xeo_uSpecularFresnelCenterColor;"),l("uniform vec3 xeo_uSpecularFresnelEdgeColor;"),l()),w&&(l("uniform float xeo_uOpacityFresnelCenterBias;"),l("uniform float xeo_uOpacityFresnelEdgeBias;"),l("uniform float xeo_uOpacityFresnelPower;"),l("uniform vec3 xeo_uOpacityFresnelCenterColor;"),l("uniform vec3 xeo_uOpacityFresnelEdgeColor;"),l()),x&&(l("uniform float xeo_uReflectivityFresnelCenterBias;"),l("uniform float xeo_uReflectivityFresnelEdgeBias;"),l("uniform float xeo_uReflectivityFresnelPower;"),l("uniform vec3 xeo_uReflectivityFresnelCenterColor;"),l("uniform vec3 xeo_uReflectivityFresnelEdgeColor;"),l()),y&&(l("uniform float xeo_uEmissiveFresnelCenterBias;"),l("uniform float xeo_uEmissiveFresnelEdgeBias;"),l("uniform float xeo_uEmissiveFresnelPower;"),l("uniform vec3 xeo_uEmissiveFresnelCenterColor;"),l("uniform vec3 xeo_uEmissiveFresnelEdgeColor;"),l()),m("Fresnel calculation"),l(),l("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),l("    float fr = abs(dot(eyeDir, normal));"),l("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),l("    return pow(finalFr, power);"),l("}"))}if(l(),l("void main(void) {"),l(),l("   vec3 ambient = xeo_uLightAmbientColor;"),l("   vec3 emissive = xeo_uEmissive;"),l("   float opacity = xeo_uOpacity;"),l(p.geometry.colors?"   vec3 diffuse = xeo_vColor.rgb;":"   vec3 diffuse = xeo_uDiffuse;"),r&&(l("vec3 viewEyeVec = normalize(xeo_vViewEyeVec);"),l("   vec3 specular = xeo_uSpecular;"),l("   float shininess = xeo_uShininess;"),l("   float reflectivity = xeo_uReflectivity;"),l(s?"   vec3 viewNormal = vec3(0.0, 1.0, 0.0);":"   vec3 viewNormal = normalize(xeo_vViewNormal);")),q){l(),m("   Apply textures"),l(),l("   vec4 texturePos = vec4(xeo_vUV.s, xeo_vUV.t, 1.0, 1.0);"),l("   vec2 textureCoord;");var e=p.material;e.emissiveMap&&(l(),l(e.emissiveMap.matrix?"   textureCoord = (xeo_uEmissiveMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   emissive = texture2D(xeo_uEmissiveMap, textureCoord).rgb;")),e.opacityMap&&(l(),l(e.opacityMap.matrix?"   textureCoord = (xeo_uOpacityMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   opacity = texture2D(xeo_uOpacityMap, textureCoord).b;")),e.ambientMap&&(l(),l(e.ambientMap.matrix?"   textureCoord = (xeo_uAmbientMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   ambient = texture2D(xeo_uAmbientMap, textureCoord).rgb;")),e.diffuseMap&&(l(),l(e.diffuseMap.matrix?"   textureCoord = (xeo_uDiffuseMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   diffuse = texture2D(xeo_uDiffuseMap, textureCoord).rgb;")),r&&(e.specularMap&&(l(),l(e.specularMap.matrix?"   textureCoord = (xeo_uSpecularMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   specular = texture2D(xeo_uSpecularMap, textureCoord).rgb;")),e.reflectivityMap&&(l(),l(e.reflectivityMap.matrix?"   textureCoord = (xeo_uReflectivityMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   reflectivity = texture2D(xeo_uReflectivityMap, textureCoord).b;"))),s&&(l(),l(e.normalMap.matrix?"   textureCoord = (xeo_uNormalMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   viewNormal = normalize(texture2D(xeo_uNormalMap, vec2(textureCoord.x, textureCoord.y)).xyz * 2.0 - 1.0);"))}if(l("   vec4 fragColor;"),r){for(l(),l("   vec3  diffuseLight = vec3(0.0, 0.0, 0.0);"),l("   vec3  specularLight = vec3(0.0, 0.0, 0.0);"),l(),l("   vec3  viewLightVec;"),l("   float specAngle;"),l("   float lightDist;"),l("   float attenuation;"),b=0,c=p.lights.lights.length;c>b;b++)d=p.lights.lights[b],"ambient"!==d.type&&(l("   viewLightVec = normalize(xeo_vViewLightVecAndDist"+b+".xyz);"),"point"===d.type&&(l(),l("   specAngle = max(dot(viewNormal, viewLightVec), 0.0);"),l("   lightDist = xeo_vViewLightVecAndDist"+b+".w;"),l("   attenuation = 1.0 - (  xeo_uLightAttenuation"+b+"[0] +   xeo_uLightAttenuation"+b+"[1] * lightDist +   xeo_uLightAttenuation"+b+"[2] * lightDist * lightDist);"),l("   diffuseLight += xeo_uLightIntensity"+b+" * specAngle * xeo_uLightColor"+b+" * attenuation;"),l("   specularLight += xeo_uLightIntensity"+b+" *  pow(max(dot(reflect(-viewLightVec, -viewNormal), viewEyeVec), 0.0), shininess) * attenuation;")),"dir"===d.type&&(l("   specAngle = max(dot(viewNormal, -viewLightVec), 0.0);"),l("   diffuseLight += xeo_uLightIntensity"+b+" * specAngle * xeo_uLightColor"+b+";"),l("   specularLight += xeo_uLightIntensity"+b+" * pow(max(dot(reflect(viewLightVec, -viewNormal), viewEyeVec), 0.0), shininess);")));l(),(u||v||w||y||x)&&(l(),m("   Apply Fresnels"),u&&(l(),l("float diffuseFresnel = fresnel(viewEyeVec, viewNormal, xeo_uDiffuseFresnelEdgeBias, xeo_uDiffuseFresnelCenterBias, xeo_uDiffuseFresnelPower);"),l("diffuse *= mix(xeo_uDiffuseFresnelEdgeColor, xeo_uDiffuseFresnelCenterColor, diffuseFresnel);")),v&&(l(),l("float specularFresnel = fresnel(viewEyeVec, viewNormal, xeo_uSpecularFresnelEdgeBias, xeo_uSpecularFresnelCenterBias, xeo_uSpecularFresnelPower);"),l("specular *= mix(xeo_uSpecularFresnelEdgeColor, xeo_uSpecularFresnelCenterColor, specularFresnel);")),w&&(l(),l("float opacityFresnel = fresnel(viewEyeVec, viewNormal, xeo_uOpacityFresnelEdgeBias, xeo_uOpacityFresnelCenterBias, xeo_uOpacityFresnelPower);"),l("opacity *= mix(xeo_uOpacityFresnelEdgeColor.r, xeo_uOpacityFresnelCenterColor.r, opacityFresnel);")),y&&(l(),l("float emissiveFresnel = fresnel(viewEyeVec, viewNormal, xeo_uEmissiveFresnelEdgeBias, xeo_uEmissiveFresnelCenterBias, xeo_uEmissiveFresnelPower);"),l("emissive *= mix(xeo_uEmissiveFresnelEdgeColor, xeo_uEmissiveFresnelCenterColor, emissiveFresnel);"))),l(),m("   Phong BRDF"),l(),l("   fragColor = vec4((specular * specularLight) + ((diffuseLight + (ambient * xeo_uLightAmbientIntensity) ) * diffuse) + emissive, opacity);")}else l(),m("   Non-Lambertian BRDF"),l(),l("   fragColor = vec4(emissive + diffuse, opacity);");return l("   fragColor.rgb *= fragColor.a;"),l("   gl_FragColor = fragColor;"),l("}"),n()}function k(){A=[]}function l(a){A.push(a||"")}function m(a){if(a){for(var b=0,c=0,d=a.length;d>c;c++)" "===a.charAt(c)&&b++;var e=b>0?a.substring(0,b-1):"";A.push(e+"// "+a.substring(b-1))}}function n(){return A}function o(a){return a.getShaderPrecisionFormat?a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT).precision>0?"highp":a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}var p,q,r,s,t,u,v,w,x,y,z={},A="";this.getSource=function(k,l){var m=z[k];return m?(m.useCount++,m):(p=l,q=a(),r=c(),s=d(),t=b(),u=p.material.diffuseFresnel,v=p.material.specularFresnel,w=p.material.opacityFresnel,x=p.material.reflectivityFresnel,y=p.material.emissiveFresnel,m=new XEO.renderer.ProgramSource(k,e(),f(),g(),h(),i(),j()),z[k]=m,m)},this.putSource=function(a){var b=z[a];b&&0===--b.useCount&&(z[b.hash]=null)}}}(),function(){"use strict";XEO.renderer.webgl={enums:{funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"}}}(),function(){"use strict";XEO.renderer.webgl.ArrayBuffer=function(a,b,c,d,e,f){this.allocated=!1,this.gl=a,this.type=b,this.itemType=c.constructor==Uint8Array?a.UNSIGNED_BYTE:c.constructor==Uint16Array?a.UNSIGNED_SHORT:c.constructor==Uint32Array?a.UNSIGNED_INT:a.FLOAT,this.usage=f,this.length=0,this.numItems=0,this.itemSize=e,this._allocate(c)},XEO.renderer.webgl.ArrayBuffer.prototype._allocate=function(a){if(this.allocated=!1,this._handle=this.gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this.gl.bindBuffer(this.type,this._handle),this.gl.bufferData(this.type,a,this.usage),this.gl.bindBuffer(this.type,null),this.length=a.length,this.numItems=this.length/this.itemSize,this.allocated=!0)},XEO.renderer.webgl.ArrayBuffer.prototype.setData=function(a,b){this.allocated&&(a.length>this.length?(this.destroy(),this._allocate(a,a.length)):b||0===b?this.gl.bufferSubData(this.type,b,a):this.gl.bufferData(this.type,a))},XEO.renderer.webgl.ArrayBuffer.prototype.bind=function(){this.allocated&&this.gl.bindBuffer(this.type,this._handle)},XEO.renderer.webgl.ArrayBuffer.prototype.unbind=function(){this.allocated&&this.gl.bindBuffer(this.type,null)},XEO.renderer.webgl.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}(),function(){"use strict";XEO.renderer.webgl.Attribute=function(a,b){this.gl=a,this.location=b},XEO.renderer.webgl.Attribute.prototype.bindFloatArrayBuffer=function(a){a&&(a.bind(),this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a.itemSize,this.gl.FLOAT,!1,0,0))},XEO.renderer.webgl.Attribute.prototype.bindInterleavedFloatArrayBuffer=function(a,b,c){this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a,this.gl.FLOAT,!1,b,c)}}(),function(){"use strict";function a(a){for(var b,c,d=[],e=0,f=a.length;f>e;e++)b=a[e],c=b.indexOf("/"),c>0&&"/"===b.charAt(c+1)&&(b=b.substring(0,c)),d.push(b);return d.join("\n")}XEO.renderer.webgl.Program=function(b,c,d,e){if(this.stats=b,this.gl=c,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new XEO.renderer.webgl.Shader(c,c.VERTEX_SHADER,a(d)),this._fragmentShader=new XEO.renderer.webgl.Shader(c,c.FRAGMENT_SHADER,a(e)),!this._vertexShader.allocated)return void(this.errorLog=["Vertex shader failed to allocate"].concat(this._vertexShader.errorLog));if(!this._fragmentShader.allocated)return void(this.errorLog=["Fragment shader failed to allocate"].concat(this._fragmentShader.errorLog));if(this.allocated=!0,!this._vertexShader.compiled)return void(this.errorLog=["Vertex shader failed to compile"].concat(this._vertexShader.errorLog));if(!this._fragmentShader.compiled)return void(this.errorLog=["Fragment shader failed to compile"].concat(this._fragmentShader.errorLog));this.compiled=!0;var f,g,h,i,j;if(this.handle=c.createProgram(),!this.handle)return void(this.errorLog=["Failed to allocate program"]);if(c.attachShader(this.handle,this._vertexShader.handle),c.attachShader(this.handle,this._fragmentShader.handle),c.linkProgram(this.handle),this.linked=c.getProgramParameter(this.handle,c.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errorLog=[],this.errorLog.push(""),this.errorLog.push(c.getProgramInfoLog(this.handle)),this.errorLog.push("\nVertex shader:\n"),this.errorLog=this.errorLog.concat(d),this.errorLog.push("\nFragment shader:\n"),void(this.errorLog=this.errorLog.concat(e));var k=c.getProgramParameter(this.handle,c.ACTIVE_UNIFORMS);for(g=0;k>g;++g)h=c.getActiveUniform(this.handle,g),h&&(i=h.name,"\x00"===i[i.length-1]&&(i=i.substr(0,i.length-1)),j=c.getUniformLocation(this.handle,i),h.type===c.SAMPLER_2D||h.type===c.SAMPLER_CUBE||35682===h.type?this.samplers[i]=new XEO.renderer.webgl.Sampler(c,j):this.uniforms[i]=new XEO.renderer.webgl.Uniform(b.frame,c,h.type,j));var l=c.getProgramParameter(this.handle,c.ACTIVE_ATTRIBUTES);for(g=0;l>g;g++)f=c.getActiveAttrib(this.handle,g),f&&(j=c.getAttribLocation(this.handle,f.name),this.attributes[f.name]=new XEO.renderer.webgl.Attribute(c,j));this.allocated=!0},XEO.renderer.webgl.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},XEO.renderer.webgl.Program.prototype.setUniform=function(a,b){if(this.allocated){var c=this.uniforms[a];c&&c.setValue(b)}},XEO.renderer.webgl.Program.prototype.getUniform=function(a){return this.allocated?this.uniforms[a]:void 0},XEO.renderer.webgl.Program.prototype.getAttribute=function(a){return this.allocated?this.attributes[a]:void 0},XEO.renderer.webgl.Program.prototype.bindTexture=function(a,b,c){if(!this.allocated)return!1;var d=this.samplers[a];return d?d.bindTexture(b,c):!1},XEO.renderer.webgl.Program.prototype.destroy=function(){this.allocated&&(this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}(),function(){"use strict";XEO.renderer.webgl.RenderBuffer=function(a){this.allocated=!1,this.canvas=a.canvas,this.gl=a.gl,this.buffer=null,this.bound=!1,this.size=a.size},XEO.renderer.webgl.RenderBuffer.prototype.setSize=function(a){this.size=a},XEO.renderer.webgl.RenderBuffer.prototype.webglRestored=function(a){this.gl=a,this.buffer=null,this.allocated=!1,this.bound=!1},XEO.renderer.webgl.RenderBuffer.prototype.bind=function(){this._touch(),this.bound||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0)},XEO.renderer.webgl.RenderBuffer.prototype._touch=function(){var a,b;if(this.size?(a=this.size[0],b=this.size[1]):(a=this.canvas.clientWidth,b=this.canvas.clientHeight),this.buffer){if(this.buffer.width===a&&this.buffer.height===b)return;this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf)}this.buffer={framebuf:this.gl.createFramebuffer(),renderbuf:this.gl.createRenderbuffer(),texture:this.gl.createTexture(),width:a,height:b},this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.gl.bindTexture(this.gl.TEXTURE_2D,this.buffer.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);try{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)}catch(c){var d=new WebGLUnsignedByteArray(a*b*3);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,d)}if(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,a,b),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.buffer.texture,0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),!this.gl.isFramebuffer(this.buffer.framebuf))throw"Invalid framebuffer";this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);var e=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);switch(e){case this.gl.FRAMEBUFFER_COMPLETE:break;case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case this.gl.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+e}this.bound=!1},XEO.renderer.webgl.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.BLEND)},XEO.renderer.webgl.RenderBuffer.prototype.read=function(a,b){var c=a,d=this.canvas.height-b,e=new Uint8Array(4);return this.gl.readPixels(c,d,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),e},XEO.renderer.webgl.RenderBuffer.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.bound=!1},XEO.renderer.webgl.RenderBuffer.prototype.getTexture=function(){var a=this;return{renderBuffer:this,bind:function(b){return a.buffer&&a.buffer.texture?(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,a.buffer.texture),!0):!1},unbind:function(b){a.buffer&&a.buffer.texture&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,null))}}},XEO.renderer.webgl.RenderBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1)}}(),function(){"use strict";XEO.renderer.webgl.Sampler=function(a,b){this.bindTexture=function(c,d){return c.bind(d)?(a.uniform1i(b,d),!0):!1}}}(),function(){"use strict";XEO.renderer.webgl.Shader=function(a,b,c){return this.allocated=!1,this.compiled=!1,this.errorLog=null,this.source=c,this.handle=a.createShader(b),this.handle?(this.allocated=!0,a.shaderSource(this.handle,c),a.compileShader(this.handle),this.compiled=a.getShaderParameter(this.handle,a.COMPILE_STATUS),void(this.compiled||a.isContextLost()||(this.errorLog=[],this.errorLog.push(""),this.errorLog.push(a.getShaderInfoLog(this.handle)),this.errorLog=this.errorLog.concat(this.source)))):void(this.errorLog=["Failed to allocate"])}}(),function(){"use strict";XEO.renderer.webgl.Texture2D=function(a){this.gl=a,this.target=a.TEXTURE_2D,this.texture=a.createTexture(),this.allocated=!0},XEO.renderer.webgl.Texture2D.prototype.setImage=function(a,b){var c=this.gl;c.bindTexture(this.target,this.texture),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,b.flipY),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a),c.bindTexture(this.target,null)},XEO.renderer.webgl.Texture2D.prototype.setProps=function(a){var b=this.gl;if(b.bindTexture(this.target,this.texture),a.minFilter){var c=this._getGLEnum(a.minFilter);c&&(b.texParameteri(this.target,b.TEXTURE_MIN_FILTER,c),(c===b.NEAREST_MIPMAP_NEAREST||c===b.LINEAR_MIPMAP_NEAREST||c===b.NEAREST_MIPMAP_LINEAR||c===b.LINEAR_MIPMAP_LINEAR)&&b.generateMipmap(this.target))}if(a.magFilter){var d=this._getGLEnum(a.magFilter);d&&b.texParameteri(this.target,b.TEXTURE_MAG_FILTER,d)}if(a.wrapS){var e=this._getGLEnum(a.wrapS);e&&b.texParameteri(this.target,b.TEXTURE_WRAP_S,e)}if(a.wrapT){var f=this._getGLEnum(a.wrapT);f&&b.texParameteri(this.target,b.TEXTURE_WRAP_T,f)}b.bindTexture(this.target,null)},XEO.renderer.webgl.Texture2D.prototype._getGLEnum=function(a,b){if(void 0===a)return b;var c=XEO.renderer.webgl.enums[a];return void 0===c?b:this.gl[c]},XEO.renderer.webgl.Texture2D.prototype.bind=function(a){if(this.allocated){if(this.texture){var b=this.gl;return b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,this.texture),!0}return!1}},XEO.renderer.webgl.Texture2D.prototype.unbind=function(a){if(this.allocated&&this.texture){var b=this.gl;b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,null)}},XEO.renderer.webgl.Texture2D.prototype.destroy=function(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)},XEO.renderer.webgl.clampImageSize=function(a,b){var c=a.width*a.height;if(c>b){var d=b/c,e=a.width*d,f=a.height*d,g=document.createElement("canvas");g.width=XEO.renderer.webgl.nextHighestPowerOfTwo(e),g.height=XEO.renderer.webgl.nextHighestPowerOfTwo(f);var h=g.getContext("2d");h.drawImage(a,0,0,a.width,a.height,0,0,g.width,g.height),a=g}return a},XEO.renderer.webgl.ensureImageSizePowerOfTwo=function(a){if(!XEO.renderer.webgl.isPowerOfTwo(a.width)||!XEO.renderer.webgl.isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=XEO.renderer.webgl.nextHighestPowerOfTwo(a.width),b.height=XEO.renderer.webgl.nextHighestPowerOfTwo(a.height);var c=b.getContext("2d");c.drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b}return a},XEO.renderer.webgl.isPowerOfTwo=function(a){return 0===(a&a-1)},XEO.renderer.webgl.nextHighestPowerOfTwo=function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1}}(),function(){"use strict";XEO.renderer.webgl.Uniform=function(a,b,c,d){var e=null,f=null,g=null,h=null,i=null;if(c===b.BOOL)e=function(c){return f===c?void a.setUniformCacheHits++:(f=c,b.uniform1i(d,c),void a.setUniform++)};else if(c===b.BOOL_VEC2)e=function(c){return f===c[0]&&g===c[1]?void a.setUniformCacheHits++:(f=c[0],g=c[1],b.uniform2iv(d,c),void a.setUniform++)};else if(c===b.BOOL_VEC3)e=function(c){return f===c[0]&&g===c[1]&&h===c[2]?void a.setUniformCacheHits++:(f=c[0],g=c[1],h=c[2],b.uniform3iv(d,c),void a.setUniform++)};else if(c===b.BOOL_VEC4)e=function(c){return f===c[0]&&g===c[1]&&h===c[2]&&i===c[3]?void a.setUniformCacheHits++:(f=c[0],g=c[1],h=c[2],i=c[3],b.uniform4iv(d,c),void a.setUniform++)};else if(c===b.INT)e=function(c){return f===c?void a.setUniformCacheHits++:(f=c,b.uniform1iv(d,c),void a.setUniform++)};else if(c===b.INT_VEC2)e=function(c){return f===c[0]&&g===c[1]?void a.setUniformCacheHits++:(f=c[0],g=c[1],b.uniform2iv(d,c),void a.setUniform++)};else if(c===b.INT_VEC3)e=function(c){return f===c[0]&&g===c[1]&&h===c[2]?void a.setUniformCacheHits++:(f=c[0],g=c[1],h=c[2],b.uniform3iv(d,c),void a.setUniform++)};else if(c===b.INT_VEC4)e=function(c){return f===c[0]&&g===c[1]&&h===c[2]&&i===c[3]?void a.setUniformCacheHits++:(f=c[0],g=c[1],h=c[2],i=c[3],b.uniform4iv(d,c),void a.setUniform++)};else if(c===b.FLOAT)e=function(c){return f===c?void a.setUniformCacheHits++:(f=c,b.uniform1f(d,c),void a.setUniform++)};else if(c===b.FLOAT_VEC2)e=function(c){return f===c[0]&&g===c[1]?void a.setUniformCacheHits++:(f=c[0],g=c[1],b.uniform2fv(d,c),void a.setUniform++)};else if(c===b.FLOAT_VEC3)e=function(c){return f===c[0]&&g===c[1]&&h===c[2]?void a.setUniformCacheHits++:(f=c[0],g=c[1],h=c[2],b.uniform3fv(d,c),void a.setUniform++)};else if(c===b.FLOAT_VEC4)e=function(c){return f===c[0]&&g===c[1]&&h===c[2]&&i===c[3]?void a.setUniformCacheHits++:(f=c[0],g=c[1],h=c[2],i=c[3],b.uniform4fv(d,c),void a.setUniform++)};else if(c===b.FLOAT_MAT2)e=function(c){b.uniformMatrix2fv(d,b.FALSE,c),a.setUniform++};else if(c===b.FLOAT_MAT3)e=function(c){b.uniformMatrix3fv(d,b.FALSE,c),a.setUniform++};else{if(c!==b.FLOAT_MAT4)throw"Unsupported shader uniform type: "+c;e=function(c){b.uniformMatrix4fv(d,b.FALSE,c),a.setUniform++}}this.setValue=e,this.getLocation=function(){return d}}}(),function(){"use strict";XEO.renderer.Chunk=function(){},XEO.renderer.Chunk.prototype.init=function(a,b,c){this.id=a,this.program=b,this.state=c,this.useCount=0,this.build&&this.build()}}(),function(){"use strict";XEO.renderer.ChunkFactory=function(){this.types=XEO.renderer.ChunkFactory.types},XEO.renderer.ChunkFactory.types={},XEO.renderer.ChunkFactory.createChunkType=function(a){if(!a.type)throw"'type' expected in params";var b=XEO.renderer.Chunk,c=function(){this.useCount=0,this.init.apply(this,arguments)};return c.prototype=new b,c.prototype.constructor=c,XEO._apply(a,c.prototype),XEO.renderer.ChunkFactory.types[a.type]={constructor:c,chunks:{},freeChunks:[],freeChunksLen:0},c},XEO.renderer.ChunkFactory.prototype.getChunk=function(a,b,c,d){var e=this.types[b];if(!e)throw"chunk type not supported: '"+b+"'";var f=e.chunks[a];return f?(f.useCount++,f):(e.freeChunksLen>0&&(f=e.freeChunks[--e.freeChunksLen]),f?f.init(a,c,d):f=new e.constructor(a,c,d),f.useCount=1,e.chunks[a]=f,f)},XEO.renderer.ChunkFactory.prototype.putChunk=function(a){if(0!==a.useCount&&--a.useCount<=0){var b=this.types[a.type];delete b.chunks[a.id],b.freeChunks[b.freeChunksLen++]=a}},XEO.renderer.ChunkFactory.prototype.webglRestored=function(){var a,b,c,d=this.types;for(var e in d)if(d.hasOwnProperty(e)){a=d[e],b=a.chunks;for(var f in b)b.hasOwnProperty(f)&&(c=b[f],c.build&&c.build())}}}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"clips",build:function(){var a,b;this._uClipModeDraw=this._uClipModeDraw||[],this._uClipPlaneDraw=this._uClipPlaneDraw||[];var c=this.program.draw;for(a=0,b=this.state.clips.length;b>a;a++)this._uClipModeDraw[a]=c.getUniform("xeo_uClipMode"+a),this._uClipPlaneDraw[a]=c.getUniform("xeo_uClipPlane"+a);this._uClipModePick=this._uClipModePick||[],this._uClipPlanePick=this._uClipPlanePick||[];var d=this.program.pick;for(a=0,b=this.state.clips.length;b>a;a++)this._uClipModePick[a]=d.getUniform("xeo_uClipMode"+a),this._uClipPlanePick[a]=d.getUniform("xeo_uClipPlane"+a)},drawPick:function(a){return}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"colorBuf",programGlobal:!0,draw:function(a){if(!a.transparent){var b=this.state,c=b.blendEnabled,d=this.program.gl;a.blendEnabled!==c&&(c?d.enable(d.BLEND):d.disable(d.BLEND),a.blendEnabled=c);var e=b.colorMask;d.colorMask(e[0],e[1],e[2],e[3])}}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"cubemap",build:function(){},draw:function(a){}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"depthBuf",programGlobal:!0,draw:function(a){var b=this.program.gl,c=this.state,d=c.active;a.depthbufEnabled!==d&&(d?b.disable(b.DEPTH_TEST):b.enable(b.DEPTH_TEST),a.depthbufEnabled=d);var e=c.clearDepth;a.clearDepth!==e&&(b.clearDepth(e),a.clearDepth=e);var f=c.depthFunc;a.depthFunc!==f&&(b.depthFunc(f),a.depthFunc=f),c.clear&&b.clear(b.DEPTH_BUFFER_BIT)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"draw",unique:!0,build:function(){this._uPickColorObject=this.program.pickObject.getUniform("xeo_uPickColor")},draw:function(a){var b=this.state,c=this.program.gl;b.indices&&(c.drawElements(b.primitive,b.indices.numItems,b.indices.itemType,0),a.drawElements++)},pickObject:function(a){var b=this.state,c=this.program.gl;if(this._uPickColorObject){a.pickObjects[a.pickIndex++]=this.object;var d=a.pickIndex>>16&255,e=a.pickIndex>>8&255,f=255&a.pickIndex;this._uPickColorObject.setValue([f/255,e/255,d/255,1])}b.indices&&(c.drawElements(b.primitive,b.indices.numItems,b.indices.itemType,0),a.drawElements++)},pickPrimitive:function(){var a=this.state,b=this.program.gl,c=a.getPickPositions();c&&b.drawArrays(a.primitive,0,c.numItems/3)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"geometry",build:function(){var a=this.program.draw;this._aPositionDraw=a.getAttribute("xeo_aPosition"),this._aNormalDraw=a.getAttribute("xeo_aNormal"),this._aUVDraw=a.getAttribute("xeo_aUV"),this._aTangentDraw=a.getAttribute("xeo_aTangent"),this._aColorDraw=a.getAttribute("xeo_aColor");var b=this.program.pickObject;this._aPositionPickObject=b.getAttribute("xeo_aPosition");var c=this.program.pickPrimitive;this._aPositionPickPrimitive=c.getAttribute("xeo_aPosition"),this._aColorPickPrimitive=c.getAttribute("xeo_aColor")},draw:function(a){var b=this.state;this._aPositionDraw&&(this._aPositionDraw.bindFloatArrayBuffer(b.positions),a.bindArray++),this._aNormalDraw&&(this._aNormalDraw.bindFloatArrayBuffer(b.normals),a.bindArray++),this._aUVDraw&&(this._aUVDraw.bindFloatArrayBuffer(b.uv),a.bindArray++),this._aColorDraw&&(this._aColorDraw.bindFloatArrayBuffer(b.colors),a.bindArray++),this._aTangentDraw&&(this._aTangentDraw.bindFloatArrayBuffer(b.getTangents()),a.bindArray++),b.indices&&(b.indices.bind(),a.bindArray++)},pickObject:function(){var a=this.state;this._aPositionPickObject&&this._aPositionPickObject.bindFloatArrayBuffer(a.positions),a.indices&&a.indices.bind()},pickPrimitive:function(){var a=this.state;this._aPositionPickPrimitive&&this._aPositionPickPrimitive.bindFloatArrayBuffer(a.getPickPositions()),this._aColorPickPrimitive&&this._aColorPickPrimitive.bindFloatArrayBuffer(a.getPickColors())}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"lights",build:function(){this._uLightAmbientColor=this._uLightAmbientColor||[],this._uLightAmbientIntensity=this._uLightAmbientIntensity||[],this._uLightColor=this._uLightColor||[],this._uLightIntensity=this._uLightIntensity||[],
this._uLightDir=this._uLightDir||[],this._uLightPos=this._uLightPos||[],this._uLightAttenuation=this._uLightAttenuation||[];for(var a=this.state.lights,b=this.program,c=0,d=a.length;d>c;c++)switch(a[c].type){case"ambient":this._uLightAmbientColor[c]=b.draw.getUniform("xeo_uLightAmbientColor"),this._uLightAmbientIntensity[c]=b.draw.getUniform("xeo_uLightAmbientIntensity");break;case"dir":this._uLightColor[c]=b.draw.getUniform("xeo_uLightColor"+c),this._uLightIntensity[c]=b.draw.getUniform("xeo_uLightIntensity"+c),this._uLightPos[c]=null,this._uLightDir[c]=b.draw.getUniform("xeo_uLightDir"+c);break;case"point":this._uLightColor[c]=b.draw.getUniform("xeo_uLightColor"+c),this._uLightIntensity[c]=b.draw.getUniform("xeo_uLightIntensity"+c),this._uLightPos[c]=b.draw.getUniform("xeo_uLightPos"+c),this._uLightDir[c]=null,this._uLightAttenuation[c]=b.draw.getUniform("xeo_uLightAttenuation"+c)}},draw:function(){for(var a,b=this.state.lights,c=0,d=b.length;d>c;c++)a=b[c],this._uLightAmbientColor[c]?(this._uLightAmbientColor[c].setValue(a.color),this._uLightAmbientIntensity[c]&&this._uLightAmbientIntensity[c].setValue(a.intensity)):(this._uLightColor[c]&&this._uLightColor[c].setValue(a.color),this._uLightIntensity[c]&&this._uLightIntensity[c].setValue(a.intensity),this._uLightPos[c]&&(this._uLightPos[c].setValue(a.pos),this._uLightAttenuation[c]&&this._uLightAttenuation[c].setValue(a.attenuation)),this._uLightDir[c]&&this._uLightDir[c].setValue(a.dir))}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"modelTransform",build:function(){this._uModelMatrixDraw=this.program.draw.getUniform("xeo_uModelMatrix"),this._uModelNormalMatrixDraw=this.program.draw.getUniform("xeo_uModelNormalMatrix"),this._uModelMatrixPickObject=this.program.pickObject.getUniform("xeo_uModelMatrix"),this._uModelMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uModelMatrix")},draw:function(){this._uModelMatrixDraw&&this._uModelMatrixDraw.setValue(this.state.matrix),this._uModelNormalMatrixDraw&&this._uModelNormalMatrixDraw.setValue(this.state.normalMatrix)},pickObject:function(){this._uModelMatrixPickObject&&this._uModelMatrixPickObject.setValue(this.state.matrix)},pickPrimitive:function(){this._uModelMatrixPickPrimitive&&this._uModelMatrixPickPrimitive.setValue(this.state.matrix)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"modes",build:function(){},draw:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e);var f=b.transparent;a.transparent!==f&&(a.pick||(f?(c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE_MINUS_SRC_ALPHA),a.blendEnabled=!0):(c.disable(c.BLEND),a.blendEnabled=!1)),a.transparent=f)},pickObject:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)},pickPrimitive:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"phongMaterial",build:function(){var a=this.state,b=this.program.draw;this._uDiffuse=b.getUniform("xeo_uDiffuse"),this._uSpecular=b.getUniform("xeo_uSpecular"),this._uEmissive=b.getUniform("xeo_uEmissive"),this._uOpacity=b.getUniform("xeo_uOpacity"),this._uShininess=b.getUniform("xeo_uShininess"),this._uPointSize=b.getUniform("xeo_uPointSize"),a.ambientMap&&(this._uAmbientMap="xeo_uAmbientMap",this._uAmbientMapMatrix=b.getUniform("xeo_uAmbientMapMatrix")),a.diffuseMap&&(this._uDiffuseMap="xeo_uDiffuseMap",this._uDiffuseMapMatrix=b.getUniform("xeo_uDiffuseMapMatrix")),a.specularMap&&(this._uSpecularMap="xeo_uSpecularMap",this._uSpecularMapMatrix=b.getUniform("xeo_uSpecularMapMatrix")),a.emissiveMap&&(this._uEmissiveMap="xeo_uEmissiveMap",this._uEmissiveMapMatrix=b.getUniform("xeo_uEmissiveMapMatrix")),a.opacityMap&&(this._uOpacityMap="xeo_uOpacityMap",this._uOpacityMapMatrix=b.getUniform("xeo_uOpacityMapMatrix")),a.reflectivityMap&&(this._uReflectivityMap="xeo_uReflectivityMap",this._uReflectivityMapMatrix=b.getUniform("xeo_uReflectivityMapMatrix")),a.normalMap&&(this._uNormalMap="xeo_uNormalMap",this._uNormalMapMatrix=b.getUniform("xeo_uNormalMapMatrix")),a.diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=b.getUniform("xeo_uDiffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=b.getUniform("xeo_uDiffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=b.getUniform("xeo_uDiffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=b.getUniform("xeo_uDiffuseFresnelCenterColor"),this._uDiffuseFresnelPower=b.getUniform("xeo_uDiffuseFresnelPower")),a.specularFresnel&&(this._uSpecularFresnelEdgeBias=b.getUniform("xeo_uSpecularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=b.getUniform("xeo_uSpecularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=b.getUniform("xeo_uSpecularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=b.getUniform("xeo_uSpecularFresnelCenterColor"),this._uSpecularFresnelPower=b.getUniform("xeo_uSpecularFresnelPower")),a.opacityFresnel&&(this._uOpacityFresnelEdgeBias=b.getUniform("xeo_uOpacityFresnelEdgeBias"),this._uOpacityFresnelCenterBias=b.getUniform("xeo_uOpacityFresnelCenterBias"),this._uOpacityFresnelEdgeColor=b.getUniform("xeo_uOpacityFresnelEdgeColor"),this._uOpacityFresnelCenterColor=b.getUniform("xeo_uOpacityFresnelCenterColor"),this._uOpacityFresnelPower=b.getUniform("xeo_uOpacityFresnelPower")),a.reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=b.getUniform("xeo_uReflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=b.getUniform("xeo_uReflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=b.getUniform("xeo_uReflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=b.getUniform("xeo_uReflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=b.getUniform("xeo_uReflectivityFresnelPower")),a.emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=b.getUniform("xeo_uEmissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=b.getUniform("xeo_uEmissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=b.getUniform("xeo_uEmissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=b.getUniform("xeo_uEmissiveFresnelCenterColor"),this._uEmissiveFresnelPower=b.getUniform("xeo_uEmissiveFresnelPower"))},draw:function(a){var b=this.program.draw,c=this.state,d=this.program.gl;this._uShininess&&this._uShininess.setValue(c.shininess),a.lineWidth!==c.lineWidth&&(d.lineWidth(c.lineWidth),a.lineWidth=c.lineWidth),this._uPointSize&&this._uPointSize.setValue(c.pointSize),c.ambientMap&&c.ambientMap.texture&&(b.bindTexture(this._uAmbientMap,c.ambientMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uAmbientMapMatrix&&this._uAmbientMapMatrix.setValue(c.ambientMap.matrix)),c.diffuseMap&&c.diffuseMap.texture?(b.bindTexture(this._uDiffuseMap,c.diffuseMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uDiffuseMapMatrix&&this._uDiffuseMapMatrix.setValue(c.diffuseMap.matrix)):this._uDiffuse&&this._uDiffuse.setValue(c.diffuse),c.specularMap&&c.specularMap.texture?(b.bindTexture(this._uSpecularMap,c.specularMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uSpecularMapMatrix&&this._uSpecularMapMatrix.setValue(c.specularMap.matrix)):this._uSpecular&&this._uSpecular.setValue(c.specular),c.emissiveMap&&c.emissiveMap.texture?(b.bindTexture(this._uEmissiveMap,c.emissiveMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uEmissiveMapMatrix&&this._uEmissiveMapMatrix.setValue(c.emissiveMap.matrix)):this._uEmissive&&this._uEmissive.setValue(c.emissive),c.opacityMap&&c.opacityMap.texture?(b.bindTexture(this._uOpacityMap,c.opacityMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uOpacityMapMatrix&&this._uOpacityMapMatrix.setValue(c.opacityMap.matrix)):this._uOpacity&&this._uOpacity.setValue(c.opacity),c.reflectivityMap&&c.reflectivityMap.texture&&(b.bindTexture(this._uReflectivityMap,c.reflectivityMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),this._uReflectivityMapMatrix&&this._uReflectivityMapMatrix.setValue(c.reflectivityMap.matrix)),c.normalMap&&c.normalMap.texture&&(b.bindTexture(this._uNormalMap,c.normalMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uNormalMapMatrix&&this._uNormalMapMatrix.setValue(c.normalMap.matrix)),c.diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&this._uDiffuseFresnelEdgeBias.setValue(c.diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&this._uDiffuseFresnelCenterBias.setValue(c.diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&this._uDiffuseFresnelEdgeColor.setValue(c.diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&this._uDiffuseFresnelCenterColor.setValue(c.diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&this._uDiffuseFresnelPower.setValue(c.diffuseFresnel.power)),c.specularFresnel&&(this._uSpecularFresnelEdgeBias&&this._uSpecularFresnelEdgeBias.setValue(c.specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&this._uSpecularFresnelCenterBias.setValue(c.specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&this._uSpecularFresnelEdgeColor.setValue(c.specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&this._uSpecularFresnelCenterColor.setValue(c.specularFresnel.centerColor),this._uSpecularFresnelPower&&this._uSpecularFresnelPower.setValue(c.specularFresnel.power)),c.opacityFresnel&&(this._uOpacityFresnelEdgeBias&&this._uOpacityFresnelEdgeBias.setValue(c.opacityFresnel.edgeBias),this._uOpacityFresnelCenterBias&&this._uOpacityFresnelCenterBias.setValue(c.opacityFresnel.centerBias),this._uOpacityFresnelEdgeColor&&this._uOpacityFresnelEdgeColor.setValue(c.opacityFresnel.edgeColor),this._uOpacityFresnelCenterColor&&this._uOpacityFresnelCenterColor.setValue(c.opacityFresnel.centerColor),this._uOpacityFresnelPower&&this._uOpacityFresnelPower.setValue(c.opacityFresnel.power)),c.reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&this._uReflectivityFresnelEdgeBias.setValue(c.reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&this._uReflectivityFresnelCenterBias.setValue(c.reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&this._uReflectivityFresnelEdgeColor.setValue(c.reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&this._uReflectivityFresnelCenterColor.setValue(c.reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&this._uReflectivityFresnelPower.setValue(c.reflectivityFresnel.power)),c.emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&this._uEmissiveFresnelEdgeBias.setValue(c.emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&this._uEmissiveFresnelCenterBias.setValue(c.emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&this._uEmissiveFresnelEdgeColor.setValue(c.emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&this._uEmissiveFresnelCenterColor.setValue(c.emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&this._uEmissiveFresnelPower.setValue(c.emissiveFresnel.power))}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"program",build:function(){},draw:function(a){this.program.draw.bind(),a.useProgram++},pickObject:function(){this.program.pickObject.bind()},pickPrimitive:function(){this.program.pickPrimitive.bind()}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"projTransform",build:function(){this._uProjMatrixDraw=this.program.draw.getUniform("xeo_uProjMatrix"),this._uProjMatrixPickObject=this.program.pickObject.getUniform("xeo_uProjMatrix"),this._uProjMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uProjMatrix")},draw:function(){this._uProjMatrixDraw&&this._uProjMatrixDraw.setValue(this.state.matrix)},pickObject:function(){this._uProjMatrixPickObject&&this._uProjMatrixPickObject.setValue(this.state.matrix)},pickPrimitive:function(){this._uProjMatrixPickPrimitive&&this._uProjMatrixPickPrimitive.setValue(this.state.matrix)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"renderTarget",programGlobal:!0,draw:function(a){var b=this.program.gl,c=this.state;a.renderBuf&&(b.flush(),a.renderBuf.unbind(),a.renderBuf=null);var d=c.renderBuf;return d?(d.bind(),a.depthMode=c.type===c.DEPTH,a.blendEnabled&&!a.depthMode&&(b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE_MINUS_SRC_ALPHA)),b.viewport(0,0,b.drawingBufferWidth,b.drawingBufferHeight),b.clearColor(a.ambientColor[0],a.ambientColor[1],a.ambientColor[2],1),b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT|b.STENCIL_BUFFER_BIT),void(a.renderBuf=d)):void(a.depthMode=!1)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"shader",draw:function(){var a=this.state.params;if(a){var b,c=this.program.draw;for(b in a)a.hasOwnProperty(b)&&c.setUniform(b,a[b])}}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"shaderParams",draw:function(){var a=this.state.params;if(a){var b,c=this.program.draw;for(b in a)a.hasOwnProperty(b)&&c.setUniform(b,a[b])}}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"viewTransform",build:function(){this._uViewMatrixDraw=this.program.draw.getUniform("xeo_uViewMatrix"),this._uViewNormalMatrixDraw=this.program.draw.getUniform("xeo_uViewNormalMatrix"),this._uViewMatrixPickObject=this.program.pickObject.getUniform("xeo_uViewMatrix"),this._uViewMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uViewMatrix")},draw:function(){this._uViewMatrixDraw&&this._uViewMatrixDraw.setValue(this.state.matrix),this._uViewNormalMatrixDraw&&this._uViewNormalMatrixDraw.setValue(this.state.normalMatrix)},pickObject:function(){this._uViewMatrixPickObject&&this._uViewMatrixPickObject.setValue(this.state.matrix)},pickPrimitive:function(){this._uViewMatrixPickPrimitive&&this._uViewMatrixPickPrimitive.setValue(this.state.matrix)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"viewport",programGlobal:!0,draw:function(){var a=this.state.boundary;this.program.gl.viewport(a[0],a[1],a[2],a[3])},pickObject:function(){var a=this.state.boundary;this.program.gl.viewport(a[0],a[1],a[2],a[3])},pickPrimitive:function(){var a=this.state.boundary;this.program.gl.viewport(a[0],a[1],a[2],a[3])}})}(),function(){"use strict";var a=new Float32Array(16),b=new Float32Array(16),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3),f=new Float32Array(3),g=new Float32Array(3),h=new Float32Array(3),i=new Float32Array(3),j=new Float32Array(4);XEO.math={DEGTORAD:.0174532925,vec2:function(a){return new Float32Array(a||2)},vec3:function(a){return new Float32Array(a||3)},vec4:function(a){return new Float32Array(a||4)},mat3:function(a){return new Float32Array(a||9)},mat4:function(a){return new Float32Array(a||16)},AABB3:function(){return{min:new Float32Array(3),max:new Float32Array(3)}},AABB2:function(){return{min:new Float32Array(2),max:new Float32Array(2)}},createUUID:function(){var a,b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c=new Array(36),d=0;return function(){for(var e=0;36>e;e++)8===e||13===e||18===e||23===e?c[e]="-":14===e?c[e]="4":(2>=d&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19===e?3&a|8:a]);return c.join("")}}(),clamp:function(a,b,c){return Math.max(b,Math.min(c,a))},fmod:function(a,b){if(b>a)return console.error("XEO.math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),a;for(;a>=b;)a-=b;return a},negateVec4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b},addVec4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c},addVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c},addVec3:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c},addVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c},subVec4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c},subVec3:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c},subVec2:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c},subVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c},subScalarVec4:function(a,b,c){return c||(c=a),c[0]=b-a[0],c[1]=b-a[1],c[2]=b-a[2],c[3]=b-a[3],c},mulVec4:function(a,b,c){return c||(c=a),c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3],c},mulVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c},mulVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c},mulVec2Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c},divVec3:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c},divVec4:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c[3]=a[3]/b[3],c},divScalarVec3:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c},divVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c},divVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c[3]=a[3]/b,c},divScalarVec4:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c[3]=a/b[3],c},dotVec4:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},cross3Vec4:function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2];return[d*h-e*g,e*f-c*h,c*g-d*f,0]},cross3Vec3:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=b[0],h=b[1],i=b[2];return c[0]=e*i-f*h,c[1]=f*g-d*i,c[2]=d*h-e*g,c},sqLenVec4:function(a){return XEO.math.dotVec4(a,a)},lenVec4:function(a){return Math.sqrt(XEO.math.sqLenVec4(a))},dotVec3:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},dotVec2:function(a,b){return a[0]*b[0]+a[1]*b[1]},sqLenVec3:function(a){return XEO.math.dotVec3(a,a)},sqLenVec2:function(a){return XEO.math.dotVec2(a,a)},lenVec3:function(a){return Math.sqrt(XEO.math.sqLenVec3(a))},lenVec2:function(a){return Math.sqrt(XEO.math.sqLenVec2(a))},rcpVec3:function(a,b){return XEO.math.divScalarVec3(1,a,b)},normalizeVec4:function(a,b){var c=1/XEO.math.lenVec4(a);return XEO.math.mulVec4Scalar(a,c,b)},normalizeVec3:function(a,b){var c=1/XEO.math.lenVec3(a);return XEO.math.mulVec3Scalar(a,c,b)},normalizeVec2:function(a,b){var c=1/XEO.math.lenVec2(a);return XEO.math.mulVec2Scalar(a,c,b)},dupMat4:function(a){return a.slice(0,16)},mat4To3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},m4s:function(a){return[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a]},setMat4ToZeroes:function(){return XEO.math.m4s(0)},setMat4ToOnes:function(){return XEO.math.m4s(1)},diagonalMat4v:function(a){return new Float32Array([a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,a[3]])},diagonalMat4c:function(a,b,c,d){return XEO.math.diagonalMat4v([a,b,c,d])},diagonalMat4s:function(a){return XEO.math.diagonalMat4c(a,a,a,a)},identityMat4:function(a){return a=a||new Float32Array(16),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},isIdentityMat4:function(a){return 1!==a[0]||0!==a[1]||0!==a[2]||0!==a[3]||0!==a[4]||1!==a[5]||0!==a[6]||0!==a[7]||0!==a[8]||0!==a[9]||1!==a[10]||0!==a[11]||0!==a[12]||0!==a[13]||0!==a[14]||1!==a[15]?!1:!0},negateMat4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b[4]=-a[4],b[5]=-a[5],b[6]=-a[6],b[7]=-a[7],b[8]=-a[8],b[9]=-a[9],b[10]=-a[10],b[11]=-a[11],b[12]=-a[12],b[13]=-a[13],b[14]=-a[14],b[15]=-a[15],b},addMat4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c[4]=a[4]+b[4],c[5]=a[5]+b[5],c[6]=a[6]+b[6],c[7]=a[7]+b[7],c[8]=a[8]+b[8],c[9]=a[9]+b[9],c[10]=a[10]+b[10],c[11]=a[11]+b[11],c[12]=a[12]+b[12],c[13]=a[13]+b[13],c[14]=a[14]+b[14],c[15]=a[15]+b[15],c},addMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c[4]=a[4]+b,c[5]=a[5]+b,c[6]=a[6]+b,c[7]=a[7]+b,c[8]=a[8]+b,c[9]=a[9]+b,c[10]=a[10]+b,c[11]=a[11]+b,c[12]=a[12]+b,c[13]=a[13]+b,c[14]=a[14]+b,c[15]=a[15]+b,c},addScalarMat4:function(a,b,c){return XEO.math.addMat4Scalar(b,a,c)},subMat4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c[4]=a[4]-b[4],c[5]=a[5]-b[5],c[6]=a[6]-b[6],c[7]=a[7]-b[7],c[8]=a[8]-b[8],c[9]=a[9]-b[9],c[10]=a[10]-b[10],c[11]=a[11]-b[11],c[12]=a[12]-b[12],c[13]=a[13]-b[13],c[14]=a[14]-b[14],c[15]=a[15]-b[15],c},subMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c[4]=a[4]-b,c[5]=a[5]-b,c[6]=a[6]-b,c[7]=a[7]-b,c[8]=a[8]-b,c[9]=a[9]-b,c[10]=a[10]-b,c[11]=a[11]-b,c[12]=a[12]-b,c[13]=a[13]-b,c[14]=a[14]-b,c[15]=a[15]-b,c},subScalarMat4:function(a,b,c){return c||(c=b),c[0]=a-b[0],c[1]=a-b[1],c[2]=a-b[2],c[3]=a-b[3],c[4]=a-b[4],c[5]=a-b[5],c[6]=a-b[6],c[7]=a-b[7],c[8]=a-b[8],c[9]=a-b[9],c[10]=a-b[10],c[11]=a-b[11],c[12]=a-b[12],c[13]=a-b[13],c[14]=a-b[14],c[15]=a-b[15],c},mulMat4:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];return c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s,c},mulMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c[4]=a[4]*b,c[5]=a[5]*b,c[6]=a[6]*b,c[7]=a[7]*b,c[8]=a[8]*b,c[9]=a[9]*b,c[10]=a[10]*b,c[11]=a[11]*b,c[12]=a[12]*b,c[13]=a[13]*b,c[14]=a[14]*b,c[15]=a[15]*b,c},mulMat4v4:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},transposeMat4:function(a,b){var c=a[4],d=a[14],e=a[8],f=a[13],g=a[12],h=a[9];if(!b||a===b){var i=a[1],j=a[2],k=a[3],l=a[6],m=a[7],n=a[11];return a[1]=c,a[2]=e,a[3]=g,a[4]=i,a[6]=h,a[7]=f,a[8]=j,a[9]=l,a[11]=d,a[12]=k,a[13]=m,a[14]=n,a}return b[0]=a[0],b[1]=c,b[2]=e,b[3]=g,b[4]=a[1],b[5]=a[5],b[6]=h,b[7]=f,b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=d,b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},determinantMat4:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},inverseMat4:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=1/(s*D-t*C+u*B+v*A-w*z+x*y);return b[0]=(h*D-i*C+j*B)*E,b[1]=(-d*D+e*C-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(-l*x+m*w-n*v)*E,b[4]=(-g*D+i*A-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(-o*x+q*u-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(-c*C+d*A-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(-k*w+l*u-n*s)*E,b[12]=(-g*B+h*z-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(-o*v+p*t-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b},traceMat4:function(a){return a[0]+a[5]+a[10]+a[15]},translationMat4v:function(a,b){var c=b||XEO.math.identityMat4();return c[12]=a[0],c[13]=a[1],c[14]=a[2],c},translationMat4c:function(a,b,c,d){return XEO.math.translationMat4v([a,b,c],d)},translationMat4s:function(a,b){return XEO.math.translationMat4c(a,a,a,b)},rotationMat4v:function(a,b,c){var d,e,f,g,h,i,j=XEO.math.normalizeVec4([b[0],b[1],b[2],0],[]),k=Math.sin(a),l=Math.cos(a),m=1-l,n=j[0],o=j[1],p=j[2];return d=n*o,e=o*p,f=p*n,g=n*k,h=o*k,i=p*k,c=c||XEO.math.mat4(),c[0]=m*n*n+l,c[1]=m*d+i,c[2]=m*f-h,c[3]=0,c[4]=m*d-i,c[5]=m*o*o+l,c[6]=m*e+g,c[7]=0,c[8]=m*f+h,c[9]=m*e-g,c[10]=m*p*p+l,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,c},rotationMat4c:function(a,b,c,d,e){return XEO.math.rotationMat4v(a,[b,c,d],e)},scalingMat4v:function(a,b){return b=b||XEO.math.identityMat4(),b[0]=a[0],b[5]=a[1],b[10]=a[2],b},scalingMat4c:function(a,b,c){return XEO.math.scalingMat4v([a,b,c])},scalingMat4s:function(a){return XEO.math.scalingMat4c(a,a,a)},mat4ToEuler:function(a,b,c){c=c||XEO.math.vec4();var d=XEO.math.clamp,e=a[0],f=a[4],g=a[8],h=a[1],i=a[5],j=a[9],k=a[2],l=a[6],m=a[10];return"XYZ"===b?(c[1]=Math.asin(d(g,-1,1)),Math.abs(g)<.99999?(c[0]=Math.atan2(-j,m),c[2]=Math.atan2(-f,e)):(c[0]=Math.atan2(l,i),c[2]=0)):"YXZ"===b?(c[0]=Math.asin(-d(j,-1,1)),Math.abs(j)<.99999?(c[1]=Math.atan2(g,m),c[2]=Math.atan2(h,i)):(c[1]=Math.atan2(-k,e),c[2]=0)):"ZXY"===b?(c[0]=Math.asin(d(l,-1,1)),Math.abs(l)<.99999?(c[1]=Math.atan2(-k,m),c[2]=Math.atan2(-f,i)):(c[1]=0,c[2]=Math.atan2(h,e))):"ZYX"===b?(c[1]=Math.asin(-d(k,-1,1)),Math.abs(k)<.99999?(c[0]=Math.atan2(l,m),c[2]=Math.atan2(h,e)):(c[0]=0,c[2]=Math.atan2(-f,i))):"YZX"===b?(c[2]=Math.asin(d(h,-1,1)),Math.abs(h)<.99999?(c[0]=Math.atan2(-j,i),c[1]=Math.atan2(-k,e)):(c[0]=0,c[1]=Math.atan2(g,m))):"XZY"===b&&(c[2]=Math.asin(-d(f,-1,1)),Math.abs(f)<.99999?(c[0]=Math.atan2(l,i),c[1]=Math.atan2(g,e)):(c[0]=Math.atan2(-j,m),c[1]=0)),c},lookAtMat4v:function(a,b,c,d){d||(d=XEO.math.mat4());var e=a[0],f=a[1],g=a[2],h=c[0],i=c[1],j=c[2],k=b[0],l=b[1],m=b[2];if(e===k&&f===l&&g===m)return XEO.math.identityMat4();var n,o,p,q,r,s,t,u,v,w;return n=e-k,o=f-l,p=g-m,w=1/Math.sqrt(n*n+o*o+p*p),n*=w,o*=w,p*=w,q=i*p-j*o,r=j*n-h*p,s=h*o-i*n,w=Math.sqrt(q*q+r*r+s*s),w?(w=1/w,q*=w,r*=w,s*=w):(q=0,r=0,s=0),t=o*s-p*r,u=p*q-n*s,v=n*r-o*q,w=Math.sqrt(t*t+u*u+v*v),w?(w=1/w,t*=w,u*=w,v*=w):(t=0,u=0,v=0),d[0]=q,d[1]=t,d[2]=n,d[3]=0,d[4]=r,d[5]=u,d[6]=o,d[7]=0,d[8]=s,d[9]=v,d[10]=p,d[11]=0,d[12]=-(q*e+r*f+s*g),d[13]=-(t*e+u*f+v*g),d[14]=-(n*e+o*f+p*g),d[15]=1,d},lookAtMat4c:function(a,b,c,d,e,f,g,h,i){return XEO.math.lookAtMat4v([a,b,c],[d,e,f],[g,h,i],[])},orthoMat4c:function(a,b,c,d,e,f,g){g||(g=XEO.math.mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2/i,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=-2/j,g[11]=0,g[12]=-(a+b)/h,g[13]=-(d+c)/i,g[14]=-(f+e)/j,g[15]=1,g},frustumMat4v:function(c,d,e){e||(e=XEO.math.mat4());var f=[c[0],c[1],c[2],0],g=[d[0],d[1],d[2],0];XEO.math.addVec4(g,f,a),XEO.math.subVec4(g,f,b);var h=2*f[2],i=b[0],j=b[1],k=b[2];return e[0]=h/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=h/j,e[6]=0,e[7]=0,e[8]=a[0]/i,e[9]=a[1]/j,e[10]=-a[2]/k,e[11]=-1,e[12]=0,e[13]=0,e[14]=-h*g[2]/k,e[15]=0,e},frustumMat4:function(a,b,c,d,e,f,g){g||(g=XEO.math.mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2*e/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2*e/i,g[6]=0,g[7]=0,g[8]=(b+a)/h,g[9]=(d+c)/i,g[10]=-(f+e)/j,g[11]=-1,g[12]=0,g[13]=0,g[14]=-(f*e*2)/j,g[15]=0,g},perspectiveMatrix4:function(a,b,c,d,e){var f=[],g=[];return f[2]=c,g[2]=d,g[1]=f[2]*Math.tan(a/2),f[1]=-g[1],g[0]=g[1]*b,f[0]=-g[0],XEO.math.frustumMat4v(f,g,e)},transformPoint3:function(a,b,c){var d=c||XEO.math.vec4();return d[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12],d[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13],d[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14],d[3]=1,d},transformPoint4:function(a,b,c){var d=c||XEO.math.vec4();return d[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3],d[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3],d[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3],d[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3],d},transformPoints3:function(a,b,c){for(var d,e,f,g,h,i=c||[],j=b.length,k=a[0],l=a[1],m=a[2],n=a[3],o=a[4],p=a[5],q=a[6],r=a[7],s=a[8],t=a[9],u=a[10],v=a[11],w=a[12],x=a[13],y=a[14],z=a[15],A=0;j>A;++A)g=b[A],d=g[0],e=g[1],f=g[2],h=i[A]||(i[A]=[0,0,0]),h[0]=k*d+o*e+s*f+w,h[1]=l*d+p*e+t*f+x,h[2]=m*d+q*e+u*f+y,h[3]=n*d+r*e+v*f+z;return i.length=j,i},transformVec3:function(a,b,c){var d=b[0],e=b[1],f=b[2];return c=c||this.vec3(),c[0]=a[0]*d+a[4]*e+a[8]*f,c[1]=a[1]*d+a[5]*e+a[9]*f,c[2]=a[2]*d+a[6]*e+a[10]*f,c},transformVec4:function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3];return c=c||this.vec4(),c[0]=a[0]*d+a[4]*e+a[8]*f+a[12]*g,c[1]=a[1]*d+a[5]*e+a[9]*f+a[13]*g,c[2]=a[2]*d+a[6]*e+a[10]*f+a[14]*g,c[3]=a[3]*d+a[7]*e+a[11]*f+a[15]*g,c},projectVec4:function(a){var b=1/a[3];return[a[0]*b,a[1]*b,a[2]*b,1]},lerpVec3:function(a,b,c,d,e,f){var g=f||this.vec3(),h=(a-b)/(c-b);return g[0]=d[0]+h*(e[0]-d[0]),g[1]=d[1]+h*(e[1]-d[1]),g[2]=d[2]+h*(e[2]-d[2]),g},getAABBDiag:function(a){return this.subVec3(a.max,a.min,e),Math.abs(this.lenVec3(e))},getAABBDiagPoint:function(a,b){var c=this.subVec3(a.max,a.min,e),d=b[0]-a.min[0],f=a.max[0]-b[0],g=b[1]-a.min[1],h=a.max[1]-b[1],i=b[2]-a.min[2],j=a.max[2]-b[2];return c[0]+=d>f?d:f,c[1]+=g>h?g:h,c[2]+=i>j?i:j,Math.abs(this.lenVec3(c))},getAABBCenter:function(a,b){var c=b||this.vec3();return c[0]=.5*(a.max[0]+a.min[0]),c[1]=.5*(a.max[1]+a.min[1]),c[2]=.5*(a.max[2]+a.min[2]),c},getAABB2Center:function(a,b){var c=b||this.vec2();return c[0]=(a.max[0]+a.min[0])/2,c[1]=(a.max[1]+a.min[1])/2,c},collapseAABB3:function(a){return a=a||XEO.math.AABB2(),a.min[0]=1e7,a.min[1]=1e7,a.min[2]=1e7,a.max[0]=-1e7,a.max[1]=-1e7,a.max[2]=-1e7,a},AABB3ToOBB3:function(a,b){return b=b||[],b[0]||(b[0]=[]),b[0][0]=a.min[0],b[0][1]=a.min[1],b[0][2]=a.min[2],b[0][3]=1,b[1]||(b[1]=[]),b[1][0]=a.max[0],b[1][1]=a.min[1],b[1][2]=a.min[2],b[1][3]=1,b[2]||(b[2]=[]),b[2][0]=a.max[0],b[2][1]=a.max[1],b[2][2]=a.min[2],b[2][3]=1,b[3]||(b[3]=[]),b[3][0]=a.min[0],b[3][1]=a.max[1],b[3][2]=a.min[2],b[3][3]=1,b[4]||(b[4]=[]),b[4][0]=a.min[0],b[4][1]=a.min[1],b[4][2]=a.max[2],b[4][3]=1,b[5]||(b[5]=[]),b[5][0]=a.max[0],b[5][1]=a.min[1],b[5][2]=a.max[2],b[5][3]=1,b[6]||(b[6]=[]),b[6][0]=a.max[0],b[6][1]=a.max[1],b[6][2]=a.max[2],b[6][3]=1,b[7]||(b[7]=[]),b[7][0]=a.min[0],b[7][1]=a.max[1],b[7][2]=a.max[2],b[7][3]=1,b},positions3ToAABB3:function(a,b){b=b||XEO.math.AABB3();for(var c,d,e,f=1e5,g=1e5,h=1e5,i=-1e5,j=-1e5,k=-1e5,l=0,m=a.length-2;m>l;l+=3)c=a[l+0],d=a[l+1],e=a[l+2],f>c&&(f=c),g>d&&(g=d),h>e&&(h=e),c>i&&(i=c),d>j&&(j=d),e>k&&(k=e);return b.min[0]=f,b.min[1]=g,b.min[2]=h,b.max[0]=i,b.max[1]=j,b.max[2]=k,b},points3ToAABB3:function(a,b){b=b||XEO.math.AABB3();for(var c,d,e,f=1e5,g=1e5,h=1e5,i=-1e5,j=-1e5,k=-1e5,l=0,m=a.length;m>l;l++)c=a[l][0],d=a[l][1],e=a[l][2],f>c&&(f=c),g>d&&(g=d),h>e&&(h=e),c>i&&(i=c),d>j&&(j=d),e>k&&(k=e);return b.min[0]=f,b.min[1]=g,b.min[2]=h,b.max[0]=i,b.max[1]=j,b.max[2]=k,b},expandAABB3:function(a,b){return a.min[0]>b.min[0]&&(a.min[0]=b.min[0]),a.min[1]>b.min[1]&&(a.min[1]=b.min[1]),a.min[2]>b.min[2]&&(a.min[2]=b.min[2]),a.max[0]<b.max[0]&&(a.max[0]=b.max[0]),a.max[1]<b.max[1]&&(a.max[1]=b.max[1]),a.max[2]<b.max[2]&&(a.max[2]=b.max[2]),b},expandAABB3Point3:function(a,b){return a.min[0]<b[0]&&(a.min[0]=b[0]),a.min[1]<b[1]&&(a.min[1]=b[1]),a.min[2]<b[2]&&(a.min[2]=b[2]),a.max[0]>b[0]&&(a.max[0]=b[0]),a.max[1]>b[1]&&(a.max[1]=b[1]),a.max[2]>b[2]&&(a.max[2]=b[2]),a},collapseAABB2:function(a){return a=a||XEO.math.AABB2(),a.min[0]=1e7,a.min[1]=1e7,a.max[0]=-1e7,a.max[1]=-1e7,a},points3ToAABB2:function(a,b){b=b||XEO.math.AABB2();for(var c,d,e,f,g=1e7,h=1e7,i=-1e7,j=-1e7,k=0,l=a.length;l>k;k++)c=a[k][0],d=a[k][1],e=a[k][3]||1,f=1/e,c*=f,d*=f,g>c&&(g=c),h>d&&(h=d),c>i&&(i=c),d>j&&(j=d);return b.min[0]=g,b.min[1]=h,b.max[0]=i,b.max[1]=j,b},expandAABB2:function(a,b){return a.min[0]>b.min[0]&&(a.min[0]=b.min[0]),a.min[1]>b.min[1]&&(a.min[1]=b.min[1]),a.max[0]<b.max[0]&&(a.max[0]=b.max[0]),a.max[1]<b.max[1]&&(a.max[1]=b.max[1]),b},expandAABB2Point2:function(a,b){return a.min[0]>b[0]&&(a.min[0]=b[0]),
a.min[1]>b[1]&&(a.min[1]=b[1]),a.max[0]<b[0]&&(a.max[0]=b[0]),a.max[1]<b[1]&&(a.max[1]=b[1]),a},AABB2ToCanvas:function(a,b,c,d){d=d||a;var e=.5*(a.min[0]+1),f=.5*(a.min[1]+1),g=.5*(a.max[0]+1),h=.5*(a.max[1]+1);return d.min[0]=Math.floor(e*b),d.min[1]=c-Math.floor(h*c),d.max[0]=Math.floor(g*b),d.max[1]=c-Math.floor(f*c),a},buildNormals:function(a,b){var c,d,e,f,g,h,i,j,k=new Array(a.length/3);for(c=0,d=b.length;d>c;c+=3){e=b[c+0],f=b[c+1],g=b[c+2],h=[a[3*e+0],a[3*e+1],a[3*e+2]],i=[a[3*f+0],a[3*f+1],a[3*f+2]],j=[a[3*g+0],a[3*g+1],a[3*g+2]],i=XEO.math.subVec3(i,h,[0,0,0]),j=XEO.math.subVec3(j,h,[0,0,0]);var l=XEO.math.normalizeVec3(XEO.math.cross3Vec3(i,j,[0,0,0]),[0,0,0]);k[e]||(k[e]=[]),k[f]||(k[f]=[]),k[g]||(k[g]=[]),k[e].push(l),k[f].push(l),k[g].push(l)}var m=new Float32Array(a.length);for(c=0,d=k.length;d>c;c++){for(var n=k[c].length,o=0,p=0,q=0,r=0;n>r;r++)o+=k[c][r][0],p+=k[c][r][1],q+=k[c][r][2];m[3*c+0]=o/n,m[3*c+1]=p/n,m[3*c+2]=q/n}return m},buildTangents:function(a,b,j){for(var k=XEO.math,l=new Float32Array(a.length),m=0;m<b.length;m+=3){var n=b[m],o=a.subarray(3*n,3*n+3),p=j.subarray(2*n,2*n+2);n=b[m+1];var q=a.subarray(3*n,3*n+3),r=j.subarray(2*n,2*n+2);n=b[m+2];for(var s=a.subarray(3*n,3*n+3),t=j.subarray(2*n,2*n+2),u=k.subVec3(q,o,c),v=k.subVec3(s,o,d),w=k.subVec2(r,p,e),x=k.subVec2(t,p,f),y=1/(w[0]*x[1]-w[1]*x[0]),z=k.mulVec3Scalar(k.subVec3(k.mulVec3Scalar(u,x[1],g),k.mulVec3Scalar(v,w[1],h),i),y,h),A=0;3>A;A++){var B=3*b[m+A];l[B]+=z[0],l[B+1]+=z[1],l[B+2]+=z[2]}}return l},flatten:function(a){var b,c,d,e,f,g=[];for(b=0,c=a.length;c>b;b++)for(f=a[b],d=0,e=f.length;e>d;d++)g.push(f[d]);return g},getPickPrimitives:function(a,b){for(var c,d,e,f,g,h,i,j,k=b.length,l=new Float32Array(30*k),m=new Float32Array(40*k),n=0,o=0;k>o;o+=3)d=3*o,e=4*o,j=(n>>24&255)/255,i=(n>>16&255)/255,h=(n>>8&255)/255,g=(255&n)/255,f=b[o],c=3*f,l[d]=a[c],l[d+1]=a[c+1],l[d+2]=a[c+2],m[e]=g,m[e+1]=h,m[e+2]=i,m[e+3]=j,f=b[o+1],c=3*f,l[d+3]=a[c],l[d+4]=a[c+1],l[d+5]=a[c+2],m[e+4]=g,m[e+5]=h,m[e+6]=i,m[e+7]=j,f=b[o+2],c=3*f,l[d+6]=a[c],l[d+7]=a[c+1],l[d+8]=a[c+2],m[e+8]=g,m[e+9]=h,m[e+10]=i,m[e+11]=j,n++;return{positions:l,colors:m}},rayTriangleIntersect:function(a,b,h,i,j,k){k=k||XEO.math.vec3();var l=1e-6,m=XEO.math.subVec3(i,h,c),n=XEO.math.subVec3(j,h,d),o=XEO.math.cross3Vec3(b,n,e),p=XEO.math.dotVec3(m,o);if(l>p)return null;var q=XEO.math.subVec3(a,h,f),r=XEO.math.dotVec3(q,o);if(0>r||r>p)return null;var s=XEO.math.cross3Vec3(q,m,g),t=XEO.math.dotVec3(b,s);if(0>t||r+t>p)return null;var u=XEO.math.dotVec3(n,s)/p;return k[0]=a[0]+u*b[0],k[1]=a[1]+u*b[1],k[2]=a[2]+u*b[2],k},rayPlaneIntersect:function(a,b,g,h,i,j){var k=XEO.math;j=j||k.vec3(),b=k.normalizeVec3(b,c);var l=k.subVec3(h,g,d),m=k.subVec3(i,g,e),n=k.cross3Vec3(l,m,f);k.normalizeVec3(n,n);var o=-k.dotVec3(g,n),p=-(k.dotVec3(a,n)+o)/k.dotVec3(b,n);return j[0]=a[0]+p*b[0],j[1]=a[1]+p*b[1],j[2]=a[2]+p*b[2],j},cartesianToBarycentric:function(a,b,i,j,k){var l=XEO.math.subVec3(b,a,c),m=XEO.math.subVec3(i,a,d),n=XEO.math.subVec3(j,a,e),o=XEO.math.subVec3(b,i,f),p=XEO.math.subVec3(b,j,g),q=XEO.math.lenVec3(XEO.math.cross3Vec3(o,p,h));return k[0]=XEO.math.lenVec3(XEO.math.cross3Vec3(m,n,h))/q,k[1]=XEO.math.lenVec3(XEO.math.cross3Vec3(n,l,h))/q,k[2]=XEO.math.lenVec3(XEO.math.cross3Vec3(l,m,h))/q,k},cartesianToBarycentric2:function(a,b,f,g,h){var i=XEO.math,j=i.subVec3(g,b,c),k=i.subVec3(f,b,d),l=i.subVec3(a,b,e),m=i.dotVec3(j,j),n=i.dotVec3(j,k),o=i.dotVec3(j,l),p=i.dotVec3(k,k),q=i.dotVec3(k,l),r=m*p-n*n;if(0===r)return null;var s=1/r,t=(p*o-n*q)*s,u=(m*q-n*o)*s;return h[0]=1-t-u,h[1]=u,h[2]=t,h},barycentricInsideTriangle:function(a){var b=a[1],c=a[2];return c>=0&&b>=0&&1>c+b},barycentricToCartesian2:function(a,b,c,d,e){e=e||XEO.math.vec3();var f=a[0],g=a[1],h=a[2];return e[0]=b[0]*f+c[0]*g+d[0]*h,e[1]=b[1]*f+c[1]*g+d[1]*h,e[2]=b[2]*f+c[2]*g+d[2]*h,e},identityQuaternion:function(a){return a=a||XEO.math.vec4(),a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},eulerToQuaternion:function(a,b,c){c=c||XEO.math.vec4();var d=Math.cos(a[0]/2),e=Math.cos(a[1]/2),f=Math.cos(a[2]/2),g=Math.sin(a[0]/2),h=Math.sin(a[1]/2),i=Math.sin(a[2]/2);return"XYZ"===b?(c[0]=g*e*f+d*h*i,c[1]=d*h*f-g*e*i,c[2]=d*e*i+g*h*f,c[3]=d*e*f-g*h*i):"YXZ"===b?(c[0]=g*e*f+d*h*i,c[1]=d*h*f-g*e*i,c[2]=d*e*i-g*h*f,c[3]=d*e*f+g*h*i):"ZXY"===b?(c[0]=g*e*f-d*h*i,c[1]=d*h*f+g*e*i,c[2]=d*e*i+g*h*f,c[3]=d*e*f-g*h*i):"ZYX"===b?(c[0]=g*e*f-d*h*i,c[1]=d*h*f+g*e*i,c[2]=d*e*i-g*h*f,c[3]=d*e*f+g*h*i):"YZX"===b?(c[0]=g*e*f+d*h*i,c[1]=d*h*f+g*e*i,c[2]=d*e*i-g*h*f,c[3]=d*e*f-g*h*i):"XZY"===b&&(c[0]=g*e*f-d*h*i,c[1]=d*h*f-g*e*i,c[2]=d*e*i+g*h*f,c[3]=d*e*f+g*h*i),c},mat4ToQuaternion:function(a,b){b=b||XEO.math.vec4();var c,d=a[0],e=a[4],f=a[8],g=a[1],h=a[5],i=a[9],j=a[2],k=a[6],l=a[10],m=d+h+l;return m>0?(c=.5/Math.sqrt(m+1),b[3]=.25/c,b[0]=(k-i)*c,b[1]=(f-j)*c,b[2]=(g-e)*c):d>h&&d>l?(c=2*Math.sqrt(1+d-h-l),b[3]=(k-i)/c,b[0]=.25*c,b[1]=(e+g)/c,b[2]=(f+j)/c):h>l?(c=2*Math.sqrt(1+h-d-l),b[3]=(f-j)/c,b[0]=(e+g)/c,b[1]=.25*c,b[2]=(i+k)/c):(c=2*Math.sqrt(1+l-d-h),b[3]=(g-e)/c,b[0]=(f+j)/c,b[1]=(i+k)/c,b[2]=.25*c),b},vec3PairToQuaternion:function(a,b,c){c=c||XEO.math.vec4();var d=XEO.math,e=Math.sqrt(d.dotVec3(a,a)*d.dotVec3(b,b)),f=e+d.dotVec3(a,b);return 1e-8*e>f?(f=0,Math.abs(a[0])>Math.abs(a[2])?(c[0]=-a[1],c[1]=a[0],c[2]=0):(c[0]=0,c[1]=-a[2],c[2]=a[1])):d.cross3Vec3(a,b,c),c[3]=f,d.normalizeQuaternion(c)},angleAxisToQuaternion:function(a,b){b=b||XEO.math.vec4();var c=a[3]/2,d=Math.sin(c);return b[0]=d*a[0],b[1]=d*a[1],b[2]=d*a[2],b[3]=Math.cos(c),b},quaternionToEuler:function(a,b,c){c=c||XEO.math.vec4();var d=a[3]/2,e=Math.sin(d);return c[0]=e*a[0],c[1]=e*a[1],c[2]=e*a[2],c[3]=Math.cos(d),c},mulQuaternions:function(a,b,c){c=c||XEO.math.vec4();var d=a[0],e=a[1],f=a[2],g=a[3],h=b[0],i=b[1],j=b[2],k=b[3];return c[0]=g*h+d*k+e*j-f*i,c[1]=g*i+e*k+f*h-d*j,c[2]=g*j+f*k+d*i-e*h,c[3]=g*k-d*h-e*i-f*j,c},vec3ApplyQuaternion:function(a,b,c){c=c||XEO.math.vec3();var d=b[0],e=b[1],f=b[2],g=a[0],h=a[1],i=a[2],j=a[3],k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;return c[0]=k*j+n*-g+l*-i-m*-h,c[1]=l*j+n*-h+m*-g-k*-i,c[2]=m*j+n*-i+k*-h-l*-g,c},quaternionToMat4:function(a,b){b=XEO.math.identityMat4(b);var c=a[0],d=a[1],e=a[2],f=a[3],g=2*c,h=2*d,i=2*e,j=g*f,k=h*f,l=i*f,m=g*c,n=h*c,o=i*c,p=h*d,q=i*d,r=i*e;return b[0]=1-(p+r),b[1]=n-l,b[2]=o+k,b[4]=n+l,b[5]=1-(m+r),b[6]=q-j,b[8]=o-k,b[9]=q+j,b[10]=1-(m+p),b},normalizeQuaternion:function(a,b){b=b||a;var c=XEO.math.lenVec4([a[0],a[1],a[2],a[3]]);return b[0]=a[0]/c,b[1]=a[1]/c,b[2]=a[2]/c,b[3]=a[3]/c,b},conjugateQuaternion:function(a,b){return b=b||a,b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=a[3],b},inverseQuaternion:function(a,b){return XEO.math.normalizeQuaternion(XEO.math.conjugateQuaternion(a,b))},quaternionToAngleAxis:function(a,b){b=b||XEO.math.vec4(),a=XEO.math.normalizeQuaternion(a,j);var c=a[3],d=2*Math.acos(c),e=Math.sqrt(1-c*c);return.001>e?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=a[0]/e,b[0]=a[1]/e,b[0]=a[2]/e),b[3]=d,b}}}(),XEO.math.tangentQuadraticBezier=function(a,b,c,d){return 2*(1-a)*(c-b)+2*a*(d-c)},XEO.math.tangentQuadraticBezier=function(a,b,c,d,e){return-3*b*(1-a)*(1-a)+3*c*(1-a)*(1-a)-6*a*c*(1-a)+6*a*d*(1-a)-3*a*a*d+3*a*a*e},XEO.math.tangentSpline=function(a,b,c,d,e){var f=6*a*a-6*a,g=3*a*a-4*a+1,h=-6*a*a+6*a,i=3*a*a-2*a;return f+g+h+i},XEO.math.catmullRomInterpolate=function(a,b,c,d,e){var f=.5*(c-a),g=.5*(d-b),h=e*e,i=e*h;return(2*b-2*c+f+g)*i+(-3*b+3*c-2*f-g)*h+f*e+b},XEO.math.b2p0=function(a,b){var c=1-a;return c*c*b},XEO.math.b2p1=function(a,b){return 2*(1-a)*a*b},XEO.math.b2p2=function(a,b){return a*a*b},XEO.math.b2=function(a,b,c,d){return this.b2p0(a,b)+this.b2p1(a,c)+this.b2p2(a,d)},XEO.math.b3p0=function(a,b){var c=1-a;return c*c*c*b},XEO.math.b3p1=function(a,b){var c=1-a;return 3*c*c*a*b},XEO.math.b3p2=function(a,b){var c=1-a;return 3*c*a*a*b},XEO.math.b3p3=function(a,b){return a*a*a*b},XEO.math.b3=function(a,b,c,d,e){return this.b3p0(a,b)+this.b3p1(a,c)+this.b3p2(a,d)+this.b3p3(a,e)},function(){"use strict";XEO.Component=Class.extend({__init:function(){var a={},b=arguments[0],c=arguments[1];this.scene=null,"XEO.Scene"===this.type?(this.scene=this,b&&(a=b)):(b?"XEO.Scene"===b.type?(this.scene=b,c&&(a=c)):(this.scene=XEO.scene,a=b):this.scene=XEO.scene,this._renderer=this.scene._renderer),this.meta=a.meta||{},this.isDefault=a.isDefault,this.id=a.id,this.destroyed=!1,this._attached={},this._attachments={},this._handleMap=new XEO.utils.Map,this._handleEvents={},this._eventSubs={},this._events={},this._eventCallDepth=0,this._sharedComponents={},this.scene&&"XEO.Scene"!==this.type&&this.scene._addComponent(this),this._updateScheduled=!1,this._init&&this._init(a)},type:"XEO.Component",superTypes:[],isType:function(a){if(!XEO._isString(a)&&(a=a.type,!a))return!1;if(this.type===a)return!0;var b=this.superTypes;if(!b)return!1;for(var c=b.length-1;c>=0;c--)if(b[c]===a)return!0;return!1},_init:function(a){},fire:function(a,b,c){c!==!0&&(this._events[a]=b);var d,e=this._eventSubs[a];if(e)for(var f in e)e.hasOwnProperty(f)&&(d=e[f],this._eventCallDepth++,this._eventCallDepth<300?d.callback.call(d.scope,b):this.error("fire: potential stack overflow from recursive event '"+a+"' - dropping this event"),this._eventCallDepth--)},on:function(a,b,c){var d=this._eventSubs[a];d||(d={},this._eventSubs[a]=d);var e=this._handleMap.addItem();d[e]={callback:b,scope:c||this},this._handleEvents[e]=a;var f=this._events[a];return f&&b.call(c||this,f),e},off:function(a){if(void 0!==a&&null!==a){var b=this._handleEvents[a];if(b){delete this._handleEvents[a];var c=this._eventSubs[b];c&&delete c[a],this._handleMap.removeItem(a)}}},once:function(a,b,c){var d=this,e=this.on(a,function(a){d.off(e),b(a)},c)},log:function(a){a="[LOG]"+this._message(a),window.console.log(a),this.scene.fire("log",a)},_message:function(a){return" ["+this.type+" "+XEO._inQuotes(this.id)+"]: "+a},warn:function(a){a="[WARN]"+this._message(a),window.console.warn(a),this.scene.fire("warn",a)},error:function(a){a="[ERROR]"+this._message(a),window.console.error(a),this.scene.fire("error",a)},clone:function(a){if(this.destroyed)return void this.error("Clone failed - component has been destroyed");a=a||{};var b=this.json;return delete b.id,new this.constructor(this.scene,XEO._apply(a,b))},_attach:function(a){var b=a.name;if(!b)return void this.error("Component 'name' expected");var c=a.component,d=a.sceneDefault,e=a.type,f=a.on,g=a.recompiles!==!1;if(c&&XEO._isNumeric(c)||XEO._isString(c)){var h=c;if(c=this.scene.components[h],!c)return void this.error("Component not found: "+XEO._inQuotes(h))}if(!c&&d===!0&&(c=this.scene[b],!c))return this.error("Scene has no default component for '"+b+"'"),null;if(c){if(c.scene.id!==this.scene.id)return void this.error("Not in same scene: "+c.type+" "+XEO._inQuotes(c.id));if(e&&!c.isType(e))return void this.error("Expected a "+e+" type or subtype: "+c.type+" "+XEO._inQuotes(c.id))}var i,j,k,l=this._attached[b];if(l){if(c&&l.id===c.id)return;var m=this._attachments[l.id];for(i=m.subs,j=0,k=i.length;k>j;j++)l.off(i[j]);delete this._attached[b],delete this._attachments[l.id];var n=m.params.onDetached;n&&(XEO._isFunction(n)?n(c):n.scope?n.callback.call(n.scope,c):n.callback(c))}if(c){var o={params:a,component:c,subs:[]};o.subs.push(c.on("destroyed",function(){o.params.component=null,this._attach(o.params)},this)),g&&o.subs.push(c.on("dirty",function(){this.fire("dirty",this)},this)),this._attached[b]=c,this._attachments[c.id]=o;var p=a.onAttached;if(p&&(XEO._isFunction(p)?p(c):p.scope?p.callback.call(p.scope,c):p.callback(c)),f){var q,r,s,t;for(q in f)if(f.hasOwnProperty(q)){if(r=f[q],XEO._isFunction(r)?(s=r,t=null):(s=r.callback,t=r.scope),!s)continue;o.subs.push(c.on(q,s,t))}}}return g&&this.fire("dirty",this),this.fire(b,c),c},create:function(a,b,c){var d=this.scene._getSharedComponent(a,b,c);return d&&(this._sharedComponents[d.id]||(this._sharedComponents[d.id]=d),d.on("destroyed",function(){delete this._sharedComponents[d.id]},this)),d},_scheduleUpdate:function(a){this._updateScheduled||(this._updateScheduled=!0,this._buildScheduled=!0,0===a?XEO.deferTask(this._doUpdate,this):XEO.scheduleTask(this._doUpdate,this))},_doUpdate:function(){this._updateScheduled&&(this._buildScheduled&&(this._build&&this._build(),this._buildScheduled=!1),this._update&&this._update(),this._updateScheduled=!1)},_build:null,_update:null,_compile:function(){},_props:{json:{get:function(){var a={type:this.type,id:this.id};return XEO._isEmptyObject(this.meta)||(a.meta=this.meta),this._getJSON?XEO._apply(this._getJSON(),a):a}},string:{get:function(){return JSON.stringify(this.json,"\n",4)}},js:{get:function(){var a=this.json;delete a.id;var b=JSON.stringify(a,"\n",4);return"new "+this.type+"("+b+");"}}},destroy:function(){var a,b,c,d,e,f;for(a in this._attachments)if(this._attachments.hasOwnProperty(a))for(b=this._attachments[a],c=b.component,d=b.subs,e=0,f=d.length;f>e;e++)c.off(d[e]);for(a in this._sharedComponents)this._sharedComponents.hasOwnProperty(a)&&(c=this._sharedComponents[a],delete this._sharedComponents[a],this.scene._putSharedComponent(c));this._destroy&&this._destroy(),this.fire("destroyed",this.destroyed=!0)},_destroy:function(){}})}(),function(){"use strict";XEO.Scene=XEO.Component.extend({type:"XEO.Scene",_init:function(a){var b=this;this._componentIDMap=new XEO.utils.Map,this.startTime=(new Date).getTime(),this.components={},this.types={},this.entities={},this._sharedComponents={},this._sharedComponentIDs={},this._sharedCounts={},this._dirtyEntities={},this.configs=new XEO.Configs(this,a.configs),this.canvas=new XEO.Canvas(this,{canvas:a.canvas,contextAttr:a.contextAttr||{}}),this.canvas.on("boundary",function(){b._renderer.imageDirty=!0,b._renderer.render({force:!0,clear:!0})}),this.canvas.on("webglContextFailed",function(){alert("xeoEngine failed to find WebGL!")}),this._renderer=new XEO.renderer.Renderer(XEO.stats,{canvas:this.canvas,transparent:a.transparent}),this.input=new XEO.Input(this,{element:this.canvas.overlay}),this.tasks=new XEO.Tasks(this),XEO._addScene(this);var c=a.components;if(c)for(var d,e,f,g=0,h=c.length;h>g;g++)d=c[g],e=d.type,e&&(f=window[e],f&&new f(this,d));this._initDefaults(),this.passes=a.passes},_initDefaults:function(){var a;a=this.view,a=this.project,a=this.camera,a=this.clips,a=this.colorTarget,a=this.colorBuf,a=this.depthTarget,a=this.depthBuf,a=this.visibility,a=this.cull,a=this.modes,a=this.geometry,a=this.layer,a=this.lights,a=this.material,a=this.morphTargets,a=this.reflect,a=this.shader,a=this.shaderParams,a=this.stage,a=this.transform,a=this.viewport},_addComponent:function(a){if(a.id){if(this.components[a.id])return void this.error("Component "+XEO._inQuotes(a.id)+" already exists in Scene")}else a.id=this._componentIDMap.addItem(a);this.components[a.id]=a;var b=a.type,c=this.types[a.type];c||(c=this.types[b]={}),c[a.id]=a,a.on("destroyed",function(){this._componentDestroyed(a)},this),a.isType("XEO.Entity")&&(a.on("dirty",this._entityDirty,this),this.entities[a.id]=a,this._worldBoundary&&a.worldBoundary.on("updated",this._setWorldBoundaryDirty,this),XEO.stats.components.entities++),this.fire("componentCreated",a,!0)},_componentDestroyed:function(a){this._componentIDMap.removeItem(a.id),delete this.components[a.id];var b=this.types[a.type];b&&(delete b[a.id],XEO._isEmptyObject(b)&&delete this.types[a.type]),a.isType("XEO.Entity")&&(XEO.stats.components.entities--,delete this.entities[a.id],delete this._dirtyEntities[a.id]),this.fire("componentDestroyed",a,!0)},_entityDirty:function(a){this._dirtyEntities[a.id]||(this._dirtyEntities[a.id]=a)},render:function(){var a={sceneId:null,pass:null};return function(){a.sceneId=this.id;var b,c,d=this._passes;for(b=0;d>b;b++)a.pass=b,this.fire("rendering",a,!0),c=0===b,this._compile(c,!0),this.fire("rendered",a,!0)}}(),_props:{passes:{set:function(a){void 0===a||null===a?a=1:(!XEO._isNumeric(a)||0>=a)&&(this.error("Unsupported value for 'passes': '"+a+"' - should be an integer greater than zero."),a=1),a!==this._passes&&(this._passes=a,this._renderer.drawListDirty=!0,this.fire("passes",this._passes))},get:function(){return this._passes}},project:{get:function(){return this.components["default.project"]||new XEO.Perspective(this,{id:"default.project",isDefault:!0})}},view:{get:function(){return this.components["default.view"]||new XEO.Lookat(this,{id:"default.view",isDefault:!0})}},camera:{get:function(){return this.components["default.camera"]||new XEO.Camera(this,{id:"default.camera",isDefault:!0,project:"default.project",view:"default.view"})}},transform:{get:function(){return this.components["default.transform"]||new XEO.Transform(this,{id:"default.transform",isDefault:!0})}},billboard:{get:function(){return this.components["default.billboard"]||new XEO.Billboard(this,{id:"default.billboard",active:!1,isDefault:!0})}},stationary:{get:function(){return this.components["default.stationary"]||new XEO.Stationary(this,{id:"default.stationary",active:!1,isDefault:!0})}},clips:{get:function(){return this.components["default.clips"]||new XEO.Clips(this,{id:"default.clips",isDefault:!0})}},colorBuf:{get:function(){return this.components["default.colorBuf"]||new XEO.ColorBuf(this,{id:"default.colorBuf",isDefault:!0})}},colorTarget:{get:function(){return this.components["default.colorTarget"]||new XEO.ColorTarget(this,{id:"default.colorTarget",isDefault:!0,active:!1})}},depthBuf:{get:function(){return this.components["default.depthBuf"]||new XEO.DepthBuf(this,{id:"default.depthBuf",isDefault:!0,active:!1})}},depthTarget:{get:function(){return this.components["default.depthTarget"]||new XEO.DepthTarget(this,{id:"default.depthTarget",isDefault:!0,active:!1})}},visibility:{get:function(){return this.components["default.visibility"]||new XEO.Visibility(this,{id:"default.visibility",isDefault:!0,visible:!0})}},cull:{get:function(){return this.components["default.cull"]||new XEO.Cull(this,{id:"default.cull",isDefault:!0,culled:!1})}},modes:{get:function(){return this.components["default.modes"]||new XEO.Modes(this,{id:"default.modes",isDefault:!0})}},geometry:{get:function(){return this.components["default.geometry"]||new XEO.BoxGeometry(this,{id:"default.geometry",isDefault:!0})}},layer:{get:function(){return this.components["default.layer"]||new XEO.Layer(this,{id:"default.layer",isDefault:!0,priority:0})}},lights:{get:function(){return this.components["default.lights"]||new XEO.Lights(this,{id:"default.lights",isDefault:!0,lights:[new XEO.AmbientLight(this,{id:"default.light0",color:[.45,.45,.5],intensity:.9}),new XEO.DirLight(this,{id:"default.light1",dir:[-.5,.5,-.6],color:[.8,.8,.7],intensity:1,space:"view"}),new XEO.DirLight(this,{id:"default.light2",dir:[.5,-.5,-.6],color:[.8,.8,.8],intensity:1,space:"view"})]})}},material:{get:function(){return this.components["default.material"]||new XEO.PhongMaterial(this,{id:"default.material",isDefault:!0})}},morphTargets:{get:function(){return this.components["default.morphTargets"]||new XEO.MorphTargets(this,{id:"default.morphTargets",isDefault:!0})}},reflect:{get:function(){return this.components["default.reflect"]||new XEO.Reflect(this,{id:"default.reflect",isDefault:!0})}},shader:{get:function(){return this.components["default.shader"]||this.components["default.shader"]||new XEO.Shader(this,{id:"default.shader",isDefault:!0})}},shaderParams:{get:function(){return this.components["default.shaderParams"]||new XEO.ShaderParams(this,{id:"default.shaderParams",isDefault:!0})}},stage:{get:function(){return this.components["default.stage"]||new XEO.Stage(this,{id:"default.stage",priority:0,isDefault:!0})}},viewport:{get:function(){return this.components["default.viewport"]||new XEO.Viewport(this,{id:"default.viewport",autoBoundary:!0,isDefault:!0})}},worldBoundary:{get:function(){if(!this._worldBoundary){var a=this,b=XEO.math.AABB3();this._worldBoundary=new XEO.Boundary3D(this.scene,{getDirty:function(){return a._worldBoundaryDirty},getAABB:function(){XEO.math.collapseAABB3(b);var c,d=a.entities;for(var e in d)d.hasOwnProperty(e)&&(c=d[e],c.modes.collidable&&XEO.math.expandAABB3(b,c.worldBoundary.aabb));return b}}),this._worldBoundary.on("destroyed",function(){a._worldBoundary=null}),this._setWorldBoundaryDirty()}return this._worldBoundary}}},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0)},pick:function(){function a(a,b,c,d){var e=XEO.math,f=a.scene.canvas.canvas,g=a.transform.leafMatrix,h=a.camera.view.matrix,i=a.camera.project.matrix,j=e.mulMat4(h,g,q),k=e.mulMat4(i,j,r),l=e.inverseMat4(k,r),m=f.width,n=f.height,o=(b[0]-m/2)/(m/2),p=-(b[1]-n/2)/(n/2),s=e.transformVec4(l,[o,p,-1,1],t);s=e.mulVec4Scalar(s,1/s[3]);var v=e.transformVec4(l,[o,p,1,1],u);v=e.mulVec4Scalar(v,1/v[3]),c[0]=s[0],c[1]=s[1],c[2]=s[2],e.subVec3(v,s,d),e.normalizeVec3(d)}var b=XEO.math.vec3(),c=XEO.math.vec3(),d=XEO.math.vec3(),e=XEO.math.vec3(),f=XEO.math.vec3(),g=XEO.math.vec3(),h=XEO.math.vec4(),i=XEO.math.vec4(),j=XEO.math.vec3(),k=XEO.math.vec3(),l=XEO.math.vec3(),m=XEO.math.vec3(),n=XEO.math.vec3(),o=XEO.math.vec3(),p=XEO.math.vec3(),q=XEO.math.mat4(),r=XEO.math.mat4(),s=XEO.math.vec2(),t=XEO.math.vec4(),u=XEO.math.vec4(),v=XEO.math.vec3(),w=XEO.math.vec3(),x=XEO.math.vec3(),y=XEO.math.vec3(),z=XEO.math.vec3(),A=XEO.math.vec3(),B=XEO.math.vec3(),C=XEO.math.vec3(),D=XEO.math.vec3(),E=XEO.math.vec3(),F=XEO.math.vec3();return function(q){var r=XEO.math;q=q||{},q.canvasPos=q.canvasPos||s;var G=this._renderer.pick(q);if(G){var H=this.entities[G.entity];if(G.entity=H,void 0!==G.primitiveIndex&&G.primitiveIndex>-1){var I=H.geometry;if("triangles"===I.primitive){G.primitive="triangle";var J=G.primitiveIndex,K=I.indices,L=I.positions,M=K[J],N=K[J+1],O=K[J+2],P=3*M,Q=3*N,R=3*O;g[0]=M,g[1]=N,g[2]=O,G.indices=g,d[0]=L[P],d[1]=L[P+1],d[2]=L[P+2],e[0]=L[Q],e[1]=L[Q+1],e[2]=L[Q+2],f[0]=L[R],f[1]=L[R+1],f[2]=L[R+2],a(H,q.canvasPos,b,c),r.rayPlaneIntersect(b,c,d,e,f,h),G.position=h,t[0]=h[0],t[1]=h[1],t[2]=h[2],t[3]=1,r.transformVec4(H.transform.leafMatrix,t,u),i[0]=u[0],i[1]=u[1],i[2]=u[2],G.worldPos=i,r.cartesianToBarycentric2(h,d,e,f,j),G.barycentric=j;var S=I.normals;if(S){k[0]=S[P],k[1]=S[P+1],k[2]=S[P+2],l[0]=S[Q],l[1]=S[Q+1],l[2]=S[Q+2],m[0]=S[R],m[1]=S[R+1],m[2]=S[R+2];var T=r.addVec3(r.addVec3(r.mulVec3Scalar(k,j[0],v),r.mulVec3Scalar(l,j[1],w),x),r.mulVec3Scalar(m,j[2],y),z);G.normal=r.transformVec3(H.transform.leafMatrix,T,A)}var U=I.uv;U&&(n[0]=U[2*M],n[1]=U[2*M+1],o[0]=U[2*N],o[1]=U[2*N+1],p[0]=U[2*O],p[1]=U[2*O+1],G.uv=r.addVec3(r.addVec3(r.mulVec2Scalar(n,j[0],B),r.mulVec2Scalar(o,j[1],C),D),r.mulVec2Scalar(p,j[2],E),F))}}return G}}}(),clear:function(){for(var a in this.components)this.components.hasOwnProperty(a)&&this.components[a].destroy();this._initDefaults(),this._dirtyEntities={}},_getSharedComponent:function(a,b,c){var d,e;if(void 0!==c&&(e="__shared."+a+"."+c,d=this._sharedComponents[e]))return this._sharedCounts[e]++,d;var f;if(XEO._isString(a)){var g=a.substring(3);if(f=XEO[g],!f)return this.error("Component type not found: '"+a+"'"),null}else f=a;return b&&b.id&&this.components[b.id]?(this.error("Component "+XEO._inQuotes(b.id)+" already exists in Scene"),null):(d=new f(this,b),void 0!==c&&(this._sharedComponents[e]=d,this._sharedComponentIDs[d.id]=e,this._sharedCounts[e]=1,d.on("destroyed",function(){void 0!==this._sharedComponentIDs[d.id]&&this._putSharedComponent(d)},this)),d)},_putSharedComponent:function(a){var b=this._sharedComponentIDs[a.id];if(void 0!==b){if(--this._sharedCounts[b]>0)return;delete this._sharedComponents[b],delete this._sharedComponentIDs[a.id],delete this._sharedCounts[b]}a.destroy()},_compile:function(a,b){var c,d=0;for(var e in this._dirtyEntities)this._dirtyEntities.hasOwnProperty(e)&&(c=this._dirtyEntities[e],c._valid()&&(c._compile(),delete this._dirtyEntities[e],d++));this._renderer.render({clear:a!==!1,force:b})},_getJSON:function(){var a,b=[];for(var c in this.components)if(this.components.hasOwnProperty(c)){if(a=this.components[c],!a._getJSON)continue;b.unshift(a)}b.sort(function(a,b){return a._componentOrder-b._componentOrder});for(var d=[],e=0,f=b.length;f>e;e++)d.push(b[e].json);return{components:d}},_destroy:function(){this.clear()}})}(),function(){"use strict";XEO.MorphTargets=XEO.Component.extend({type:"XEO.MorphTargets",_init:function(a){this.scene.on("webglContextRestored",function(){}),this.targets=a.targets,this.factor=a.factor},_props:{targets:{set:function(a){},get:function(){}},factor:{set:function(a){},get:function(){return 0}},_compile:function(){this._renderer.MorphTargets=this._state}},_getJSON:function(){return{targets:this.targets,factor:this.factor}}})}(),function(){"use strict";var a=XEO.math.vec3(),b=XEO.math.vec3(),c=XEO.math.vec3();XEO.CameraFlight=XEO.Component.extend({type:"XEO.CameraFlight",_init:function(a){this._look1=XEO.math.vec3(),this._eye1=XEO.math.vec3(),this._up1=XEO.math.vec3(),this._look2=XEO.math.vec3(),this._eye2=XEO.math.vec3(),this._up2=XEO.math.vec3(),this._flying=!1,this._callback=null,this._callbackScope=null,this._onTick=null,this._stopFOV=55,this._time1=null,this._time2=null,this.easing=a.easing!==!1,this.duration=a.duration||.5,this.camera=a.camera,this._boundaryIndicator=this.create(XEO.Entity,{geometry:this.create(XEO.BoundaryGeometry,{material:this.create(XEO.PhongMaterial,{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,0],lineWidth:3})}),visibility:this.create(XEO.Visibility,{visible:!1}),modes:this.create(XEO.Modes,{collidable:!1})})},flyTo:function(b,c,d){this._flying&&this.stop();var e=this._attached.camera;if(!e)return void(c&&(d?c.call(d):c()));this._flying=!1,this._callback=c,this._callbackScope=d;var f=e.view;this._eye1[0]=f.eye[0],this._eye1[1]=f.eye[1],this._eye1[2]=f.eye[2],this._look1[0]=f.look[0],this._look1[1]=f.look[1],this._look1[2]=f.look[2],this._up1[0]=f.up[0],this._up1[1]=f.up[1],this._up1[2]=f.up[2];var g,h,i,j,k;if(b.worldBoundary)g=b.worldBoundary.aabb;else if(b.aabb)g=b.aabb;else if(void 0!==b.min&&void 0!==b.max)g=b;else if(b.eye||b.look||b.up)h=b.eye,i=b.look,j=b.up;else{var l=b;if((XEO._isNumeric(l)||XEO._isString(l))&&(k=l,l=this.scene.components[k],!l))return this.error("Component not found: "+XEO._inQuotes(k)),void(c&&(d?c.call(d):c()));var m=l.worldBoundary;if(!m)return this.error("Can't fly to component "+XEO._inQuotes(k)+" - does not have a worldBoundary"),void(c&&(d?c.call(d):c()));g=m.aabb}var n=b.offset;if(g){if(g.max[0]<=g.min[0]||g.max[1]<=g.min[1]||g.max[2]<=g.min[2])return;this._boundaryIndicator.geometry.aabb=g,this._boundaryIndicator.visibility.visible=!0;var o=XEO.math.getAABBCenter(g);this._look2=b.look||o,n&&(this._look2[0]+=n[0],this._look2[1]+=n[1],this._look2[2]+=n[2]);var p=XEO.math.normalizeVec3(XEO.math.subVec3(this._eye1,this._look1,a)),q=(b.look,XEO.math.getAABBDiag(g)),r=Math.abs(q/Math.tan((b.stopFOV||this._stopFOV)/2));this._eye2[0]=this._look2[0]+p[0]*r,this._eye2[1]=this._look2[1]+p[1]*r,this._eye2[2]=this._look2[2]+p[2]*r,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2]}else(h||i||j)&&(i=i||this._look1,h=h||this._eye1,j=j||this._up1,this._look2[0]=i[0],this._look2[1]=i[1],this._look2[2]=i[2],this._eye2[0]=h[0],this._eye2[1]=h[1],this._eye2[2]=h[2],this._up2[0]=j[0],this._up2[1]=j[1],this._up2[2]=j[2]);this.fire("started",b,!0),this._time1=Date.now(),this._time2=this._time1+(b.duration?1e3*b.duration:this._duration),this._flying=!0,XEO.scheduleTask(this._update,this)},jumpTo:function(b){this._flying&&this.stop();var c=this._attached.camera;if(c){var d,e,f,g,h,i=c.view;if(b.worldBoundary)d=b.worldBoundary.aabb;else if(b.aabb)d=b.aabb;else if(void 0!==b.min&&void 0!==b.max)d=b;else if(b.eye||b.look||b.up)e=b.eye,f=b.look,g=b.up;else{var j=b;if((XEO._isNumeric(j)||XEO._isString(j))&&(h=j,j=this.scene.components[h],!j))return void this.error("Component not found: "+XEO._inQuotes(h));var k=j.worldBoundary;if(!k)return void this.error("Can't jump to component "+XEO._inQuotes(h)+" - does not have a worldBoundary");d=k.aabb}b.offset;if(d){if(d.max[0]<=d.min[0]||d.max[1]<=d.min[1]||d.max[2]<=d.min[2])return;e=i.eye,f=XEO.math.getAABBCenter(d);var l=XEO.math.normalizeVec3(XEO.math.subVec3(e,f,a)),m=XEO.math.getAABBDiag(d),n=Math.abs(m/Math.tan((b.stopFOV||this._stopFOV)/2));i.eye=[f[0]+l[0]*n,f[1]+l[1]*n,f[2]+l[2]*n],i.look=f}else(e||f||g)&&(e&&(i.eye=e),f&&(i.look=f),g&&(i.up=g))}},_update:function(){if(this._flying){var d=Date.now(),e=(d-this._time1)/(this._time2-this._time1),f=e>=1;e>1&&(e=1),e=this.easing?this._ease(e,0,1,1):e;var g=this._attached.camera.view;return g.eye=XEO.math.lerpVec3(e,0,1,this._eye1,this._eye2,a),g.look=XEO.math.lerpVec3(e,0,1,this._look1,this._look2,b),g.up=XEO.math.lerpVec3(e,0,1,this._up1,this._up2,c),f?void this.stop():void XEO.scheduleTask(this._update,this)}},_ease:function(a,b,c,d){return a/=d,-c*a*(a-2)+b},stop:function(){if(this._flying){this._boundaryIndicator.visibility.visible=!1,this._flying=!1,this._time1=null,this._time2=null;var a=this._callback;a&&(this._callback=null,this._callbackScope?a.call(this._callbackScope):a()),this.fire("stopped",!0,!0)}},_props:{camera:{set:function(a){this._attach({name:"camera",type:"XEO.Camera",component:a,sceneDefault:!0}),this.stop()},get:function(){return this._attached.camera}},duration:{set:function(a){this._duration=1e3*a,this.stop()},get:function(){return this._duration/1e3}}},_getJSON:function(){var a={};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.stop()}})}(),function(){"use strict";XEO.CameraPath=XEO.Component.extend({type:"XEO.CameraPath",_init:function(a){this.freeRotate=a.freeRotate,this.camera=a.camera,this.path=a.path},_props:{freeRotate:{set:function(a){a=!!a,this._freeRotate=a,this.fire("freeRotate",this._freeRotate)},get:function(){return this._freeRotate}},camera:{set:function(a){this._attach({name:"camera",type:"XEO.Camera",component:a,sceneDefault:!0,onAttached:{callback:this._update,scope:this}})},get:function(){return this._attached.camera}},path:{set:function(a){this._attach({name:"path",type:"XEO.Path",component:a,sceneDefault:!1,on:{t:{callback:this._update,scope:this}}})},get:function(){return this._attached.path}}},_update:function(){var a=this._attached.camera,b=this._attached.path;if(a&&b){var c=b.point,d=b.tangent,e=a.view;e.eye=c,this._freeRotate||(e.look=[c[0]+d[0],c[1]+d[1],c[2]+d[2]])}},_getJSON:function(){var a={freeRotate:this._freeRotate};return this._attached.camera&&(a.camera=this._attached.camera.id),this._attached.path&&(a.path=this._attached.path.id),a}})}(),function(){"use strict";XEO.Camera=XEO.Component.extend({type:"XEO.Camera",_init:function(a){this.project=a.project,this.view=a.view},_props:{project:{set:function(a){this._attach({name:"project",type:"XEO.Projection",component:a,sceneDefault:!0,on:{matrix:{callback:function(){this.fire("projectMatrix")},scope:this}}})},get:function(){return this._attached.project}},view:{set:function(a){this._attach({name:"view",type:"XEO.Lookat",component:a,sceneDefault:!0,on:{matrix:{callback:function(){this.fire("viewMatrix")},scope:this}}})},get:function(){return this._attached.view}}},_compile:function(){this._attached.project._compile(),this._attached.view._compile()},_getJSON:function(){return{project:this._attached.project.id,view:this._attached.view.id}}})}(),function(){"use strict";XEO.Projection=XEO.Component.extend({type:"XEO.Projection",_init:function(a){this._state=new XEO.renderer.ProjTransform({matrix:XEO.math.identityMat4(XEO.math.mat4())}),this.matrix=a.matrix},_props:{matrix:{set:function(a){a=a||XEO.math.identityMat4(),this._matrix||(this._matrix=XEO.math.mat4()),this._matrix.set(a),this._renderer.imageDirty=!0,this.fire("matrix",this._matrix)},get:function(){return this._matrix}}},_compile:function(){this._renderer.modelProjection=this._state},_getJSON:function(){return{matrix:Array.prototype.slice.call(this._matrix)}}})}(),function(){"use strict";XEO.Frustum=XEO.Projection.extend({type:"XEO.Frustum",_init:function(a){this._state=new XEO.renderer.ProjTransform({
matrix:XEO.math.identityMat4()}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._near=.1,this._far=1e4,this.left=a.left,this.right=a.right,this.bottom=a.bottom,this.top=a.top,this.near=a.near,this.far=a.far},_props:{left:{set:function(a){this._left=void 0!==a&&null!==a?a:-1,this._scheduleUpdate(0),this.fire("left",this._left)},get:function(){return this._left}},right:{set:function(a){this._right=void 0!==a&&null!==a?a:1,this._scheduleUpdate(0),this.fire("right",this._right)},get:function(){return this._right}},top:{set:function(a){this._top=void 0!==a&&null!==a?a:1,this._scheduleUpdate(0),this.fire("top",this._top)},get:function(){return this._top}},bottom:{set:function(a){this._bottom=void 0!==a&&null!==a?a:-1,this._scheduleUpdate(0),this.fire("bottom",this._bottom)},get:function(){return this._bottom}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._scheduleUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._scheduleUpdate(0),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._buildScheduled&&(this._build(),this._buildScheduled=!1),this._state.matrix}}},_build:function(){XEO.math.frustumMat4(this._left,this._right,this._bottom,this._top,this._near,this._far,this._state.matrix)},_update:function(){this._renderer.imageDirty=!0,this.fire("matrix",this._state.matrix)},_compile:function(){this._renderer.projTransform=this._state},_getJSON:function(){return{left:this._left,right:this._right,top:this._top,bottom:this._bottom,near:this._near,far:this._far}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Lookat=XEO.Component.extend({type:"XEO.Lookat",_init:function(a){var b=XEO.math.identityMat4(XEO.math.mat4()),c=XEO.math.inverseMat4(b,XEO.math.mat4());this._state=new XEO.renderer.ViewTransform({matrix:b,normalMatrix:c,eye:[0,0,10],look:[0,0,0],up:[0,1,0]}),this._buildScheduled=!1,this.eye=a.eye,this.look=a.look,this.up=a.up,this.gimbalLockY=a.gimbalLockY},rotateEyeY:function(a){var b=XEO.math.subVec3(this._state.eye,this._state.look,[]),c=XEO.math.rotationMat4v(.0174532925*a,this._gimbalLockY?[0,1,0]:this._state.up);b=XEO.math.transformPoint3(c,b,[]),this.eye=XEO.math.addVec3(b,this._state.look,[]),this._gimbalLockY&&(this.up=XEO.math.transformPoint3(c,this._state.up,[]))},rotateEyeX:function(a){var b=XEO.math.subVec3(this._state.eye,this._state.look,[]),c=XEO.math.cross3Vec3(XEO.math.normalizeVec3(b,[]),XEO.math.normalizeVec3(this._state.up,[])),d=XEO.math.rotationMat4v(.0174532925*a,c);b=XEO.math.transformPoint3(d,b,[]),this.eye=XEO.math.addVec3(b,this._state.look,[]),this.up=XEO.math.transformPoint3(d,this._state.up,[])},rotateLookY:function(a){var b=XEO.math.subVec3(this._state.look,this._state.eye,[]),c=XEO.math.rotationMat4v(.0174532925*a,this._state.up);b=XEO.math.transformPoint3(c,b,[]),this.look=XEO.math.addVec3(b,this._state.eye,[])},rotateLookX:function(a){var b=XEO.math.subVec3(this._state.look,this._state.eye,[]),c=XEO.math.cross3Vec3(XEO.math.normalizeVec3(b,[]),XEO.math.normalizeVec3(this._state.up,[])),d=XEO.math.rotationMat4v(.0174532925*a,c);b=XEO.math.transformPoint3(d,b,[]),this.look=XEO.math.addVec3(b,this._state.eye,[]),this.up=XEO.math.transformPoint3(d,this._state.up,[])},pan:function(a){var b,c=XEO.math.subVec3(this._state.eye,this._state.look,[]),d=[0,0,0];if(0!==a[0]){var e=XEO.math.cross3Vec3(XEO.math.normalizeVec3(c,[]),XEO.math.normalizeVec3(this._state.up,[]));b=XEO.math.mulVec3Scalar(e,a[0]),d[0]+=b[0],d[1]+=b[1],d[2]+=b[2]}0!==a[1]&&(b=XEO.math.mulVec3Scalar(XEO.math.normalizeVec3(this._state.up,[]),a[1]),d[0]+=b[0],d[1]+=b[1],d[2]+=b[2]),0!==a[2]&&(b=XEO.math.mulVec3Scalar(XEO.math.normalizeVec3(c,[]),a[2]),d[0]+=b[0],d[1]+=b[1],d[2]+=b[2]),this.eye=XEO.math.addVec3(this._state.eye,d,[]),this.look=XEO.math.addVec3(this._state.look,d,[])},zoom:function(a){var b=XEO.math.subVec3(this._state.eye,this._state.look,[]),c=Math.abs(XEO.math.lenVec3(b,[])),d=Math.abs(c+a),e=XEO.math.normalizeVec3(b,[]);this.eye=XEO.math.addVec3(this._state.look,XEO.math.mulVec3Scalar(e,d),[])},_props:{gimbalLockY:{set:function(a){a=a!==!1,this._gimbalLockY=a,this.fire("gimbalLockY",this._state.gimbalLockY)},get:function(){return this._gimbalLockY}},eye:{set:function(a){a=a||[0,0,10];var b=this._state.eye;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._scheduleUpdate(0),this.fire("eye",this._state.eye)},get:function(){return this._state.eye}},look:{set:function(a){a=a||[0,0,0];var b=this._state.look;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._scheduleUpdate(0),this.fire("look",this._state.look)},get:function(){return this._state.look}},up:{set:function(a){a=a||[0,1,0];var b=this._state.up;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._scheduleUpdate(0),this.fire("up",this._state.up)},get:function(){return this._state.up}},matrix:{get:function(){return this._buildScheduled&&(this._build(),this._buildScheduled=!1),this._state.matrix}}},_build:function(){this._state.matrix=new Float32Array(XEO.math.lookAtMat4v(this._state.eye,this._state.look,this._state.up,this._state.matrix)),this._state.normalMatrix=new Float32Array(XEO.math.transposeMat4(new Float32Array(XEO.math.inverseMat4(this._state.matrix,this._state.normalMatrix),this._state.normalMatrix)))},_update:function(){this._renderer.imageDirty=!0,this.fire("matrix",this._state.matrix)},_compile:function(){this._renderer.viewTransform=this._state},_getJSON:function(){return{eye:this._state.eye,look:this._state.look,up:this._state.up}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Ortho=XEO.Projection.extend({type:"XEO.Ortho",_init:function(a){this._state=new XEO.renderer.ProjTransform({matrix:XEO.math.identityMat4(XEO.math.mat4())}),this._left=-1,this._right=1,this._top=1,this._bottom=-1,this._near=.1,this._far=1e4,this.left=a.left,this.right=a.right,this.top=a.top,this.bottom=a.bottom,this.near=a.near,this.far=a.far},_props:{left:{set:function(a){this._left=void 0!==a&&null!==a?a:-1,this._scheduleUpdate(0),this.fire("left",this._left)},get:function(){return this._left}},right:{set:function(a){this._right=void 0!==a&&null!==a?a:1,this._scheduleUpdate(),this.fire("right",this._right)},get:function(){return this._right}},top:{set:function(a){this._top=void 0!==a&&null!==a?a:1,this._scheduleUpdate(),this.fire("top",this._top)},get:function(){return this._top}},bottom:{set:function(a){this._bottom=void 0!==a&&null!==a?a:-1,this._scheduleUpdate(),this.fire("bottom",this._bottom)},get:function(){return this._bottom}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._scheduleUpdate(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._scheduleUpdate(),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._buildScheduled&&(this._build(),this._buildScheduled=!1),this._state.matrix}}},_build:function(){XEO.math.orthoMat4c(this._left,this._right,this._bottom,this._top,this._near,this._far,this._state.matrix),this._renderer.imageDirty=!0},_update:function(){this._renderer.imageDirty=!0,this.fire("matrix",this._state.matrix)},_compile:function(){this._renderer.projTransform=this._state},_getJSON:function(){return{left:this._left,right:this._right,top:this._top,bottom:this._bottom,near:this._near,far:this._far}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Perspective=XEO.Projection.extend({type:"XEO.Perspective",_init:function(a){this._state=new XEO.renderer.ProjTransform({matrix:XEO.math.identityMat4(XEO.math.mat4())}),this._dirty=!1,this._fovy=60,this._near=.1,this._far=1e4;var b=this.scene.canvas;this._canvasResized=b.on("boundary",this._scheduleUpdate,this),this.fovy=a.fovy,this.near=a.near,this.far=a.far},_update:function(){var a=this.scene.canvas.canvas,b=a.clientWidth/a.clientHeight;XEO.math.perspectiveMatrix4(this._fovy*(Math.PI/180),b,this._near,this._far,this._state.matrix),this.fire("matrix",this._state.matrix)},_props:{fovy:{set:function(a){this._fovy=void 0!==a&&null!==a?a:60,this._renderer.imageDirty=!0,this._scheduleUpdate(0),this.fire("fovy",this._fovy)},get:function(){return this._fovy}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._renderer.imageDirty=!0,this._scheduleUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._renderer.imageDirty=!0,this._scheduleUpdate(0),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._updateScheduled&&this._update(),this._state.matrix}}},_compile:function(){this._renderer.projTransform=this._state},_getJSON:function(){return{fovy:this._fovy,near:this._near,far:this._far}},_destroy:function(){this.scene.canvas.off(this._canvasResized),this._state.destroy()}})}(),function(){"use strict";XEO.Canvas=XEO.Component.extend({type:"XEO.Canvas",serializable:!1,_WEBGL_CONTEXT_NAMES:["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],_init:function(a){if(this.canvas=null,this.overlay=null,this.gl=null,this.contextAttr=a.contextAttr||{},this.contextAttr.alpha=!0,a.canvas?XEO._isString(a.canvas)?(this.canvas=document.getElementById(a.canvas),this.canvas||(this.error("Canvas element not found: "+XEO._inQuotes(a.canvas)+" - creating default canvas instead."),this._createCanvas())):this.canvas=a.canvas:this._createCanvas(),!this.canvas)return void this.error("Faied to create canvas");this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._createOverlay(),this._resizeOverlay(),this._initWebGL();var b=this;this.canvas.addEventListener("webglcontextlost",function(){b.fire("webglContextLost")},!1),this.canvas.addEventListener("webglcontextrestored",function(){b._initWebGL(),b.gl&&b.fire("webglContextRestored",b.gl)},!1);var c=null,d=null,e=null,f=null;this._tick=this.scene.on("tick",function(){var a=b.canvas,g=window.innerWidth!==c||window.innerHeight!==d,h=a.clientWidth!==e||a.clientHeight!==f;if((g||h)&&(b._spinner._adjustPosition(),b._resizeOverlay(),h)){var i,j=a.clientWidth,k=a.clientHeight,l=0;for(var m in XEO.scenes)XEO.scenes.hasOwnProperty(m)&&(i=XEO.scenes[m],l+=i.canvas.canvas.clientWidth*i.canvas.canvas.clientHeight);XEO.stats.memory.pixels=l,a.width=a.clientWidth,a.height=a.clientHeight;var n=b.boundary;n[0]=a.offsetLeft,n[1]=a.offsetTop,n[2]=j,n[3]=k,b.fire("boundary",n),e=j,f=k}}),this.canvas.oncontextmenu=function(a){a.preventDefault()},this._spinner=new XEO.Spinner(this.scene,{canvas:this.canvas})},_createCanvas:function(){var a="XEO-canvas-"+XEO.math.createUUID(),b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d.height="100%",d.width="100%",d.padding="0",d.margin="0",d.background="black",d["float"]="left",d.left="0",d.top="0",d.position="absolute",d["z-index"]="-10000",c.innerHTML+='<canvas id="'+a+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',b.appendChild(c),this.canvas=document.getElementById(a)},_createOverlay:function(){var a=("XEO-overlay-"+XEO.math.createUUID(),document.getElementsByTagName("body")[0]),b=document.createElement("div"),c=b.style;c.padding="0",c.margin="0",c.background="black",c["float"]="left",c.left="0",c.top="0",c.position="absolute",c.opacity=0,c["z-index"]="100000",a.appendChild(b),this.overlay=b},_resizeOverlay:function(){if(this.canvas&&this.overlay){var a=this.canvas,b=this.overlay,c=b.style;c.left=a.offsetLeft+"px",c.top=a.offsetTop+"px",c.width=a.clientWidth+"px",c.height=a.clientHeight+"px"}},_initWebGL:function(){for(var a=0;!this.gl&&a<this._WEBGL_CONTEXT_NAMES.length;a++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[a],this.contextAttr)}catch(b){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0))},getSnapshot:function(a){if(!this.canvas)return void this.error("Can't get snapshot - no canvas.");this.scene.render(),a=a||{};var b,c=a.width||this.canvas.width,d=a.height||this.canvas.height,e=a.format||"jpeg";switch(e){case"jpeg":b=Canvas2Image.saveAsJPEG(this.canvas,!0,c,d);break;case"png":b=Canvas2Image.saveAsPNG(this.canvas,!0,c,d);break;case"bmp":b=Canvas2Image.saveAsBMP(this.canvas,!0,c,d);break;default:this.error("Unsupported snapshot format: '"+e+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),b=Canvas2Image.saveAsJPEG(this.canvas,!0,c,d)}return b.src},_props:{spinner:{get:function(){return this._spinner}}},_destroy:function(){this.scene.off(this._tick)}})}(),function(){"use strict";var a=!1;XEO.Spinner=XEO.Component.extend({type:"XEO.Spinner",serializable:!1,_init:function(a){this._canvas=a.canvas,this._injectSpinnerCSS();var b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d["z-index"]="9000",d.position="absolute",c.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',b.appendChild(c),this._element=c,this._adjustPosition(),this.processes=0,this.textures=a.textures},_props:{textures:{set:function(a){a=a!==!1,this._textures=a,this.fire("textures",this._textures)},get:function(){return this._textures}},processes:{set:function(a){a=a||0,this._processes!==a&&(0>a||(this._processes=a,this._element.style.visibility=this._processes>0?"visible":"hidden",this.fire("processes",this._processes)))},get:function(){return this._processes}}},_adjustPosition:function(){if(this._canvas&&this._element){var a=this._canvas,b=this._element,c=b.style;c.left=a.offsetLeft+.5*a.clientWidth-.5*b.clientWidth+"px",c.top=a.offsetTop+.5*a.clientHeight-.5*b.clientHeight+"px"}},_injectSpinnerCSS:function(){if(!a){var b=document.createElement("style");b.innerHTML=this._spinnerCSS,document.body.appendChild(b),a=!0}},_spinnerCSS:".sk-fading-circle {        margin: 100px auto;        width: 100px;        height:100px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }"})}(),function(){"use strict";XEO.Clip=XEO.Component.extend({type:"XEO.Clip",_init:function(a){this._state={mode:"disabled",dir:[1,0,0],dist:1},this.mode=a.mode,this.dir=a.dir,this.dist=a.dist},_props:{mode:{set:function(a){this._state.mode=a||"disabled",this._renderer.imageDirty=!0,this.fire("mode",this._state.mode)},get:function(){return this._state.mode}},dir:{set:function(a){this._state.dir=a||[1,0,0],this._renderer.imageDirty=!0,this.fire("dir",this._state.dir)},get:function(){return this._state.dir}},dist:{set:function(a){this._state.dist=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("dist",this._state.dist)},get:function(){return this._state.dist}}},_getJSON:function(){return{mode:this._state.mode,dir:this._state.dir,dist:this._state.dist}}})}(),function(){"use strict";XEO.Clips=XEO.Component.extend({type:"XEO.Clips",_init:function(a){this._state=new XEO.renderer.Clips({clips:[],hash:""}),this._dirty=!0,this._clips=[],this._dirtySubs=[],this._destroyedSubs=[],this.clips=a.clips},_props:{clips:{set:function(a){function b(){h.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=h._clips.length;c>b;b++)if(h._clips[b].id===a)return h._clips=h._clips.slice(b,b+1),h._dirtySubs=h._dirtySubs.slice(b,b+1),h._destroyedSubs=h._destroyedSubs.slice(b,b+1),h._dirty=!0,h.fire("dirty",!0),void h.fire("clips",h._clips)}a=a||[];var d,e,f,g;for(e=0,f=this._clips.length;f>e;e++)d=this._clips[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._clips=[],this._dirtySubs=[],this._destroyedSubs=[];var h=this;for(e=0,f=a.length;f>e;e++)d=a[e],!XEO._isString(d)||(g=d,d=this.components[g])?"XEO.Clip"===d.type?(this._clips.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c))):this.error("Component "+XEO._inQuotes(g)+" is not a XEO.Clip"):this.error("Component not found: "+XEO._inQuotes(g));this._dirty=!0,this.fire("dirty",!0),this.fire("clips",this._clips)},get:function(){return this._clips.slice(0,this._clips.length)}}},_compile:function(){var a=this._state;if(this._dirty){a.clips=[];for(var b=0,c=this._clips.length;c>b;b++)a.clips.push(this._clips[b]._state);this._makeHash(),this._dirty=!1}this._renderer.clips=a},_makeHash:function(){var a=this._state.clips;if(0===a.length)return";";for(var b,c=[],d=0,e=a.length;e>d;d++)b=a[d],c.push(b._state.mode);c.push(";"),this._state.hash=c.join("")},_getJSON:function(){for(var a=[],b=0,c=this._clips.length;c>b;b++)a.push(this._clips[b].id);return{clips:a}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Configs=XEO.Component.extend({type:"XEO.Configs",_init:function(a){this.props={};for(var b in a)a.hasOwnProperty(b)&&this.set(b,a[b])},set:function(a,b){this.props[a]=b,this.fire(a,b)},_toJSON:function(){return XEO._copy(this.props)}})}(),function(){"use strict";XEO.CameraControl=XEO.Component.extend({type:"XEO.CameraControl",exclusive:!0,_init:function(a){this.scene;this._boundaryEntity=this.create(XEO.Entity,{geometry:this.create(XEO.BoundaryGeometry),material:this.create(XEO.PhongMaterial,{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,.6],lineWidth:4}),visibility:this.create(XEO.Visibility,{visible:!1}),modes:this.create(XEO.Modes,{collidable:!1})}),this.keyboardAxis=this.create(XEO.KeyboardAxisCamera,{camera:a.camera}),this.keyboardRotate=this.create(XEO.KeyboardRotateCamera,{camera:a.camera}),this.mouseRotate=this.create(XEO.MouseRotateCamera,{camera:a.camera}),this.keyboardPan=this.create(XEO.KeyboardPanCamera,{camera:a.camera}),this.mousePan=this.create(XEO.MousePanCamera,{camera:a.camera}),this.keyboardZoom=this.create(XEO.KeyboardZoomCamera,{camera:a.camera}),this.mouseZoom=this.create(XEO.MouseZoomCamera,{camera:a.camera}),this.mousePickEntity=this.create(XEO.MousePickEntity,{rayPick:!0}),this.mousePickEntity.on("pick",this._entityPicked,this),this.mousePickEntity.on("nopick",function(){}),this.cameraFlight=this.create(XEO.CameraFlight,{camera:a.camera,duration:.5}),this.firstPerson=a.firstPerson,this.camera=a.camera,this.active=a.active!==!1},_entityPicked:function(a){var b;a.worldPos&&(b=a.worldPos);var c;if(c=a.entity.worldBoundary.aabb,this._boundaryEntity.geometry.aabb=c,this._boundaryEntity.visibility.visible=!0,b){var d=this.camera.view;XEO.math.subVec3(d.eye,d.look,[]);this.cameraFlight.flyTo({look:b,aabb:c},this._hideEntityBoundary,this)}else this.cameraFlight.flyTo({aabb:c},this._hideEntityBoundary,this)},_hideEntityBoundary:function(){this._boundaryEntity.visibility.visible=!1},_props:{firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.keyboardRotate.firstPerson=a,this.mouseRotate.firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},camera:{set:function(a){this._attach({name:"camera",type:"XEO.Camera",component:a,sceneDefault:!0,onAdded:this._transformUpdated,onAddedScope:this});var b=this._attached.camera;this.keyboardAxis.camera=b,this.keyboardRotate.camera=b,this.mouseRotate.camera=b,this.keyboardPan.camera=b,this.mousePan.camera=b,this.keyboardZoom.camera=b,this.mouseZoom.camera=b,this.cameraFlight.camera=b},get:function(){return this._attached.camera}},active:{set:function(a){a=!!a,this._active!==a&&(this.keyboardAxis.active=a,this.keyboardRotate.active=a,this.mouseRotate.active=a,this.keyboardPan.active=a,this.mousePan.active=a,this.keyboardZoom.active=a,this.mouseZoom.active=a,this.mousePickEntity.active=a,this.cameraFlight.active=a,this.fire("active",this._active=a))},get:function(){return this._active}}},_getJSON:function(){var a={firstPerson:this._firstPerson,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.CameraController=XEO.Component.extend({type:"XEO.CameraController",_init:function(a){this.camera=a.camera,this.active=a.active!==!1},_props:{camera:{set:function(a){this._attach({name:"camera",type:"XEO.Camera",component:a,sceneDefault:!0,onAddedScope:this})},get:function(){return this._attached.camera}},active:{set:function(a){a=!!a,this._active!==a&&(this._active=a,this.fire("active",this._active))},get:function(){return this._active}}},_getJSON:function(){var a={active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.KeyboardAxisCamera=XEO.Component.extend({type:"XEO.KeyboardAxisCamera",_init:function(a){this._onKeyDown=null,this._cameraFly=new XEO.CameraFlight(this.scene,{duration:1}),this.camera=a.camera,this.active=a.active!==!1},_props:{camera:{set:function(a){var b=this._attach({name:"camera",type:"XEO.Camera",component:a,sceneDefault:!0});this._cameraFly.camera=b},get:function(){return this._attached.camera}},active:{set:function(a){if(a=!!a,this._active!==a){this._cameraFly.active=a;var b=this,c=this.scene.input;a?this._onKeyDown=c.on("keydown",function(a){b._attached.camera&&c.mouseover&&(a===c.KEY_NUM_1||a===c.KEY_NUM_2||a===c.KEY_NUM_3||a===c.KEY_NUM_4||a===c.KEY_NUM_5||a===c.KEY_NUM_6)&&XEO.scheduleTask(function(){b._fly(a)})}):this.scene.off(this._onKeyDown),this.fire("active",this._active=a)}},get:function(){return this._active}}},_fly:function(a){var b=this.scene.input,c=this.scene.worldBoundary,d=c.aabb,e=c.center,f=XEO.math.getAABBDiag(d);this._stopFOV=55;var g=Math.abs(f/Math.tan(this._stopFOV/2));switch(a){case b.KEY_NUM_1:this._cameraFly.flyTo({look:e,eye:[e[0]-g,e[1],e[2]],up:[0,1,0]});break;case b.KEY_NUM_2:this._cameraFly.flyTo({look:e,eye:[e[0],e[1],e[2]+g],up:[0,1,0]});break;case b.KEY_NUM_3:this._cameraFly.flyTo({look:e,eye:[e[0]+g,e[1],e[2]],up:[0,1,0]});break;case b.KEY_NUM_4:this._cameraFly.flyTo({look:e,eye:[e[0],e[1],e[2]-g],up:[0,1,0]});break;case b.KEY_NUM_5:this._cameraFly.flyTo({look:e,eye:[e[0],e[1]-g,e[2]],up:[0,0,-1]});break;case b.KEY_NUM_6:this._cameraFly.flyTo({look:e,eye:[e[0],e[1]+g,e[2]],up:[0,0,1]})}},_getJSON:function(){var a={active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1,this._cameraFly.destroy()}})}(),function(){"use strict";XEO.KeyboardRotateCamera=XEO.Component.extend({type:"XEO.KeyboardRotateCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.active=a.active!==!1,this.sensitivity=a.sensitivity},_props:{camera:{set:function(a){this._attach({name:"camera",type:"XEO.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||1,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._attached.camera;if(d&&b.mouseover){var e=a.deltaTime,f=.3*c._sensitivity,g=.3*c._sensitivity;if(!b.ctrlDown&&!b.altDown){var h=b.keyDown[b.KEY_LEFT_ARROW],i=b.keyDown[b.KEY_RIGHT_ARROW],j=b.keyDown[b.KEY_UP_ARROW],k=b.keyDown[b.KEY_DOWN_ARROW];if(h||i||j||k){var l=0,m=0;i?l=-e*f:h&&(l=e*f),k?m=e*g:j&&(m=-e*g),Math.abs(l)>Math.abs(m)?m=0:l=0,0!==l&&d.view.rotateEyeY(l),0!==m&&d.view.rotateEyeX(m)}}}})}else this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.KeyboardPanCamera=XEO.Component.extend({type:"XEO.KeyboardPanCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._attach({name:"camera",type:"XEO.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._attached.camera;if(d&&b.mouseover){var e=a.deltaTime;if(!b.ctrlDown&&!b.altDown){var f=b.keyDown[b.KEY_W],g=b.keyDown[b.KEY_S],h=b.keyDown[b.KEY_A],i=b.keyDown[b.KEY_D],j=b.keyDown[b.KEY_Z],k=b.keyDown[b.KEY_X];if(f||g||h||i||k||j){var l=0,m=0,n=0,o=.01*c._sensitivity;g?m=e*o:f&&(m=-e*o),i?l=e*o:h&&(l=-e*o),k?n=e*o:j&&(n=-e*o),d.view.pan([l,m,n])}}}})}else this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.KeyboardZoomCamera=XEO.Component.extend({type:"XEO.KeyboardZoomCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._attach({name:"camera",type:"XEO.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._attached.camera;if(d&&b.mouseover){var e=a.deltaTime;if(!b.ctrlDown&&!b.altDown){var f=b.keyDown[b.KEY_ADD],g=b.keyDown[b.KEY_SUBTRACT];if(f||g){var h=0,i=.01*c.sensitivity;g?h=e*i:f&&(h=-e*i),d.view.zoom(h)}}}})}else null!==this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.MouseRotateCamera=XEO.Component.extend({type:"XEO.MouseRotateCamera",_init:function(a){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._attach({name:"camera",type:"XEO.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e,f=0,g=0,h=!1,i=!1;this._onTick=this.scene.on("tick",function(){var a=this._attached.camera;a&&i&&h&&(0!==f&&(e=-f*this._sensitivity,this._firstPerson?a.view.rotateLookY(e):a.view.rotateEyeY(e),f=0),0!==g&&(e=g*this._sensitivity,this._firstPerson?a.view.rotateLookX(-e):a.view.rotateEyeX(e),g=0))},this),this._onMouseDown=b.on("mousedown",function(a){f=0,g=0,i&&(!b.mouseDownLeft||b.mouseDownRight||b.keyDown[b.KEY_SHIFT]||b.mouseDownMiddle?h=!1:(h=!0,c=a[0],d=a[1]))},this),this._onMouseUp=b.on("mouseup",function(){h=!1,f=0,g=0}),this._onMouseOver=b.on("mouseover",function(){i=!0,f=0,g=0}),this._onMouseOut=b.on("mouseout",function(){i=!1,f=0,g=0}),this._onMouseMove=b.on("mousemove",function(a){
i&&h&&(f+=(a[0]-c)*this._sensitivity,g+=(a[1]-d)*this._sensitivity,c=a[0],d=a[1])},this)}else b.off(this._onTick),b.off(this._onMouseDown),b.off(this._onMouseUp),b.off(this._onMouseMove),b.off(this._onMouseOver),b.off(this._onMouseOut);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.MousePanCamera=XEO.Component.extend({type:"XEO.MousePanCamera",_init:function(a){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._attach({name:"camera",type:"XEO.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a?.03*a:.03,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e=0,f=0,g=!1,h=this;this._onTick=this.scene.on("tick",function(){var a=h._attached.camera;a&&(0!==e||0!==f)&&(a.view.pan([e,f,0]),e=0,f=0)}),this._onMouseDown=b.on("mousedown",function(a){b.mouseDownLeft&&b.mouseDownRight||b.mouseDownLeft&&b.keyDown[b.KEY_SHIFT]||b.mouseDownMiddle?(c=a[0],d=a[1],g=!0):g=!1}),this._onMouseUp=b.on("mouseup",function(){g=!1}),this._onMouseUp=b.on("mouseout",function(){g=!1}),this._onMouseMove=b.on("mousemove",function(a){g&&(e+=(a[0]-c)*h._sensitivity,f+=(a[1]-d)*h._sensitivity,c=a[0],d=a[1])})}else b.off(this._onTick),b.off(this._onMouseDown),b.off(this._onMouseUp),b.off(this._onMouseMove);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.MousePickEntity=XEO.Component.extend({type:"XEO.MousePickEntity",_init:function(a){this.rayPick=a.rayPick,this.active=a.active!==!1},_props:{active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e=this,f=2,g=!1,h=!1;this._onMouseOver=b.on("mouseover",function(){g=!0}),this._onMouseOut=b.on("mouseout",function(){g=!1}),this._onMouseDown=b.on("mousedown",function(a){g&&(h=!0,c=a[0],d=a[1])}),this._onMouseUp=b.on("mouseup",function(a){if(h&&g){if(c>=a[0]-f&&c<=a[0]+f&&d>=a[1]-f&&d<=a[1]+f){var b=e.scene.pick({canvasPos:a,rayPick:e._rayPick});b?e.fire("pick",b):e.fire("nopick",{canvasPos:a})}h=!1}})}else b.off(this._onMouseDown),b.off(this._onMouseUp);this.fire("active",this._active=a)}},get:function(){return this._active}},rayPick:{set:function(a){a=!!a,this._rayPick!==a&&(this._dirty=!1,this.fire("rayPick",this._rayPick=a))},get:function(){return this._rayPick}}},_getJSON:function(){var a={rayPick:this._rayPick,active:this._active};return a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.MouseZoomCamera=XEO.Component.extend({type:"XEO.MouseZoomCamera",_init:function(a){this._onTick=null,this._onMouseWheel=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._attach({name:"camera",type:"XEO.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){if(a){var b=0,c=0,d=!1,e=!1,f=0,g=XEO.math.vec3(),h=XEO.math.vec3(),i=XEO.math.vec3(),j=this;this._onMouseWheel=this.scene.input.on("mousewheel",function(a){b=a,0===b?(e=!1,d=!1):d=!0}),this._onTick=this.scene.on("tick",function(){var a=j._attached.camera;if(a){var k=a.view.eye,l=a.view.look;g[0]=k[0],g[1]=k[1],g[2]=k[2],h[0]=l[0],h[1]=l[1],h[2]=l[2],XEO.math.subVec3(g,h,i);var m=Math.abs(XEO.math.lenVec3(i)),n=1e3,o=j._sensitivity*(2+m/n);d&&(c=b*o,f=0,d=!1,e=!0),e&&(b>0?(f+=.2*o,f>c&&(e=!1)):0>b&&(f-=.2*o,c>f&&(e=!1)),e&&a.view.zoom(f))}})}else null!==this._onTick&&(this.scene.off(this._onTick),this.scene.input.off(this._onMouseWheel));this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.Cull=XEO.Component.extend({type:"XEO.Cull",_init:function(a){this._state=new XEO.renderer.Cull({culled:!0}),this.culled=a.culled},_props:{culled:{set:function(a){a=!!a,a!==this._state.culled&&(this._state.culled=a,this._renderer.drawListDirty=!0,this.fire("culled",this._state.culled))},get:function(){return this._state.culled}}},_compile:function(){this._renderer.cull=this._state},_getJSON:function(){return{culled:this.culled}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Visibility=XEO.Component.extend({type:"XEO.Visibility",_init:function(a){this._state=new XEO.renderer.Visibility({visible:!0}),this.visible=a.visible},_props:{visible:{set:function(a){this._state.visible=a!==!1,this._renderer.drawListDirty=!0,this.fire("visible",this._state.visible)},get:function(){return this._state.visible}}},_compile:function(){this._renderer.visibility=this._state},_getJSON:function(){return{visible:this.visible}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Curve=XEO.Component.extend({type:"XEO.Curve",_init:function(a){this.t=a.t},_props:{t:{set:function(a){a=a||0,this._t=0>a?0:a>1?1:a,this.fire("t",this._t)},get:function(){return this._t}},tangent:{get:function(){return this.getTangent(this._t)}},length:{get:function(){var a=this._getLengths();return a[a.length-1]}}},getTangent:function(a){var b=1e-4;void 0===a&&(a=this._t);var c=a-b,d=a+b;0>c&&(c=0),d>1&&(d=1);var e=this.getPoint(c),f=this.getPoint(d),g=XEO.math.subVec3(f,e,[]);return XEO.math.normalizeVec3(g,[])},_getPointAt:function(a){var b=this._getUToTMapping(a);return this.getPoint(b)},getPoints:function(a){a||(a=5);var b,c=[];for(b=0;a>=b;b++)c.push(this.getPoint(b/a));return c},getSpacedPoints:function(a){a||(a=5);var b,c=[];for(b=0;a>=b;b++)c.push(this._getPointAt(b/a));return c},_getLengths:function(a){if(a||(a=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length===a+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var b,c,d=[],e=this.getPoint(0),f=0;for(d.push(0),c=1;a>=c;c++)b=this.getPoint(c/a),f+=XEO.math.lenVec3(XEO.math.subVec3(b,e,[])),d.push(f),e=b;return this.cacheArcLengths=d,d},_updateArcLengths:function(){this.needsUpdate=!0,this._getLengths()},_getUToTMapping:function(a,b){var c,d,e=this._getLengths(),f=0,g=e.length;d=b?b:a*e[g-1];for(var h,i=0,j=g-1;j>=i;)if(f=Math.floor(i+(j-i)/2),h=e[f]-d,0>h)i=f+1;else{if(!(h>0)){j=f;break}j=f-1}if(f=j,e[f]===d)return c=f/(g-1);var k=e[f],l=e[f+1],m=l-k,n=(d-k)/m;return c=(f+n)/(g-1)}})}(),function(){"use strict";XEO.CubicBezierCurve=XEO.Curve.extend({type:"XEO.CubicBezierCurve",_init:function(a){this._super(a),this.v0=a.v0,this.v1=a.v1,this.v2=a.v2,this.v3=a.v3,this.t=a.t},_props:{v0:{set:function(a){this.fire("v0",this._v0=a||[0,0,0])},get:function(){return this._v0}},v1:{set:function(a){this.fire("v1",this._v1=a||[0,0,0])},get:function(){return this._v1}},v2:{set:function(a){this.fire("v2",this._v2=a||[0,0,0])},get:function(){return this._v2}},v3:{set:function(a){this.fire("v3",this._v3=a||[0,0,0])},get:function(){return this._v3}},t:{set:function(a){a=a||0,this._t=0>a?0:a>1?1:a,this.fire("t",this._t)},get:function(){return this._t}},point:{get:function(){return this.getPoint(this._t)}}},getPoint:function(a){var b=XEO.math,c=b.vec3();return c[0]=b.b3(a,this._v0[0],this._v1[0],this._v2[0],this._v3[0]),c[1]=b.b3(a,this._v0[1],this._v1[1],this._v2[1],this._v3[1]),c[2]=b.b3(a,this._v0[2],this._v1[2],this._v2[2],this._v3[2]),c},_getJSON:function(){return{v0:this._v0,v1:this._v1,v2:this._v2,v3:this._v3,t:this._t}}})}(),function(){"use strict";XEO.SplineCurve=XEO.Curve.extend({type:"XEO.SplineCurve",_init:function(a){this._super(a),this.points=a.points,this.t=a.t},_props:{points:{set:function(a){this._points=a||[],this.fire("points",this._points)},get:function(){return this._points}},t:{set:function(a){a=a||0,this._t=0>a?0:a>1?1:a,this.fire("t",this._t)},get:function(){return this._t}},point:{get:function(){return this.getPoint(this._t)}}},getPoint:function(a){var b=XEO.math,c=this.points,d=(c.length-1)*a,e=Math.floor(d),f=d-e,g=c[0===e?e:e-1],h=c[e],i=c[e>c.length-2?c.length-1:e+1],j=c[e>c.length-3?c.length-1:e+2],k=b.vec3();return k[0]=b.catmullRomInterpolate(g[0],h[0],i[0],j[0],f),k[1]=b.catmullRomInterpolate(g[1],h[1],i[1],j[1],f),k[2]=b.catmullRomInterpolate(g[2],h[2],i[2],j[2],f),k},_getJSON:function(){return{v0:this._v0,v1:this._v1,v2:this._v2,v3:this._v3,t:this._t}}})}(),function(){"use strict";XEO.QuadraticBezierCurve=XEO.Curve.extend({type:"XEO.QuadraticBezierCurve",_init:function(a){this._super(a),this.v0=a.v0,this.v1=a.v1,this.v2=a.v2,this.t=a.t},_props:{v0:{set:function(a){this.fire("v0",this._v0=a||[0,0,0])},get:function(){return this._v0}},v1:{set:function(a){this.fire("v1",this._v1=a||[0,0,0])},get:function(){return this._v1}},v2:{set:function(a){this.fire("v2",this._v2=a||[0,0,0])},get:function(){return this._v2}},t:{set:function(a){a=a||0,this._t=0>a?0:a>1?1:a,this.fire("t",this._t)},get:function(){return this._t}},point:{get:function(){return this.getPoint(this._t)}}},getPoint:function(a){var b=XEO.math,c=b.vec3();return c[0]=b.b2(a,this._v0[0],this._v1[0],this._v2[0]),c[1]=b.b2(a,this._v0[1],this._v1[1],this._v2[1]),c[2]=b.b2(a,this._v0[2],this._v1[2],this._v2[2]),c},_getJSON:function(){return{v0:this._v0,v1:this._v1,v2:this._v2,t:this._t}}})}(),function(){"use strict";XEO.Path=XEO.Curve.extend({type:"XEO.Path",_init:function(a){this._super(a),this._cachedLengths=[],this._dirty=!0,this._curves=[],this._t=0,this._dirtySubs=[],this._destroyedSubs=[],this.curves=a.curves||[],this.t=a.t},addCurve:function(a){this._curves.push(a),this._dirty=!0,this.fire("curves",this._curves)},_props:{curves:{set:function(a){function b(){g._dirty=!0}function c(){var a=this.id;for(e=0,f=g._curves.length;f>e;e++)if(g._curves[e].id===a)return g._curves=g._curves.slice(e,e+1),g._dirtySubs=g._dirtySubs.slice(e,e+1),g._destroyedSubs=g._destroyedSubs.slice(e,e+1),g._dirty=!0,void g.fire("curves",g._curves)}a=a||[];var d,e,f;for(e=0,f=this._curves.length;f>e;e++)d=this._curves[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._curves=[],this._dirtySubs=[],this._destroyedSubs=[];var g=this;for(e=0,f=a.length;f>e;e++){if(d=a[e],XEO._isNumeric(d)||XEO._isString(d)){var h=d;if(d=this.scene.components[h],!d){this.error("Component not found: "+XEO._inQuotes(h));continue}}var i=d.type;"XEO.SplineCurve"===i||"XEO.Path"===i||"XEO.CubicBezierCurve"===i||"XEO.QuadraticBezierCurve"===i?(this._curves.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c))):this.error("Component "+XEO._inQuotes(d.id)+" is not a XEO.SplineCurve, XEO.Path or XEO.QuadraticBezierCurve")}this._dirty=!0,this.fire("curves",this._curves)},get:function(){return this._curves}},t:{set:function(a){a=a||0,this._t=0>a?0:a>1?1:a,this.fire("t",this._t)},get:function(){return this._t}},point:{get:function(){return this.getPoint(this._t)}},length:{get:function(){var a=this._getCurveLengths();return a[a.length-1]}}},getPoint:function(a){for(var b,c,d=a*this.length,e=this._getCurveLengths(),f=0;f<e.length;){if(e[f]>=d){b=e[f]-d,c=this._curves[f];var g=1-b/c.length;return c._getPointAt(g)}f++}return null},_getCurveLengths:function(){if(!this._dirty)return this._cachedLengths;var a,b=[],c=0,d=this._curves.length;for(a=0;d>a;a++)c+=this._curves[a].length,b.push(c);return this._cachedLengths=b,this._dirty=!1,b},_getJSON:function(){for(var a=[],b=0,c=this._curves.length;c>b;b++)a.push(this._curves[b].id);return{curves:a,t:this._t}},_destroy:function(){var a,b,c;for(a=0,b=this._curves.length;b>a;a++)c=this._curves[a],c.off(this._dirtySubs[a]),c.off(this._destroyedSubs[a]);this._super()}})}(),function(){"use strict";XEO.Geometry=XEO.Component.extend({type:"XEO.Geometry",_init:function(a){var b=this;this._state=new XEO.renderer.Geometry({primitive:null,primitiveName:null,positions:null,colors:null,normals:null,uv:null,tangents:null,indices:null,getTangents:function(){return b._tangentsDirty&&b._buildTangents(),b._tangents},getPickPositions:function(){return b._pickVBOsDirty&&b._buildPickVBOs(),b._pickPositions},getPickColors:function(){return b._pickVBOsDirty&&b._buildPickVBOs(),b._pickColors}}),this._updateScheduled=!1,this._vboUpdateScheduled=!1,this._hashDirty=!0,this._positionsData=null,this._colorsData=null,this._normalsData=null,this._uvData=null,this._tangentsData=null,this._indicesData=null,this._tangents=null,this._pickPositions=null,this._pickColors=null,this._vboUpdateScheduled=!1,this._positionsDirty=!0,this._colorsDirty=!0,this._normalsDirty=!0,this._uvDirty=!0,this._tangentsDirty=!0,this._indicesDirty=!0,this._pickVBOsDirty=!0,this._localBoundary=null,this._boundaryDirty=!0;var c=!(a.positions||a.normals||a.uv||a.indices);if(c)this.primitive=a.primitive;else{var d=(!a.primitive||"line-strip"===a.primitive)&&a.positions&&!a.indices;if(d){for(var e=[],f=0,g=a.positions.length/3;g>f;f++)e.push(f);this.primitive="line-strip",this.positions=a.positions,this.indices=e}else this.primitive=a.primitive,this.positions=a.positions,this.colors=a.colors,this.normals=a.normals,this.uv=a.uv,this.tangents=a.tangents,this.indices=a.indices}this.autoNormals=a.autoNormals,this.usage=a.usage,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._scheduleVBOUpdate,this),XEO.stats.memory.meshes++},_scheduleUpdate:function(){this._updateScheduled||(this._updateScheduled=!0,XEO.scheduleTask(this._doUpdate,this))},_doUpdate:function(){this._updateScheduled&&(this._vboUpdateScheduled=!0,this._update&&this._update(),this._updateScheduled=!1),this._vboUpdateScheduled&&this._doVBOUpdate()},_update:null,_scheduleVBOUpdate:function(){this._vboUpdateScheduled||(this._vboUpdateScheduled=!0,XEO.scheduleTask(this._doVBOUpdate,this))},_doVBOUpdate:function(){if(this._updateScheduled)this._update&&(this._vboUpdateScheduled=!0,this._update()),this._updateScheduled=!1,this._vboUpdateScheduled=!0;else if(!this._vboUpdateScheduled)return;var a=this.scene.canvas.gl;switch(this._state.primitiveName){case"points":this._state.primitive=a.POINTS;break;case"lines":this._state.primitive=a.LINES;break;case"line-loop":this._state.primitive=a.LINE_LOOP;break;case"line-strip":this._state.primitive=a.LINE_STRIP;break;case"triangles":this._state.primitive=a.TRIANGLES;break;case"triangle-strip":this._state.primitive=a.TRIANGLE_STRIP;break;case"triangle-fan":this._state.primitive=a.TRIANGLE_FAN;break;default:this._state.primitive=a.TRIANGLES}var b=a.STATIC_DRAW,c=XEO.stats.memory;this._positionsDirty&&(this._state.positions&&(c.positions-=this._state.positions.numItems,this._state.positions.destroy()),this._state.positions=this._positionsData?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,this._positionsData,this._positionsData.length,3,b):null,this._state.positions&&(c.positions+=this._state.positions.numItems),this._positionsDirty=!1,this._pickVBOsDirty=!0),this._colorsDirty&&(this._state.colors&&(c.colors-=this._state.colors.numItems,this._state.colors.destroy()),this._state.colors=this._colorsData?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,this._colorsData,this._colorsData.length,4,b):null,this._state.colors&&(c.colors+=this._state.colors.numItems),this._colorsDirty=!1),this._normalsDirty&&(this._state.normals&&(c.normals-=this._state.normals.numItems,this._state.normals.destroy()),this._autoNormals&&this._positionsData&&this._indicesData&&(this._normalsData=XEO.math.buildNormals(this._positionsData,this._indicesData)),this._state.normals=this._normalsData?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,this._normalsData,this._normalsData.length,3,b):null,this._state.normals&&(c.normals+=this._state.normals.numItems),this._normalsDirty=!1,this._tangentsDirty=!0),this._uvDirty&&(this._state.uv&&(c.uvs-=this._state.uv.numItems,this._state.uv.destroy()),this._state.uv=this._uvData?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,this._uvData,this._uvData.length,2,b):null,this._state.uv&&(c.uvs+=this._state.uv.numItems),this._uvDirty=!1,this._tangentsDirty=!0),this._indicesDirty&&(this._state.indices&&(c.indices-=this._state.indices.numItems,this._state.indices.destroy()),this._state.indices=this._indicesData?new XEO.renderer.webgl.ArrayBuffer(a,a.ELEMENT_ARRAY_BUFFER,this._indicesData,this._indicesData.length,1,b):null,this._state.indices&&(c.indices+=this._state.indices.numItems),this._indicesDirty=!1,this._pickVBOsDirty=!0),this._vboUpdateScheduled=!1,this._setBoundaryDirty()},_buildTangents:function(){if(this._tangentsDirty){(this._updateScheduled||this._vboUpdateScheduled)&&this._doUpdate();var a=XEO.stats.memory;if(this._tangents&&(a.tangents-=this._tangents.numItems,this._tangents.destroy()),!this._positionsData||!this._indicesData||!this._uvData)return null;this._tangentsData=XEO.math.buildTangents(this._positionsData,this._indicesData,this._uvData);var b=this.scene.canvas.gl,c=b.STATIC_DRAW;this._tangents=this._tangentsData?new XEO.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._tangentsData,this._tangentsData.length,3,c):null,this._tangents&&(a.tangents+=this._tangents.numItems),this._tangentsDirty=!1}},_buildPickVBOs:function(){if(this._pickVBOsDirty){if((this._updateScheduled||this._vboUpdateScheduled)&&this._doUpdate(),this._destroyPickVBOs(),this._positionsData&&this._indicesData){var a=this.scene.canvas.gl,b=a.STATIC_DRAW,c=XEO.math.getPickPrimitives(this._positionsData,this._indicesData),d=c.positions,e=c.colors;this._pickPositions=new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,d,d.length,3,b),this._pickColors=new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,e,e.length,4,b);var f=XEO.stats.memory;f.positions+=this._pickPositions.numItems,f.colors+=this._pickColors.numItems}this._pickVBOsDirty=!1}},_destroyPickVBOs:function(){var a=XEO.stats.memory;this._pickPositions&&(this._pickPositions.destroy(),a.positions-=this._pickPositions.numItems,this._pickPositions=null),this._pickColors&&(this._pickColors.destroy(),a.colors-=this._pickColors.numItems,this._pickColors=null),this._pickVBOsDirty=!0},_props:{usage:{set:function(a){a=a||"static","static"!==a&&"dynamic"!==a&&"stream"!==a&&(this.error("Unsupported value for 'usage': '"+a+"' - supported values are 'static', 'dynamic' and 'stream'."),a="static"),this._state.usageName=a,this._scheduleVBOUpdate(),this.fire("dirty",!0),this.fire("usage",this._state.usageName)},get:function(){return this._state.usageName}},primitive:{set:function(a){a=a||"triangles","points"!==a&&"lines"!==a&&"line-loop"!==a&&"line-strip"!==a&&"triangles"!==a&&"triangle-strip"!==a&&"triangle-fan"!==a&&(this.error("Unsupported value for 'primitive': '"+a+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),a="triangles"),this._state.primitiveName=a,this._scheduleVBOUpdate(),this._hashDirty=!0,this.fire("dirty",!0),this.fire("primitive",this._state.primitiveName)},get:function(){return this._state.primitiveName}},positions:{set:function(a){var b=!this._positionsData!=!a;a&&a.constructor!=Float32Array&&(a=new Float32Array(a)),this._positionsData=a,this._positionsDirty=!0,this._scheduleVBOUpdate(),b&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("positions",this._positionsData),this.fire("localBoundary",!0),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._positionsData}},normals:{set:function(a){var b=!this._normalsData!=!a;a&&a.constructor!=Float32Array&&(a=new Float32Array(a)),this._normalsData=a,this._normalsDirty=!0,this._scheduleVBOUpdate(),b&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire(" normals",this._normalsData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._normalsData}},uv:{set:function(a){var b=!this._uvData!=!a;a&&a.constructor!=Float32Array&&(a=new Float32Array(a)),this._uvData=a,this._uvDirty=!0,this._scheduleVBOUpdate(),b&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("uv",this._uvData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._uvData}},colors:{set:function(a){var b=!this._colorsData!=!a;a&&a.constructor!=Float32Array&&(a=new Float32Array(a)),this._colorsData=a,this._colorsDirty=!0,this._scheduleVBOUpdate(),b&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("colors",this._colorsData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._colorsData}},indices:{set:function(a){var b=!this._indicesData&&!a;if(a){var c=XEO.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint;if(!c&&a.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");var d=c?Uint32Array:Uint16Array;a.constructor!=Uint16Array&&a.constructor!=Uint32Array&&(a=new d(a))}this._indicesData=a,this._indicesDirty=!0,this._scheduleVBOUpdate(),b&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("indices",this._indicesData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._indicesData}},localBoundary:{get:function(){if(!this._localBoundary){var a=this;this._localBoundary=new XEO.Boundary3D(this.scene,{getDirty:function(){return a._boundaryDirty?(a._boundaryDirty=!1,!0):!1},getPositions:function(){return a._updateScheduled&&a._doUpdate(),a._positionsData}}),this._localBoundary.on("destroyed",function(){a._localBoundary=null})}return this._localBoundary}},autoNormals:{set:function(a){a=!!a,this._autoNormals!==a&&(this._autoNormals=a,this._normalsDirty=!0,this._scheduleVBOUpdate(),this.fire("autoNormals",this._autoNormals))},get:function(){return this._autoNormals}}},_setBoundaryDirty:function(){this._boundaryDirty||(this._boundaryDirty=!0,this._localBoundary&&this._localBoundary.fire("updated",!0))},_compile:function(){(this._updateScheduled||this._vboUpdateScheduled)&&this._doUpdate(),this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._renderer.geometry=this._state},_makeHash:function(){var a=this._state,b=["/g"];b.push("/"+a.primitive+";"),a.positions&&b.push("0"),a.colors&&b.push("1"),a.normals&&b.push("2"),a.uv&&b.push("3"),b.push(";"),a.hash=b.join("")},_getJSON:function(){return this._updateScheduled&&this._update(),{primitive:this._state.primitiveName,positions:this._positionsData,normals:this._normalsData,uv:this._uvData,colors:this._colorsData,indices:this._indicesData}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.positions&&this._state.positions.destroy(),this._state.colors&&this._state.colors.destroy(),this._state.normals&&this._state.normals.destroy(),this._state.uv&&this._state.uv.destroy(),this._state.indices&&this._state.indices.destroy(),this._tangentsData&&this._tangentsData.destroy(),this._pickPositions&&this._pickPositions.destroy(),this._pickColors&&this._pickColors.destroy(),this._localBoundary&&this._localBoundary.destroy(),this._state.destroy(),XEO.stats.memory.meshes--}})}(),function(){"use strict";XEO.BoxGeometry=XEO.Geometry.extend({type:"XEO.BoxGeometry",_init:function(a){this._super(a),this.xSize=a.xSize,this.ySize=a.ySize,this.zSize=a.zSize},_update:function(){var a=-this._xSize,b=-this._ySize,c=-this._zSize,d=this._xSize,e=this._ySize,f=this._zSize;this.positions=[d,e,f,a,e,f,a,b,f,d,b,f,d,e,f,d,b,f,d,b,c,d,e,c,d,e,f,d,e,c,a,e,c,a,e,f,a,e,f,a,e,c,a,b,c,a,b,f,a,b,c,d,b,c,d,b,f,a,b,f,d,b,c,a,b,c,a,e,c,d,e,c],this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],this.uv=[1,1,0,1,0,0,1,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1],this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],this.tangents=null},_props:{xSize:{set:function(a){a=a||1,this._xSize!==a&&(0>a&&(this.warn("negative xSize not allowed - will invert"),a=-1*a),this._xSize=a,this._scheduleUpdate(),this.fire("xSize",this._xSize))},get:function(){return this._xSize}},ySize:{set:function(a){a=a||1,this._ySize!==a&&(0>a&&(this.warn("negative ySize not allowed - will invert"),a=-1*a),this._ySize=a,this._scheduleUpdate(),this.fire("ySize",this._ySize))},get:function(){return this._ySize}},zSize:{set:function(a){a=a||1,this._zSize!==a&&(0>a&&(this.warn("negative zSize not allowed - will invert"),a=-1*a),this._zSize=a,this._scheduleUpdate(),this.fire("zSize",this._zSize))},get:function(){return this._zSize}}},_getJSON:function(){return{xSize:this._xSize,ySize:this._ySize,zSize:this._zSize}}})}(),function(){"use strict";XEO.BoundaryGeometry=XEO.Geometry.extend({type:"XEO.BoundaryGeometry",_init:function(a){this._super(a),this.primitive=a.primitive||"lines",this.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],a.boundary?this.boundary=a.boundary:a.obb?this.obb=a.obb:a.aabb?this.aabb=a.aabb:a.positions?this.positions=a.positions:this.positions=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]},_props:{boundary:{set:function(a){var b=!1,c=this;this._attach({name:"boundary",type:"XEO.Boundary3D",component:a,sceneDefault:!1,on:{updated:function(){b||(b=!0,XEO.scheduleTask(function(){c._setPositionsFromOBB(c._attached.boundary.obb),b=!1}))}},onAttached:function(){c._setPositionsFromOBB(c._attached.boundary.obb)}})},get:function(){return this._attached.boundary}},obb:{set:function(a){a&&(this._attached.boundary&&(this.boundary=null),this._setPositionsFromOBB(a))}},aabb:{set:function(a){a&&(this._attached.boundary&&(this.boundary=null),this._setPositionsFromAABB(a))}}},_setPositionsFromOBB:function(a){this.positions=[a[0][0],a[0][1],a[0][2],a[1][0],a[1][1],a[1][2],a[2][0],a[2][1],a[2][2],a[3][0],a[3][1],a[3][2],a[4][0],a[4][1],a[4][2],a[5][0],a[5][1],a[5][2],a[6][0],a[6][1],a[6][2],a[7][0],a[7][1],a[7][2]]},_setPositionsFromAABB:function(a){this.positions=[a.max[0],a.max[1],a.max[2],a.max[0],a.min[1],a.max[2],a.min[0],a.min[1],a.max[2],a.min[0],a.max[1],a.max[2],a.max[0],a.max[1],a.min[2],a.max[0],a.min[1],a.min[2],a.min[0],a.min[1],a.min[2],a.min[0],a.max[1],a.min[2]]},_getJSON:function(){var a={};return this._attached.boundary?a.boundary=this._attached.boundary.id:a.positions&&(a.positions=this.positions),a},_destroy:function(){this._attached.boundary&&(this._attached.boundary.off(this._onBoundaryUpdated),this._attached.boundary.off(this._onBoundaryDestroyed)),this._super()}})}(),function(){"use strict";XEO.TorusGeometry=XEO.Geometry.extend({type:"XEO.TorusGeometry",_init:function(a){this._super(a),this.lod=a.lod,this.radius=a.radius,this.tube=a.tube,this.radialSegments=a.radialSegments,this.tubeSegments=a.tubeSegments,this.arc=a.arc},_update:function(){var a=this._radius,b=this._tube,c=Math.floor(this._radialSegments*this._lod),d=Math.floor(this._tubeSegments*this._lod),e=this._arc;4>c&&(c=4),4>d&&(d=4);var f,g,h,i,j,k,l,m,n,o,p=[],q=[],r=[],s=[],t=0;for(o=0;c>=o;o++)for(n=0;d>=n;n++)f=n/d*e,g=o/c*Math.PI*2,h=a*Math.cos(f),i=a*Math.sin(f),j=(a+b*Math.cos(g))*Math.cos(f),k=(a+b*Math.cos(g))*Math.sin(f),l=b*Math.sin(g),p.push(j),p.push(k),p.push(l),r.push(1-n/d),r.push(1-o/c),m=XEO.math.normalizeVec3(XEO.math.subVec3([j,k,l],[h,i,t],[]),[]),q.push(m[0]),q.push(m[1]),q.push(m[2]);var u,v,w,x;for(o=1;c>=o;o++)for(n=1;d>=n;n++)u=(d+1)*o+n-1,v=(d+1)*(o-1)+n-1,w=(d+1)*(o-1)+n,x=(d+1)*o+n,s.push(u),s.push(v),s.push(w),s.push(w),s.push(x),s.push(u);this.positions=p,this.normals=q,this.uv=r,this.indices=s},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((0>a||a>1)&&(this.warn("clamping lod to [0..1]"),a=0>a?0:1),this._lod=a,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},radius:{set:function(a){a=a||1,this._radius!==a&&(0>a&&(this.warn("negative radius not allowed - will invert"),a=-1*a),this._radius=a,this._scheduleUpdate(),this.fire("radius",this._radius))},get:function(){return this._radius}},tube:{set:function(a){a=a||.3,this._tube!==a&&(0>a&&(this.warn("negative tube not allowed - will invert"),a=-1*a),this._tube=a,this._scheduleUpdate(),this.fire("tube",this._tube))},get:function(){return this._tube}},radialSegments:{set:function(a){a=a||32,this._radialSegments!==a&&(0>a&&(this.warn("negative radialSegments not allowed - will invert"),a=-1*a),this._radialSegments=a,this._scheduleUpdate(),this.fire("radialSegments",this._radialSegments))},get:function(){return this._radialSegments}},tubeSegments:{set:function(a){a=a||24,this._tubeSegments!==a&&(0>a&&(this.warn("negative tubeSegments not allowed - will invert"),a=-1*a),this._tubeSegments=a,this._scheduleUpdate(),this.fire("tubeSegments",this._tubeSegments))},get:function(){return this._tubeSegments}},arc:{set:function(a){a=a||2*Math.PI,this._arc!==a&&(0>a&&(this.warn("negative arc not allowed - will invert"),a=-1*a),this._arc=a,this._scheduleUpdate(),this.fire("arc",this._arc))},get:function(){return this._arc}}},_getJSON:function(){return{radius:this._radius,tube:this._tube,radialSegments:this._radialSegments,tubeSegments:this._tubeSegments,arc:this._arc}}})}(),function(){"use strict";XEO.SphereGeometry=XEO.Geometry.extend({type:"XEO.SphereGeometry",_init:function(a){this._super(a),this.lod=a.lod,this.radius=a.radius,this.heightSegments=a.heightSegments,this.widthSegments=a.widthSegments},_update:function(){var a=this._radius,b=Math.floor(this._lod*this._heightSegments),c=Math.floor(this._lod*this._widthSegments);18>b&&(b=18),18>c&&(c=18);var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=[],t=[],u=[],v=[];for(d=0;b>=d;d++)for(f=d*Math.PI/b,g=Math.sin(f),h=Math.cos(f),e=0;c>=e;e++)i=2*e*Math.PI/c,j=Math.sin(i),k=Math.cos(i),l=k*g,m=h,n=j*g,o=1-e/c,p=1-d/b,t.push(l),t.push(m),t.push(n),u.push(o),u.push(p),s.push(a*l),s.push(a*m),s.push(a*n);for(d=0;b>d;d++)for(e=0;c>e;e++)q=d*(c+1)+e,r=q+c+1,v.push(q+1),v.push(r+1),v.push(r),v.push(q+1),v.push(r),v.push(q);this.positions=s,this.normals=t,this.uv=u,this.indices=v},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((0>a||a>1)&&(this.warn("clamping lod to [0..1]"),a=0>a?0:1),this._lod=a,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},radius:{set:function(a){a=a||1,this._radius!==a&&(0>a&&(this.warn("negative radius not allowed - will invert"),a=-1*a),this._radius=a,this._scheduleUpdate(),this.fire("radius",this._radius))},get:function(){return this._radius}},heightSegments:{set:function(a){a=a||18,this._heightSegments!==a&&(0>a&&(this.warn("negative heightSegments not allowed - will invert"),a=-1*a),this._heightSegments=a,this._scheduleUpdate(),this.fire("heightSegments",this._heightSegments))},get:function(){return this._heightSegments}},widthSegments:{set:function(a){a=a||24,this._widthSegments!==a&&(0>a&&(this.warn("negative widthSegments not allowed - will invert"),a=-1*a),this._widthSegments=a,this._scheduleUpdate(),this.fire("widthSegments",this._widthSegments))},get:function(){return this._widthSegments}}},_getJSON:function(){return{radius:this._radius,heightSegments:this._heightSegments,widthSegments:this._widthSegments}}})}(),XEO.PathGeometry=XEO.Geometry.extend({type:"XEO.PathGeometry",_init:function(a){this._super(a),this.path=a.path,this.divisions=a.divisions},_update:function(){var a=this._attached.path;if(a){var b,c,d,e=a.getPoints(this._divisions),f=[];for(b=0,c=e.length;c>b;b++)d=e[b],
f.push(d[0]),f.push(d[1]),f.push(d[2]);var g=[];for(b=0,c=e.length-1;c>b;b++)g.push(b),g.push(b+1);this.primitive="lines",this.positions=f,this.indices=g,this.normals=null,this.uv=null}},_props:{path:{set:function(a){this._attach({name:"path",type:"XEO.Path",component:a,sceneDefault:!1,on:{curves:{callback:this._scheduleUpdate,scope:this}}})},get:function(){return this._attached.path}},divisions:{set:function(a){a=a||6,this._divisions=a,this._scheduleUpdate(),this.fire("divisions",this._divisions)},get:function(){return this._divisions}}},_getJSON:function(){var a={divisions:this._divisions};return this._attached.path&&(a.path=this._attached.path.id),a}}),function(){"use strict";XEO.CylinderGeometry=XEO.Geometry.extend({type:"XEO.CylinderGeometry",_init:function(a){this._super(a),this.lod=a.lod,this.radiusTop=a.radiusTop,this.radiusBottom=a.radiusBottom,this.height=a.height,this.radialSegments=a.radialSegments,this.heightSegments=a.heightSegments,this.openEnded=a.openEnded},_update:function(){var a=this._radiusTop,b=this._radiusBottom,c=this._height,d=Math.floor(this._radialSegments*this._lod),e=Math.floor(this._heightSegments*this._lod);3>d&&(d=3),1>e&&(e=1);var f,g,h,i,j,k,l,m,n,o,p,q,r=this._openEnded,s=c/2,t=c/e,u=2*Math.PI/d,v=1/d,w=(a-b)/e,x=[],y=[],z=[],A=[],B=(90-180*Math.atan(c/(b-a))/Math.PI)/90;for(f=0;e>=f;f++)for(j=a-f*w,k=s-f*t,g=0;d>=g;g++)h=Math.sin(g*u),i=Math.cos(g*u),y.push(j*h),y.push(B),y.push(j*i),z.push(g*v),z.push(1-1*f/e),x.push(j*h),x.push(k),x.push(j*i);for(f=0;e>f;f++)for(g=0;d>=g;g++)m=f*(d+1)+g,n=m+d,A.push(m),A.push(n),A.push(n+1),A.push(m),A.push(n+1),A.push(m+1);if(!r&&a>0){for(o=x.length/3,y.push(0),y.push(1),y.push(0),z.push(.5),z.push(.5),x.push(0),x.push(s),x.push(0),g=0;d>=g;g++)h=Math.sin(g*u),i=Math.cos(g*u),p=.5*Math.sin(g*u)+.5,q=.5*Math.cos(g*u)+.5,y.push(a*h),y.push(1),y.push(a*i),z.push(p),z.push(q),x.push(a*h),x.push(s),x.push(a*i);for(g=0;d>g;g++)l=o,m=o+1+g,A.push(m),A.push(m+1),A.push(l)}if(!r&&b>0){for(o=x.length/3,y.push(0),y.push(-1),y.push(0),z.push(.5),z.push(.5),x.push(0),x.push(0-s),x.push(0),g=0;d>=g;g++)h=Math.sin(g*u),i=Math.cos(g*u),p=.5*Math.sin(g*u)+.5,q=.5*Math.cos(g*u)+.5,y.push(b*h),y.push(-1),y.push(b*i),z.push(p),z.push(q),x.push(b*h),x.push(0-s),x.push(b*i);for(g=0;d>g;g++)l=o,m=o+1+g,A.push(l),A.push(m+1),A.push(m)}this.positions=x,this.normals=y,this.uv=z,this.indices=A},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((0>a||a>1)&&(this.warn("clamping lod to [0..1]"),a=0>a?0:1),this._lod=a,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},radiusTop:{set:function(a){a=void 0!==a?a:1,this._radiusTop!==a&&(0>a&&(this.warn("negative radiusTop not allowed - will invert"),a=-1*a),this._radiusTop=a,this._scheduleUpdate(),this.fire("radiusTop",this._radiusTop))},get:function(){return this._radiusTop}},radiusBottom:{set:function(a){a=void 0!==a?a:1,this._radiusBottom!==a&&(0>a&&(this.warn("negative radiusBottom not allowed - will invert"),a=-1*a),this._radiusBottom=a,this._scheduleUpdate(),this.fire("radiusBottom",this._radiusBottom))},get:function(){return this._radiusBottom}},height:{set:function(a){a=a||1,this._height!==a&&(0>a&&(this.warn("negative height not allowed - will invert"),a=-1*a),this._height=a,this._scheduleUpdate(),this.fire("height",this._height))},get:function(){return this._height}},radialSegments:{set:function(a){a=a||60,this._radialSegments!==a&&(0>a&&(this.warn("negative radialSegments not allowed - will invert"),a=-1*a),this._radialSegments=a,this._scheduleUpdate(),this.fire("radialSegments",this._radialSegments))},get:function(){return this._radialSegments}},heightSegments:{set:function(a){a=a||1,this._heightSegments!==a&&(0>a&&(this.warn("negative heightSegments not allowed - will invert"),a=-1*a),this._heightSegments=a,this._scheduleUpdate(),this.fire("heightSegments",this._heightSegments))},get:function(){return this._heightSegments}},openEnded:{set:function(a){a=void 0===a?!1:a,this._openEnded!==a&&(this._openEnded=a,this._scheduleUpdate(),this.fire("openEnded",this._openEnded))},get:function(){return this._openEnded}}},_getJSON:function(){return{radiusTop:this._radiusTop,radiusBottom:this._radiusBottom,height:this._height,radialSegments:this._radialSegments,heightSegments:this._heightSegments,openEnded:this._openEnded}}})}(),function(){"use strict";XEO.PlaneGeometry=XEO.Geometry.extend({type:"XEO.PlaneGeometry",_init:function(a){this._super(a),this.xSize=a.xSize,this.zSize=a.zSize,this.xSegments=a.xSegments,this.zSegments=a.zSegments,this.lod=a.lod,this.autoNormals=a.autoNormals!==!1},_update:function(){var a=this._xSize,b=this._zSize,c=Math.floor(this._lod*this._xSegments),d=Math.floor(this._lod*this._zSegments);1>d&&(d=1),1>d&&(d=1);var e,f,g,h,i,j,k,l=a/2,m=b/2,n=Math.floor(c)||1,o=Math.floor(d)||1,p=n+1,q=o+1,r=a/n,s=b/o,t=new Float32Array(p*q*3),u=new Float32Array(p*q*3),v=new Float32Array(p*q*2),w=0,x=0;for(e=0;q>e;e++){var y=e*s-m;for(f=0;p>f;f++)g=f*r-l,t[w]=g,t[w+2]=-y,u[w+2]=-1,v[x]=(n-f)/n,v[x+1]=(o-e)/o,w+=3,x+=2}w=0;var z=new(t.length/3>65535?Uint32Arraz:Uint16Array)(n*o*6);for(e=0;o>e;e++)for(f=0;n>f;f++)h=f+p*e,i=f+p*(e+1),j=f+1+p*(e+1),k=f+1+p*e,z[w]=k,z[w+1]=i,z[w+2]=h,z[w+3]=k,z[w+4]=j,z[w+5]=i,w+=6;this.positions=t,this.normals=u,this.uv=v,this.indices=z},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((0>a||a>1)&&(this.warn("clamping lod to [0..1]"),a=0>a?0:1),this._lod=a,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},xSize:{set:function(a){a=a||1,this._xSize!==a&&(0>a&&(this.warn("negative xSize not allowed - will invert"),a=-1*a),this._xSize=a,this._scheduleUpdate(),this.fire("xSize",this._xSize))},get:function(){return this._xSize}},zSize:{set:function(a){a=a||1,this._zSize!==a&&(0>a&&(this.warn("negative zSize not allowed - will invert"),a=-1*a),this._zSize=a,this._scheduleUpdate(),this.fire("zSize",this._zSize))},get:function(){return this._zSize}},xSegments:{set:function(a){a=a||1,this._xSegments!==a&&(0>a&&(this.warn("negative xSegments not allowed - will invert"),a=-1*a),this._xSegments=a,this._scheduleUpdate(),this.fire("xSegments",this._xSegments))},get:function(){return this._xSegments}},zSegments:{set:function(a){a=a||1,this._zSegments!==a&&(0>a&&(this.warn("negative zSegments not allowed - will invert"),a=-1*a),this._zSegments=a,this._scheduleUpdate(),this.fire("zSegments",this._zSegments))},get:function(){return this._zSegments}}},_getJSON:function(){return{xSize:this._xSize,zSize:this._zSize,xSegments:this._xSegments,zSegments:this._zSegments}}})}(),function(){"use strict";XEO.LatheGeometry=XEO.Geometry.extend({type:"XEO.LatheGeometry",_init:function(a){this._super(a),this.points=a.points,this.segments=a.segments,this.phiStart=a.phiStart,this.phiLength=a.phiLength,this.lod=a.lod,this.autoNormals=a.autoNormals!==!1},_update:function(){var a=[],b=[],c=Math.floor(this._lod*this._segments);4>c&&(c=4);for(var d=this._phiStart*XEO.math.DEGTORAD,e=this._phiLength*XEO.math.DEGTORAD,f=this._points,g=(1/(f.length-1),1/c),h=0,i=c;i>=h;h++)for(var j=d+h*g*e,k=Math.cos(j),l=Math.sin(j),m=0,n=f.length;n>m;m++){var o=f[m];a.push(k*o[0]-l*o[1]),a.push(l*o[0]+k*o[1]),a.push(o[2])}for(var p=f.length,h=0,i=c;i>h;h++)for(var m=0,n=f.length-1;n>m;m++){var q=m+p*h,r=q,s=q+p,k=q+1+p,t=q+1;b.push(t),b.push(s),b.push(r),b.push(t),b.push(k),b.push(s)}this.positions=a,this.indices=b},_props:{points:{set:function(a){this._points=a||[],this._scheduleUpdate(),this.fire("points",this._points)},get:function(){return this._points}},lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((0>a||a>1)&&(this.warn("clamping lod to [0..1]"),a=0>a?0:1),this._lod=a,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},phiStart:{set:function(a){a=a||0,this._phiStart!==a&&(0>a&&(this.warn("negative phiStart not allowed - will invert"),a=-1*a),this._phiStart=a,this._scheduleUpdate(),this.fire("phiStart",this._phiStart))},get:function(){return this._phiStart}},phiLength:{set:function(a){a=a||1,this._phiLength!==a&&(0>a&&(this.warn("negative phiLength not allowed - will invert"),a=-1*a),this._phiLength=a,this._scheduleUpdate(),this.fire("phiLength",this._phiLength))},get:function(){return this._phiLength}},segments:{set:function(a){a=Math.floor(a||4),this._segments!==a&&(0>a&&(this.warn("negative segments not allowed - will invert"),a=-1*a),this._segments=a,this._scheduleUpdate(),this.fire("segments",this._segments))},get:function(){return this._segments}}},_getJSON:function(){return{points:this._points,phiStart:this._phiStart,phiLength:this._phiLength,segments:this._segments}}})}(),function(){"use strict";XEO.Collection=XEO.Component.extend({type:"XEO.Collection",_init:function(a){this.components={},this.numComponents=0,this.types={},this._destroyedSubs={},a.components&&this.add(a.components)},add:function(a){a=XEO._isArray(a)?a:[a];for(var b=0,c=a.length;c>b;b++)this._add(a[b])},_add:function(a){var b,c,d,e;if(a.type)c=a;else{if(!XEO._isNumeric(a)&&!XEO._isString(a))return;if(this.scene.types[a]){if(d=a,e=this.scene.types[d],!e)return void this.warn("Component type not found: '"+d+"'");for(b in e)e.hasOwnProperty(b)&&this._add(e[b]);return}if(c=this.scene.components[a],!c)return void this.warn("Component not found: "+XEO._inQuotes(a))}if(c.scene!==this.scene)return void this.warn("Attempted to add component from different XEO.Scene: "+XEO._inQuotes(c.id));if(!this.components[c.id]){this.components[c.id]=c,e=this.types[c.type],e||(e=this.types[c.type]={}),e[c.id]=c,this.numComponents++;var f=this;this._destroyedSubs[c.id]=c.on("destroyed",function(a){f._remove(a)}),this.fire("added",c),this._dirty||this._scheduleUpdate()}},_scheduleUpdate:function(){this._dirty||(this._dirty=!0,XEO.scheduleTask(this._notifyUpdated,this))},_notifyUpdated:function(){this.fire("updated"),this._dirty=!1},clear:function(){this.iterate(function(a){this._remove(a)})},destroyAll:function(){this.iterate(function(a){a.destroy()})},remove:function(a){a=XEO._isArray(a)?a:[a];for(var b=0,c=a.length;c>b;b++)this._remove(a[b])},_remove:function(a){var b=a.id;if(a.scene!==this.scene)return void this.warn("Attempted to remove component that's not in same XEO.Scene: '"+b+"'");delete this.components[b],a.off(this._destroyedSubs[b]),delete this._destroyedSubs[b];var c=this.types[a.type];c&&delete c[a.id],this.numComponents--,this.fire("removed",a),this._dirty||this._scheduleUpdate()},iterate:function(a,b){b=b||this;var c=this.components;for(var d in c)c.hasOwnProperty(d)&&a.call(b,c[d])},_getJSON:function(){var a=[];for(var b in this.components)this.components.hasOwnProperty(b)&&a.push(this.components[b].id);return{components:a}},_destroy:function(){this.clear()}})}(),function(){"use strict";XEO.Input=XEO.Component.extend({type:"XEO.Input",serializable:!1,_init:function(a){var b=this;this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.mouseover=!1,document.addEventListener("keydown",this._keyDownListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!0:a.altKey?b.altDown=!0:(b.keyDown[a.keyCode]=!0,b.fire("keydown",a.keyCode,!0)))},!0),document.addEventListener("keyup",this._keyUpListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!1:a.altKey?b.altDown=!1:(b.keyDown[a.keyCode]=!1,b.fire("keyup",a.keyCode,!0)))}),a.element.addEventListener("mouseenter",this._mouseDownListener=function(a){if(b.enabled){b.mouseover=!0;var c=b._getClickCoordsWithinElement(a);b.fire("mouseover",c,!0)}}),a.element.addEventListener("mouseleave",this._mouseDownListener=function(a){if(b.enabled){b.mouseover=!1;var c=b._getClickCoordsWithinElement(a);b.fire("mouseout",c,!0)}}),a.element.addEventListener("mousedown",this._mouseDownListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!0;break;case 2:b.mouseDownMiddle=!0;break;case 3:b.mouseDownRight=!0}var c=b._getClickCoordsWithinElement(a);b.fire("mousedown",c,!0)}}),a.element.addEventListener("mouseup",this._mouseUpListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("mouseup",c,!0)}}),a.element.addEventListener("dblclick",this._dblClickListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1,b.mouseDownRight=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownLeft=!1,b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("dblclick",c,!0)}}),a.element.addEventListener("mousemove",this._mouseMoveListener=function(a){if(b.enabled){var c=b._getClickCoordsWithinElement(a);b.fire("mousemove",c,!0)}}),a.element.addEventListener("mousewheel",this._mouseWheelListener=function(a,c){if(b.enabled){var d=Math.max(-1,Math.min(1,a.wheelDelta||-a.detail));b.fire("mousewheel",d,!0)}}),function(){var a,c,d=2;b.on("mousedown",function(b){a=b[0],c=b[1]}),b.on("mouseup",function(e){a>=e[0]-d&&a<=e[0]+d&&c>=e[1]-d&&c<=e[1]+d&&b.fire("mouseclicked",e,!0)})}(),function(){var a,c,d={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0},e=XEO.math.vec3(),f=XEO.math.vec3(),g={orientation:null,orientationAngle:0},h={orientationAngle:0,acceleration:null,accelerationIncludingGravity:f,rotationRate:XEO.math.vec3(),interval:0},i={alpha:0,beta:0,gamma:0,absolute:!1};window.OrientationChangeEvent?window.addEventListener("orientationchange",b._orientationchangedListener=function(){a=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,c=a?d[a]||0:0,g.orientation=a,g.orientationAngle=c,b.fire("orientationchange",g)},!1):b.warn("Browser event not supported: orientationchange"),window.DeviceMotionEvent?window.addEventListener("devicemotion",b._deviceMotionListener=function(a){h.interval=a.interval,h.orientationAngle=c;var d=a.acceleration;d?(e[0]=d.x,e[1]=d.y,e[2]=d.z,h.acceleration=e):h.acceleration=null;var g=a.accelerationIncludingGravity;g?(f[0]=g.x,f[1]=g.y,f[2]=g.z,h.accelerationIncludingGravity=f):h.accelerationIncludingGravity=null,h.rotationRate=a.rotationRate,b.fire("devicemotion",h)},!1):b.warn("Browser event not supported: devicemotion"),window.DeviceOrientationEvent?window.addEventListener("deviceorientation",b._deviceOrientListener=function(a){i.gamma=a.gamma,i.beta=a.beta,i.alpha=a.alpha,i.absolute=a.absolute,b.fire("deviceorientation",i)},!1):b.warn("Browser event not supported: deviceorientation")}()},_getClickCoordsWithinElement:function(a){var b=[0,0];if(a){for(var c=a.target,d=0,e=0;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;b[0]=a.pageX-d,b[1]=a.pageY-e}else a=window.event,b.x=a.x,b.y=a.y;return b},setEnabled:function(a){this.enabled!==a&&this.fire("enabled",this.enabled=a)},KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_NUM_0:48,KEY_NUM_1:49,KEY_NUM_2:50,KEY_NUM_3:51,KEY_NUM_4:52,KEY_NUM_5:53,KEY_NUM_6:54,KEY_NUM_7:55,KEY_NUM_8:56,KEY_NUM_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW:91,KEY_RIGHT_WINDOW:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_SPACE:32,_destroy:function(){document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener)}})}(),function(){"use strict";XEO.Lights=XEO.Component.extend({type:"XEO.Lights",_init:function(a){this._state=new XEO.renderer.Lights({lights:[],hash:""}),this._dirty=!0,this._lights=[],this._dirtySubs=[],this._destroyedSubs=[],this.lights=a.lights},_props:{lights:{set:function(a){function b(){g.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=g._lights.length;c>b;b++)if(g._lights[b].id===a)return g._lights=g._lights.slice(b,b+1),g._dirtySubs=g._dirtySubs.slice(b,b+1),g._destroyedSubs=g._destroyedSubs.slice(b,b+1),g._dirty=!0,g.fire("dirty",!0),void g.fire("lights",g._lights)}a=a||[];var d,e,f;for(e=0,f=this._lights.length;f>e;e++)d=this._lights[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._lights=[],this._dirtySubs=[],this._destroyedSubs=[];var g=this;for(e=0,f=a.length;f>e;e++){if(d=a[e],XEO._isNumeric(d)||XEO._isString(d)){var h=d;if(d=this.scene.components[h],!d){this.error("Component not found: "+XEO._inQuotes(h));continue}}var i=d.type;"XEO.AmbientLight"===i||"XEO.DirLight"===i||"XEO.PointLight"===i?(this._lights.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c))):this.error("Component "+XEO._inQuotes(d.id)+" is not an XEO.AmbientLight, XEO.DirLight or XEO.PointLight ")}this._dirty=!0,this.fire("dirty",!0),this.fire("lights",this._lights)},get:function(){return this._lights}}},_compile:function(){var a=this._state;if(this._dirty){a.lights=[];for(var b=0,c=this._lights.length;c>b;b++)a.lights.push(this._lights[b]._state);this._makeHash(),this._dirty=!1}this._renderer.lights=a},_makeHash:function(){var a=this._state.lights;if(0===a.length)return";";for(var b,c=[],d=0,e=a.length;e>d;d++)b=a[d],c.push(b.type),c.push("world"===b.space?"w":"v");c.push(";"),this._state.hash=c.join("")},_getJSON:function(){for(var a=[],b=0,c=this._lights.length;c>b;b++)a.push(this._lights[b].id);return{lights:a}},_destroy:function(){var a,b,c;for(a=0,b=this._lights.length;b>a;a++)c=this._lights[a],c.off(this._dirtySubs[a]),c.off(this._destroyedSubs[a]);this._state.destroy()}})}(),function(){"use strict";XEO.AmbientLight=XEO.Component.extend({type:"XEO.AmbientLight",_init:function(a){this._state={type:"ambient",color:[.7,.7,.7],intensity:1},this.color=a.color,this.intensity=a.intensity},_props:{color:{set:function(a){this._state.color=a||[.7,.7,.8],this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){this._state.intensity=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}}},_getJSON:function(){return{color:this._state.color,intensity:this._state.intensity}}})}(),function(){"use strict";XEO.DirLight=XEO.Component.extend({type:"XEO.DirLight",_init:function(a){this._state={type:"dir",dir:[0,0,-1],color:[.7,.7,.8],intensity:1,space:"view"},this.dir=a.dir,this.color=a.color,this.intensity=a.intensity,this.space=a.space},_props:{dir:{set:function(a){a=a||[1,1,1];var b=this._state.dir;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._renderer.imageDirty=!0,this.fire("dir",b)},get:function(){return this._state.dir}},color:{set:function(a){a=a||[.7,.7,.8];var b=this._state.color;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._renderer.imageDirty=!0,this.fire("color",b)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}}},_getJSON:function(){return{type:this._state.type,dir:this._state.dir,color:this._state.color,intensity:this._state.intensity,space:this._state.space}}})}(),function(){"use strict";XEO.PointLight=XEO.Component.extend({type:"XEO.PointLight",_init:function(a){this._state={type:"point",pos:[1,1,1],color:[.7,.7,.8],intensity:1,attenuation:[0,0,0],space:"view"},this.pos=a.pos,this.color=a.color,this.intensity=a.intensity,this.constantAttenuation=a.constantAttenuation,this.linearAttenuation=a.linearAttenuation,this.quadraticAttenuation=a.quadraticAttenuation,this.space=a.space},_props:{pos:{set:function(a){this._state.pos=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},color:{set:function(a){this._state.color=a||[.7,.7,.8],this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},constantAttenuation:{set:function(a){this._state.attenuation[0]=a||0,this._renderer.imageDirty=!0,this.fire("constantAttenuation",this._state.attenuation[0])},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(a){this._state.attenuation[1]=a||0,this._renderer.imageDirty=!0,this.fire("linearAttenuation",this._state.attenuation[1])},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(a){this._state.attenuation[2]=a||0,this._renderer.imageDirty=!0,this.fire("quadraticAttenuation",this._state.attenuation[2])},get:function(){return this._state.attenuation[2]}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}}},_getJSON:function(){return{type:this._state.type,pos:this._state.pos,color:this._state.color,intensity:this._state.intensity,constantAttenuation:this._state.attenuation[0],linearAttenuation:this._state.attenuation[1],quadraticAttenuation:this._state.attenuation[2],space:this._state.space}}})}(),function(){"use strict";var a=["extensions","buffers","bufferViews","images","videos","samplers","textures","shaders","programs","techniques","materials","accessors","meshes","cameras","lights","skins","nodes","scenes","animations"];XEO.glTFParser=Object.create(Object.prototype,{_rootDescription:{value:null,writable:!0},rootDescription:{set:function(a){this._rootDescription=a},get:function(){return this._rootDescription}},baseURL:{value:null,writable:!0},_isAbsolutePath:{value:function(a){var b=new RegExp("^"+window.location.protocol,"i");return a.match(b)?!0:!1}},resolvePathIfNeeded:{value:function(a){if(this._isAbsolutePath(a))return a;var b=/^data:/;return b.test(a)?a:this.baseURL+a}},_resolvePathsForCategories:{value:function(a){a.forEach(function(a){var b=this.json[a];if(b){var c=Object.keys(b);c.forEach(function(a){var c=b[a];c.uri=this.resolvePathIfNeeded(c.uri)},this)}},this)}},_json:{value:null,writable:!0},json:{enumerable:!0,get:function(){return this._json},set:function(a){this._json!==a&&(this._json=a,this._resolvePathsForCategories(["buffers","shaders","images","videos"]))}},_path:{value:null,writable:!0},getEntryDescription:{value:function(a,b){var c=null,d=b;return c=this.rootDescription[d],c?c?c[a]:null:(console.log("ERROR:CANNOT find expected category named:"+d),null)}},_stepToNextCategory:{value:function(){return this._state.categoryIndex=this.getNextCategoryIndex(this._state.categoryIndex+1),-1!==this._state.categoryIndex?(this._state.categoryState.index=0,!0):!1}},_stepToNextDescription:{enumerable:!1,value:function(){var a=this._state.categoryState,b=a.keys;return b?(a.index++,a.keys=null,a.index>=b.length?this._stepToNextCategory():!1):(console.log("INCONSISTENCY ERROR"),!1)}},hasCategory:{value:function(a){return this.rootDescription[a]?!0:!1}},_handleState:{value:function(){for(var b={buffers:this.handleBuffer,bufferViews:this.handleBufferView,shaders:this.handleShader,programs:this.handleProgram,techniques:this.handleTechnique,materials:this.handleMaterial,meshes:this.handleMesh,cameras:this.handleCamera,lights:this.handleLight,nodes:this.handleNode,scenes:this.handleScene,images:this.handleImage,animations:this.handleAnimation,accessors:this.handleAccessor,skins:this.handleSkin,samplers:this.handleSampler,textures:this.handleTexture,videos:this.handleVideo,extensions:this.handleExtension},c=!0;-1!==this._state.categoryIndex;){var d=a[this._state.categoryIndex],e=this._state.categoryState,f=e.keys;if(f||(e.keys=f=Object.keys(this.rootDescription[d]),!f||0!==f.length)){var g=d,h=f[e.index],i=this.getEntryDescription(h,g);if(i){if(b[g]&&b[g].call(this,h,i,this._state.userInfo)===!1){c=!1;break}this._stepToNextDescription()}else if(this.handleError){this.handleError("INCONSISTENCY ERROR: no description found for entry "+h),c=!1;break}}else this._stepToNextDescription()}this.handleLoadCompleted&&this.handleLoadCompleted(c)}},_loadJSONIfNeeded:{enumerable:!0,value:function(a){var b=this;if(this._json)a&&a(this.json);else{var c=this._path,d=c.lastIndexOf("/");this.baseURL=0!==d?c.substring(0,d+1):"";var e=new XMLHttpRequest;e.open("GET",c,!0),e.onreadystatechange=function(){4===e.readyState&&200===e.status&&(b.json=JSON.parse(e.responseText),a&&a(b.json))},e.send(null)}}},_buildLoader:{value:function(a){function b(b){c.rootDescription=b,a&&a(this)}var c=this;this._loadJSONIfNeeded(b)}},_state:{value:null,writable:!0},_getEntryType:{value:function(b){for(var c=a,d=0;d<c.length;d++){var e=this.rootDescription[c[d]];if(e)return c[d]}return null}},getNextCategoryIndex:{value:function(b){for(var c=b;c<a.length;c++)if(this.hasCategory(a[c]))return c;return-1}},load:{enumerable:!0,value:function(a,b){var c=this;this._buildLoader(function(d){var e=c.getNextCategoryIndex.call(c,0);-1!==e&&(c._state={userInfo:a,options:b,categoryIndex:e,categoryState:{index:"0"}},c._handleState())})}},initWithPath:{value:function(a,b){return this._idPrefix=a,this._path=b,this._json=null,this}},_knownURLs:{writable:!0,value:{}},loaderContext:{value:function(){return"undefined"==typeof this._knownURLs[this._path]&&(this._knownURLs[this._path]=Object.keys(this._knownURLs).length),"__"+this._knownURLs[this._path]}},initWithJSON:{value:function(a,b){return this.json=a,this.baseURL=b,b||console.log("WARNING: no base URL passed to Reader:initWithJSON"),this}}})}(),XEO.GLTFLoaderUtils=Object.create(Object,{ARRAY_BUFFER:{value:"ArrayBuffer"},_streams:{value:{},writable:!0},_streamsStatus:{value:{},writable:!0},_resources:{value:{},writable:!0},_resourcesStatus:{value:{},writable:!0},init:{value:function(){this._streams={},this._streamsStatus={},this._resources={},this._resourcesStatus={}}},_containsResource:{enumerable:!1,value:function(a){return this._resources[a]?!0:!1}},_storeResource:{enumerable:!1,value:function(a,b){return a?(this._containsResource[a]&&console.log("WARNING: resource:"+a+" is already stored, overriding"),void(this._resources[a]=b)):void console.log("ERROR: entry does not contain id, cannot store")}},_getResource:{enumerable:!1,value:function(a){return this._resources[a]}},_loadStream:{value:function(a,b,c){function d(a,b){var c=decodeURIComponent(b);return a?atob(c):c}function e(a,b){for(var c=d(a,b),e=new ArrayBuffer(c.length),f=new Uint8Array(e),g=0;g<c.length;g++)f[g]=c.charCodeAt(g);return e}function f(a,b){b="undefined"!=typeof b?b:"";var c=a[1],f=!!a[2],g=a[3];switch(b){case"":case"text":return d(f,g);case"ArrayBuffer":return e(f,g);case"blob":var h=e(f,g);return new Blob([h],{type:c});case"document":var i=new DOMParser;return i.parseFromString(d(f,g),c);case"json":return JSON.parse(d(f,g));default:throw"Unhandled responseType: "+b}}var g=/^data:(.*?)(;base64)?,(.*)$/,h=g.exec(a);if(null!==h)return void c.streamAvailable(a,f(h,b));if(!b)return void c.handleError(XEO.GLTFLoaderUtils.INVALID_TYPE,null);if(!a)return void c.handleError(XEO.GLTFLoaderUtils.INVALID_PATH);var i=new XMLHttpRequest;i.open("GET",a,!0),i.responseType=b===this.ARRAY_BUFFER?"arraybuffer":"text",i.setRequestHeader("If-Modified-Since","Sat, 01 Jan 1970 00:00:00 GMT"),i.onload=function(){200===i.status||206===i.status?c.streamAvailable(a,i.response):c.handleError(XEO.GLTFLoaderUtils.XMLHTTPREQUEST_STATUS_ERROR,this.status)},i.send(null)}},send:{value:0,writable:!0},requested:{value:0,writable:!0},_handleRequest:{value:function(a){var b=this._resourcesStatus[a.id];b?this._resourcesStatus[a.id]++:this._resourcesStatus[a.id]=1;var c=this._streamsStatus[a.uri];if(c&&"loading"===c.status)return void c.requests.push(a);this._streamsStatus[a.uri]={status:"loading",requests:[a]};var d=this,e={};e.streamAvailable=function(a,b){var c=d._streamsStatus[a],e=c.requests;e.forEach(function(a){var c=b.slice(a.range[0],a.range[1]),e=a.delegate.convert(c,a.ctx);d._storeResource(a.id,e),a.delegate.resourceAvailable(e,a.ctx),--d._resourcesStatus[a.id]},this),delete d._streamsStatus[a]},e.handleError=function(b,c){a.delegate.handleError(b,c)},this._loadStream(a.uri,a.type,e)}},_elementSizeForGLType:{value:function(a,b){var c=0;switch(b){case"SCALAR":c=1;break;case"VEC2":c=2;break;case"VEC3":c=3;break;case"VEC4":c=4;break;case"MAT2":c=4;break;case"MAT3":c=9;break;case"MAT4":c=16}switch(a){case WebGLRenderingContext.FLOAT:return Float32Array.BYTES_PER_ELEMENT*c;case WebGLRenderingContext.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT*c;case WebGLRenderingContext.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT*c;default:return null}}},_handleWrappedBufferViewResourceLoading:{value:function(a,b,c){var d=a.bufferView,e=d.buffer,f=a.byteOffset+d.description.byteOffset,g=[f,this._elementSizeForGLType(a.componentType,a.type)*a.count+f];this._handleRequest({id:a.id,range:g,type:e.description.type,uri:e.description.uri,delegate:b,ctx:c},null)}},getBuffer:{value:function(a,b,c){var d=this._getResource(a.id);return d?d:(this._handleWrappedBufferViewResourceLoading(a,b,c),null)}},getFile:{value:function(a,b,c){return a.delegate=b,a.ctx=c,this._handleRequest({id:a.id,uri:a.uri,range:[0],type:"text",delegate:b,ctx:c},null),null}}}),function(){"use strict";function a(a,b,c){console.log(a+": "+b+": "+JSON.stringify(c,null,4))}function b(a){var b=0;switch(a){case"SCALAR":b=1;break;case"VEC2":b=2;break;case"VEC3":b=3;break;case"VEC4":b=4;break;case"MAT2":b=4;break;case"MAT3":b=9;break;case"MAT4":b=16}return b}var c=function(a,b,c){this.entryID=a,this.object=b,this.description=c},d=function(){this._entries={}};d.prototype.setEntry=function(a,b,d){return a?(this._entries[a]&&console.warn("entry["+a+"] is being overwritten"),void(this._entries[a]=new c(a,b,d))):void console.error("No EntryID provided, cannot store",d)},d.prototype.getEntry=function(a){return this._entries[a]},d.prototype.clearEntries=function(){this._entries={}};var e=function(){};e.prototype.handleError=function(a,b){console.log("ERROR(IndicesDelegate):"+a+":"+b)},e.prototype.convert=function(a,b){return new Uint16Array(a,0,b.indices.count)},e.prototype.resourceAvailable=function(a,b){var c=b.geometry;return c.indices=a,!0};var f=new e,g=function(a,b){this.indices=a,this.geometry=b},h=function(){};h.prototype.handleError=function(a,b){console.log("ERROR(VertexAttributeDelegate):"+a+":"+b)},h.prototype.convert=function(a,b){return a},h.prototype.resourceAvailable=function(a,c){var d=c.geometry,e=c.attribute,f=c.semantic;return"POSITION"===f?d.positions=new Float32Array(a,0,e.count*b(e.type)):"NORMAL"===f?d.normals=new Float32Array(a,0,e.count*b(e.type)):("TEXCOORD_0"===f||"TEXCOORD"===f)&&(d.uv=new Float32Array(a,0,e.count*b(e.type))),d.loadedAttributes++,!0};var i=new h,j=function(a,b,c){this.attribute=a,this.semantic=b,this.geometry=c};XEO.GLTFLoader=Object.create(XEO.glTFParser,{setCollection:{value:function(a){this.collection=a;
}},load:{enumerable:!0,value:function(a,b,c){if(!this.collection)throw"collection not set";this.resources=new d,XEO.glTFParser.handleLoadCompleted=c,XEO.glTFParser.load.call(this,a,b)}},_makeID:{value:function(a){return this._idPrefix+"#"+a}},handleBuffer:{value:function(a,b,c){return this.resources.setEntry(a,null,b),b.type="ArrayBuffer",!0}},handleBufferView:{value:function(a,b,c){this.resources.setEntry(a,null,b);var d=this.resources.getEntry(b.buffer);b.type="ArrayBufferView";var e=this.resources.getEntry(a);return e.buffer=d,!0}},handleAccessor:{value:function(a,b,c){return this.resources.setEntry(a,b,b),!0}},handleTexture:{value:function(a,b,c){if(b.source){var d=this._json.images[b.source],e=new XEO.Texture(this.collection.scene,{id:this._makeID(a),src:d.uri,flipY:!0});return this.collection.add(e),this.resources.setEntry(a,e,b),!0}}},handleMaterial:{value:function(a,b,c){var d,e=b.values||{},f=e.diffuse,g=e.specular,h=e.shininess,i=e.emission,j={id:this._makeID(a),meta:{userInfo:c},shininess:h};f&&(XEO._isString(f)?(d=this.resources.getEntry(f),d&&(j.diffuseMap=d.object)):j.diffuse=f.slice(0,3)),g&&(XEO._isString(g)?(d=this.resources.getEntry(g),d&&(j.specularMap=d.object)):j.specular=g.slice(0,3)),i&&(XEO._isString(i)?(d=this.resources.getEntry(i),d&&(j.emissiveMap=d.object)):j.emissive=i.slice(0,3));var k=new XEO.PhongMaterial(this.collection.scene,j);return this.collection.add(k),this.resources.setEntry(a,k,b),!0}},handleLight:{value:function(b,c,d){return a("light",b,c),!0}},handleMesh:{value:function(b,c,d){var e=[];this.resources.setEntry(b,e,c);var h=c.primitives;if(!h)return a("MISSING_PRIMITIVES for mesh:"+b),!1;for(var k=0;k<h.length;k++){var l=h[k];if(l.mode===WebGLRenderingContext.TRIANGLES){var m=new XEO.Geometry(this.collection.scene,{id:this._makeID(b)});this.collection.add(m);var n=this.resources.getEntry(l.material),o=n.object;e.push({geometry:m,material:o});var p=Object.keys(l.attributes);m.totalAttributes+=p.length;var q=this.resources.getEntry(l.indices),r=this.resources.getEntry(q.description.bufferView),s={bufferView:r,byteOffset:q.description.byteOffset,count:q.description.count,id:q.entryID,componentType:q.description.componentType,type:q.description.type},t=new g(s,m);XEO.GLTFLoaderUtils.getBuffer(s,f,t);p.forEach(function(a){var b,d,e=l.attributes[a],f=this.resources.getEntry(e);f?(b=f.object,b.id=e,d=this.resources.getEntry(b.bufferView)):(b=c.attributes[e],b.id=e,this.resources.setEntry(e,b,b),d=this.resources.getEntry(b.bufferView),f=this.resources.getEntry(e));var g={bufferView:d,byteOffset:b.byteOffset,byteStride:b.byteStride,count:b.count,max:b.max,min:b.min,componentType:b.componentType,type:b.type,id:e},h=new j(g,a,m);XEO.GLTFLoaderUtils.getBuffer(g,i,h)},this)}}return!0}},handleCamera:{value:function(a,b,c){return!0}},handleScene:{value:function(a,b,c){var d=b.nodes;if(d){var e,f;for(var g in d)d.hasOwnProperty(g)&&(e=d[g],f=null,this._parseNode(e,f))}}},_parseNode:{value:function(a,b){var c=this._json.nodes[a];if(c){var d,e;if(c.matrix){var f=c.matrix;b=new XEO.Transform(this.collection.scene,{id:this._makeID(a+".transform"),matrix:f,parent:b}),this.collection.add(b)}if(c.translation){var g=c.translation;b=new XEO.Translate(this.collection.scene,{id:this._makeID(a+".translation"),xyz:[g[0],g[1],g[2]],parent:b}),this.collection.add(b)}if(c.rotation){var h=c.rotation;b=new XEO.Rotate(this.collection.scene,{id:this._makeID(a+".rotation"),xyz:[h[0],h[1],h[2]],angle:h[3],parent:b}),this.collection.add(b)}if(c.scale){var i=c.scale;b=new XEO.Scale(this.collection.scene,{id:this._makeID(a+".scale"),xyz:[i[0],i[1],i[2]],parent:b}),this.collection.add(b)}if(c.meshes){var j=new XEO.Visibility(this.collection.scene,{id:this._makeID(a+".visibility")});this.collection.add(j);var k=new XEO.Cull(this.collection.scene,{id:this._makeID(a+".cull")});this.collection.add(k);var l=new XEO.Modes(this.collection.scene,{id:this._makeID(a+".modes")});this.collection.add(k);var m,n,o,p,q,r=c.meshes,s=r.length,t=this.collection,u=this.collection.scene;for(m=0;s>m;m++)if(n=this.resources.getEntry(r[m]))for(n=n.object,d=0,e=n.length;e>d;d++)o=n[d].material,p=n[d].geometry,q=new XEO.Entity(u,{id:this._makeID(a+".entity."+d),meta:{name:c.name},material:o,geometry:p,transform:b,visibility:j,cull:k,modes:l,loading:!0}),t.add(q)}if(c.children){var v,w=c.children;for(d=0,e=w.length;e>d;d++)v=w[d],this._parseNode(v,b)}return!0}}}})}(),function(){"use strict";var a=XEO.GLTFLoader;XEO.Model=XEO.Component.extend({type:"XEO.Model",_init:function(a){return this._super(a),this._collection=this.create(XEO.Collection),this._dummyRootTransform=this.create(XEO.Translate,{meta:"dummy"}),this._src=null,a.src?XEO._isString(a.src)?(this.src=a.src,void(this.transform=a.transform)):void this.error("Value for config 'src' should be a string"):void this.error("Config missing: 'src'")},_props:{src:{set:function(b){if(b){if(!XEO._isString(b))return void this.error("Value for 'src' should be a string");this._clear(),this._src=b,a.setCollection(this._collection),a.initWithPath(this.id,this._src);var c,d=this,e=null,f=null,g=d._dummyRootTransform,h=d.scene.canvas.spinner;h.processes++,a.load(e,f,function(){d._collection.iterate(function(a){if(a.isType("XEO.Entity"))if(c=a.transform){for(;c.parent;){if(c.id===g.id)return;c=c.parent}if(c.id===g.id)return;c.parent=g}else a.transform=g}),h.processes--,d.fire("loaded")}),this.fire("src",this._src)}},get:function(){return this._src}},collection:{get:function(){return this._collection}},transform:{set:function(a){this._attach({name:"transform",type:"XEO.Transform",component:a,sceneDefault:!1,onAttached:{callback:this._transformUpdated,scope:this}})},get:function(){return this._attached.transform}}},_transformUpdated:function(a){this._dummyRootTransform.parent=a},_clear:function(){var a=[];for(this._collection.iterate(function(b){a.push(b)});a.length;)a.pop().destroy()},_getJSON:function(){var a={src:this._src};return this._attached.transform&&(a.transform=this._attached.transform.id),a},_destroy:function(){this._clear()}})}(),function(){"use strict";XEO.Material=XEO.Component.extend({type:"XEO.Material",_init:function(){}})}(),function(){"use strict";XEO.PhongMaterial=XEO.Material.extend({type:"XEO.PhongMaterial",_init:function(a){this._state=new XEO.renderer.PhongMaterial({type:"phongMaterial",ambient:[.7,.7,.8],diffuse:[1,1,1],specular:[1,1,1],emissive:[0,0,0],opacity:1,shininess:30,reflectivity:1,lineWidth:1,pointSize:1,ambientMap:null,normalMap:null,diffuseMap:null,specularMap:null,emissiveMap:null,opacityMap:null,reflectivityMap:null,diffuseFresnel:null,specularFresnel:null,emissiveFresnel:null,opacityFresnel:null,reflectivityFresnel:null,hash:null}),this._hashDirty=!0,this.on("dirty",function(){this._hashDirty=!0},this),this.ambient=a.ambient,this.diffuse=a.diffuse,this.specular=a.specular,this.emissive=a.emissive,this.opacity=a.opacity,this.shininess=a.shininess,this.reflectivity=a.reflectivity,this.lineWidth=a.lineWidth,this.pointSize=a.pointSize,this.ambientMap=a.ambientMap,this.diffuseMap=a.diffuseMap,this.specularMap=a.specularMap,this.emissiveMap=a.emissiveMap,this.opacityMap=a.opacityMap,this.reflectivityMap=a.reflectivityMap,this.normalMap=a.normalMap,this.diffuseFresnel=a.diffuseFresnel,this.specularFresnel=a.specularFresnel,this.emissiveFresnel=a.emissiveFresnel,this.opacityFresnel=a.opacityFresnel,this.reflectivityFresnel=a.reflectivityFresnel},_props:{ambient:{set:function(a){this._state.ambient=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("ambient",this._state.ambient)},get:function(){return this._state.ambient}},diffuse:{set:function(a){this._state.diffuse=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("diffuse",this._state.diffuse)},get:function(){return this._state.diffuse}},specular:{set:function(a){this._state.specular=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("specular",this._state.specular)},get:function(){return this._state.specular}},emissive:{set:function(a){this._state.emissive=a||[0,0,0],this._renderer.imageDirty=!0,this.fire("emissive",this._state.emissive)},get:function(){return this._state.emissive}},opacity:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.opacity!==a&&(this._state.opacity=a,this._renderer.imageDirty=!0,this.fire("opacity",this._state.opacity))},get:function(){return this._state.opacity}},shininess:{set:function(a){this._state.shininess=void 0!==a?a:80,this._renderer.imageDirty=!0,this.fire("shininess",this._state.shininess)},get:function(){return this._state.shininess}},lineWidth:{set:function(a){this._state.lineWidth=a||1,this._renderer.imageDirty=!0,this.fire("lineWidth",this._state.lineWidth)},get:function(){return this._state.lineWidth}},pointSize:{set:function(a){this._state.pointSize=a||1,this._renderer.imageDirty=!0,this.fire("pointSize",this._state.pointSize)},get:function(){return this._state.pointSize}},reflectivity:{set:function(a){this._state.reflectivity=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("reflectivity",this._state.reflectivity)},get:function(){return this._state.reflectivity}},normalMap:{set:function(a){this._attachComponent("XEO.Texture","normalMap",a)},get:function(){return this._attached.normalMap}},ambientMap:{set:function(a){this._attachComponent("XEO.Texture","ambientMap",a)},get:function(){return this._attached.ambientMap}},diffuseMap:{set:function(a){this._attachComponent("XEO.Texture","diffuseMap",a)},get:function(){return this._attached.diffuseMap}},specularMap:{set:function(a){this._attachComponent("XEO.Texture","specularMap",a)},get:function(){return this._attached.specularMap}},emissiveMap:{set:function(a){this._attachComponent("XEO.Texture","emissiveMap",a)},get:function(){return this._attached.emissiveMap}},opacityMap:{set:function(a){this._attachComponent("XEO.Texture","opacityMap",a)},get:function(){return this._attached.opacityMap}},reflectivityMap:{set:function(a){this._attachComponent("XEO.Texture","reflectivityMap",a)},get:function(){return this._attached.reflectivityMap}},reflection:{set:function(a){this._attachComponent("XEO.Reflect","reflection",a)},get:function(){return this._attached.reflection}},diffuseFresnel:{set:function(a){this._attachComponent("XEO.Fresnel","diffuseFresnel",a)},get:function(){return this._attached.diffuseFresnel}},specularFresnel:{set:function(a){this._attachComponent("XEO.Fresnel","specularFresnel",a)},get:function(){return this._attached.specularFresnel}},emissiveFresnel:{set:function(a){this._attachComponent("XEO.Fresnel","emissiveFresnel",a)},get:function(){return this._attached.emissiveFresnel}},opacityFresnel:{set:function(a){this._attachComponent("XEO.Fresnel","opacityFresnel",a)},get:function(){return this._attached.opacityFresnel}},reflectivityFresnel:{set:function(a){this._attachComponent("XEO.Fresnel","reflectivityFresnel",a)},get:function(){return this._attached.reflectivityFresnel}}},_attachComponent:function(a,b,c){c=this._attach({name:b,type:a,component:c,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[b]=null,this._hashDirty=!0},scope:this}}}),this._state[b]=c?c._state:null,this._hashDirty=!0},_compile:function(){this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._renderer.material=this._state},_makeHash:function(){var a=this._state,b=["/p"];a.normalMap&&(b.push("/b"),a.normalMap.matrix&&b.push("/mat")),a.ambientMap&&(b.push("/a"),a.ambientMap.matrix&&b.push("/mat")),a.diffuseMap&&(b.push("/d"),a.diffuseMap.matrix&&b.push("/mat")),a.specularMap&&(b.push("/s"),a.specularMap.matrix&&b.push("/mat")),a.emissiveMap&&(b.push("/e"),a.emissiveMap.matrix&&b.push("/mat")),a.opacityMap&&(b.push("/o"),a.opacityMap.matrix&&b.push("/mat")),a.reflectivityMap&&(b.push("/r"),a.reflectivityMap.matrix&&b.push("/mat")),a.diffuseFresnel&&b.push("/df"),a.specularFresnel&&b.push("/sf"),a.emissiveFresnel&&b.push("/ef"),a.opacityFresnel&&b.push("/of"),a.reflectivityFresnel&&b.push("/rf"),b.push(";"),a.hash=b.join("")},_getJSON:function(){var a={ambient:this._state.ambient,diffuse:this._state.diffuse,specular:this._state.specular,emissive:this._state.emissive};1!==this._state.opacity&&(a.opacity=this._state.opacity),80!==this._state.shininess&&(a.shininess=this._state.shininess),1!==this._state.reflectivity&&(a.reflectivity=this._state.reflectivity),1!==this._state.lineWidth&&(a.lineWidth=this._state.lineWidth),1!==this._state.pointSize&&(a.pointSize=this._state.pointSize);var b=this._attached;return b.normalMap&&(a.normalMap=b.normalMap.id),b.ambientMap&&(a.ambientMap=b.ambientMap.id),b.diffuseMap&&(a.diffuseMap=b.diffuseMap.id),b.specularMap&&(a.specularMap=b.specularMap.id),b.emissiveMap&&(a.emissiveMap=b.emissiveMap.id),b.opacityMap&&(a.opacityMap=b.opacityMap.id),b.reflectivityMap&&(a.reflectivityMap=b.reflectivityMap.id),b.diffuseFresnel&&(a.diffuseFresnel=b.diffuseFresnel.id),b.specularFresnel&&(a.specularFresnel=b.specularFresnel.id),b.emissiveFresnel&&(a.emissiveFresnel=b.emissiveFresnel.id),b.opacityFresnel&&(a.opacityFresnel=b.opacityFresnel.id),b.reflectivityFresnel&&(a.reflectivityFresnel=b.reflectivityFresnel.id),a},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Texture=XEO.Component.extend({type:"XEO.Texture",_init:function(a){this._state=new XEO.renderer.Texture({texture:null,matrix:null,minFilter:null,magFilter:null,wrapS:null,wrapT:null,flipY:null}),this._src=null,this._image=null,this._target=null,this._translate=[0,0],this._scale=[1,1],this._rotate=[0,0],this._matrixDirty=!1,this._srcDirty=!1,this._imageDirty=!1,this._targetDirty=!1,this._propsDirty=!1,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._webglContextRestored,this),this.translate=a.translate,this.scale=a.scale,this.rotate=a.rotate,this.minFilter=a.minFilter,this.magFilter=a.magFilter,this.wrapS=a.wrapS,this.wrapT=a.wrapT,this.flipY=a.flipY,a.src?this.src=a.src:a.image?this.image=a.image:a.target&&(this.target=a.target),XEO.stats.memory.textures++},_webglContextRestored:function(){this._state.texture=null,this._matrixDirty=!0,this._propsDirty=!0,this._image?this._imageDirty=!0:this._src?this._srcDirty=!0:this._target&&(this._targetDirty=!0),this._scheduleUpdate()},_update:function(){var a=this.scene.canvas.gl,b=this._state;if(this._srcDirty&&this._src)return this._loadSrc(this._src),void(this._srcDirty=!1);if(this._imageDirty&&this._image&&(this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),b.texture&&b.texture.renderBuffer&&(b.texture=null),b.texture||(b.texture=new XEO.renderer.webgl.Texture2D(a)),b.texture.setImage(this._image,b),this._imageDirty=!1,this._propsDirty=!0),this._targetDirty&&(b.texture&&!b.texture.renderBuffer&&(b.texture.destroy(),b.texture=null),this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),this._target&&(this._onTargetActive=this._target.on("active",function(a){b.texture=a?this._state.renderBuf.getTexture():null})),this._targetDirty=!1,this._propsDirty=!0),this._matrixDirty){var c,d;(0!==this._translate[0]||0!==this._translate[2])&&(c=XEO.math.translationMat4v([this._translate[0],this._translate[1],0])),(1!==this._scale[0]||1!==this._scale[1])&&(d=XEO.math.scalingMat4v([this._scale[0],this._scale[1],1]),c=c?XEO.math.mulMat4(c,d):d),0!==this._rotate&&(d=XEO.math.rotationMat4v(.0174532925*this._rotate,[0,0,1]),c=c?XEO.math.mulMat4(c,d):d);var e=b.matrix;b.matrix=c,this._matrixDirty=!1,!!c!=!!e&&this.fire("dirty")}this._propsDirty&&(b.texture&&b.texture.setProps&&b.texture.setProps(b),this._propsDirty=!1),this._renderer.imageDirty=!0},_loadSrc:function(a){var b=this,c=new Image,d=this.scene.canvas.spinner,e=d.textures;c.onload=function(){b._src===a&&(b._image=XEO.renderer.webgl.ensureImageSizePowerOfTwo(c),b._imageDirty=!0,b._srcDirty=!1,b._targetDirty=!1,e&&d.processes--,b._scheduleUpdate(),b.fire("image",b._image),b.fire("loaded",b._src))},c.onerror=function(){e&&d.processes--},0===a.indexOf("data")?c.src=a:(c.crossOrigin="Anonymous",c.src=a,e&&d.processes++)},_props:{image:{set:function(a){this._image=XEO.renderer.webgl.ensureImageSizePowerOfTwo(a),this._src=null,this._imageDirty=!0,this._srcDirty=!1,this._targetDirty=!1,this._scheduleUpdate(),this.fire("image",this._image)},get:function(){return this._state.image}},src:{set:function(a){this._image=null,this._src=a,this._imageDirty=!1,this._srcDirty=!0,this._targetDirty=!1,this._scheduleUpdate(),this.fire("src",this._src)},get:function(){return this._src}},target:{set:function(a){this._image=null,this._src=null,this._target=this._attach({name:"renderBuf",type:null,component:a,sceneDefault:!0,on:{active:{callback:this._onTargetActive,scope:this}}}),this._imageDirty=!1,this._srcDirty=!1,this._targetDirty=!0,this._scheduleUpdate(),this.fire("target",this._target)},get:function(){return this._attached.target}},translate:{set:function(a){a=a||[0,0],this._translate=a,this._matrixDirty=!0,this._scheduleUpdate(),this.fire("translate",this._translate)},get:function(){return this._translate}},scale:{set:function(a){a=a||[1,1],this._scale=a,this._matrixDirty=!0,this._scheduleUpdate(),this.fire("scale",this._scale)},get:function(){return this._scale}},rotate:{set:function(a){a=a||0,this._rotate!==a&&(this._rotate=a,this._matrixDirty=!0,this._scheduleUpdate(),this.fire("rotate",this._rotate))},get:function(){return this._rotate}},minFilter:{set:function(a){a=a||"linearMipmapLinear","linear"!==a&&"linearMipmapNearest"!==a&&"linearMipmapLinear"!==a&&"nearestMipmapLinear"!==a&&"linearMipmapLinear"!==a&&(this.error("Unsupported value for 'minFilter': '"+a+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),a="linearMipmapLinear"),this._state.minFilter=a,this._propsDirty=!0,this._scheduleUpdate(),this.fire("minFilter",this._state.minFilter)},get:function(){return this._state.minFilter}},magFilter:{set:function(a){a=a||"linear","linear"!==a&&"nearest"!==a&&(this.error("Unsupported value for 'magFilter': '"+a+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),a="linear"),this._state.magFilter=a,this._propsDirty=!0,this._scheduleUpdate(),this.fire("magFilter",this._state.magFilter)},get:function(){return this._state.magFilter}},wrapS:{set:function(a){a=a||"repeat","clampToEdge"!==a&&"mirroredRepeat"!==a&&"repeat"!==a&&(this.error("Unsupported value for 'wrapS': '"+a+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),a="repeat"),this._state.wrapS=a,this._propsDirty=!0,this._scheduleUpdate(),this.fire("wrapS",this._state.wrapS)},get:function(){return this._state.wrapS}},wrapT:{set:function(a){a=a||"repeat","clampToEdge"!==a&&"mirroredRepeat"!==a&&"repeat"!==a&&(this.error("Unsupported value for 'wrapT': '"+a+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),a="repeat"),this._state.wrapT=a,this._propsDirty=!0,this._scheduleUpdate(),this.fire("wrapT",this._state.wrapT)},get:function(){return this._state.wrapT}},flipY:{set:function(a){a=!!a,this._state.flipY!==a&&(this._state.flipY=a,this._imageDirty=!0,this._scheduleUpdate(),this.fire("flipY",this._state.flipY))},get:function(){return this._state.flipY}}},_getJSON:function(){var a={};return!this._translate||0===this._translate[0]&&0===this._translate[1]||(a.translate=this._translate),!this._scale||1===this._scale[0]&&1===this._scale[1]||(a.scale=this._scale),0!==this._rotate&&(a.rotate=this._rotate),"linearMipmapLinear"!==this._state.minFilter&&(a.minFilter=this._state.minFilter),"linear"!==this._state.magFilter&&(a.magFilter=this._state.magFilter),"repeat"!==this._state.wrapS&&(a.wrapS=this._state.wrapS),"repeat"!==this._state.wrapT&&(a.wrapT=this._state.wrapT),this._state.flipY!==!1&&(a.flipY=this._state.flipY),this._src?a.src=this._src:this._target?a.target=this._target.id:this._image,a},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),XEO.stats.memory.textures--}})}(),function(){"use strict";XEO.Fresnel=XEO.Component.extend({type:"XEO.Fresnel",_init:function(a){this._state=new XEO.renderer.Fresnel({edgeColor:[0,0,0],centerColor:[1,1,1],edgeBias:0,centerBias:1,power:1}),this.edgeColor=a.edgeColor,this.centerColor=a.centerColor,this.edgeBias=a.edgeBias,this.centerBias=a.centerBias,this.power=a.power},_props:{edgeColor:{set:function(a){this._state.edgeColor=a||[0,0,0],this._renderer.imageDirty=!0,this.fire("edgeColor",this._state.edgeColor)},get:function(){return this._state.edgeColor}},centerColor:{set:function(a){this._state.centerColor=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("centerColor",this._state.centerColor)},get:function(){return this._state.centerColor}},edgeBias:{set:function(a){this._state.edgeBias=a||0,this._renderer.imageDirty=!0,this.fire("edgeBias",this._state.edgeBias)},get:function(){return this._state.edgeBias}},centerBias:{set:function(a){this._state.centerBias=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this.fire("centerBias",this._state.centerBias)},get:function(){return this._state.centerBias}},power:{set:function(a){this._state.power=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this.fire("power",this._state.power)},get:function(){return this._state.power}}},_getJSON:function(){return{edgeColor:this._state.edgeColor,centerColor:this._state.centerColor,edgeBias:this._state.edgeBias,centerBias:this._state.centerBias,power:this._state.power}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Reflect=XEO.Component.extend({type:"XEO.Reflect",_init:function(a){this._state=new XEO.renderer.Reflect({texture:null}),this._src=[],this._images=[],this._srcDirty=!1,this._imageDirty=!1,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._webglContextRestored,this),this.src=a.src,XEO.stats.memory.textures++},_webglContextRestored:function(){this._state.reflect=null,this._images?this._imageDirty=!0:this._src&&(this._srcDirty=!0),this._scheduleUpdate()},_update:function(){var a=this._state;return this._srcDirty&&this._src?(this._loadSrc(this._src),void(this._srcDirty=!1)):(this._imageDirty&&this._images&&(a.reflect.setImage(this._image),this._imageDirty=!1,this._propsDirty=!0),void(this._renderer.imageDirty=!0))},_loadSrc:function(a){var b=this,c=new Image;c.onload=function(){b._src===a&&(b._image=XEO.renderer.webgl.ensureImageSizePowerOfTwo(c),b._imageDirty=!0,b._srcDirty=!1,b._targetDirty=!1,b._scheduleUpdate(),b.fire("image",b._image),b.fire("loaded",b._src))},c.onerror=function(){},0===a.indexOf("data")?c.src=a:(c.crossOrigin="Anonymous",c.src=a)},_props:{src:{set:function(a){this._image=null,this._src=a,this._imageDirty=!1,this._srcDirty=!0,this._targetDirty=!1,this._scheduleUpdate(),this.fire("src",this._src)},get:function(){return this._src}}},_getJSON:function(){return{src:this._src.slice(0)}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),XEO.stats.memory.textures--}})}(),function(){"use strict";XEO.Entity=XEO.Component.extend({type:"XEO.Entity",_init:function(a){this._loading=a.loading,this._loading===!0&&this.scene.canvas.spinner.processes++,this.camera=a.camera,this.clips=a.clips,this.colorTarget=a.colorTarget,this.colorBuf=a.colorBuf,this.depthTarget=a.depthTarget,this.depthBuf=a.depthBuf,this.visibility=a.visibility,this.cull=a.cull,this.modes=a.modes,this.geometry=a.geometry,this.layer=a.layer,this.lights=a.lights,this.material=a.material,this.morphTargets=a.morphTargets,this.reflect=a.reflect,this.shader=a.shader,this.shaderParams=a.shaderParams,this.stage=a.stage,this.transform=a.transform,this.billboard=a.billboard,this.stationary=a.stationary,this.viewport=a.viewport,this._worldBoundary=null,this._viewBoundary=null,this._canvasBoundary=null,this._worldBoundaryDirty=!0,this._viewBoundaryDirty=!0,this._canvasBoundaryDirty=!0},_props:{camera:{set:function(a){this._setViewBoundaryDirty(),this._attach({name:"camera",type:"XEO.Camera",component:a,sceneDefault:!0,on:{viewMatrix:{callback:this._setViewBoundaryDirty,scope:this},projMatrix:{callback:this._setCanvasBoundaryDirty,scope:this}}})},get:function(){return this._attached.camera}},clips:{set:function(a){this._attach({name:"clips",type:"XEO.Clips",component:a,sceneDefault:!0})},get:function(){return this._attached.clips}},colorTarget:{set:function(a){this._attach({name:"colorTarget",type:"XEO.ColorTarget",component:a,sceneDefault:!0})},get:function(){return this._attached.colorTarget}},colorBuf:{set:function(a){this._attach({name:"colorBuf",type:"XEO.ColorBuf",component:a,sceneDefault:!0})},get:function(){return this._attached.colorBuf}},depthTarget:{set:function(a){this._attach({name:"depthTarget",type:"XEO.DepthTarget",component:a,sceneDefault:!0})},get:function(){return this._attached.depthTarget}},depthBuf:{set:function(a){this._attach({name:"depthBuf",type:"XEO.DepthBuf",component:a,sceneDefault:!0})},get:function(){return this._attached.depthBuf}},visibility:{set:function(a){this._attach({name:"visibility",type:"XEO.Visibility",component:a,sceneDefault:!0})},get:function(){return this._attached.visibility}},cull:{set:function(a){this._attach({name:"cull",type:"XEO.Cull",component:a,sceneDefault:!0})},get:function(){return this._attached.cull}},modes:{set:function(a){this._attach({name:"modes",type:"XEO.Modes",component:a,sceneDefault:!0})},get:function(){return this._attached.modes}},geometry:{set:function(a){this._setWorldBoundaryDirty(),this._attach({name:"geometry",type:"XEO.Geometry",component:a,sceneDefault:!0,on:{positions:{callback:this._setWorldBoundaryDirty,scope:this},destroyed:{callback:this._setWorldBoundaryDirty,scope:this}}})},get:function(){return this._attached.geometry}},layer:{set:function(a){this._attach({name:"layer",type:"XEO.Layer",component:a,sceneDefault:!0})},get:function(){return this._attached.layer}},lights:{set:function(a){this._attach({name:"lights",type:"XEO.Lights",component:a,sceneDefault:!0})},get:function(){return this._attached.lights}},material:{set:function(a){this._attach({name:"material",type:"XEO.Material",component:a,sceneDefault:!0})},get:function(){return this._attached.material}},morphTargets:{set:function(a){this._attach({name:"morphTargets",type:"XEO.MorphTargets",component:a,sceneDefault:!0})},get:function(){return this._attached.morphTargets}},reflect:{set:function(a){this._attach({name:"reflect",type:"XEO.Reflect",component:a,sceneDefault:!0})},get:function(){return this._attached.reflect}},shader:{set:function(a){this._attach({name:"shader",type:"XEO.Shader",component:a,sceneDefault:!0})},get:function(){return this._attached.shader}},shaderParams:{set:function(a){this._attach({name:"shaderParams",type:"XEO.ShaderParams",component:a,sceneDefault:!0})},get:function(){return this._attached.shaderParams}},stage:{set:function(a){this._attach({name:"stage",type:"XEO.Stage",component:a,sceneDefault:!0})},get:function(){return this._attached.stage}},transform:{set:function(a){this._setWorldBoundaryDirty(),this._attach({name:"transform",type:"XEO.Transform",component:a,sceneDefault:!0,on:{updated:{callback:function(){this._transformDirty||(this._transformDirty=!0,XEO.scheduleTask(function(){this._transformDirty&&(this._attached.transform._buildLeafMatrix(),this._setWorldBoundaryDirty(),this._transformDirty=!1)},this))},scope:this},destroyed:{callback:this._setWorldBoundaryDirty,scope:this}}})},get:function(){return this._attached.transform}},billboard:{set:function(a){this._attach({name:"billboard",type:"XEO.Billboard",component:a,sceneDefault:!0})},get:function(){return this._attached.billboard}},viewport:{set:function(a){this._attach({name:"viewport",type:"XEO.Viewport",component:a,sceneDefault:!0})},get:function(){return this._attached.viewport}},stationary:{set:function(a){this._attach({name:"stationary",type:"XEO.Stationary",component:a,sceneDefault:!0})},get:function(){return this._attached.stationary}},localBoundary:{get:function(){return this._attached.geometry.localBoundary}},worldBoundary:{get:function(){if(!this._worldBoundary){var a=this;this._worldBoundary=new XEO.Boundary3D(this.scene,{meta:{desc:"Entity "+a.id+" World-space boundary"},getDirty:function(){return a._worldBoundaryDirty?(a._worldBoundaryDirty=!1,!0):!1},getOBB:function(){var b=a._attached.geometry;if(b){var c=b.localBoundary;return c.obb}},getMatrix:function(){var b=a._attached.transform;return a._transformDirty&&(b._buildLeafMatrix(),a._setWorldBoundaryDirty(),a._transformDirty=!1),b.leafMatrix}}),this._worldBoundary.on("destroyed",function(){a._worldBoundary=null})}return this._worldBoundary}},viewBoundary:{get:function(){if(!this._viewBoundary){var a=this;this._viewBoundary=new XEO.Boundary3D(this.scene,{meta:{desc:"Entity "+a.id+" View-space boundary"},getDirty:function(){return a._viewBoundaryDirty?(a._viewBoundaryDirty=!1,!0):!1},getOBB:function(){return a.worldBoundary.obb},getMatrix:function(){return a._attached.camera.view.matrix}}),this._viewBoundary.on("destroyed",function(){a._viewBoundary=null})}return this._viewBoundary}},canvasBoundary:{get:function(){if(!this._canvasBoundary){var a=this;this._canvasBoundary=new XEO.Boundary2D(this.scene,{meta:{desc:"Entity "+a.id+" Canvas-space boundary"},getDirty:function(){return a._canvasBoundaryDirty?(a._canvasBoundaryDirty=!1,!0):!1},getOBB:function(){return a.viewBoundary.obb},getMatrix:function(){return a._attached.camera.project.matrix}}),this._canvasBoundary.on("destroyed",function(){a._canvasBoundary=null})}return this._canvasBoundary}},glsl:{get:function(){var a=this._renderer.objects[this.id];if(!a)return null;var b=a.program.program.source;return{draw:{vertex:b.vertexDraw,fragment:b.fragmentDraw},pickObject:{vertex:b.vertexPickObject,fragment:b.fragmentPickObject},pickPrimitive:{vertex:b.vertexPickPrimitive,fragment:b.fragmentPickPrimitive}}}},glslString:{get:function(){var a=this.glsl;return a?JSON.stringify(a,"\n",4):void 0}}},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0),this._setViewBoundaryDirty()},_setViewBoundaryDirty:function(){this._viewBoundaryDirty=!0,this._viewBoundary&&this._viewBoundary.fire("updated",!0),this._setCanvasBoundaryDirty()},_setCanvasBoundaryDirty:function(){this._canvasBoundaryDirty=!0,this._canvasBoundary&&this._canvasBoundary.fire("updated",!0)},_valid:function(){var a=this._attached.geometry;return a&&a.positions&&a.indices},_compile:function(){var a=this._attached;a.camera._compile(),a.clips._compile(),a.colorTarget._compile(),a.colorBuf._compile(),a.depthTarget._compile(),a.depthBuf._compile(),a.visibility._compile(),a.cull._compile(),a.modes._compile(),a.geometry._compile(),a.layer._compile(),a.lights._compile(),a.material._compile(),a.reflect._compile(),a.shader._compile(),a.shaderParams._compile(),a.stage._compile(),a.transform._compile(),a.billboard._compile(),a.stationary._compile(),a.viewport._compile();var b=this.id,c=this._renderer.buildObject(b);this._loading&&(this.scene.canvas.spinner.processes--,this._loading=!1),c&&c.error&&this.error(c.errorLog.join("\n"))},_getJSON:function(){var a=this._attached;return{camera:a.camera.id,clips:a.clips.id,colorTarget:a.colorTarget.id,colorBuf:a.colorBuf.id,depthTarget:a.depthTarget.id,depthBuf:a.depthBuf.id,visibility:a.visibility.id,cull:a.cull.id,modes:a.modes.id,geometry:a.geometry.id,layer:a.layer.id,lights:a.lights.id,material:a.material.id,reflect:a.reflect.id,shader:a.shader.id,shaderParams:a.shaderParams.id,stage:a.stage.id,transform:a.transform.id,billboard:a.billboard.id,stationary:a.stationary.id,viewport:a.viewport.id}},_destroy:function(){this._worldBoundary&&this._worldBoundary.destroy(),this._viewBoundary&&this._viewBoundary.destroy(),this._canvasBoundary&&this._canvasBoundary.destroy(),this._renderer.removeObject(this.id)}})}(),function(){"use strict";XEO.ColorBuf=XEO.Component.extend({type:"XEO.ColorBuf",_init:function(a){
this._state=new XEO.renderer.ColorBuf({blendEnabled:!1,colorMask:[!0,!0,!0,!0]}),this.blendEnabled=a.blendEnabled,this.colorMask=a.colorMask},_props:{blendEnabled:{set:function(a){this._state.blendEnabled=a===!0,this._renderer.imageDirty=!0,this.fire("blendEnabled",this._state.blendEnabled)},get:function(){return this._state.blendEnabled}},colorMask:{set:function(a){this._state.colorMask=a||[!0,!0,!0,!0],this._renderer.imageDirty=!0,this.fire("colorMask",this._state.colorMask)},get:function(){return this._state.colorMask}}},_compile:function(){this._renderer.colorBuf=this._state},_getJSON:function(){return{blendEnabled:this._state.blendEnabled,colorMask:this._state.colorMask}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.DepthBuf=XEO.Component.extend({type:"XEO.DepthBuf",_init:function(a){this._state=new XEO.renderer.DepthBuf({clearDepth:null,depthFunc:null,active:null}),this.clearDepth=a.clearDepth,this.depthFunc=a.depthFunc,this.active=a.active},_props:{clearDepth:{set:function(a){this._state.clearDepth=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("clearDepth",this._state.clearDepth)},get:function(){return this._state.clearDepth}},depthFunc:{set:function(a){a=a||"less";var b=this._depthFuncNames[a];void 0===b&&(this.error("Unsupported value for 'clearFunc': '"+a+"' - supported values are 'less', 'equal', 'lequal', 'greater', 'notequal' and 'gequal. Defaulting to 'less'."),b="less"),this._state.depthFunc=this.scene.canvas.gl[b],this._state.depthFuncName=a,this._renderer.imageDirty=!0,this.fire("depthFunc",this._state.depthFuncName)},get:function(){return this._state.depthFuncName}},active:{set:function(a){this._state.active!==a&&(this._state.active=a,this.fire("active",this._state.active))},get:function(){return this._state.active}}},_depthFuncNames:{less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL"},_compile:function(){this._renderer.depthBuf=this._state},_getJSON:function(){return{clearDepth:this._state.clearDepth,depthFunc:this._state.depthFuncName,active:this._state.active}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Layer=XEO.Component.extend({type:"XEO.Layer",_init:function(a){this._state=new XEO.renderer.Layer({priority:null}),this.priority=a.priority},_props:{priority:{set:function(a){a=a||0,a=Math.round(a),a!==this._state.priority&&(this._state.priority=a,this._renderer.stateOrderDirty=!0,this.fire("priority",this._state.priority))},get:function(){return this._state.priority}}},_compile:function(){this._renderer.layer=this._state},_getJSON:function(){return{priority:this._state.priority}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.ColorTarget=XEO.Component.extend({type:"XEO.ColorTarget",_init:function(a){this._state=new XEO.renderer.RenderTarget({type:XEO.renderer.RenderTarget.COLOR,renderBuf:null});var b=this.scene.canvas,c=this;this._webglContextRestored=b.on("webglContextRestored",function(){c._state.renderBuf&&c._state.renderBuf.webglRestored(b.gl)}),this.size=a.size,this.active=a.active},_props:{size:{set:function(a){a=a||null,this._size=a,this._active&&this._state.renderBuf.setSize(this._size),this.fire("size",this._size)},get:function(){return this._size}},active:{set:function(a){if(a=a!==!1,this._active!==a){var b=this._state;if(this._active=a,this._active){var c=this.scene.canvas;b.renderBuf=new XEO.renderer.webgl.RenderBuffer({canvas:c.canvas,gl:c.gl,size:this._size}),this._renderer.imageDirty=!0}else b.renderBuf&&(b.renderBuf.destroy(),b.renderBuf=null);this.fire("active",this._active)}},get:function(){return this._active}}},_compile:function(){this._renderer.colorTarget=this._state},_getJSON:function(){var a={active:this._active};return this._size&&(a.size=this._size),a},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.renderBuf.destroy(),this._state.destroy()}})}(),function(){"use strict";XEO.DepthTarget=XEO.Component.extend({type:"XEO.DepthTarget",_init:function(a){this._state=new XEO.renderer.RenderTarget({type:XEO.renderer.RenderTarget.DEPTH,renderBuf:null});var b=this.scene.canvas,c=this;this._webglContextRestored=b.on("webglContextRestored",function(){c._state.renderBuf&&c._state.renderBuf.webglRestored(b.gl)}),this.active=a.active},_props:{active:{set:function(a){if(a=a!==!1,this._active!==a){this._active=a;var b=this._state;if(this._active){var c=this.scene.canvas;b.renderBuf=new XEO.renderer.webgl.RenderBuffer({canvas:c.canvas,gl:c.gl}),this._renderer.imageDirty=!0}else b.renderBuf&&(b.renderBuf.destroy(),b.renderBuf=null);this.fire("active",this._active)}},get:function(){return this._active}}},_compile:function(){this._renderer.depthTarget=this._state},_getJSON:function(){return{active:this._active}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.renderBuf.destroy(),this._state.destroy()}})}(),function(){"use strict";XEO.Modes=XEO.Component.extend({type:"XEO.Modes",_init:function(a){this._state=new XEO.renderer.Modes({pickable:null,clippable:null,transparent:null,backfaces:null,frontface:null,collidable:null}),this.pickable=a.pickable,this.clippable=a.clippable,this.transparent=a.transparent,this.backfaces=a.backfaces,this.frontface=a.frontface,this.collidable=a.collidable},_props:{pickable:{set:function(a){a=a!==!1,this._state.pickable!==a&&(this._state.pickable=a,this._renderer.drawListDirty=!0,this.fire("pickable",this._state.pickable))},get:function(){return this._state.pickable}},clippable:{set:function(a){a=a!==!1,this._state.clippable!==a&&(this._state.clippable=a,this._renderer.imageDirty=!0,this.fire("clippable",this._state.clippable))},get:function(){return this._state.clippable}},transparent:{set:function(a){a=!!a,this._state.transparent!==a&&(this._state.transparent=a,this._renderer.stateOrderDirty=!0,this.fire("transparent",this._state.transparent))},get:function(){return this._state.transparent}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty=!0,this.fire("backfaces",this._state.backfaces))},get:function(){return this._state.backfaces}},frontface:{set:function(a){a="cw"!==a,this._state.frontface!==a&&(this._state.frontface=a,this._renderer.imageDirty=!0,this.fire("frontface",this._state.frontface?"ccw":"cw"))},get:function(){return this._state.frontface?"ccw":"cw"}},collidable:{set:function(a){a=a!==!1,a!==this._state.collidable&&(this._state.collidable=a,this.fire("collidable",this._state.collidable))},get:function(){return this._state.collidable}}},_compile:function(){this._renderer.modes=this._state},_getJSON:function(){return{pickable:this._state.pickable,clippable:this._state.clippable,transparent:this._state.transparent,backfaces:this._state.backfaces,frontface:this._state.frontface,collidable:this._state.collidable}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Viewport=XEO.Component.extend({type:"XEO.Viewport",_init:function(a){this._state=new XEO.renderer.Viewport({boundary:[0,0,100,100]}),this.boundary=a.boundary,this.autoBoundary=a.autoBoundary},_props:{boundary:{set:function(a){if(!this._autoBoundary){if(!a){var b=this.scene.canvas.boundary,c=b[2],d=b[3];a=[0,0,c,d]}this._state.boundary=a,this._renderer.imageDirty=!0,this.fire("boundary",this._state.boundary)}},get:function(){return this._state.boundary}},autoBoundary:{set:function(a){a=!!a,a!==this._autoBoundary&&(this._autoBoundary=a,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",function(a){var b=a[2],c=a[3];this._state.boundary=[0,0,b,c],this.fire("boundary",this._state.boundary)},this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))},get:function(){return this._autoBoundary}}},_compile:function(){this._renderer.viewport=this._state},_getJSON:function(){var a={};return this._autoBoundary?a.autoBoundary=!0:a.boundary=this._state.boundary.slice(),a}})}(),function(){"use strict";XEO.Stage=XEO.Component.extend({type:"XEO.Stage",_init:function(a){this._state=new XEO.renderer.Stage({priority:null,pickable:!0}),this.priority=a.priority,this.pickable=a.pickable},_props:{priority:{set:function(a){a=a||0,a!==this._state.priority&&(a=Math.round(a),this._state.priority=a,this._renderer.stateOrderDirty=!0,this.fire("priority",this._state.priority))},get:function(){return this._state.priority}},pickable:{set:function(a){this._state.pickable=a!==!1,this._renderer.drawListDirty=!0,this.fire("pickable",this._state.pickable)},get:function(){return this._state.pickable}}},_compile:function(){this._renderer.stage=this._state},_getJSON:function(){return{priority:this.priority,pickable:this.pickable}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Task=XEO.Component.extend({type:"XEO.Task",serializable:!1,_init:function(a){this.description=a.description||"",this.failed=!1,this.completed=!1},setCompleted:function(){this.fire("completed",this.completed=!0)},setFailed:function(){this.fire("failed",this.failed=!0)},_destroy:function(){!this.completed&&this.destroyed&&this.setCompleted()}})}(),function(){"use strict";XEO.Tasks=XEO.Component.extend({type:"XEO.Tasks",serializable:!1,_init:function(){this._idMap=new XEO.utils.Map,this.tasks={}},create:function(a){if(a=a||{},a.id){if(this.tasks[a.id])return this.error("Task "+XEO._inQuotes(a.id)+"already exists"),null}else a.id=this._idMap.addItem({});var b=new XEO.Task(this,a);this.tasks[a.id]=b;var c=this;return b.on("completed",function(){delete c.tasks[b.id],c._idMap.removeItem(b.id),c.fire("completed",b,!0)}),b.on("failed",function(){delete c.tasks[b.id],c._idMap.removeItem(b.id),c.fire("failed",b,!0)}),c.fire("started",b,!0),b},setCompleted:function(a){var b=this.tasks[a];return b?void b.fire("completed",b,!0):void this.error("Task not found:"+XEO._inQuotes(a))},setFailed:function(a){var b=this.tasks[a];return b?void b.fire("failed",b,!0):void this.error("Task not found:"+XEO._inQuotes(a))},clear:function(){for(var a in this.tasks)this.tasks.hasOwnProperty(a)&&this.tasks[a].setCompleted()}})}(),function(){"use strict";XEO.Shader=XEO.Component.extend({type:"XEO.Shader",_init:function(a){this._state=new XEO.renderer.Shader({vertex:null,fragment:null,params:{}}),this.vertex=a.vertex,this.fragment=a.fragment,this.setParams(a.params)},_props:{vertex:{set:function(a){this._state.vertex=a,this.fire("dirty",!0),this.fire("vertex",this._state.vertex)},get:function(){return this._state.vertex}},fragment:{set:function(a){this._state.fragment=a,this.fire("dirty",!0),this.fire("fragment",this._state.fragment)},get:function(){return this._state.fragment}},params:{get:function(){return this._state.params}}},setParams:function(a){for(var b in a)a.hasOwnProperty(b)&&(this._state.params[b]=a[b]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shader=this._state},_getJSON:function(){var a={params:this._state.params};return this._state.vertex&&(a.vertex=this._state.vertex),this._state.fragment&&(a.fragment=this._state.fragment),a}})}(),function(){"use strict";XEO.ShaderParams=XEO.Component.extend({type:"XEO.ShaderParams",_init:function(a){this._state=new XEO.renderer.ShaderParams({params:{}}),this.setParams(a.params)},_props:{params:{get:function(){return this._state.params}}},setParams:function(a){for(var b in a)a.hasOwnProperty(b)&&(this._state.params[b]=a[b]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shaderParams=this._state},_getJSON:function(){return{params:this._state.params}}})}(),function(){"use strict";XEO.Skybox=XEO.Component.extend({type:"XEO.Skybox",_init:function(a){var b={geometry:this.create(XEO.Geometry,{primitive:"triangles",positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},"geometryInstance"),transform:this.create(XEO.Scale,{xyz:[2e3,2e3,2e3]}),material:this.create(XEO.PhongMaterial,{ambient:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],emissiveMap:this.create(XEO.Texture,{src:a.src})},"materialInstance"),stationary:this.create(XEO.Stationary,{active:!0},"stationaryInstance"),modes:this.create(XEO.Modes,{backfaces:!0,pickable:!1,collidable:!1},"modesInstance")};this._skyboxEntity=this.create(XEO.Entity,b),this.size=a.size},_props:{size:{set:function(a){this._size=a||1e3,this._skyboxEntity.transform.xyz=[this._size,this._size,this._size],this.fire("size",this._size)},get:function(){return this._size}}},_getJSON:function(){return{src:this._skyboxEntity.material.emissiveMap.src,size:this._size}}})}(),function(){"use strict";XEO.Boundary2D=XEO.Component.extend({type:"XEO.Boundary2D",_init:function(a){this._div=null,this._shown=!1,this._obb=null,this._aabb=a.aabb||null,this._center=a.center||null,this._getDirty=a.getDirty,this._getOBB=a.getOBB,this._getMatrix=a.getMatrix,this.shown=a.shown},_props:{aabb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._aabb}},center:{get:function(){return this._getDirty()&&this._buildBoundary(),this._center}},shown:{set:function(a){if(a!==this._shown){if(a){if(!this._div){var b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d.position="absolute",d.padding="0",d.margin="0",d.border="3px solid #99FF99",d["border-radius"]="10px",d["z-index"]="1000",b.appendChild(c);var e=this;this.on("updated",function(){var a=e.aabb;c.style.left=a.min[0]+"px",c.style.top=a.min[1]+"px",c.style.width=a.max[0]-a.min[0]+"px",c.style.height=a.max[1]-a.min[1]+"px"}),this._div=c}}else this._div&&(this._div.parentNode.removeChild(this._div),this._div=null);this._shown=a,this.fire("shown",this._shown)}},get:function(){return this._shown}}},_buildBoundary:function(){var a=XEO.math,b=this.scene.canvas.canvas,c=b.width,d=b.height;this._obb||(this._obb=[],this._aabb=XEO.math.AABB2(),this._center=XEO.math.vec2());var e=this._getOBB(),f=this._getMatrix();e&&f&&(a.transformPoints3(f,e,this._obb),a.points3ToAABB2(this._obb,this._aabb),a.AABB2ToCanvas(this._aabb,c,d),a.getAABB2Center(this._aabb,this._center))},_getJSON:function(){return{aabb:this.aabb,center:this.center}}})}(),function(){"use strict";XEO.Boundary3D=XEO.Component.extend({type:"XEO.Boundary3D",_init:function(a){this._obb=a.obb||null,this._aabb=a.aabb||null,this._center=a.center||null,this._getDirty=a.getDirty,this._getOBB=a.getOBB,this._getAABB=a.getAABB,this._getMatrix=a.getMatrix,this._getPositions=a.getPositions},_props:{obb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._obb}},aabb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._aabb}},center:{get:function(){return this._getDirty()&&this._buildBoundary(),this._center}}},_buildBoundary:function(){var a=XEO.math;this._obb||(this._obb=[]),this._aabb||(this._aabb=XEO.math.AABB3()),this._center||(this._center=XEO.math.vec3());var b=this._getAABB?this._getAABB():null;if(b)return this._aabb.min[0]=b.min[0],this._aabb.min[1]=b.min[1],this._aabb.min[2]=b.min[2],this._aabb.max[0]=b.max[0],this._aabb.max[1]=b.max[1],this._aabb.max[2]=b.max[2],a.AABB3ToOBB3(this._aabb,this._obb),void a.getAABBCenter(this._aabb,this._center);var c,d=this._getPositions?this._getPositions():null;if(d)return(c=this._getMatrix?this._getMatrix():null)?(a.positions3ToAABB3(d,this._aabb),a.AABB3ToOBB3(this._aabb,this._obb),this._obb=a.transformPoints3(c,this._obb),a.points3ToAABB3(this._obb,this._aabb),void a.getAABBCenter(this._aabb,this._center)):(a.positions3ToAABB3(d,this._aabb),a.AABB3ToOBB3(this._aabb,this._obb),void a.getAABBCenter(this._aabb,this._center));var e=this._getOBB?this._getOBB():null;if(e){if(c=this._getMatrix?this._getMatrix():null)return a.transformPoints3(c,e,this._obb),a.points3ToAABB3(this._obb,this._aabb),void a.getAABBCenter(this._aabb,this._center);for(var f=0,g=e.length;g>f;f++)this._obb[f]=e[f];a.points3ToAABB3(this._obb,this._aabb),a.getAABBCenter(this._aabb,this._center)}},_getJSON:function(){return{obb:this.obb,aabb:this.aabb,center:this.center}}})}(),function(){"use strict";XEO.CollectionBoundary=XEO.Component.extend({type:"XEO.CollectionBoundary",_init:function(a){this._onAdded={},this._onUpdated={},this._onRemoved={},this._aabb=null,this._aabbDirty=!1,this._worldBoundary=null,this.collection=a.collection},_props:{collection:{set:function(a){var b=this;this._attach({name:"collection",type:"XEO.Collection",component:a,on:{added:function(a){b._added(a)},removed:function(a){b._removed(a)}},onAttached:function(a){a.iterate(b._bind,b),b._setAABBDirty()},onDetached:function(a){a.iterate(b._unbind,b)}}),this._setAABBDirty()},get:function(){return this._attached.collection}},worldBoundary:{get:function(){if(!this._worldBoundary){var a=this;this._worldBoundary=new XEO.Boundary3D(this.scene,{getDirty:function(){return a._aabbDirty?(a._buildAABB(),a._aabbDirty=!1,!0):!1},getAABB:function(){return a._aabb}}),this._worldBoundary.on("destroyed",function(){a._worldBoundary=null})}return this._worldBoundary}}},_added:function(a){a.worldBoundary&&this._bind(a),this._aabbDirty||this._setAABBDirty()},_removed:function(a){a.worldBoundary&&this._unbind(a),this._aabbDirty||this._setAABBDirty()},_bind:function(a){var b=a.worldBoundary;b&&(this._onUpdated[a.id]=b.on("updated",this._updated,this))},_updated:function(){this._aabbDirty||this._setAABBDirty()},_unbind:function(a){var b=a.worldBoundary;b&&(b.off(this._onUpdated[a.id]),delete this._onUpdated[a.id])},_setAABBDirty:function(){this._aabbDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0)},_buildAABB:function(){this._aabb||(this._aabb=XEO.math.AABB3());var a,b,c,d,e,f=1e5,g=1e5,h=1e5,i=-1e5,j=-1e5,k=-1e5,l=this.collection;if(l){var m=l.components;for(var n in m)m.hasOwnProperty(n)&&(a=m[n],b=a.worldBoundary,b&&(c=b.aabb,d=c.min,e=c.max,d[0]<f&&(f=d[0]),d[1]<g&&(g=d[1]),d[2]<h&&(h=d[2]),e[0]>i&&(i=e[0]),e[1]>j&&(j=e[1]),e[2]>k&&(k=e[2])))}this._aabb.min[0]=f,this._aabb.min[1]=g,this._aabb.min[2]=h,this._aabb.max[0]=i,this._aabb.max[1]=j,this._aabb.max[2]=k},_getJSON:function(){var a={};return this.collection&&(a.collection=this.collection.id),a},_destroy:function(){this.collection=null,this._worldBoundary&&this._worldBoundary.destroy()}})}(),function(){"use strict";XEO.Transform=XEO.Component.extend({type:"XEO.Transform",_init:function(a){this._leafMatrixDirty=!1,this._onParentUpdated=null,this._onParentDestroyed=null;var b=XEO.math.identityMat4(XEO.math.mat4()),c=XEO.math.inverseMat4(b,XEO.math.mat4());this._state=new XEO.renderer.ModelTransform({matrix:b,normalMatrix:c}),this.parent=a.parent,this.matrix=a.matrix},_props:{parent:{set:function(a){if(a)for(var b=this.id,c=a;c;c=c._parent)if(b===c.id)return void this.error("Not allowed to attach Transform as parent of itself - ignoring");!this._parent||a&&a.id===this._parent.id||(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed)),this._parent=a,this.fire("parent",this._parent),this._parent&&(this._onParentUpdated=this._parent.on("updated",this._parentUpdated,this),this._onParentDestroyed=this._parent.on("destroyed",this._parentUpdated,this)),this._parentUpdated()},get:function(){return this._parent}},matrix:{set:function(a){a=a||XEO.math.identityMat4(),this._matrix||(this._matrix=XEO.math.mat4()),this._matrix.set(a),this._leafMatrixDirty=!0,this.fire("matrix",this._matrix),this.fire("updated",!0)},get:function(){return this._matrix}},leafMatrix:{get:function(){return this._leafMatrixDirty&&this._buildLeafMatrix(),this._state.matrix}}},_parentUpdated:function(){this._leafMatrixDirty=!0,this.fire("updated",!0)},_buildLeafMatrix:function(){if(this._leafMatrixDirty){if(this._state.matrix=this._state.matrix||XEO.math.identityMat4(),this._parent)XEO.math.mulMat4(this._parent.leafMatrix,this._matrix,this._state.matrix);else for(var a=this._matrix,b=this._state.matrix,c=0,d=a.length;d>c;c++)b[c]=a[c];this._state.normalMatrix||(this._state.normalMatrix=XEO.math.identityMat4()),XEO.math.inverseMat4(this._state.matrix,this._state.normalMatrix),XEO.math.transposeMat4(this._state.normalMatrix),this._renderer.imageDirty=!0,this._leafMatrixDirty=!1}},_compile:function(){this._renderer.modelTransform=this._state},_getJSON:function(){return{matrix:Array.prototype.slice.call(this._matrix)}},_destroy:function(){this._parent&&(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed))}})}(),function(){"use strict";XEO.Rotate=XEO.Transform.extend({type:"XEO.Rotate",_init:function(a){this._super(a),this.xyz=a.xyz,this.angle=a.angle},_props:{xyz:{set:function(a){if(a=a||[0,1,0],this._xyz){if(this._xyz[0]===a[0]&&this._xyz[1]===a[1]&&this._xyz[2]===a[2])return;this._xyz[0]=a[0],this._xyz[1]=a[1],this._xyz[2]=a[2]}else this._xyz=a;this._buildMatrix(),this.fire("xyz",this._xyz)},get:function(){return this._xyz}},angle:{set:function(a){this._angle=a||0,this._buildMatrix(),this.fire("angle",this._angle)},get:function(){return this._angle}}},_buildMatrix:function(){null!==this._xyz&&null!==this._angle&&(this.matrix=XEO.math.rotationMat4v(this._angle*XEO.math.DEGTORAD,this._xyz,this._matrix||(this._matrix=XEO.math.identityMat4())))},_getJSON:function(){return{xyz:this._xyz,angle:this._angle}}})}(),function(){"use strict";XEO.Quaternion=XEO.Transform.extend({type:"XEO.Quaternion",_init:function(a){this._super(a),this.xyzw=a.xyzw},_props:{xyzw:{set:function(a){var b=XEO.math;this._xyzw=a||b.identityQuaternion(),this.matrix=b.quaternionToMat4(this._xyzw,b.mat4()),this.fire("xyzw",this._xyzw)},get:function(){return this._xyzw}}},rotate:function(){var a=XEO.math,b=a.vec4(),c=a.vec4();a.mat4();return function(d){b[0]=d[0],b[1]=d[1],b[2]=d[2],b[3]=d[3]*a.DEGTORAD,a.angleAxisToQuaternion(b,c),this.xyzw=a.mulQuaternions(this._xyzw,c,this._xyzw)}}(),_getJSON:function(){return{xyzw:this._xyzw}}})}(),function(){"use strict";XEO.Scale=XEO.Transform.extend({type:"XEO.Scale",_init:function(a){this._super(a),this.xyz=a.xyz},_props:{xyz:{set:function(a){if(a=a||[1,1,1],this._xyz){if(this._xyz[0]===a[0]&&this._xyz[1]===a[1]&&this._xyz[2]===a[2])return;this._xyz[0]=a[0],this._xyz[1]=a[1],this._xyz[2]=a[2]}else this._xyz=a;this.matrix=XEO.math.scalingMat4v(this._xyz,this._matrix||(this._matrix=XEO.math.identityMat4())),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){return{xyz:this.xyz}}})}(),function(){"use strict";XEO.Translate=XEO.Transform.extend({type:"XEO.Translate",_init:function(a){this._super(a),this.xyz=a.xyz},_props:{xyz:{set:function(a){if(a=a||[0,0,0],this._xyz){if(this._xyz[0]===a[0]&&this._xyz[1]===a[1]&&this._xyz[2]===a[2])return;this._xyz[0]=a[0],this._xyz[1]=a[1],this._xyz[2]=a[2]}else this._xyz=a;this.matrix=XEO.math.translationMat4v(this._xyz,this._matrix||(this._matrix=XEO.math.identityMat4())),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){return{xyz:this.xyz}}})}(),function(){"use strict";XEO.Billboard=XEO.Component.extend({type:"XEO.Billboard",_init:function(a){this._super(a),this._state=new XEO.renderer.Billboard({active:!0,spherical:!0,hash:"a;s;"}),this.active=a.active!==!1,this.spherical=a.spherical!==!1},_props:{active:{set:function(a){a=!!a,this._state.active!==a&&(this._state.active=a,this._state.hash=(this._state.active?"a;":";")+(this._state.spherical?"s;":";"),this.fire("dirty",!0),this.fire("active",this._state.active))},get:function(){return this._state.active}},spherical:{set:function(a){a=!!a,this._state.spherical!==a&&(this._state.spherical=a,this._state.hash=(this._state.active?"a;":";")+(this._state.spherical?"s;":";"),this.fire("dirty",!0),this.fire("spherical",this._state.spherical))},get:function(){return this._state.spherical}}},_compile:function(){this._renderer.billboard=this._state},_getJSON:function(){return{active:this._state.active}}})}(),function(){"use strict";XEO.Stationary=XEO.Component.extend({type:"XEO.Stationary",_init:function(a){this._super(a),this._state=new XEO.renderer.Stationary({active:!0}),this.active=a.active!==!1},_props:{active:{set:function(a){a=!!a,this._state.active!==a&&(this._state.active=a,this._state.hash=this._state.active?"a;":";",this.fire("dirty",!0),this.fire("active",this._state.active))},get:function(){return this._state.active}}},_compile:function(){this._renderer.stationary=this._state},_getJSON:function(){return{active:this._state.active}}})}(),XEO.version="0.1.0";