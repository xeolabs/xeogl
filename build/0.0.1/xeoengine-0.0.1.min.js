/*
 * xeoEngine V0.0.1
 *
 * A WebGL-based 3D engine from xeoLabs
 * http://xeoengine.org/
 *
 * Built on 2015-03-08
 *
 * MIT License
 * Copyright 2015, Lindsay Kay
 * http://xeolabs.com/
 *
 */

!function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){!a&&this.__init&&this.__init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)if("_props"!==g)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];else{var h,i=c[g];for(var j in i)h=i[j],Object.defineProperty(f,j,h)}return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(),function(){"use strict";var a=function(){this._scene=null,this.scenes={},this._dirtyScenes={};var a=this,b=function(){var c,d={};for(var e in a.scenes)a.scenes.hasOwnProperty(e)&&(c=a.scenes[e],c.fire("tick",d),a._dirtyScenes[e]&&(c._compile(),a._dirtyScenes[e]=!1));window.requestAnimationFrame(b)};window.requestAnimationFrame(b)};a.prototype={constructor:a,get scene(){return this._scene||(this._scene=new a.Scene)},_addScene:function(a){this.scenes[a.id]=a;var b=this;a.on("destroyed",function(){delete b.scenes[a.id],delete b._dirtyScenes[a.id]}),a.on("dirty",function(){b._dirtyScenes[a.id]=!0})},clear:function(){for(var a in this.scenes)this.scenes.hasOwnProperty(a)&&this.scenes[a].destroy();this.scenes={},this._dirtyScenes={}},_isArray:function(a){return a&&!a.propertyIsEnumerable("length")&&"object"==typeof a&&"number"==typeof a.length},_isString:function(a){return"string"==typeof a||a instanceof String},_copy:function(a){return this._apply(a,{})},_apply:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_applyIf:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(void 0===b[c]||null===b[c])&&(b[c]=a[c]);return b},_createType:function(b){var c=a.Component;for(var d in b)c.prototype[d]=d;return c}},window.XEO=new a}(),function(){"use strict";XEO.utils=XEO.utils||{},XEO.utils.Map=function(a,b){this.items=a||[],b=b||0;var c=b+1;this.addItem=function(){var a;if(2===arguments.length){var b=arguments[0];if(a=arguments[1],this.items[b])throw"ID clash: '"+b+"'";return this.items[b]=a,b}for(;;){a=arguments[0];var d=c++;if(!this.items[d])return this.items[d]=a,d}},this.removeItem=function(a){var b=this.items[a];return delete this.items[a],b}}}(),function(){"use strict";XEO.Component=Class.extend({__init:function(){this.scene=null;var a={},b=arguments[0],c=arguments[1];(b||c)&&(b&&!c?"scene"===b.type?(this.scene=b,this._renderer=this.scene._renderer):a=b:b&&c&&(this.scene=b,a=c)),this._renderer={},this.metadata=a.metadata||{},this.id=a.id,this.destroyed=!1,this._children={},this._childDestroySubs={},this._childDirtySubs={},this._handleMap=new XEO.utils.Map,this._locSubs={},this._handleLocs={},this.props={};var d=this._stateIDMap.addItem({});this._state={type:this.type,stateId:d,hash:""+d},this._init&&this._init(a),this.scene&&this.scene._addComponent(this)},_stateIDMap:new XEO.utils.Map({}),type:"component",className:"XEO.Component",_init:function(){},fire:function(a,b,c){c!==!0&&(this.props[a]=b);var d=this._locSubs[a];if(d)for(var e in d)d.hasOwnProperty(e)&&d[e].call(this,b)},on:function(a,b){var c=this._locSubs[a];c||(c={},this._locSubs[a]=c);var d=this._handleMap.addItem();c[d]=b,this._handleLocs[d]=a;var e=this.props[a];return e&&b.call(this,e),d},off:function(a){var b=this._handleLocs[a];if(b){delete this._handleLocs[a];var c=this._locSubs[b];c&&delete c[a],this._handleMap.removeItem(a)}},once:function(a,b){var c=this,d=this.on(a,function(a){c.off(d),b(a)})},log:function(a){window.console.log("[LOG] "+this.id+": "+a),this.scene.fire("log",a)},error:function(a){window.console.error("[ERROR] "+this.id+": "+a),this.scene.fire("error",a)},warn:function(a){window.console.warn("[WARN] "+this.id+": "+a),this.scene.fire("warn",a)},_setChild:function(a,b){if(b){if(XEO._isString(b)){var c=b;if(b=this.scene.components[c],!b)return void this.error("component not found for ID: '"+c+"'")}if(!b.type||b.type!==a)return void this.error("Failed to add component '"+b.id+"' to object - component expected to be a '"+a+"' type")}else if(b=this.scene[a],!b)return void this.error("Default component not found for type '"+a+"'");var d=this._children[a];if(d){if(d.id===b.id)return;d.off(this._childDestroySubs[a]),d.off(this._childDirtySubs[a])}this._children[a]=b;var e=this;this._childDestroySubs[a]=b.on("destroyed",function(){delete e._children[a];var c=e.scene[a];return b.id===c.id?void e.set(a,null):void e._setChild(a,c)}),this._childDirtySubs[a]=b.on("dirty",function(){e.fire("dirty",!0)}),this.fire("dirty",!0),this.fire(a,b)},_compile:function(){},_props:{json:{get:function(){var a={id:this.id,className:this.className,type:this.type,metadata:this.metadata};return this._getJSON?XEO._apply(a,this._getJSON()):a}}},destroy:function(){var a;for(var b in this._children)this._children.hasOwnProperty(b)&&(a=this._children[b],a.off(this._childDestroySubs[b]),a.off(this._childDirtySubs[b]));XEO.Component._stateIDMap.removeItem(this._state.stateId),this._destroy&&this._destroy(),this.fire("destroyed",this.destroyed=!0)},_destroy:function(){}})}(),function(){"use strict";XEO.AmbientLight=XEO.Component.extend({className:"XEO.AmbientLight",type:"light",_init:function(a){this.mode="ambient",this.ambient=a.ambient},_props:{ambient:{set:function(a){a=a||[.7,.7,.8],this._state.ambient=a,this._renderer.imageDirty=!0,this.fire("ambient",a)},get:function(){return this._state.ambient}}},_getJSON:function(){return{color:this.color}}})}(),function(){"use strict";XEO.Camera=XEO.Component.extend({className:"XEO.Camera",type:"camera",_init:function(a){this.project=a.project,this.view=a.view},_props:{project:{set:function(a){this._setChild("project",a)},get:function(){return this._children.project}},view:{set:function(a){this._setChild("view",a)},get:function(){return this._children.view}}},_compile:function(){this._children.project._compile(),this._children.view._compile()},_getJSON:function(){return{project:this.project.id,view:this.view.id}}})}(),function(){"use strict";XEO.Canvas=XEO.Component.extend({className:"XEO.Canvas",type:"canvas",_WEBGL_CONTEXT_NAMES:["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],_init:function(a){if(this.canvas=null,this.gl=null,this.contextAttr=a.contextAttr||{},a.canvas?XEO._isString(a.canvas)?(this.canvas=document.getElementById(a.canvas),this.canvas||(this.error("Canvas element not found: '"+a.canvas+"' - creating one automatically."),this._createCanvas())):this.error("Config 'canvasId' should be a string."):this._createCanvas(),this.canvas){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this._initWebGL();var b=this;this.canvas.addEventListener("webglcontextlost",function(){b.fire("webglContextLost")},!1),this.canvas.addEventListener("webglcontextrestored",function(){b._initWebGL(),b.gl&&b.fire("webglContextRestored",b.gl)},!1);var c=this.canvas.width,d=this.canvas.height;this._tick=this.scene.on("tick",function(){var a=b.canvas;(a.width!==c||a.height!==d)&&(c=a.width,d=a.height,b.fire("resized",{width:a.width,height:a.height,aspect:a.height/a.width}))})}},pick:function(){},_createCanvas:function(){var a="canvas-"+this.id,b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d.height="100%",d.width="100%",d.padding="0",d.margin="0",d.left="0",d.top="0",d.position="absolute",c.innerHTML+='<canvas id="'+a+'" style="width: 100%; height: 100%; margin: 0; padding: 0;"></canvas>',b.appendChild(c),this.canvas=document.getElementById(a)},_initWebGL:function(){for(var a=0;!this.gl&&a<this._WEBGL_CONTEXT_NAMES.length;a++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[a],this.contextAttr)}catch(b){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0))},_destroy:function(){this.scene.off(this._tick)}})}(),function(){"use strict";XEO.Clip=XEO.Component.extend({className:"XEO.Clip",type:"clip",_init:function(a){this.mode=a.mode,this.dir=a.dir,this.dist=a.dist},_props:{mode:{set:function(a){a=a||"disabled",this._state.mode=a,this._renderer.imageDirty=!0,this.fire("mode",a)},get:function(){return this._state.mode}},dir:{set:function(a){a=a||[1,0,0],this._state.dir=a,this._renderer.imageDirty=!0,this.fire("dir",a)},get:function(){return this._state.dir}},dist:{set:function(a){a=void 0!==a?a:1,this._state.dist=a,this._renderer.imageDirty=!0,this.fire("dist",a)},get:function(){return this._state.dist}}},_getJSON:function(){return{mode:this.mode,dir:this.dir,dist:this.dist}}})}(),function(){"use strict";XEO.Clips=XEO.Component.extend({className:"XEO.Clips",type:"clips",_init:function(a){this._clips=[],this._dirtySubs=[],this._destroyedSubs=[],this.clips=a.clips},_props:{clips:{set:function(a){function b(){h.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=h._clips.length;c>b;b++)if(h._clips[b].id===a)return h._clips=h._clips.slice(b,b+1),h._dirtySubs=h._dirtySubs.slice(b,b+1),h._destroyedSubs=h._destroyedSubs.slice(b,b+1),h.fire("dirty",!0),void h.fire("clips",h._clips)}a=a||[];for(var d,e=0,f=this._clips.length;f>e;e++)d=this._clips[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._clips=[],this._dirtySubs=[],this._destroyedSubs=[];for(var g=[],h=this,e=0,f=a.length;f>e;e++){if(d=a[e],XEO._isString(d)){var i=d;if(d=this.components[i],!d){this.error("Clip not found for ID: '"+i+"'");continue}}"clip"===d.type?(this._clips.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c)),g.push(d)):this.error("Component is not a clip: '"+d.id+"'")}this.fire("dirty",!0),this.fire("clips",this._clips)},get:function(){return this._clips.slice(0,this._clips.length)}}},_compile:function(){for(var a=[],b=0,c=this._clips.length;c>b;b++)a.push(this._clips[b]._state);var d={type:"clips",clips:a,hash:this._makeHash(a)};this._renderer.clips=d},_makeHash:function(a){if(0===a.length)return"";for(var b,c=[],d=0,e=a.length;e>d;d++)b=a[d],c.push(b.mode),b.specular&&c.push("s"),b.diffuse&&c.push("d"),c.push("world"===b.space?"w":"v");return c.join("")},_getJSON:function(){for(var a=[],b=0,c=this._clips.length;c>b;b++)a.push(this._clips[b].id);return{clips:a}}})}(),function(){"use strict";XEO.ColorBuf=XEO.Component.extend({className:"XEO.ColorBuf",type:"colorbuf",_init:function(a){this.blendEnabled=a.blendEnabled,this.colorMask=a.colorMask},_props:{blendEnabled:{set:function(a){a=a!==!1,this._state.blendEnabled=a,this._renderer.imageDirty=!0,this.fire("blendEnabled",a)},get:function(){return this._state.blendEnabled}},colorMask:{set:function(a){a=a||[!0,!0,!0,!0],this._state.colorMask=a,this._renderer.imageDirty=!0,this.fire("colorMask",a)},get:function(){return this._state.colorMask}}},_compile:function(){this._renderer.colorBuf=this._state},_getJSON:function(){return{blendEnabled:this.blendEnabled,colorMask:this.colorMask}}})}(),function(){"use strict";XEO.ColorTarget=XEO.Component.extend({className:"XEO.ColorTarget",type:"renderBuf",_componentCoreMap:{},_init:function(){this._state.bufType="color",this._componentCoreMap[this._state.id]=this._state,this._state.renderBuf=new XEO.webgl.RenderBuffer({canvas:this.scene.canvas})},_compile:function(){this._renderer.colorTarget=this._state},_destroy:function(){this._state&&(this._state.renderBuf&&this._state.renderBuf.destroy(),delete this._componentCoreMap[this._state.id])}})}(),function(){"use strict";XEO.Configs=XEO.Component.extend({className:"XEO.Configs",type:"configs",_init:function(a){for(var b in a)a.hasOwnProperty(b)&&this.fire(b,a[b])},_toJSON:function(){return XEO._copy(this.props)}})}(),function(){"use strict";XEO.DepthBuf=XEO.Component.extend({className:"XEO.DepthBuf",type:"DepthBuf",_init:function(a){this.clearDepth=a.clearDepth,this.depthFunc=a.depthFunc},_props:{clearDepth:{set:function(a){a=void 0!==a?a:1,this._state.clearDepth=a,this._renderer.imageDirty=!0,this.fire("clearDepth",a)},get:function(){return this._state.clearDepth}},depthFunc:{set:function(a){a=a||"less";var b=this._depthFuncNames[a];return void 0===b?void this.error("unsupported value for 'clearFunc' attribute on depthBuf component: '"+a+"' - supported values are 'less', 'equal', 'lequal', 'greater', 'notequal' and 'gequal'"):(this._state.depthFunc=this.scene.canvas.gl[b],this._state.depthFuncName=a,this._renderer.imageDirty=!0,void this.fire("depthFunc",a))},get:function(){return this._state.depthFuncName}}},_depthFuncNames:{less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL"},_compile:function(){this._renderer.depthBuf=this._state},_getJSON:function(){return{clearDepth:this.clearDepth,depthFunc:this.depthFunc}}})}(),function(){"use strict";XEO.DepthTarget=XEO.Component.extend({className:"XEO.DepthTarget",type:"renderBuf",_componentCoreMap:{},_init:function(){this._state.bufType="depth",this._componentCoreMap[this._state.coreId]=this._state,this._state.renderBuf=new XEO.webgl.RenderBuffer({canvas:this.scene.canvas})},_compile:function(){this._renderer.depthTarget=this._state},_destroy:function(){this._state&&(this._state.renderBuf&&this._state.renderBuf.destroy(),delete this._componentCoreMap[this._state.coreId])}})}(),function(){"use strict";XEO.DirLight=XEO.Component.extend({className:"XEO.DirLight",type:"light",_init:function(a){this.mode="dir",this._state.mode=this.mode,this.dir=a.dir,this.diffuse=a.diffuse,this.specular=a.specular,this.space=a.space},_props:{dir:{set:function(a){a=a||[1,1,1],this._state.dir=a,this._renderer.imageDirty=!0,this.fire("dir",a)},get:function(){return this._state.dir}},diffuse:{set:function(a){a=a||[.7,.7,.8],this._state.diffuse=a,this._renderer.imageDirty=!0,this.fire("diffuse",a)},get:function(){return this._state.diffuse}},specular:{set:function(a){a=a||[1,1,1],this._state.specular=a,this._renderer.imageDirty=!0,this.fire("specular",a)},get:function(){return this._state.specular}},space:{set:function(a){a=a||"view",a!==this._state.space&&(this._state.space=a,this.fire("dirty",!0),this.fire("space",a))},get:function(){return this._state.space}}},_getJSON:function(){return{mode:this.mode,dir:this.dir,color:this.color,diffuse:this.diffuse,specular:this.specular,space:this.space}}})}(),function(){"use strict";XEO.Visibility=XEO.Component.extend({className:"XEO.Visibility",type:"enable",_init:function(a){this.visible=a.visible},_props:{visible:{set:function(a){a=a!==!1,this._state.visible=a,this._renderer.imageDirty=!0,this.fire("visible",a)},get:function(){return this._state.visible}}},_compile:function(){this._renderer.enable=this._state},_getJSON:function(){return{visible:this.visible}}})}(),function(){"use strict";XEO.Modes=XEO.Component.extend({className:"XEO.Modes",type:"modes",_init:function(a){this.picking=a.picking,this.clipping=a.clipping,this.transparent=a.transparent,this.backfaces=a.backfaces,this.frontface=a.frontface,this.backfaceLighting=a.backfaceLighting,this.backfaceTexturing=a.backfaceTexturing,this.diffuse=a.diffuse,this.specular=a.specular,this.ambient=a.ambient,this.reflection=a.reflection},_props:{picking:{set:function(a){a=a!==!1,this._state.picking=a,this._renderer.drawListDirty=!0,this.fire("picking",a)},get:function(){return this._state.picking}},clipping:{set:function(a){a=a!==!1,this._state.clipping=a,this._renderer.imageDirty=!0,this.fire("clipping",a)},get:function(){return this._state.clipping}},transparent:{set:function(a){a=!!a,this._state.transparent=a,this._renderer.stateOrderDirty=!0,this.fire("transparent",a)},get:function(){return this._state.transparent}},backfaces:{set:function(a){a=a!==!1,this._state.backfaces=a,this._renderer.imageDirty=!0,this.fire("backfaces",a)},get:function(){return this._state.backfaces}},frontface:{set:function(a){a=a||"ccw",this._state.frontface=a,this._renderer.imageDirty=!0,this.fire("frontface",a)},get:function(){return this._state.frontface}},backfaceLighting:{set:function(a){a=a!==!1,this._state.backfaceLighting=a,this._renderer.imageDirty=!0,this.fire("backfaceLighting",a)},get:function(){return this._state.backfaceLighting}},backfaceTexturing:{set:function(a){a=a!==!1,this._state.backfaceTexturing=a,this._renderer.imageDirty=!0,this.fire("backfaceTexturing",a)},get:function(){return this._state.backfaceTexturing}},diffuse:{set:function(a){a=a!==!1,this._state.diffuse=a,this._renderer.imageDirty=!0,this.fire("diffuse",a)},get:function(){return this._state.diffuse}},specular:{set:function(a){a=a!==!1,this._state.specular=a,this._renderer.imageDirty=!0,this.fire("specular",a)},get:function(){return this._state.specular}},ambient:{set:function(a){a=a!==!1,this._state.ambient=a,this._renderer.imageDirty=!0,this.fire("ambient",a)},get:function(){return this._state.ambient}},reflection:{set:function(a){a=a!==!1,this._state.reflection=a,this._renderer.imageDirty=!0,this.fire("reflection",a)},get:function(){return this._state.reflection}}},_compile:function(){this._renderer.flags=this._state},_getJSON:function(){return{picking:this.picking,clipping:this.clipping,transparent:this.transparent,backfaces:this.backfaces,frontface:this.frontface,backfaceLighting:this.backfaceLighting,backfaceTexturing:this.backfaceTexturing,diffuse:this.diffuse,specular:this.specular,ambient:this.ambient,reflection:this.reflection}}})}(),function(){"use strict";XEO.Frustum=XEO.Component.extend({className:"XEO.Frustum",type:"project",_init:function(a){this.mode="frustum",this.left=a.left,this.right=a.right,this.top=a.top,this.bottom=a.bottom,this.near=a.near,this.far=a.far;var b=this;this._onTick=this.scene.on("tick",function(){b._dirty&&b._rebuild()})},_rebuild:function(){var a=this._state;a.matrix=XEO.math.frustumMat4c(a.left,a.right,a.bottom,a.top,a.near,a.far,[]),a.mat?a.mat.set(a.matrix):a.mat=new Float32Array(a.matrix),this.fire("matrix",a.matrix),this._dirty=!1},_props:{left:{set:function(a){a=a||-1,this._state.left=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("left",a)},get:function(){return this._state.left}},rights:{set:function(a){a=a||1,this._state.right=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("right",a)},get:function(){return this._state.right}},top:{set:function(a){a=a||1,this._state.top=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("top",a)},get:function(){return this._state.top}},bottom:{set:function(a){a=a||-1,this._state.bottom=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("bottom",a)},get:function(){return this._state.bottom}},near:{set:function(a){a=a||.1,this._state.near=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("near",a)},get:function(){return this._state.near}},far:{set:function(a){a=a||1e4,this._state.far=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("far",a)},get:function(){return this._state.far}},matrix:{get:function(){return this._dirty&&this._state.rebuild(),this._state.matrix.slice(0)}}},_compile:function(){this._renderer.cameraMat=this._state},_getJSON:function(){return{left:this.left,right:this.right,top:this.top,bottom:this.bottom,near:this.near,far:this.far}},_destroy:function(){this.scene.off(this._onTick)}})}(),function(){"use strict";XEO.Geometry=XEO.Component.extend({className:"XEO.Geometry",type:"geometry",_init:function(a){a.positions||a.normals||a.uv||!a.uv2||a.indices||(a.primitive="triangles",a.positions=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],a.colors=[1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,1,0,1,1,0,1,1],a.normals=[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],a.uv=[1,1,0,1,0,0,1,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1],a.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),this.primitive=a.primitive,this.positions=a.positions,this.normals=a.normals,this.uv=a.uv,this.uv2=a.uv2,this.colors=a.colors,this.indices=a.indices,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",function(){}),this.scene.stats.inc("geometries")},_props:{primitive:{set:function(a){a=a||"triangles";var b,c=this.scene.canvas.gl;switch(a){case"points":b=c.POINTS;break;case"lines":b=c.LINES;break;case"line-loop":b=c.LINE_LOOP;break;case"line-strip":b=c.LINE_STRIP;break;case"triangles":b=c.TRIANGLES;break;case"triangle-strip":b=c.TRIANGLE_STRIP;break;case"triangle-fan":b=c.TRIANGLE_FAN;break;default:this.error("XEO.Geometry 'primitive' value is unsupported - should be either 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan' (defaulting to 'triangles')"),a="triangles",b=c.TRIANGLES}this._state.primitive=a,this._state.primitiveEnum=b,this.fire("dirty",!0),this.fire("primitive",b)},get:function(){return this._state.primitive}},positions:{set:function(a){this.fire("positions",a)},get:function(){}},normals:{set:function(){},get:function(){}},uv:{set:function(){},get:function(){}},uv2:{set:function(){},get:function(){}},colors:{set:function(){},get:function(){}},indices:{set:function(){},get:function(){}},boundingBox:{get:function(){}},boundingSphere:{get:function(){}},center:{get:function(){}}},_compile:function(){},_buildNormals:function(a){for(var b,c,d,e,f,g,h=a.positions,i=a.indices,j=new Array(h.length/3),k=0,l=i.length-3;l>k;k+=3){b=i[k+0],c=i[k+1],d=i[k+2],e=[h[3*b+0],h[3*b+1],h[3*b+2]],f=[h[3*c+0],h[3*c+1],h[3*c+2]],g=[h[3*d+0],h[3*d+1],h[3*d+2]],f=XEO.math.subVec4(f,e,[0,0,0,0]),g=XEO.math.subVec4(g,e,[0,0,0,0]);var m=XEO.math.normalizeVec4(XEO.math.cross3Vec4(f,g,[0,0,0,0]),[0,0,0,0]);j[b]||(j[b]=[]),j[c]||(j[c]=[]),j[d]||(j[d]=[]),j[b].push(m),j[c].push(m),j[d].push(m)}for(var n=new Array(h.length),k=0,l=j.length;l>k;k++){for(var o=j[k].length,p=0,q=0,r=0,s=0;o>s;s++)p+=j[k][s][0],q+=j[k][s][1],r+=j[k][s][2];n[3*k+0]=p/o,n[3*k+1]=q/o,n[3*k+2]=r/o}a.normals=n},_buildTangents:function(a){for(var b=a.positions,c=a.indices,d=a.uv,e=[],f=0;f<c.length;f+=3){var g=c[f],h=[b[3*g],b[3*g+1],b[3*g+2]],i=[d[2*g],d[2*g+1]];g=c[f+1];var j=[b[3*g],b[3*g+1],b[3*g+2]],k=[d[2*g],d[2*g+1]];g=c[f+2];for(var l=[b[3*g],b[3*g+1],b[3*g+2]],m=[d[2*g],d[2*g+1]],n=XEO.math.subVec3(j,h,[]),o=XEO.math.subVec3(l,h,[]),p=XEO.math.subVec2(k,i,[]),q=XEO.math.subVec2(m,i,[]),r=1/(p[0]*q[1]-p[1]*q[0]),s=XEO.math.mulVec3Scalar(XEO.math.subVec3(XEO.math.mulVec3Scalar(n,q[1],[]),XEO.math.mulVec3Scalar(o,p[1],[]),[]),r,[]),t=0;3>t;t++){var u=c[f+t];e[u]="undefined"!=typeof e[u]?XEO.math.addVec3(e[u],s,[]):s}}for(var v=[],w=0;w<e.length;w++)v=v.concat(e[w]);return v},_getJSON:function(){var a={primitive:this.primitive};return this._state.positions&&(a.positions=this.positions),this._state.normals&&(a.normals=this.normals),this._state.uv&&(a.uv=this.uv),this._state.uv2&&(a.uv2=this.uv2),this._state.colors&&(a.colors=this.colors),this._state.indices&&(a.indices=this.indices),a},_destroy:function(){this.scene.stats.dec("geometries"),this.scene.canvas.off(this._webglContextRestored)}})}(),function(){"use strict";XEO.Input=XEO.Component.extend({className:"XEO.Input",type:"input",_init:function(a){var b=this;this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,document.addEventListener("keydown",this._keyDownListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!0:a.altKey?b.altDown=!0:(b.keyDown[a.keyCode]=!0,b.fire("keydown",a.keyCode,!0)))},!0),document.addEventListener("keyup",this._keyUpListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!1:a.altKey?b.altDown=!1:(b.keyDown[a.keyCode]=!1,b.fire("keyup",a.keyCode,!0)))}),a.canvas.addEventListener("mousedown",this._mouseDownListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!0;break;case 2:b.mouseDownMiddle=!0;break;case 3:b.mouseDownRight=!0}var c=b._getClickCoordsWithinElement(a);b.fire("mousedown",c,!0)}}),a.canvas.addEventListener("mouseup",this._mouseUpListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("mouseup",c,!0)}}),a.canvas.addEventListener("dblclick",this._dblClickListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1,b.mouseDownRight=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownLeft=!1,b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("dblclick",c,!0)}}),a.canvas.addEventListener("mousemove",this._mouseMoveListener=function(a){if(b.enabled){var c=b._getClickCoordsWithinElement(a);b.fire("mousemove",c,!0)}}),a.canvas.addEventListener("mousewheel",this._mouseWheelListener=function(a,c){b.enabled&&b.fire("mousewheel",{event:a,d:c},!0)}),function(){var a,c;b.on("mousedown",function(b){a=b.x,c=b.y}),b.on("mouseup",function(d){a===d.x&&c===d.y&&b.fire("mouseclicked",d,!0)})}()},_getClickCoordsWithinElement:function(a){var b={x:0,y:0};if(a){for(var c=a.target,d=0,e=0;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;b.x=a.pageX-d,b.y=a.pageY-e}else a=window.event,b.x=a.x,b.y=a.y;return b},setEnabled:function(a){this.enabled!==a&&this.fire("enabled",this.enabled=a)},KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_NUM_0:48,KEY_NUM_1:49,KEY_NUM_2:50,KEY_NUM_3:51,KEY_NUM_4:52,KEY_NUM_5:53,KEY_NUM_6:54,KEY_NUM_7:55,KEY_NUM_8:56,KEY_NUM_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW:91,KEY_RIGHT_WINDOW:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_SPACE:32,_destroy:function(){document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener)}})}(),function(){"use strict";XEO.Layer=XEO.Component.extend({className:"XEO.Layer",type:"layer",_init:function(a){this.priority=a.priority},priority:{set:function(a){a=a||0,this._state.priority=a,this._renderer.stateOrderDirty=!0,this.fire("priority",a)},get:function(){return this._state.priority}},_compile:function(){this._renderer.layer=this._state},_getJSON:function(){return{priority:this.priority}}})}(),function(){"use strict";XEO.Lights=XEO.Component.extend({className:"XEO.Lights",type:"lights",_init:function(a){this._lights=[],this._dirtySubs=[],this._destroyedSubs=[],this.lights=a.lights},_props:{lights:{set:function(a){function b(){h.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=h._lights.length;c>b;b++)if(h._lights[b].id===a)return h._lights=h._lights.slice(b,b+1),h._dirtySubs=h._dirtySubs.slice(b,b+1),h._destroyedSubs=h._destroyedSubs.slice(b,b+1),h.fire("dirty",!0),void h.fire("lights",h._lights)}a=a||[];for(var d,e=0,f=this._lights.length;f>e;e++)d=this._lights[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._lights=[],this._dirtySubs=[],this._destroyedSubs=[];for(var g=[],h=this,e=0,f=a.length;f>e;e++){if(d=a[e],XEO._isString(d)){var i=d;if(d=this.components[i],!d){this.error("Component with this ID not found: '"+i+"'");continue}}"light"===d.type?(this._lights.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c)),g.push(d)):this.error("Component with this ID is not a light source: '"+d.id+"'")}this.fire("dirty",!0),this.fire("lights",this._lights)},get:function(){return this._lights.slice(0,this._lights.length)}}},_compile:function(){for(var a=[],b=0,c=this._lights.length;c>b;b++)a.push(this._lights[b]._state);var d={type:"lights",lights:a,hash:this._makeHash(a)};this._renderer.lights=d},_makeHash:function(a){if(0===a.length)return"";for(var b,c=[],d=0,e=a.length;e>d;d++)b=a[d],c.push(b.mode),b.specular&&c.push("s"),b.diffuse&&c.push("d"),c.push("world"===b.space?"w":"v");return c.join("")},_getJSON:function(){for(var a=[],b=0,c=this._lights.length;c>b;b++)a.push(this._lights[b].id);return{lights:a}}})}(),function(){"use strict";XEO.Lookat=XEO.Component.extend({className:"XEO.Lookat",type:"view",_init:function(a){this.eye=a.eye,this.look=a.look,this.up=a.up;var b=this._state,c=this;b.rebuild=function(){b.matrix=XEO.math.lookAtMat4c(b.eye[0],b.eye[1],b.eye[2],b.look[0],b.look[1],b.look[2],b.up[0],b.up[1],b.up[2]),b.lookAt={eye:b.eye,look:b.look,up:b.up},b.mat?(b.mat.set(b.matrix),b.normalMat.set(XEO.math.transposeMat4(XEO.math.inverseMat4(b.matrix,XEO.math.mat4())))):(b.mat=new Float32Array(b.matrix),b.normalMat=new Float32Array(XEO.math.transposeMat4(XEO.math.inverseMat4(b.matrix,XEO.math.mat4())))),c.fire("matrix",b.matrix),b.dirty=!1},this._state.dirty=!0},_props:{eye:{set:function(a){a=a||[0,0,-10],this._state.eye=a,this._state.dirty=!0,this._renderer.imageDirty=!0,this.fire("eye",a)},get:function(){return this._state.eye}},look:{set:function(a){a=a||[0,0,0],this._state.look=a,this._state.dirty=!0,this._renderer.imageDirty=!0,this.fire("look",a)},get:function(){return this._state.look}},up:{set:function(a){a=a||[0,1,0],this._state.up=a,this._state.dirty=!0,this._renderer.imageDirty=!0,this.fire("up",a)},get:function(){return this._state.up}},matrix:{get:function(){return this._state.dirty&&this._state.rebuild(),this._state.matrix.slice(0)}}},_compile:function(){this._renderer.viewTransform=this._state},_getJSON:function(){return{eye:this.eye,look:this.look,up:this.up}}})}(),function(){"use strict";XEO.Matrix=XEO.Component.extend({className:"XEO.Matrix",type:"transform",_init:function(a){this.elements=a.elements},_props:{elements:{set:function(a){a=a||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this._state.elements=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("elements",a)},get:function(){return this._state.elements}}},_compile:function(){},_getJSON:function(){return{elements:this._state.elements}}})}(),function(){"use strict";XEO.Material=XEO.Component.extend({className:"XEO.Material",type:"material",_init:function(a){this._textures=[],this._dirtyTextureSubs=[],this._destroyedTextureSubs=[],this.ambient=a.ambient,this.diffuse=a.diffuse,this.specular=a.specular,this.emissive=a.emissive,this.opacity=a.opacity,this.shininess=a.shininess,this.reflectivity=a.reflectivity,this.bumpMap=a.bumpMap,this.diffuseMap=a.diffuseMap,this.specularMap=a.specularMap,this.emissiveMap=a.emissiveMap,this.opacityMap=a.opacityMap,this.reflectivityMap=a.reflectivityMap},_props:{ambient:{set:function(a){a=a||[1,1,1],this._state.ambient=a,this._renderer.imageDirty=!0,this.fire("ambient",a)},get:function(){return this._state.ambient}},diffuse:{set:function(a){a=a||[1,1,1],this._state.diffuse=a,this._renderer.imageDirty=!0,this.fire("diffuse",a)},get:function(){return this._state.diffuse}},specular:{set:function(a){a=a||[.3,.3,.3],this._state.specular=a,this._renderer.imageDirty=!0,this.fire("specular",a)},get:function(){return this._state.specular}},emissive:{set:function(a){a=a||[1,1,1],this._state.emissive=a,this._renderer.imageDirty=!0,this.fire("emissive",a)},get:function(){return this._state.emissive
}},opacity:{set:function(a){a=void 0!==a?a:1,this._state.opacity=a,this._renderer.imageDirty=!0,this.fire("opacity",a)},get:function(){return this._state.opacity}},shininess:{set:function(a){a=void 0!==a?a:30,this._state.shininess=a,this._renderer.imageDirty=!0,this.fire("shininess",a)},get:function(){return this._state.shininess}},reflectivity:{set:function(a){a=void 0!==a?a:1,this._state.reflectivity=a,this._renderer.imageDirty=!0,this.fire("reflectivity",a)},get:function(){return this._state.reflectivity}},diffuseMap:{set:function(a){this._attachTexture("diffuseMap",a)},get:function(){return this._textures.diffuseMap}},specularMap:{set:function(a){this._attachTexture("specularMap",a)},get:function(){return this._textures.specularMap}},emissiveMap:{set:function(a){this._attachTexture("emissiveMap",a)},get:function(){return this._textures.emissiveMap}},opacityMap:{set:function(a){this._attachTexture("opacityMap",a)},get:function(){return this._textures.opacityMap}},reflectivityMap:{set:function(a){this._attachTexture("reflectivityMap",a)},get:function(){return this._textures.reflectivityMap}}},_attachTexture:function(a,b){if(XEO._isString(b)){var c=b;if(b=this.scene.components[c],!b)return void this.error("Component with this ID not found: '"+c+"'")}if(b&&"texture"!==b.type)return void this.error("Component with this ID is not a texture: '"+c+"'");var d=this._textures[a];d&&(d.off(this._dirtyTextureSubs[a]),d.off(this._destroyedTextureSubs[a]),delete this._textures[a]);var e=this;b&&(this._dirtyTextureSubs[a]=b.on("dirty",function(){e.fire("dirty",!0)}),this._destroyedTextureSubs[a]=b.on("destroyed",function(){delete e._dirtyTextureSubs[a],delete e._destroyedTextureSubs[a],e.fire("dirty",!0),e.fire(a,null)}),this._textures[a]=b),this.fire(a,b||null)},_compile:function(){this._renderer.material=this._state;for(var a=[],b=0,c=this._textures.length;c>b;b++)a.push(this._textures[b]._state);var d={type:"texture",bumpMap:this.bumpMap?this.bumpMap._state:null,diffuseMap:this.diffuseMap?this.diffuseMap._state:null,specularMap:this.specularMap?this.specularMap._state:null,emissiveMap:this.emissiveMap?this.emissiveMap._state:null,opacityMap:this.opacityMap?this.opacityMap._state:null,reflectivityMap:this.reflectivityMap?this.reflectivityMap._state:null,hash:this._makeTexturesHash()};this._renderer.texture=d},_makeTexturesHash:function(){var a=[];return this.bumpMap&&(a.push("/b"),this.bumpMap.matrix&&a.push("/anim")),this.diffuseMap&&(a.push("/d"),this.bumpMap.matrix&&a.push("/anim")),this.specularMap&&(a.push("/s"),this.bumpMap.matrix&&a.push("/anim")),this.emissiveMap&&(a.push("/e"),this.bumpMap.matrix&&a.push("/anim")),this.opacityMap&&(a.push("/o"),this.bumpMap.matrix&&a.push("/anim")),this.reflectivityMap&&(a.push("/r"),this.bumpMap.matrix&&a.push("/anim")),a.join("")},_getJSON:function(){var a={ambient:this.ambient,diffuse:this.diffuse,specular:this.specular,emissive:this.emissive,opacity:this.opacity,shininess:this.shininess,reflectivity:this.reflectivity};return this.bumpMap&&(a.bumpMap=this.bumpMap.id),this.diffuseMap&&(a.diffuseMap=this.diffuseMap.id),this.specularMap&&(a.specularMap=this.specularMap.id),this.emissiveMap&&(a.emissiveMap=this.emissiveMap.id),this.opacityMap&&(a.opacityMap=this.opacityMap.id),this.reflectivityMap&&(a.reflectivityMap=this.reflectivityMap.id),a}})}(),function(){"use strict";XEO.MorphTargets=XEO.Component.extend({className:"XEO.MorphTargets",type:"MorphTargets",_init:function(){this.scene.on("webglContextRestored",function(){})},_props:{targets:{set:function(){},get:function(){}},factor:{set:function(){},get:function(){return this._state.factor}},_compile:function(){this._renderer.MorphTargets=this._state}},_getJSON:function(){return{targets:this.targets,factor:this.factor}}})}(),function(){"use strict";XEO.GameObject=XEO.Component.extend({className:"XEO.GameObject",type:"object",_init:function(a){this.camera=a.camera,this.clips=a.clips,this.colorTarget=a.colorTarget,this.colorBuf=a.colorBuf,this.depthTarget=a.depthTarget,this.depthBuf=a.depthBuf,this.visibility=a.visibility,this.modes=a.modes,this.geometry=a.geometry,this.layer=a.layer,this.lights=a.lights,this.material=a.material,this.morphTargets=a.morphTargets,this.reflect=a.reflect,this.shader=a.shader,this.shaderParams=a.shaderParams,this.stage=a.stage,this.transform=a.transform},_props:{camera:{set:function(a){this._setChild("camera",a)},get:function(){return this._children.camera}},clips:{set:function(a){this._setChild("clips",a)},get:function(){return this._children.clips}},colorTarget:{set:function(a){this._setChild("colorTarget",a)},get:function(){return this._children.colorTarget}},colorBuf:{set:function(a){this._setChild("colorBuf",a)},get:function(){return this._children.colorBuf}},depthTarget:{set:function(a){this._setChild("depthTarget",a)},get:function(){return this._children.depthTarget}},depthBuf:{set:function(a){this._setChild("depthBuf",a)},get:function(){return this._children.depthBuf}},visibility:{set:function(a){this._setChild("visibility",a)},get:function(){return this._children.visibility}},modes:{set:function(a){this._setChild("modes",a)},get:function(){return this._children.modes}},geometry:{set:function(a){this._setChild("geometry",a)},get:function(){return this._children.geometry}},layer:{set:function(a){this._setChild("layer",a)},get:function(){return this._children.layer}},lights:{set:function(a){this._setChild("lights",a)},get:function(){return this._children.lights}},material:{set:function(a){this._setChild("material",a)},get:function(){return this._children.material}},morphTargets:{set:function(a){this._setChild("morphTargets",a)},get:function(){return this._children.morphTargets}},reflect:{set:function(a){this._setChild("reflect",a)},get:function(){return this._children.reflect}},shader:{set:function(a){this._setChild("shader",a)},get:function(){return this._children.shader}},shaderParams:{set:function(a){this._setChild("shaderParams",a)},get:function(){return this._children.shaderParams}},stage:{set:function(a){this._setChild("stage",a)},get:function(){return this._children.stage}},transform:{set:function(a){this._setChild("transform",a)},get:function(){return this._children.transform}}},_compile:function(){var a=this._children;a.camera._compile(),a.clips._compile(),a.colorTarget._compile(),a.colorBuf._compile(),a.depthTarget._compile(),a.depthBuf._compile(),a.visibility._compile(),a.modes._compile(),a.geometry._compile(),a.layer._compile(),a.lights._compile(),a.material._compile(),a.morphTargets._compile(),a.reflect._compile(),a.shader._compile(),a.shaderParams._compile(),a.stage._compile(),a.transform._compile(),this._renderer.buildGameObject(this.id)},_getJSON:function(){return{camera:this.camera.id,clips:this.clips.id,colorTarget:this.colorTarget.id,colorBuf:this.colorBuf.id,depthTarget:this.depthTarget.id,depthBuf:this.depthBuf.id,visibility:this.visibility.id,modes:this.modes.id,geometry:this.geometry.id,layer:this.layer.id,lights:this.lights.id,material:this.material.id,morphTargets:this.morphTargets.id,reflect:this.reflect.id,shader:this.shader.id,shaderParams:this.shaderParams.id,stage:this.stage.id,transform:this.transform.id}},_destroy:function(){this._renderer.removeGameObject(this.id)}})}(),function(){"use strict";XEO.Ortho=XEO.Component.extend({className:"XEO.Ortho",type:"project",_init:function(a){this.mode="ortho",this.left=a.left,this.right=a.right,this.top=a.top,this.bottom=a.bottom,this.near=a.near,this.far=a.far;var b=this;this._onTick=this.scene.on("tick",function(){b._dirty&&b._rebuild()})},_rebuild:function(){var a=this._state;a.matrix=XEO.math.orthoMat4c(a.left,a.right,a.bottom,a.top,a.near,a.far,[]),a.mat?a.mat.set(a.matrix):a.mat=new Float32Array(a.matrix),this.fire("matrix",a.matrix),this._dirty=!1},_props:{left:{set:function(a){a=a||-1,this._state.left=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("left",a)},get:function(){return this._state.left}},right:{set:function(a){a=a||1,this._state.right=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("right",a)},get:function(){return this._state.right}},top:{set:function(a){a=a||1,this._state.top=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("top",a)},get:function(){return this._state.top}},bottom:{set:function(a){a=a||-1,this._state.bottom=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("bottom",a)},get:function(){return this._state.bottom}},near:{set:function(a){a=a||.1,this._state.near=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("near",a)},get:function(){return this._state.near}},far:{set:function(a){a=a||1e4,this._state.far=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("far",a)},get:function(){return this._state.far}},matrix:{get:function(){return this._dirty&&this._state.rebuild(),this._state.matrix.slice(0)}}},_compile:function(){this._renderer.cameraMat=this._state},_getJSON:function(){return{left:this.left,right:this.right,top:this.top,bottom:this.bottom,near:this.near,far:this.far}},_destroy:function(){this.scene.off(this._onTick)}})}(),function(){"use strict";XEO.Perspective=XEO.Component.extend({className:"XEO.Perspective",type:"project",_init:function(a){this.mode="perspective";var b=this.scene.canvas;this.fovy=a.fovy,this.aspect=b.width/b.height,this.near=a.near,this.far=a.far;var c=this;this._canvasResized=this.scene.canvas.on("resized",function(){c.aspect=b.width/b.height}),this._tick=this.scene.on("tick",function(){c._dirty&&c._rebuild()})},_rebuild:function(){var a=this._state;a.matrix=XEO.math.perspectiveMatrix4(a.fovy*Math.PI/180,a.aspect,a.near,a.far),a.mat?a.mat.set(a.matrix):a.mat=new Float32Array(a.matrix),this.fire("matrix",a.matrix),this._dirty=!1},_props:{fovy:{set:function(a){a=a||60,this._state.fovy=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("fovy",a)},get:function(){return this._state.fovy}},aspect:{set:function(a){a=a||1,this._state.aspect=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("aspect",a)},get:function(){return this._state.aspect}},near:{set:function(a){a=a||.1,this._state.near=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("near",a)},get:function(){return this._state.near}},far:{set:function(a){a=a||1e4,this._state.far=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("far",a)},get:function(){return this._state.far}},matrix:{get:function(){return this._dirty&&this._state.rebuild(),this._state.matrix.slice(0)}}},_compile:function(){this._renderer.cameraMat=this._state},_getJSON:function(){return{fovy:this.fovy,aspect:this.aspect,near:this.near,far:this.far}},_destroy:function(){this.scene.canvas.off(this._canvasResized),this.scene.off(this._tick)}})}(),function(){"use strict";XEO.PointLight=XEO.Component.extend({className:"XEO.PointLight",type:"light",_init:function(a){this.mode="point",this._state.mode=this.mode,this.pos=a.pos,this.diffuse=a.diffuse,this.specular=a.specular,this.constantAttenuation=a.constantAttenuation,this.linearAttenuation=a.linearAttenuation,this.quadraticAttenuation=a.quadraticAttenuation,this.space=a.space},_props:{pos:{set:function(a){a=a||[1,1,1],this._state.pos=a,this._renderer.imageDirty=!0,this.fire("pos",a)},get:function(){return this._state.pos}},diffuse:{set:function(a){a=a||[.7,.7,.8],this._state.diffuse=a,this._renderer.imageDirty=!0,this.fire("diffuse",a)},get:function(){return this._state.diffuse}},specular:{set:function(a){a=a||[.7,.7,.8],this._state.specular=a,this._renderer.imageDirty=!0,this.fire("specular",a)},get:function(){return this._state.specular}},constantAttenuation:{set:function(a){a=a||0,this._state.constantAttenuation=a,this._renderer.imageDirty=!0,this.fire("constantAttenuation",a)},get:function(){return this._state.constantAttenuation}},linearAttenuation:{set:function(a){a=a||0,this._state.linearAttenuation=a,this._renderer.imageDirty=!0,this.fire("linearAttenuation",a)},get:function(){return this._state.linearAttenuation}},quadraticAttenuation:{set:function(a){a=a||0,this._state.quadraticAttenuation=a,this._renderer.imageDirty=!0,this.fire("quadraticAttenuation",a)},get:function(){return this._state.quadraticAttenuation}},space:{set:function(a){a=a||"view",a!==this._state.space&&(this._state.space=a,this.fire("dirty",!0),this.fire("space",a))},get:function(){return this._state.space}}},_getJSON:function(){return{mode:this.mode,pos:this.pos,diffuse:this.diffuse,specular:this.specular,constantAttenuation:this.constantAttenuation,linearAttenuation:this.linearAttenuation,quadraticAttenuation:this.quadraticAttenuation,space:this.space}}})}(),function(){"use strict";XEO.Reflect=XEO.Component.extend({className:"XEO.Reflect",type:"reflect",_init:function(){},_compile:function(){this._renderer.reflect=this._state},_getJSON:function(){return{}}})}(),function(){"use strict";XEO.Scene=XEO.Component.extend({className:"XEO.Scene",type:"scene",_init:function(a){this._componentIDMap=new XEO.utils.Map,this.components={},this._dirtyGameObjects={},this.configs=new XEO.Configs(this,a.configs),this.canvas=new XEO.Canvas(this,{canvas:a.canvas,contextAttr:a.contextAttr||{}}),this.canvas.on("webglContextFailed",function(){alert("XeoEngine failed to find WebGL")}),this._renderer=new XEO.renderer.Renderer({canvas:this.canvas,transparent:a.transparent}),this.input=new XEO.Input(this,{canvas:this.canvas.canvas}),this.tasks=new XEO.Tasks(this),this.stats=new XEO.Stats(this,{objects:0,geometries:0,textures:0}),XEO._addScene(this);var b=a.components;if(b)for(var c,d,e,f=0,g=b.length;g>f;f++)c=b[f],d=c.className,d&&(e=window[d],e&&new e(this,c));this.view,this.project,this.camera,this.clips,this.colorTarget,this.colorBuf,this.depthTarget,this.depthBuf,this.visibility,this.modes,this.geometry,this.layer,this.lights,this.material,this.morphTargets,this.reflect,this.shader,this.shaderParams,this.stage,this.transform},_addComponent:function(a){if(a.id){if(this.components[a.id])return void this.error("A component with this ID already exists in this Scene: "+a.id)}else a.id=this._componentIDMap.addItem({});this.components[a.id]=a;var b="object"===a.type,c=this;a.on("destroyed",function(){c._componentIDMap.removeItem(a.id),delete c.components[a.id],b&&(c.stats.dec("objects"),delete c._dirtyGameObjects[a.id],c.fire("dirty",!0)),c.fire("componentDestroyed",a,!0)}),b&&(this.stats.inc("objects"),a.on("dirty",function(){c._dirtyGameObjects[a.id]||(c._dirtyGameObjects[a.id]=object),c.fire("dirty",!0)})),this.fire("componentCreated",a,!0)},_props:{project:{get:function(){return this.components["default.project"]||new XEO.Perspective(this,{id:"default.project"})}},view:{get:function(){return this.components["default.view"]||new XEO.Lookat(this,{id:"default.view"})}},camera:{get:function(){return this.components["default.camera"]||new XEO.Camera(this,{id:"default.camera",project:"default.project",view:"default.view"})}},transform:{get:function(){return this.components["default.transform"]||new XEO.Matrix(this,{id:"default.transform"})}},clips:{get:function(){return this.components["default.clips"]||new XEO.Clips(this,{id:"default.clips"})}},colorBuf:{get:function(){return this.components["default.colorBuf"]||new XEO.ColorBuf(this,{id:"default.colorBuf"})}},colorTarget:{get:function(){return this.components["default.colorTarget"]||new XEO.ColorTarget(this,{id:"default.colorTarget"})}},depthBuf:{get:function(){return this.components["default.depthBuf"]||new XEO.DepthBuf(this,{id:"default.depthBuf"})}},depthTarget:{get:function(){return this.components["default.depthTarget"]||new XEO.DepthTarget(this,{id:"default.depthTarget"})}},visibility:{get:function(){return this.components["default.visibility"]||new XEO.Visibility(this,{id:"default.visibility",enabled:!0})}},modes:{get:function(){return this.components["default.modes"]||new XEO.Modes(this,{id:"default.modes"})}},geometry:{get:function(){return this.components["default.geometry"]||new XEO.Geometry(this,{id:"default.geometry"})}},layer:{get:function(){return this.components["default.layer"]||new XEO.Layer(this,{id:"default.layer",priority:0})}},lights:{get:function(){return this.components["default.lights"]||new XEO.Lights(this,{id:"default.lights",lights:[new XEO.AmbientLight(this,{id:"default.light0",color:[.7,.7,.7]}),new XEO.DirLight(this,{id:"default.light1",dir:[-.5,-.5,-1],color:[1,1,1],specular:!0,diffuse:!0,space:"view"}),new XEO.DirLight(this,{id:"default.light2",dir:[1,-.9,-.7],color:[1,1,1],specular:!0,diffuse:!0,space:"view"})]})}},material:{get:function(){return this.components["default.material"]||new XEO.Material(this,{id:"default.material"})}},morphTargets:{get:function(){return this.components["default.morphTargets"]||new XEO.MorphTargets(this,{id:"default.morphTargets"})}},reflect:{get:function(){return this.components["default.reflect"]||new XEO.Reflect(this,{id:"default.reflect"})}},shader:{get:function(){return this.components["default.shader"]||this.components["default.shader"]||new XEO.Shader(this,{id:"default.shader"})}},shaderParams:{get:function(){return this.components["default.shaderParams"]||new XEO.ShaderParams(this,{id:"default.shaderParams"})}},stage:{get:function(){return this.components["default.stage"]||new XEO.Stage(this,{id:"default.stage",priority:0})}},clear:function(){var a;for(var b in this.components)this.components.hasOwnProperty(b)&&(a=this.components[b],!a.id!==this.id&&a.destroy());this._dirtyGameObjects={}},_compile:function(){for(var a in this._dirtyGameObjects)this._dirtyGameObjects.hasOwnProperty(a)&&this._dirtyGameObjects[i]._compile();this._dirtyGameObjects={},this._renderer.render({clear:0===i})},_getJSON:function(){var a=[];for(var b in this.components)this.components.hasOwnProperty(b)&&a.push(this.components[b]);a.sort(function(a,b){return a._componentOrder-b._componentOrder});for(var c=[],d=0,e=a.length;e>d;d++)c.push(a[d].json);return{components:c}},_destroy:function(){this.clear()}}})}(),function(){"use strict";XEO.Shader=XEO.Component.extend({className:"XEO.Shader",type:"shader",_init:function(a){this._state.shaders={},this.vertex=a.vertex,this.fragment=a.fragment,this.setParams(a.params)},_props:{vertex:{set:function(a){this._state.shaders.vertex=a,this.fire("dirty",!0),this.fire("vertex",a)},get:function(){return this._state.shaders.vertex}},fragment:{set:function(a){this._state.shaders.fragment=a,this.fire("dirty",!0),this.fire("fragment",a)},get:function(){return this._state.shaders.fragment}},params:{get:function(){return this._state.params}}},setParams:function(a){this._state.params=this._state.params||{};for(var b in a)a.hasOwnProperty(b)&&(this._state.params[b]=a[b]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shader=this._state},_getJSON:function(){return{vertex:this.vertex,fragment:this.fragment,params:this.params}}})}(),function(){"use strict";XEO.ShaderParams=XEO.Component.extend({className:"XEO.ShaderParams",type:"shaderParams",_init:function(a){this.setParams(a.params)},_props:{params:{get:function(){return this._state.params}}},setParams:function(a){this._state.params=this._state.params||{};for(var b in a)a.hasOwnProperty(b)&&(this._state.params[b]=a[b]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shader=this._state},_getJSON:function(){return{params:this.params}}})}(),function(){"use strict";XEO.Stage=XEO.Component.extend({className:"XEO.Stage",type:"stage",_init:function(a){this.priority=a.priority,this.pickable=a.pickable},_props:{priority:{set:function(a){a=a||0,this._state.priority=a,this._renderer.stateOrderDirty=!0,this.fire("priority",a)},get:function(){return this._state.priority}},pickable:{set:function(a){a=a!==!1,this._state.pickable=a,this._renderer.drawListDirty=!0,this.fire("pickable",a)},get:function(){return this._state.pickable}}},_compile:function(){this._renderer.stage=this._state},_getJSON:function(){return{priority:this.priority,pickable:this.pickable}}})}(),function(){"use strict";XEO.Stats=XEO.Component.extend({className:"XEO.Stats",type:"stats",_init:function(a){for(var b in a)a.hasOwnProperty(b)&&this.fire(b,a[b])},clear:function(){},inc:function(a){this.fire(a,(this.props[a]||0)+1)},dec:function(a){this.fir(a,(this.props[a]||0)-1)},zero:function(a){this.fire(a,0)},_toJSON:function(){return XEO._copy(this.props)}})}(),function(){"use strict";XEO.Task=XEO.Component.extend({_init:function(a){this.id=a.id,this.description=a.description||"",this.failed=!1,this.completed=!1},setCompleted:function(){this.fire("completed",this.completed=!0)},setFailed:function(){this.fire("failed",this.failed=!0)},_destroy:function(){!this.completed&&this.destroyed&&this.setCompleted()}})}(),function(){"use strict";XEO.Tasks=XEO.Component.extend({_init:function(){this._idMap=new XEO.utils.Map,this.tasks={}},create:function(a){if(a=a||{},a.id){if(this.tasks[a.id])return this.error("A task with this ID already exists: "+a.id),null}else a.id=this._idMap.addItem({});var b=this.tasks[a.id]=new XEO.Tasks.Task(this,a),c=this;return b.on("completed",function(){delete c.tasks[b.id],c._idMap.removeItem(b.id),c.fire("completed",b,!0)}),b.on("failed",function(){delete c.tasks[b.id],c._idMap.removeItem(b.id),c.fire("failed",b,!0)}),c.fire("started",b,!0),b},setCompleted:function(a){var b=this.tasks[a];return b?void b.fire("completed",b,!0):void this.error("Task not found:"+a)},setFailed:function(a){var b=this.tasks[a];return b?void b.fire("failed",b,!0):void this.error("Task not found:"+a)},clear:function(){for(var a in this.tasks)this.tasks.hasOwnProperty(a)&&this.tasks[a].setCompleted()}})}(),function(){"use strict";XEO.Texture=XEO.Component.extend({className:"XEO.Texture",type:"texture",_init:function(a){this._srcDirty=!1,this._textureDirty=!1,this.minFilter=a.minFilter,this.magFilter=a.magFilter,this.wrapS=a.wrapS,this.wrapT=a.wrapT,this.isDepth=a.isDepth,this.depthMode=a.depthMode,this.depthCompareMode=a.depthCompareMode,this.depthCompareFunc=a.depthCompareFunc,this.flipY=a.flipY,this.width=a.width,this.height=a.height,this.internalFormat=a.internalFormat,this.sourceFormat=a.sourceFormat,this.sourceType=a.sourceType,this.translate=a.translate,this.scale=a.scale,this.rotate=a.rotate,a.src?this.src=a.src:a.target&&(this.target=a.target);var b=this._state;b.waitForLoad=a.waitForLoad!==!1,b.texture=null,b.matrix=null,b._matrixDirty=!0,b._textureDirty=!0,b.buildMatrix=function(){self._buildMatrix(b)},b.buildMatrix.call(b),a.src?(this._state.src=a.src,this._loadTexture(a.src)):a.image?(this._state.image=a.image,this._initTexture(a.image)):a.target&&this.scene.getComponent(a.target,function(a){self.setTarget(a)}),this._webglContextRestored=this.scene.canvas.on("webglContextRestored",function(){self._state.src?self._loadTexture(self._state.src):self._state.image?self._initTexture(self._state.image):self._state.target}),this.scene.stats.inc("textures")},_psops:{src:{set function(a){this._state.image=null,this._state.src=a,this._state.target=null;var b=this;this.scene.once("tick",function(){b._loadTexture(b._state.src)}),this._srcDirty=!0,this.fire("src",a)},get function(){return this._state.src}},target:{set function(a){this._setChild("renderBuf",a),this._state.image=null,this._state.src=null,this._state.target=null,this._targetDirty=!0,this._setDirty(),this.fire("target",a)},get function(){return this._children.renderBuf}},translate:{set function(a){a=a||[0,0,0],this._state.translate=a,this._state._matrixDirty=!0,this.fire("translate",a)},get:function(){return this._state.translate}},scale:{set:function(a){a=a||[1,1,1],this._state.scale=a,this._state._matrixDirty=!0,this.fire("scale",a)},get:function(){return this._state.scale}},rotate:{set:function(a){a=a||0,this._state.rotate=a,this._state._matrixDirty=!0,this.fire("rotate",a)},get:function(){return this._state.rotate}},minFilter:{set:function(a){a=a||"linearMipMapNearest",this._state.minFilter=a,this.fire("minFilter",a)},get:function(){return this._state.minFilter}},magFilter:{set:function(a){a=a||"linear",this._state.magFilter=a,this.fire("magFilter",a)},get:function(){return this._state.magFilter}},wrapS:{set:function(a){a=a||"repeat",this._state.wrapS=a,this.fire("wrapS",a)},get:function(){return this._state.wrapS}},wrapT:{set:function(a){a=a||"repeat",this._state.wrapT=a,this.fire("wrapT",a)},get:function(){return this._state.wrapT}},isDepth:{set:function(a){a=a===!0,this._state.isDepth=a,this.fire("isDepth",a)},get:function(){return this._state.isDepth}},depthMode:{set:function(a){a=a||"luminance",this._state.depthMode=a,this.fire("depthMode",a)},get:function(){return this._state.depthMode}},depthCompareMode:{set:function(a){a=a||"compareRToTexture",this._state.depthCompareMode=a,this.fire("depthCompareMode",a)},get:function(){return this._state.depthCompareMode}},depthCompareFunc:{set:function(a){a=a||"lequal",this._state.depthCompareFunc=a,this.fire("depthCompareFunc",a)},get:function(){return this._state.depthCompareFunc}},flipY:{set:function(a){a=a!==!1,this._state.flipY=a,this.fire("flipY",a)},get:function(){return this._state.flipY}},width:{set:function(a){a=void 0!==a?a:1,this._state.width=a,this.fire("width",a)},get:function(){return this._state.width}},height:{set:function(a){a=void 0!==a?a:1,this._state.height=a,this.fire("height",a)},get:function(){return this._state.height}},internalFormat:{set:function(a){a=a||"alpha",this._state.internalFormat=a,this.fire("internalFormat",a)},get:function(){return this._state.internalFormat}},sourceFormat:{set:function(a){a=a||"alpha",this._state.sourceFormat=a,this.fire("sourceFormat",a)},get:function(){return this._state.sourceFormat}},sourceType:{set:function(a){a=a||"unsignedByte",this._state.sourceType=a,this.fire("sourceType",a)},get:function(){return this._state.sourceType}},image:{set:function(a){this.fire("image",a)},get:function(){}}},_buildMatrix:function(){var a,b;(0!==this.translate.x||0!==this.translate.y)&&(a=XEO.math.translationMat4v([this.translate.x||0,this.translate.y||0,0])),(1!==this.scale.x||1!==this.scale.y)&&(b=XEO.math.scalingMat4v([this.scale.x||1,this.scale.y||1,1]),a=a?XEO.math.mulMat4(a,b):b),0!==this.rotate&&(b=XEO.math.rotationMat4v(.0174532925*this.rotate,[0,0,1]),a=a?XEO.math.mulMat4(a,b):b),a&&(this.matrix=a,this.matrixAsArray?this.matrixAsArray.set(this.matrix):this.matrixAsArray=new Float32Array(this.matrix)),this._matrixDirty=!1},_loadTexture:function(a){var b=this,c=this.scene.tasks.create({description:"Loading texture"}),d=new Image;d.onload=function(){b._initTexture(d),c.setCompleted()},d.onerror=function(){c.setFailed()},0===a.indexOf("data")?d.src=a:(d.crossOrigin="Anonymous",d.src=a)},_initTexture:function(a){var b=!!this._state.texture,c=this.scene.canvas.gl,d=b?this._state.texture.texture:c.createTexture();c.bindTexture(c.TEXTURE_2D,d),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,this._ensureImageSizePowerOfTwo(a)),b||(this._state.texture=new XEO.webgl.Texture2D(c,{texture:d,minFilter:this._getGLOption("minFilter",c.LINEAR_MIPMAP_NEAREST),magFilter:this._getGLOption("magFilter",c.LINEAR),wrapS:this._getGLOption("wrapS",c.REPEAT),wrapT:this._getGLOption("wrapT",c.REPEAT),isDepth:this._getOption(this._state.isDepth,!1),depthMode:this._getGLOption("depthMode",c.LUMINANCE),depthCompareMode:this._getGLOption("depthCompareMode",c.COMPARE_R_TO_TEXTURE),depthCompareFunc:this._getGLOption("depthCompareFunc",c.LEQUAL),flipY:this._getOption(this._state.flipY,!0),width:this._getOption(this._state.width,1),height:this._getOption(this._state.height,1),internalFormat:this._getGLOption("internalFormat",c.LEQUAL),sourceFormat:this._getGLOption("sourceType",c.ALPHA),sourceType:this._getGLOption("sourceType",c.UNSIGNED_BYTE),update:null}),this.destroyed&&this._state.texture.destroy()),this._renderer.imageDirty=!0},_ensureImageSizePowerOfTwo:function(a){if(!this._isPowerOfTwo(a.width)||!this._isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=this._nextHighestPowerOfTwo(a.width),b.height=this._nextHighestPowerOfTwo(a.height);var c=b.getContext("2d");c.drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b,a.crossOrigin=""}return a},_isPowerOfTwo:function(a){return 0===(a&a-1)},_nextHighestPowerOfTwo:function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},_getGLOption:function(a,b){var c=this.scene.canvas.gl,d=this._state[a];if(void 0===d)return b;var e=XEO.webgl.enums[d];if(void 0===e)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_COMPONENT_CONFIG,"Unrecognised value for texture component property '"+a+"' value: '"+d+"'");return c[e]},_getOption:function(a,b){return void 0===a?b:a},_getJSON:function(){var a={translate:this.translate,scale:this.scale,rotate:this.rotate,minFilter:this.minFilter,magFilter:this.magFilter,wrapS:this.wrapS,wrapT:this.wrapT,isDepth:this.isDepth,depthMode:this.depthMode,depthCompareMode:this.depthCompareMode,depthCompareFunc:this.depthCompareFunc,flipY:this.flipY,width:this.width,height:this.height,internalFormat:this.internalFormat,sourceFormat:this.sourceFormat,sourceType:this.sourceType};return this.src?a.src=this.src:this.target&&(a.target=this.target.id),a},_destroy:function(){this.scene.off(this._tick),this.scene.canvas.off(this._webglContextRestored),this.scene.stats.dec("textures")}})}(),function(){"use strict";XEO.math={createUUID:function(){var a,b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c=new Array(36),d=0;return function(){for(var e=0;36>e;e++)8===e||13===e||18===e||23===e?c[e]="-":14===e?c[e]="4":(2>=d&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19===e?3&a|8:a]);return c.join("")}}(),fmod:function(a,b){if(b>a)return console.error("XEO.math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),a;for(;a>=b;)a-=b;return a},negateVec4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b},addVec4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c},addVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c},addVec3:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c},addVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c},subVec4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c},subVec3:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c},subVec2:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c},subVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c},subScalarVec4:function(a,b,c){return c||(c=a),c[0]=b-a[0],c[1]=b-a[1],c[2]=b-a[2],c[3]=b-a[3],c},mulVec4:function(a,b,c){return c||(c=a),c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3],c},mulVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c},mulVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c},mulVec2Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c},divVec3:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c},divVec4:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c[3]=a[3]/b[3],c},divScalarVec3:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c},divVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c},divVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c[3]=a[3]/b,c},divScalarVec4:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c[3]=a/b[3],c},dotVec4:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},cross3Vec4:function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2];return[d*h-e*g,e*f-c*h,c*g-d*f,0]},cross3Vec3:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=b[0],h=b[1],i=b[2];return c[0]=e*i-f*h,c[1]=f*g-d*i,c[2]=d*h-e*g,c},sqLenVec4:function(a){return XEO.math.dotVec4(a,a)},lenVec4:function(a){return Math.sqrt(XEO.math.sqLenVec4(a))
},dotVec3:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},dotVec2:function(a,b){return a[0]*b[0]+a[1]*b[1]},sqLenVec3:function(a){return XEO.math.dotVec3(a,a)},sqLenVec2:function(a){return XEO.math.dotVec2(a,a)},lenVec3:function(a){return Math.sqrt(XEO.math.sqLenVec3(a))},lenVec2:function(a){return Math.sqrt(XEO.math.sqLenVec2(a))},rcpVec3:function(a,b){return XEO.math.divScalarVec3(1,a,b)},normalizeVec4:function(a,b){var c=1/XEO.math.lenVec4(a);return XEO.math.mulVec4Scalar(a,c,b)},normalizeVec3:function(a,b){var c=1/XEO.math.lenVec3(a);return XEO.math.mulVec3Scalar(a,c,b)},normalizeVec2:function(a,b){var c=1/XEO.math.lenVec2(a);return XEO.math.mulVec2Scalar(a,c,b)},mat4:function(){return new Array(16)},dupMat4:function(a){return a.slice(0,16)},mat4To3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},m4s:function(a){return[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a]},setMat4ToZeroes:function(){return XEO.math.m4s(0)},setMat4ToOnes:function(){return XEO.math.m4s(1)},diagonalMat4v:function(a){return[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,a[3]]},diagonalMat4c:function(a,b,c,d){return XEO.math.diagonalMat4v([a,b,c,d])},diagonalMat4s:function(a){return XEO.math.diagonalMat4c(a,a,a,a)},identityMat4:function(){return XEO.math.diagonalMat4v([1,1,1,1])},isIdentityMat4:function(a){return 1!==a[0]||0!==a[1]||0!==a[2]||0!==a[3]||0!==a[4]||1!==a[5]||0!==a[6]||0!==a[7]||0!==a[8]||0!==a[9]||1!==a[10]||0!==a[11]||0!==a[12]||0!==a[13]||0!==a[14]||1!==a[15]?!1:!0},negateMat4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b[4]=-a[4],b[5]=-a[5],b[6]=-a[6],b[7]=-a[7],b[8]=-a[8],b[9]=-a[9],b[10]=-a[10],b[11]=-a[11],b[12]=-a[12],b[13]=-a[13],b[14]=-a[14],b[15]=-a[15],b},addMat4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c[4]=a[4]+b[4],c[5]=a[5]+b[5],c[6]=a[6]+b[6],c[7]=a[7]+b[7],c[8]=a[8]+b[8],c[9]=a[9]+b[9],c[10]=a[10]+b[10],c[11]=a[11]+b[11],c[12]=a[12]+b[12],c[13]=a[13]+b[13],c[14]=a[14]+b[14],c[15]=a[15]+b[15],c},addMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c[4]=a[4]+b,c[5]=a[5]+b,c[6]=a[6]+b,c[7]=a[7]+b,c[8]=a[8]+b,c[9]=a[9]+b,c[10]=a[10]+b,c[11]=a[11]+b,c[12]=a[12]+b,c[13]=a[13]+b,c[14]=a[14]+b,c[15]=a[15]+b,c},addScalarMat4:function(a,b,c){return XEO.math.addMat4Scalar(b,a,c)},subMat4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c[4]=a[4]-b[4],c[5]=a[5]-b[5],c[6]=a[6]-b[6],c[7]=a[7]-b[7],c[8]=a[8]-b[8],c[9]=a[9]-b[9],c[10]=a[10]-b[10],c[11]=a[11]-b[11],c[12]=a[12]-b[12],c[13]=a[13]-b[13],c[14]=a[14]-b[14],c[15]=a[15]-b[15],c},subMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c[4]=a[4]-b,c[5]=a[5]-b,c[6]=a[6]-b,c[7]=a[7]-b,c[8]=a[8]-b,c[9]=a[9]-b,c[10]=a[10]-b,c[11]=a[11]-b,c[12]=a[12]-b,c[13]=a[13]-b,c[14]=a[14]-b,c[15]=a[15]-b,c},subScalarMat4:function(a,b,c){return c||(c=b),c[0]=a-b[0],c[1]=a-b[1],c[2]=a-b[2],c[3]=a-b[3],c[4]=a-b[4],c[5]=a-b[5],c[6]=a-b[6],c[7]=a-b[7],c[8]=a-b[8],c[9]=a-b[9],c[10]=a-b[10],c[11]=a-b[11],c[12]=a-b[12],c[13]=a-b[13],c[14]=a-b[14],c[15]=a-b[15],c},mulMat4:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];return c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s,c},mulMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c[4]=a[4]*b,c[5]=a[5]*b,c[6]=a[6]*b,c[7]=a[7]*b,c[8]=a[8]*b,c[9]=a[9]*b,c[10]=a[10]*b,c[11]=a[11]*b,c[12]=a[12]*b,c[13]=a[13]*b,c[14]=a[14]*b,c[15]=a[15]*b,c},mulMat4v4:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},transposeMat4:function(a,b){var c=a[4],d=a[14],e=a[8],f=a[13],g=a[12],h=a[9];if(!b||a===b){var i=a[1],j=a[2],k=a[3],l=a[6],m=a[7],n=a[11];return a[1]=c,a[2]=e,a[3]=g,a[4]=i,a[6]=h,a[7]=f,a[8]=j,a[9]=l,a[11]=d,a[12]=k,a[13]=m,a[14]=n,a}return b[0]=a[0],b[1]=c,b[2]=e,b[3]=g,b[4]=a[1],b[5]=a[5],b[6]=h,b[7]=f,b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=d,b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},determinantMat4:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},inverseMat4:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=1/(s*D-t*C+u*B+v*A-w*z+x*y);return b[0]=(h*D-i*C+j*B)*E,b[1]=(-d*D+e*C-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(-l*x+m*w-n*v)*E,b[4]=(-g*D+i*A-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(-o*x+q*u-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(-c*C+d*A-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(-k*w+l*u-n*s)*E,b[12]=(-g*B+h*z-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(-o*v+p*t-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b},traceMat4:function(a){return a[0]+a[5]+a[10]+a[15]},translationMat4v:function(a){var b=XEO.math.identityMat4();return b[12]=a[0],b[13]=a[1],b[14]=a[2],b},translationMat4c:function(a,b,c){return XEO.math.translationMat4v([a,b,c])},translationMat4s:function(a){return XEO.math.translationMat4c(a,a,a)},rotationMat4v:function(a,b){var c,d,e,f,g,h,i=XEO.math.normalizeVec4([b[0],b[1],b[2],0],[]),j=Math.sin(a),k=Math.cos(a),l=1-k,m=i[0],n=i[1],o=i[2];c=m*n,d=n*o,e=o*m,f=m*j,g=n*j,h=o*j;var p=XEO.math.mat4();return p[0]=l*m*m+k,p[1]=l*c+h,p[2]=l*e-g,p[3]=0,p[4]=l*c-h,p[5]=l*n*n+k,p[6]=l*d+f,p[7]=0,p[8]=l*e+g,p[9]=l*d-f,p[10]=l*o*o+k,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p},rotationMat4c:function(a,b,c,d){return XEO.math.rotationMat4v(a,[b,c,d])},scalingMat4v:function(a){var b=XEO.math.identityMat4();return b[0]=a[0],b[5]=a[1],b[10]=a[2],b},scalingMat4c:function(a,b,c){return XEO.math.scalingMat4v([a,b,c])},scalingMat4s:function(a){return XEO.math.scalingMat4c(a,a,a)},lookAtMat4v:function(a,b,c,d){d||(d=XEO.math.mat4());var e=a[0],f=a[1],g=a[2],h=c[0],i=c[1],j=c[2],k=b[0],l=b[1],m=b[2];if(e===k&&f===l&&g===m)return XEO.math.identityMat4();var n,o,p,q,r,s,t,u,v,w;return n=e-k,o=f-l,p=g-m,w=1/Math.sqrt(n*n+o*o+p*p),n*=w,o*=w,p*=w,q=i*p-j*o,r=j*n-h*p,s=h*o-i*n,w=Math.sqrt(q*q+r*r+s*s),w?(w=1/w,q*=w,r*=w,s*=w):(q=0,r=0,s=0),t=o*s-p*r,u=p*q-n*s,v=n*r-o*q,w=Math.sqrt(t*t+u*u+v*v),w?(w=1/w,t*=w,u*=w,v*=w):(t=0,u=0,v=0),d[0]=q,d[1]=t,d[2]=n,d[3]=0,d[4]=r,d[5]=u,d[6]=o,d[7]=0,d[8]=s,d[9]=v,d[10]=p,d[11]=0,d[12]=-(q*e+r*f+s*g),d[13]=-(t*e+u*f+v*g),d[14]=-(n*e+o*f+p*g),d[15]=1,d},lookAtMat4c:function(a,b,c,d,e,f,g,h,i){return XEO.math.lookAtMat4v([a,b,c],[d,e,f],[g,h,i],[])},orthoMat4c:function(a,b,c,d,e,f,g){g||(g=XEO.math.mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2/i,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=-2/j,g[11]=0,g[12]=-(a+b)/h,g[13]=-(d+c)/i,g[14]=-(f+e)/j,g[15]=1,g},frustumMat4v:function(a,b){var c=[a[0],a[1],a[2],0],d=[b[0],b[1],b[2],0],e=XEO.math.mat4();XEO.math.addVec4(d,c,e);var f=XEO.math.mat4();XEO.math.subVec4(d,c,f);var g=2*c[2],h=XEO.math.mat4(),i=f[0],j=f[1],k=f[2];return h[0]=g/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=g/j,h[6]=0,h[7]=0,h[8]=e[0]/i,h[9]=e[1]/j,h[10]=-e[2]/k,h[11]=-1,h[12]=0,h[13]=0,h[14]=-g*d[2]/k,h[15]=0,h},frustumMatrix4:function(a,b,c,d,e,f,g){g||(g=XEO.math.mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2*e/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2*e/i,g[6]=0,g[7]=0,g[8]=(b+a)/h,g[9]=(d+c)/i,g[10]=-(f+e)/j,g[11]=-1,g[12]=0,g[13]=0,g[14]=-(f*e*2)/j,g[15]=0,g},perspectiveMatrix4:function(a,b,c,d){var e=[],f=[];return e[2]=c,f[2]=d,f[1]=e[2]*Math.tan(a/2),e[1]=-f[1],f[0]=f[1]*b,e[0]=-f[0],XEO.math.frustumMat4v(e,f)},transformPoint3:function(a,b){var c=b[0],d=b[1],e=b[2];return[a[0]*c+a[4]*d+a[8]*e+a[12],a[1]*c+a[5]*d+a[9]*e+a[13],a[2]*c+a[6]*d+a[10]*e+a[14],a[3]*c+a[7]*d+a[11]*e+a[15]]},transformPoints3:function(a,b){for(var c,d,e,f,g=new Array(b.length),h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15],y=0;h>y;++y)f=b[y],c=f[0],d=f[1],e=f[2],g[y]=[i*c+m*d+q*e+u,j*c+n*d+r*e+v,k*c+o*d+s*e+w,l*c+p*d+t*e+x];return g},transformVec3:function(a,b){var c=b[0],d=b[1],e=b[2];return[a[0]*c+a[4]*d+a[8]*e,a[1]*c+a[5]*d+a[9]*e,a[2]*c+a[6]*d+a[10]*e]},transformVec4:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},projectVec4:function(a){var b=1/a[3];return[a[0]*b,a[1]*b,a[2]*b,1]}}}(),function(){"use strict";XEO.webgl={enums:{funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipMapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipMapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipMapLinear:"NEAREST_MIPMAP_LINEAR",linearMipMapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"}}}(),function(){"use strict";XEO.webgl.ArrayBuffer=function(a,b,c,d,e,f){this.allocated=!1,this.gl=a,this.type=b,this.numItems=d,this.itemSize=e,this.usage=f,this._allocate(c,d)},XEO.webgl.ArrayBuffer.prototype._allocate=function(a,b){if(this.allocated=!1,this.handle=this.gl.createBuffer(),!this.handle)throw"Failed to allocate WebGL ArrayBuffer";this.handle&&(this.gl.bindBuffer(this.type,this.handle),this.gl.bufferData(this.type,a,this.usage),this.gl.bindBuffer(this.type,null),this.numItems=b,this.length=a.length,this.allocated=!0)},XEO.webgl.ArrayBuffer.prototype.setData=function(a,b){this.allocated&&(a.length>this.length?(this.destroy(),this._allocate(a,a.length)):b||0===b?this.gl.bufferSubData(this.type,b,a):this.gl.bufferData(this.type,a))},XEO.webgl.ArrayBuffer.prototype.unbind=function(){this.allocated&&this.gl.bindBuffer(this.type,null)},XEO.webgl.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteBuffer(this.handle),this.handle=null,this.allocated=!1)},XEO.webgl.ArrayBuffer.prototype.bind=function(){this.allocated&&this.gl.bindBuffer(this.type,this.handle)}}(),function(){"use strict";XEO.webgl.Attribute=function(a,b,c,d,e,f){this.gl=a,this.location=f,this.bindFloatArrayBuffer=function(b){b&&(b.bind(),a.enableVertexAttribArray(f),a.vertexAttribPointer(f,b.itemSize,a.FLOAT,!1,0,0))}},XEO.webgl.Attribute.prototype.bindInterleavedFloatArrayBuffer=function(a,b,c){this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a,this.gl.FLOAT,!1,b,c)}}(),function(){"use strict";XEO.webgl.Program=function(a,b,c){this.allocated=!1,this.gl=a,this._uniforms={},this._samplers={},this._attributes={},this.uniformValues=[],this.materialSettings={specularColor:[0,0,0],specular:0,shininess:0,emit:0,alpha:0},this._vertexShader=new XEO.webgl.Shader(a,a.VERTEX_SHADER,b),this._fragmentShader=new XEO.webgl.Shader(a,a.FRAGMENT_SHADER,c);var d,e,f,g,h;if(this.handle=a.createProgram(),this.handle){this._vertexShader.valid&&a.attachShader(this.handle,this._vertexShader.handle),this._fragmentShader.valid&&a.attachShader(this.handle,this._fragmentShader.handle),a.linkProgram(this.handle);var i=a.getProgramParameter(this.handle,a.ACTIVE_UNIFORMS),j=0;for(e=0;i>e;++e)f=a.getActiveUniform(this.handle,e),f&&(g=f.name,"\x00"===g[g.length-1]&&(g=g.substr(0,g.length-1)),h=a.getUniformLocation(this.handle,g),f.type===a.SAMPLER_2D||f.type===a.SAMPLER_CUBE||35682===f.type?this._samplers[g]=new XEO.webgl.Sampler(a,this.handle,g,f.type,f.size,h):(this._uniforms[g]=new XEO.webgl.Uniform(a,this.handle,g,f.type,f.size,h,j),this.uniformValues[j]=null,++j));var k=a.getProgramParameter(this.handle,a.ACTIVE_ATTRIBUTES);for(e=0;k>e;e++)d=a.getActiveAttrib(this.handle,e),d&&(h=a.getAttribLocation(this.handle,d.name),this._attributes[d.name]=new XEO.webgl.Attribute(a,this.handle,d.name,d.type,d.size,h));this.allocated=!0}},XEO.webgl.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},XEO.webgl.Program.prototype.getUniformLocation=function(a){if(this.allocated){var b=this._uniforms[a];return b?b.getLocation():void 0}},XEO.webgl.Program.prototype.getUniform=function(a){if(this.allocated){var b=this._uniforms[a];return b?b:void 0}},XEO.webgl.Program.prototype.getAttribute=function(a){if(this.allocated){var b=this._attributes[a];return b?b:void 0}},XEO.webgl.Program.prototype.bindFloatArrayBuffer=function(a,b){if(this.allocated){var c=this._attributes[a];c&&c.bindFloatArrayBuffer(b)}},XEO.webgl.Program.prototype.bindTexture=function(a,b,c){if(!this.allocated)return!1;var d=this._samplers[a];return d?d.bindTexture(b,c):!1},XEO.webgl.Program.prototype.destroy=function(){this.allocated&&(this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this._attributes=null,this._uniforms=null,this._samplers=null,this.allocated=!1)},XEO.webgl.Program.prototype.setUniform=function(a,b){if(this.allocated){var c=this._uniforms[a];c&&(this.uniformValues[c.index]===b&&c.numberValue||(c.setValue(b),this.uniformValues[c.index]=b))}}}(),function(){"use strict";XEO.webgl.RenderBuffer=function(a){this.allocated=!1,this.canvas=a.canvas,this.gl=a.canvas.gl,this.buf=null,this.bound=!1},XEO.webgl.RenderBuffer.prototype.webglRestored=function(a){this.gl=a,this.buf=null,this.allocated=!1,this.bound=!1},XEO.webgl.RenderBuffer.prototype.bind=function(){this._touch(),this.bound||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),this.bound=!0)},XEO.webgl.RenderBuffer.prototype._touch=function(){var a=this.canvas.canvas.width,b=this.canvas.canvas.height;if(this.buf){if(this.buf.width===a&&this.buf.height===b)return;this.gl.deleteTexture(this.buf.texture),this.gl.deleteFramebuffer(this.buf.framebuf),this.gl.deleteRenderbuffer(this.buf.renderbuf)}this.buf={framebuf:this.gl.createFramebuffer(),renderbuf:this.gl.createRenderbuffer(),texture:this.gl.createTexture(),width:a,height:b},this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),this.gl.bindTexture(this.gl.TEXTURE_2D,this.buf.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);try{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)}catch(c){var d=new WebGLUnsignedByteArray(a*b*3);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,d)}if(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.buf.renderbuf),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,a,b),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.buf.texture,0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.buf.renderbuf),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),!this.gl.isFramebuffer(this.buf.framebuf))throw xeo_error.fatalError(XEO.errors.INVALID_FRAMEBUFFER,"Invalid framebuffer");var e=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);switch(e){case this.gl.FRAMEBUFFER_COMPLETE:break;case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw xeo_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw xeo_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw xeo_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case this.gl.FRAMEBUFFER_UNSUPPORTED:throw xeo_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:throw xeo_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: "+e)}this.bound=!1},XEO.webgl.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.BLEND)},XEO.webgl.RenderBuffer.prototype.read=function(a,b){var c=a,d=this.canvas.canvas.height-b,e=new Uint8Array(4);return this.gl.readPixels(c,d,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),e},XEO.webgl.RenderBuffer.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.bound=!1},XEO.webgl.RenderBuffer.prototype.getTexture=function(){var a=this;return{bind:function(b){return a.buf&&a.buf.texture?(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,a.buf.texture),!0):!1},unbind:function(b){a.buf&&a.buf.texture&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,null))}}},XEO.webgl.RenderBuffer.prototype.destroy=function(){this.buf&&(this.gl.deleteTexture(this.buf.texture),this.gl.deleteFramebuffer(this.buf.framebuf),this.gl.deleteRenderbuffer(this.buf.renderbuf),this.buf=null,this.bound=!1)}}(),function(){"use strict";XEO.webgl.Sampler=function(a,b,c,d,e,f){this.bindTexture=function(b,c){return b.bind(c)?(a.uniform1i(f,c),!0):!1}}}(),function(){"use strict";XEO.webgl.Texture2D=function(a,b){this.allocated=!1,this.target=b.target||a.TEXTURE_2D,this.minFilter=b.minFilter,this.magFilter=b.magFilter,this.wrapS=b.wrapS,this.wrapT=b.wrapT,this.update=b.update,this.texture=b.texture,this.format=a.RGBA,this.isDepth=!1,this.depthMode=0,this.depthCompareMode=0,this.depthCompareFunc=0;try{a.bindTexture(this.target,this.texture),b.minFilter&&a.texParameteri(this.target,a.TEXTURE_MIN_FILTER,b.minFilter),b.magFilter&&a.texParameteri(this.target,a.TEXTURE_MAG_FILTER,b.magFilter),b.wrapS&&a.texParameteri(this.target,a.TEXTURE_WRAP_S,b.wrapS),b.wrapT&&a.texParameteri(this.target,a.TEXTURE_WRAP_T,b.wrapT),(b.minFilter===a.NEAREST_MIPMAP_NEAREST||b.minFilter===a.LINEAR_MIPMAP_NEAREST||b.minFilter===a.NEAREST_MIPMAP_LINEAR||b.minFilter===a.LINEAR_MIPMAP_LINEAR)&&a.generateMipmap(this.target),a.bindTexture(this.target,null),this.allocated=!0}catch(c){throw xeo_error.fatalError(XEO.errors.OUT_OF_VRAM,"Failed to create texture: "+c.message||c)}this.bind=function(b){return this.allocated?this.texture?(a.activeTexture(a["TEXTURE"+b]),a.bindTexture(this.target,this.texture),this.update&&this.update(a),!0):!1:void 0},this.unbind=function(b){this.allocated&&this.texture&&(a.activeTexture(a["TEXTURE"+b]),a.bindTexture(this.target,null))},this.destroy=function(){this.allocated&&this.texture&&(a.deleteTexture(this.texture),this.texture=null)}},XEO.webgl.clampImageSize=function(a,b){var c=a.width*a.height;if(c>b){var d=b/c,e=a.width*d,f=a.height*d,g=document.createElement("canvas");g.width=XEO.webgl.nextHighestPowerOfTwo(e),g.height=XEO.webgl.nextHighestPowerOfTwo(f);var h=g.getContext("2d");h.drawImage(a,0,0,a.width,a.height,0,0,g.width,g.height),a=g}return a},XEO.webgl.ensureImageSizePowerOfTwo=function(a){if(!XEO.webgl.isPowerOfTwo(a.width)||!XEO.webgl.isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=XEO.webgl.nextHighestPowerOfTwo(a.width),b.height=XEO.webgl.nextHighestPowerOfTwo(a.height);var c=b.getContext("2d");c.drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b}return a},XEO.webgl.isPowerOfTwo=function(a){return 0===(a&a-1)},XEO.webgl.nextHighestPowerOfTwo=function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1}}(),function(){"use strict";XEO.webgl.Uniform=function(a,b,c,d,e,f,g){var h=null;if(this.numberValue=!1,d===a.BOOL)this.numberValue=!0,h=function(b){a.uniform1i(f,b)};else if(d===a.BOOL_VEC2)h=function(b){a.uniform2iv(f,b)};else if(d===a.BOOL_VEC3)h=function(b){a.uniform3iv(f,b)};else if(d===a.BOOL_VEC4)h=function(b){a.uniform4iv(f,b)};else if(d===a.INT)this.numberValue=!0,h=function(b){a.uniform1iv(f,b)};else if(d===a.INT_VEC2)h=function(b){a.uniform2iv(f,b)};else if(d===a.INT_VEC3)h=function(b){a.uniform3iv(f,b)};else if(d===a.INT_VEC4)h=function(b){a.uniform4iv(f,b)};else if(d===a.FLOAT)this.numberValue=!0,h=function(b){a.uniform1f(f,b)};else if(d===a.FLOAT_VEC2)h=function(b){a.uniform2fv(f,b)};else if(d===a.FLOAT_VEC3)h=function(b){a.uniform3fv(f,b)};else if(d===a.FLOAT_VEC4)h=function(b){a.uniform4fv(f,b)};else if(d===a.FLOAT_MAT2)h=function(b){a.uniformMatrix2fv(f,a.FALSE,b)};else if(d===a.FLOAT_MAT3)h=function(b){a.uniformMatrix3fv(f,a.FALSE,b)};else{if(d!==a.FLOAT_MAT4)throw"Unsupported shader uniform type: "+d;h=function(b){a.uniformMatrix4fv(f,a.FALSE,b)}}this.setValue=h,this.getValue=function(){return a.getUniform(b,f)},this.getLocation=function(){return f},this.index=g}}(),function(){"use strict";XEO.renderer=XEO.renderer||{},XEO.renderer.Renderer=function(a){this._canvas=a.canvas,this._programFactory=new XEO.renderer.ProgramFactory({canvas:a.canvas}),this._chunkFactory=new XEO.renderer.ChunkFactory,this.transparent=a.transparent===!0,this.enable=null,this.flags=null,this.layer=null,this.stage=null,this.renderer=null,this.depthBuf=null,this.colorBuf=null,this.view=null,this.lights=null,this.material=null,this.texture=null,this.cubemap=null,this.modelTransform=null,this.viewTransform=null,this.projTransform=null,this.renderTarget=null,this.clips=null,this.MorphTargets=null,this.name=null,this.tag=null,this.shader=null,this.uniforms=null,this.style=null,this.geometry=null,this._objectFactory=new XEO.renderer.ObjectFactory,this._objects={},this._ambientColor=[0,0,0,1],this._objectList=[],this._objectListLen=0,this._drawList=[],this._drawListLen=0,this._pickDrawList=[],this._pickDrawListLen=0,this._targetList=[],this._targetListLen=0,this._frameCtx={pickNames:[],canvas:this._canvas,VAO:null},this.objectListDirty=!0,this.stateOrderDirty=!0,this.stateSortDirty=!0,this.drawListDirty=!0,this.imageDirty=!0,this.pickBufDirty=!0,this.rayPickBufDirty=!0},XEO.renderer.Renderer.prototype.webglRestored=function(){this._programFactory.webglRestored(),this._chunkFactory.webglRestored();var a=this._canvas.gl;this.pickBuf&&this.pickBuf.webglRestored(a),this.rayPickBuf&&this.rayPickBuf.webglRestored(a),this.imageDirty=!0},XEO.renderer.Renderer.prototype.buildGameObject=function(a){var b=this._objects[a];b||(b=this._objects[a]=this._objectFactory.getGameObject(a),this.objectListDirty=!0),b.stage=this.stage,b.layer=this.layer,b.renderTarget=this.renderTarget,b.texture=this.texture,b.cubemap=this.cubemap,b.geometry=this.geometry,b.enable=this.enable,b.flags=this.flags,b.tag=this.tag;var c=[this.geometry.hash,this.shader.hash,this.clips.hash,this.MorphTargets.hash,this.texture.hash,this.cubemap.hash,this.lights.hash].join(";");b.program&&c===b.hash||(b.program&&this._programFactory.putProgram(b.program),b.program=this._programFactory.getProgram(c,this),b.hash=c),this._setChunk(b,0,"program"),this._setChunk(b,1,"xform",this.modelTransform),this._setChunk(b,2,"lookAt",this.viewTransform),this._setChunk(b,3,"camera",this.projTransform),this._setChunk(b,4,"flags",this.flags),this._setChunk(b,5,"shader",this.shader),this._setChunk(b,6,"uniforms",this.uniforms),this._setChunk(b,7,"style",this.style),this._setChunk(b,8,"depthBuf",this.depthBuf),this._setChunk(b,9,"colorBuf",this.colorBuf),this._setChunk(b,10,"view",this.view),this._setChunk(b,11,"name",this.name),this._setChunk(b,12,"lights",this.lights),this._setChunk(b,13,"material",this.material),this._setChunk(b,14,"texture",this.texture),this._setChunk(b,15,"cubemap",this.cubemap),this._setChunk(b,16,"clips",this.clips),this._setChunk(b,17,"renderer",this.renderer),this._setChunk(b,18,"geometry",this.MorphTargets,this.geometry),this._setChunk(b,19,"draw",this.geometry)},XEO.renderer.Renderer.prototype._setChunk=function(a,b,c,d,e){var f,g=this._chunkFactory.chunkTypes[c];if(d){if(d.empty){var h=a.chunks[b];return h&&this._chunkFactory.putChunk(h),void(a.chunks[b]=null)}f=g.prototype.programGlobal?"_"+d.stateId:"p"+a.program.id+"_"+d.stateId,e&&(f+="__"+e.stateId)}else f="p"+a.program.id;f=b+"__"+f;var h=a.chunks[b];if(h){if(h.id===f)return;this._chunkFactory.putChunk(h)}a.chunks[b]=this._chunkFactory.getChunk(f,c,a.program,d,e),"lights"===c&&this._setAmbient(d)},XEO.renderer.Renderer.prototype._setAmbient=function(a){for(var b,c=a.lights,d=0,e=c.length;e>d;d++)b=c[d],"ambient"===b.mode&&(this._ambientColor[0]=b.color[0],this._ambientColor[1]=b.color[1],this._ambientColor[2]=b.color[2])},XEO.renderer.Renderer.prototype.removeGameObject=function(a){var b=this._objects[a];b&&(this._programFactory.putProgram(b.program),b.program=null,b.hash=null,this._objectFactory.putGameObject(b),delete this._objects[a],this.objectListDirty=!0)},XEO.renderer.Renderer.prototype.selectTags=function(a){this._tagSelector=a,this.drawListDirty=!0},XEO.renderer.Renderer.prototype.render=function(a){a=a||{},this.objectListDirty&&(this._buildGameObjectList(),this.objectListDirty=!1,this.stateOrderDirty=!0),this.stateOrderDirty&&(this._makeStateSortKeys(),this.stateOrderDirty=!1,this.stateSortDirty=!0),this.stateSortDirty&&(this._stateSort(),this.stateSortDirty=!1,this.drawListDirty=!0),this.drawListDirty&&(this._buildDrawList(),this.imageDirty=!0),(this.imageDirty||a.force)&&(this._doDrawList({clear:a.clear!==!1}),this.imageDirty=!1,this.pickBufDirty=!0)},XEO.renderer.Renderer.prototype._buildGameObjectList=function(){this._objectListLen=0;for(var a in this._objects)this._objects.hasOwnProperty(a)&&(this._objectList[this._objectListLen++]=this._objects[a])},XEO.renderer.Renderer.prototype._makeStateSortKeys=function(){for(var a,b=0,c=this._objectListLen;c>b;b++)a=this._objectList[b],a.sortKey=a.program?1e12*(a.stage.priority+1)+1e9*(a.flags.transparent?2:1)+1e6*(a.layer.priority+1)+1e3*(a.program.id+1)+a.texture.stateId:-1},XEO.renderer.Renderer.prototype._stateSort=function(){this._objectList.length=this._objectListLen,this._objectList.sort(this._stateSortGameObjects)},XEO.renderer.Renderer.prototype._stateSortGameObjects=function(a,b){return a.sortKey-b.sortKey},XEO.renderer.Renderer.prototype._logGameObjectList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._objectListLen+" objects");for(var a=0,b=this._objectListLen;b>a;a++){var c=this._objectList[a];console.log("XEO.Renderer : object["+a+"] sortKey = "+c.sortKey)}console.log("--------------------------------------------------------------------------------------------------")},XEO.renderer.Renderer.prototype._buildDrawList=function(){this._lastStateId=this._lastStateId||[],this._lastPickStateId=this._lastPickStateId||[];for(var a=0;23>a;a++)this._lastStateId[a]=null,this._lastPickStateId[a]=null;this._drawListLen=0,this._pickDrawListLen=0;var b,c,d,e,f,g={},h=[],i=[];this._tagSelector&&(c=this._tagSelector.mask,d=this._tagSelector.regex),this._objectDrawList=this._objectDrawList||[],this._objectDrawListLen=0;for(var a=0,j=this._objectListLen;j>a;a++)if(b=this._objectList[a],b.enable.enabled!==!1&&(f=b.flags,f.enabled!==!1&&b.layer.enabled&&(!c||(e=b.tag,!e.tag||(e.mask!==c&&(e.mask=c,e.matches=d.test(e.tag)),e.matches)))))if(b.renderTarget.targets)for(var k,l,m,n=b.renderTarget.targets,o=0,p=n.length;p>o;o++)k=n[o],l=k.coreId,m=g[l],m||(m=[],g[l]=m,h.push(m),i.push(this._chunkFactory.getChunk(k.stateId,"renderTarget",b.program,k))),m.push(b);else this._objectDrawList[this._objectDrawListLen++]=b;for(var m,k,b,q,a=0,j=h.length;j>a;a++){m=h[a],k=i[a],this._appendRenderTargetChunk(k);for(var o=0,p=m.length;p>o;o++)b=m[o],q=b.stage&&b.stage.pickable,this._appendGameObjectToDrawLists(b,q)}b&&this._appendRenderTargetChunk(this._chunkFactory.getChunk(-1,"renderTarget",b.program,{}));for(var a=0,j=this._objectDrawListLen;j>a;a++)b=this._objectDrawList[a],q=!b.stage||b.stage&&b.stage.pickable,this._appendGameObjectToDrawLists(b,q);this.drawListDirty=!1},XEO.renderer.Renderer.prototype._appendRenderTargetChunk=function(a){this._drawList[this._drawListLen++]=a},XEO.renderer.Renderer.prototype._appendGameObjectToDrawLists=function(a,b){for(var c,d=a.chunks,e=a.flags.picking,f=0,g=d.length;g>f;f++)c=d[f],c&&(c.draw&&(c.unique||this._lastStateId[f]!==c.id)&&(this._drawList[this._drawListLen++]=c,this._lastStateId[f]=c.id),c.pick&&b!==!1&&e&&(c.unique||this._lastPickStateId[f]!==c.id)&&(this._pickDrawList[this._pickDrawListLen++]=c,this._lastPickStateId[f]=c.id))},XEO.renderer.Renderer.prototype._logDrawList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._drawListLen+" draw list chunks");for(var a=0,b=this._drawListLen;b>a;a++){var c=this._drawList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" bufType = "+c.state.bufType)}}console.log("--------------------------------------------------------------------------------------------------")},XEO.renderer.Renderer.prototype._logPickList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._pickDrawListLen+" pick list chunks");for(var a=0,b=this._pickDrawListLen;b>a;a++){var c=this._pickDrawList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" bufType = "+c.state.bufType)}}console.log("--------------------------------------------------------------------------------------------------")},XEO.renderer.Renderer.prototype.pick=function(a){var b=this._canvas.canvas,c=null,d=a.canvasX,e=a.canvasY,f=this.pickBuf;f||(f=this.pickBuf=new XEO.webgl.RenderBuffer({canvas:this._canvas}),this.pickBufDirty=!0),this.render(),f.bind(),this.pickBufDirty&&(f.clear(),this._doDrawList({pick:!0,clear:!0}),this._canvas.gl.finish(),this.pickBufDirty=!1,this.rayPickBufDirty=!0);var g=f.read(d,e),h=g[0]+256*g[1]+65536*g[2],i=h>=1?h-1:-1;f.unbind();var j=this._frameCtx.pickNames[i];if(j&&(c={name:j.name,path:j.path,componentId:j.componentId,canvasPos:[d,e]},a.rayPick)){var k=this.rayPickBuf;k||(k=this.rayPickBuf=new XEO.webgl.RenderBuffer({canvas:this._canvas}),this.rayPickBufDirty=!0),k.bind(),this.rayPickBufDirty&&(k.clear(),this._doDrawList({pick:!0,rayPick:!0,clear:!0}),this.rayPickBufDirty=!1),g=k.read(d,e),k.unbind();var l=this._unpackDepth(g),m=b.width,n=b.height,o=(d-m/2)/(m/2),p=-(e-n/2)/(n/2),q=this._frameCtx.cameraMat,r=this._frameCtx.viewMat,s=XEO.math.mulMat4(q,r,[]),t=XEO.math.inverseMat4(s,[]),u=XEO.math.transformVec4(t,[o,p,-1,1]);
u=XEO.math.mulVec4Scalar(u,1/u[3]);var v=XEO.math.transformVec4(t,[o,p,1,1]);v=XEO.math.mulVec4Scalar(v,1/v[3]);var w=XEO.math.subVec3(v,u,[]),x=XEO.math.addVec3(u,XEO.math.mulVec4Scalar(w,l,[]),[]);c.worldPos=x}return c},XEO.renderer.Renderer.prototype._unpackDepth=function(a){var b=[a[0]/256,a[1]/256,a[2]/256,a[3]/256],c=[1/16777216,1/65536,1/256,1];return XEO.math.dotVector4(b,c)},XEO.renderer.Renderer.prototype._doDrawList=function(a){var b=this._canvas.gl,c=this._frameCtx;c.renderTarget=null,c.targetIndex=0,c.renderBuf=null,c.viewMat=null,c.modelMat=null,c.cameraMat=null,c.renderer=null,c.depthbufEnabled=null,c.clearDepth=null,c.depthFunc=b.LESS,c.scissorTestEnabled=!1,c.blendEnabled=!1,c.backfaces=!0,c.frontface="ccw",c.pick=!!a.pick,c.rayPick=!!a.rayPick,c.pickIndex=0,c.textureUnit=0,c.lineWidth=1,c.transparent=!1,c.ambientColor=this._ambientColor,c.aspect=this._canvas.canvas.width/this._canvas.canvas.height;var d=b.getExtension("OES_vertex_array_object");if(c.VAO=d?d:null,c.VAO=null,b.viewport(0,0,b.drawingBufferWidth,b.drawingBufferHeight),this.transparent?b.clearColor(0,0,0,0):b.clearColor(this._ambientColor[0],this._ambientColor[1],this._ambientColor[2],1),a.clear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT|b.STENCIL_BUFFER_BIT),b.frontFace(b.CCW),b.disable(b.CULL_FACE),b.disable(b.BLEND),a.pick)for(var e=0,f=this._pickDrawListLen;f>e;e++)this._pickDrawList[e].pick(c);else for(var e=0,f=this._drawListLen;f>e;e++)this._drawList[e].draw(c);if(b.flush(),c.renderBuf&&c.renderBuf.unbind(),c.VAO){c.VAO.bindVertexArrayOES(null);for(var e=0;10>e;e++)b.disableVertexAttribArray(e)}},XEO.renderer.Renderer.prototype.destroy=function(){this._programFactory.destroy()}}(),function(){"use strict";XEO.renderer=XEO.renderer||{},XEO.renderer.GameObject=function(a){this.id=a,this.hash=null,this.sortKey=null,this.chunks=[],this.chunksLen=0,this.program=null,this.layer=null,this.texture=null,this.flags=null,this.tag=null}}(),function(){"use strict";XEO.renderer=XEO.renderer||{},XEO.renderer.ObjectFactory=function(){var a=[],b=0;this.getGameObject=function(c){var d;return b>0?(d=a[--b],d.id=c,d):new XEO.renderer.GameObject(c)},this.putGameObject=function(c){a[b++]=c}}}(),function(){"use strict";XEO.renderer=XEO.renderer||{},XEO.renderer.Program=function(a,b,c,d){this.id=a,this.hash=c.hash,this.source=c,this.gl=d,this.draw=null,this.pick=null,this.useCount=0,this.build(d)},XEO.renderer.Program.prototype.build=function(a){this.drawUniformFlags=0,this.gl=a,this.draw=new XEO.webgl.Program(a,this.source.drawVertex,this.source.drawFragment),this.pick=new XEO.webgl.Program(a,this.source.vertexPickObject,this.source.pickFragment)}}(),function(){"use strict";XEO.renderer=XEO.renderer||{},XEO.renderer.ProgramFactory=function(a){this._canvas=a.canvas,this._programs={},this._nextProgramId=0},XEO.renderer.ProgramFactory.prototype={getProgram:function(a,b){var c=this._programs[a];if(!c){var d=XEO.renderer.ProgramSourceFactory.getSource(a,b);c=new XEO.renderer.Program(this._nextProgramId++,a,d,this._canvas.gl),this._programs[a]=c}return c.useCount++,c},putProgram:function(a){--a.useCount<=0&&(a.draw.destroy(),a.pick.destroy(),XEO.renderer.ProgramSourceFactory.putSource(a.hash),this._programs[a.hash]=null)},webglRestored:function(){var a=this._canvas.gl;for(var b in this._programs)this._programs.hasOwnProperty(b)&&this._programs[b].build(a)},destroy:function(){}}}(),function(){"use strict";XEO.renderer.ProgramSource=function(a,b,c,d,e){this.hash=a,this.vertexPickObject=b,this.pickFragment=c,this.drawVertex=d,this.drawFragment=e,this.useCount=0}}(),function(){"use strict";XEO.renderer.ProgramSourceFactory=new function(){var a={};this.getSource=function(b,c){var d=a[b];return d?(d.useCount++,d):a[b]=new XEO.renderer.ProgramSource(b,this._composePickingVertexShader(c),this._composePickingFragmentShader(c),this._composeRenderingVertexShader(c),this._composeRenderingFragmentShader(c))},this.putSource=function(b){var c=a[b];c&&0===--c.useCount&&(a[c.hash]=null)},this._composePickingVertexShader=function(a){var b=!!a.MorphTargets.targets,c=["precision mediump float;","attribute vec3 xeo_aPosition;","uniform mat4 xeo_uMMatrix;","uniform mat4 xeo_uVMatrix;","uniform mat4 xeo_uVNMatrix;","uniform mat4 xeo_uPMatrix;"];return c.push("varying vec4 xeo_vWorldVertex;"),c.push("varying vec4 xeo_vViewVertex;"),b&&(c.push("uniform float xeo_uMorphFactor;"),a.MorphTargets.targets[0].vertexBuf&&c.push("attribute vec3 xeo_aMorphVertex;")),c.push("void main(void) {"),c.push("   vec4 tmpVertex=vec4(xeo_aPosition, 1.0); "),b&&a.MorphTargets.targets[0].vertexBuf&&c.push("  tmpVertex = vec4(mix(tmpVertex.xyz, xeo_aMorphVertex, xeo_uMorphFactor), 1.0); "),c.push("  xeo_vWorldVertex = xeo_uMMatrix * tmpVertex; "),c.push("  xeo_vViewVertex = xeo_uVMatrix * xeo_vWorldVertex;"),c.push("  gl_Position =  xeo_uPMatrix * xeo_vViewVertex;"),c.push("}"),c.join("\n")},this._composePickingFragmentShader=function(a){var b=a.clips.clips.length>0,c=["precision mediump float;"];if(c.push("varying vec4 xeo_vWorldVertex;"),c.push("varying vec4  xeo_vViewVertex;"),c.push("uniform bool  xeo_uRayPickMode;"),c.push("uniform vec3  xeo_uPickColor;"),c.push("uniform float xeo_uZNear;"),c.push("uniform float xeo_uZFar;"),c.push("uniform bool  xeo_uClipping;"),b)for(var d=0;d<a.clips.clips.length;d++)c.push("uniform float xeo_uClipMode"+d+";"),c.push("uniform vec4  xeo_uClipNormalAndDist"+d+";");if(c.push("vec4 packDepth(const in float depth) {"),c.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),c.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),c.push("  vec4 res = fract(depth * bitShift);"),c.push("  res -= res.xxyz * bitMask;"),c.push("  return res;"),c.push("}"),c.push("void main(void) {"),b){c.push("if (xeo_uClipping) {"),c.push("  float   dist;");for(var d=0;d<a.clips.clips.length;d++)c.push("    if (xeo_uClipMode"+d+" != 0.0) {"),c.push("        dist = dot(xeo_vWorldVertex.xyz, xeo_uClipNormalAndDist"+d+".xyz) - xeo_uClipNormalAndDist"+d+".w;"),c.push("        if (xeo_uClipMode"+d+" == 1.0) {"),c.push("            if (dist > 0.0) { discard; }"),c.push("        }"),c.push("        if (xeo_uClipMode"+d+" == 2.0) {"),c.push("            if (dist > 0.0) { discard; }"),c.push("        }"),c.push("    }");c.push("}")}return c.push("    if (xeo_uRayPickMode) {"),c.push("          float zNormalizedDepth = abs((xeo_uZNear + xeo_vViewVertex.z) / (xeo_uZFar - xeo_uZNear));"),c.push("          gl_FragColor = packDepth(zNormalizedDepth); "),c.push("    } else {"),c.push("          gl_FragColor = vec4(xeo_uPickColor.rgb, 1.0);  "),c.push("    }"),c.push("}"),c.join("\n")},this._isTexturing=function(a){if(a.texture.layers&&a.texture.layers.length>0){if(a.geometry.uvBuf||a.geometry.uvBuf2)return!0;if(a.MorphTargets.targets&&(a.MorphTargets.targets[0].uvBuf||a.MorphTargets.targets[0].uvBuf2))return!0}return!1},this._isCubeMapping=function(a){return a.cubemap.layers&&a.cubemap.layers.length>0&&a.geometry.normalBuf},this._hasNormals=function(a){return a.geometry.normalBuf?!0:a.MorphTargets.targets&&a.MorphTargets.targets[0].normalBuf?!0:!1},this._hasTangents=function(a){if(a.texture){var b=a.texture.layers;if(!b)return!1;for(var c=0,d=b.length;d>c;c++)if("normals"===b[c].applyTo)return!0}return!1},this._composeRenderingVertexShader=function(a){var b=a.shader.shaders||{};if(b.vertex&&b.vertex.code&&""!==b.vertex.code&&SceneJS._isEmpty(b.vertex.hooks))return[b.vertex.code];var c=b.vertex||{},d=c.hooks||{},e=b.fragment||{},f=e.hooks||{},g=this._isTexturing(a),h=this._hasNormals(a),i=this._hasTangents(a),j=a.clips.clips.length>0,k=!!a.MorphTargets.targets,l=["precision mediump float;"];if(l.push("uniform mat4 xeo_uMMatrix;"),l.push("uniform mat4 xeo_uVMatrix;"),l.push("uniform mat4 xeo_uPMatrix;"),l.push("attribute vec3 xeo_aPosition;"),l.push("uniform vec3 xeo_uWorldEye;"),l.push("varying vec3 xeo_vViewEyeVec;"),h){l.push("attribute vec3 xeo_aNormal;"),l.push("uniform   mat4 xeo_uMNMatrix;"),l.push("uniform   mat4 xeo_uVNMatrix;"),l.push("varying   vec3 xeo_vViewNormal;"),i&&l.push("attribute vec4 xeo_aTangent;");for(var m=0;m<a.lights.lights.length;m++){var n=a.lights.lights[m];"ambient"!==n.mode&&("dir"===n.mode&&l.push("uniform vec3 xeo_uLightDir"+m+";"),"point"===n.mode&&l.push("uniform vec3 xeo_uLightPos"+m+";"),"spot"===n.mode&&l.push("uniform vec3 xeo_uLightPos"+m+";"),l.push("varying vec4 xeo_vViewLightVecAndDist"+m+";"))}}if(g&&(a.geometry.uvBuf&&l.push("attribute vec2 xeo_aUV;"),a.geometry.uvBuf2&&l.push("attribute vec2 xeo_aUV2;")),a.geometry.colorBuf&&(l.push("attribute vec4 xeo_aVertexColor;"),l.push("varying vec4 xeo_vColor;")),j&&l.push("varying vec4 xeo_vWorldVertex;"),l.push("varying vec4 xeo_vViewVertex;"),g&&(a.geometry.uvBuf&&l.push("varying vec2 xeo_vUVCoord;"),a.geometry.uvBuf2&&l.push("varying vec2 xeo_vUVCoord2;")),k&&(l.push("uniform float xeo_uMorphFactor;"),a.MorphTargets.targets[0].vertexBuf&&l.push("attribute vec3 xeo_aMorphVertex;"),h&&a.MorphTargets.targets[0].normalBuf&&l.push("attribute vec3 xeo_aMorphNormal;")),c.code&&l.push("\n"+c.code+"\n"),l.push("void main(void) {"),l.push("  vec4 tmpVertex=vec4(xeo_aPosition, 1.0); "),l.push("  vec4 modelVertex = tmpVertex; "),h&&l.push("  vec4 modelNormal = vec4(xeo_aNormal, 0.0); "),k&&(a.MorphTargets.targets[0].vertexBuf&&(l.push("  vec4 vMorphVertex = vec4(xeo_aMorphVertex, 1.0); "),l.push("  modelVertex = vec4(mix(modelVertex.xyz, vMorphVertex.xyz, xeo_uMorphFactor), 1.0); ")),h&&a.MorphTargets.targets[0].normalBuf&&(l.push("  vec4 vMorphNormal = vec4(xeo_aMorphNormal, 1.0); "),l.push("  modelNormal = vec4( mix(modelNormal.xyz, vMorphNormal.xyz, xeo_uMorphFactor), 1.0); "))),l.push("  vec4 worldVertex = xeo_uMMatrix * modelVertex;"),l.push(d.viewMatrix?"vec4 viewVertex = "+d.viewMatrix+"(xeo_uVMatrix) * worldVertex;":"vec4 viewVertex  = xeo_uVMatrix * worldVertex; "),d.viewPos&&l.push("viewVertex="+d.viewPos+"(viewVertex);"),h&&(l.push("  vec3 worldNormal = (xeo_uMNMatrix * modelNormal).xyz; "),l.push("  xeo_vViewNormal = (xeo_uVNMatrix * vec4(worldNormal, 1.0)).xyz;")),(j||f.worldPos)&&l.push("  xeo_vWorldVertex = worldVertex;"),l.push("  xeo_vViewVertex = viewVertex;"),l.push(d.projMatrix?"gl_Position = "+d.projMatrix+"(xeo_uPMatrix) * viewVertex;":"  gl_Position = xeo_uPMatrix * viewVertex;"),i&&(l.push("vec3 tangent = normalize((xeo_uVNMatrix * xeo_uMNMatrix * xeo_aTangent).xyz);"),l.push("vec3 bitangent = cross(xeo_vViewNormal, tangent);"),l.push("mat3 TBM = mat3(tangent, bitangent, xeo_vViewNormal);")),l.push("  vec3 tmpVec3;"),h)for(var m=0;m<a.lights.lights.length;m++)n=a.lights.lights[m],"ambient"!==n.mode&&("dir"===n.mode&&("world"===n.space?(l.push("tmpVec3 = normalize(xeo_uLightDir"+m+");"),l.push("tmpVec3 = vec3(xeo_uVMatrix * vec4(tmpVec3, 0.0)).xyz;"),i&&l.push("tmpVec3 *= TBM;")):(l.push("tmpVec3 = normalize(xeo_uLightDir"+m+");"),i&&l.push("tmpVec3 *= TBM;")),l.push("xeo_vViewLightVecAndDist"+m+" = vec4(-tmpVec3, 0.0);")),"point"===n.mode&&("world"===n.space?(l.push("tmpVec3 = xeo_uLightPos"+m+" - worldVertex.xyz;"),l.push("tmpVec3 = vec3(xeo_uVMatrix * vec4(tmpVec3, 0.0)).xyz;"),i&&l.push("tmpVec3 *= TBM;")):(l.push("tmpVec3 = xeo_uLightPos"+m+".xyz - viewVertex.xyz;"),i&&l.push("tmpVec3 *= TBM;")),l.push("xeo_vViewLightVecAndDist"+m+" = vec4(tmpVec3, length( xeo_uLightPos"+m+" - worldVertex.xyz));")));return l.push("xeo_vViewEyeVec = ((xeo_uVMatrix * vec4(xeo_uWorldEye, 0.0)).xyz  - viewVertex.xyz);"),i&&l.push("xeo_vViewEyeVec *= TBM;"),g&&(a.geometry.uvBuf&&l.push("xeo_vUVCoord = xeo_aUV;"),a.geometry.uvBuf2&&l.push("xeo_vUVCoord2 = xeo_aUV2;")),a.geometry.colorBuf&&l.push("xeo_vColor = xeo_aVertexColor;"),l.push("}"),l.join("\n")},this._composeRenderingFragmentShader=function(a){var b=a.shader.shaders||{};if(b.fragment&&b.fragment.code&&""!==b.fragment.code&&SceneJS._isEmpty(b.fragment.hooks))return[b.fragment.code];var c=b.fragment||{},d=c.hooks||{},e=this._isTexturing(a),f=this._isCubeMapping(a),g=this._hasNormals(a),h=this._hasTangents(a),i=a.clips.clips.length>0,j=["\n"];if(j.push("precision mediump float;"),i&&j.push("varying vec4 xeo_vWorldVertex;"),j.push("varying vec4 xeo_vViewVertex;"),j.push("uniform float xeo_uZNear;"),j.push("uniform float xeo_uZFar;"),i)for(var k=0;k<a.clips.clips.length;k++)j.push("uniform float xeo_uClipMode"+k+";"),j.push("uniform vec4  xeo_uClipNormalAndDist"+k+";");if(e){a.geometry.uvBuf&&j.push("varying vec2 xeo_vUVCoord;"),a.geometry.uvBuf2&&j.push("varying vec2 xeo_vUVCoord2;");for(var l,k=0,m=a.texture.layers.length;m>k;k++)l=a.texture.layers[k],j.push("uniform sampler2D xeo_uSampler"+k+";"),l.matrix&&j.push("uniform mat4 xeo_uLayer"+k+"Matrix;"),j.push("uniform float xeo_uLayer"+k+"BlendFactor;")}if(g&&f)for(var l,k=0,m=a.cubemap.layers.length;m>k;k++)l=a.cubemap.layers[k],j.push("uniform samplerCube xeo_uCubeMapSampler"+k+";"),j.push("uniform float xeo_uCubeMapIntensity"+k+";");if(j.push("uniform bool  xeo_uBackfaceTexturing;"),j.push("uniform bool  xeo_uBackfaceLighting;"),j.push("uniform bool  xeo_uSpecularLighting;"),j.push("uniform bool  xeo_uClipping;"),j.push("uniform bool  xeo_uAmbient;"),j.push("uniform bool  xeo_uDiffuse;"),j.push("uniform bool  xeo_uReflection;"),j.push("uniform bool  xeo_uDepthMode;"),j.push("uniform bool  xeo_uTransparent;"),a.geometry.colorBuf&&j.push("varying vec4 xeo_vColor;"),j.push("uniform vec3  xeo_uAmbientColor;"),j.push("uniform vec3  xeo_uMaterialColor;"),j.push("uniform float xeo_uMaterialAlpha;"),j.push("uniform float xeo_uMaterialEmit;"),j.push("uniform vec3  xeo_uMaterialSpecularColor;"),j.push("uniform float xeo_uMaterialSpecular;"),j.push("uniform float xeo_uMaterialShine;"),j.push("varying vec3 xeo_vViewEyeVec;"),g){j.push("varying vec3 xeo_vViewNormal;");for(var n,k=0;k<a.lights.lights.length;k++)n=a.lights.lights[k],"ambient"!==n.mode&&(j.push("uniform vec3  xeo_uLightColor"+k+";"),"point"===n.mode&&j.push("uniform vec3  xeo_uLightAttenuation"+k+";"),j.push("varying vec4  xeo_vViewLightVecAndDist"+k+";"))}if(c.code&&j.push("\n"+c.code+"\n"),j.push("void main(void) {"),i){j.push("if (xeo_uClipping) {"),j.push("  float   dist;");for(var k=0;k<a.clips.clips.length;k++)j.push("    if (xeo_uClipMode"+k+" != 0.0) {"),j.push("        dist = dot(xeo_vWorldVertex.xyz, xeo_uClipNormalAndDist"+k+".xyz) - xeo_uClipNormalAndDist"+k+".w;"),j.push("        if (xeo_uClipMode"+k+" == 1.0) {"),j.push("            if (dist > 0.0) { discard; }"),j.push("        }"),j.push("        if (xeo_uClipMode"+k+" == 2.0) {"),j.push("            if (dist > 0.0) { discard; }"),j.push("        }"),j.push("    }");j.push("}")}j.push("  vec3 ambient= xeo_uAmbient ? xeo_uAmbientColor : vec3(0.0, 0.0, 0.0);"),e&&a.geometry.uvBuf&&d.texturePos&&j.push(d.texturePos+"(xeo_vUVCoord);"),d.viewPos&&j.push(d.viewPos+"(xeo_vViewVertex);"),g&&d.viewNormal&&j.push(d.viewNormal+"(xeo_vViewNormal);"),j.push(a.geometry.colorBuf?"  vec3    color   = xeo_vColor.rgb;":"  vec3    color   = xeo_uMaterialColor;"),j.push("  float alpha         = xeo_uMaterialAlpha;"),j.push("  float emit          = xeo_uMaterialEmit;"),j.push("  float specular      = xeo_uMaterialSpecular;"),j.push("  vec3  specularColor = xeo_uMaterialSpecularColor;"),j.push("  float shininess         = xeo_uMaterialShine;"),d.materialBaseColor&&j.push("color="+d.materialBaseColor+"(color);"),d.materialAlpha&&j.push("alpha="+d.materialAlpha+"(alpha);"),d.materialEmit&&j.push("emit="+d.materialEmit+"(emit);"),d.materialSpecular&&j.push("specular="+d.materialSpecular+"(specular);"),d.materialSpecularColor&&j.push("specularColor="+d.materialSpecularColor+"(specularColor);"),d.materialShine&&j.push("shininess="+d.materialShine+"(shininess);"),g&&(j.push("  float   attenuation = 1.0;"),j.push(h?"  vec3    viewNormalVec = vec3(0.0, 1.0, 0.0);":"  vec3    viewNormalVec = normalize(xeo_vViewNormal);"));var l;if(e){g&&j.push("if (xeo_uBackfaceTexturing || dot(xeo_vViewNormal, xeo_vViewEyeVec) > 0.0) {"),j.push("  vec4    texturePos;"),j.push("  vec2    textureCoord=vec2(0.0,0.0);");for(var k=0,m=a.texture.layers.length;m>k;k++){if(l=a.texture.layers[k],"normal"===l.applyFrom&&g){if(!a.geometry.normalBuf){SceneJS.log.warn("Texture layer applyFrom='normal' but geo has no normal vectors");continue}j.push("texturePos=vec4(viewNormalVec.xyz, 1.0);")}if("uv"===l.applyFrom){if(!a.geometry.uvBuf){SceneJS.log.warn("Texture layer applyTo='uv' but geometry has no UV coordinates");continue}j.push("texturePos = vec4(xeo_vUVCoord.s, xeo_vUVCoord.t, 1.0, 1.0);")}if("uv2"===l.applyFrom){if(!a.geometry.uvBuf2){SceneJS.log.warn("Texture layer applyTo='uv2' but geometry has no UV2 coordinates");continue}j.push("texturePos = vec4(xeo_vUVCoord2.s, xeo_vUVCoord2.t, 1.0, 1.0);")}j.push(l.matrix?"textureCoord=(xeo_uLayer"+k+"Matrix * texturePos).xy;":"textureCoord=texturePos.xy;"),"alpha"===l.applyTo&&("multiply"===l.blendMode?j.push("alpha = alpha * (xeo_uLayer"+k+"BlendFactor * texture2D(xeo_uSampler"+k+", vec2(textureCoord.x, 1.0 - textureCoord.y)).b);"):"add"===l.blendMode&&j.push("alpha = ((1.0 - xeo_uLayer"+k+"BlendFactor) * alpha) + (xeo_uLayer"+k+"BlendFactor * texture2D(xeo_uSampler"+k+", vec2(textureCoord.x, 1.0 - textureCoord.y)).b);")),"baseColor"===l.applyTo&&j.push("multiply"===l.blendMode?"color = color * (xeo_uLayer"+k+"BlendFactor * texture2D(xeo_uSampler"+k+", vec2(textureCoord.x, 1.0 - textureCoord.y)).rgb);":"color = ((1.0 - xeo_uLayer"+k+"BlendFactor) * color) + (xeo_uLayer"+k+"BlendFactor * texture2D(xeo_uSampler"+k+", vec2(textureCoord.x, 1.0 - textureCoord.y)).rgb);"),"emit"===l.applyTo&&j.push("multiply"===l.blendMode?"emit  = emit * (xeo_uLayer"+k+"BlendFactor * texture2D(xeo_uSampler"+k+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);":"emit = ((1.0 - xeo_uLayer"+k+"BlendFactor) * emit) + (xeo_uLayer"+k+"BlendFactor * texture2D(xeo_uSampler"+k+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);"),"specular"===l.applyTo&&g&&j.push("multiply"===l.blendMode?"specular  = specular * (xeo_uLayer"+k+"BlendFactor * texture2D(xeo_uSampler"+k+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);":"specular = ((1.0 - xeo_uLayer"+k+"BlendFactor) * specular) + (xeo_uLayer"+k+"BlendFactor * texture2D(xeo_uSampler"+k+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);"),"shininess"===l.applyTo&&j.push("multiply"===l.blendMode?"shininess  = shininess * (xeo_uLayer"+k+"BlendFactor * texture2D(xeo_uSampler"+k+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);":"shininess = ((1.0 - xeo_uLayer"+k+"BlendFactor) * shininess) + (xeo_uLayer"+k+"BlendFactor * texture2D(xeo_uSampler"+k+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);"),"normals"===l.applyTo&&g&&j.push("viewNormalVec = normalize(texture2D(xeo_uSampler"+k+", vec2(textureCoord.x, -textureCoord.y)).xyz * 2.0 - 1.0);")}g&&j.push("}")}if(g&&f){j.push("if (xeo_uReflection) {"),j.push("vec3 envLookup = reflect(xeo_vViewEyeVec, viewNormalVec);"),j.push("envLookup.y = envLookup.y * -1.0;"),j.push("vec4 envColor;");for(var k=0,m=a.cubemap.layers.length;m>k;k++)l=a.cubemap.layers[k],j.push("envColor = textureCube(xeo_uCubeMapSampler"+k+", envLookup);"),j.push("color = mix(color, envColor.rgb, specular * xeo_uCubeMapIntensity"+k+");");j.push("}")}if(j.push("  vec4    fragColor;"),g){j.push("if (xeo_uBackfaceLighting || dot(viewNormalVec, xeo_vViewEyeVec) > 0.0) {"),j.push("  vec3    lightValue      = vec3(0.0, 0.0, 0.0);"),j.push("  vec3    specularValue   = vec3(0.0, 0.0, 0.0);"),j.push("  vec3    viewLightVec;"),j.push("  float   dotN;"),j.push("  float   lightDist;");for(var n,k=0,m=a.lights.lights.length;m>k;k++)n=a.lights.lights[k],"ambient"!==n.mode&&(j.push("viewLightVec = xeo_vViewLightVecAndDist"+k+".xyz;"),"point"===n.mode&&(j.push("dotN = max(dot(normalize(viewNormalVec), normalize(viewLightVec)), 0.0);"),j.push("lightDist = xeo_vViewLightVecAndDist"+k+".w;"),j.push("attenuation = 1.0 - (  xeo_uLightAttenuation"+k+"[0] +   xeo_uLightAttenuation"+k+"[1] * lightDist +   xeo_uLightAttenuation"+k+"[2] * lightDist * lightDist);"),n.diffuse&&(j.push("if (xeo_uDiffuse) {"),j.push("      lightValue += dotN * xeo_uLightColor"+k+" * attenuation;"),j.push("}")),n.specular&&(j.push("if (xeo_uSpecularLighting) {"),j.push("    specularValue += specularColor * xeo_uLightColor"+k+" * specular * pow(max(dot(reflect(normalize(-viewLightVec), normalize(-viewNormalVec)), normalize(-xeo_vViewVertex.xyz)), 0.0), shininess) * attenuation;"),j.push("}"))),"dir"===n.mode&&(j.push("dotN = max(dot(normalize(viewNormalVec), normalize(viewLightVec)), 0.0);"),n.diffuse&&(j.push("if (xeo_uDiffuse) {"),j.push("      lightValue += dotN * xeo_uLightColor"+k+";"),j.push("}")),n.specular&&(j.push("if (xeo_uSpecularLighting) {"),j.push("    specularValue += specularColor * xeo_uLightColor"+k+" * specular * pow(max(dot(reflect(normalize(-viewLightVec), normalize(-viewNormalVec)), normalize(-xeo_vViewVertex.xyz)), 0.0), shininess);"),j.push("}"))));j.push("      fragColor = vec4((specularValue.rgb + color.rgb * (lightValue.rgb + ambient.rgb)) + (emit * color.rgb), alpha);"),j.push("   } else {"),j.push("      fragColor = vec4((color.rgb + (emit * color.rgb)) *  (vec3(1.0, 1.0, 1.0) + ambient.rgb), alpha);"),j.push("   }")}else j.push("fragColor = vec4((color.rgb + (emit * color.rgb)) *  (vec3(1.0, 1.0, 1.0) + ambient.rgb), alpha);");return d.pixelColor&&j.push("fragColor="+d.pixelColor+"(fragColor);"),j.push("    if (xeo_uDepthMode) {"),j.push("          float depth = length(xeo_vViewVertex) / (xeo_uZFar - xeo_uZNear);"),j.push("          const vec4 bias = vec4(1.0 / 255.0,"),j.push("          1.0 / 255.0,"),j.push("          1.0 / 255.0,"),j.push("          0.0);"),j.push("          float r = depth;"),j.push("          float g = fract(r * 255.0);"),j.push("          float b = fract(g * 255.0);"),j.push("          float a = fract(b * 255.0);"),j.push("          vec4 colour = vec4(r, g, b, a);"),j.push("          gl_FragColor = colour - (colour.yzww * bias);"),j.push("    } else {"),j.push("          gl_FragColor = fragColor;"),j.push("    };"),j.push("}"),j.join("\n")}}}(),function(){"use strict";XEO.renderer.RenderContext=function(a){this._frameCtx=a},XEO.renderer.RenderContext.prototype.getCameraMatrix=function(){return this._frameCtx.cameraMat},XEO.renderer.RenderContext.prototype.getViewMatrix=function(){return this._frameCtx.viewMat},XEO.renderer.RenderContext.prototype.getModelMatrix=function(){return this._frameCtx.modelMat},XEO.renderer.RenderContext.prototype.getCanvasPos=function(a){this.getProjPos(a);var b=this._frameCtx.canvas.canvas,c=b.width,d=b.height,e=this._pc,f=e[0]/e[3]*c*.5,g=e[1]/e[3]*d*.5;return{x:f+.5*c,y:d-g-.5*d}},XEO.renderer.RenderContext.prototype.getCameraPos=function(a){return this.getProjPos(a),this._camPos=XEO.math.normalizeVec3(this._pc,[0,0,0]),{x:this._camPos[0],y:this._camPos[1],z:this._camPos[2]}},XEO.renderer.RenderContext.prototype.getProjPos=function(a){return this.getViewPos(a),this._pc=XEO.math.transformPoint3(this._frameCtx.cameraMat,this._vc),{x:this._pc[0],y:this._pc[1],z:this._pc[2],w:this._pc[3]}},XEO.renderer.RenderContext.prototype.getViewPos=function(a){return this.getWorldPos(a),this._vc=XEO.math.transformPoint3(this._frameCtx.viewMat,this._wc),{x:this._vc[0],y:this._vc[1],z:this._vc[2],w:this._vc[3]}},XEO.renderer.RenderContext.prototype.getWorldPos=function(a){return this._wc=XEO.math.transformPoint3(this._frameCtx.modelMat,a||[0,0,0]),{x:this._wc[0],y:this._wc[1],z:this._wc[2],w:this._wc[3]}}}(),function(){"use strict";XEO.renderer.ChunkFactory=function(){this._chunks={},this.chunkTypes=XEO.renderer.ChunkFactory.chunkTypes},XEO.renderer.ChunkFactory.chunkTypes={},XEO.renderer.ChunkFactory._freeChunks={},XEO.renderer.ChunkFactory.createChunkType=function(a){if(!a.type)throw"'type' expected in params";var b=XEO.Chunk,c=function(){this.useCount=0,this.init.apply(this,arguments)};return c.prototype=new b,c.prototype.constructor=c,a.drawAndPick&&(a.draw=a.pick=a.drawAndPick),XEO.renderer.ChunkFactory.chunkTypes[a.type]=c,XEO._apply(a,c.prototype),XEO.renderer.ChunkFactory._freeChunks[a.type]={chunks:[],chunksLen:0},c},XEO.renderer.ChunkFactory.prototype.getChunk=function(a,b,c,d,e){var f=XEO.renderer.ChunkFactory.chunkTypes[b];if(!f)throw"chunk type not supported: '"+b+"'";var g=this._chunks[a];if(g)return g.useCount++,g;var h=XEO.renderer.ChunkFactory._freeChunks[b];return h.chunksLen>0&&(g=h.chunks[--h.chunksLen]),g?g.init(a,c,d,e):g=new f(a,c,d,e),g.type=b,g.useCount=1,this._chunks[a]=g,g},XEO.renderer.ChunkFactory.prototype.putChunk=function(a){if(0!==a.useCount&&--a.useCount<=0){a.recycle&&a.recycle(),this._chunks[a.id]=null;var b=XEO.renderer.ChunkFactory._freeChunks[a.type];b.chunks[b.chunksLen++]=a}},XEO.renderer.ChunkFactory.prototype.webglRestored=function(){var a;for(var b in this._chunks)this._chunks.hasOwnProperty(b)&&(a=this._chunks[b],a.build&&a.build())}}();