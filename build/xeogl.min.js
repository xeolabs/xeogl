/*
 * xeogl V1.0.0
 *
 * A WebGL-based 3D visualization engine from xeoLabs
 * http://xeogl.org/
 *
 * Built on 2016-11-23
 *
 * MIT License
 * Copyright 2016, Lindsay Kay
 * http://xeolabs.com/
 *
 */

!function(){"use strict";var a=function(){this.version=null,this.WEBGL_INFO=function(){var a={WEBGL:!1},b=document.createElement("canvas");if(!b)return a;var c=b.getContext("webgl",{antialias:!0})||b.getContext("experimental-webgl",{antialias:!0});return a.WEBGL=!!c,a.WEBGL?(a.ANTIALIAS=c.getContextAttributes().antialias,c.getShaderPrecisionFormat?c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.HIGH_FLOAT).precision>0?a.FS_MAX_FLOAT_PRECISION="highp":c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.MEDIUM_FLOAT).precision>0?a.FS_MAX_FLOAT_PRECISION="mediump":a.FS_MAX_FLOAT_PRECISION="lowp":a.FS_MAX_FLOAT_PRECISION="mediump",a.DEPTH_BUFFER_BITS=c.getParameter(c.DEPTH_BITS),a.MAX_TEXTURE_SIZE=c.getParameter(c.MAX_TEXTURE_SIZE),a.MAX_CUBE_MAP_SIZE=c.getParameter(c.MAX_CUBE_MAP_TEXTURE_SIZE),a.MAX_RENDERBUFFER_SIZE=c.getParameter(c.MAX_RENDERBUFFER_SIZE),a.MAX_TEXTURE_UNITS=c.getParameter(c.MAX_COMBINED_TEXTURE_IMAGE_UNITS),a.MAX_VERTEX_ATTRIBS=c.getParameter(c.MAX_VERTEX_ATTRIBS),a.MAX_VERTEX_UNIFORM_VECTORS=c.getParameter(c.MAX_VERTEX_UNIFORM_VECTORS),a.MAX_FRAGMENT_UNIFORM_VECTORS=c.getParameter(c.MAX_FRAGMENT_UNIFORM_VECTORS),a.MAX_VARYING_VECTORS=c.getParameter(c.MAX_VARYING_VECTORS),a.SUPPORTED_EXTENSIONS={},c.getSupportedExtensions().forEach(function(b){a.SUPPORTED_EXTENSIONS[b]=!0}),a):a}(),this.stats={build:{version:a.version},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,entities:0},memory:{meshes:0,positions:0,colors:0,normals:0,tangents:0,uvs:0,indices:0,textures:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,tasksRun:0,tasksScheduled:0}},this._sceneIDMap=null,this._scene=null,this.scenes={},this._superTypes={},this._taskQueue=[];var b=this;!function(){function a(){g=Date.now();var a=b._runScheduledTasks(g+k),c=b._taskQueue.length;b.stats.frame.tasksRun=a,b.stats.frame.tasksScheduled=c,b.stats.frame.tasksBudget=k,j.time=g;for(h in b.scenes)b.scenes.hasOwnProperty(h)&&(i=b.scenes[h],j.sceneId=h,j.startTime=i.startTime,j.deltaTime=null!=j.prevTime?j.time-j.prevTime:0,i.fire("tick",j,!0));j.prevTime=g}function c(){var a=b.scenes,c=!1;for(h in a)a.hasOwnProperty(h)&&a[h].render(c)}var d,e,f,g,h,i,j={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},k=10,l=0,m=[],n=30,o=0,p=function(){d=Date.now(),l>0&&(e=d-l,f=1e3/e,o+=f,m.push(f),m.length>=n&&(o-=m.shift()),b.stats.frame.fps=Math.round(o/m.length)),a(),c(),l=d,window.requestAnimationFrame(p)};window.requestAnimationFrame(p)}()};a.prototype={constructor:a,get scene(){return this._scene||(this._scene=new window.xeogl.Scene({id:"default.scene"}))},_addScene:function(b){if(this._sceneIDMap=this._sceneIDMap||new window.xeogl.utils.Map,b.id){if(this.scenes[b.id])return void console.error("[ERROR] Scene "+a._inQuotes(b.id)+" already exists")}else b.id=this._sceneIDMap.addItem(b);this.scenes[b.id]=b,this.stats.components.scenes++;var c=this;b.on("destroyed",function(){c._sceneIDMap.removeItem(b.id),delete c.scenes[b.id],c.stats.components.scenes--})},scheduleTask:function(a,b){this._taskQueue.push(a),this._taskQueue.push(b)},deferTask:function(a,b){b?a.call(b):a()},_runScheduledTasks:function(a){for(var b,c,d=(new Date).getTime(),e=this._taskQueue,f=0;e.length>0&&d<a;)b=e.shift(),c=e.shift(),c?b.call(c):b(),d=(new Date).getTime(),f++;return f},clear:function(){var a;for(var b in this.scenes)this.scenes.hasOwnProperty(b)&&(a=this.scenes[b],"default.scene"===b?a.clear():a.destroy());this.scenes={}},_isArray:function(a){return a&&!a.propertyIsEnumerable("length")&&"object"==typeof a&&"number"==typeof a.length},_isString:function(a){return"string"==typeof a||a instanceof String},_isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},_isID:function(b){return a._isString(b)||a._isNumeric(b)},_isSameComponent:function(b,c){if(!b||!c)return!1;var d=a.prototype._isNumeric(b)||a.prototype._isString(b)?""+b:b.id,e=a.prototype._isNumeric(c)||a.prototype._isString(c)?""+c:c.id;return d===e},_isFunction:function(a){return"function"==typeof a},_isObject:function(){var a={}.constructor;return function(b){return!!b&&b.constructor===a}}(),_isComponentType:function(a,b){if(b=b||"xeogl.Component",a===b)return!0;var c=this._superTypes[a];if(!c)return!1;for(var d=c.length-1;d>=0;d--)if(c[d]===b)return!0;return!1},_copy:function(a){return this._apply(a,{})},_apply:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_apply2:function(a,b){for(var c in a)a.hasOwnProperty(c)&&void 0!==a[c]&&null!==a[c]&&(b[c]=a[c]);return b},_applyIf:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(void 0!==b[c]&&null!==b[c]||(b[c]=a[c]));return b},_isEmptyObject:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},_inQuotes:function(a){return this._isNumeric(a)?""+a:"'"+a+"'"}},window.xeogl=window.xeogl=new a}();var Canvas2Image=function(){var a=document.createElement("canvas"),b=String.fromCharCode,c="image/octet-stream",d=!1;if(!a.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var e=!!a.getContext("2d").getImageData,f=!!a.toDataURL,g=!!window.btoa,h=function(a){var b=parseInt(a.width),c=parseInt(a.height);return a.getContext("2d").getImageData(0,0,b,c)},i=function(a){var c,d,e="";if("string"==typeof a)e=a;else for(d=a,c=0;c<d.length;c++)e+=b(d[c]);return btoa(e)},j=function(a){var c="",d=a.width,e=a.height;c+="BM";var f=d*e*4+54;c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),c+=b(0,0,0,0,54,0,0,0),c+=b(40,0,0,0);var g=d;c+=b(g%256),g=Math.floor(g/256),c+=b(g%256),g=Math.floor(g/256),c+=b(g%256),g=Math.floor(g/256),c+=b(g%256);var h=e;c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),c+=b(1,0,32,0),c+=b(0,0,0,0);var j=d*e*4;c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),c+=b(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var k,l,m,n,o=a.data,p="",q=e;do{for(m=d*(q-1)*4,n="",k=0;k<d;k++)l=4*k,n+=b(o[m+l+2],o[m+l+1],o[m+l],o[m+l+3]);p+=n}while(--q);return i(c+p)},k=function(a){window.open(a)||(document.location.href=a)},l=function(a,b){return"data:"+b+";base64,"+a},m=function(a){var b=document.createElement("img");return b.src=a,b},n=function(a,b,c){if(b&&c){var d=document.createElement("canvas");d.width=b,d.height=c,d.style.width=b+"px",d.style.height=c+"px";var e=d.getContext("2d");return e.drawImage(a,0,0,a.width,a.height,0,0,b,b),d}return a};return{saveAsPNG:function(a,b,e,g){if(!f)return!1;var h=n(a,e,g),i="image/png",j=h.toDataURL(i);return b?m(j):(k(d?j.replace(i,c):j),!0)},saveAsJPEG:function(a,b,e,g){if(!f)return!1;var h=n(a,e,g),i="image/jpeg",j=h.toDataURL(i);return 5==j.indexOf(i)&&(b?m(j):(k(d?j.replace(i,c):j),!0))},saveAsBMP:function(a,b,c,d){if(!(f&&e&&g))return!1;var i=n(a,c,d),o="image/bmp",p=h(i),q=j(p);return b?m(l(q,o)):(k(l(q,o)),!0)}}}();!function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(d){function e(){!a&&this.__init&&this.__init.apply(this,arguments)}var f=this.prototype;a=!0;var g=new this;a=!1;for(var h in d)if("_props"!==h)g[h]="function"==typeof d[h]&&"function"==typeof f[h]&&b.test(d[h])?function(a,b){return function(){var c=this._super;this._super=f[a];var d=b.apply(this,arguments);return this._super=c,d}}(h,d[h]):d[h];else{var i,j=d[h];for(var k in j)i=j[k],i.set||!function(){var a=k;i.set=function(){this.warn("Property '"+a+"' is read-only, ignoring assignment")}}(),i.enumerable=!0,Object.defineProperty(g,k,i)}return g.superTypes=f.superTypes?f.superTypes.concat(f.type):[],d.type?xeogl._superTypes[d.type]=g.superTypes:d.type=f.type+"_"+c(),e.prototype=g,e.prototype.constructor=e,e.extend=arguments.callee,window[d.type]=e,e};var c=function(){var a,b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c=new Array(36),d=0;return function(){for(var e=0;e<36;e++)8===e||13===e||18===e||23===e?c[e]="-":14===e?c[e]="4":(d<=2&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19===e?3&a|8:a]);return c.join("")}}()}(),function(){"use strict";xeogl.utils=xeogl.utils||{},xeogl.utils.Map=function(a,b){this.items=a||[],b=b||0;var c=b+1;this.addItem=function(){var a;if(2===arguments.length){var b=arguments[0];if(a=arguments[1],this.items[b])throw"ID clash: '"+b+"'";return this.items[b]=a,b}for(;;){a=arguments[0]||{};var d=c++;if(!this.items[d])return this.items[d]=a,d}},this.removeItem=function(a){var b=this.items[a];return delete this.items[a],b}}}(),function(){"use strict";var a=new Float32Array(16),b=new Float32Array(16),c=new Float32Array(4),d=xeogl.math={DEGTORAD:.0174532925,vec2:function(a){return new Float32Array(a||2)},vec3:function(a){return new Float32Array(a||3)},vec4:function(a){return new Float32Array(a||4)},mat3:function(a){return new Float32Array(a||9)},mat3ToMat4:function(a,b){},mat4:function(a){return new Float32Array(a||16)},mat4ToMat3:function(a,b){},createUUID:function(){var a,b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c=new Array(36),d=0;return function(){for(var e=0;e<36;e++)8===e||13===e||18===e||23===e?c[e]="-":14===e?c[e]="4":(d<=2&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19===e?3&a|8:a]);return c.join("")}}(),clamp:function(a,b,c){return Math.max(b,Math.min(c,a))},fmod:function(a,b){if(a<b)return console.error("xeogl.math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),a;for(;b<=a;)a-=b;return a},negateVec4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b},addVec4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c},addVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c},addVec3:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c},addVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c},subVec4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c},subVec3:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c},subVec2:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c},subVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c},subScalarVec4:function(a,b,c){return c||(c=a),c[0]=b-a[0],c[1]=b-a[1],c[2]=b-a[2],c[3]=b-a[3],c},mulVec4:function(a,b,c){return c||(c=a),c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3],c},mulVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c},mulVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c},mulVec2Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c},divVec3:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c},divVec4:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c[3]=a[3]/b[3],c},divScalarVec3:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c},divVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c},divVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c[3]=a[3]/b,c},divScalarVec4:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c[3]=a/b[3],c},dotVec4:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},cross3Vec4:function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2];return[d*h-e*g,e*f-c*h,c*g-d*f,0]},cross3Vec3:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=b[0],h=b[1],i=b[2];return c[0]=e*i-f*h,c[1]=f*g-d*i,c[2]=d*h-e*g,c},sqLenVec4:function(a){return d.dotVec4(a,a)},lenVec4:function(a){return Math.sqrt(d.sqLenVec4(a))},dotVec3:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},dotVec2:function(a,b){return a[0]*b[0]+a[1]*b[1]},sqLenVec3:function(a){return d.dotVec3(a,a)},sqLenVec2:function(a){return d.dotVec2(a,a)},lenVec3:function(a){return Math.sqrt(d.sqLenVec3(a))},lenVec2:function(a){return Math.sqrt(d.sqLenVec2(a))},rcpVec3:function(a,b){return d.divScalarVec3(1,a,b)},normalizeVec4:function(a,b){var c=1/d.lenVec4(a);return d.mulVec4Scalar(a,c,b)},normalizeVec3:function(a,b){var c=1/d.lenVec3(a);return d.mulVec3Scalar(a,c,b)},normalizeVec2:function(a,b){var c=1/d.lenVec2(a);return d.mulVec2Scalar(a,c,b)},vec3FromMat4Scale:function(){var a=new Float32Array(3);return function(b,c){return a[0]=b[0],a[1]=b[1],a[2]=b[2],c[0]=d.lenVec3(a),a[0]=b[4],a[1]=b[5],a[2]=b[6],c[1]=d.lenVec3(a),a[0]=b[8],a[1]=b[9],a[2]=b[10],c[2]=d.lenVec3(a),c}}(),dupMat4:function(a){return a.slice(0,16)},mat4To3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},m4s:function(a){return[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a]},setMat4ToZeroes:function(){return d.m4s(0)},setMat4ToOnes:function(){return d.m4s(1)},diagonalMat4v:function(a){return new Float32Array([a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,a[3]])},diagonalMat4c:function(a,b,c,e){return d.diagonalMat4v([a,b,c,e])},diagonalMat4s:function(a){return d.diagonalMat4c(a,a,a,a)},identityMat4:function(a){return a=a||new Float32Array(16),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},isIdentityMat4:function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},negateMat4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b[4]=-a[4],b[5]=-a[5],b[6]=-a[6],b[7]=-a[7],b[8]=-a[8],b[9]=-a[9],b[10]=-a[10],b[11]=-a[11],b[12]=-a[12],b[13]=-a[13],b[14]=-a[14],b[15]=-a[15],b},addMat4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c[4]=a[4]+b[4],c[5]=a[5]+b[5],c[6]=a[6]+b[6],c[7]=a[7]+b[7],c[8]=a[8]+b[8],c[9]=a[9]+b[9],c[10]=a[10]+b[10],c[11]=a[11]+b[11],c[12]=a[12]+b[12],c[13]=a[13]+b[13],c[14]=a[14]+b[14],c[15]=a[15]+b[15],c},addMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c[4]=a[4]+b,c[5]=a[5]+b,c[6]=a[6]+b,c[7]=a[7]+b,c[8]=a[8]+b,c[9]=a[9]+b,c[10]=a[10]+b,c[11]=a[11]+b,c[12]=a[12]+b,c[13]=a[13]+b,c[14]=a[14]+b,c[15]=a[15]+b,c},addScalarMat4:function(a,b,c){return d.addMat4Scalar(b,a,c)},subMat4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c[4]=a[4]-b[4],c[5]=a[5]-b[5],c[6]=a[6]-b[6],c[7]=a[7]-b[7],c[8]=a[8]-b[8],c[9]=a[9]-b[9],c[10]=a[10]-b[10],c[11]=a[11]-b[11],c[12]=a[12]-b[12],c[13]=a[13]-b[13],c[14]=a[14]-b[14],c[15]=a[15]-b[15],c},subMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c[4]=a[4]-b,c[5]=a[5]-b,c[6]=a[6]-b,c[7]=a[7]-b,c[8]=a[8]-b,c[9]=a[9]-b,c[10]=a[10]-b,c[11]=a[11]-b,c[12]=a[12]-b,c[13]=a[13]-b,c[14]=a[14]-b,c[15]=a[15]-b,c},subScalarMat4:function(a,b,c){return c||(c=b),c[0]=a-b[0],c[1]=a-b[1],c[2]=a-b[2],c[3]=a-b[3],c[4]=a-b[4],c[5]=a-b[5],c[6]=a-b[6],c[7]=a-b[7],c[8]=a-b[8],c[9]=a-b[9],c[10]=a-b[10],c[11]=a-b[11],c[12]=a-b[12],c[13]=a-b[13],c[14]=a-b[14],c[15]=a-b[15],c},mulMat4:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];return c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s,c},mulMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c[4]=a[4]*b,c[5]=a[5]*b,c[6]=a[6]*b,c[7]=a[7]*b,c[8]=a[8]*b,c[9]=a[9]*b,c[10]=a[10]*b,c[11]=a[11]*b,c[12]=a[12]*b,c[13]=a[13]*b,c[14]=a[14]*b,c[15]=a[15]*b,c},mulMat4v4:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},transposeMat4:function(a,b){var c=a[4],d=a[14],e=a[8],f=a[13],g=a[12],h=a[9];if(!b||a===b){var i=a[1],j=a[2],k=a[3],l=a[6],m=a[7],n=a[11];return a[1]=c,a[2]=e,a[3]=g,a[4]=i,a[6]=h,a[7]=f,a[8]=j,a[9]=l,a[11]=d,a[12]=k,a[13]=m,a[14]=n,a}return b[0]=a[0],b[1]=c,b[2]=e,b[3]=g,b[4]=a[1],b[5]=a[5],b[6]=h,b[7]=f,b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=d,b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},determinantMat4:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},inverseMat4:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=1/(s*D-t*C+u*B+v*A-w*z+x*y);return b[0]=(h*D-i*C+j*B)*E,b[1]=(-d*D+e*C-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(-l*x+m*w-n*v)*E,b[4]=(-g*D+i*A-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(-o*x+q*u-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(-c*C+d*A-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(-k*w+l*u-n*s)*E,b[12]=(-g*B+h*z-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(-o*v+p*t-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b},traceMat4:function(a){return a[0]+a[5]+a[10]+a[15]},translationMat4v:function(a,b){var c=b||d.identityMat4();return c[12]=a[0],c[13]=a[1],c[14]=a[2],c},translationMat4c:function(){var a=new Float32Array(3);return function(b,c,e,f){return a[0]=b,a[1]=c,a[2]=e,d.translationMat4v(a,f)}}(),translationMat4s:function(a,b){return d.translationMat4c(a,a,a,b)},translateMat4v:function(a,b){return d.translateMat4c(a[0],a[1],a[2],b)},OLDtranslateMat4c:function(a,b,c,d){var e=d[12];d[0]+=e*a,d[4]+=e*b,d[8]+=e*c;var f=d[13];d[1]+=f*a,d[5]+=f*b,d[9]+=f*c;var g=d[14];d[2]+=g*a,d[6]+=g*b,d[10]+=g*c;var h=d[15];return d[3]+=h*a,d[7]+=h*b,d[11]+=h*c,d},translateMat4c:function(a,b,c,d){var e=d[3];d[0]+=e*a,d[1]+=e*b,d[2]+=e*c;var f=d[7];d[4]+=f*a,d[5]+=f*b,d[6]+=f*c;var g=d[11];d[8]+=g*a,d[9]+=g*b,d[10]+=g*c;var h=d[15];return d[12]+=h*a,d[13]+=h*b,d[14]+=h*c,d},rotationMat4v:function(a,b,c){var e,f,g,h,i,j,k=d.normalizeVec4([b[0],b[1],b[2],0],[]),l=Math.sin(a),m=Math.cos(a),n=1-m,o=k[0],p=k[1],q=k[2];return e=o*p,f=p*q,g=q*o,h=o*l,i=p*l,j=q*l,c=c||d.mat4(),c[0]=n*o*o+m,c[1]=n*e+j,c[2]=n*g-i,c[3]=0,c[4]=n*e-j,c[5]=n*p*p+m,c[6]=n*f+h,c[7]=0,c[8]=n*g+i,c[9]=n*f-h,c[10]=n*q*q+m,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,c},rotationMat4c:function(a,b,c,e,f){return d.rotationMat4v(a,[b,c,e],f)},scalingMat4v:function(a,b){return b=b||d.identityMat4(),b[0]=a[0],b[5]=a[1],b[10]=a[2],b},scalingMat4c:function(){var a=new Float32Array(3);return function(b,c,e,f){return a[0]=b,a[1]=c,a[2]=e,d.scalingMat4v(a,f)}}(),scaleMat4c:function(a,b,c,d){return d[0]*=a,d[4]*=b,d[8]*=c,d[1]*=a,d[5]*=b,d[9]*=c,d[2]*=a,d[6]*=b,d[10]*=c,d[3]*=a,d[7]*=b,d[11]*=c,d},scaleMat4v:function(a,b){var c=a[0],d=a[1],e=a[2];return b[0]*=c,b[4]*=d,b[8]*=e,b[1]*=c,b[5]*=d,b[9]*=e,b[2]*=c,b[6]*=d,b[10]*=e,b[3]*=c,b[7]*=d,b[11]*=e,b},scalingMat4s:function(a){return d.scalingMat4c(a,a,a)},rotationTranslationMat4:function(a,b,c){c=c||d.mat4();var e=a[0],f=a[1],g=a[2],h=a[3],i=e+e,j=f+f,k=g+g,l=e*i,m=e*j,n=e*k,o=f*j,p=f*k,q=g*k,r=h*i,s=h*j,t=h*k;return c[0]=1-(o+q),c[1]=m+t,c[2]=n-s,c[3]=0,c[4]=m-t,c[5]=1-(l+q),c[6]=p+r,c[7]=0,c[8]=n+s,c[9]=p-r,c[10]=1-(l+o),c[11]=0,c[12]=b[0],c[13]=b[1],c[14]=b[2],c[15]=1,c},mat4ToEuler:function(a,b,c){c=c||d.vec4();var e=d.clamp,f=a[0],g=a[4],h=a[8],i=a[1],j=a[5],k=a[9],l=a[2],m=a[6],n=a[10];return"XYZ"===b?(c[1]=Math.asin(e(h,-1,1)),Math.abs(h)<.99999?(c[0]=Math.atan2(-k,n),c[2]=Math.atan2(-g,f)):(c[0]=Math.atan2(m,j),c[2]=0)):"YXZ"===b?(c[0]=Math.asin(-e(k,-1,1)),Math.abs(k)<.99999?(c[1]=Math.atan2(h,n),c[2]=Math.atan2(i,j)):(c[1]=Math.atan2(-l,f),c[2]=0)):"ZXY"===b?(c[0]=Math.asin(e(m,-1,1)),Math.abs(m)<.99999?(c[1]=Math.atan2(-l,n),c[2]=Math.atan2(-g,j)):(c[1]=0,c[2]=Math.atan2(i,f))):"ZYX"===b?(c[1]=Math.asin(-e(l,-1,1)),Math.abs(l)<.99999?(c[0]=Math.atan2(m,n),c[2]=Math.atan2(i,f)):(c[0]=0,c[2]=Math.atan2(-g,j))):"YZX"===b?(c[2]=Math.asin(e(i,-1,1)),Math.abs(i)<.99999?(c[0]=Math.atan2(-k,j),c[1]=Math.atan2(-l,f)):(c[0]=0,c[1]=Math.atan2(h,n))):"XZY"===b&&(c[2]=Math.asin(-e(g,-1,1)),Math.abs(g)<.99999?(c[0]=Math.atan2(m,j),c[1]=Math.atan2(h,f)):(c[0]=Math.atan2(-k,n),c[1]=0)),c},lookAtMat4v:function(a,b,c,e){e||(e=d.mat4());var f=a[0],g=a[1],h=a[2],i=c[0],j=c[1],k=c[2],l=b[0],m=b[1],n=b[2];if(f===l&&g===m&&h===n)return d.identityMat4();var o,p,q,r,s,t,u,v,w,x;return o=f-l,p=g-m,q=h-n,x=1/Math.sqrt(o*o+p*p+q*q),o*=x,p*=x,q*=x,r=j*q-k*p,s=k*o-i*q,t=i*p-j*o,x=Math.sqrt(r*r+s*s+t*t),x?(x=1/x,r*=x,s*=x,t*=x):(r=0,s=0,t=0),u=p*t-q*s,v=q*r-o*t,w=o*s-p*r,x=Math.sqrt(u*u+v*v+w*w),x?(x=1/x,u*=x,v*=x,w*=x):(u=0,v=0,w=0),e[0]=r,e[1]=u,e[2]=o,e[3]=0,e[4]=s,e[5]=v,e[6]=p,e[7]=0,e[8]=t,e[9]=w,e[10]=q,e[11]=0,e[12]=-(r*f+s*g+t*h),e[13]=-(u*f+v*g+w*h),e[14]=-(o*f+p*g+q*h),e[15]=1,e},lookAtMat4c:function(a,b,c,e,f,g,h,i,j){return d.lookAtMat4v([a,b,c],[e,f,g],[h,i,j],[])},orthoMat4c:function(a,b,c,e,f,g,h){h||(h=d.mat4());var i=b-a,j=e-c,k=g-f;return h[0]=2/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2/j,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=-2/k,h[11]=0,h[12]=-(a+b)/i,h[13]=-(e+c)/j,h[14]=-(g+f)/k,h[15]=1,h},frustumMat4v:function(c,e,f){f||(f=d.mat4());var g=[c[0],c[1],c[2],0],h=[e[0],e[1],e[2],0];d.addVec4(h,g,a),d.subVec4(h,g,b);var i=2*g[2],j=b[0],k=b[1],l=b[2];return f[0]=i/j,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=i/k,f[6]=0,f[7]=0,f[8]=a[0]/j,f[9]=a[1]/k,f[10]=-a[2]/l,f[11]=-1,f[12]=0,f[13]=0,f[14]=-i*h[2]/l,f[15]=0,f},frustumMat4:function(a,b,c,e,f,g,h){h||(h=d.mat4());var i=b-a,j=e-c,k=g-f;return h[0]=2*f/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2*f/j,h[6]=0,h[7]=0,h[8]=(b+a)/i,h[9]=(e+c)/j,h[10]=-(g+f)/k,h[11]=-1,h[12]=0,h[13]=0,h[14]=-(g*f*2)/k,h[15]=0,h},perspectiveMat4:function(a,b,c,e,f){var g=[],h=[];return g[2]=c,h[2]=e,h[1]=g[2]*Math.tan(a/2),g[1]=-h[1],h[0]=h[1]*b,g[0]=-h[0],d.frustumMat4v(g,h,f)},transformPoint3:function(a,b,c){return c=c||d.vec3(),c[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12],c[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13],c[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14],c},transformPoint4:function(a,b,c){return c=c||d.vec4(),c[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3],c[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3],c[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3],c[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3],c},transformPoints3:function(a,b,c){for(var d,e,f,g,h,i=c||[],j=b.length,k=a[0],l=a[1],m=a[2],n=a[3],o=a[4],p=a[5],q=a[6],r=a[7],s=a[8],t=a[9],u=a[10],v=a[11],w=a[12],x=a[13],y=a[14],z=a[15],A=0;A<j;++A)g=b[A],d=g[0],e=g[1],f=g[2],h=i[A]||(i[A]=[0,0,0]),h[0]=k*d+o*e+s*f+w,h[1]=l*d+p*e+t*f+x,h[2]=m*d+q*e+u*f+y,h[3]=n*d+r*e+v*f+z;return i.length=j,i},transformPositions3:function(a,b,c){c=c||b;var d,e,f,g,h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15];for(d=0;d<h;d+=3)e=b[d+0],f=b[d+1],g=b[d+2],c[d+0]=i*e+m*f+q*g+u,c[d+1]=j*e+n*f+r*g+v,c[d+2]=k*e+o*f+s*g+w,c[d+3]=l*e+p*f+t*g+x;return c},transformVec3:function(a,b,c){var d=b[0],e=b[1],f=b[2];return c=c||this.vec3(),c[0]=a[0]*d+a[4]*e+a[8]*f,c[1]=a[1]*d+a[5]*e+a[9]*f,c[2]=a[2]*d+a[6]*e+a[10]*f,c},transformVec4:function(a,b,c){var e=b[0],f=b[1],g=b[2],h=b[3];return c=c||d.vec4(),c[0]=a[0]*e+a[4]*f+a[8]*g+a[12]*h,c[1]=a[1]*e+a[5]*f+a[9]*g+a[13]*h,c[2]=a[2]*e+a[6]*f+a[10]*g+a[14]*h,c[3]=a[3]*e+a[7]*f+a[11]*g+a[15]*h,c},rotateVec3X:function(a,b,c,d){var e=[],f=[];return e[0]=a[0]-b[0],e[1]=a[1]-b[1],e[2]=a[2]-b[2],f[0]=e[0],f[1]=e[1]*Math.cos(c)-e[2]*Math.sin(c),f[2]=e[1]*Math.sin(c)+e[2]*Math.cos(c),d[0]=f[0]+b[0],d[1]=f[1]+b[1],d[2]=f[2]+b[2],d},rotateVec3Y:function(a,b,c,d){var e=[],f=[];return e[0]=a[0]-b[0],e[1]=a[1]-b[1],e[2]=a[2]-b[2],f[0]=e[2]*Math.sin(c)+e[0]*Math.cos(c),f[1]=e[1],f[2]=e[2]*Math.cos(c)-e[0]*Math.sin(c),d[0]=f[0]+b[0],d[1]=f[1]+b[1],d[2]=f[2]+b[2],d},rotateVec3Z:function(a,b,c,d){var e=[],f=[];return e[0]=a[0]-b[0],e[1]=a[1]-b[1],e[2]=a[2]-b[2],f[0]=e[0]*Math.cos(c)-e[1]*Math.sin(c),f[1]=e[0]*Math.sin(c)+e[1]*Math.cos(c),f[2]=e[2],d[0]=f[0]+b[0],d[1]=f[1]+b[1],d[2]=f[2]+b[2],d},projectVec4:function(a,b){var c=1/a[3];return b=b||d.vec2(),b[0]=v[0]*c,b[1]=v[1]*c,b},lerpVec3:function(a,b,c,e,f,g){var h=g||d.vec3(),i=(a-b)/(c-b);return h[0]=e[0]+i*(f[0]-e[0]),h[1]=e[1]+i*(f[1]-e[1]),h[2]=e[2]+i*(f[2]-e[2]),h},flatten:function(a){var b,c,d,e,f,g=[];for(b=0,c=a.length;b<c;b++)for(f=a[b],d=0,e=f.length;d<e;d++)g.push(f[d]);return g},identityQuaternion:function(a){return a=a||d.vec4(),a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},eulerToQuaternion:function(a,b,c){c=c||d.vec4();var e=Math.cos(a[0]/2),f=Math.cos(a[1]/2),g=Math.cos(a[2]/2),h=Math.sin(a[0]/2),i=Math.sin(a[1]/2),j=Math.sin(a[2]/2);return"XYZ"===b?(c[0]=h*f*g+e*i*j,c[1]=e*i*g-h*f*j,c[2]=e*f*j+h*i*g,c[3]=e*f*g-h*i*j):"YXZ"===b?(c[0]=h*f*g+e*i*j,c[1]=e*i*g-h*f*j,c[2]=e*f*j-h*i*g,c[3]=e*f*g+h*i*j):"ZXY"===b?(c[0]=h*f*g-e*i*j,c[1]=e*i*g+h*f*j,c[2]=e*f*j+h*i*g,c[3]=e*f*g-h*i*j):"ZYX"===b?(c[0]=h*f*g-e*i*j,c[1]=e*i*g+h*f*j,c[2]=e*f*j-h*i*g,c[3]=e*f*g+h*i*j):"YZX"===b?(c[0]=h*f*g+e*i*j,c[1]=e*i*g+h*f*j,c[2]=e*f*j-h*i*g,c[3]=e*f*g-h*i*j):"XZY"===b&&(c[0]=h*f*g-e*i*j,c[1]=e*i*g-h*f*j,c[2]=e*f*j+h*i*g,c[3]=e*f*g+h*i*j),c},mat4ToQuaternion:function(a,b){b=b||d.vec4();var c,e=a[0],f=a[4],g=a[8],h=a[1],i=a[5],j=a[9],k=a[2],l=a[6],m=a[10],n=e+i+m;return n>0?(c=.5/Math.sqrt(n+1),b[3]=.25/c,b[0]=(l-j)*c,b[1]=(g-k)*c,b[2]=(h-f)*c):e>i&&e>m?(c=2*Math.sqrt(1+e-i-m),b[3]=(l-j)/c,b[0]=.25*c,b[1]=(f+h)/c,b[2]=(g+k)/c):i>m?(c=2*Math.sqrt(1+i-e-m),b[3]=(g-k)/c,b[0]=(f+h)/c,b[1]=.25*c,b[2]=(j+l)/c):(c=2*Math.sqrt(1+m-e-i),b[3]=(h-f)/c,b[0]=(g+k)/c,b[1]=(j+l)/c,b[2]=.25*c),b},vec3PairToQuaternion:function(a,b,c){c=c||d.vec4();var e=Math.sqrt(d.dotVec3(a,a)*d.dotVec3(b,b)),f=e+d.dotVec3(a,b);return f<1e-8*e?(f=0,Math.abs(a[0])>Math.abs(a[2])?(c[0]=-a[1],c[1]=a[0],c[2]=0):(c[0]=0,c[1]=-a[2],c[2]=a[1])):d.cross3Vec3(a,b,c),c[3]=f,d.normalizeQuaternion(c)},angleAxisToQuaternion:function(a,b){b=b||d.vec4();var c=a[3]/2,e=Math.sin(c);return b[0]=e*a[0],b[1]=e*a[1],b[2]=e*a[2],b[3]=Math.cos(c),b},quaternionToEuler:function(a,b,c){c=c||d.vec4();var e=a[3]/2,f=Math.sin(e);return c[0]=f*a[0],c[1]=f*a[1],c[2]=f*a[2],c[3]=Math.cos(e),c},mulQuaternions:function(a,b,c){c=c||d.vec4();var e=a[0],f=a[1],g=a[2],h=a[3],i=b[0],j=b[1],k=b[2],l=b[3];return c[0]=h*i+e*l+f*k-g*j,c[1]=h*j+f*l+g*i-e*k,c[2]=h*k+g*l+e*j-f*i,c[3]=h*l-e*i-f*j-g*k,c},vec3ApplyQuaternion:function(a,b,c){c=c||d.vec3();var e=b[0],f=b[1],g=b[2],h=a[0],i=a[1],j=a[2],k=a[3],l=k*e+i*g-j*f,m=k*f+j*e-h*g,n=k*g+h*f-i*e,o=-h*e-i*f-j*g;return c[0]=l*k+o*-h+m*-j-n*-i,c[1]=m*k+o*-i+n*-h-l*-j,c[2]=n*k+o*-j+l*-i-m*-h,c},quaternionToMat4:function(a,b){b=d.identityMat4(b);var c=a[0],e=a[1],f=a[2],g=a[3],h=2*c,i=2*e,j=2*f,k=h*g,l=i*g,m=j*g,n=h*c,o=i*c,p=j*c,q=i*e,r=j*e,s=j*f;return b[0]=1-(q+s),b[1]=o+m,b[2]=p-l,b[4]=o-m,b[5]=1-(n+s),b[6]=r+k,b[8]=p+l,b[9]=r-k,b[10]=1-(n+q),b},quaternionToRotationMat4:function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,l=c*i,m=d*h,n=d*i,o=e*i,p=f*g,q=f*h,r=f*i;return b[0]=1-(m+o),b[4]=k-r,b[8]=l+q,b[1]=k+r,b[5]=1-(j+o),b[9]=n-p,b[2]=l-q,b[6]=n+p,b[10]=1-(j+m),b[3]=0,b[7]=0,b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,b},normalizeQuaternion:function(a,b){b=b||a;var c=d.lenVec4([a[0],a[1],a[2],a[3]]);return b[0]=a[0]/c,b[1]=a[1]/c,b[2]=a[2]/c,b[3]=a[3]/c,b},conjugateQuaternion:function(a,b){return b=b||a,b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=a[3],b},inverseQuaternion:function(a,b){return d.normalizeQuaternion(d.conjugateQuaternion(a,b))},quaternionToAngleAxis:function(a,b){b=b||d.vec4(),a=d.normalizeQuaternion(a,c);var e=a[3],f=2*Math.acos(e),g=Math.sqrt(1-e*e);return g<.001?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=a[0]/g,b[0]=a[1]/g,b[0]=a[2]/g),b[3]=f,b}}}(),function(){"use strict";var a=xeogl.math;a.AABB3=function(a){return new Float32Array(a||6)},a.AABB2=function(a){return new Float32Array(a||4)},a.OBB3=function(a){return new Float32Array(a||32)},a.OBB2=function(a){return new Float32Array(a||16)},a.transformOBB3=function(a,b,c){c=c||b;var d,e,f,g,h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15];for(d=0;d<h;d+=4)e=b[d+0],f=b[d+1],g=b[d+2],c[d+0]=i*e+m*f+q*g+u,c[d+1]=j*e+n*f+r*g+v,c[d+2]=k*e+o*f+s*g+w,c[d+3]=l*e+p*f+t*g+x;return c},a.getAABB3Diag=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3);return function(e){return b[0]=e[0],b[1]=e[1],b[2]=e[2],c[0]=e[3],c[1]=e[4],c[2]=e[5],a.subVec3(c,b,d),Math.abs(a.lenVec3(d))}}(),a.getAABB3DiagPoint=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3);return function(e,f){b[0]=e[0],b[1]=e[1],b[2]=e[2],c[0]=e[3],c[1]=e[4],c[2]=e[5];var g=a.subVec3(c,b,d),h=f[0]-e[0],i=e[3]-f[0],j=f[1]-e[1],k=e[4]-f[1],l=f[2]-e[2],m=e[5]-f[2];return g[0]+=h>i?h:i,g[1]+=j>k?j:k,g[2]+=l>m?l:m,Math.abs(a.lenVec3(g))}}(),a.getAABB3Center=function(b,c){var d=c||a.vec3();return d[0]=.5*(b[3]+b[0]),d[1]=.5*(b[4]+b[1]),d[2]=.5*(b[5]+b[2]),d},a.getAABB2Center=function(b,c){var d=c||a.vec2();return d[0]=(b[2]+b[0])/2,d[1]=(b[3]+b[1])/2,d},a.collapseAABB3=function(b){return b=b||a.AABB3(),b[0]=1e7,b[1]=1e7,b[2]=1e7,b[3]=-1e7,b[4]=-1e7,b[5]=-1e7,b},a.AABB3ToOBB3=function(b,c){return c=c||a.OBB3(),c[0]=b[0],c[1]=b[1],c[2]=b[2],c[3]=1,c[4]=b[3],c[5]=b[1],c[6]=b[2],c[7]=1,c[8]=b[3],c[9]=b[4],c[10]=b[2],c[11]=1,c[12]=b[0],c[13]=b[4],c[14]=b[2],c[15]=1,c[16]=b[0],c[17]=b[1],c[18]=b[5],c[19]=1,c[20]=b[3],c[21]=b[1],c[22]=b[5],c[23]=1,c[24]=b[3],c[25]=b[4],c[26]=b[5],c[27]=1,c[28]=b[0],c[29]=b[4],c[30]=b[5],c[31]=1,c},a.positions3ToAABB3=function(b,c){c=c||a.AABB3();for(var d,e,f,g=1e5,h=1e5,i=1e5,j=-1e5,k=-1e5,l=-1e5,m=0,n=b.length;m<n;m+=3)d=b[m+0],e=b[m+1],f=b[m+2],d<g&&(g=d),e<h&&(h=e),f<i&&(i=f),d>j&&(j=d),e>k&&(k=e),f>l&&(l=f);return c[0]=g,c[1]=h,c[2]=i,c[3]=j,c[4]=k,c[5]=l,c},a.OBB3ToAABB3=function(b,c){c=c||a.AABB3();for(var d,e,f,g=1e5,h=1e5,i=1e5,j=-1e5,k=-1e5,l=-1e5,m=0,n=b.length;m<n;m+=4)d=b[m+0],e=b[m+1],f=b[m+2],d<g&&(g=d),e<h&&(h=e),f<i&&(i=f),d>j&&(j=d),e>k&&(k=e),f>l&&(l=f);return c[0]=g,c[1]=h,c[2]=i,c[3]=j,c[4]=k,c[5]=l,c},a.points3ToAABB3=function(b,c){c=c||a.AABB3();for(var d,e,f,g=1e5,h=1e5,i=1e5,j=-1e5,k=-1e5,l=-1e5,m=0,n=b.length;m<n;m++)d=b[m][0],e=b[m][1],f=b[m][2],d<g&&(g=d),e<h&&(h=e),f<i&&(i=f),d>j&&(j=d),e>k&&(k=e),f>l&&(l=f);return c[0]=g,c[1]=h,c[2]=i,c[3]=j,c[4]=k,c[5]=l,c},a.points3ToSphere3=function(){var b=new Float32Array(3);return function(c,d){d=d||a.vec4();var e,f=0,g=0,h=0,i=c.length;for(e=0;e<i;e++)f+=c[e][0],g+=c[e][1],h+=c[e][2];d[0]=f/i,d[1]=g/i,d[2]=h/i;var j,k=0;for(e=0;e<i;e++)j=Math.abs(a.lenVec3(a.subVec3(c[e],d,b))),j>k&&(k=j);return d[3]=k,d}}(),a.OBB3ToSphere3=function(){var b=new Float32Array(3),c=new Float32Array(3);return function(d,e){e=e||a.vec4();var f,g=0,h=0,i=0,j=d.length,k=j/4;for(f=0;f<j;f+=4)g+=d[f+0],h+=d[f+1],i+=d[f+2];e[0]=g/k,e[1]=h/k,e[2]=i/k;var l,m=0;for(f=0;f<j;f+=4)b[0]=d[f+0],b[1]=d[f+1],b[2]=d[f+2],l=Math.abs(a.lenVec3(a.subVec3(b,e,c))),l>m&&(m=l);return e[3]=m,e}}(),a.getSphere3Center=function(b,c){return c=c||a.vec3(),c[0]=b[0],c[1]=b[1],c[2]=b[2],c},a.expandAABB3=function(a,b){return a[0]>b[0]&&(a[0]=b[0]),a[1]>b[1]&&(a[1]=b[1]),a[2]>b[2]&&(a[2]=b[2]),a[3]<b[3]&&(a[3]=b[3]),a[4]<b[4]&&(a[4]=b[4]),a[5]<b[5]&&(a[5]=b[5]),a},a.expandAABB3Point3=function(a,b){return a[0]<b[0]&&(a[0]=b[0]),a[1]<b[1]&&(a[1]=b[1]),a[2]<b[2]&&(a[2]=b[2]),a[3]>b[0]&&(a[3]=b[0]),a[4]>b[1]&&(a[4]=b[1]),a[5]>b[2]&&(a[5]=b[2]),a},a.collapseAABB2=function(b){return b=b||a.AABB2(),b[0]=1e7,b[1]=1e7,
b[2]=-1e7,b[3]=-1e7,b},a.OBB3ToAABB2=function(b,c){c=c||a.AABB2();for(var d,e,f,g,h=1e7,i=1e7,j=-1e7,k=-1e7,l=0,m=b.length;l<m;l+=4)d=b[l+0],e=b[l+1],f=b[l+3]||1,g=1/f,d*=g,e*=g,d<h&&(h=d),e<i&&(i=e),d>j&&(j=d),e>k&&(k=e);return c[0]=h,c[1]=i,c[2]=j,c[3]=k,c},a.expandAABB2=function(a,b){return a[0]>b[0]&&(a[0]=b[0]),a[1]>b[1]&&(a[1]=b[1]),a[2]<b[2]&&(a[2]=b[2]),a[3]<b[3]&&(a[3]=b[3]),a},a.expandAABB2Point2=function(a,b){return a[0]>b[0]&&(a[0]=b[0]),a[1]>b[1]&&(a[1]=b[1]),a[2]<b[0]&&(a[2]=b[0]),a[3]<b[1]&&(a[3]=b[1]),a},a.AABB2ToCanvas=function(a,b,c,d){d=d||a;var e=.5*(a[0]+1),f=.5*(a[1]+1),g=.5*(a[2]+1),h=.5*(a[3]+1);return d[0]=Math.floor(e*b),d[1]=c-Math.floor(h*c),d[2]=Math.floor(g*b),d[3]=c-Math.floor(f*c),d}}(),function(){"use strict";var a=xeogl.math;a.triangleNormal=function(b,c,d,e){e=e||a.vec3();var f=c[0]-b[0],g=c[1]-b[1],h=c[2]-b[2],i=d[0]-b[0],j=d[1]-b[1],k=d[2]-b[2],l=g*k-h*j,m=h*i-f*k,n=f*j-g*i,o=Math.sqrt(l*l+m*m+n*n);return 0===o?(e[0]=0,e[1]=0,e[2]=0):(e[0]=l/o,e[1]=m/o,e[2]=n/o),e},a.rayTriangleIntersect=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3),f=new Float32Array(3);return function(g,h,i,j,k,l){l=l||a.vec3();var m=1e-6,n=a.subVec3(j,i,b),o=a.subVec3(k,i,c),p=a.cross3Vec3(h,o,d),q=a.dotVec3(n,p);if(q<m)return null;var r=a.subVec3(g,i,e),s=a.dotVec3(r,p);if(s<0||s>q)return null;var t=a.cross3Vec3(r,n,f),u=a.dotVec3(h,t);if(u<0||s+u>q)return null;var v=a.dotVec3(o,t)/q;return l[0]=g[0]+v*h[0],l[1]=g[1]+v*h[1],l[2]=g[2]+v*h[2],l}}(),a.rayPlaneIntersect=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3);return function(f,g,h,i,j,k){k=k||a.vec3(),g=a.normalizeVec3(g,b);var l=a.subVec3(i,h,c),m=a.subVec3(j,h,d),n=a.cross3Vec3(l,m,e);a.normalizeVec3(n,n);var o=-a.dotVec3(h,n),p=-(a.dotVec3(f,n)+o)/a.dotVec3(g,n);return k[0]=f[0]+p*g[0],k[1]=f[1]+p*g[1],k[2]=f[2]+p*g[2],k}}(),a.cartesianToBarycentric=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3);return function(e,f,g,h,i){var j=a.subVec3(h,f,b),k=a.subVec3(g,f,c),l=a.subVec3(e,f,d),m=a.dotVec3(j,j),n=a.dotVec3(j,k),o=a.dotVec3(j,l),p=a.dotVec3(k,k),q=a.dotVec3(k,l),r=m*p-n*n;if(0===r)return null;var s=1/r,t=(p*o-n*q)*s,u=(m*q-n*o)*s;return i[0]=1-t-u,i[1]=u,i[2]=t,i}}(),a.barycentricInsideTriangle=function(a){var b=a[1],c=a[2];return c>=0&&b>=0&&c+b<1},a.barycentricToCartesian=function(b,c,d,e,f){f=f||a.vec3();var g=b[0],h=b[1],i=b[2];return f[0]=c[0]*g+d[0]*h+e[0]*i,f[1]=c[1]*g+d[1]*h+e[1]*i,f[2]=c[2]*g+d[2]*h+e[2]*i,f}}(),function(){"use strict";var a=xeogl.math;a.buildNormals=function(){var b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3(),g=a.vec3(),h=a.vec3();return function(i,j){var k,l,m,n,o,p=new Array(i.length/3);for(k=0,l=j.length;k<l;k+=3)m=j[k],n=j[k+1],o=j[k+2],b[0]=i[3*m],b[1]=i[3*m+1],b[2]=i[3*m+2],c[0]=i[3*n],c[1]=i[3*n+1],c[2]=i[3*n+2],d[0]=i[3*o],d[1]=i[3*o+1],d[2]=i[3*o+2],a.subVec3(c,b,e),a.subVec3(d,b,f),a.normalizeVec3(a.cross3Vec3(e,f,g),h),p[m]||(p[m]=[]),p[n]||(p[n]=[]),p[o]||(p[o]=[]),p[m].push(h),p[n].push(h),p[o].push(h);var q=new Float32Array(i.length);for(k=0,l=p.length;k<l;k++){for(var r=p[k].length,s=0,t=0,u=0,v=0;v<r;v++)s+=p[k][v][0],t+=p[k][v][1],u+=p[k][v][2];q[3*k]=s/r,q[3*k+1]=t/r,q[3*k+2]=u/r}return q}}(),a.buildTangents=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3),f=new Float32Array(3),g=new Float32Array(3),h=new Float32Array(3);return function(i,j,k){for(var l=new Float32Array(i.length),m=0;m<j.length;m+=3){var n=j[m],o=i.subarray(3*n,3*n+3),p=k.subarray(2*n,2*n+2);n=j[m+1];var q=i.subarray(3*n,3*n+3),r=k.subarray(2*n,2*n+2);n=j[m+2];for(var s,t=i.subarray(3*n,3*n+3),u=k.subarray(2*n,2*n+2),v=a.subVec3(q,o,b),w=a.subVec3(t,o,c),x=a.subVec2(r,p,d),y=a.subVec2(u,p,e),z=1/(x[0]*y[1]-x[1]*y[0]),A=a.mulVec3Scalar(a.subVec3(a.mulVec3Scalar(v,y[1],f),a.mulVec3Scalar(w,x[1],g),h),z,g),B=0;B<3;B++)s=3*j[m+B],l[s]+=A[0],l[s+1]+=A[1],l[s+2]+=A[2]}return l}}(),a.buildPickTriangles=function(a,b){for(var c,d,e,f,g,h,i,j,k=b.length,l=new Float32Array(30*k),m=new Float32Array(40*k),n=0,o=0;o<k;o+=3)d=3*o,e=4*o,j=(n>>24&255)/255,i=(n>>16&255)/255,h=(n>>8&255)/255,g=(255&n)/255,f=b[o],c=3*f,l[d]=a[c],l[d+1]=a[c+1],l[d+2]=a[c+2],m[e]=g,m[e+1]=h,m[e+2]=i,m[e+3]=j,f=b[o+1],c=3*f,l[d+3]=a[c],l[d+4]=a[c+1],l[d+5]=a[c+2],m[e+4]=g,m[e+5]=h,m[e+6]=i,m[e+7]=j,f=b[o+2],c=3*f,l[d+6]=a[c],l[d+7]=a[c+1],l[d+8]=a[c+2],m[e+8]=g,m[e+9]=h,m[e+10]=i,m[e+11]=j,n++;return{positions:l,colors:m}}}(),function(){"use strict";var a=xeogl.math;a.tangentQuadraticBezier=function(a,b,c,d){return 2*(1-a)*(c-b)+2*a*(d-c)},a.tangentQuadraticBezier=function(a,b,c,d,e){return-3*b*(1-a)*(1-a)+3*c*(1-a)*(1-a)-6*a*c*(1-a)+6*a*d*(1-a)-3*a*a*d+3*a*a*e},a.tangentSpline=function(a){var b=6*a*a-6*a,c=3*a*a-4*a+1,d=-6*a*a+6*a,e=3*a*a-2*a;return b+c+d+e},a.catmullRomInterpolate=function(a,b,c,d,e){var f=.5*(c-a),g=.5*(d-b),h=e*e,i=e*h;return(2*b-2*c+f+g)*i+(-3*b+3*c-2*f-g)*h+f*e+b},a.b2p0=function(a,b){var c=1-a;return c*c*b},a.b2p1=function(a,b){return 2*(1-a)*a*b},a.b2p2=function(a,b){return a*a*b},a.b2=function(a,b,c,d){return this.b2p0(a,b)+this.b2p1(a,c)+this.b2p2(a,d)},a.b3p0=function(a,b){var c=1-a;return c*c*c*b},a.b3p1=function(a,b){var c=1-a;return 3*c*c*a*b},a.b3p2=function(a,b){var c=1-a;return 3*c*a*a*b},a.b3p3=function(a,b){return a*a*a*b},a.b3=function(a,b,c,d,e){return this.b3p0(a,b)+this.b3p1(a,c)+this.b3p2(a,d)+this.b3p3(a,e)}}(),function(){"use strict";xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Renderer=function(a,b,c,d){d=d||{},this.stats=a||{},this.gl=c,this.canvas=b,this._programFactory=new xeogl.renderer.ProgramFactory(this.stats,c),this._objectFactory=new xeogl.renderer.ObjectFactory,this._chunkFactory=new xeogl.renderer.ChunkFactory,this.transparent=d.transparent===!0,this.bindOutputFramebuffer=null,this.unbindOutputFramebuffer=null,this.objects={},this._ambient=null,this.ambientColor=xeogl.math.vec4([0,0,0,1]),this._objectList=[],this._objectListLen=0,this._objectPickList=[],this._objectPickListLen=0,this._frameCtx={canvas:this.canvas,renderTarget:null,renderBuf:null,depthbufEnabled:null,clearDepth:null,depthFunc:null,blendEnabled:!1,backfaces:!0,frontface:!0,textureUnit:0,transparent:!1,ambientColor:null,drawElements:0,useProgram:0,bindTexture:0,bindArray:null,pass:null,bindOutputFramebuffer:null,pickIndex:0},this.visibility=null,this.cull=null,this.modes=null,this.layer=null,this.stage=null,this.depthBuf=null,this.colorBuf=null,this.lights=null,this.material=null,this.reflect=null,this.modelTransform=null,this.viewTransform=null,this.projTransform=null,this.billboard=null,this.stationary=null,this.colorTarget=null,this.depthTarget=null,this.clips=null,this.shader=null,this.shaderParams=null,this.geometry=null,this.viewport=null,this.objectListDirty=!0,this.stateOrderDirty=!0,this.stateSortDirty=!0,this.imageDirty=!0},xeogl.renderer.Renderer.prototype.webglRestored=function(a){this.gl=a,this._programFactory.webglRestored(a),this._chunkFactory.webglRestored(),this.pickBuf&&this.pickBuf.webglRestored(a),this.imageDirty=!0},xeogl.renderer.Renderer.prototype.buildObject=function(a){var b=this.objects[a];b||(b=this._objectFactory.get(a),b.hash=""),b.stage=this.stage,b.layer=this.layer,b.colorTarget=this.colorTarget,b.depthTarget=this.depthTarget,b.material=this.material,b.reflect=this.reflect,b.geometry=this.geometry,b.visibility=this.visibility,b.cull=this.cull,b.modes=this.modes,b.billboard=this.billboard,b.stationary=this.stationary,b.viewport=this.viewport;var c=[this.geometry.hash,this.shader.hash,this.clips.hash,this.material.hash,this.lights.hash,this.billboard.hash,this.stationary.hash].join(";"),d=!1;if(c!==b.hash){b.program&&this._programFactory.put(b.program),b.program=this._programFactory.get(c,this),b.hash=c,d=!0;var e=b.program;if(e){var f=e.program;if(!(f.allocated&&f.compiled&&f.validated&&f.linked))return this.objects[a]&&this.removeObject(a),{error:!0,errorLog:f.errorLog}}}return this._setChunk(b,0,"program",b.program),this._setChunk(b,1,"modelTransform",this.modelTransform),this._setChunk(b,2,"viewTransform",this.viewTransform),this._setChunk(b,3,"projTransform",this.projTransform),this._setChunk(b,4,"modes",this.modes),this._setChunk(b,5,"shader",this.shader),this._setChunk(b,6,"shaderParams",this.shaderParams),this._setChunk(b,7,"depthBuf",this.depthBuf),this._setChunk(b,8,"colorBuf",this.colorBuf),this._setChunk(b,9,"lights",this.lights),this._setChunk(b,10,this.material.type,this.material),this._setChunk(b,11,"clips",this.clips),this._setChunk(b,12,"viewport",this.viewport),this._setChunk(b,13,"geometry",this.geometry),this._setChunk(b,14,"draw",this.geometry,!0),this._setAmbient(this.lights),this.objects[a]?this.stateOrderDirty=!0:(this.objects[a]=b,this.objectListDirty=!0),b.compiled=!0,b},xeogl.renderer.Renderer.prototype._setChunk=function(a,b,c,d,e){var f,g=this._chunkFactory.types[c];f="program"===c?1e8*(a.program.id+1):g.constructor.prototype.programGlobal?d.id:1e8*(a.program.id+1)+(d.id+1),e&&(f*=1e5);var h=a.chunks[b];h&&this._chunkFactory.putChunk(h),a.chunks[b]=this._chunkFactory.getChunk(f,c,a.program.program,d)},xeogl.renderer.Renderer.prototype._setAmbient=function(a){for(var b,c=a.lights,d=0,e=c.length;d<e;d++)b=c[d],"ambient"===b.type&&(this._ambient=b)},xeogl.renderer.Renderer.prototype.removeObject=function(a){var b=this.objects[a];if(b){for(var c=b.chunks,d=0,e=c.length;d<e;d++)this._chunkFactory.putChunk(c[d]);this._programFactory.put(b.program),b.program=null,b.hash=null,this._objectFactory.put(b),delete this.objects[a],this.objectListDirty=!0}},xeogl.renderer.Renderer.prototype.render=function(a){a=a||{},this.objectListDirty&&(this._buildObjectList(),this.objectListDirty=!1,this.stateOrderDirty=!0),this.stateOrderDirty&&(this._makeStateSortKeys(),this.stateOrderDirty=!1,this.stateSortDirty=!0),this.stateSortDirty&&(this._stateSort(),this.stateSortDirty=!1,this.imageDirty=!0),(this.imageDirty||a.force)&&(this._renderObjectList({clear:a.clear!==!1,opaqueOnly:a.opaqueOnly,pass:a.pass}),this.stats.frame.frameCount++,this.imageDirty=!1)},xeogl.renderer.Renderer.prototype._buildObjectList=function(){this._objectListLen=0;for(var a in this.objects)this.objects.hasOwnProperty(a)&&(this._objectList[this._objectListLen++]=this.objects[a])},xeogl.renderer.Renderer.prototype._makeStateSortKeys=function(){for(var a,b=0,c=this._objectListLen;b<c;b++)a=this._objectList[b],a.program?a.sortKey=1e16*(a.stage.priority+1)+1e14*(a.modes.transparent?2:1)+1e13*(a.layer.priority+1)+1e8*(a.program.id+1)+1e4*(a.material.id+1)+a.geometry.id:a.sortKey=-1},xeogl.renderer.Renderer.prototype._stateSort=function(){this._objectList.length=this._objectListLen,this._objectList.sort(function(a,b){return a.sortKey-b.sortKey})},xeogl.renderer.Renderer.prototype._renderObjectList=function(a){var b=this.gl;xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&b.getExtension("OES_element_index_uint");var c=this._ambient;if(c){var d=c.color,e=c.intensity;this.ambientColor[0]=d[0]*e,this.ambientColor[1]=d[1]*e,this.ambientColor[2]=d[2]*e}else this.ambientColor[0]=0,this.ambientColor[1]=0,this.ambientColor[2]=0;var f=this._frameCtx;f.renderTarget=null,f.renderBuf=null,f.depthbufEnabled=null,f.clearDepth=null,f.depthFunc=b.LESS,f.blendEnabled=!1,f.backfaces=!0,f.frontface=!0,f.textureUnit=0,f.transparent=!1,f.ambientColor=this.ambientColor,f.drawElements=0,f.useProgram=0,f.bindTexture=0,f.bindArray=0,f.pass=a.pass,f.bindOutputFramebuffer=this.bindOutputFramebuffer,f.pickViewMatrix=a.pickViewMatrix,f.pickProjMatrix=a.pickProjMatrix,f.pickIndex=0,xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&b.getExtension("OES_element_index_uint"),b.viewport(0,0,b.drawingBufferWidth,b.drawingBufferHeight),this.transparent||a.pickObject||a.pickSurface?b.clearColor(0,0,0,0):b.clearColor(this.ambientColor[0],this.ambientColor[1],this.ambientColor[2],1),b.enable(b.DEPTH_TEST),b.frontFace(b.CCW),b.disable(b.CULL_FACE),b.disable(b.BLEND);var g,h,i,j,k,l,m=this._lastChunkId=this._lastChunkId||new Int32Array(30);for(g=0;g<20;g++)m[g]=-9999999999999;if(a.pickObject){b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT),this._objectPickListLen=0;var n;for(g=0,h=this._objectListLen;g<h;g++)if(n=this._objectList[g],n.compiled&&n.cull.culled!==!0&&n.visibility.visible!==!1&&n.modes.pickable!==!1)for(this._objectPickList[this._objectPickListLen++]=n,k=n.chunks,i=0,j=k.length;i<j;i++)l=k[i],l&&l.pickObject&&(l.unique||m[i]!==l.id)&&(l.pickObject(f),m[i]=l.id)}else if(a.pickSurface){if(b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT),a.object)for(k=a.object.chunks,g=0,h=k.length;g<h;g++)l=k[g],l.pickPrimitive&&l.pickPrimitive(f)}else{var o=(new Date).getTime();for(this.bindOutputFramebuffer&&this.bindOutputFramebuffer(a.pass),a.clear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT),g=0,h=this._objectListLen;g<h;g++)if(n=this._objectList[g],n.compiled&&n.cull.culled!==!0&&n.visibility.visible!==!1)for(k=n.chunks,i=0,j=k.length;i<j;i++)l=k[i],l&&l.draw&&(l.unique||m[i]!==l.id)&&(l.draw(f),m[i]=l.id);var p=Date.now(),q=this.stats.frame;q.renderTime=(p-o)/1e3,q.drawElements=f.drawElements,q.useProgram=f.useProgram,q.bindTexture=f.bindTexture,q.bindArray=f.bindArray,f.renderBuf&&f.renderBuf.unbind();for(var r=b.getParameter(b.MAX_TEXTURE_IMAGE_UNITS),s=0;s<r;++s)b.activeTexture(b.TEXTURE0+s),b.bindTexture(b.TEXTURE_CUBE_MAP,null),b.bindTexture(b.TEXTURE_2D,null);this.unbindOutputFramebuffer&&this.unbindOutputFramebuffer(a.pass)}},xeogl.renderer.Renderer.prototype.pick=function(){var a=xeogl.math,b=a.vec3(),c=a.mat4(),d=a.vec3([0,1,0]),e=a.frustumMat4(-1,1,-1,1,.1,1e4);return function(f){var g=null,h=this.pickBuf;h||(h=new xeogl.renderer.webgl.RenderBuffer(this.canvas,this.gl),this.pickBuf=h),this.render(),h.bind(),h.clear();var i,j,k,l,m,n=null,o=null;f.canvasPos?f.canvasPos?(i=f.canvasPos[0],j=f.canvasPos[1]):(i=.5*this.canvas.clientWidth,j=.5*this.canvas.clientHeight):(k=f.origin||a.vec3([0,0,0]),l=f.direction||a.vec3([0,0,1]),m=a.addVec3(k,l,b),n=a.lookAtMat4v(k,m,d,c),o=e,i=.5*this.canvas.clientWidth,j=.5*this.canvas.clientHeight),this._renderObjectList({pickObject:!0,clear:!0,pickViewMatrix:n,pickProjMatrix:o});var p=h.read(i,j),q=p[0]+256*p[1]+65536*p[2];q=q>=1?q-1:-1;var r=this._objectPickList[q];if(r&&(g={entity:r.id},f.pickSurface)){h.clear(),this._renderObjectList({pickSurface:!0,object:r,pickViewMatrix:n,pickProjMatrix:o,clear:!0}),this.gl.finish(),p=h.read(i,j);var s=p[0]+256*p[1]+256*p[2]*256+256*p[3]*256*256;s*=3,g.primIndex=s,n&&(g.origin=k,g.direction=l)}return h.unbind(),g}}(),xeogl.renderer.Renderer.prototype.readPixels=function(a,b,c,d){this._readPixelBuf||(this._readPixelBuf=new xeogl.renderer.webgl.RenderBuffer(this.canvas,this.gl)),this._readPixelBuf.bind(),this._readPixelBuf.clear(),this.render({force:!0,opaqueOnly:d});var e,f,g,h;for(f=0;f<c;f++)g=2*f,h=4*f,e=this._readPixelBuf.read(a[g],a[g+1]),b[h]=e[0],b[h+1]=e[1],b[h+2]=e[2],b[h+3]=e[3];this._readPixelBuf.unbind()},xeogl.renderer.Renderer.prototype.destroy=function(){this._programFactory.destroy()}}(),function(){"use strict";xeogl.renderer.webgl={enums:{funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"}}}(),function(){"use strict";xeogl.renderer.webgl.ArrayBuffer=function(a,b,c,d,e,f){this.allocated=!1,this.gl=a,this.type=b,this.itemType=c.constructor==Uint8Array?a.UNSIGNED_BYTE:c.constructor==Uint16Array?a.UNSIGNED_SHORT:c.constructor==Uint32Array?a.UNSIGNED_INT:a.FLOAT,this.usage=f,this.length=0,this.numItems=0,this.itemSize=e,this._allocate(c)},xeogl.renderer.webgl.ArrayBuffer.prototype._allocate=function(a){if(this.allocated=!1,this._handle=this.gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this.gl.bindBuffer(this.type,this._handle),this.gl.bufferData(this.type,a,this.usage),this.gl.bindBuffer(this.type,null),this.length=a.length,this.numItems=this.length/this.itemSize,this.allocated=!0)},xeogl.renderer.webgl.ArrayBuffer.prototype.setData=function(a,b){this.allocated&&(a.length>this.length?(this.destroy(),this._allocate(a,a.length)):b||0===b?this.gl.bufferSubData(this.type,b,a):this.gl.bufferData(this.type,a))},xeogl.renderer.webgl.ArrayBuffer.prototype.bind=function(){this.allocated&&this.gl.bindBuffer(this.type,this._handle)},xeogl.renderer.webgl.ArrayBuffer.prototype.unbind=function(){this.allocated&&this.gl.bindBuffer(this.type,null)},xeogl.renderer.webgl.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}(),function(){"use strict";xeogl.renderer.webgl.Attribute=function(a,b){this.gl=a,this.location=b},xeogl.renderer.webgl.Attribute.prototype.bindFloatArrayBuffer=function(a){a&&(a.bind(),this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a.itemSize,this.gl.FLOAT,!1,0,0))},xeogl.renderer.webgl.Attribute.prototype.bindInterleavedFloatArrayBuffer=function(a,b,c){this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a,this.gl.FLOAT,!1,b,c)}}(),function(){"use strict";function a(a){for(var b,c,d=[],e=0,f=a.length;e<f;e++)b=a[e],c=b.indexOf("/"),c>0&&"/"===b.charAt(c+1)&&(b=b.substring(0,c)),d.push(b);return d.join("\n")}xeogl.renderer.webgl.Program=function(b,c,d,e){if(this.stats=b,this.gl=c,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new xeogl.renderer.webgl.Shader(c,c.VERTEX_SHADER,a(d)),this._fragmentShader=new xeogl.renderer.webgl.Shader(c,c.FRAGMENT_SHADER,a(e)),!this._vertexShader.allocated)return void(this.errorLog=["Vertex shader failed to allocate"].concat(this._vertexShader.errorLog));if(!this._fragmentShader.allocated)return void(this.errorLog=["Fragment shader failed to allocate"].concat(this._fragmentShader.errorLog));if(this.allocated=!0,!this._vertexShader.compiled)return void(this.errorLog=["Vertex shader failed to compile"].concat(this._vertexShader.errorLog));if(!this._fragmentShader.compiled)return void(this.errorLog=["Fragment shader failed to compile"].concat(this._fragmentShader.errorLog));this.compiled=!0;var f,g,h,i,j;if(this.handle=c.createProgram(),!this.handle)return void(this.errorLog=["Failed to allocate program"]);if(c.attachShader(this.handle,this._vertexShader.handle),c.attachShader(this.handle,this._fragmentShader.handle),c.linkProgram(this.handle),this.linked=c.getProgramParameter(this.handle,c.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errorLog=[],this.errorLog.push(""),this.errorLog.push(c.getProgramInfoLog(this.handle)),this.errorLog.push("\nVertex shader:\n"),this.errorLog=this.errorLog.concat(d),this.errorLog.push("\nFragment shader:\n"),void(this.errorLog=this.errorLog.concat(e));var k=c.getProgramParameter(this.handle,c.ACTIVE_UNIFORMS);for(g=0;g<k;++g)h=c.getActiveUniform(this.handle,g),h&&(i=h.name,"\0"===i[i.length-1]&&(i=i.substr(0,i.length-1)),j=c.getUniformLocation(this.handle,i),h.type===c.SAMPLER_2D||h.type===c.SAMPLER_CUBE||35682===h.type?this.samplers[i]=new xeogl.renderer.webgl.Sampler(c,j):this.uniforms[i]=new xeogl.renderer.webgl.Uniform(b.frame,c,h.type,j));var l=c.getProgramParameter(this.handle,c.ACTIVE_ATTRIBUTES);for(g=0;g<l;g++)f=c.getActiveAttrib(this.handle,g),f&&(j=c.getAttribLocation(this.handle,f.name),this.attributes[f.name]=new xeogl.renderer.webgl.Attribute(c,j));this.allocated=!0},xeogl.renderer.webgl.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},xeogl.renderer.webgl.Program.prototype.setUniform=function(a,b){if(this.allocated){var c=this.uniforms[a];c&&c.setValue(b)}},xeogl.renderer.webgl.Program.prototype.getUniform=function(a){if(this.allocated)return this.uniforms[a]},xeogl.renderer.webgl.Program.prototype.getAttribute=function(a){if(this.allocated)return this.attributes[a]},xeogl.renderer.webgl.Program.prototype.bindTexture=function(a,b,c){if(!this.allocated)return!1;var d=this.samplers[a];return!!d&&d.bindTexture(b,c)},xeogl.renderer.webgl.Program.prototype.destroy=function(){this.allocated&&(this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}(),function(){"use strict";xeogl.renderer.webgl.RenderBuffer=function(a,b,c){c=c||{},this.allocated=!1,this.canvas=a,this.gl=b,this.buffer=null,this.bound=!1,this.size=c.size},xeogl.renderer.webgl.RenderBuffer.prototype.setSize=function(a){this.size=a},xeogl.renderer.webgl.RenderBuffer.prototype.webglRestored=function(a){this.gl=a,this.buffer=null,this.allocated=!1,this.bound=!1},xeogl.renderer.webgl.RenderBuffer.prototype.bind=function(){this._touch(),this.bound||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0)},xeogl.renderer.webgl.RenderBuffer.prototype._touch=function(){var a,b;if(this.size?(a=this.size[0],b=this.size[1]):(a=this.canvas.clientWidth,b=this.canvas.clientHeight),this.buffer){if(this.buffer.width===a&&this.buffer.height===b)return;this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf)}this.buffer={framebuf:this.gl.createFramebuffer(),renderbuf:this.gl.createRenderbuffer(),texture:this.gl.createTexture(),width:a,height:b},this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.gl.bindTexture(this.gl.TEXTURE_2D,this.buffer.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);try{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)}catch(c){var d=new WebGLUnsignedByteArray(a*b*3);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,d)}if(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,a,b),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.buffer.texture,0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),!this.gl.isFramebuffer(this.buffer.framebuf))throw"Invalid framebuffer";this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);var e=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);switch(e){case this.gl.FRAMEBUFFER_COMPLETE:break;case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case this.gl.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+e}this.bound=!1},xeogl.renderer.webgl.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.BLEND)},xeogl.renderer.webgl.RenderBuffer.prototype.read=function(a,b){var c=a,d=this.canvas.height-b,e=new Uint8Array(4);return this.gl.readPixels(c,d,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),e},xeogl.renderer.webgl.RenderBuffer.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.bound=!1},xeogl.renderer.webgl.RenderBuffer.prototype.getTexture=function(){var a=this;return{renderBuffer:this,bind:function(b){return!(!a.buffer||!a.buffer.texture)&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,a.buffer.texture),!0)},unbind:function(b){a.buffer&&a.buffer.texture&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,null))}}},xeogl.renderer.webgl.RenderBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1)}}(),function(){"use strict";xeogl.renderer.webgl.Sampler=function(a,b){this.bindTexture=function(c,d){return!!c.bind(d)&&(a.uniform1i(b,d),!0)}}}(),function(){"use strict";xeogl.renderer.webgl.Shader=function(a,b,c){return this.allocated=!1,this.compiled=!1,this.errorLog=null,this.source=c,this.handle=a.createShader(b),this.handle?(this.allocated=!0,a.shaderSource(this.handle,c),a.compileShader(this.handle),this.compiled=a.getShaderParameter(this.handle,a.COMPILE_STATUS),void(this.compiled||a.isContextLost()||(this.errorLog=[],this.errorLog.push(""),this.errorLog.push(a.getShaderInfoLog(this.handle)),this.errorLog=this.errorLog.concat(this.source)))):void(this.errorLog=["Failed to allocate"])}}(),function(){"use strict";xeogl.renderer.webgl.Texture2D=function(a){this.gl=a,this.target=a.TEXTURE_2D,this.texture=a.createTexture(),this.allocated=!0},xeogl.renderer.webgl.Texture2D.prototype.setImage=function(a,b){var c=this.gl;c.bindTexture(this.target,this.texture),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,b.flipY),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a),c.bindTexture(this.target,null)},xeogl.renderer.webgl.Texture2D.prototype.setProps=function(a){var b=this.gl;if(b.bindTexture(this.target,this.texture),a.minFilter){var c=this._getGLEnum(a.minFilter);c&&(b.texParameteri(this.target,b.TEXTURE_MIN_FILTER,c),c!==b.NEAREST_MIPMAP_NEAREST&&c!==b.LINEAR_MIPMAP_NEAREST&&c!==b.NEAREST_MIPMAP_LINEAR&&c!==b.LINEAR_MIPMAP_LINEAR||b.generateMipmap(this.target))}if(a.magFilter){var d=this._getGLEnum(a.magFilter);d&&b.texParameteri(this.target,b.TEXTURE_MAG_FILTER,d)}if(a.wrapS){var e=this._getGLEnum(a.wrapS);e&&b.texParameteri(this.target,b.TEXTURE_WRAP_S,e)}if(a.wrapT){var f=this._getGLEnum(a.wrapT);f&&b.texParameteri(this.target,b.TEXTURE_WRAP_T,f)}b.bindTexture(this.target,null)},xeogl.renderer.webgl.Texture2D.prototype._getGLEnum=function(a,b){if(void 0===a)return b;var c=xeogl.renderer.webgl.enums[a];return void 0===c?b:this.gl[c]},xeogl.renderer.webgl.Texture2D.prototype.bind=function(a){if(this.allocated){if(this.texture){var b=this.gl;return b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,this.texture),!0}return!1}},xeogl.renderer.webgl.Texture2D.prototype.unbind=function(a){if(this.allocated&&this.texture){var b=this.gl;b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,null)}},xeogl.renderer.webgl.Texture2D.prototype.destroy=function(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)},xeogl.renderer.webgl.clampImageSize=function(a,b){var c=a.width*a.height;if(c>b){var d=b/c,e=a.width*d,f=a.height*d,g=document.createElement("canvas");g.width=xeogl.renderer.webgl.nextHighestPowerOfTwo(e),g.height=xeogl.renderer.webgl.nextHighestPowerOfTwo(f);var h=g.getContext("2d");h.drawImage(a,0,0,a.width,a.height,0,0,g.width,g.height),a=g}return a},xeogl.renderer.webgl.ensureImageSizePowerOfTwo=function(a){if(!xeogl.renderer.webgl.isPowerOfTwo(a.width)||!xeogl.renderer.webgl.isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=xeogl.renderer.webgl.nextHighestPowerOfTwo(a.width),b.height=xeogl.renderer.webgl.nextHighestPowerOfTwo(a.height);var c=b.getContext("2d");c.drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b}return a},xeogl.renderer.webgl.isPowerOfTwo=function(a){return 0===(a&a-1)},xeogl.renderer.webgl.nextHighestPowerOfTwo=function(a){--a;for(var b=1;b<32;b<<=1)a|=a>>b;return a+1}}(),function(){"use strict";xeogl.renderer.webgl.Uniform=function(a,b,c,d){var e=null,f=null;if(c===b.BOOL)e=function(a){f!==a&&(f=a,b.uniform1i(d,a))};else if(c===b.BOOL_VEC2)f=new Array(2),e=function(a){f[0]===a[0]&&f[1]===a[1]||(f[0]=a[0],f[1]=a[1],b.uniform2iv(d,a))};else if(c===b.BOOL_VEC3)f=new Array(3),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]||(f[0]=a[0],f[1]=a[1],f[2]=a[2],b.uniform3iv(d,a))};else if(c===b.BOOL_VEC4)f=new Array(4),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]&&f[3]===a[3]||(f[0]=a[0],f[1]=a[1],f[2]=a[2],f[3]=a[3],b.uniform4iv(d,a))};else if(c===b.INT)e=function(a){f!==a&&(f=a,b.uniform1iv(d,a))};else if(c===b.INT_VEC2)f=new Uint32Array(2),e=function(a){f[0]===a[0]&&f[1]===a[1]||(f.set(a),b.uniform2iv(d,a))};else if(c===b.INT_VEC3)f=new Uint32Array(3),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]||(f.set(a),b.uniform3iv(d,a))};else if(c===b.INT_VEC4)f=new Uint32Array(4),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]&&f[3]===a[3]||(f.set(a),b.uniform4iv(d,a))};else if(c===b.FLOAT)e=function(a){f!==a&&(f=a,b.uniform1f(d,a))};else if(c===b.FLOAT_VEC2)f=new Float32Array(2),e=function(a){f[0]===a[0]&&f[1]===a[1]||(f.set(a),b.uniform2fv(d,a))};else if(c===b.FLOAT_VEC3)f=new Float32Array(3),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]||(f.set(a),b.uniform3fv(d,a))};else if(c===b.FLOAT_VEC4)f=new Float32Array(4),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]&&f[3]===a[3]||(f.set(a),b.uniform4fv(d,a))};else if(c===b.FLOAT_MAT2)f=new Float32Array(4),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]&&f[3]===a[3]||(f.set(a),b.uniformMatrix2fv(d,b.FALSE,a))};else if(c===b.FLOAT_MAT3)f=new Float32Array(9),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]&&f[3]===a[3]&&f[4]===a[4]&&f[5]===a[5]&&f[6]===a[6]&&f[7]===a[7]&&f[8]===a[8]||(f.set(a),b.uniformMatrix3fv(d,b.FALSE,a))};else{if(c!==b.FLOAT_MAT4)throw"Unsupported shader uniform type: "+c;f=new Float32Array(16),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]&&f[3]===a[3]&&f[4]===a[4]&&f[5]===a[5]&&f[6]===a[6]&&f[7]===a[7]&&f[8]===a[8]&&f[9]===a[9]&&f[10]===a[10]&&f[11]===a[11]&&f[12]===a[12]&&f[13]===a[13]&&f[14]===a[14]&&f[15]===a[15]||(f.set(a),b.uniformMatrix4fv(d,b.FALSE,a))}}this.setValue=e,this.getLocation=function(){return d}}}(),function(){"use strict";xeogl.renderer=xeogl.renderer||{},xeogl.renderer.State=Class.extend({__init:function(a){this.id=this._ids.addItem({}),this.hash=a.hash||""+this.id;for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])},destroy:function(){this._ids.removeItem(this.id)}}),xeogl.renderer.Visibility=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Cull=xeogl.renderer.State.extend({
_ids:new xeogl.utils.Map({})}),xeogl.renderer.Modes=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Layer=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Stage=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.DepthBuf=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.ColorBuf=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Lights=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.PhongMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Reflect=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Transform=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Billboard=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Stationary=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.RenderTarget=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.RenderTarget.DEPTH=0,xeogl.renderer.RenderTarget.COLOR=1,xeogl.renderer.Clips=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.MorphTargets=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Shader=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.ShaderParams=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Texture=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Fresnel=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Geometry=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.ProgramState=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Viewport=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})})}(),function(){"use strict";xeogl.renderer.Object=function(a){this.id=a,this.hash=null,this.sortKey=null,this.chunks=[],this.program=null,this.stage=null,this.modes=null,this.layer=null,this.material=null,this.compiled=!1}}(),function(){"use strict";xeogl.renderer.ObjectFactory=function(){var a=[],b=0;this.get=function(c){var d;return b>0?(d=a[--b],d.id=c,d.compiled=!1,d):new xeogl.renderer.Object(c)},this.put=function(c){a[b++]=c}}}(),function(){"use strict";xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Program=function(a,b,c,d){this.stats=a,this.hash=c.hash,this.source=c,this.gl=d,this.draw=null,this.pickObject=null,this.pickPrimitive=null,this.useCount=0,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.build(d)},xeogl.renderer.Program.prototype.build=function(a){return this.gl=a,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.draw=new xeogl.renderer.webgl.Program(this.stats,a,this.source.vertexDraw,this.source.fragmentDraw),this.pickObject=new xeogl.renderer.webgl.Program(this.stats,a,this.source.vertexPickObject,this.source.fragmentPickObject),this.pickPrimitive=new xeogl.renderer.webgl.Program(this.stats,a,this.source.vertexPickPrimitive,this.source.fragmentPickPrimitive),this.draw.allocated?this.pickObject.allocated?this.pickPrimitive.allocated?(this.allocated=!0,this.draw.compiled?this.pickObject.compiled?this.pickPrimitive.compiled?(this.compiled=!0,this.draw.linked?this.pickObject.linked?this.pickPrimitive.linked?(this.linked=!0,this.draw.validated?this.pickObject.validated?this.pickPrimitive.validated?void(this.validated=!0):void(this.errorLog=["Primitive-picking program failed to validate"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to validate"].concat(this.pickObject.errorLog)):void(this.errorLog=["Draw program failed to validate"].concat(this.draw.errorLog))):void(this.errorLog=["Primitive-picking program failed to link"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to link"].concat(this.pickObject.errorLog)):void(this.errorLog=["Draw program failed to link"].concat(this.draw.errorLog))):void(this.errorLog=["Primitive-picking program failed to compile"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to compile"].concat(this.pickObject.errorLog)):void(this.errorLog=["Draw program failed to compile"].concat(this.draw.errorLog))):void(this.errorLog=["Primitive-picking program failed to allocate"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to allocate"].concat(this.pickObject.errorLog)):void(this.errorLog=["Draw program failed to allocate"].concat(this.draw.errorLog))}}(),function(){"use strict";xeogl.renderer.ProgramFactory=function(a,b){this.stats=a,this._gl=b,this._programStates={}},xeogl.renderer.ProgramFactory.prototype.get=function(a,b){var c=this._programStates[a];if(!c){var d=xeogl.renderer.ProgramSourceFactory.getSource(a,b),e=new xeogl.renderer.Program(this.stats,a,d,this._gl);c=new xeogl.renderer.ProgramState({program:e,useCount:0}),this._programStates[a]=c,this.stats.memory.programs++}return c.useCount++,c},xeogl.renderer.ProgramFactory.prototype.put=function(a){if(--a.useCount<=0){var b=a.program;b.draw.destroy(),b.pickObject.destroy(),b.pickPrimitive.destroy(),xeogl.renderer.ProgramSourceFactory.putSource(b.hash),delete this._programStates[b.hash],this.stats.memory.programs--}},xeogl.renderer.ProgramFactory.prototype.webglRestored=function(a){this._gl=a;for(var b in this._programStates)this._programStates.hasOwnProperty(b)&&this._programStates[b].build(a)},xeogl.renderer.ProgramFactory.prototype.destroy=function(){}}(),function(){"use strict";xeogl.renderer.ProgramSource=function(a,b,c,d,e,f,g){this.hash=a,this.vertexPickObject=b,this.fragmentPickObject=c,this.vertexPickPrimitive=d,this.fragmentPickPrimitive=e,this.vertexDraw=f,this.fragmentDraw=g,this.useCount=0}}(),function(){"use strict";xeogl.renderer.ProgramSourceFactory=new function(){function a(){if(!p.geometry.uv)return!1;var a=p.material;return a.ambientMap||a.diffuseMap||a.specularMap||a.emissiveMap||a.opacityMap||a.reflectivityMap||p.material.normalMap}function b(){return!1}function c(){var a=p.geometry.primitiveName;return!(!p.geometry.normals||"triangles"!==a&&"triangle-strip"!==a&&"triangle-fan"!==a)}function d(){var a=p.geometry;return a.positions&&a.indices&&a.normals&&a.uv&&p.material.normalMap}function e(){return z?z:(k(),l("// Object picking vertex shader"),l("attribute vec3 xeo_aPosition;"),l("uniform mat4 xeo_uModelMatrix;"),l("uniform mat4 xeo_uViewMatrix;"),l("uniform mat4 xeo_uViewNormalMatrix;"),l("uniform mat4 xeo_uProjMatrix;"),l("varying vec4 xeo_vWorldPosition;"),l("varying vec4 xeo_vViewPosition;"),l("void main(void) {"),l("   vec4 tmpVertex = vec4(xeo_aPosition, 1.0); "),l("   xeo_vWorldPosition = xeo_uModelMatrix * tmpVertex; "),l("   xeo_vViewPosition = xeo_uViewMatrix * xeo_vWorldPosition;"),l("   gl_Position = xeo_uProjMatrix * xeo_vViewPosition;"),l("}"),z=n())}function f(){return A?A:(k(),l("// Object picking fragment shader"),l("precision "+o(p.gl)+" float;"),l("uniform vec4 xeo_uPickColor;"),l("void main(void) {"),l("   gl_FragColor = xeo_uPickColor; "),l("}"),A=n())}function g(){return B?B:(k(),l("// Triangle picking vertex shader"),l("attribute vec3 xeo_aPosition;"),l("attribute vec4 xeo_aColor;"),l("uniform vec3 xeo_uPickColor;"),l("uniform mat4 xeo_uModelMatrix;"),l("uniform mat4 xeo_uViewMatrix;"),l("uniform mat4 xeo_uProjMatrix;"),l("varying vec4 xeo_vWorldPosition;"),l("varying vec4 xeo_vViewPosition;"),l("varying vec4 xeo_vColor;"),l("void main(void) {"),l("   vec4 tmpVertex = vec4(xeo_aPosition, 1.0); "),l("   vec4 worldPosition = xeo_uModelMatrix * tmpVertex; "),l("   vec4 viewPosition = xeo_uViewMatrix * worldPosition;"),l("   xeo_vColor = xeo_aColor;"),l("   gl_Position = xeo_uProjMatrix * viewPosition;"),l("}"),B=n())}function h(){return C?C:(k(),l("// Triangle picking fragment shader"),l("precision "+o(p.gl)+" float;"),l("varying vec4 xeo_vColor;"),l("void main(void) {"),l("   gl_FragColor = xeo_vColor;"),l("}"),C=n())}function i(){var a=p.shader.vertex;if(a)return a;var b,c,d;if(k(),l("// Drawing vertex shader"),l("uniform mat4 xeo_uModelMatrix;          // Modeling matrix"),l("uniform mat4 xeo_uViewMatrix;           // Viewing matrix"),l("uniform mat4 xeo_uProjMatrix;           // Projection matrix"),l("attribute vec3 xeo_aPosition;           // Local-space vertex position"),l(),l("varying vec4 xeo_vViewPosition;         // Output: View-space fragment position"),r)for(l(),l("attribute vec3 xeo_aNormal;             // Local-space vertex normal"),l("uniform mat4 xeo_uModelNormalMatrix;    // Modeling normal matrix"),l("uniform mat4 xeo_uViewNormalMatrix;     // Viewing normal matrix"),l("varying vec3 xeo_vViewEyeVec;           // Output: View-space vector from fragment position to eye"),l("varying vec3 xeo_vViewNormal;           // Output: View-space normal"),b=0,c=p.lights.lights.length;b<c;b++)d=p.lights.lights[b],"ambient"!==d.type&&("dir"===d.type&&l("uniform vec3 xeo_uLightDir"+b+";   // Directional light direction"),"point"===d.type&&l("uniform vec3 xeo_uLightPos"+b+";   // Positional light position"),"spot"===d.type&&l("uniform vec3 xeo_uLightPos"+b+";   // Spot light position"),l("varying vec4 xeo_vViewLightVecAndDist"+b+"; // Output: Vector from vertex to light, packaged with the pre-computed length of that vector"));if(s&&l("attribute vec3 xeo_aTangent;"),q&&(l(),l("attribute vec2 xeo_aUV;"),l("varying vec2 xeo_vUV;")),p.geometry.colors&&(l("attribute vec4 xeo_aColor;"),l("varying vec4 xeo_vColor;")),"points"===p.geometry.primitiveName&&l("uniform float xeo_uPointSize;"),p.billboard.active&&(l("void billboard(inout mat4 mat) {"),l("   mat[0][0] = 1.0;"),l("   mat[0][1] = 0.0;"),l("   mat[0][2] = 0.0;"),p.billboard.spherical&&(l("   mat[1][0] = 0.0;"),l("   mat[1][1] = 1.0;"),l("   mat[1][2] = 0.0;")),l("   mat[2][0] = 0.0;"),l("   mat[2][1] = 0.0;"),l("   mat[2][2] =1.0;"),l("}")),l(),l("void main(void) {"),l(),l("   vec4 localPosition = vec4(xeo_aPosition, 1.0); "),r&&(l("   vec4 localNormal = vec4(xeo_aNormal, 0.0); "),l("   mat4 modelNormalMatrix = xeo_uModelNormalMatrix;"),l("   mat4 viewNormalMatrix = xeo_uViewNormalMatrix;")),l("   mat4 modelMatrix = xeo_uModelMatrix;"),l("   mat4 viewMatrix = xeo_uViewMatrix;"),l("   vec4 worldPosition;"),p.stationary.active&&l("   viewMatrix[3][0] = viewMatrix[3][1] = viewMatrix[3][2] = 0.0;"),p.billboard.active?(l("   mat4 modelViewMatrix =  xeo_uViewMatrix * xeo_uModelMatrix;"),l("   billboard(modelMatrix);"),l("   billboard(viewMatrix);"),l("   billboard(modelViewMatrix);"),r&&(l("   mat4 modelViewNormalMatrix =  xeo_uViewNormalMatrix * xeo_uModelNormalMatrix;"),l("   billboard(modelNormalMatrix);"),l("   billboard(viewNormalMatrix);"),l("   billboard(modelViewNormalMatrix);")),l("   worldPosition = modelMatrix * localPosition;"),l("   vec4 viewPosition = modelViewMatrix * localPosition;")):(l("   worldPosition = modelMatrix * localPosition;"),l("   vec4 viewPosition  = viewMatrix * worldPosition; ")),r){for(l("   vec3 worldNormal = (modelNormalMatrix * localNormal).xyz; "),l("   xeo_vViewNormal = normalize((viewNormalMatrix * vec4(worldNormal, 1.0)).xyz);"),s&&(l("   vec3 tangent = normalize((xeo_uViewNormalMatrix * xeo_uModelNormalMatrix * vec4(xeo_aTangent, 1.0)).xyz);"),l("   vec3 bitangent = cross(xeo_vViewNormal, tangent);"),l("   mat3 TBN = mat3(tangent, bitangent, xeo_vViewNormal);")),l("   vec3 tmpVec3;"),l("   float lightDist;"),b=0,c=p.lights.lights.length;b<c;b++)d=p.lights.lights[b],"ambient"!==d.type&&("dir"===d.type&&("world"===d.space?(l("   tmpVec3 = xeo_uLightDir"+b+";"),l("   tmpVec3 = vec3(viewMatrix * vec4(tmpVec3, 1.0)).xyz;"),s&&l("   tmpVec3 *= TBN;")):(l("   tmpVec3 = xeo_uLightDir"+b+";"),s&&l("   tmpVec3 *= TBN;")),l("   xeo_vViewLightVecAndDist"+b+" = vec4(tmpVec3, 0.0);")),"point"===d.type&&("world"===d.space?(l("   tmpVec3 = (viewMatrix * vec4(xeo_uLightPos"+b+", 1.0)).xyz - viewPosition.xyz;"),l("   lightDist = abs(length(tmpVec3));"),s&&l("   tmpVec3 *= TBN;")):(l("   tmpVec3 = xeo_uLightPos"+b+".xyz - viewPosition.xyz;"),l("   lightDist = abs(length(tmpVec3));"),s&&l("   tmpVec3 *= TBN;")),l("   xeo_vViewLightVecAndDist"+b+" = vec4(tmpVec3, lightDist);")));l("   xeo_vViewEyeVec = -viewPosition.xyz;"),s&&l("   xeo_vViewEyeVec *= TBN;")}return q&&l("   xeo_vUV = xeo_aUV;"),p.geometry.colors&&l("   xeo_vColor = xeo_aColor;"),"points"===p.geometry.primitiveName&&l("   gl_PointSize = xeo_uPointSize;"),l("   xeo_vViewPosition = viewPosition;"),l("   gl_Position = xeo_uProjMatrix * viewPosition;"),l("}"),n()}function j(){var a=p.shader.fragment;if(a)return a;var b,c,d;if(k(),l("// Drawing fragment shader"),l("precision "+o(p.gl)+" float;"),l(),r&&(l("varying vec4 xeo_vViewPosition;"),l(),l("uniform vec3 xeo_uSpecular;"),l("uniform float xeo_uShininess;"),l("uniform float xeo_uReflectivity;")),l("uniform vec3 xeo_uEmissive;"),l("uniform float xeo_uOpacity;"),l("uniform vec3 xeo_uDiffuse;"),l(),p.geometry.colors&&l("varying vec4 xeo_vColor;"),q&&(l(),m("Texture variables"),l(),p.geometry.uv&&l("varying vec2 xeo_vUV;"),p.material.emissiveMap&&(l("uniform sampler2D xeo_uEmissiveMap;"),p.material.emissiveMap.matrix&&l("uniform mat4 xeo_uEmissiveMapMatrix;")),p.material.opacityMap&&(l("uniform sampler2D xeo_uOpacityMap;"),p.material.opacityMap.matrix&&l("uniform mat4 xeo_uOpacityMapMatrix;")),p.material.ambientMap&&(l("uniform sampler2D xeo_uAmbientMap;"),p.material.ambientMap.matrix&&l("uniform mat4 xeo_uAmbientMapMatrix;")),p.material.diffuseMap&&(l("uniform sampler2D xeo_uDiffuseMap;"),p.material.diffuseMap.matrix&&l("uniform mat4 xeo_uDiffuseMapMatrix;")),r&&(p.material.specularMap&&(l("uniform sampler2D xeo_uSpecularMap;"),p.material.specularMap.matrix&&l("uniform mat4 xeo_uSpecularMapMatrix;")),p.material.reflectivityMap&&(l("uniform sampler2D xeo_uTextureReflectivity;"),p.material.reflectivityMap.matrix&&l("uniform mat4 xeo_uTextureReflectivityMatrix;")),s&&(l("uniform sampler2D xeo_uNormalMap;"),p.material.normalMap.matrix&&l("uniform mat4 xeo_uNormalMapMatrix;")))),l("uniform vec3 xeo_uLightAmbientColor;"),l("uniform float xeo_uLightAmbientIntensity;"),r){for(l("varying vec3 xeo_vViewEyeVec;"),l("varying vec3 xeo_vViewNormal;"),b=0,c=p.lights.lights.length;b<c;b++)d=p.lights.lights[b],"ambient"!==d.type&&(l("uniform vec3 xeo_uLightColor"+b+";"),l("uniform float xeo_uLightIntensity"+b+";"),"point"===d.type&&l("uniform vec3 xeo_uLightAttenuation"+b+";"),l("varying vec4 xeo_vViewLightVecAndDist"+b+";"));(u||v||w||y||x)&&(l(),m("Fresnel variables"),l(),u&&(l("uniform float xeo_uDiffuseFresnelCenterBias;"),l("uniform float xeo_uDiffuseFresnelEdgeBias;"),l("uniform float xeo_uDiffuseFresnelPower;"),l("uniform vec3 xeo_uDiffuseFresnelCenterColor;"),l("uniform vec3 xeo_uDiffuseFresnelEdgeColor;"),l()),v&&(l("uniform float xeo_uSpecularFresnelCenterBias;"),l("uniform float xeo_uSpecularFresnelEdgeBias;"),l("uniform float xeo_uSpecularFresnelPower;"),l("uniform vec3 xeo_uSpecularFresnelCenterColor;"),l("uniform vec3 xeo_uSpecularFresnelEdgeColor;"),l()),w&&(l("uniform float xeo_uOpacityFresnelCenterBias;"),l("uniform float xeo_uOpacityFresnelEdgeBias;"),l("uniform float xeo_uOpacityFresnelPower;"),l("uniform vec3 xeo_uOpacityFresnelCenterColor;"),l("uniform vec3 xeo_uOpacityFresnelEdgeColor;"),l()),x&&(l("uniform float xeo_uReflectivityFresnelCenterBias;"),l("uniform float xeo_uReflectivityFresnelEdgeBias;"),l("uniform float xeo_uReflectivityFresnelPower;"),l("uniform vec3 xeo_uReflectivityFresnelCenterColor;"),l("uniform vec3 xeo_uReflectivityFresnelEdgeColor;"),l()),y&&(l("uniform float xeo_uEmissiveFresnelCenterBias;"),l("uniform float xeo_uEmissiveFresnelEdgeBias;"),l("uniform float xeo_uEmissiveFresnelPower;"),l("uniform vec3 xeo_uEmissiveFresnelCenterColor;"),l("uniform vec3 xeo_uEmissiveFresnelEdgeColor;"),l()),m("Fresnel calculation"),l(),l("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),l("    float fr = abs(dot(eyeDir, normal));"),l("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),l("    return pow(finalFr, power);"),l("}"))}if(l(),l("void main(void) {"),l(),l("   vec3 ambient = xeo_uLightAmbientColor;"),l("   vec3 emissive = xeo_uEmissive;"),l("   float opacity = xeo_uOpacity;"),l(p.geometry.colors?"   vec3 diffuse = xeo_vColor.rgb;":"   vec3 diffuse = xeo_uDiffuse;"),r&&(l("vec3 viewEyeVec = normalize(xeo_vViewEyeVec);"),l("   vec3 specular = xeo_uSpecular;"),l("   float shininess = xeo_uShininess;"),l("   float reflectivity = xeo_uReflectivity;"),l(s?"   vec3 viewNormal = vec3(0.0, 1.0, 0.0);":"   vec3 viewNormal = normalize(xeo_vViewNormal);")),q){l(),m("   Apply textures"),l(),l("   vec4 texturePos = vec4(xeo_vUV.s, xeo_vUV.t, 1.0, 1.0);"),l("   vec2 textureCoord;");var e=p.material;e.emissiveMap&&(l(),l(e.emissiveMap.matrix?"   textureCoord = (xeo_uEmissiveMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   emissive = texture2D(xeo_uEmissiveMap, textureCoord).rgb;")),e.opacityMap&&(l(),l(e.opacityMap.matrix?"   textureCoord = (xeo_uOpacityMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   opacity = texture2D(xeo_uOpacityMap, textureCoord).b;")),e.ambientMap&&(l(),l(e.ambientMap.matrix?"   textureCoord = (xeo_uAmbientMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   ambient = texture2D(xeo_uAmbientMap, textureCoord).rgb;")),e.diffuseMap&&(l(),l(e.diffuseMap.matrix?"   textureCoord = (xeo_uDiffuseMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   diffuse = texture2D(xeo_uDiffuseMap, textureCoord).rgb;")),r&&(e.specularMap&&(l(),l(e.specularMap.matrix?"   textureCoord = (xeo_uSpecularMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   specular = texture2D(xeo_uSpecularMap, textureCoord).rgb;")),e.reflectivityMap&&(l(),l(e.reflectivityMap.matrix?"   textureCoord = (xeo_uReflectivityMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   reflectivity = texture2D(xeo_uReflectivityMap, textureCoord).b;"))),s&&(l(),l(e.normalMap.matrix?"   textureCoord = (xeo_uNormalMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   viewNormal = normalize(texture2D(xeo_uNormalMap, vec2(textureCoord.x, textureCoord.y)).xyz * 2.0 - 1.0);"))}if(l("   vec4 fragColor;"),r){for(l(),l("   vec3  diffuseLight = vec3(0.0, 0.0, 0.0);"),l("   vec3  specularLight = vec3(0.0, 0.0, 0.0);"),l(),l("   vec3  viewLightVec;"),l("   float specAngle;"),l("   float lightDist;"),l("   float attenuation;"),b=0,c=p.lights.lights.length;b<c;b++)d=p.lights.lights[b],"ambient"!==d.type&&(l("   viewLightVec = normalize(xeo_vViewLightVecAndDist"+b+".xyz);"),"point"===d.type&&(l(),l("   specAngle = max(dot(viewNormal, viewLightVec), 0.0);"),l("   lightDist = xeo_vViewLightVecAndDist"+b+".w;"),l("   attenuation = 1.0 - (  xeo_uLightAttenuation"+b+"[0] +   xeo_uLightAttenuation"+b+"[1] * lightDist +   xeo_uLightAttenuation"+b+"[2] * lightDist * lightDist);"),l("   diffuseLight += xeo_uLightIntensity"+b+" * specAngle * xeo_uLightColor"+b+" * attenuation;"),l("   specularLight += xeo_uLightIntensity"+b+" *  pow(max(dot(reflect(-viewLightVec, -viewNormal), viewEyeVec), 0.0), shininess) * attenuation;")),"dir"===d.type&&(l("   specAngle = max(dot(viewNormal, -viewLightVec), 0.0);"),l("   diffuseLight += xeo_uLightIntensity"+b+" * specAngle * xeo_uLightColor"+b+";"),l("   specularLight += xeo_uLightIntensity"+b+" * pow(max(dot(reflect(viewLightVec, -viewNormal), viewEyeVec), 0.0), shininess);")));l(),(u||v||w||y||x)&&(l(),m("   Apply Fresnels"),u&&(l(),l("float diffuseFresnel = fresnel(viewEyeVec, viewNormal, xeo_uDiffuseFresnelEdgeBias, xeo_uDiffuseFresnelCenterBias, xeo_uDiffuseFresnelPower);"),l("diffuse *= mix(xeo_uDiffuseFresnelEdgeColor, xeo_uDiffuseFresnelCenterColor, diffuseFresnel);")),v&&(l(),l("float specularFresnel = fresnel(viewEyeVec, viewNormal, xeo_uSpecularFresnelEdgeBias, xeo_uSpecularFresnelCenterBias, xeo_uSpecularFresnelPower);"),l("specular *= mix(xeo_uSpecularFresnelEdgeColor, xeo_uSpecularFresnelCenterColor, specularFresnel);")),w&&(l(),l("float opacityFresnel = fresnel(viewEyeVec, viewNormal, xeo_uOpacityFresnelEdgeBias, xeo_uOpacityFresnelCenterBias, xeo_uOpacityFresnelPower);"),l("opacity *= mix(xeo_uOpacityFresnelEdgeColor.r, xeo_uOpacityFresnelCenterColor.r, opacityFresnel);")),y&&(l(),l("float emissiveFresnel = fresnel(viewEyeVec, viewNormal, xeo_uEmissiveFresnelEdgeBias, xeo_uEmissiveFresnelCenterBias, xeo_uEmissiveFresnelPower);"),l("emissive *= mix(xeo_uEmissiveFresnelEdgeColor, xeo_uEmissiveFresnelCenterColor, emissiveFresnel);"))),l(),m("   Phong BRDF"),l(),l("   fragColor = vec4((specular * specularLight) + ((diffuseLight + (ambient * xeo_uLightAmbientIntensity) ) * diffuse) + emissive, opacity);")}else l(),m("   Non-Lambertian BRDF"),l(),l("   fragColor = vec4(emissive + diffuse, opacity);");return l("   fragColor.rgb *= fragColor.a;"),l("   gl_FragColor = fragColor;"),l("}"),n()}function k(){E=[]}function l(a){E.push(a||"")}function m(a){if(a){for(var b=0,c=0,d=a.length;c<d;c++)" "===a.charAt(c)&&b++;var e=b>0?a.substring(0,b-1):"";E.push(e+"// "+a.substring(b-1))}}function n(){return E}function o(a){return a.getShaderPrecisionFormat?a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT).precision>0?"highp":a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}var p,q,r,s,t,u,v,w,x,y,z,A,B,C,D={},E="";this.getSource=function(k,l){var m=D[k];return m?(m.useCount++,m):(p=l,q=a(),r=c(),s=d(),t=b(),u=p.material.diffuseFresnel,v=p.material.specularFresnel,w=p.material.opacityFresnel,x=p.material.reflectivityFresnel,y=p.material.emissiveFresnel,m=new xeogl.renderer.ProgramSource(k,e(),f(),g(),h(),i(),j()),D[k]=m,m)},this.putSource=function(a){var b=D[a];b&&0===--b.useCount&&(D[b.hash]=null)}}}(),function(){"use strict";xeogl.renderer.Chunk=function(){},xeogl.renderer.Chunk.prototype.init=function(a,b,c){this.id=a,this.program=b,this.state=c,this.useCount=0,this.build&&this.build()}}(),function(){"use strict";xeogl.renderer.ChunkFactory=function(){this.types=xeogl.renderer.ChunkFactory.types},xeogl.renderer.ChunkFactory.types={},xeogl.renderer.ChunkFactory.createChunkType=function(a){if(!a.type)throw"'type' expected in params";var b=xeogl.renderer.Chunk,c=function(){this.useCount=0,this.init.apply(this,arguments)};return c.prototype=new b,c.prototype.constructor=c,xeogl._apply(a,c.prototype),xeogl.renderer.ChunkFactory.types[a.type]={constructor:c,chunks:{},freeChunks:[],freeChunksLen:0},c},xeogl.renderer.ChunkFactory.prototype.getChunk=function(a,b,c,d){var e=this.types[b];if(!e)throw"chunk type not supported: '"+b+"'";var f=e.chunks[a];return f?(f.useCount++,f):(e.freeChunksLen>0&&(f=e.freeChunks[--e.freeChunksLen]),f?f.init(a,c,d):f=new e.constructor(a,c,d),f.useCount=1,e.chunks[a]=f,f)},xeogl.renderer.ChunkFactory.prototype.putChunk=function(a){if(0!==a.useCount&&--a.useCount<=0){var b=this.types[a.type];delete b.chunks[a.id],b.freeChunks[b.freeChunksLen++]=a}},xeogl.renderer.ChunkFactory.prototype.webglRestored=function(a){var b,c,d,e=this.types;for(var f in e)if(e.hasOwnProperty(f)){b=e[f],c=b.chunks;for(var g in c)c.hasOwnProperty(g)&&(d=c[g],d.build&&d.build())}}}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"clips",build:function(){var a,b;this._uClipModeDraw=this._uClipModeDraw||[],this._uClipPlaneDraw=this._uClipPlaneDraw||[];var c=this.program.draw;for(a=0,b=this.state.clips.length;a<b;a++)this._uClipModeDraw[a]=c.getUniform("xeo_uClipMode"+a),this._uClipPlaneDraw[a]=c.getUniform("xeo_uClipPlane"+a);this._uClipModePick=this._uClipModePick||[],this._uClipPlanePick=this._uClipPlanePick||[];var d=this.program.pick;for(a=0,b=this.state.clips.length;a<b;a++)this._uClipModePick[a]=d.getUniform("xeo_uClipMode"+a),this._uClipPlanePick[a]=d.getUniform("xeo_uClipPlane"+a)},drawPick:function(a){return}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"colorBuf",programGlobal:!0,draw:function(a){if(!a.transparent){var b=this.state,c=b.blendEnabled,d=this.program.gl;a.blendEnabled!==c&&(c?d.enable(d.BLEND):d.disable(d.BLEND),a.blendEnabled=c);var e=b.colorMask;d.colorMask(e[0],e[1],e[2],e[3])}}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"cubemap",build:function(){},draw:function(a){}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"depthBuf",programGlobal:!0,draw:function(a){var b=this.program.gl,c=this.state,d=c.active;a.depthbufEnabled!==d&&(d?b.enable(b.DEPTH_TEST):b.disable(b.DEPTH_TEST),a.depthbufEnabled=d);var e=c.clearDepth;a.clearDepth!==e&&(b.clearDepth(e),a.clearDepth=e);var f=c.depthFunc;a.depthFunc!==f&&(b.depthFunc(f),a.depthFunc=f),c.clear&&b.clear(b.DEPTH_BUFFER_BIT)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"draw",unique:!0,build:function(){this._uPickColorObject=this.program.pickObject.getUniform("xeo_uPickColor")},draw:function(a){var b=this.state,c=this.program.gl;b.indices&&(c.drawElements(b.primitive,b.indices.numItems,b.indices.itemType,0),a.drawElements++)},pickObject:function(a){var b=this.state,c=this.program.gl;if(this._uPickColorObject){a.pickIndex++;var d=a.pickIndex>>16&255,e=a.pickIndex>>8&255,f=255&a.pickIndex;this._uPickColorObject.setValue([f/255,e/255,d/255,1])}b.indices&&(c.drawElements(b.primitive,b.indices.numItems,b.indices.itemType,0),a.drawElements++)},pickPrimitive:function(){var a=this.state,b=this.program.gl,c=a.getPickPositions();c&&b.drawArrays(a.primitive,0,c.numItems/3)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"geometry",build:function(){var a=this.program.draw;this._aPositionDraw=a.getAttribute("xeo_aPosition"),this._aNormalDraw=a.getAttribute("xeo_aNormal"),this._aUVDraw=a.getAttribute("xeo_aUV"),this._aTangentDraw=a.getAttribute("xeo_aTangent"),this._aColorDraw=a.getAttribute("xeo_aColor");var b=this.program.pickObject;this._aPositionPickObject=b.getAttribute("xeo_aPosition");var c=this.program.pickPrimitive;this._aPositionPickPrimitive=c.getAttribute("xeo_aPosition"),this._aColorPickPrimitive=c.getAttribute("xeo_aColor")},draw:function(a){var b=this.state;this._aPositionDraw&&(this._aPositionDraw.bindFloatArrayBuffer(b.positions),a.bindArray++),this._aNormalDraw&&(this._aNormalDraw.bindFloatArrayBuffer(b.normals),a.bindArray++),this._aUVDraw&&(this._aUVDraw.bindFloatArrayBuffer(b.uv),a.bindArray++),this._aColorDraw&&(this._aColorDraw.bindFloatArrayBuffer(b.colors),a.bindArray++),this._aTangentDraw&&(this._aTangentDraw.bindFloatArrayBuffer(b.getTangents()),a.bindArray++),b.indices&&(b.indices.bind(),a.bindArray++)},pickObject:function(){var a=this.state;this._aPositionPickObject&&this._aPositionPickObject.bindFloatArrayBuffer(a.positions),a.indices&&a.indices.bind()},pickPrimitive:function(){var a=this.state;this._aPositionPickPrimitive&&this._aPositionPickPrimitive.bindFloatArrayBuffer(a.getPickPositions()),this._aColorPickPrimitive&&this._aColorPickPrimitive.bindFloatArrayBuffer(a.getPickColors())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"lights",build:function(){this._uLightAmbientColor=this._uLightAmbientColor||[],this._uLightAmbientIntensity=this._uLightAmbientIntensity||[],this._uLightColor=this._uLightColor||[],this._uLightIntensity=this._uLightIntensity||[],this._uLightDir=this._uLightDir||[],this._uLightPos=this._uLightPos||[],this._uLightAttenuation=this._uLightAttenuation||[];for(var a=this.state.lights,b=this.program,c=0,d=a.length;c<d;c++)switch(a[c].type){case"ambient":this._uLightAmbientColor[c]=b.draw.getUniform("xeo_uLightAmbientColor"),this._uLightAmbientIntensity[c]=b.draw.getUniform("xeo_uLightAmbientIntensity");break;case"dir":this._uLightColor[c]=b.draw.getUniform("xeo_uLightColor"+c),this._uLightIntensity[c]=b.draw.getUniform("xeo_uLightIntensity"+c),this._uLightPos[c]=null,this._uLightDir[c]=b.draw.getUniform("xeo_uLightDir"+c);break;case"point":this._uLightColor[c]=b.draw.getUniform("xeo_uLightColor"+c),this._uLightIntensity[c]=b.draw.getUniform("xeo_uLightIntensity"+c),this._uLightPos[c]=b.draw.getUniform("xeo_uLightPos"+c),this._uLightDir[c]=null,this._uLightAttenuation[c]=b.draw.getUniform("xeo_uLightAttenuation"+c)}},draw:function(){for(var a,b=this.state.lights,c=0,d=b.length;c<d;c++)a=b[c],this._uLightAmbientColor[c]?(this._uLightAmbientColor[c].setValue(a.color),this._uLightAmbientIntensity[c]&&this._uLightAmbientIntensity[c].setValue(a.intensity)):(this._uLightColor[c]&&this._uLightColor[c].setValue(a.color),this._uLightIntensity[c]&&this._uLightIntensity[c].setValue(a.intensity),this._uLightPos[c]&&(this._uLightPos[c].setValue(a.pos),this._uLightAttenuation[c]&&this._uLightAttenuation[c].setValue(a.attenuation)),this._uLightDir[c]&&this._uLightDir[c].setValue(a.dir))}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"modelTransform",build:function(){this._uModelMatrixDraw=this.program.draw.getUniform("xeo_uModelMatrix"),this._uModelNormalMatrixDraw=this.program.draw.getUniform("xeo_uModelNormalMatrix"),this._uModelMatrixPickObject=this.program.pickObject.getUniform("xeo_uModelMatrix"),this._uModelMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uModelMatrix")},draw:function(){this._uModelMatrixDraw&&this._uModelMatrixDraw.setValue(this.state.getMatrix()),this._uModelNormalMatrixDraw&&this._uModelNormalMatrixDraw.setValue(this.state.getNormalMatrix())},pickObject:function(){this._uModelMatrixPickObject&&this._uModelMatrixPickObject.setValue(this.state.getMatrix())},pickPrimitive:function(){this._uModelMatrixPickPrimitive&&this._uModelMatrixPickPrimitive.setValue(this.state.getMatrix())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"modes",build:function(){},draw:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e);var f=b.transparent;a.transparent!==f&&(a.pick||(f?(c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE_MINUS_SRC_ALPHA),a.blendEnabled=!0):(c.disable(c.BLEND),a.blendEnabled=!1)),a.transparent=f)},pickObject:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)},pickPrimitive:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"phongMaterial",build:function(){var a=this.state,b=this.program.draw;this._uDiffuse=b.getUniform("xeo_uDiffuse"),this._uSpecular=b.getUniform("xeo_uSpecular"),this._uEmissive=b.getUniform("xeo_uEmissive"),this._uOpacity=b.getUniform("xeo_uOpacity"),this._uShininess=b.getUniform("xeo_uShininess"),this._uPointSize=b.getUniform("xeo_uPointSize"),a.ambientMap&&(this._uAmbientMap="xeo_uAmbientMap",this._uAmbientMapMatrix=b.getUniform("xeo_uAmbientMapMatrix")),a.diffuseMap&&(this._uDiffuseMap="xeo_uDiffuseMap",this._uDiffuseMapMatrix=b.getUniform("xeo_uDiffuseMapMatrix")),a.specularMap&&(this._uSpecularMap="xeo_uSpecularMap",this._uSpecularMapMatrix=b.getUniform("xeo_uSpecularMapMatrix")),a.emissiveMap&&(this._uEmissiveMap="xeo_uEmissiveMap",
this._uEmissiveMapMatrix=b.getUniform("xeo_uEmissiveMapMatrix")),a.opacityMap&&(this._uOpacityMap="xeo_uOpacityMap",this._uOpacityMapMatrix=b.getUniform("xeo_uOpacityMapMatrix")),a.reflectivityMap&&(this._uReflectivityMap="xeo_uReflectivityMap",this._uReflectivityMapMatrix=b.getUniform("xeo_uReflectivityMapMatrix")),a.normalMap&&(this._uNormalMap="xeo_uNormalMap",this._uNormalMapMatrix=b.getUniform("xeo_uNormalMapMatrix")),a.diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=b.getUniform("xeo_uDiffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=b.getUniform("xeo_uDiffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=b.getUniform("xeo_uDiffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=b.getUniform("xeo_uDiffuseFresnelCenterColor"),this._uDiffuseFresnelPower=b.getUniform("xeo_uDiffuseFresnelPower")),a.specularFresnel&&(this._uSpecularFresnelEdgeBias=b.getUniform("xeo_uSpecularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=b.getUniform("xeo_uSpecularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=b.getUniform("xeo_uSpecularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=b.getUniform("xeo_uSpecularFresnelCenterColor"),this._uSpecularFresnelPower=b.getUniform("xeo_uSpecularFresnelPower")),a.opacityFresnel&&(this._uOpacityFresnelEdgeBias=b.getUniform("xeo_uOpacityFresnelEdgeBias"),this._uOpacityFresnelCenterBias=b.getUniform("xeo_uOpacityFresnelCenterBias"),this._uOpacityFresnelEdgeColor=b.getUniform("xeo_uOpacityFresnelEdgeColor"),this._uOpacityFresnelCenterColor=b.getUniform("xeo_uOpacityFresnelCenterColor"),this._uOpacityFresnelPower=b.getUniform("xeo_uOpacityFresnelPower")),a.reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=b.getUniform("xeo_uReflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=b.getUniform("xeo_uReflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=b.getUniform("xeo_uReflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=b.getUniform("xeo_uReflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=b.getUniform("xeo_uReflectivityFresnelPower")),a.emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=b.getUniform("xeo_uEmissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=b.getUniform("xeo_uEmissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=b.getUniform("xeo_uEmissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=b.getUniform("xeo_uEmissiveFresnelCenterColor"),this._uEmissiveFresnelPower=b.getUniform("xeo_uEmissiveFresnelPower"))},draw:function(a){var b=this.program.draw,c=this.state,d=this.program.gl;this._uShininess&&this._uShininess.setValue(c.shininess),a.lineWidth!==c.lineWidth&&(d.lineWidth(c.lineWidth),a.lineWidth=c.lineWidth),this._uPointSize&&this._uPointSize.setValue(c.pointSize),c.ambientMap&&c.ambientMap.texture&&(b.bindTexture(this._uAmbientMap,c.ambientMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uAmbientMapMatrix&&this._uAmbientMapMatrix.setValue(c.ambientMap.matrix)),c.diffuseMap&&c.diffuseMap.texture?(b.bindTexture(this._uDiffuseMap,c.diffuseMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uDiffuseMapMatrix&&this._uDiffuseMapMatrix.setValue(c.diffuseMap.matrix)):this._uDiffuse&&this._uDiffuse.setValue(c.diffuse),c.specularMap&&c.specularMap.texture?(b.bindTexture(this._uSpecularMap,c.specularMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uSpecularMapMatrix&&this._uSpecularMapMatrix.setValue(c.specularMap.matrix)):this._uSpecular&&this._uSpecular.setValue(c.specular),c.emissiveMap&&c.emissiveMap.texture?(b.bindTexture(this._uEmissiveMap,c.emissiveMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uEmissiveMapMatrix&&this._uEmissiveMapMatrix.setValue(c.emissiveMap.matrix)):this._uEmissive&&this._uEmissive.setValue(c.emissive),c.opacityMap&&c.opacityMap.texture?(b.bindTexture(this._uOpacityMap,c.opacityMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uOpacityMapMatrix&&this._uOpacityMapMatrix.setValue(c.opacityMap.matrix)):this._uOpacity&&this._uOpacity.setValue(c.opacity),c.reflectivityMap&&c.reflectivityMap.texture&&(b.bindTexture(this._uReflectivityMap,c.reflectivityMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),this._uReflectivityMapMatrix&&this._uReflectivityMapMatrix.setValue(c.reflectivityMap.matrix)),c.normalMap&&c.normalMap.texture&&(b.bindTexture(this._uNormalMap,c.normalMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uNormalMapMatrix&&this._uNormalMapMatrix.setValue(c.normalMap.matrix)),c.diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&this._uDiffuseFresnelEdgeBias.setValue(c.diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&this._uDiffuseFresnelCenterBias.setValue(c.diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&this._uDiffuseFresnelEdgeColor.setValue(c.diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&this._uDiffuseFresnelCenterColor.setValue(c.diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&this._uDiffuseFresnelPower.setValue(c.diffuseFresnel.power)),c.specularFresnel&&(this._uSpecularFresnelEdgeBias&&this._uSpecularFresnelEdgeBias.setValue(c.specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&this._uSpecularFresnelCenterBias.setValue(c.specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&this._uSpecularFresnelEdgeColor.setValue(c.specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&this._uSpecularFresnelCenterColor.setValue(c.specularFresnel.centerColor),this._uSpecularFresnelPower&&this._uSpecularFresnelPower.setValue(c.specularFresnel.power)),c.opacityFresnel&&(this._uOpacityFresnelEdgeBias&&this._uOpacityFresnelEdgeBias.setValue(c.opacityFresnel.edgeBias),this._uOpacityFresnelCenterBias&&this._uOpacityFresnelCenterBias.setValue(c.opacityFresnel.centerBias),this._uOpacityFresnelEdgeColor&&this._uOpacityFresnelEdgeColor.setValue(c.opacityFresnel.edgeColor),this._uOpacityFresnelCenterColor&&this._uOpacityFresnelCenterColor.setValue(c.opacityFresnel.centerColor),this._uOpacityFresnelPower&&this._uOpacityFresnelPower.setValue(c.opacityFresnel.power)),c.reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&this._uReflectivityFresnelEdgeBias.setValue(c.reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&this._uReflectivityFresnelCenterBias.setValue(c.reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&this._uReflectivityFresnelEdgeColor.setValue(c.reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&this._uReflectivityFresnelCenterColor.setValue(c.reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&this._uReflectivityFresnelPower.setValue(c.reflectivityFresnel.power)),c.emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&this._uEmissiveFresnelEdgeBias.setValue(c.emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&this._uEmissiveFresnelCenterBias.setValue(c.emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&this._uEmissiveFresnelEdgeColor.setValue(c.emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&this._uEmissiveFresnelCenterColor.setValue(c.emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&this._uEmissiveFresnelPower.setValue(c.emissiveFresnel.power))}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"program",build:function(){},draw:function(a){this.program.draw.bind(),a.useProgram++},pickObject:function(){this.program.pickObject.bind()},pickPrimitive:function(){this.program.pickPrimitive.bind()}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"projTransform",build:function(){this._uProjMatrixDraw=this.program.draw.getUniform("xeo_uProjMatrix"),this._uProjMatrixPickObject=this.program.pickObject.getUniform("xeo_uProjMatrix"),this._uProjMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uProjMatrix")},draw:function(){this._uProjMatrixDraw&&this._uProjMatrixDraw.setValue(this.state.getMatrix())},pickObject:function(a){this._uProjMatrixPickObject&&this._uProjMatrixPickObject.setValue(a.pickProjMatrix||this.state.getMatrix())},pickPrimitive:function(a){this._uProjMatrixPickPrimitive&&this._uProjMatrixPickPrimitive.setValue(a.pickProjMatrix||this.state.getMatrix())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"renderTarget",programGlobal:!0,draw:function(a){var b=this.program.gl,c=this.state;a.renderBuf&&(b.flush(),a.renderBuf.unbind(),a.renderBuf=null,a.bindOutputFramebuffer&&a.bindOutputFramebuffer(a.pass));var d=c.renderBuf;return d?(d.bind(),a.depthMode=c.type===c.DEPTH,a.blendEnabled&&!a.depthMode&&(b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE_MINUS_SRC_ALPHA)),b.viewport(0,0,b.drawingBufferWidth,b.drawingBufferHeight),b.clearColor(a.ambientColor[0],a.ambientColor[1],a.ambientColor[2],1),void(a.renderBuf=d)):void(a.depthMode=!1)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"shader",draw:function(){var a=this.state.params;if(a){var b,c=this.program.draw;for(b in a)a.hasOwnProperty(b)&&c.setUniform(b,a[b])}}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"shaderParams",draw:function(){var a=this.state.params;if(a){var b,c=this.program.draw;for(b in a)a.hasOwnProperty(b)&&c.setUniform(b,a[b])}}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"viewTransform",build:function(){this._uViewMatrixDraw=this.program.draw.getUniform("xeo_uViewMatrix"),this._uViewNormalMatrixDraw=this.program.draw.getUniform("xeo_uViewNormalMatrix"),this._uViewMatrixPickObject=this.program.pickObject.getUniform("xeo_uViewMatrix"),this._uViewMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uViewMatrix")},draw:function(){this._uViewMatrixDraw&&this._uViewMatrixDraw.setValue(this.state.getMatrix()),this._uViewNormalMatrixDraw&&this._uViewNormalMatrixDraw.setValue(this.state.getNormalMatrix())},pickObject:function(a){this._uViewMatrixPickObject&&this._uViewMatrixPickObject.setValue(a.pickViewMatrix||this.state.getMatrix())},pickPrimitive:function(a){this._uViewMatrixPickPrimitive&&this._uViewMatrixPickPrimitive.setValue(a.pickViewMatrix||this.state.getMatrix())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"viewport",programGlobal:!0,draw:function(){var a=this.state.boundary;this.program.gl.viewport(a[0],a[1],a[2],a[3])},pickObject:function(){var a=this.state.boundary;this.program.gl.viewport(a[0],a[1],a[2],a[3])},pickPrimitive:function(){var a=this.state.boundary;this.program.gl.viewport(a[0],a[1],a[2],a[3])}})}(),function(){"use strict";xeogl.Component=Class.extend({__init:function(){var a={},b=arguments[0],c=arguments[1];this.scene=null,"xeogl.Scene"===this.type?(this.scene=this,b&&(a=b)):(b?"xeogl.Scene"===b.type?(this.scene=b,c&&(a=c)):(this.scene=xeogl.scene,a=b):this.scene=xeogl.scene,this._renderer=this.scene._renderer),this.meta=a.meta||{},this.isDefault=a.isDefault,this.id=a.id,this.destroyed=!1,this._attached={},this._attachments=null,this._events=null,this._handleMap=null,this._handleEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._sharedComponents=null,this.scene&&"xeogl.Scene"!==this.type&&this.scene._addComponent(this),this._updateScheduled=!1,this._init&&this._init(a)},type:"xeogl.Component",superTypes:[],isType:function(a){return!(!xeogl._isString(a)&&!(a=a.type))&&xeogl._isComponentType(this.type,a)},_init:function(a){},fire:function(a,b,c){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),c!==!0&&(this._events[a]=b);var d,e=this._eventSubs[a];if(e)for(var f in e)e.hasOwnProperty(f)&&(d=e[f],this._eventCallDepth++,this._eventCallDepth<300?d.callback.call(d.scope,b):this.error("fire: potential stack overflow from recursive event '"+a+"' - dropping this event"),this._eventCallDepth--)},on:function(a,b,c){this._events||(this._events={}),this._handleMap||(this._handleMap=new xeogl.utils.Map),this._handleEvents||(this._handleEvents={}),this._eventSubs||(this._eventSubs={});var d=this._eventSubs[a];d||(d={},this._eventSubs[a]=d);var e=this._handleMap.addItem();d[e]={callback:b,scope:c||this},this._handleEvents[e]=a;var f=this._events[a];return void 0!==f&&b.call(c||this,f),e},off:function(a){if(void 0!==a&&null!==a&&this._handleEvents){var b=this._handleEvents[a];if(b){delete this._handleEvents[a];var c=this._eventSubs[b];c&&delete c[a],this._handleMap.removeItem(a)}}},once:function(a,b,c){var d=this,e=this.on(a,function(a){d.off(e),b(a)},c)},log:function(a){a="[LOG]"+this._message(a),window.console.log(a),this.scene.fire("log",a)},_message:function(a){return" ["+this.type+" "+xeogl._inQuotes(this.id)+"]: "+a},warn:function(a){a="[WARN]"+this._message(a),window.console.warn(a),this.scene.fire("warn",a)},error:function(a){a="[ERROR]"+this._message(a),window.console.error(a),this.scene.fire("error",a)},clone:function(a){if(this.destroyed)return void this.error("Clone failed - component has been destroyed");a=a||{};var b=this.json;return delete b.id,new this.constructor(this.scene,xeogl._apply(a,b))},_attach:function(a){var b=a.name;if(!b)return void this.error("Component 'name' expected");var c=a.component,d=a.sceneDefault,e=a.sceneSingleton,f=a.type,g=a.on,h=a.recompiles!==!1,i=!1;if(c)if(xeogl._isNumeric(c)||xeogl._isString(c)){var j=c;if(c=this.scene.components[j],!c)return void this.error("Component not found: "+xeogl._inQuotes(j))}else if(xeogl._isObject(c)){var k=c,l=k.type||f||"xeogl.Component",m=window[l];if(!m)return void this.error("Component type not found: "+l);if(f&&!xeogl._isComponentType(l,f))return void this.error("Expected a "+f+" type or subtype, not a "+l);c=new m(k),i=!0}if(!c)if(e===!0){var n=this.scene.types[f];for(var o in n)if(n.hasOwnProperty){c=n[o];break}if(!c)return this.error("Scene has no default component for '"+b+"'"),null}else if(d===!0&&(c=this.scene[b],!c))return this.error("Scene has no default component for '"+b+"'"),null;if(c){if(c.scene.id!==this.scene.id)return void this.error("Not in same scene: "+c.type+" "+xeogl._inQuotes(c.id));if(f&&!c.isType(f))return void this.error("Expected a "+f+" type or subtype: "+c.type+" "+xeogl._inQuotes(c.id))}this._attachments||(this._attachments={});var p,q,r,s=this._attached[b];if(s){if(c&&s.id===c.id)return;var t=this._attachments[s.id];for(p=t.subs,q=0,r=p.length;q<r;q++)s.off(p[q]);delete this._attached[b],delete this._attachments[s.id];var u=t.params.onDetached;u&&(xeogl._isFunction(u)?u(s):u.scope?u.callback.call(u.scope,s):u.callback(s)),t.managingLifecycle&&s.destroy()}if(c){var v={params:a,component:c,subs:[],managingLifecycle:i};v.subs.push(c.on("destroyed",function(){v.params.component=null,this._attach(v.params)},this)),h&&v.subs.push(c.on("dirty",function(){this.fire("dirty",this)},this)),this._attached[b]=c,this._attachments[c.id]=v;var w=a.onAttached;if(w&&(xeogl._isFunction(w)?w(c):w.scope?w.callback.call(w.scope,c):w.callback(c)),g){var x,y,z,A;for(x in g)if(g.hasOwnProperty(x)){if(y=g[x],xeogl._isFunction(y)?(z=y,A=null):(z=y.callback,A=y.scope),!z)continue;v.subs.push(c.on(x,z,A))}}}return h&&this.fire("dirty",this),this.fire(b,c),c},create:function(a,b){var c=this.scene._getSharedComponent(a,b);return c&&(this._sharedComponents||(this._sharedComponents={}),this._sharedComponents[c.id]||(this._sharedComponents[c.id]=c),c.on("destroyed",function(){delete this._sharedComponents[c.id]},this)),c},_scheduleUpdate:function(a){this._updateScheduled||(this._updateScheduled=!0,0===a?xeogl.deferTask(this._doUpdate,this):xeogl.scheduleTask(this._doUpdate,this))},_doUpdate:function(){this._updateScheduled&&(this._update&&this._update(),this._updateScheduled=!1)},_update:null,_compile:function(){},_props:{json:{get:function(){var a={type:this.type,id:this.id};return xeogl._isEmptyObject(this.meta)||(a.meta=this.meta),this._getJSON?xeogl._apply(this._getJSON(),a):a}},string:{get:function(){return JSON.stringify(this.json,"\n",4)}},js:{get:function(){var a=this.json;delete a.id;var b=JSON.stringify(a,"\n",4);return"new "+this.type+"("+b+");"}}},destroy:function(){var a,b,c,d,e,f;if(this._attachments)for(a in this._attachments)if(this._attachments.hasOwnProperty(a)){for(b=this._attachments[a],c=b.component,d=b.subs,e=0,f=d.length;e<f;e++)c.off(d[e]);b.managingLifecycle&&c.destroy()}if(this._sharedComponents)for(a in this._sharedComponents)this._sharedComponents.hasOwnProperty(a)&&(c=this._sharedComponents[a],delete this._sharedComponents[a],this.scene._putSharedComponent(c));this._destroy&&this._destroy(),this.fire("destroyed",this.destroyed=!0)},_destroy:function(){}})}(),function(){"use strict";xeogl.Scene=xeogl.Component.extend({type:"xeogl.Scene",_init:function(a){var b=this,c=!!a.transparent;this._componentIDMap=new xeogl.utils.Map,this.startTime=(new Date).getTime(),this.components={},this.types={},this.entities={},this._sharedComponents={},this._sharedComponentIDs={},this._sharedCounts={},this._dirtyEntities={},this.configs=new xeogl.Configs(this,a.configs),this.canvas=new xeogl.Canvas(this,{canvas:a.canvas,transparent:c,backgroundColor:a.backgroundColor,backgroundImage:a.backgroundImage,webgl2:a.webgl2!==!1,contextAttr:a.contextAttr||{}}),this.canvas.on("boundary",function(){b._renderer.imageDirty=!0}),this.canvas.on("webglContextFailed",function(){alert("xeogl failed to find WebGL!")}),this._renderer=new xeogl.renderer.Renderer(xeogl.stats,this.canvas.canvas,this.canvas.gl,{transparent:c}),this.input=new xeogl.Input(this,{element:this.canvas.overlay}),xeogl._addScene(this);var d=a.components;if(d)for(var e,f,g,h=0,i=d.length;h<i;h++)e=d[h],f=e.type,f&&(g=window[f],g&&new g(this,e));this._initDefaults(),this.passes=a.passes,this.clearEachPass=a.clearEachPass},_initDefaults:function(){var a;a=this.view,a=this.project,a=this.camera,a=this.clips,a=this.colorTarget,a=this.colorBuf,a=this.depthTarget,a=this.depthBuf,a=this.visibility,a=this.cull,a=this.modes,a=this.geometry,a=this.layer,a=this.lights,a=this.material,a=this.morphTargets,a=this.reflect,a=this.shader,a=this.shaderParams,a=this.stage,a=this.transform,a=this.viewport},_addComponent:function(a){if(a.id){if(this.components[a.id])return void this.error("Component "+xeogl._inQuotes(a.id)+" already exists in Scene")}else a.id=this._componentIDMap.addItem(a);this.components[a.id]=a;var b=a.type,c=this.types[a.type];c||(c=this.types[b]={}),c[a.id]=a,a.on("destroyed",function(){this._componentDestroyed(a)},this),a.isType("xeogl.Entity")&&(a.on("dirty",this._entityDirty,this),this.entities[a.id]=a,this._worldBoundary&&a.worldBoundary.on("updated",this._setWorldBoundaryDirty,this),xeogl.stats.components.entities++),this.fire("componentCreated",a,!0)},_componentDestroyed:function(a){this._componentIDMap.removeItem(a.id),delete this.components[a.id];var b=this.types[a.type];b&&(delete b[a.id],xeogl._isEmptyObject(b)&&delete this.types[a.type]),a.isType("xeogl.Entity")&&(xeogl.stats.components.entities--,delete this.entities[a.id],delete this._dirtyEntities[a.id]),this.fire("componentDestroyed",a,!0)},_entityDirty:function(a){this._dirtyEntities[a.id]||(this._dirtyEntities[a.id]=a)},render:function(){var a={sceneId:null,pass:null};return function(b){a.sceneId=this.id;var c,d,e=this._passes,f=this._clearEachPass;for(c=0;c<e;c++)a.pass=c,this.fire("rendering",a,!0),d=f||0===c,this._compile(c,d,b),this.fire("rendered",a,!0)}}(),_props:{passes:{set:function(a){void 0===a||null===a?a=1:(!xeogl._isNumeric(a)||a<=0)&&(this.error("Unsupported value for 'passes': '"+a+"' - should be an integer greater than zero."),a=1),a!==this._passes&&(this._passes=a,this._renderer.imageDirty=!0,this.fire("passes",this._passes))},get:function(){return this._passes}},clearEachPass:{set:function(a){a=!!a,a!==this._clearEachPass&&(this._clearEachPass=a,this._renderer.imageDirty=!0,this.fire("clearEachPass",this._clearEachPass))},get:function(){return this._clearEachPass}},project:{get:function(){return this.components["default.project"]||new xeogl.Perspective(this,{id:"default.project",isDefault:!0})}},view:{get:function(){return this.components["default.view"]||new xeogl.Lookat(this,{id:"default.view",isDefault:!0})}},camera:{get:function(){return this.components["default.camera"]||new xeogl.Camera(this,{id:"default.camera",isDefault:!0,project:"default.project",view:"default.view"})}},transform:{get:function(){return this.components["default.transform"]||new xeogl.Transform(this,{id:"default.transform",isDefault:!0})}},billboard:{get:function(){return this.components["default.billboard"]||new xeogl.Billboard(this,{id:"default.billboard",active:!1,isDefault:!0})}},stationary:{get:function(){return this.components["default.stationary"]||new xeogl.Stationary(this,{id:"default.stationary",active:!1,isDefault:!0})}},clips:{get:function(){return this.components["default.clips"]||new xeogl.Clips(this,{id:"default.clips",isDefault:!0})}},colorBuf:{get:function(){return this.components["default.colorBuf"]||new xeogl.ColorBuf(this,{id:"default.colorBuf",isDefault:!0})}},colorTarget:{get:function(){return this.components["default.colorTarget"]||new xeogl.ColorTarget(this,{id:"default.colorTarget",isDefault:!0,active:!1})}},depthBuf:{get:function(){return this.components["default.depthBuf"]||new xeogl.DepthBuf(this,{id:"default.depthBuf",isDefault:!0,active:!0})}},depthTarget:{get:function(){return this.components["default.depthTarget"]||new xeogl.DepthTarget(this,{id:"default.depthTarget",isDefault:!0,active:!1})}},visibility:{get:function(){return this.components["default.visibility"]||new xeogl.Visibility(this,{id:"default.visibility",isDefault:!0,visible:!0})}},cull:{get:function(){return this.components["default.cull"]||new xeogl.Cull(this,{id:"default.cull",isDefault:!0,culled:!1})}},modes:{get:function(){return this.components["default.modes"]||new xeogl.Modes(this,{id:"default.modes",isDefault:!0})}},geometry:{get:function(){return this.components["default.geometry"]||new xeogl.BoxGeometry(this,{id:"default.geometry",isDefault:!0})}},layer:{get:function(){return this.components["default.layer"]||new xeogl.Layer(this,{id:"default.layer",isDefault:!0,priority:0})}},lights:{get:function(){return this.components["default.lights"]||new xeogl.Lights(this,{id:"default.lights",isDefault:!0,lights:[new xeogl.AmbientLight(this,{id:"default.light0",color:[.45,.45,.5],intensity:.9}),new xeogl.DirLight(this,{id:"default.light1",dir:[-.5,.5,-.6],color:[.8,.8,.7],intensity:1,space:"view"}),new xeogl.DirLight(this,{id:"default.light2",dir:[.5,-.5,-.6],color:[.8,.8,.8],intensity:1,space:"view"})]})}},material:{get:function(){return this.components["default.material"]||new xeogl.PhongMaterial(this,{id:"default.material",isDefault:!0})}},morphTargets:{get:function(){return this.components["default.morphTargets"]||new xeogl.MorphTargets(this,{id:"default.morphTargets",isDefault:!0})}},reflect:{get:function(){return this.components["default.reflect"]||new xeogl.Reflect(this,{id:"default.reflect",isDefault:!0})}},shader:{get:function(){return this.components["default.shader"]||this.components["default.shader"]||new xeogl.Shader(this,{id:"default.shader",isDefault:!0})}},shaderParams:{get:function(){return this.components["default.shaderParams"]||new xeogl.ShaderParams(this,{id:"default.shaderParams",isDefault:!0})}},stage:{get:function(){return this.components["default.stage"]||new xeogl.Stage(this,{id:"default.stage",priority:0,isDefault:!0})}},viewport:{get:function(){return this.components["default.viewport"]||new xeogl.Viewport(this,{id:"default.viewport",autoBoundary:!0,isDefault:!0})}},worldBoundary:{get:function(){if(!this._worldBoundary){var a=this,b=xeogl.math.AABB3();this._worldBoundary=new xeogl.Boundary3D(this.scene,{getDirty:function(){return a._worldBoundaryDirty},getAABB:function(){xeogl.math.collapseAABB3(b);var c,d=a.entities;for(var e in d)d.hasOwnProperty(e)&&(c=d[e],c.modes.collidable&&xeogl.math.expandAABB3(b,c.worldBoundary.aabb));return b}}),this._worldBoundary.on("destroyed",function(){a._worldBoundary=null}),this._setWorldBoundaryDirty()}return this._worldBoundary}}},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0)},pick:function(){function a(a,b,d,e){var f=a.scene.canvas.canvas,g=a.transform.leafMatrix,h=a.camera.view.matrix,i=a.camera.project.matrix,j=c.mulMat4(h,g,I),k=c.mulMat4(i,j,J),l=c.inverseMat4(k,K),m=f.width,n=f.height,o=(b[0]-m/2)/(m/2),p=-(b[1]-n/2)/(n/2);t[0]=o,t[1]=p,t[2]=-1,t[3]=1,c.transformVec4(l,t,u),c.mulVec4Scalar(u,1/u[3]),v[0]=o,v[1]=p,v[2]=1,v[3]=1,c.transformVec4(l,v,w),c.mulVec4Scalar(w,1/w[3]),d[0]=w[0],d[1]=w[1],d[2]=w[2],c.subVec3(w,u,e),c.normalizeVec3(e)}function b(a,b,d,e,f){var g=a.transform.leafMatrix,h=c.inverseMat4(g,I);t[0]=b[0],t[1]=b[1],t[2]=b[2],t[3]=1,c.transformVec4(h,t,u),e[0]=u[0],e[1]=u[1],e[2]=u[2],c.transformVec3(h,d,f)}var c=xeogl.math,d=c.vec3(),e=c.vec3(),f=c.vec3(),g=c.vec3(),h=c.vec3(),i=c.vec3(),j=c.vec4(),k=c.vec3(),l=c.vec3(),m=c.vec3(),n=c.vec3(),o=c.vec3(),p=c.vec3(),q=c.vec3(),r=c.vec3(),s=c.vec3(),t=c.vec4(),u=c.vec4(),v=c.vec4(),w=c.vec4(),x=(c.vec4(),c.vec3()),y=c.vec3(),z=c.vec3(),A=c.vec3(),B=c.vec3(),C=c.vec3(),D=c.vec3(),E=c.vec3(),F=c.vec3(),G=c.vec3(),H=c.vec3(),I=c.mat4(),J=c.mat4(),K=c.mat4();return function(w){w=w||{},w.pickSurface=w.pickSurface||w.rayPick,w.canvasPos||w.origin&&w.direction||this.warn("picking without canvasPos or ray origin and direction");var I=this._renderer.pick(w);if(I){var J=this.entities[I.entity];if(I.entity=J,w.pickSurface&&void 0!==I.primIndex&&I.primIndex>-1){var K=J.geometry;if("triangles"===K.primitive){I.primitive="triangle";var L=I.primIndex,M=K.indices,N=K.positions,O=M[L],P=M[L+1],Q=M[L+2],R=3*O,S=3*P,T=3*Q;i[0]=O,i[1]=P,i[2]=Q,I.indices=i,f[0]=N[R],f[1]=N[R+1],f[2]=N[R+2],g[0]=N[S],g[1]=N[S+1],g[2]=N[S+2],h[0]=N[T],h[1]=N[T+1],h[2]=N[T+2];var U;w.canvasPos?(U=w.canvasPos,I.canvasPos=w.canvasPos,a(J,U,d,e)):w.origin&&w.direction&&b(J,w.origin,w.direction,d,e),c.normalizeVec3(e),c.rayPlaneIntersect(d,e,f,g,h,j),I.localPos=j,I.position=j,t[0]=j[0],t[1]=j[1],t[2]=j[2],t[3]=1,c.transformVec4(J.transform.leafMatrix,t,u),k[0]=u[0],k[1]=u[1],k[2]=u[2],I.worldPos=k,c.transformVec4(J.camera.view.matrix,u,v),l[0]=v[0],l[1]=v[1],l[2]=v[2],I.viewPos=l,c.cartesianToBarycentric(j,f,g,h,m),I.bary=m;var V=K.normals;if(V){n[0]=V[R],n[1]=V[R+1],n[2]=V[R+2],o[0]=V[S],o[1]=V[S+1],o[2]=V[S+2],p[0]=V[T],p[1]=V[T+1],p[2]=V[T+2];var W=c.addVec3(c.addVec3(c.mulVec3Scalar(n,m[0],x),c.mulVec3Scalar(o,m[1],y),z),c.mulVec3Scalar(p,m[2],A),B);I.normal=c.transformVec3(J.transform.leafMatrix,W,C)}var X=K.uv;X&&(q[0]=X[2*O],q[1]=X[2*O+1],r[0]=X[2*P],r[1]=X[2*P+1],s[0]=X[2*Q],s[1]=X[2*Q+1],I.uv=c.addVec3(c.addVec3(c.mulVec2Scalar(q,m[0],D),c.mulVec2Scalar(r,m[1],E),F),c.mulVec2Scalar(s,m[2],G),H))}}return I}}}(),clear:function(){for(var a in this.components)this.components.hasOwnProperty(a)&&this.components[a].destroy();this._initDefaults(),this._dirtyEntities={}},_getSharedComponent:function(a,b){var c,d;if(xeogl._isObject(a)?(c=a.type||"xeogl.Component",d=xeogl[c.substring(6)]):xeogl._isString(a)?(c=a,d=xeogl[c.substring(6)]):(d=a,c=a.prototype.type),!d)return void this.error("Component type not found: "+c);if(!xeogl._isComponentType(c,"xeogl.Component"))return void this.error("Expected a xeogl.Component type or subtype");var e,f;return void 0!==b&&(f="__shared."+c+"."+b,e=this._sharedComponents[f])?(this._sharedCounts[f]++,e):a&&a.id&&this.components[a.id]?(this.error("Component "+xeogl._inQuotes(a.id)+" already exists in Scene"),null):(e=new d(this,a),void 0!==b&&(this._sharedComponents[f]=e,this._sharedComponentIDs[e.id]=f,this._sharedCounts[f]=1,e.on("destroyed",function(){void 0!==this._sharedComponentIDs[e.id]&&this._putSharedComponent(e)},this)),e)},_putSharedComponent:function(a){var b=this._sharedComponentIDs[a.id];if(void 0!==b){if(--this._sharedCounts[b]>0)return;delete this._sharedComponents[b],delete this._sharedComponentIDs[a.id],delete this._sharedCounts[b]}a.destroy()},_compile:function(a,b,c){var d,e=0;for(var f in this._dirtyEntities)this._dirtyEntities.hasOwnProperty(f)&&(d=this._dirtyEntities[f],d._valid()&&(d._compile(),delete this._dirtyEntities[f],e++));this._renderer.render({pass:a,clear:b,force:c});var g=this.canvas;if(g.transparent||g.backgroundImage||g.backgroundColor)this._lastAmbientColor=null;else{var h=this._renderer.ambientColor;this._lastAmbientColor&&this._lastAmbientColor[0]===h[0]&&this._lastAmbientColor[1]===h[1]&&this._lastAmbientColor[2]===h[2]&&this._lastAmbientColor[3]===h[3]||(g.backgroundColor=h,this._lastAmbientColor||(this._lastAmbientColor=xeogl.math.vec4()),this._lastAmbientColor.set(h))}},_getJSON:function(){var a,b=[];for(var c in this.components)if(this.components.hasOwnProperty(c)){if(a=this.components[c],!a._getJSON)continue;b.unshift(a)}b.sort(function(a,b){return a._componentOrder-b._componentOrder});for(var d=[],e=0,f=b.length;e<f;e++)d.push(b[e].json);return{passes:this._passes,clearEachPass:this._clearEachPass,components:d}},_destroy:function(){this.clear()}})}(),function(){"use strict";xeogl.MorphTargets=xeogl.Component.extend({type:"xeogl.MorphTargets",_init:function(a){this.scene.on("webglContextRestored",function(){}),this.targets=a.targets,this.factor=a.factor},_props:{targets:{set:function(a){},get:function(){}},factor:{set:function(a){},get:function(){return 0}},_compile:function(){this._renderer.MorphTargets=this._state}},_getJSON:function(){return{targets:this.targets,factor:this.factor}}})}(),function(){"use strict";var a=xeogl.math;xeogl.CameraFlightAnimation=xeogl.Component.extend({type:"xeogl.CameraFlightAnimation",_init:function(b){this._look1=a.vec3(),this._eye1=a.vec3(),this._up1=a.vec3(),this._look2=a.vec3(),this._eye2=a.vec3(),this._up2=a.vec3(),this._flying=!1,this._flyEyeLookUp=!1,this._callback=null,this._callbackScope=null,this._onTick=null,this._time1=null,this._time2=null,this.easing=b.easing!==!1,this.duration=b.duration,this.fit=b.fit,this.fitFOV=b.fitFOV,this.trail=b.trail,this.camera=b.camera,this._aabbHelper=this.create({type:"xeogl.Entity",geometry:this.create({type:"xeogl.AABBGeometry",material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,0],lineWidth:3})}),visibility:this.create({type:"xeogl.Visibility",visible:!1}),modes:this.create({type:"xeogl.Modes",collidable:!1})}),this._obbHelper=this.create({type:"xeogl.Entity",geometry:this.create({type:"xeogl.OBBGeometry",material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,0],lineWidth:3})}),visibility:this.create({type:"xeogl.Visibility",visible:!1}),modes:this.create({type:"xeogl.Modes",collidable:!1})})},flyTo:function(){var b=a.vec3();return function(c,d,e){c=c||this.scene,this._flying&&this.stop();var f=this._attached.camera;if(!f)return void(d&&(e?d.call(e):d()));this._flying=!1,this._callback=d,this._callbackScope=e;var g=f.view;this._eye1[0]=g.eye[0],this._eye1[1]=g.eye[1],this._eye1[2]=g.eye[2],this._look1[0]=g.look[0],this._look1[1]=g.look[1],this._look1[2]=g.look[2],this._up1[0]=g.up[0],this._up1[1]=g.up[1],this._up1[2]=g.up[2];var h,i,j,k,l;if(c.worldBoundary)h=c.worldBoundary.aabb;else if(c.aabb)h=c.aabb;else if(6===c.length)h=c;else if(c.eye||c.look||c.up)i=c.eye,j=c.look,k=c.up;else{var m=c;if((xeogl._isNumeric(m)||xeogl._isString(m))&&(l=m,m=this.scene.components[l],!m))return this.error("Component not found: "+xeogl._inQuotes(l)),void(d&&(e?d.call(e):d()));var n=m.worldBoundary;if(!n)return this.error("Can't fly to component "+xeogl._inQuotes(l)+" - does not have a worldBoundary"),void(d&&(e?d.call(e):d()));h=n.aabb}var o=c.offset;if(h){if(h[3]<=h[0]||h[4]<=h[1]||h[5]<=h[2])return;this._aabbHelper.geometry.aabb=h,this._aabbHelper.visibility.visible=!0;var p=a.getAABB3Center(h);this._look2=c.look||p,o&&(this._look2[0]+=o[0],this._look2[1]+=o[1],this._look2[2]+=o[2]);var q=a.normalizeVec3(a.subVec3(this._eye1,this._look1,b)),r=(c.look,
a.getAABB3Diag(h)),s=Math.abs(r/Math.tan((c.fitFOV||this._fitFOV)*xeogl.math.DEGTORAD));this._eye2[0]=this._look2[0]+q[0]*s,this._eye2[1]=this._look2[1]+q[1]*s,this._eye2[2]=this._look2[2]+q[2]*s,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyEyeLookUp=!1}else(i||j||k)&&(j=j||this._look1,i=i||this._eye1,k=k||this._up1,this._look2[0]=j[0],this._look2[1]=j[1],this._look2[2]=j[2],this._eye2[0]=i[0],this._eye2[1]=i[1],this._eye2[2]=i[2],this._up2[0]=k[0],this._up2[1]=k[1],this._up2[2]=k[2],this._flyEyeLookUp=!0);this.fire("started",c,!0),this._time1=Date.now(),this._time2=this._time1+(c.duration?1e3*c.duration:this._duration),this._flying=!0,xeogl.scheduleTask(this._update,this)}}(),jumpTo:function(){var b=(a.vec3(),a.vec3()),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3();return function(g){this._flying&&this.stop();var h=this._attached.camera;if(h){var i,j,k,l=h.view;if(g.worldBoundary)j=g.worldBoundary.sphere;else if(g.sphere)j=g.sphere;else if(g.aabb)i=g.aabb;else if(6===g.length)i=g;else if(4===g.length)j=g;else if(g.eye||g.look||g.up)b=g.eye,c=g.look,d=g.up;else{var m=g;if((xeogl._isNumeric(m)||xeogl._isString(m))&&(k=m,m=this.scene.components[k],!m))return void this.error("Component not found: "+xeogl._inQuotes(k));var n=m.worldBoundary;if(!n)return void this.error("Can't jump to component "+xeogl._inQuotes(k)+" - does not have a worldBoundary");j=n.sphere}g.offset;if(i||j){var o;if(i){if(i[3]<=i[0]||i[4]<=i[1]||i[5]<=i[2])return;o=a.getAABB3Diag(i),a.getAABB3Center(i,c)}else{if(j[3]<=0)return;o=2*j[3],c[0]=j[0],c[1]=j[1],c[2]=j[2]}this._trail?a.subVec3(l.look,c,e):a.subVec3(l.eye,l.look,e),a.normalizeVec3(e);var p,q=void 0!==g.fit?g.fit:this._fit;p=q?Math.abs(o/Math.tan((g.fitFOV||this._fitFOV)*xeogl.math.DEGTORAD)):a.lenVec3(a.subVec3(l.eye,l.look,f)),a.mulVec3Scalar(e,p),l.eye=a.addVec3(c,e,b),l.look=c}else(b||c||d)&&(b&&(l.eye=b),c&&(l.look=c),d&&(l.up=d))}}}(),_update:function(){var b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3();return function(){if(this._flying){var g=Date.now(),h=(g-this._time1)/(this._time2-this._time1),i=h>=1;h>1&&(h=1),h=this.easing?this._ease(h,0,1,1):h;var j=this._attached.camera.view;if(this._flyEyeLookUp)j.eye=a.lerpVec3(h,0,1,this._eye1,this._eye2,c),j.look=a.lerpVec3(h,0,1,this._look1,this._look2,d),j.up=a.lerpVec3(h,0,1,this._up1,this._up2,e);else{a.lerpVec3(h,0,1,this._look1,this._look2,d);var k;this._trail?a.subVec3(d,j.look,b):a.subVec3(j.eye,j.look,b),a.normalizeVec3(b),a.lerpVec3(h,0,1,this._eye1,this._eye2,c),a.subVec3(c,d,f),k=a.lenVec3(f),a.mulVec3Scalar(b,k),j.eye=a.addVec3(d,b,c),j.look=d}return i?void this.stop():void xeogl.scheduleTask(this._update,this)}}}(),_ease:function(a,b,c,d){return a/=d,-c*a*(a-2)+b},stop:function(){if(this._flying){this._aabbHelper.visibility.visible=!1,this._flying=!1,this._time1=null,this._time2=null;var a=this._callback;a&&(this._callback=null,this._callbackScope?a.call(this._callbackScope):a()),this.fire("stopped",!0,!0)}},cancel:function(){this._flying&&(this._aabbHelper.visibility.visible=!1,this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0}),this.stop()},get:function(){return this._attached.camera}},duration:{set:function(a){a=a||.5,this._duration=1e3*a,this.stop()},get:function(){return this._duration/1e3}},fit:{set:function(a){this._fit=a!==!1,this.fire("fit",this._fit)},get:function(){return this._fit}},fitFOV:{set:function(a){a=a||45,this._fitFOV=a},get:function(){return this._fitFOV}},trail:{set:function(a){this._trail=!!a,this.fire("trail",this._trail)},get:function(){return this._trail}}},_getJSON:function(){var a={duration:this._duration,fitFOV:this._fitFOV,fit:this._fit,trail:this._trail};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.stop()}})}(),function(){"use strict";xeogl.Camera=xeogl.Component.extend({type:"xeogl.Camera",_init:function(a){this.project=a.project,this.view=a.view},_props:{project:{set:function(a){this._attach({name:"project",type:"xeogl.Transform",component:a,sceneDefault:!0,on:{matrix:{callback:function(){this.fire("projectMatrix")},scope:this}}})},get:function(){return this._attached.project}},view:{set:function(a){this._attach({name:"view",type:"xeogl.Transform",component:a,sceneDefault:!0,on:{matrix:{callback:function(){this.fire("viewMatrix")},scope:this}}})},get:function(){return this._attached.view}}},_compile:function(){this._renderer.projTransform=this._attached.project._state,this._renderer.viewTransform=this._attached.view._state},_getJSON:function(){return{project:this._attached.project.id,view:this._attached.view.id}}})}(),function(){"use strict";xeogl.Canvas=xeogl.Component.extend({type:"xeogl.Canvas",serializable:!1,_WEBGL_CONTEXT_NAMES:["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],_init:function(a){if(this.canvas=null,this.overlay=null,this.gl=null,this.webgl2=!1,this.transparent=!!a.transparent,this.contextAttr=a.contextAttr||{},this.contextAttr.alpha=this.transparent,this.contextAttr.preserveDrawingBuffer=!1,a.canvas?xeogl._isString(a.canvas)?(this.canvas=document.getElementById(a.canvas),this.canvas||(this.error("Canvas element not found: "+xeogl._inQuotes(a.canvas)+" - creating default canvas instead."),this._createCanvas())):this.canvas=a.canvas:this._createCanvas(),!this.canvas)return void this.error("Faied to create canvas");this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._createBackground(),this._createOverlay(),this._resizeBackground(),this._resizeOverlay(),this._initWebGL(a);var b=this;this.canvas.addEventListener("webglcontextlost",function(){b.fire("webglContextLost")},!1),this.canvas.addEventListener("webglcontextrestored",function(){b._initWebGL(),b.gl&&b.fire("webglContextRestored",b.gl)},!1);var c=null,d=null,e=null,f=null;this._tick=this.scene.on("tick",function(){var a=b.canvas,g=window.innerWidth!==c||window.innerHeight!==d,h=a.clientWidth!==e||a.clientHeight!==f;if((g||h)&&(b._spinner._adjustPosition(),b._resizeBackground(),b._resizeOverlay(),h)){var i,j=a.clientWidth,k=a.clientHeight,l=0;for(var m in xeogl.scenes)xeogl.scenes.hasOwnProperty(m)&&(i=xeogl.scenes[m],l+=i.canvas.canvas.clientWidth*i.canvas.canvas.clientHeight);xeogl.stats.memory.pixels=l,a.width=a.clientWidth,a.height=a.clientHeight;var n=b.boundary;n[0]=a.offsetLeft,n[1]=a.offsetTop,n[2]=j,n[3]=k,b.fire("boundary",n),e=j,f=k,c=window.innerWidth,d=window.innerHeight}}),this.canvas.oncontextmenu=function(a){a.preventDefault()},this._spinner=new xeogl.Spinner(this.scene,{canvas:this.canvas}),this.backgroundColor=a.backgroundColor,this.backgroundImage=a.backgroundImage},_createCanvas:function(){var a="xeogl-canvas-"+xeogl.math.createUUID(),b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d.height="100%",d.width="100%",d.padding="0",d.margin="0",d.background="rgba(0,0,0,0);",d.float="left",d.left="0",d.top="0",d.position="absolute",d.opacity="1.0",d["z-index"]="-10000",c.innerHTML+='<canvas id="'+a+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',b.appendChild(c),this.canvas=document.getElementById(a)},_createBackground:function(){var a=document.getElementsByTagName("body")[0],b=document.createElement("div"),c=b.style;c.padding="0",c.margin="0",c.background=null,c.backgroundImage=null,c.float="left",c.left="0",c.top="0",c.width="0px",c.height="0px",c.position="absolute",c.opacity=1,c["z-index"]="-20000",a.appendChild(b),this._backgroundElement=b},_createOverlay:function(){var a=document.getElementsByTagName("body")[0],b=document.createElement("div"),c=b.style;c.padding="0",c.margin="0",c.background="black",c.float="left",c.left="0",c.top="0",c.width="0px",c.height="0px",c.position="absolute",c.opacity=0,c["z-index"]="100000",a.appendChild(b),this.overlay=b},_resizeOverlay:function(){if(this.canvas&&this.overlay){var a=this.canvas,b=this.overlay,c=b.style,d=this._getElementXY(a);c.left=d.x+"px",c.top=d.y+"px",c.width=a.clientWidth+"px",c.height=a.clientHeight+"px"}},_resizeBackground:function(){if(this.canvas&&this._backgroundElement){var a=this.canvas,b=this._backgroundElement,c=b.style,d=this._getElementXY(a);c.left=d.x+"px",c.top=d.y+"px",c.width=a.clientWidth+"px",c.height=a.clientHeight+"px"}},_getElementXY:function(a){for(var b=0,c=0;a;)b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent;return{x:b,y:c}},_initWebGL:function(a){if(a.webgl2){try{this.gl=this.canvas.getContext("webgl2",this.contextAttr)}catch(b){}this.gl?this.webgl2=!0:this.warn("Failed to get a WebGL 2 context - defaulting to WebGL 1.")}if(!this.gl)for(var c=0;!this.gl&&c<this._WEBGL_CONTEXT_NAMES.length;c++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[c],this.contextAttr)}catch(b){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0))},getSnapshot:function(a){if(!this.canvas)return void this.error("Can't get snapshot - no canvas.");this.scene.render(),a=a||{};var b,c=a.width||this.canvas.width,d=a.height||this.canvas.height,e=a.format||"jpeg";switch(e){case"jpeg":b=Canvas2Image.saveAsJPEG(this.canvas,!0,c,d);break;case"png":b=Canvas2Image.saveAsPNG(this.canvas,!0,c,d);break;case"bmp":b=Canvas2Image.saveAsBMP(this.canvas,!0,c,d);break;default:this.error("Unsupported snapshot format: '"+e+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),b=Canvas2Image.saveAsJPEG(this.canvas,!0,c,d)}return b.src},readPixels:function(a,b,c,d){return this.scene._renderer.readPixels(a,b,c,d)},_props:{backgroundColor:{set:function(a){if(a){if((this._backgroundColor=this._backgroundColor||new xeogl.math.vec4).set(a||[0,0,0,1]),!this._backgroundImageSrc){var b="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=b}}else this._backgroundColor=null;this.fire("backgroundColor",this._backgroundColor)},get:function(){return this._backgroundColor}},backgroundImage:{set:function(a){if(a){if(!xeogl._isString(a))return void this.error("Value for 'backgroundImage' should be a string");if(a!==this._backgroundImageSrc){if(this._backgroundElement.style.backgroundImage="url('"+a+"')",this._backgroundImageSrc=a,!this._backgroundImageSrc){var b="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=b}this.fire("backgroundImage",this._backgroundImageSrc)}}},get:function(){return this._backgroundImageSrc}},spinner:{get:function(){return this._spinner}}},_destroy:function(){this.scene.off(this._tick)}})}(),function(){"use strict";var a=!1;xeogl.Spinner=xeogl.Component.extend({type:"xeogl.Spinner",serializable:!1,_init:function(a){this._canvas=a.canvas,this._injectSpinnerCSS();var b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d["z-index"]="9000",d.position="absolute",c.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',b.appendChild(c),this._element=c,this._adjustPosition(),this.processes=0,this.textures=a.textures},_props:{textures:{set:function(a){a=a!==!1,this._textures=a,this.fire("textures",this._textures)},get:function(){return this._textures}},processes:{set:function(a){a=a||0,this._processes!==a&&(a<0||(this._processes=a,this._element.style.visibility=this._processes>0?"visible":"hidden",this.fire("processes",this._processes)))},get:function(){return this._processes}}},_adjustPosition:function(){if(this._canvas&&this._element){var a=this._canvas,b=this._element,c=b.style;c.left=a.offsetLeft+.5*a.clientWidth-.5*b.clientWidth+"px",c.top=a.offsetTop+.5*a.clientHeight-.5*b.clientHeight+"px"}},_injectSpinnerCSS:function(){if(!a){var b=document.createElement("style");b.innerHTML=this._spinnerCSS,document.body.appendChild(b),a=!0}},_spinnerCSS:".sk-fading-circle {        margin: 100px auto;        width: 100px;        height:100px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }"})}(),function(){"use strict";xeogl.Clip=xeogl.Component.extend({type:"xeogl.Clip",_init:function(a){this._state={mode:"disabled",dir:[1,0,0],dist:1},this.mode=a.mode,this.dir=a.dir,this.dist=a.dist},_props:{mode:{set:function(a){this._state.mode=a||"disabled",this._renderer.imageDirty=!0,this.fire("mode",this._state.mode)},get:function(){return this._state.mode}},dir:{set:function(a){this._state.dir=a||xeogl.math.vec3([1,0,0]),this._renderer.imageDirty=!0,this.fire("dir",this._state.dir)},get:function(){return this._state.dir}},dist:{set:function(a){this._state.dist=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("dist",this._state.dist)},get:function(){return this._state.dist}}},_getJSON:function(){return{mode:this._state.mode,dir:this._state.dir,dist:this._state.dist}}})}(),function(){"use strict";xeogl.Clips=xeogl.Component.extend({type:"xeogl.Clips",_init:function(a){this._state=new xeogl.renderer.Clips({clips:[],hash:""}),this._dirty=!0,this._clips=[],this._dirtySubs=[],this._destroyedSubs=[],this.clips=a.clips},_props:{clips:{set:function(a){function b(){h.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=h._clips.length;b<c;b++)if(h._clips[b].id===a)return h._clips=h._clips.slice(b,b+1),h._dirtySubs=h._dirtySubs.slice(b,b+1),h._destroyedSubs=h._destroyedSubs.slice(b,b+1),h._dirty=!0,h.fire("dirty",!0),void h.fire("clips",h._clips)}a=a||[];var d,e,f,g;for(e=0,f=this._clips.length;e<f;e++)d=this._clips[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._clips=[],this._dirtySubs=[],this._destroyedSubs=[];var h=this;for(e=0,f=a.length;e<f;e++)d=a[e],!xeogl._isString(d)||(g=d,d=this.components[g])?"xeogl.Clip"===d.type?(this._clips.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c))):this.error("Component "+xeogl._inQuotes(g)+" is not a xeogl.Clip"):this.error("Component not found: "+xeogl._inQuotes(g));this._dirty=!0,this.fire("dirty",!0),this.fire("clips",this._clips)},get:function(){return this._clips.slice(0,this._clips.length)}}},_compile:function(){var a=this._state;if(this._dirty){a.clips=[];for(var b=0,c=this._clips.length;b<c;b++)a.clips.push(this._clips[b]._state);this._makeHash(),this._dirty=!1}this._renderer.clips=a},_makeHash:function(){var a=this._state.clips;if(0===a.length)return";";for(var b,c=[],d=0,e=a.length;d<e;d++)b=a[d],c.push(b._state.mode);c.push(";"),this._state.hash=c.join("")},_getJSON:function(){for(var a=[],b=0,c=this._clips.length;b<c;b++)a.push(this._clips[b].id);return{clips:a}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Configs=xeogl.Component.extend({type:"xeogl.Configs",_init:function(a){this.props={};for(var b in a)a.hasOwnProperty(b)&&this.set(b,a[b])},set:function(a,b){this.props[a]=b,this.fire(a,b)},_toJSON:function(){return xeogl._copy(this.props)}})}(),function(){"use strict";xeogl.CameraControl=xeogl.Component.extend({type:"xeogl.CameraControl",exclusive:!0,_init:function(a){this.scene;this._boundaryHelper=this.create({type:"xeogl.Entity",geometry:this.create({type:"xeogl.AABBGeometry"}),material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,.6],lineWidth:4}),visibility:this.create({type:"xeogl.Visibility",visible:!1}),modes:this.create({type:"xeogl.Modes",collidable:!1})}),this.keyboardAxis=this.create(xeogl.KeyboardAxisCamera,{camera:a.camera}),this.keyboardRotate=this.create(xeogl.KeyboardRotateCamera,{camera:a.camera}),this.mouseRotate=this.create(xeogl.MouseRotateCamera,{camera:a.camera}),this.keyboardPan=this.create(xeogl.KeyboardPanCamera,{camera:a.camera}),this.mousePan=this.create(xeogl.MousePanCamera,{camera:a.camera}),this.keyboardZoom=this.create(xeogl.KeyboardZoomCamera,{camera:a.camera}),this.mouseZoom=this.create(xeogl.MouseZoomCamera,{camera:a.camera}),this.mousePickEntity=this.create(xeogl.MousePickEntity,{pickSurface:!0}),this.mousePickEntity.on("pick",this._entityPicked,this),this.mousePickEntity.on("nopick",function(){}),this.cameraFlight=this.create(xeogl.CameraFlightAnimation,{camera:a.camera,duration:.5}),this.firstPerson=a.firstPerson,this.camera=a.camera,this.active=a.active!==!1},_entityPicked:function(a){var b;a.worldPos&&(b=a.worldPos);var c=a.entity.worldBoundary,d=c.aabb;c.sphere;if(this._boundaryHelper.geometry.aabb=d,b){var e=this.camera.view;xeogl.math.subVec3(e.eye,e.look,[]);this.cameraFlight.flyTo({look:b,aabb:d},this._hideEntityBoundary,this)}else this.cameraFlight.flyTo({aabb:d},this._hideEntityBoundary,this)},_hideEntityBoundary:function(){this._boundaryHelper.visibility.visible=!1},_props:{firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.keyboardRotate.firstPerson=a,this.mouseRotate.firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0,onAdded:this._transformUpdated,onAddedScope:this});var b=this._attached.camera;this.keyboardAxis.camera=b,this.keyboardRotate.camera=b,this.mouseRotate.camera=b,this.keyboardPan.camera=b,this.mousePan.camera=b,this.keyboardZoom.camera=b,this.mouseZoom.camera=b,this.cameraFlight.camera=b},get:function(){return this._attached.camera}},active:{set:function(a){a=!!a,this._active!==a&&(this.keyboardAxis.active=a,this.keyboardRotate.active=a,this.mouseRotate.active=a,this.keyboardPan.active=a,this.mousePan.active=a,this.keyboardZoom.active=a,this.mouseZoom.active=a,this.mousePickEntity.active=a,this.cameraFlight.active=a,this.fire("active",this._active=a))},get:function(){return this._active}}},_getJSON:function(){var a={firstPerson:this._firstPerson,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.CameraController=xeogl.Component.extend({type:"xeogl.CameraController",_init:function(a){this.camera=a.camera,this.active=a.active!==!1},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0,onAddedScope:this})},get:function(){return this._attached.camera}},active:{set:function(a){a=!!a,this._active!==a&&(this._active=a,this.fire("active",this._active))},get:function(){return this._active}}},_getJSON:function(){var a={active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.KeyboardAxisCamera=xeogl.Component.extend({type:"xeogl.KeyboardAxisCamera",_init:function(a){this._onKeyDown=null,this._cameraFly=new xeogl.CameraFlightAnimation(this.scene,{duration:1}),this.camera=a.camera,this.active=a.active!==!1},_props:{camera:{set:function(a){var b=this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0});this._cameraFly.camera=b},get:function(){return this._attached.camera}},active:{set:function(a){if(a=!!a,this._active!==a){this._cameraFly.active=a;var b=this,c=this.scene.input;a?this._onKeyDown=c.on("keydown",function(a){b._attached.camera&&c.mouseover&&(a!==c.KEY_NUM_1&&a!==c.KEY_NUM_2&&a!==c.KEY_NUM_3&&a!==c.KEY_NUM_4&&a!==c.KEY_NUM_5&&a!==c.KEY_NUM_6||xeogl.scheduleTask(function(){b._fly(a)}))}):this.scene.off(this._onKeyDown),this.fire("active",this._active=a)}},get:function(){return this._active}}},_fly:function(a){var b=this.scene.input,c=this.scene.worldBoundary,d=c.aabb,e=c.center,f=xeogl.math.getAABB3Diag(d);this._fitFOV=55;var g=Math.abs(f/Math.tan(this._fitFOV/2));switch(a){case b.KEY_NUM_1:this._cameraFly.flyTo({look:e,eye:[e[0]-g,e[1],e[2]],up:[0,1,0]});break;case b.KEY_NUM_2:this._cameraFly.flyTo({look:e,eye:[e[0],e[1],e[2]+g],up:[0,1,0]});break;case b.KEY_NUM_3:this._cameraFly.flyTo({look:e,eye:[e[0]+g,e[1],e[2]],up:[0,1,0]});break;case b.KEY_NUM_4:this._cameraFly.flyTo({look:e,eye:[e[0],e[1],e[2]-g],up:[0,1,0]});break;case b.KEY_NUM_5:this._cameraFly.flyTo({look:e,eye:[e[0],e[1]-g,e[2]],up:[0,0,-1]});break;case b.KEY_NUM_6:this._cameraFly.flyTo({look:e,eye:[e[0],e[1]+g,e[2]],up:[0,0,1]})}},_getJSON:function(){var a={active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1,this._cameraFly.destroy()}})}(),function(){"use strict";xeogl.KeyboardRotateCamera=xeogl.Component.extend({type:"xeogl.KeyboardRotateCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.active=a.active!==!1,this.sensitivity=a.sensitivity},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||1,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._attached.camera;if(d&&b.mouseover){var e=a.deltaTime,f=.3*c._sensitivity,g=.3*c._sensitivity;if(!b.ctrlDown&&!b.altDown){var h=b.keyDown[b.KEY_LEFT_ARROW],i=b.keyDown[b.KEY_RIGHT_ARROW],j=b.keyDown[b.KEY_UP_ARROW],k=b.keyDown[b.KEY_DOWN_ARROW];if(h||i||j||k){var l=0,m=0;i?l=-e*f:h&&(l=e*f),k?m=e*g:j&&(m=-e*g),Math.abs(l)>Math.abs(m)?m=0:l=0,0!==l&&d.view.rotateEyeY(l),0!==m&&d.view.rotateEyeX(m)}}}})}else this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.KeyboardPanCamera=xeogl.Component.extend({type:"xeogl.KeyboardPanCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._attached.camera;if(d&&b.mouseover){var e=a.deltaTime;if(!b.ctrlDown&&!b.altDown){var f=b.keyDown[b.KEY_W],g=b.keyDown[b.KEY_S],h=b.keyDown[b.KEY_A],i=b.keyDown[b.KEY_D],j=b.keyDown[b.KEY_Z],k=b.keyDown[b.KEY_X];if(f||g||h||i||k||j){var l=0,m=0,n=0,o=.01*c._sensitivity;g?m=e*o:f&&(m=-e*o),i?l=e*o:h&&(l=-e*o),k?n=e*o:j&&(n=-e*o),d.view.pan([l,m,n])}}}})}else this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.KeyboardZoomCamera=xeogl.Component.extend({type:"xeogl.KeyboardZoomCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._attached.camera;if(d&&b.mouseover){var e=a.deltaTime;if(!b.ctrlDown&&!b.altDown){var f=b.keyDown[b.KEY_ADD],g=b.keyDown[b.KEY_SUBTRACT];if(f||g){var h=0,i=.01*c.sensitivity;g?h=e*i:f&&(h=-e*i),d.view.zoom(h)}}}})}else null!==this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MouseRotateCamera=xeogl.Component.extend({type:"xeogl.MouseRotateCamera",_init:function(a){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e,f=0,g=0,h=!1,i=!1;this._onMouseDown=b.on("mousedown",function(a){b.mouseover&&(f=0,g=0,i&&(!b.mouseDownLeft||b.mouseDownRight||b.keyDown[b.KEY_SHIFT]||b.mouseDownMiddle?h=!1:(h=!0,c=a[0],d=a[1])))},this),this._onMouseUp=b.on("mouseup",function(){h=!1,f=0,g=0}),this._onMouseEnter=b.on("mouseenter",function(){i=!0,f=0,g=0}),this._onMouseLeave=b.on("mouseleave",function(){i=!1,f=0,g=0}),this._onMouseMove=b.on("mousemove",function(a){if(i&&h){var b=(a[0]-c)*this._sensitivity,f=(a[1]-d)*this._sensitivity;c=a[0],d=a[1];var g=this._attached.camera;g&&i&&h&&(0!==b&&(e=-b*this._sensitivity,this._firstPerson?g.view.rotateLookY(e):g.view.rotateEyeY(e)),0!==f&&(e=f*this._sensitivity,this._firstPerson?g.view.rotateLookX(-e):g.view.rotateEyeX(e)))}},this)}else b.off(this._onTick),b.off(this._onMouseDown),b.off(this._onMouseUp),b.off(this._onMouseMove),b.off(this._onMouseEnter),b.off(this._onMouseLeave);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MousePanCamera=xeogl.Component.extend({type:"xeogl.MousePanCamera",_init:function(a){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a?.03*a:.03,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e=0,f=0,g=!1,h=this;this._onTick=this.scene.on("tick",function(){var a=h._attached.camera;a&&(0===e&&0===f||(a.view.pan([e,f,0]),e=0,f=0))}),this._onMouseDown=b.on("mousedown",function(a){b.mouseDownLeft&&b.mouseDownRight||b.mouseDownLeft&&b.keyDown[b.KEY_SHIFT]||b.mouseDownMiddle?(c=a[0],d=a[1],g=!0):g=!1}),this._onMouseUp=b.on("mouseup",function(){g=!1}),this._onMouseUp=b.on("mouseout",function(){g=!1}),this._onMouseMove=b.on("mousemove",function(a){
g&&(e+=(a[0]-c)*h._sensitivity,f+=(a[1]-d)*h._sensitivity,c=a[0],d=a[1])})}else b.off(this._onTick),b.off(this._onMouseDown),b.off(this._onMouseUp),b.off(this._onMouseMove);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MousePickEntity=xeogl.Component.extend({type:"xeogl.MousePickEntity",_init:function(a){this.pickSurface=a.pickSurface,this.active=a.active!==!1},_props:{active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e=this,f=2,g=!1,h=!1;this._onMouseEnter=b.on("mouseenter",function(){g=!0}),this._onMouseLeave=b.on("mouseleave",function(){g=!1}),this._onMouseDown=b.on("mousedown",function(a){g&&(h=!0,c=a[0],d=a[1])}),this._onMouseUp=b.on("mouseup",function(a){if(h&&g){if(c>=a[0]-f&&c<=a[0]+f&&d>=a[1]-f&&d<=a[1]+f){var b=e.scene.pick({canvasPos:a,pickSurface:e._pickSurface});b?e.fire("pick",b):e.fire("nopick",{canvasPos:a})}h=!1}})}else b.off(this._onMouseDown),b.off(this._onMouseUp);this.fire("active",this._active=a)}},get:function(){return this._active}},pickSurface:{set:function(a){a=!!a,this._pickSurface!==a&&(this._dirty=!1,this.fire("pickSurface",this._pickSurface=a))},get:function(){return this._pickSurface}}},_getJSON:function(){var a={pickSurface:this._pickSurface,active:this._active};return a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MouseZoomCamera=xeogl.Component.extend({type:"xeogl.MouseZoomCamera",_init:function(a){this._onTick=null,this._onMouseWheel=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){if(a){var b=0,c=0,d=!1,e=!1,f=0,g=xeogl.math.vec3(),h=xeogl.math.vec3(),i=xeogl.math.vec3(),j=this;this._onMouseWheel=this.scene.input.on("mousewheel",function(a){b=a,0===b?(e=!1,d=!1):d=!0}),this._onTick=this.scene.on("tick",function(){var a=j._attached.camera;if(a){var k=a.view.eye,l=a.view.look;g[0]=k[0],g[1]=k[1],g[2]=k[2],h[0]=l[0],h[1]=l[1],h[2]=l[2],xeogl.math.subVec3(g,h,i);var m=Math.abs(xeogl.math.lenVec3(i)),n=1e3,o=j._sensitivity*(2+m/n);d&&(c=b*o,f=0,d=!1,e=!0),e&&(b>0?(f+=.2*o,f>c&&(e=!1)):b<0&&(f-=.2*o,f<c&&(e=!1)),e&&(a.view.zoom(f),a.project.isType("xeogl.Ortho")))}})}else null!==this._onTick&&(this.scene.off(this._onTick),this.scene.input.off(this._onMouseWheel));this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.Cull=xeogl.Component.extend({type:"xeogl.Cull",_init:function(a){this._state=new xeogl.renderer.Cull({culled:!0}),this.culled=a.culled},_props:{culled:{set:function(a){a=!!a,a!==this._state.culled&&(this._state.culled=a,this._renderer.imageDirty=!0,this.fire("culled",this._state.culled))},get:function(){return this._state.culled}}},_compile:function(){this._renderer.cull=this._state},_getJSON:function(){return{culled:this.culled}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Visibility=xeogl.Component.extend({type:"xeogl.Visibility",_init:function(a){this._state=new xeogl.renderer.Visibility({visible:!0}),this.visible=a.visible},_props:{visible:{set:function(a){this._state.visible=a!==!1,this._renderer.imageDirty=!0,this.fire("visible",this._state.visible)},get:function(){return this._state.visible}}},_compile:function(){this._renderer.visibility=this._state},_getJSON:function(){return{visible:this.visible}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Geometry=xeogl.Component.extend({type:"xeogl.Geometry",_init:function(a){var b=this;this._state=new xeogl.renderer.Geometry({primitive:null,primitiveName:null,positions:null,colors:null,normals:null,uv:null,tangents:null,indices:null,hash:"",getTangents:function(){return b._tangentsDirty&&b._buildTangents(),b._tangents},getPickPositions:function(){return b._pickVBOsDirty&&b._buildPickVBOs(),b._pickPositions},getPickColors:function(){return b._pickVBOsDirty&&b._buildPickVBOs(),b._pickColors}}),this._positionsData=null,this._colorsData=null,this._normalsData=null,this._uvData=null,this._tangentsData=null,this._indicesData=null,this._tangents=null,this._pickPositions=null,this._pickColors=null,this._updateScheduled=!1,this._geometryUpdateScheduled=!1,this._hashDirty=!0,this._positionsDirty=!0,this._colorsDirty=!0,this._normalsDirty=!0,this._uvDirty=!0,this._tangentsDirty=!0,this._indicesDirty=!0,this._pickVBOsDirty=!0,this._localBoundary=null,this._boundaryDirty=!0;var c=!(a.positions||a.normals||a.uv||a.indices);if(c)this.primitive=a.primitive;else{var d=(!a.primitive||"line-strip"===a.primitive)&&a.positions&&!a.indices;if(d){for(var e=[],f=0,g=a.positions.length/3;f<g;f++)e.push(f);this.primitive="line-strip",this.positions=a.positions,this.indices=e}else this.primitive=a.primitive,this.positions=a.positions,this.colors=a.colors,this.normals=a.normals,this.uv=a.uv,this.tangents=a.tangents,this.indices=a.indices}this.autoNormals=a.autoNormals,this.usage=a.usage,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._scheduleGeometryUpdate,this),xeogl.stats.memory.meshes++},_scheduleUpdate:function(){this._updateScheduled||(this._updateScheduled=!0,xeogl.scheduleTask(this._doUpdate,this))},_doUpdate:function(){this._updateScheduled&&(this._geometryUpdateScheduled=!0,this._update&&this._update(),this._updateScheduled=!1),this._geometryUpdateScheduled&&this._updateGeometry()},_scheduleGeometryUpdate:function(){this._geometryUpdateScheduled||(this._geometryUpdateScheduled=!0,xeogl.scheduleTask(this._updateGeometry,this))},_updateGeometry:function(){if(this._updateScheduled)this._update&&(this._geometryUpdateScheduled=!0,this._update()),this._updateScheduled=!1,this._geometryUpdateScheduled=!0;else if(!this._geometryUpdateScheduled)return;var a=this.scene.canvas.gl;switch(this._state.primitiveName){case"points":this._state.primitive=a.POINTS;break;case"lines":this._state.primitive=a.LINES;break;case"line-loop":this._state.primitive=a.LINE_LOOP;break;case"line-strip":this._state.primitive=a.LINE_STRIP;break;case"triangles":this._state.primitive=a.TRIANGLES;break;case"triangle-strip":this._state.primitive=a.TRIANGLE_STRIP;break;case"triangle-fan":this._state.primitive=a.TRIANGLE_FAN;break;default:this._state.primitive=a.TRIANGLES}var b=a.STATIC_DRAW,c=xeogl.stats.memory;this._positionsDirty&&(this._state.positions&&(c.positions-=this._state.positions.numItems,this._state.positions.destroy()),this._state.positions=this._positionsData?new xeogl.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,this._positionsData,this._positionsData.length,3,b):null,this._state.positions&&(c.positions+=this._state.positions.numItems),this._positionsDirty=!1,this._pickVBOsDirty=!0),this._colorsDirty&&(this._state.colors&&(c.colors-=this._state.colors.numItems,this._state.colors.destroy()),this._state.colors=this._colorsData?new xeogl.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,this._colorsData,this._colorsData.length,4,b):null,this._state.colors&&(c.colors+=this._state.colors.numItems),this._colorsDirty=!1),this._normalsDirty&&(this._state.normals&&(c.normals-=this._state.normals.numItems,this._state.normals.destroy()),this._autoNormals&&this._positionsData&&this._indicesData&&(this._normalsData=xeogl.math.buildNormals(this._positionsData,this._indicesData)),this._state.normals=this._normalsData?new xeogl.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,this._normalsData,this._normalsData.length,3,b):null,this._state.normals&&(c.normals+=this._state.normals.numItems),this._normalsDirty=!1,this._tangentsDirty=!0),this._uvDirty&&(this._state.uv&&(c.uvs-=this._state.uv.numItems,this._state.uv.destroy()),this._state.uv=this._uvData?new xeogl.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,this._uvData,this._uvData.length,2,b):null,this._state.uv&&(c.uvs+=this._state.uv.numItems),this._uvDirty=!1,this._tangentsDirty=!0),this._indicesDirty&&(this._state.indices&&(c.indices-=this._state.indices.numItems,this._state.indices.destroy()),this._state.indices=this._indicesData?new xeogl.renderer.webgl.ArrayBuffer(a,a.ELEMENT_ARRAY_BUFFER,this._indicesData,this._indicesData.length,1,b):null,this._state.indices&&(c.indices+=this._state.indices.numItems),this._indicesDirty=!1,this._pickVBOsDirty=!0),this._geometryUpdateScheduled=!1,this._setBoundaryDirty()},_buildTangents:function(){if(this._tangentsDirty){(this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate();var a=xeogl.stats.memory;if(this._tangents&&(a.tangents-=this._tangents.numItems,this._tangents.destroy()),!this._positionsData||!this._indicesData||!this._uvData)return null;this._tangentsData=xeogl.math.buildTangents(this._positionsData,this._indicesData,this._uvData);var b=this.scene.canvas.gl,c=b.STATIC_DRAW;this._tangents=this._tangentsData?new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._tangentsData,this._tangentsData.length,3,c):null,this._tangents&&(a.tangents+=this._tangents.numItems),this._tangentsDirty=!1}},_buildPickVBOs:function(){if(this._pickVBOsDirty){if((this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate(),this._destroyPickVBOs(),this._positionsData&&this._indicesData){var a=this.scene.canvas.gl,b=a.STATIC_DRAW,c=xeogl.math.buildPickTriangles(this._positionsData,this._indicesData),d=c.positions,e=c.colors;this._pickPositions=new xeogl.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,d,d.length,3,b),this._pickColors=new xeogl.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,e,e.length,4,b);var f=xeogl.stats.memory;f.positions+=this._pickPositions.numItems,f.colors+=this._pickColors.numItems}this._pickVBOsDirty=!1}},_destroyPickVBOs:function(){var a=xeogl.stats.memory;this._pickPositions&&(this._pickPositions.destroy(),a.positions-=this._pickPositions.numItems,this._pickPositions=null),this._pickColors&&(this._pickColors.destroy(),a.colors-=this._pickColors.numItems,this._pickColors=null),this._pickVBOsDirty=!0},_props:{usage:{set:function(a){a=a||"static","static"!==a&&"dynamic"!==a&&"stream"!==a&&(this.error("Unsupported value for 'usage': '"+a+"' - supported values are 'static', 'dynamic' and 'stream'."),a="static"),this._state.usageName=a,this._scheduleGeometryUpdate(),this.fire("dirty",!0),this.fire("usage",this._state.usageName)},get:function(){return this._state.usageName}},primitive:{set:function(a){a=a||"triangles","points"!==a&&"lines"!==a&&"line-loop"!==a&&"line-strip"!==a&&"triangles"!==a&&"triangle-strip"!==a&&"triangle-fan"!==a&&(this.error("Unsupported value for 'primitive': '"+a+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),a="triangles"),this._state.primitiveName!==a&&(this._state.primitiveName=a,this._scheduleGeometryUpdate(),this._hashDirty=!0,this.fire("dirty",!0),this.fire("primitive",this._state.primitiveName))},get:function(){return this._state.primitiveName}},positions:{set:function(a){var b=!this._positionsData!=!a;a&&a.constructor!=Float32Array&&(a=new Float32Array(a)),this._positionsData=a,this._positionsDirty=!0,this._scheduleGeometryUpdate(),b&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("positions",this._positionsData),this.fire("localBoundary",!0),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._positionsData}},normals:{set:function(a){var b=!this._normalsData!=!a;a&&a.constructor!=Float32Array&&(a=new Float32Array(a)),this._normalsData=a,this._normalsDirty=!0,this._scheduleGeometryUpdate(),b&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire(" normals",this._normalsData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._normalsData}},uv:{set:function(a){var b=!this._uvData!=!a;a&&a.constructor!=Float32Array&&(a=new Float32Array(a)),this._uvData=a,this._uvDirty=!0,this._scheduleGeometryUpdate(),b&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("uv",this._uvData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._uvData}},colors:{set:function(a){var b=!this._colorsData!=!a;a&&a.constructor!=Float32Array&&(a=new Float32Array(a)),this._colorsData=a,this._colorsDirty=!0,this._scheduleGeometryUpdate(),b&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("colors",this._colorsData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._colorsData}},indices:{set:function(a){var b=!this._indicesData&&!a;if(a){var c=xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint;if(!c&&a.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");var d=c?Uint32Array:Uint16Array;a.constructor!=Uint16Array&&a.constructor!=Uint32Array&&(a=new d(a))}this._indicesData=a,this._indicesDirty=!0,this._scheduleGeometryUpdate(),b&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("indices",this._indicesData),this._renderer.imageDirty=!0},get:function(){return this._updateScheduled&&this._doUpdate(),this._indicesData}},localBoundary:{get:function(){if(!this._localBoundary){var a=this;this._localBoundary=new xeogl.Boundary3D(this.scene,{getDirty:function(){return!!a._boundaryDirty&&(a._boundaryDirty=!1,!0)},getPositions:function(){return(a._updateScheduled||a._geometryUpdateScheduled)&&a._doUpdate(),a._positionsData}}),this._localBoundary.on("destroyed",function(){a._localBoundary=null})}return this._localBoundary}},autoNormals:{set:function(a){a=!!a,this._autoNormals!==a&&(this._autoNormals=a,this._normalsDirty=!0,this._scheduleGeometryUpdate(),this.fire("autoNormals",this._autoNormals))},get:function(){return this._autoNormals}}},_setBoundaryDirty:function(){this._boundaryDirty||(this._boundaryDirty=!0,this._localBoundary&&this._localBoundary.fire("updated",!0))},_compile:function(){(this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate(),this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._renderer.geometry=this._state},_makeHash:function(){var a=this._state,b=["/g"];b.push("/"+a.primitive+";"),a.positions&&b.push("0"),a.colors&&b.push("1"),a.normals&&b.push("2"),a.uv&&b.push("3"),b.push(";"),a.hash=b.join("")},_getJSON:function(){return(this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate(),{primitive:this._state.primitiveName,positions:this._positionsData,normals:this._normalsData,uv:this._uvData,colors:this._colorsData,indices:this._indicesData}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.positions&&this._state.positions.destroy(),this._state.colors&&this._state.colors.destroy(),this._state.normals&&this._state.normals.destroy(),this._state.uv&&this._state.uv.destroy(),this._state.indices&&this._state.indices.destroy(),this._tangentsData&&this._tangentsData.destroy(),this._pickPositions&&this._pickPositions.destroy(),this._pickColors&&this._pickColors.destroy(),this._localBoundary&&this._localBoundary.destroy(),this._state.destroy(),xeogl.stats.memory.meshes--}})}(),function(){"use strict";xeogl.BoxGeometry=xeogl.Geometry.extend({type:"xeogl.BoxGeometry",_init:function(a){this._super(a),this.center=a.center,this.xSize=a.xSize,this.ySize=a.ySize,this.zSize=a.zSize},_update:function(){var a=-this._xSize+this._center[0],b=-this._ySize+this._center[1],c=-this._zSize+this._center[2],d=this._xSize+this._center[0],e=this._ySize+this._center[1],f=this._zSize+this._center[2];this.positions=[d,e,f,a,e,f,a,b,f,d,b,f,d,e,f,d,b,f,d,b,c,d,e,c,d,e,f,d,e,c,a,e,c,a,e,f,a,e,f,a,e,c,a,b,c,a,b,f,a,b,c,d,b,c,d,b,f,a,b,f,d,b,c,a,b,c,a,e,c,d,e,c],this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],this.uv=[1,1,0,1,0,0,1,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1],this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],this.tangents=null},_props:{center:{set:function(a){(this._center=this._center||new xeogl.math.vec3).set(a||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},xSize:{set:function(a){a=a||1,this._xSize!==a&&(a<0&&(this.warn("negative xSize not allowed - will invert"),a*=-1),this._xSize=a,this._scheduleUpdate(),this.fire("xSize",this._xSize))},get:function(){return this._xSize}},ySize:{set:function(a){a=a||1,this._ySize!==a&&(a<0&&(this.warn("negative ySize not allowed - will invert"),a*=-1),this._ySize=a,this._scheduleUpdate(),this.fire("ySize",this._ySize))},get:function(){return this._ySize}},zSize:{set:function(a){a=a||1,this._zSize!==a&&(a<0&&(this.warn("negative zSize not allowed - will invert"),a*=-1),this._zSize=a,this._scheduleUpdate(),this.fire("zSize",this._zSize))},get:function(){return this._zSize}}},_getJSON:function(){return{center:this._center.slice(),xSize:this._xSize,ySize:this._ySize,zSize:this._zSize}}})}(),function(){"use strict";xeogl.TorusGeometry=xeogl.Geometry.extend({type:"xeogl.TorusGeometry",_init:function(a){this._super(a),this.lod=a.lod,this.center=a.center,this.radius=a.radius,this.tube=a.tube,this.radialSegments=a.radialSegments,this.tubeSegments=a.tubeSegments,this.arc=a.arc},_update:function(){var a=this._center[0],b=this._center[1],c=this._center[2],d=this._radius,e=this._tube,f=Math.floor(this._radialSegments*this._lod),g=Math.floor(this._tubeSegments*this._lod),h=this._arc;f<4&&(f=4),g<4&&(g=4);var i,j,k,l,m,n,o,p,q,r,s=[],t=[],u=[],v=[],w=0;for(r=0;r<=f;r++)for(q=0;q<=g;q++)i=q/g*h,j=r/f*Math.PI*2,k=d*Math.cos(i),l=d*Math.sin(i),m=(d+e*Math.cos(j))*Math.cos(i),n=(d+e*Math.cos(j))*Math.sin(i),o=e*Math.sin(j),s.push(m+a),s.push(n+b),s.push(o+c),u.push(1-q/g),u.push(1-r/f),p=xeogl.math.normalizeVec3(xeogl.math.subVec3([m,n,o],[k,l,w],[]),[]),t.push(p[0]),t.push(p[1]),t.push(p[2]);var x,y,z,A;for(r=1;r<=f;r++)for(q=1;q<=g;q++)x=(g+1)*r+q-1,y=(g+1)*(r-1)+q-1,z=(g+1)*(r-1)+q,A=(g+1)*r+q,v.push(x),v.push(y),v.push(z),v.push(z),v.push(A),v.push(x);this.positions=s,this.normals=t,this.uv=u,this.indices=v},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((a<0||a>1)&&(this.warn("clamping lod to [0..1]"),a=a<0?0:1),this._lod=a,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(a){(this._center=this._center||new xeogl.math.vec3).set(a||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},radius:{set:function(a){a=a||1,this._radius!==a&&(a<0&&(this.warn("negative radius not allowed - will invert"),a*=-1),this._radius=a,this._scheduleUpdate(),this.fire("radius",this._radius))},get:function(){return this._radius}},tube:{set:function(a){a=a||.3,this._tube!==a&&(a<0&&(this.warn("negative tube not allowed - will invert"),a*=-1),this._tube=a,this._scheduleUpdate(),this.fire("tube",this._tube))},get:function(){return this._tube}},radialSegments:{set:function(a){a=a||32,this._radialSegments!==a&&(a<0&&(this.warn("negative radialSegments not allowed - will invert"),a*=-1),this._radialSegments=a,this._scheduleUpdate(),this.fire("radialSegments",this._radialSegments))},get:function(){return this._radialSegments}},tubeSegments:{set:function(a){a=a||24,this._tubeSegments!==a&&(a<0&&(this.warn("negative tubeSegments not allowed - will invert"),a*=-1),this._tubeSegments=a,this._scheduleUpdate(),this.fire("tubeSegments",this._tubeSegments))},get:function(){return this._tubeSegments}},arc:{set:function(a){a=a||2*Math.PI,this._arc!==a&&(a<0&&(this.warn("negative arc not allowed - will invert"),a*=-1),this._arc=a,this._scheduleUpdate(),this.fire("arc",this._arc))},get:function(){return this._arc}}},_getJSON:function(){return{center:this._center.slice(),radius:this._radius,tube:this._tube,radialSegments:this._radialSegments,tubeSegments:this._tubeSegments,arc:this._arc}}})}(),function(){"use strict";xeogl.SphereGeometry=xeogl.Geometry.extend({type:"xeogl.SphereGeometry",_init:function(a){this._super(a),this.lod=a.lod,this.center=a.center,this.radius=a.radius,this.heightSegments=a.heightSegments,this.widthSegments=a.widthSegments},_update:function(){var a=this._radius,b=Math.floor(this._lod*this._heightSegments),c=Math.floor(this._lod*this._widthSegments);b<18&&(b=18),c<18&&(c=18);var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=[],t=[],u=[],v=[],w=this._center[0],x=this._center[1],y=this._center[2];for(d=0;d<=b;d++)for(f=d*Math.PI/b,g=Math.sin(f),h=Math.cos(f),e=0;e<=c;e++)i=2*e*Math.PI/c,j=Math.sin(i),k=Math.cos(i),l=k*g,m=h,n=j*g,o=1-e/c,p=1-d/b,t.push(l),t.push(m),t.push(n),u.push(o),u.push(p),s.push(w+a*l),s.push(x+a*m),s.push(y+a*n);for(d=0;d<b;d++)for(e=0;e<c;e++)q=d*(c+1)+e,r=q+c+1,v.push(q+1),v.push(r+1),v.push(r),v.push(q+1),v.push(r),v.push(q);this.positions=s,this.normals=t,this.uv=u,this.indices=v},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((a<0||a>1)&&(this.warn("clamping lod to [0..1]"),a=a<0?0:1),this._lod=a,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(a){(this._center=this._center||new xeogl.math.vec3).set(a||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},radius:{set:function(a){a=a||1,this._radius!==a&&(a<0&&(this.warn("negative radius not allowed - will invert"),a*=-1),this._radius=a,this._scheduleUpdate(),this.fire("radius",this._radius))},get:function(){return this._radius}},heightSegments:{set:function(a){a=a||18,this._heightSegments!==a&&(a<0&&(this.warn("negative heightSegments not allowed - will invert"),a*=-1),this._heightSegments=a,this._scheduleUpdate(),this.fire("heightSegments",this._heightSegments))},get:function(){return this._heightSegments}},widthSegments:{set:function(a){a=a||24,this._widthSegments!==a&&(a<0&&(this.warn("negative widthSegments not allowed - will invert"),a*=-1),this._widthSegments=a,this._scheduleUpdate(),this.fire("widthSegments",this._widthSegments))},get:function(){return this._widthSegments}}},_getJSON:function(){return{center:this._center.slice(),radius:this._radius,heightSegments:this._heightSegments,widthSegments:this._widthSegments}}})}(),function(){"use strict";xeogl.BoundingSphereGeometry=xeogl.SphereGeometry.extend({type:"xeogl.BoundingSphereGeometry",_init:function(a){this._super(a),a.boundary?this.boundary=a.boundary:a.sphere&&(this.sphere=a.sphere)},_props:{boundary:{set:function(a){var b=!1,c=this;this._attach({name:"boundary",type:"xeogl.Boundary3D",component:a,sceneDefault:!1,on:{updated:function(){b||(b=!0,xeogl.scheduleTask(function(){c._setFromSphere(c._attached.boundary.sphere),b=!1}))}},onAttached:function(){c._setFromSphere(c._attached.boundary.sphere)}})},get:function(){return this._attached.boundary}},sphere:{set:function(a){a&&(this._attached.boundary&&(this.boundary=null),this._setFromSphere(a))}}},_setFromSphere:function(){var a=xeogl.math.vec3();return function(b){a[0]=b[0],a[1]=b[1],a[2]=b[2],this.center=a,this.radius=b[4]}}()})}(),function(){"use strict";xeogl.OBBGeometry=xeogl.Geometry.extend({type:"xeogl.OBBGeometry",_init:function(a){this._super(a),this.primitive=a.primitive||"lines",this.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],a.boundary?this.boundary=a.boundary:a.obb?this.obb=a.obb:a.positions?this.positions=a.positions:this.positions=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]},_props:{boundary:{set:function(a){var b=!1,c=this;this._attach({name:"boundary",type:"xeogl.Boundary3D",component:a,sceneDefault:!1,on:{updated:function(){b||(b=!0,xeogl.scheduleTask(function(){c._setPositionsFromOBB(c._attached.boundary.obb),b=!1}))}},onAttached:function(){c._setPositionsFromOBB(c._attached.boundary.obb)}})},get:function(){return this._attached.boundary}},obb:{set:function(a){a&&(this._attached.boundary&&(this.boundary=null),this._setPositionsFromOBB(a))}}},_setPositionsFromOBB:function(a){this.positions=[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10],a[12],a[13],a[14],a[16],a[17],a[18],a[20],a[21],a[22],a[24],a[25],a[26],a[28],a[29],a[30]]},_getJSON:function(){var a={};return this._attached.boundary?a.boundary=this._attached.boundary.id:this.positions&&(a.positions=this.positions),a}})}(),function(){"use strict";xeogl.AABBGeometry=xeogl.Geometry.extend({type:"xeogl.AABBGeometry",_init:function(a){this._super(a),this.primitive=a.primitive||"lines",this.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],a.boundary?this.boundary=a.boundary:a.aabb?this.aabb=a.aabb:a.positions?this.positions=a.positions:this.positions=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]},_props:{boundary:{set:function(a){var b=!1,c=this;this._attach({name:"boundary",type:"xeogl.Boundary3D",component:a,sceneDefault:!1,on:{updated:function(){b||(b=!0,xeogl.scheduleTask(function(){c._setPositionsFromAABB(c._attached.boundary.aabb),b=!1}))}},onAttached:function(){c._setPositionsFromAABB(c._attached.boundary.aabb)}})},get:function(){return this._attached.boundary}},aabb:{set:function(a){a&&(this._attached.boundary&&(this.boundary=null),this._setPositionsFromAABB(a))}}},_setPositionsFromAABB:function(a){this.positions=[a[3],a[4],a[5],a[3],a[1],a[5],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[2],a[0],a[4],a[2]]},_getJSON:function(){var a={};return this._attached.boundary?a.boundary=this._attached.boundary.id:this.positions&&(this.positions=this.positions),a}})}(),xeogl.PathGeometry=xeogl.Geometry.extend({type:"xeogl.PathGeometry",_init:function(a){this._super(a),this.path=a.path,this.divisions=a.divisions},_update:function(){var a=this._attached.path;if(a){var b,c,d,e=a.getPoints(this._divisions),f=[];for(b=0,c=e.length;b<c;b++)d=e[b],f.push(d[0]),f.push(d[1]),f.push(d[2]);var g=[];for(b=0,c=e.length-1;b<c;b++)g.push(b),g.push(b+1);this.primitive="lines",this.positions=f,this.indices=g,this.normals=null,this.uv=null}},_props:{path:{set:function(a){this._attach({name:"path",type:"xeogl.Curve",component:a,sceneDefault:!1,on:{curves:{callback:this._scheduleUpdate,scope:this}}})},get:function(){return this._attached.path}},divisions:{set:function(a){a=a||6,this._divisions=a,this._scheduleUpdate(),this.fire("divisions",this._divisions)},get:function(){return this._divisions}}},_getJSON:function(){var a={divisions:this._divisions};return this._attached.path&&(a.path=this._attached.path.id),a}}),function(){"use strict";xeogl.CylinderGeometry=xeogl.Geometry.extend({type:"xeogl.CylinderGeometry",_init:function(a){this._super(a),this.center=a.center,this.lod=a.lod,this.center=a.center,this.radiusTop=a.radiusTop,this.radiusBottom=a.radiusBottom,this.height=a.height,this.radialSegments=a.radialSegments,this.heightSegments=a.heightSegments,this.openEnded=a.openEnded},_update:function(){var a=this._center[0],b=this._center[1],c=this._center[2],d=this._radiusTop,e=this._radiusBottom,f=this._height,g=Math.floor(this._radialSegments*this._lod),h=Math.floor(this._heightSegments*this._lod);g<3&&(g=3),h<1&&(h=1);var i,j,k,l,m,n,o,p,q,r,s,t,u=this._openEnded,v=f/2,w=f/h,x=2*Math.PI/g,y=1/g,z=(d-e)/h,A=[],B=[],C=[],D=[],E=(90-180*Math.atan(f/(e-d))/Math.PI)/90;for(i=0;i<=h;i++)for(m=d-i*z,n=v-i*w,j=0;j<=g;j++)k=Math.sin(j*x),l=Math.cos(j*x),B.push(m*k),B.push(E),B.push(m*l),C.push(j*y),C.push(1-1*i/h),A.push(m*k+a),A.push(n+b),A.push(m*l+c);for(i=0;i<h;i++)for(j=0;j<=g;j++)p=i*(g+1)+j,q=p+g,D.push(p),D.push(q),D.push(q+1),D.push(p),D.push(q+1),D.push(p+1);if(!u&&d>0){for(r=A.length/3,B.push(0),B.push(1),B.push(0),C.push(.5),C.push(.5),A.push(0+a),A.push(v+b),A.push(0+c),j=0;j<=g;j++)k=Math.sin(j*x),l=Math.cos(j*x),s=.5*Math.sin(j*x)+.5,t=.5*Math.cos(j*x)+.5,B.push(d*k),B.push(1),B.push(d*l),C.push(s),C.push(t),A.push(d*k+a),A.push(v+b),A.push(d*l+c);for(j=0;j<g;j++)o=r,p=r+1+j,D.push(p),D.push(p+1),D.push(o)}if(!u&&e>0){for(r=A.length/3,B.push(0),B.push(-1),B.push(0),C.push(.5),C.push(.5),A.push(0+a),A.push(0-v+b),A.push(0+c),j=0;j<=g;j++)k=Math.sin(j*x),l=Math.cos(j*x),s=.5*Math.sin(j*x)+.5,t=.5*Math.cos(j*x)+.5,B.push(e*k),B.push(-1),B.push(e*l),C.push(s),C.push(t),A.push(e*k+a),A.push(0-v+b),A.push(e*l+c);for(j=0;j<g;j++)o=r,p=r+1+j,D.push(o),D.push(p+1),D.push(p)}this.positions=A,this.normals=B,this.uv=C,this.indices=D},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((a<0||a>1)&&(this.warn("clamping lod to [0..1]"),a=a<0?0:1),this._lod=a,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(a){(this._center=this._center||new xeogl.math.vec3).set(a||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},radiusTop:{set:function(a){a=void 0!==a?a:1,this._radiusTop!==a&&(a<0&&(this.warn("negative radiusTop not allowed - will invert"),a*=-1),this._radiusTop=a,this._scheduleUpdate(),this.fire("radiusTop",this._radiusTop))},get:function(){return this._radiusTop}},radiusBottom:{set:function(a){a=void 0!==a?a:1,this._radiusBottom!==a&&(a<0&&(this.warn("negative radiusBottom not allowed - will invert"),a*=-1),this._radiusBottom=a,this._scheduleUpdate(),this.fire("radiusBottom",this._radiusBottom))},get:function(){return this._radiusBottom}},height:{set:function(a){a=a||1,this._height!==a&&(a<0&&(this.warn("negative height not allowed - will invert"),a*=-1),this._height=a,this._scheduleUpdate(),this.fire("height",this._height))},get:function(){return this._height}},radialSegments:{set:function(a){a=a||60,this._radialSegments!==a&&(a<0&&(this.warn("negative radialSegments not allowed - will invert"),a*=-1),this._radialSegments=a,this._scheduleUpdate(),this.fire("radialSegments",this._radialSegments))},get:function(){return this._radialSegments}},heightSegments:{set:function(a){a=a||1,this._heightSegments!==a&&(a<0&&(this.warn("negative heightSegments not allowed - will invert"),a*=-1),this._heightSegments=a,this._scheduleUpdate(),this.fire("heightSegments",this._heightSegments))},get:function(){return this._heightSegments}},openEnded:{set:function(a){a=void 0!==a&&a,this._openEnded!==a&&(this._openEnded=a,this._scheduleUpdate(),this.fire("openEnded",this._openEnded))},get:function(){return this._openEnded}}},_getJSON:function(){return{center:this._center.slice(),radiusTop:this._radiusTop,radiusBottom:this._radiusBottom,height:this._height,radialSegments:this._radialSegments,heightSegments:this._heightSegments,openEnded:this._openEnded}}})}(),function(){"use strict";xeogl.PlaneGeometry=xeogl.Geometry.extend({type:"xeogl.PlaneGeometry",_init:function(a){this._super(a),this.center=a.center,this.xSize=a.xSize,this.zSize=a.zSize,this.xSegments=a.xSegments,this.zSegments=a.zSegments,this.lod=a.lod,this.autoNormals=a.autoNormals!==!1},_update:function(){var a=this._center[0],b=this._center[1],c=this._center[2],d=this._xSize,e=this._zSize,f=Math.floor(this._lod*this._xSegments),g=Math.floor(this._lod*this._zSegments);g<1&&(g=1),g<1&&(g=1);var h,i,j,k,l,m,n,o=d/2,p=e/2,q=Math.floor(f)||1,r=Math.floor(g)||1,s=q+1,t=r+1,u=d/q,v=e/r,w=new Float32Array(s*t*3),x=new Float32Array(s*t*3),y=new Float32Array(s*t*2),z=0,A=0;for(h=0;h<t;h++){var B=h*v-p;for(i=0;i<s;i++)j=i*u-o,w[z]=j+a,w[z+1]=b,w[z+2]=-B+c,x[z+2]=-1,y[A]=(q-i)/q,y[A+1]=(r-h)/r,z+=3,A+=2}z=0;var C=new(w.length/3>65535?Uint32Arraz:Uint16Array)(q*r*6);for(h=0;h<r;h++)for(i=0;i<q;i++)k=i+s*h,l=i+s*(h+1),m=i+1+s*(h+1),n=i+1+s*h,C[z]=n,C[z+1]=l,C[z+2]=k,C[z+3]=n,C[z+4]=m,
C[z+5]=l,z+=6;this.positions=w,this.normals=x,this.uv=y,this.indices=C},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((a<0||a>1)&&(this.warn("clamping lod to [0..1]"),a=a<0?0:1),this._lod=a,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(a){(this._center=this._center||new xeogl.math.vec3).set(a||[0,0,0]),this._scheduleUpdate(),this.fire("center",this._center)},get:function(){return this._center}},xSize:{set:function(a){a=a||1,this._xSize!==a&&(a<0&&(this.warn("negative xSize not allowed - will invert"),a*=-1),this._xSize=a,this._scheduleUpdate(),this.fire("xSize",this._xSize))},get:function(){return this._xSize}},zSize:{set:function(a){a=a||1,this._zSize!==a&&(a<0&&(this.warn("negative zSize not allowed - will invert"),a*=-1),this._zSize=a,this._scheduleUpdate(),this.fire("zSize",this._zSize))},get:function(){return this._zSize}},xSegments:{set:function(a){a=a||1,this._xSegments!==a&&(a<0&&(this.warn("negative xSegments not allowed - will invert"),a*=-1),this._xSegments=a,this._scheduleUpdate(),this.fire("xSegments",this._xSegments))},get:function(){return this._xSegments}},zSegments:{set:function(a){a=a||1,this._zSegments!==a&&(a<0&&(this.warn("negative zSegments not allowed - will invert"),a*=-1),this._zSegments=a,this._scheduleUpdate(),this.fire("zSegments",this._zSegments))},get:function(){return this._zSegments}}},_getJSON:function(){return{center:this._center.slice(),xSize:this._xSize,zSize:this._zSize,xSegments:this._xSegments,zSegments:this._zSegments}}})}(),function(){"use strict";xeogl.LatheGeometry=xeogl.Geometry.extend({type:"xeogl.LatheGeometry",_init:function(a){this._super(a),this.points=a.points,this.segments=a.segments,this.phiStart=a.phiStart,this.phiLength=a.phiLength,this.lod=a.lod,this.autoNormals=a.autoNormals!==!1},_update:function(){var a=[],b=[],c=Math.floor(this._lod*this._segments);c<4&&(c=4);for(var d=this._phiStart*xeogl.math.DEGTORAD,e=this._phiLength*xeogl.math.DEGTORAD,f=this._points,g=(1/(f.length-1),1/c),h=0,i=c;h<=i;h++)for(var j=d+h*g*e,k=Math.cos(j),l=Math.sin(j),m=0,n=f.length;m<n;m++){var o=f[m];a.push(k*o[0]-l*o[1]),a.push(l*o[0]+k*o[1]),a.push(o[2])}for(var p=f.length,h=0,i=c;h<i;h++)for(var m=0,n=f.length-1;m<n;m++){var q=m+p*h,r=q,s=q+p,k=q+1+p,t=q+1;b.push(t),b.push(s),b.push(r),b.push(t),b.push(k),b.push(s)}this.positions=a,this.indices=b},_props:{points:{set:function(a){this._points=a||[],this._scheduleUpdate(),this.fire("points",this._points)},get:function(){return this._points}},lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((a<0||a>1)&&(this.warn("clamping lod to [0..1]"),a=a<0?0:1),this._lod=a,this._scheduleUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},phiStart:{set:function(a){a=a||0,this._phiStart!==a&&(a<0&&(this.warn("negative phiStart not allowed - will invert"),a*=-1),this._phiStart=a,this._scheduleUpdate(),this.fire("phiStart",this._phiStart))},get:function(){return this._phiStart}},phiLength:{set:function(a){a=a||1,this._phiLength!==a&&(a<0&&(this.warn("negative phiLength not allowed - will invert"),a*=-1),this._phiLength=a,this._scheduleUpdate(),this.fire("phiLength",this._phiLength))},get:function(){return this._phiLength}},segments:{set:function(a){a=Math.floor(a||4),this._segments!==a&&(a<0&&(this.warn("negative segments not allowed - will invert"),a*=-1),this._segments=a,this._scheduleUpdate(),this.fire("segments",this._segments))},get:function(){return this._segments}}},_getJSON:function(){return{points:this._points,phiStart:this._phiStart,phiLength:this._phiLength,segments:this._segments}}})}(),function(){"use strict";xeogl.Input=xeogl.Component.extend({type:"xeogl.Input",serializable:!1,_init:function(a){var b=this;this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.mouseover=!1,document.addEventListener("keydown",this._keyDownListener=function(a){b.enabled&&("INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!0:a.altKey?b.altDown=!0:(b.keyDown[a.keyCode]=!0,b.fire("keydown",a.keyCode,!0))),b.mouseover&&a.preventDefault())},!0),document.addEventListener("keyup",this._keyUpListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!1:a.altKey?b.altDown=!1:(b.keyDown[a.keyCode]=!1,b.fire("keyup",a.keyCode,!0)))}),a.element.addEventListener("mouseenter",this._mouseDownListener=function(a){if(b.enabled){b.mouseover=!0;var c=b._getClickCoordsWithinElement(a);b.fire("mouseenter",c,!0)}}),a.element.addEventListener("mouseleave",this._mouseDownListener=function(a){if(b.enabled){b.mouseover=!1;var c=b._getClickCoordsWithinElement(a);b.fire("mouseleave",c,!0)}}),document.addEventListener("mousedown",this._mouseDownListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!0;break;case 2:b.mouseDownMiddle=!0;break;case 3:b.mouseDownRight=!0}var c=b._getClickCoordsWithinElement(a);b.fire("mousedown",c,!0),b.mouseover&&a.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("mouseup",c,!0),b.mouseover&&a.preventDefault()}},!0),document.addEventListener("dblclick",this._dblClickListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1,b.mouseDownRight=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownLeft=!1,b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("dblclick",c,!0),b.mouseover&&a.preventDefault()}}),document.addEventListener("mousemove",this._mouseMoveListener=function(a){if(b.enabled){var c=b._getClickCoordsWithinElement(a);b.fire("mousemove",c,!0),b.mouseover&&a.preventDefault()}}),a.element.addEventListener("mousewheel",this._mouseWheelListener=function(a,c){if(b.enabled){var d=Math.max(-1,Math.min(1,a.wheelDelta||-a.detail));b.fire("mousewheel",d,!0),b.mouseover&&a.preventDefault()}}),function(){var a,c,d=2;b.on("mousedown",function(b){a=b[0],c=b[1]}),b.on("mouseup",function(e){a>=e[0]-d&&a<=e[0]+d&&c>=e[1]-d&&c<=e[1]+d&&b.fire("mouseclicked",e,!0)})}(),function(){var a,c,d={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0},e=xeogl.math.vec3(),f=xeogl.math.vec3(),g={orientation:null,orientationAngle:0},h={orientationAngle:0,acceleration:null,accelerationIncludingGravity:f,rotationRate:xeogl.math.vec3(),interval:0},i={alpha:0,beta:0,gamma:0,absolute:!1};window.OrientationChangeEvent?window.addEventListener("orientationchange",b._orientationchangedListener=function(){a=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,c=a?d[a]||0:0,g.orientation=a,g.orientationAngle=c,b.fire("orientationchange",g)},!1):b.warn("Browser event not supported: orientationchange"),window.DeviceMotionEvent?window.addEventListener("devicemotion",b._deviceMotionListener=function(a){h.interval=a.interval,h.orientationAngle=c;var d=a.acceleration;d?(e[0]=d.x,e[1]=d.y,e[2]=d.z,h.acceleration=e):h.acceleration=null;var g=a.accelerationIncludingGravity;g?(f[0]=g.x,f[1]=g.y,f[2]=g.z,h.accelerationIncludingGravity=f):h.accelerationIncludingGravity=null,h.rotationRate=a.rotationRate,b.fire("devicemotion",h)},!1):b.warn("Browser event not supported: devicemotion"),window.DeviceOrientationEvent?window.addEventListener("deviceorientation",b._deviceOrientListener=function(a){i.gamma=a.gamma,i.beta=a.beta,i.alpha=a.alpha,i.absolute=a.absolute,b.fire("deviceorientation",i)},!1):b.warn("Browser event not supported: deviceorientation")}()},_getClickCoordsWithinElement:function(a){var b=[0,0];if(a){for(var c=a.target,d=0,e=0;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;b[0]=a.pageX-d,b[1]=a.pageY-e}else a=window.event,b.x=a.x,b.y=a.y;return b},setEnabled:function(a){this.enabled!==a&&this.fire("enabled",this.enabled=a)},KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_NUM_0:48,KEY_NUM_1:49,KEY_NUM_2:50,KEY_NUM_3:51,KEY_NUM_4:52,KEY_NUM_5:53,KEY_NUM_6:54,KEY_NUM_7:55,KEY_NUM_8:56,KEY_NUM_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW:91,KEY_RIGHT_WINDOW:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_SPACE:32,_destroy:function(){document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener)}})}(),function(){"use strict";xeogl.Lights=xeogl.Component.extend({type:"xeogl.Lights",_init:function(a){this._state=new xeogl.renderer.Lights({lights:[],hash:""}),this._dirty=!0,this._lights=[],this._dirtySubs=[],this._destroyedSubs=[],this.lights=a.lights},_props:{lights:{set:function(a){function b(){g.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=g._lights.length;b<c;b++)if(g._lights[b].id===a)return g._lights=g._lights.slice(b,b+1),g._dirtySubs=g._dirtySubs.slice(b,b+1),g._destroyedSubs=g._destroyedSubs.slice(b,b+1),g._dirty=!0,g.fire("dirty",!0),void g.fire("lights",g._lights)}a=a||[];var d,e,f;for(e=0,f=this._lights.length;e<f;e++)d=this._lights[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._lights=[],this._dirtySubs=[],this._destroyedSubs=[];var g=this;for(e=0,f=a.length;e<f;e++){if(d=a[e],xeogl._isNumeric(d)||xeogl._isString(d)){var h=d;if(d=this.scene.components[h],!d){this.error("Component not found: "+xeogl._inQuotes(h));continue}}var i=d.type;"xeogl.AmbientLight"===i||"xeogl.DirLight"===i||"xeogl.PointLight"===i?(this._lights.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c))):this.error("Component "+xeogl._inQuotes(d.id)+" is not an xeogl.AmbientLight, xeogl.DirLight or xeogl.PointLight ")}this._dirty=!0,this.fire("dirty",!0),this.fire("lights",this._lights)},get:function(){return this._lights}}},_compile:function(){var a=this._state;if(this._dirty){a.lights=[];for(var b=0,c=this._lights.length;b<c;b++)a.lights.push(this._lights[b]._state);this._makeHash(),this._dirty=!1}this._renderer.lights=a},_makeHash:function(){var a=this._state.lights;if(0===a.length)return";";for(var b,c=[],d=0,e=a.length;d<e;d++)b=a[d],c.push(b.type),c.push("world"===b.space?"w":"v");c.push(";"),this._state.hash=c.join("")},_getJSON:function(){for(var a=[],b=0,c=this._lights.length;b<c;b++)a.push(this._lights[b].id);return{lights:a}},_destroy:function(){var a,b,c;for(a=0,b=this._lights.length;a<b;a++)c=this._lights[a],c.off(this._dirtySubs[a]),c.off(this._destroyedSubs[a]);this._state.destroy()}})}(),function(){"use strict";xeogl.AmbientLight=xeogl.Component.extend({type:"xeogl.AmbientLight",_init:function(a){this._state={type:"ambient",color:xeogl.math.vec3([.7,.7,.7]),intensity:1},this.color=a.color,this.intensity=a.intensity},_props:{color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){this._state.intensity=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}}},_getJSON:function(){return{color:this._state.color,intensity:this._state.intensity}}})}(),function(){"use strict";xeogl.DirLight=xeogl.Component.extend({type:"xeogl.DirLight",_init:function(a){this._state={type:"dir",dir:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,space:"view"},this.dir=a.dir,this.color=a.color,this.intensity=a.intensity,this.space=a.space},_props:{dir:{set:function(a){this._state.dir.set(a||[1,1,1]),this._renderer.imageDirty=!0,this.fire("dir",this._state.dir)},get:function(){return this._state.dir}},color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}}},_getJSON:function(){return{type:this._state.type,dir:this._state.dir,color:this._state.color,intensity:this._state.intensity,space:this._state.space}}})}(),function(){"use strict";xeogl.PointLight=xeogl.Component.extend({type:"xeogl.PointLight",_init:function(a){this._state={type:"point",pos:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:"view"},this.pos=a.pos,this.color=a.color,this.intensity=a.intensity,this.constantAttenuation=a.constantAttenuation,this.linearAttenuation=a.linearAttenuation,this.quadraticAttenuation=a.quadraticAttenuation,this.space=a.space},_props:{pos:{set:function(a){this._state.pos.set(a||[1,1,1]),this._renderer.imageDirty=!0,this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},constantAttenuation:{set:function(a){this._state.attenuation[0]=a||0,this._renderer.imageDirty=!0,this.fire("constantAttenuation",this._state.attenuation[0])},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(a){this._state.attenuation[1]=a||0,this._renderer.imageDirty=!0,this.fire("linearAttenuation",this._state.attenuation[1])},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(a){this._state.attenuation[2]=a||0,this._renderer.imageDirty=!0,this.fire("quadraticAttenuation",this._state.attenuation[2])},get:function(){return this._state.attenuation[2]}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}}},_getJSON:function(){return{type:this._state.type,pos:this._state.pos,color:this._state.color,intensity:this._state.intensity,constantAttenuation:this._state.attenuation[0],linearAttenuation:this._state.attenuation[1],quadraticAttenuation:this._state.attenuation[2],space:this._state.space}}})}(),function(){"use strict";xeogl.Model=xeogl.Component.extend({type:"xeogl.Model",_init:function(a){this.components={},this.numComponents=0,this.types={},this._onDestroyed={},this._onWorldBoundaryUpdated={},this._aabbDirty=!0,this._dummyRootTransform=this.create({type:"xeogl.Transform",meta:"dummy"}),this.transform=a.transform,a.components&&this.add(a.components)},add:function(a){a=xeogl._isArray(a)?a:[a];for(var b=0,c=a.length;b<c;b++)this._add(a[b])},_add:function(a){var b,c,d,e;if(xeogl._isNumeric(a)||xeogl._isString(a)){if(this.scene.types[a]){if(d=a,e=this.scene.types[d],!e)return void this.warn("Component type not found: '"+d+"'");for(b in e)e.hasOwnProperty(b)&&this._add(e[b]);return}if(c=this.scene.components[a],!c)return void this.warn("Component not found: "+xeogl._inQuotes(a))}else if(xeogl._isObject(a)){var d=a.type||"xeogl.Component";if(!xeogl._isComponentType(d))return void this.error("Not a xeogl component type: "+d);c=new window[d](this.scene,a)}else{if(!a.type)return;c=a}if(c.scene!==this.scene)return void this.warn("Attempted to add component from different xeogl.Scene: "+xeogl._inQuotes(c.id));if(!this.components[c.id]){this.components[c.id]=c,e=this.types[c.type],e||(e=this.types[c.type]={}),e[c.id]=c,this.numComponents++;var f=this;if(this._onDestroyed[c.id]=c.on("destroyed",function(){f._remove(c)}),c.isType("xeogl.Entity")){var g=c.transform;if(g){for(;g.parent;){if(g.id===f._dummyRootTransform.id)return;g=g.parent}g.id!==f._dummyRootTransform.id&&(g.parent=f._dummyRootTransform)}else c.transform=f._dummyRootTransform}c.worldBoundary&&(this._onWorldBoundaryUpdated[a.id]=c.worldBoundary.on("updated",this._updated,this),this._aabbDirty||this._setAABBDirty()),this.fire("added",c),this._dirty||this._scheduleUpdate()}},_scheduleUpdate:function(){this._dirty||(this._dirty=!0,xeogl.scheduleTask(this._notifyUpdated,this))},_notifyUpdated:function(){this.fire("updated"),this._dirty=!1},destroyAll:function(){this.iterate(function(a){a.destroy()})},removeAll:function(){},_remove:function(a){var b=a.id;if(a.scene!==this.scene)return void this.warn("Attempted to remove component that's not in same xeogl.Scene: '"+b+"'");delete this.components[b],a.off(this._onDestroyed[b]),delete this._onDestroyed[b];var c=this.types[a.type];c&&delete c[a.id],this.numComponents--,a.worldBoundary&&(a.worldBoundary.off(this._onWorldBoundaryUpdated[a.id]),delete this._onWorldBoundaryUpdated[a.id]),this._aabbDirty||this._setAABBDirty(),this.fire("removed",a),this._dirty||this._scheduleUpdate()},iterate:function(a,b){b=b||this;var c=this.components;for(var d in c)c.hasOwnProperty(d)&&a.call(b,c[d])},_props:{transform:{set:function(a){this._attach({name:"transform",type:"xeogl.Transform",component:a,sceneDefault:!1,onAttached:{callback:this._transformUpdated,scope:this}})},get:function(){return this._attached.transform}},worldBoundary:{get:function(){if(!this._worldBoundary){var a=this;this._worldBoundary=this.create({type:"xeogl.Boundary3D",getDirty:function(){return!!a._aabbDirty&&(a._buildAABB(),a._aabbDirty=!1,!0)},getAABB:function(){return a._aabb}}),this._worldBoundary.on("destroyed",function(){a._worldBoundary=null})}return this._worldBoundary}}},_transformUpdated:function(a){this._dummyRootTransform.parent=a},_updated:function(){this._aabbDirty||this._setAABBDirty()},_setAABBDirty:function(){this._aabbDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0)},_buildAABB:function(){this._aabb||(this._aabb=xeogl.math.AABB3());var a,b,c,d=1e5,e=1e5,f=1e5,g=-1e5,h=-1e5,i=-1e5,j=this.components;for(var k in j)j.hasOwnProperty(k)&&(a=j[k],b=a.worldBoundary,b&&(c=b.aabb,c[0]<d&&(d=c[0]),c[1]<e&&(e=c[1]),c[2]<f&&(f=c[2]),c[3]>g&&(g=c[3]),c[4]>h&&(h=c[4]),c[5]>i&&(i=c[5])));this._aabb[0]=d,this._aabb[1]=e,this._aabb[2]=f,this._aabb[3]=g,this._aabb[4]=h,this._aabb[5]=i},_destroy:function(){this.removeAll()}})}(),function(){"use strict";var a=["extensions","buffers","bufferViews","images","videos","samplers","textures","shaders","programs","techniques","materials","accessors","meshes","cameras","lights","skins","nodes","scenes","animations"];xeogl.glTFParser=Object.create(Object.prototype,{_rootDescription:{value:null,writable:!0},rootDescription:{set:function(a){this._rootDescription=a},get:function(){return this._rootDescription}},baseURL:{value:null,writable:!0},_isAbsolutePath:{value:function(a){var b=new RegExp("^"+window.location.protocol,"i");return!!a.match(b)}},resolvePathIfNeeded:{value:function(a){if(this._isAbsolutePath(a))return a;var b=/^data:/;return b.test(a)?a:this.baseURL+a}},_resolvePathsForCategories:{value:function(a){a.forEach(function(a){var b=this.json[a];if(b){var c=Object.keys(b);c.forEach(function(a){var c=b[a];c.uri=this.resolvePathIfNeeded(c.uri)},this)}},this)}},_json:{value:null,writable:!0},json:{enumerable:!0,get:function(){return this._json},set:function(a){this._json!==a&&(this._json=a,this._resolvePathsForCategories(["buffers","shaders","images","videos"]))}},_path:{value:null,writable:!0},getEntryDescription:{value:function(a,b){var c=null,d=b;return c=this.rootDescription[d],c?c?c[a]:null:(console.log("ERROR:CANNOT find expected category named:"+d),null)}},_stepToNextCategory:{value:function(){return this._state.categoryIndex=this.getNextCategoryIndex(this._state.categoryIndex+1),this._state.categoryIndex!==-1&&(this._state.categoryState.index=0,!0)}},_stepToNextDescription:{enumerable:!1,value:function(){var a=this._state.categoryState,b=a.keys;return b?(a.index++,a.keys=null,a.index>=b.length&&this._stepToNextCategory()):(console.log("INCONSISTENCY ERROR"),!1)}},hasCategory:{value:function(a){return!!this.rootDescription[a]}},_handleState:{value:function(){for(var b={buffers:this.handleBuffer,bufferViews:this.handleBufferView,shaders:this.handleShader,programs:this.handleProgram,techniques:this.handleTechnique,materials:this.handleMaterial,meshes:this.handleMesh,cameras:this.handleCamera,lights:this.handleLight,nodes:this.handleNode,scenes:this.handleScene,images:this.handleImage,animations:this.handleAnimation,accessors:this.handleAccessor,skins:this.handleSkin,samplers:this.handleSampler,textures:this.handleTexture,videos:this.handleVideo,extensions:this.handleExtension},c=!0;this._state.categoryIndex!==-1;){var d=a[this._state.categoryIndex],e=this._state.categoryState,f=e.keys;if(f||(e.keys=f=Object.keys(this.rootDescription[d]),!f||0!==f.length)){var g=d,h=f[e.index],i=this.getEntryDescription(h,g);if(i){if(b[g]&&b[g].call(this,h,i,this._state.userInfo)===!1){c=!1;break}this._stepToNextDescription()}else if(this.handleError){this.handleError("INCONSISTENCY ERROR: no description found for entry "+h),c=!1;break}}else this._stepToNextDescription()}this.handleLoadCompleted&&this.handleLoadCompleted(c)}},_loadJSONIfNeeded:{enumerable:!0,value:function(a){var b=this;if(this._json)a&&a(this.json);else{var c=this._path,d=c.lastIndexOf("/");this.baseURL=0!==d?c.substring(0,d+1):"";var e=new XMLHttpRequest;e.open("GET",c,!0),e.onreadystatechange=function(){4===e.readyState&&200===e.status&&(b.json=JSON.parse(e.responseText),a&&a(b.json))},e.send(null)}}},_buildLoader:{value:function(a){function b(b){c.rootDescription=b,a&&a(this)}var c=this;this._loadJSONIfNeeded(b)}},_state:{value:null,writable:!0},_getEntryType:{value:function(b){for(var c=a,d=0;d<c.length;d++){var e=this.rootDescription[c[d]];if(e)return c[d]}return null}},getNextCategoryIndex:{value:function(b){for(var c=b;c<a.length;c++)if(this.hasCategory(a[c]))return c;return-1}},load:{enumerable:!0,value:function(a,b){var c=this;this._buildLoader(function(d){var e=c.getNextCategoryIndex.call(c,0);e!==-1&&(c._state={userInfo:a,options:b,categoryIndex:e,categoryState:{index:"0"}},c._handleState())})}},initWithPath:{value:function(a,b){return this._idPrefix=a,this._path=b,this._json=null,this}},_knownURLs:{writable:!0,value:{}},loaderContext:{value:function(){return"undefined"==typeof this._knownURLs[this._path]&&(this._knownURLs[this._path]=Object.keys(this._knownURLs).length),"__"+this._knownURLs[this._path]}},initWithJSON:{value:function(a,b){return this.json=a,this.baseURL=b,b||console.log("WARNING: no base URL passed to Reader:initWithJSON"),this}}})}(),xeogl.GLTFLoaderUtils=Object.create(Object,{ARRAY_BUFFER:{value:"ArrayBuffer"},_streams:{value:{},writable:!0},_streamsStatus:{value:{},writable:!0},_resources:{value:{},writable:!0},_resourcesStatus:{value:{},writable:!0},init:{value:function(){this._streams={},this._streamsStatus={},this._resources={},this._resourcesStatus={}}},_containsResource:{enumerable:!1,value:function(a){return!!this._resources[a]}},_storeResource:{enumerable:!1,value:function(a,b){return a?(this._containsResource[a]&&console.log("WARNING: resource:"+a+" is already stored, overriding"),void(this._resources[a]=b)):void console.log("ERROR: entry does not contain id, cannot store")}},_getResource:{enumerable:!1,value:function(a){return this._resources[a]}},_loadStream:{value:function(a,b,c){function d(a,b){var c=decodeURIComponent(b);return a?atob(c):c}function e(a,b){for(var c=d(a,b),e=new ArrayBuffer(c.length),f=new Uint8Array(e),g=0;g<c.length;g++)f[g]=c.charCodeAt(g);return e}function f(a,b){b="undefined"!=typeof b?b:"";var c=a[1],f=!!a[2],g=a[3];switch(b){case"":case"text":return d(f,g);case"ArrayBuffer":return e(f,g);case"blob":var h=e(f,g);return new Blob([h],{type:c});case"document":var i=new DOMParser;return i.parseFromString(d(f,g),c);case"json":return JSON.parse(d(f,g));default:throw"Unhandled responseType: "+b}}var g=/^data:(.*?)(;base64)?,(.*)$/,h=g.exec(a);if(null!==h)return void c.streamAvailable(a,f(h,b));if(!b)return void c.handleError(xeogl.GLTFLoaderUtils.INVALID_TYPE,null);if(!a)return void c.handleError(xeogl.GLTFLoaderUtils.INVALID_PATH);var i=new XMLHttpRequest;i.open("GET",a,!0),i.responseType=b===this.ARRAY_BUFFER?"arraybuffer":"text",i.setRequestHeader("If-Modified-Since","Sat, 01 Jan 1970 00:00:00 GMT"),i.onload=function(){200===i.status||206===i.status?c.streamAvailable(a,i.response):c.handleError(xeogl.GLTFLoaderUtils.XMLHTTPREQUEST_STATUS_ERROR,this.status)},i.send(null)}},send:{value:0,writable:!0},requested:{value:0,writable:!0},_handleRequest:{value:function(a){var b=this._resourcesStatus[a.id];b?this._resourcesStatus[a.id]++:this._resourcesStatus[a.id]=1;var c=this._streamsStatus[a.uri];if(c&&"loading"===c.status)return void c.requests.push(a);this._streamsStatus[a.uri]={status:"loading",requests:[a]};var d=this,e={};e.streamAvailable=function(a,b){var c=d._streamsStatus[a],e=c.requests;e.forEach(function(a){var c=b.slice(a.range[0],a.range[1]),e=a.delegate.convert(c,a.ctx);d._storeResource(a.id,e),a.delegate.resourceAvailable(e,a.ctx),--d._resourcesStatus[a.id]},this),delete d._streamsStatus[a]},e.handleError=function(b,c){a.delegate.handleError(b,c)},this._loadStream(a.uri,a.type,e)}},_elementSizeForGLType:{value:function(a,b){var c=0;switch(b){case"SCALAR":c=1;break;case"VEC2":c=2;break;case"VEC3":c=3;break;case"VEC4":c=4;break;case"MAT2":c=4;break;case"MAT3":c=9;break;case"MAT4":c=16}switch(a){case WebGLRenderingContext.FLOAT:return Float32Array.BYTES_PER_ELEMENT*c;case WebGLRenderingContext.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT*c;case WebGLRenderingContext.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT*c;default:return null}}},_handleWrappedBufferViewResourceLoading:{value:function(a,b,c){var d=a.bufferView,e=d.buffer,f=a.byteOffset+d.description.byteOffset,g=[f,this._elementSizeForGLType(a.componentType,a.type)*a.count+f];this._handleRequest({id:a.id,range:g,type:e.description.type,uri:e.description.uri,delegate:b,ctx:c},null)}},getBuffer:{value:function(a,b,c){var d=this._getResource(a.id);return d?d:(this._handleWrappedBufferViewResourceLoading(a,b,c),null)}},getFile:{value:function(a,b,c){return a.delegate=b,a.ctx=c,this._handleRequest({id:a.id,uri:a.uri,range:[0],type:"text",delegate:b,ctx:c},null),null}}}),function(){"use strict";function a(a,b,c){console.log(a+": "+b+": "+JSON.stringify(c,null,4))}function b(a){var b=0;switch(a){case"SCALAR":b=1;break;case"VEC2":b=2;break;case"VEC3":b=3;break;case"VEC4":b=4;break;case"MAT2":b=4;break;case"MAT3":b=9;break;case"MAT4":b=16}return b}var c=function(a,b,c){this.entryID=a,this.object=b,this.description=c},d=function(){this._entries={}};d.prototype.setEntry=function(a,b,d){return a?(this._entries[a]&&console.warn("entry["+a+"] is being overwritten"),void(this._entries[a]=new c(a,b,d))):void console.error("No EntryID provided, cannot store",d)},d.prototype.getEntry=function(a){return this._entries[a]},d.prototype.clearEntries=function(){this._entries={}};var e=function(){};e.prototype.handleError=function(a,b){console.log("ERROR(IndicesDelegate):"+a+":"+b)},e.prototype.convert=function(a,b){return new Uint16Array(a,0,b.indices.count)},e.prototype.resourceAvailable=function(a,b){var c=b.geometry;return c.indices=a,!0};var f=new e,g=function(a,b){this.indices=a,this.geometry=b},h=function(){};h.prototype.handleError=function(a,b){console.log("ERROR(VertexAttributeDelegate):"+a+":"+b)},h.prototype.convert=function(a,b){return a},h.prototype.resourceAvailable=function(a,c){var d=c.geometry,e=c.attribute,f=c.semantic;return"POSITION"===f?d.positions=new Float32Array(a,0,e.count*b(e.type)):"NORMAL"===f?d.normals=new Float32Array(a,0,e.count*b(e.type)):"TEXCOORD_0"!==f&&"TEXCOORD"!==f||(d.uv=new Float32Array(a,0,e.count*b(e.type))),d.loadedAttributes++,!0};var i=new h,j=function(a,b,c){this.attribute=a,this.semantic=b,this.geometry=c};xeogl.GLTFLoader=Object.create(xeogl.glTFParser,{setModel:{value:function(a){this.model=a}},load:{enumerable:!0,value:function(a,b,c){if(!this.model)throw"model not set";this.resources=new d,xeogl.glTFParser.handleLoadCompleted=c,xeogl.glTFParser.load.call(this,a,b)}},_makeID:{value:function(a){return this._idPrefix+"#"+a}},handleBuffer:{value:function(a,b,c){return this.resources.setEntry(a,null,b),b.type="ArrayBuffer",!0}},handleBufferView:{value:function(a,b,c){this.resources.setEntry(a,null,b);var d=this.resources.getEntry(b.buffer);b.type="ArrayBufferView";var e=this.resources.getEntry(a);return e.buffer=d,!0}},handleAccessor:{value:function(a,b,c){return this.resources.setEntry(a,b,b),!0}},handleTexture:{value:function(a,b,c){if(b.source){var d=this._json.images[b.source],e=new xeogl.Texture(this.model.scene,{id:this._makeID(a),src:d.uri,flipY:!0});return this.model.add(e),this.resources.setEntry(a,e,b),!0}}},handleMaterial:{value:function(a,b,c){var d,e=b.values||{},f=e.diffuse,g=e.specular,h=e.shininess,i=e.emission,j={id:this._makeID(a),meta:{userInfo:c},shininess:h};f&&(xeogl._isString(f)?(d=this.resources.getEntry(f),d&&(j.diffuseMap=d.object)):j.diffuse=f.slice(0,3)),g&&(xeogl._isString(g)?(d=this.resources.getEntry(g),d&&(j.specularMap=d.object)):j.specular=g.slice(0,3)),i&&(xeogl._isString(i)?(d=this.resources.getEntry(i),d&&(j.emissiveMap=d.object)):j.emissive=i.slice(0,3));var k=new xeogl.PhongMaterial(this.model.scene,j);return this.model.add(k),this.resources.setEntry(a,k,b),!0}},handleLight:{value:function(b,c,d){return a("light",b,c),!0}},handleMesh:{value:function(b,c,d){var e=[];this.resources.setEntry(b,e,c);var h=c.primitives;if(!h)return a("MISSING_PRIMITIVES for mesh:"+b),!1;for(var k=0;k<h.length;k++){var l=h[k];if(l.mode===WebGLRenderingContext.TRIANGLES){var m=new xeogl.Geometry(this.model.scene,{id:this._makeID(b)});this.model.add(m);var n=this.resources.getEntry(l.material),o=n.object;e.push({geometry:m,material:o});var p=Object.keys(l.attributes);m.totalAttributes+=p.length;var q=this.resources.getEntry(l.indices),r=this.resources.getEntry(q.description.bufferView),s={bufferView:r,byteOffset:q.description.byteOffset,count:q.description.count,id:q.entryID,componentType:q.description.componentType,type:q.description.type},t=new g(s,m);xeogl.GLTFLoaderUtils.getBuffer(s,f,t);p.forEach(function(a){var b,d,e=l.attributes[a],f=this.resources.getEntry(e);f?(b=f.object,b.id=e,d=this.resources.getEntry(b.bufferView)):(b=c.attributes[e],b.id=e,this.resources.setEntry(e,b,b),d=this.resources.getEntry(b.bufferView),f=this.resources.getEntry(e));var g={bufferView:d,byteOffset:b.byteOffset,byteStride:b.byteStride,count:b.count,max:b.max,min:b.min,componentType:b.componentType,type:b.type,id:e},h=new j(g,a,m);xeogl.GLTFLoaderUtils.getBuffer(g,i,h)},this)}}return!0}},handleCamera:{value:function(a,b,c){return!0}},handleScene:{value:function(a,b,c){var d=b.nodes;if(d){var e,f;for(var g in d)d.hasOwnProperty(g)&&(e=d[g],f=null,this._parseNode(e,f))}}},_parseNode:{
value:function(a,b){var c=this._json.nodes[a];if(c){var d=this.model,e=d.scene;if(c.matrix){var f=c.matrix;b=new xeogl.Transform(e,{id:this._makeID(a+".transform"),matrix:f,parent:b}),d.add(b)}if(c.translation){var g=c.translation;b=new xeogl.Translate(e,{id:this._makeID(a+".translation"),xyz:[g[0],g[1],g[2]],parent:b}),d.add(b)}if(c.rotation){var h=c.rotation;b=new xeogl.Rotate(e,{id:this._makeID(a+".rotation"),xyz:[h[0],h[1],h[2]],angle:h[3],parent:b}),d.add(b)}if(c.scale){var i=c.scale;b=new xeogl.Scale(e,{id:this._makeID(a+".scale"),xyz:[i[0],i[1],i[2]],parent:b}),d.add(b)}if(c.meshes){var j=new xeogl.Visibility(e,{id:this._makeID(a+".visibility")});d.add(j);var k=new xeogl.Cull(e,{id:this._makeID(a+".cull")});d.add(k);var l=new xeogl.Modes(e,{id:this._makeID(a+".modes")});d.add(k);var m,n,o,p,q,r,s,t,u=c.meshes,v=u.length;e.types["xeogl.Entity"];for(m=0;m<v;m++)if(n=this.resources.getEntry(u[m]))for(n=n.object,o=0,p=n.length;o<p;o++)q=n[o].material,r=n[o].geometry,s=this._makeID(a+".entity."+o),t=new xeogl.Entity(e,{id:s,meta:{name:c.name},material:q,geometry:r,transform:b,visibility:j,cull:k,modes:l,loading:!0}),d.add(t)}if(c.children){var w,x=c.children;for(o=0,p=x.length;o<p;o++)w=x[o],this._parseNode(w,b)}return!0}}}})}(),function(){"use strict";xeogl.GLTFModel=xeogl.Model.extend({type:"xeogl.GLTFModel",_init:function(a){return this._super(a),this._src=null,a.src?xeogl._isString(a.src)?void(this.src=a.src):void this.error("Value for config 'src' should be a string"):void this.error("Config missing: 'src'")},_props:{src:{set:function(a){if(a){if(!xeogl._isString(a))return void this.error("Value for 'src' should be a string");if(a===this._src)return void this.fire("loaded");this.destroyAll(),this._src=a;var b=xeogl.GLTFLoader;b.setModel(this),b.initWithPath(this.id,this._src);var c=this,d=null,e=null,f=c.scene.canvas.spinner;f.processes++,b.load(d,e,function(){f.processes--,c.fire("loaded")}),this.fire("src",this._src)}},get:function(){return this._src}}},_getJSON:function(){var a={};return this.src&&(a.src=this._src),a},_destroy:function(){this.destroyAll()}})}(),function(){"use strict";xeogl.Material=xeogl.Component.extend({type:"xeogl.Material",_init:function(){}})}(),function(){"use strict";xeogl.PhongMaterial=xeogl.Material.extend({type:"xeogl.PhongMaterial",_init:function(a){this._state=new xeogl.renderer.PhongMaterial({type:"phongMaterial",ambient:xeogl.math.vec3([1,1,1]),diffuse:xeogl.math.vec3([1,1,1]),specular:xeogl.math.vec3([1,1,1]),emissive:xeogl.math.vec3([0,0,0]),opacity:1,shininess:30,reflectivity:1,lineWidth:1,pointSize:1,ambientMap:null,normalMap:null,diffuseMap:null,specularMap:null,emissiveMap:null,opacityMap:null,reflectivityMap:null,diffuseFresnel:null,specularFresnel:null,emissiveFresnel:null,opacityFresnel:null,reflectivityFresnel:null,hash:null}),this._hashDirty=!0,this.on("dirty",function(){this._hashDirty=!0},this),this.ambient=a.ambient,this.diffuse=a.diffuse,this.specular=a.specular,this.emissive=a.emissive,this.opacity=a.opacity,this.shininess=a.shininess,this.reflectivity=a.reflectivity,this.lineWidth=a.lineWidth,this.pointSize=a.pointSize,this.ambientMap=a.ambientMap,this.diffuseMap=a.diffuseMap,this.specularMap=a.specularMap,this.emissiveMap=a.emissiveMap,this.opacityMap=a.opacityMap,this.reflectivityMap=a.reflectivityMap,this.normalMap=a.normalMap,this.diffuseFresnel=a.diffuseFresnel,this.specularFresnel=a.specularFresnel,this.emissiveFresnel=a.emissiveFresnel,this.opacityFresnel=a.opacityFresnel,this.reflectivityFresnel=a.reflectivityFresnel},_props:{ambient:{set:function(a){this._state.ambient.set(a||[1,1,1]),this._renderer.imageDirty=!0,this.fire("ambient",this._state.ambient)},get:function(){return this._state.ambient}},diffuse:{set:function(a){this._state.diffuse.set(a||[1,1,1]),this._renderer.imageDirty=!0,this.fire("diffuse",this._state.diffuse)},get:function(){return this._state.diffuse}},specular:{set:function(a){this._state.specular.set(a||[1,1,1]),this._renderer.imageDirty=!0,this.fire("specular",this._state.specular)},get:function(){return this._state.specular}},emissive:{set:function(a){this._state.emissive.set(a||[0,0,0]),this._renderer.imageDirty=!0,this.fire("emissive",this._state.emissive)},get:function(){return this._state.emissive}},opacity:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.opacity!==a&&(this._state.opacity=a,this._renderer.imageDirty=!0,this.fire("opacity",this._state.opacity))},get:function(){return this._state.opacity}},shininess:{set:function(a){this._state.shininess=void 0!==a?a:80,this._renderer.imageDirty=!0,this.fire("shininess",this._state.shininess)},get:function(){return this._state.shininess}},lineWidth:{set:function(a){this._state.lineWidth=a||1,this._renderer.imageDirty=!0,this.fire("lineWidth",this._state.lineWidth)},get:function(){return this._state.lineWidth}},pointSize:{set:function(a){this._state.pointSize=a||1,this._renderer.imageDirty=!0,this.fire("pointSize",this._state.pointSize)},get:function(){return this._state.pointSize}},reflectivity:{set:function(a){this._state.reflectivity=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("reflectivity",this._state.reflectivity)},get:function(){return this._state.reflectivity}},normalMap:{set:function(a){this._attachComponent("xeogl.Texture","normalMap",a)},get:function(){return this._attached.normalMap}},ambientMap:{set:function(a){this._attachComponent("xeogl.Texture","ambientMap",a)},get:function(){return this._attached.ambientMap}},diffuseMap:{set:function(a){this._attachComponent("xeogl.Texture","diffuseMap",a)},get:function(){return this._attached.diffuseMap}},specularMap:{set:function(a){this._attachComponent("xeogl.Texture","specularMap",a)},get:function(){return this._attached.specularMap}},emissiveMap:{set:function(a){this._attachComponent("xeogl.Texture","emissiveMap",a)},get:function(){return this._attached.emissiveMap}},opacityMap:{set:function(a){this._attachComponent("xeogl.Texture","opacityMap",a)},get:function(){return this._attached.opacityMap}},reflectivityMap:{set:function(a){this._attachComponent("xeogl.Texture","reflectivityMap",a)},get:function(){return this._attached.reflectivityMap}},reflection:{set:function(a){this._attachComponent("xeogl.Reflect","reflection",a)},get:function(){return this._attached.reflection}},diffuseFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","diffuseFresnel",a)},get:function(){return this._attached.diffuseFresnel}},specularFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","specularFresnel",a)},get:function(){return this._attached.specularFresnel}},emissiveFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","emissiveFresnel",a)},get:function(){return this._attached.emissiveFresnel}},opacityFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","opacityFresnel",a)},get:function(){return this._attached.opacityFresnel}},reflectivityFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","reflectivityFresnel",a)},get:function(){return this._attached.reflectivityFresnel}}},_attachComponent:function(a,b,c){c=this._attach({name:b,type:a,component:c,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[b]=null,this._hashDirty=!0},scope:this}}}),this._state[b]=c?c._state:null,this._hashDirty=!0},_compile:function(){this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._renderer.material=this._state},_makeHash:function(){var a=this._state,b=["/p"];a.normalMap&&(b.push("/b"),a.normalMap.matrix&&b.push("/mat")),a.ambientMap&&(b.push("/a"),a.ambientMap.matrix&&b.push("/mat")),a.diffuseMap&&(b.push("/d"),a.diffuseMap.matrix&&b.push("/mat")),a.specularMap&&(b.push("/s"),a.specularMap.matrix&&b.push("/mat")),a.emissiveMap&&(b.push("/e"),a.emissiveMap.matrix&&b.push("/mat")),a.opacityMap&&(b.push("/o"),a.opacityMap.matrix&&b.push("/mat")),a.reflectivityMap&&(b.push("/r"),a.reflectivityMap.matrix&&b.push("/mat")),a.diffuseFresnel&&b.push("/df"),a.specularFresnel&&b.push("/sf"),a.emissiveFresnel&&b.push("/ef"),a.opacityFresnel&&b.push("/of"),a.reflectivityFresnel&&b.push("/rf"),b.push(";"),a.hash=b.join("")},_getJSON:function(){var a={ambient:this._state.ambient,diffuse:this._state.diffuse,specular:this._state.specular,emissive:this._state.emissive};1!==this._state.opacity&&(a.opacity=this._state.opacity),80!==this._state.shininess&&(a.shininess=this._state.shininess),1!==this._state.reflectivity&&(a.reflectivity=this._state.reflectivity),1!==this._state.lineWidth&&(a.lineWidth=this._state.lineWidth),1!==this._state.pointSize&&(a.pointSize=this._state.pointSize);var b=this._attached;return b.normalMap&&(a.normalMap=b.normalMap.id),b.ambientMap&&(a.ambientMap=b.ambientMap.id),b.diffuseMap&&(a.diffuseMap=b.diffuseMap.id),b.specularMap&&(a.specularMap=b.specularMap.id),b.emissiveMap&&(a.emissiveMap=b.emissiveMap.id),b.opacityMap&&(a.opacityMap=b.opacityMap.id),b.reflectivityMap&&(a.reflectivityMap=b.reflectivityMap.id),b.diffuseFresnel&&(a.diffuseFresnel=b.diffuseFresnel.id),b.specularFresnel&&(a.specularFresnel=b.specularFresnel.id),b.emissiveFresnel&&(a.emissiveFresnel=b.emissiveFresnel.id),b.opacityFresnel&&(a.opacityFresnel=b.opacityFresnel.id),b.reflectivityFresnel&&(a.reflectivityFresnel=b.reflectivityFresnel.id),a},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Texture=xeogl.Component.extend({type:"xeogl.Texture",_init:function(a){this._state=new xeogl.renderer.Texture({texture:null,matrix:null,minFilter:null,magFilter:null,wrapS:null,wrapT:null,flipY:null,pageTableTexture:null}),this._src=null,this._image=null,this._target=null,this._pageTable=null,this._translate=xeogl.math.vec2([0,0]),this._scale=xeogl.math.vec2([1,1]),this._rotate=xeogl.math.vec2([0,0]),this._matrixDirty=!1,this._srcDirty=!1,this._imageDirty=!1,this._targetDirty=!1,this._propsDirty=!1,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._webglContextRestored,this),this.translate=a.translate,this.scale=a.scale,this.rotate=a.rotate,this.minFilter=a.minFilter,this.magFilter=a.magFilter,this.wrapS=a.wrapS,this.wrapT=a.wrapT,this.flipY=a.flipY,a.src?this.src=a.src:a.image?this.image=a.image:a.target&&(this.target=a.target),xeogl.stats.memory.textures++},_webglContextRestored:function(){this._state.texture=null,this._matrixDirty=!0,this._propsDirty=!0,this._image?this._imageDirty=!0:this._src?this._srcDirty=!0:this._target&&(this._targetDirty=!0),this._scheduleUpdate()},_update:function(){var a=this.scene.canvas.gl,b=this._state;if(this._srcDirty&&this._src)return this._loadSrc(this._src),void(this._srcDirty=!1);if(this._imageDirty&&this._image&&(this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),b.texture&&b.texture.renderBuffer&&(b.texture=null),b.texture||(b.texture=new xeogl.renderer.webgl.Texture2D(a)),b.texture.setImage(this._image,b),this._imageDirty=!1,this._propsDirty=!0),this._targetDirty&&(b.texture&&!b.texture.renderBuffer&&(b.texture.destroy(),b.texture=null),this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),this._target&&(this._onTargetActive=this._target.on("active",function(a){b.texture=a?this._state.renderBuf.getTexture():null})),this._targetDirty=!1,this._propsDirty=!0),this._matrixDirty){var c,d;0===this._translate[0]&&0===this._translate[2]||(c=xeogl.math.translationMat4v([this._translate[0],this._translate[1],0])),1===this._scale[0]&&1===this._scale[1]||(d=xeogl.math.scalingMat4v([this._scale[0],this._scale[1],1]),c=c?xeogl.math.mulMat4(c,d):d),0!==this._rotate&&(d=xeogl.math.rotationMat4v(.0174532925*this._rotate,[0,0,1]),c=c?xeogl.math.mulMat4(c,d):d);var e=b.matrix;b.matrix=c,this._matrixDirty=!1,!!c!=!!e&&this.fire("dirty")}this._propsDirty&&(b.texture&&b.texture.setProps&&b.texture.setProps(b),this._propsDirty=!1),this._pageTableDirty&&this._image&&(this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),b.texture&&b.texture.renderBuffer&&(b.texture=null),b.texture||(b.texture=new xeogl.renderer.webgl.Texture2D(a)),b.texture.setImage(this._image,b),this._imageDirty=!1,this._propsDirty=!0),this._renderer.imageDirty=!0},_loadSrc:function(a){var b=this,c=new Image,d=this.scene.canvas.spinner,e=d.textures;c.onload=function(){b._src===a&&(b._image=xeogl.renderer.webgl.ensureImageSizePowerOfTwo(c),b._imageDirty=!0,b._srcDirty=!1,b._targetDirty=!1,e&&d.processes--,b._scheduleUpdate(),b.fire("image",b._image),b.fire("loaded",b._src))},c.onerror=function(){e&&d.processes--},0===a.indexOf("data")?c.src=a:(c.crossOrigin="Anonymous",c.src=a,e&&d.processes++)},_props:{image:{set:function(a){this._image=xeogl.renderer.webgl.ensureImageSizePowerOfTwo(a),this._src=null,this._imageDirty=!0,this._srcDirty=!1,this._targetDirty=!1,this._scheduleUpdate(),this.fire("image",this._image)},get:function(){return this._state.image}},src:{set:function(a){this._image=null,this._src=a,this._imageDirty=!1,this._srcDirty=!0,this._targetDirty=!1,this._scheduleUpdate(),this.fire("src",this._src)},get:function(){return this._src}},target:{set:function(a){this._image=null,this._src=null,this._target=this._attach({name:"renderBuf",type:null,component:a,sceneDefault:!0,on:{active:{callback:this._onTargetActive,scope:this}}}),this._imageDirty=!1,this._srcDirty=!1,this._targetDirty=!0,this._scheduleUpdate(),this.fire("target",this._target)},get:function(){return this._attached.target}},pageTable:{set:function(a){this._pageTable=a,this._imageDirty=!0,this.fire("pageTable",this._pageTable)},get:function(){return this._state._pageTable}},translate:{set:function(a){this._translate.set(a||[0,0]),this._matrixDirty=!0,this._scheduleUpdate(),this.fire("translate",this._translate)},get:function(){return this._translate}},scale:{set:function(a){this._scale.set(a||[1,1]),this._matrixDirty=!0,this._scheduleUpdate(),this.fire("scale",this._scale)},get:function(){return this._scale}},rotate:{set:function(a){a=a||0,this._rotate!==a&&(this._rotate=a,this._matrixDirty=!0,this._scheduleUpdate(),this.fire("rotate",this._rotate))},get:function(){return this._rotate}},minFilter:{set:function(a){a=a||"linearMipmapLinear","linear"!==a&&"linearMipmapNearest"!==a&&"linearMipmapLinear"!==a&&"nearestMipmapLinear"!==a&&"linearMipmapLinear"!==a&&(this.error("Unsupported value for 'minFilter': '"+a+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),a="linearMipmapLinear"),this._state.minFilter=a,this._propsDirty=!0,this._scheduleUpdate(),this.fire("minFilter",this._state.minFilter)},get:function(){return this._state.minFilter}},magFilter:{set:function(a){a=a||"linear","linear"!==a&&"nearest"!==a&&(this.error("Unsupported value for 'magFilter': '"+a+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),a="linear"),this._state.magFilter=a,this._propsDirty=!0,this._scheduleUpdate(),this.fire("magFilter",this._state.magFilter)},get:function(){return this._state.magFilter}},wrapS:{set:function(a){a=a||"repeat","clampToEdge"!==a&&"mirroredRepeat"!==a&&"repeat"!==a&&(this.error("Unsupported value for 'wrapS': '"+a+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),a="repeat"),this._state.wrapS=a,this._propsDirty=!0,this._scheduleUpdate(),this.fire("wrapS",this._state.wrapS)},get:function(){return this._state.wrapS}},wrapT:{set:function(a){a=a||"repeat","clampToEdge"!==a&&"mirroredRepeat"!==a&&"repeat"!==a&&(this.error("Unsupported value for 'wrapT': '"+a+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),a="repeat"),this._state.wrapT=a,this._propsDirty=!0,this._scheduleUpdate(),this.fire("wrapT",this._state.wrapT)},get:function(){return this._state.wrapT}},flipY:{set:function(a){a=!!a,this._state.flipY!==a&&(this._state.flipY=a,this._imageDirty=!0,this._scheduleUpdate(),this.fire("flipY",this._state.flipY))},get:function(){return this._state.flipY}}},_getJSON:function(){var a={};return!this._translate||0===this._translate[0]&&0===this._translate[1]||(a.translate=this._translate),!this._scale||1===this._scale[0]&&1===this._scale[1]||(a.scale=this._scale),0!==this._rotate&&(a.rotate=this._rotate),"linearMipmapLinear"!==this._state.minFilter&&(a.minFilter=this._state.minFilter),"linear"!==this._state.magFilter&&(a.magFilter=this._state.magFilter),"repeat"!==this._state.wrapS&&(a.wrapS=this._state.wrapS),"repeat"!==this._state.wrapT&&(a.wrapT=this._state.wrapT),this._state.flipY!==!1&&(a.flipY=this._state.flipY),this._src?a.src=this._src:this._target?a.target=this._target.id:this._image,a},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.Fresnel=xeogl.Component.extend({type:"xeogl.Fresnel",_init:function(a){this._state=new xeogl.renderer.Fresnel({edgeColor:xeogl.math.vec3([0,0,0]),centerColor:xeogl.math.vec3([1,1,1]),edgeBias:0,centerBias:1,power:1}),this.edgeColor=a.edgeColor,this.centerColor=a.centerColor,this.edgeBias=a.edgeBias,this.centerBias=a.centerBias,this.power=a.power},_props:{edgeColor:{set:function(a){this._state.edgeColor.set(a||[0,0,0]),this._renderer.imageDirty=!0,this.fire("edgeColor",this._state.edgeColor)},get:function(){return this._state.edgeColor}},centerColor:{set:function(a){this._state.centerColor.set(a||[1,1,1]),this._renderer.imageDirty=!0,this.fire("centerColor",this._state.centerColor)},get:function(){return this._state.centerColor}},edgeBias:{set:function(a){this._state.edgeBias=a||0,this._renderer.imageDirty=!0,this.fire("edgeBias",this._state.edgeBias)},get:function(){return this._state.edgeBias}},centerBias:{set:function(a){this._state.centerBias=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this.fire("centerBias",this._state.centerBias)},get:function(){return this._state.centerBias}},power:{set:function(a){this._state.power=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this.fire("power",this._state.power)},get:function(){return this._state.power}}},_getJSON:function(){return{edgeColor:this._state.edgeColor,centerColor:this._state.centerColor,edgeBias:this._state.edgeBias,centerBias:this._state.centerBias,power:this._state.power}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Reflect=xeogl.Component.extend({type:"xeogl.Reflect",_init:function(a){this._state=new xeogl.renderer.Reflect({texture:null}),this._src=[],this._images=[],this._srcDirty=!1,this._imageDirty=!1,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._webglContextRestored,this),this.src=a.src,xeogl.stats.memory.textures++},_webglContextRestored:function(){this._state.reflect=null,this._images?this._imageDirty=!0:this._src&&(this._srcDirty=!0),this._scheduleUpdate()},_update:function(){var a=this._state;return this._srcDirty&&this._src?(this._loadSrc(this._src),void(this._srcDirty=!1)):(this._imageDirty&&this._images&&(a.reflect.setImage(this._image),this._imageDirty=!1,this._propsDirty=!0),void(this._renderer.imageDirty=!0))},_loadSrc:function(a){var b=this,c=new Image;c.onload=function(){b._src===a&&(b._image=xeogl.renderer.webgl.ensureImageSizePowerOfTwo(c),b._imageDirty=!0,b._srcDirty=!1,b._targetDirty=!1,b._scheduleUpdate(),b.fire("image",b._image),b.fire("loaded",b._src))},c.onerror=function(){},0===a.indexOf("data")?c.src=a:(c.crossOrigin="Anonymous",c.src=a)},_props:{src:{set:function(a){this._image=null,this._src=a,this._imageDirty=!1,this._srcDirty=!0,this._targetDirty=!1,this._scheduleUpdate(),this.fire("src",this._src)},get:function(){return this._src}}},_getJSON:function(){return{src:this._src.slice(0)}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.Entity=xeogl.Component.extend({type:"xeogl.Entity",_init:function(a){this._loading=a.loading,this._loading===!0&&this.scene.canvas.spinner.processes++,this.camera=a.camera,this.clips=a.clips,this.colorTarget=a.colorTarget,this.colorBuf=a.colorBuf,this.depthTarget=a.depthTarget,this.depthBuf=a.depthBuf,this.visibility=a.visibility,this.cull=a.cull,this.modes=a.modes,this.geometry=a.geometry,this.layer=a.layer,this.lights=a.lights,this.material=a.material,this.morphTargets=a.morphTargets,this.reflect=a.reflect,this.shader=a.shader,this.shaderParams=a.shaderParams,this.stage=a.stage,this.transform=a.transform,this.billboard=a.billboard,this.stationary=a.stationary,this.viewport=a.viewport,this._worldBoundary=null,this._viewBoundary=null,this._canvasBoundary=null,this._worldBoundaryDirty=!0,this._viewBoundaryDirty=!0,this._canvasBoundaryDirty=!0},_props:{camera:{set:function(a){this._setViewBoundaryDirty(),this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0,on:{viewMatrix:{callback:this._setViewBoundaryDirty,scope:this},projMatrix:{callback:this._setCanvasBoundaryDirty,scope:this}}})},get:function(){return this._attached.camera}},clips:{set:function(a){this._attach({name:"clips",type:"xeogl.Clips",component:a,sceneDefault:!0})},get:function(){return this._attached.clips}},colorTarget:{set:function(a){this._attach({name:"colorTarget",type:"xeogl.ColorTarget",component:a,sceneDefault:!0})},get:function(){return this._attached.colorTarget}},colorBuf:{set:function(a){this._attach({name:"colorBuf",type:"xeogl.ColorBuf",component:a,sceneDefault:!0})},get:function(){return this._attached.colorBuf}},depthTarget:{set:function(a){this._attach({name:"depthTarget",type:"xeogl.DepthTarget",component:a,sceneDefault:!0})},get:function(){return this._attached.depthTarget}},depthBuf:{set:function(a){this._attach({name:"depthBuf",type:"xeogl.DepthBuf",component:a,sceneDefault:!0})},get:function(){return this._attached.depthBuf}},visibility:{set:function(a){this._attach({name:"visibility",type:"xeogl.Visibility",component:a,sceneDefault:!0})},get:function(){return this._attached.visibility}},cull:{set:function(a){this._attach({name:"cull",type:"xeogl.Cull",component:a,sceneDefault:!0})},get:function(){return this._attached.cull}},modes:{set:function(a){this._attach({name:"modes",type:"xeogl.Modes",component:a,sceneDefault:!0})},get:function(){return this._attached.modes}},geometry:{set:function(a){this._setWorldBoundaryDirty(),this._attach({name:"geometry",type:"xeogl.Geometry",component:a,sceneDefault:!0,on:{positions:{callback:this._setWorldBoundaryDirty,scope:this},destroyed:{callback:this._setWorldBoundaryDirty,scope:this}}})},get:function(){return this._attached.geometry}},layer:{set:function(a){this._attach({name:"layer",type:"xeogl.Layer",component:a,sceneDefault:!0})},get:function(){return this._attached.layer}},lights:{set:function(a){this._attach({name:"lights",type:"xeogl.Lights",component:a,sceneDefault:!0})},get:function(){return this._attached.lights}},material:{set:function(a){this._attach({name:"material",type:"xeogl.Material",component:a,sceneDefault:!0})},get:function(){return this._attached.material}},morphTargets:{set:function(a){this._attach({name:"morphTargets",type:"xeogl.MorphTargets",component:a,sceneDefault:!0})},get:function(){return this._attached.morphTargets}},reflect:{set:function(a){this._attach({name:"reflect",type:"xeogl.Reflect",component:a,sceneDefault:!0})},get:function(){return this._attached.reflect}},shader:{set:function(a){this._attach({name:"shader",type:"xeogl.Shader",component:a,sceneDefault:!0})},get:function(){return this._attached.shader}},shaderParams:{set:function(a){this._attach({name:"shaderParams",type:"xeogl.ShaderParams",component:a,sceneDefault:!0})},get:function(){return this._attached.shaderParams}},stage:{set:function(a){this._attach({name:"stage",type:"xeogl.Stage",component:a,sceneDefault:!0})},get:function(){return this._attached.stage}},transform:{set:function(a){this._setWorldBoundaryDirty(),this._attach({name:"transform",type:"xeogl.Transform",component:a,sceneDefault:!0,on:{updated:{callback:function(){this._transformDirty||(this._transformDirty=!0,xeogl.scheduleTask(this._transformUpdated,this))},scope:this},destroyed:{callback:this._setWorldBoundaryDirty,scope:this}}})},get:function(){return this._attached.transform}},billboard:{set:function(a){this._attach({name:"billboard",type:"xeogl.Billboard",component:a,sceneDefault:!0})},get:function(){return this._attached.billboard}},viewport:{set:function(a){this._attach({name:"viewport",type:"xeogl.Viewport",component:a,sceneDefault:!0})},get:function(){return this._attached.viewport}},stationary:{set:function(a){this._attach({name:"stationary",type:"xeogl.Stationary",component:a,sceneDefault:!0})},get:function(){return this._attached.stationary}},localBoundary:{get:function(){return this._attached.geometry.localBoundary}},worldBoundary:{get:function(){if(!this._worldBoundary){var a=this;this._worldBoundary=this.create({type:"xeogl.Boundary3D",getDirty:function(){return!!a._worldBoundaryDirty&&(a._worldBoundaryDirty=!1,!0)},getOBB:function(){var b=a._attached.geometry;if(b){var c=b.localBoundary;return c.obb}},getMatrix:function(){var b=a._attached.transform;return a._transformDirty&&(b._buildLeafMatrix(),a._setWorldBoundaryDirty(),a._transformDirty=!1),b.leafMatrix}}),this._worldBoundary.on("destroyed",function(){a._worldBoundary=null})}return this._worldBoundary}},viewBoundary:{get:function(){if(!this._viewBoundary){var a=this;this._viewBoundary=this.create({type:"xeogl.Boundary3D",getDirty:function(){return!!a._viewBoundaryDirty&&(a._viewBoundaryDirty=!1,!0)},getOBB:function(){return a.worldBoundary.obb},getMatrix:function(){return a._attached.camera.view.matrix}}),this._viewBoundary.on("destroyed",function(){a._viewBoundary=null})}return this._viewBoundary}},canvasBoundary:{get:function(){if(!this._canvasBoundary){var a=this;this._canvasBoundary=this.create({type:"xeogl.Boundary2D",getDirty:function(){return!!a._canvasBoundaryDirty&&(a._canvasBoundaryDirty=!1,!0)},getOBB:function(){return a.viewBoundary.obb},getMatrix:function(){return a._attached.camera.project.matrix}}),this._canvasBoundary.on("destroyed",function(){a._canvasBoundary=null})}return this._canvasBoundary}},glsl:{get:function(){var a=this._renderer.objects[this.id];if(!a)return null;var b=a.program.program.source;return{draw:{vertex:b.vertexDraw,fragment:b.fragmentDraw},pickObject:{vertex:b.vertexPickObject,fragment:b.fragmentPickObject},pickPrimitive:{vertex:b.vertexPickPrimitive,fragment:b.fragmentPickPrimitive}}}},glslString:{get:function(){var a=this.glsl;if(a)return JSON.stringify(a,"\n",4)}}},_transformUpdated:function(){this._transformDirty&&(this._attached.transform._buildLeafMatrix(),this._setWorldBoundaryDirty(),this._transformDirty=!1)},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0),this._setViewBoundaryDirty()},_setViewBoundaryDirty:function(){this._viewBoundaryDirty=!0,this._viewBoundary&&this._viewBoundary.fire("updated",!0),this._setCanvasBoundaryDirty()},_setCanvasBoundaryDirty:function(){this._canvasBoundaryDirty=!0,this._canvasBoundary&&this._canvasBoundary.fire("updated",!0)},_valid:function(){var a=this._attached.geometry;return!this.destroyed&&a&&a.positions&&a.indices},_compile:function(){var a=this;if(!this._compiling){a._compiling=!0;var b=this._renderer.objects[this.id];b&&(b.compiled=!1);var c=function(){return a._valid()?(a.__compile(),void(a._compiling=!1)):void xeogl.scheduleTask(c)};xeogl.scheduleTask(c)}},__compile:function(){var a=this._attached;a.camera._compile(),a.clips._compile(),a.colorTarget._compile(),a.colorBuf._compile(),a.depthTarget._compile(),a.depthBuf._compile(),a.visibility._compile(),a.cull._compile(),a.modes._compile(),a.geometry._compile(),a.layer._compile(),a.lights._compile(),a.material._compile(),a.reflect._compile(),a.shader._compile(),a.shaderParams._compile(),a.stage._compile(),this._renderer.modelTransform=a.transform._state,a.billboard._compile(),a.stationary._compile(),a.viewport._compile();var b=this.id,c=this._renderer.buildObject(b);this._loading&&(this.scene.canvas.spinner.processes--,this._loading=!1),c&&c.error&&this.error(c.errorLog.join("\n"))},_getJSON:function(){var a=this._attached;return{camera:a.camera.id,clips:a.clips.id,colorTarget:a.colorTarget.id,colorBuf:a.colorBuf.id,depthTarget:a.depthTarget.id,depthBuf:a.depthBuf.id,visibility:a.visibility.id,cull:a.cull.id,modes:a.modes.id,geometry:a.geometry.id,layer:a.layer.id,lights:a.lights.id,material:a.material.id,reflect:a.reflect.id,shader:a.shader.id,shaderParams:a.shaderParams.id,stage:a.stage.id,transform:a.transform.id,billboard:a.billboard.id,stationary:a.stationary.id,viewport:a.viewport.id}},_destroy:function(){this._renderer.removeObject(this.id)}})}(),function(){"use strict";xeogl.ColorBuf=xeogl.Component.extend({type:"xeogl.ColorBuf",_init:function(a){this._state=new xeogl.renderer.ColorBuf({blendEnabled:!1,colorMask:[!0,!0,!0,!0]}),this.blendEnabled=a.blendEnabled,this.colorMask=a.colorMask},_props:{blendEnabled:{set:function(a){this._state.blendEnabled=a===!0,this._renderer.imageDirty=!0,this.fire("blendEnabled",this._state.blendEnabled)},get:function(){return this._state.blendEnabled}},colorMask:{set:function(a){this._state.colorMask=a||[!0,!0,!0,!0],this._renderer.imageDirty=!0,this.fire("colorMask",this._state.colorMask)},get:function(){return this._state.colorMask}}},_compile:function(){this._renderer.colorBuf=this._state},_getJSON:function(){return{blendEnabled:this._state.blendEnabled,colorMask:this._state.colorMask}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.DepthBuf=xeogl.Component.extend({type:"xeogl.DepthBuf",_init:function(a){this._state=new xeogl.renderer.DepthBuf({clearDepth:null,depthFunc:null,active:!0}),this.clearDepth=a.clearDepth,this.depthFunc=a.depthFunc,this.active=a.active},_props:{clearDepth:{set:function(a){this._state.clearDepth=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("clearDepth",this._state.clearDepth)},get:function(){return this._state.clearDepth}},depthFunc:{set:function(a){a=a||"less";var b=this._depthFuncNames[a];void 0===b&&(this.error("Unsupported value for 'clearFunc': '"+a+"' - supported values are 'less', 'equal', 'lequal', 'greater', 'notequal' and 'gequal. Defaulting to 'less'."),b="less"),this._state.depthFunc=this.scene.canvas.gl[b],this._state.depthFuncName=a,this._renderer.imageDirty=!0,this.fire("depthFunc",this._state.depthFuncName)},get:function(){return this._state.depthFuncName}},active:{set:function(a){a=a!==!1,this._state.active!==a&&(this._state.active=a,this._renderer.imageDirty=!0,this.fire("active",this._state.active))},get:function(){return this._state.active}}},_depthFuncNames:{less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL"},_compile:function(){this._renderer.depthBuf=this._state},_getJSON:function(){return{clearDepth:this._state.clearDepth,depthFunc:this._state.depthFuncName,active:this._state.active}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Layer=xeogl.Component.extend({type:"xeogl.Layer",_init:function(a){this._state=new xeogl.renderer.Layer({priority:null}),this.priority=a.priority},_props:{priority:{set:function(a){a=a||0,a=Math.round(a),a!==this._state.priority&&(this._state.priority=a,this._renderer.stateOrderDirty=!0,this.fire("priority",this._state.priority))},get:function(){return this._state.priority}}},_compile:function(){this._renderer.layer=this._state},_getJSON:function(){return{priority:this._state.priority}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.ColorTarget=xeogl.Component.extend({type:"xeogl.ColorTarget",_init:function(a){this._state=new xeogl.renderer.RenderTarget({type:xeogl.renderer.RenderTarget.COLOR,renderBuf:null});var b=this.scene.canvas,c=this;this._webglContextRestored=b.on("webglContextRestored",function(){c._state.renderBuf&&c._state.renderBuf.webglRestored(b.gl);
}),this.size=a.size,this.active=a.active},_props:{size:{set:function(a){a=a||null,this._size=a,this._active&&this._state.renderBuf.setSize(this._size),this.fire("size",this._size)},get:function(){return this._size}},active:{set:function(a){if(a=a!==!1,this._active!==a){var b=this._state;if(this._active=a,this._active){var c=this.scene.canvas;b.renderBuf=new xeogl.renderer.webgl.RenderBuffer({canvas:c.canvas,gl:c.gl,size:this._size}),this._renderer.imageDirty=!0}else b.renderBuf&&(b.renderBuf.destroy(),b.renderBuf=null);this.fire("active",this._active)}},get:function(){return this._active}}},_compile:function(){this._renderer.colorTarget=this._state},_getJSON:function(){var a={active:this._active};return this._size&&(a.size=this._size),a},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.renderBuf&&this._state.renderBuf.destroy(),this._state.destroy()}})}(),function(){"use strict";xeogl.DepthTarget=xeogl.Component.extend({type:"xeogl.DepthTarget",_init:function(a){this._state=new xeogl.renderer.RenderTarget({type:xeogl.renderer.RenderTarget.DEPTH,renderBuf:null});var b=this.scene.canvas,c=this;this._webglContextRestored=b.on("webglContextRestored",function(){c._state.renderBuf&&c._state.renderBuf.webglRestored(b.gl)}),this.active=a.active},_props:{active:{set:function(a){if(a=a!==!1,this._active!==a){this._active=a;var b=this._state;if(this._active){var c=this.scene.canvas;b.renderBuf=new xeogl.renderer.webgl.RenderBuffer({canvas:c.canvas,gl:c.gl}),this._renderer.imageDirty=!0}else b.renderBuf&&(b.renderBuf.destroy(),b.renderBuf=null);this.fire("active",this._active)}},get:function(){return this._active}}},_compile:function(){this._renderer.depthTarget=this._state},_getJSON:function(){return{active:this._active}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.renderBuf&&this._state.renderBuf.destroy(),this._state.destroy()}})}(),function(){"use strict";xeogl.Modes=xeogl.Component.extend({type:"xeogl.Modes",_init:function(a){this._state=new xeogl.renderer.Modes({pickable:null,clippable:null,transparent:null,backfaces:null,frontface:null,collidable:null}),this.pickable=a.pickable,this.clippable=a.clippable,this.transparent=a.transparent,this.backfaces=a.backfaces,this.frontface=a.frontface,this.collidable=a.collidable},_props:{pickable:{set:function(a){a=a!==!1,this._state.pickable!==a&&(this._state.pickable=a,this.fire("pickable",this._state.pickable))},get:function(){return this._state.pickable}},clippable:{set:function(a){a=a!==!1,this._state.clippable!==a&&(this._state.clippable=a,this._renderer.imageDirty=!0,this.fire("clippable",this._state.clippable))},get:function(){return this._state.clippable}},transparent:{set:function(a){a=!!a,this._state.transparent!==a&&(this._state.transparent=a,this._renderer.stateOrderDirty=!0,this.fire("transparent",this._state.transparent))},get:function(){return this._state.transparent}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty=!0,this.fire("backfaces",this._state.backfaces))},get:function(){return this._state.backfaces}},frontface:{set:function(a){a="cw"!==a,this._state.frontface!==a&&(this._state.frontface=a,this._renderer.imageDirty=!0,this.fire("frontface",this._state.frontface?"ccw":"cw"))},get:function(){return this._state.frontface?"ccw":"cw"}},collidable:{set:function(a){a=a!==!1,a!==this._state.collidable&&(this._state.collidable=a,this.fire("collidable",this._state.collidable))},get:function(){return this._state.collidable}}},_compile:function(){this._renderer.modes=this._state},_getJSON:function(){return{pickable:this._state.pickable,clippable:this._state.clippable,transparent:this._state.transparent,backfaces:this._state.backfaces,frontface:this._state.frontface,collidable:this._state.collidable}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Viewport=xeogl.Component.extend({type:"xeogl.Viewport",_init:function(a){this._state=new xeogl.renderer.Viewport({boundary:[0,0,100,100]}),this.boundary=a.boundary,this.autoBoundary=a.autoBoundary},_props:{boundary:{set:function(a){if(!this._autoBoundary){if(!a){var b=this.scene.canvas.boundary,c=b[2],d=b[3];a=[0,0,c,d]}this._state.boundary=a,this._renderer.imageDirty=!0,this.fire("boundary",this._state.boundary)}},get:function(){return this._state.boundary}},autoBoundary:{set:function(a){a=!!a,a!==this._autoBoundary&&(this._autoBoundary=a,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",function(a){var b=a[2],c=a[3];this._state.boundary=[0,0,b,c],this.fire("boundary",this._state.boundary)},this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))},get:function(){return this._autoBoundary}}},_compile:function(){this._renderer.viewport=this._state},_getJSON:function(){var a={};return this._autoBoundary?a.autoBoundary=!0:a.boundary=this._state.boundary.slice(),a}})}(),function(){"use strict";xeogl.Stage=xeogl.Component.extend({type:"xeogl.Stage",_init:function(a){this._state=new xeogl.renderer.Stage({priority:null,pickable:!0}),this.priority=a.priority,this.pickable=a.pickable},_props:{priority:{set:function(a){a=a||0,a!==this._state.priority&&(a=Math.round(a),this._state.priority=a,this._renderer.stateOrderDirty=!0,this.fire("priority",this._state.priority))},get:function(){return this._state.priority}},pickable:{set:function(a){a=a!==!1,this._state.pickable!==a&&(this._state.pickable=a,this.fire("pickable",this._state.pickable))},get:function(){return this._state.pickable}}},_compile:function(){this._renderer.stage=this._state},_getJSON:function(){return{priority:this.priority,pickable:this.pickable}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Shader=xeogl.Component.extend({type:"xeogl.Shader",_init:function(a){this._state=new xeogl.renderer.Shader({vertex:null,fragment:null,params:{}}),this.vertex=a.vertex,this.fragment=a.fragment,this.setParams(a.params)},_props:{vertex:{set:function(a){this._state.vertex=a,this.fire("dirty",!0),this.fire("vertex",this._state.vertex)},get:function(){return this._state.vertex}},fragment:{set:function(a){this._state.fragment=a,this.fire("dirty",!0),this.fire("fragment",this._state.fragment)},get:function(){return this._state.fragment}},params:{get:function(){return this._state.params}}},setParams:function(a){for(var b in a)a.hasOwnProperty(b)&&(this._state.params[b]=a[b]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shader=this._state},_getJSON:function(){var a={params:this._state.params};return this._state.vertex&&(a.vertex=this._state.vertex),this._state.fragment&&(a.fragment=this._state.fragment),a}})}(),function(){"use strict";xeogl.ShaderParams=xeogl.Component.extend({type:"xeogl.ShaderParams",_init:function(a){this._state=new xeogl.renderer.ShaderParams({params:{}}),this.setParams(a.params)},_props:{params:{get:function(){return this._state.params}}},setParams:function(a){for(var b in a)a.hasOwnProperty(b)&&(this._state.params[b]=a[b]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shaderParams=this._state},_getJSON:function(){return{params:this._state.params}}})}(),function(){"use strict";xeogl.Boundary2D=xeogl.Component.extend({type:"xeogl.Boundary2D",_init:function(a){this._obb=null,this._aabb=a.aabb||null,this._center=a.center||null,this._getDirty=a.getDirty,this._getOBB=a.getOBB,this._getMatrix=a.getMatrix},_props:{aabb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._aabb}},center:{get:function(){return this._getDirty()&&this._buildBoundary(),this._center}}},_buildBoundary:function(){var a=xeogl.math,b=this.scene.canvas.canvas,c=b.width,d=b.height;this._obb||(this._obb=a.OBB2(),this._aabb=a.AABB2(),this._center=a.vec2());var e=this._getOBB(),f=this._getMatrix();e&&f&&(a.transformOBB3(f,e,this._obb),a.OBB3ToAABB2(this._obb,this._aabb),a.AABB2ToCanvas(this._aabb,c,d),a.getAABB2Center(this._aabb,this._center))},_getJSON:function(){return{aabb:this.aabb,center:this.center}}})}(),function(){"use strict";xeogl.Boundary3D=xeogl.Component.extend({type:"xeogl.Boundary3D",_init:function(a){this._obb=a.obb||null,this._aabb=a.aabb||null,this._sphere=a.sphere||null,this._center=a.center||null,this._getDirty=a.getDirty,this._getOBB=a.getOBB,this._getAABB=a.getAABB,this._getMatrix=a.getMatrix,this._getPositions=a.getPositions},_props:{obb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._obb}},aabb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._aabb}},center:{get:function(){return this._getDirty()&&this._buildBoundary(),this._center}},sphere:{get:function(){return this._getDirty()&&this._buildBoundary(),this._sphere}}},_buildBoundary:function(){var a=xeogl.math;this._obb||(this._obb=xeogl.math.OBB3()),this._aabb||(this._aabb=xeogl.math.AABB3()),this._sphere||(this._sphere=xeogl.math.vec4()),this._center||(this._center=xeogl.math.vec3());var b=this._getAABB?this._getAABB():null;if(b)return this._aabb[0]=b[0],this._aabb[1]=b[1],this._aabb[2]=b[2],this._aabb[3]=b[3],this._aabb[4]=b[4],this._aabb[5]=b[5],a.AABB3ToOBB3(this._aabb,this._obb),a.OBB3ToSphere3(this._obb,this._sphere),void a.getSphere3Center(this._sphere,this._center);var c,d=this._getPositions?this._getPositions():null;if(d)return(c=this._getMatrix?this._getMatrix():null)?(a.positions3ToAABB3(d,this._aabb),a.AABB3ToOBB3(this._aabb,this._obb),a.transformOBB3(c,this._obb),a.OBB3ToAABB3(this._obb,this._aabb),a.OBB3ToSphere3(this._obb,this._sphere),void a.getSphere3Center(this._sphere,this._center)):(a.positions3ToAABB3(d,this._aabb),a.AABB3ToOBB3(this._aabb,this._obb),a.OBB3ToSphere3(this._obb,this._sphere),void a.getSphere3Center(this._sphere,this._center));var e=this._getOBB?this._getOBB():null;if(e){if(c=this._getMatrix?this._getMatrix():null)return a.transformOBB3(c,e,this._obb),a.OBB3ToAABB3(this._obb,this._aabb),a.OBB3ToSphere3(this._obb,this._sphere),void a.getSphere3Center(this._sphere,this._center);for(var f=0,g=e.length;f<g;f++)this._obb[f]=e[f];a.OBB3ToAABB3(this._obb,this._aabb),a.OBB3ToSphere3(this._obb,this._sphere),a.getSphere3Center(this._sphere,this._center)}},_getJSON:function(){return{obb:this.obb,aabb:this.aabb,center:this.center,sphere:this.sphere}}})}(),function(){"use strict";xeogl.Transform=xeogl.Component.extend({type:"xeogl.Transform",_init:function(a){this._onParentUpdated=null,this._onParentDestroyed=null,this._matrix=xeogl.math.identityMat4(xeogl.math.mat4()),this._leafMatrix=xeogl.math.mat4(),this._leafNormalMatrix=xeogl.math.mat4(),this._leafMatrixDirty=!0,this._leafNormalMatrixDirty=!0;var b=this;this._state=new xeogl.renderer.Transform({getMatrix:function(){return b._leafMatrixDirty&&b._buildLeafMatrix(),b._leafMatrix},getNormalMatrix:function(){return b._leafNormalMatrixDirty&&b._buildLeafNormalMatrix(),b._leafNormalMatrix}}),this.parent=a.parent,this.matrix=a.matrix,this.postMultiply=a.postMultiply},_parentUpdated:function(){this._leafMatrixDirty=!0,this.fire("updated",!0)},_buildLeafMatrix:function(){if(this._leafMatrixDirty){if(this._build&&this._buildScheduled&&(this._build(),this._buildScheduled=!1),this._parent)this._postMultiply?xeogl.math.mulMat4(this._parent.leafMatrix,this._matrix,this._leafMatrix):xeogl.math.mulMat4(this._matrix,this._parent.leafMatrix,this._leafMatrix);else for(var a=0,b=this._matrix.length;a<b;a++)this._leafMatrix[a]=this._matrix[a];this._renderer.imageDirty=!0,this._leafMatrixDirty=!1,this._leafNormalMatrixDirty=!0}},_buildLeafNormalMatrix:function(){this._leafMatrixDirty&&this._buildLeafMatrix(),xeogl.math.inverseMat4(this._leafMatrix,this._leafNormalMatrix),xeogl.math.transposeMat4(this._leafNormalMatrix),this._renderer.imageDirty=!0,this._leafNormalMatrixDirty=!1},_props:{parent:{set:function(a){if(a)for(var b=this.id,c=a;c;c=c._parent)if(b===c.id)return void this.error("Not allowed to attach Transform as parent of itself - ignoring");!this._parent||a&&a.id===this._parent.id||(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed)),this._parent=a,this.fire("parent",this._parent),this._parent&&(this._onParentUpdated=this._parent.on("updated",this._parentUpdated,this),this._onParentDestroyed=this._parent.on("destroyed",this._parentUpdated,this)),this._parentUpdated()},get:function(){return this._parent}},postMultiply:{set:function(a){a=a!==!1,this._postMultiply!==a&&(this._postMultiply=a,this._leafMatrixDirty=!0,this._renderer.imageDirty=!0,this.fire("updated",!0),this.fire("postMultiply",this._postMultiply))},get:function(){return this._postMultiply}},matrix:{set:function(a){this._matrix.set(a||xeogl.math.identityMat4()),this._leafMatrixDirty=!0,this._renderer.imageDirty=!0,this.fire("matrix",this._matrix),this.fire("updated",!0)},get:function(){return this._updateScheduled&&this._doUpdate(),this._matrix}},leafMatrix:{get:function(){return this._leafMatrixDirty&&this._buildLeafMatrix(),this._leafMatrix}}},_getJSON:function(){var a={matrix:Array.prototype.slice.call(this._matrix),postMultiply:this._postMultiply};return this._parent&&(a.parent=this._parent.id),a},_destroy:function(){this._parent&&(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed))}})}(),function(){"use strict";xeogl.Rotate=xeogl.Transform.extend({type:"xeogl.Rotate",_init:function(a){this._super(a),this.xyz=a.xyz,this.angle=a.angle},_update:function(){this.matrix=xeogl.math.rotationMat4v(this._angle*xeogl.math.DEGTORAD,this._xyz,this._matrix)},_props:{xyz:{set:function(a){(this._xyz=this._xyz||new xeogl.math.vec3).set(a||[0,1,0]),this._scheduleUpdate(),this.fire("xyz",this._xyz)},get:function(){return this._xyz}},angle:{set:function(a){this._angle=a||0,this._scheduleUpdate(),this.fire("angle",this._angle)},get:function(){return this._angle}}},_getJSON:function(){var a={xyz:this._xyz,angle:this._angle};return this._parent&&(a.parent=this._parent.id),a}})}(),function(){"use strict";xeogl.Quaternion=xeogl.Transform.extend({type:"xeogl.Quaternion",_init:function(a){this._super(a),this.xyzw=a.xyzw},_props:{xyzw:{set:function(a){var b=xeogl.math;(this._xyzw=this._xyzw||new b.vec4).set(a||b.identityQuaternion()),this.matrix=b.quaternionToMat4(this._xyzw,this._matrix||(this._matrix=xeogl.math.identityMat4())),this.fire("xyzw",this._xyzw)},get:function(){return this._xyzw}}},rotate:function(){var a=xeogl.math,b=a.vec4(),c=a.vec4();return function(d){b[0]=d[0],b[1]=d[1],b[2]=d[2],b[3]=d[3]*a.DEGTORAD,a.angleAxisToQuaternion(b,c),this.xyzw=a.mulQuaternions(this._xyzw,c,this._xyzw)}}(),_getJSON:function(){var a={xyzw:this._xyzw};return this._parent&&(a.parent=this._parent.id),a}})}(),function(){"use strict";xeogl.Scale=xeogl.Transform.extend({type:"xeogl.Scale",_init:function(a){this._super(a),this.xyz=a.xyz},_update:function(){this.matrix=xeogl.math.scalingMat4v(this._xyz,this._matrix)},_props:{xyz:{set:function(a){(this._xyz=this._xyz||new xeogl.math.vec3).set(a||[1,1,1]),this._scheduleUpdate(),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){var a={xyz:this._xyz};return this._parent&&(a.parent=this._parent.id),a}})}(),function(){"use strict";xeogl.Translate=xeogl.Transform.extend({type:"xeogl.Translate",_init:function(a){this._super(a),this.xyz=a.xyz},_update:function(){this.matrix=xeogl.math.translationMat4v(this._xyz,this._matrix)},_props:{xyz:{set:function(a){(this._xyz=this._xyz||new xeogl.math.vec3).set(a||[0,0,0]),this._scheduleUpdate(),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){var a={xyz:this._xyz};return this._parent&&(a.parent=this._parent.id),a}})}(),function(){"use strict";xeogl.Billboard=xeogl.Component.extend({type:"xeogl.Billboard",_init:function(a){this._super(a),this._state=new xeogl.renderer.Billboard({active:!0,spherical:!0,hash:"a;s;"}),this.active=a.active!==!1,this.spherical=a.spherical!==!1},_props:{active:{set:function(a){a=!!a,this._state.active!==a&&(this._state.active=a,this._state.hash=(this._state.active?"a;":";")+(this._state.spherical?"s;":";"),this.fire("dirty",!0),this.fire("active",this._state.active))},get:function(){return this._state.active}},spherical:{set:function(a){a=!!a,this._state.spherical!==a&&(this._state.spherical=a,this._state.hash=(this._state.active?"a;":";")+(this._state.spherical?"s;":";"),this.fire("dirty",!0),this.fire("spherical",this._state.spherical))},get:function(){return this._state.spherical}}},_compile:function(){this._renderer.billboard=this._state},_getJSON:function(){return{active:this._state.active}}})}(),function(){"use strict";xeogl.Stationary=xeogl.Component.extend({type:"xeogl.Stationary",_init:function(a){this._super(a),this._state=new xeogl.renderer.Stationary({active:!0}),this.active=a.active!==!1},_props:{active:{set:function(a){a=!!a,this._state.active!==a&&(this._state.active=a,this._state.hash=this._state.active?"a;":";",this.fire("dirty",!0),this.fire("active",this._state.active))},get:function(){return this._state.active}}},_compile:function(){this._renderer.stationary=this._state},_getJSON:function(){return{active:this._state.active}}})}(),function(){"use strict";xeogl.Frustum=xeogl.Transform.extend({type:"xeogl.Frustum",_init:function(a){this._super(a),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._near=.1,this._far=1e4,this.left=a.left,this.right=a.right,this.bottom=a.bottom,this.top=a.top,this.near=a.near,this.far=a.far},_update:function(){this.matrix=xeogl.math.frustumMat4(this._left,this._right,this._bottom,this._top,this._near,this._far,this._matrix)},_props:{left:{set:function(a){this._left=void 0!==a&&null!==a?a:-1,this._scheduleUpdate(0),this.fire("left",this._left)},get:function(){return this._left}},right:{set:function(a){this._right=void 0!==a&&null!==a?a:1,this._scheduleUpdate(0),this.fire("right",this._right)},get:function(){return this._right}},top:{set:function(a){this._top=void 0!==a&&null!==a?a:1,this._scheduleUpdate(0),this.fire("top",this._top)},get:function(){return this._top}},bottom:{set:function(a){this._bottom=void 0!==a&&null!==a?a:-1,this._scheduleUpdate(0),this.fire("bottom",this._bottom)},get:function(){return this._bottom}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._scheduleUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._scheduleUpdate(0),this.fire("far",this._far)},get:function(){return this._far}}},_getJSON:function(){var a={left:this._left,right:this._right,top:this._top,bottom:this._bottom,near:this._near,far:this._far};return this._parent&&(a.parent=this._parent.id),a}})}(),function(){"use strict";var a=xeogl.math,b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3(),g=a.vec3();xeogl.Lookat=xeogl.Transform.extend({type:"xeogl.Lookat",_init:function(b){this._super(b),this._eye=a.vec3([0,0,10]),this._look=a.vec3([0,0,0]),this._up=a.vec3([0,1,0]),this.eye=b.eye,this.look=b.look,this.up=b.up,this.gimbalLockY=b.gimbalLockY},_update:function(){var b=a.mat4();return function(){a.lookAtMat4v(this._eye,this._look,this._up,b),this.matrix=b}}(),rotateEyeY:function(f){var g=a.subVec3(this._eye,this._look,b),h=a.rotationMat4v(.0174532925*f,this._gimbalLockY?a.vec3([0,1,0]):this._up);g=a.transformPoint3(h,g,c),this.eye=a.addVec3(g,this._look,d),this._gimbalLockY&&(this.up=a.transformPoint3(h,this._up,e))},rotateEyeX:function(h){var i=a.subVec3(this._eye,this._look,b),j=a.cross3Vec3(a.normalizeVec3(i,c),a.normalizeVec3(this._up,d)),k=a.rotationMat4v(.0174532925*h,j);i=a.transformPoint3(k,i,e),this.eye=a.addVec3(i,this._look,f),this.up=a.transformPoint3(k,this._up,g)},rotateLookY:function(e){var f=a.subVec3(this._look,this._eye,b),g=a.rotationMat4v(.0174532925*e,this._up);f=a.transformPoint3(g,f,c),this.look=a.addVec3(f,this._eye,d)},rotateLookX:function(g){var h=a.subVec3(this._look,this._eye,b),i=a.cross3Vec3(a.normalizeVec3(h,c),a.normalizeVec3(this._up,d)),j=a.rotationMat4v(.0174532925*g,i);h=a.transformPoint3(j,h,e),this.look=a.addVec3(h,this._eye,f),this.up=a.transformPoint3(j,this._up,tempVecf)},pan:function(h){var i,j=a.subVec3(this._eye,this._look,b),k=[0,0,0];if(0!==h[0]){var l=a.cross3Vec3(a.normalizeVec3(j,[]),a.normalizeVec3(this._up,c));i=a.mulVec3Scalar(l,h[0]),k[0]+=i[0],k[1]+=i[1],k[2]+=i[2]}0!==h[1]&&(i=a.mulVec3Scalar(a.normalizeVec3(this._up,d),h[1]),k[0]+=i[0],k[1]+=i[1],k[2]+=i[2]),0!==h[2]&&(i=a.mulVec3Scalar(a.normalizeVec3(j,e),h[2]),k[0]+=i[0],k[1]+=i[1],k[2]+=i[2]),this.eye=a.addVec3(this._eye,k,f),this.look=a.addVec3(this._look,k,g)},zoom:function(f){var g=a.subVec3(this._eye,this._look,b),h=Math.abs(a.lenVec3(g,c)),i=Math.abs(h+f),j=a.normalizeVec3(g,d);this.eye=a.addVec3(this._look,a.mulVec3Scalar(j,i),e)},_props:{gimbalLockY:{set:function(a){a=a!==!1,this._gimbalLockY=a,this.fire("gimbalLockY",this._gimbalLockY)},get:function(){return this._gimbalLockY}},eye:{set:function(a){this._eye.set(a||[0,0,10]),this._scheduleUpdate(0),this.fire("eye",this._eye)},get:function(){return this._eye}},look:{set:function(a){this._look.set(a||[0,0,0]),this._scheduleUpdate(0),this.fire("look",this._look)},get:function(){return this._look}},up:{set:function(a){this._up.set(a||[0,1,0]),this._scheduleUpdate(0),this.fire("up",this._up)},get:function(){return this._up}}},_getJSON:function(){var a={eye:this._eye.slice(),look:this._look.slice(),up:this._up.slice(),gimbalLockY:this._gimbalLockY};return this._parent&&(a.parent=this._parent.id),a}})}(),function(){"use strict";xeogl.Ortho=xeogl.Transform.extend({type:"xeogl.Ortho",_init:function(a){this._super(a),this.scale=a.scale,this.near=a.near,this.far=a.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._scheduleUpdate,this)},_update:function(){var a,b,c,d,e=this.scene,f=this._scale,g=e.canvas.canvas,h=g.clientWidth,i=g.clientHeight,j=.5*f,k=h/i;h>i?(a=-j,b=j,c=j/k,d=-j/k):(a=-j*k,b=j*k,c=j,d=-j),this.matrix=xeogl.math.orthoMat4c(a,b,d,c,this._near,this._far,this.__tempMat||(this.__tempMat=xeogl.math.mat4()))},_props:{scale:{set:function(a){this._scale=void 0!==a&&null!==a?a:1,this._scheduleUpdate(0),this.fire("scale",this._scale)},get:function(){return this._scale}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._scheduleUpdate(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._scheduleUpdate(),this.fire("far",this._far)},get:function(){return this._far}}},_getJSON:function(){var a={scale:this._scale,near:this._near,far:this._far};return this._parent&&(a.parent=this._parent.id),a},_destroy:function(){this._super(),this.scene.canvas.off(this._onCanvasBoundary)}})}(),function(){"use strict";xeogl.Perspective=xeogl.Transform.extend({type:"xeogl.Perspective",_init:function(a){this._super(a),this._dirty=!1,this._fovy=60,this._near=.1,this._far=1e4,this._canvasResized=this.scene.canvas.on("boundary",this._scheduleUpdate,this),this.fovy=a.fovy,this.near=a.near,this.far=a.far},_update:function(){var a=this.scene.canvas.canvas,b=a.clientWidth/a.clientHeight;this.matrix=xeogl.math.perspectiveMat4(this._fovy*(Math.PI/180),b,this._near,this._far,this._matrix)},_props:{fovy:{set:function(a){this._fovy=void 0!==a&&null!==a?a:60,this._renderer.imageDirty=!0,this._scheduleUpdate(0),this.fire("fovy",this._fovy)},get:function(){return this._fovy}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._renderer.imageDirty=!0,this._scheduleUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._renderer.imageDirty=!0,this._scheduleUpdate(0),this.fire("far",this._far)},get:function(){return this._far}}},_getJSON:function(){var a={fovy:this._fovy,near:this._near,far:this._far};return this._parent&&(a.parent=this._parent.id),a},_destroy:function(){this._super(),this.scene.canvas.off(this._canvasResized)}})}(),xeogl.version="1.0.0";