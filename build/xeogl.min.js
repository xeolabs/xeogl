/*
 * xeogl V0.8.0
 *
 * A WebGL-based 3D visualization engine from xeoLabs
 * http://xeogl.org/
 *
 * Built on 2018-08-14
 *
 * MIT License
 * Copyright 2018, Lindsay Kay
 * http://xeolabs.com/
 *
 */


!function(){"use strict";var e,t=function(){this._debug={forceHighShaderPrecision:!1},this.version=null,this.WEBGL_INFO=function(){var e={WEBGL:!1},t=document.createElement("canvas");if(!t)return e;var i=t.getContext("webgl",{antialias:!0})||t.getContext("experimental-webgl",{antialias:!0});return e.WEBGL=!!i,e.WEBGL?(e.ANTIALIAS=i.getContextAttributes().antialias,i.getShaderPrecisionFormat?i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.HIGH_FLOAT).precision>0?e.FS_MAX_FLOAT_PRECISION="highp":i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.MEDIUM_FLOAT).precision>0?e.FS_MAX_FLOAT_PRECISION="mediump":e.FS_MAX_FLOAT_PRECISION="lowp":e.FS_MAX_FLOAT_PRECISION="mediump",e.DEPTH_BUFFER_BITS=i.getParameter(i.DEPTH_BITS),e.MAX_TEXTURE_SIZE=i.getParameter(i.MAX_TEXTURE_SIZE),e.MAX_CUBE_MAP_SIZE=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),e.MAX_RENDERBUFFER_SIZE=i.getParameter(i.MAX_RENDERBUFFER_SIZE),e.MAX_TEXTURE_UNITS=i.getParameter(i.MAX_COMBINED_TEXTURE_IMAGE_UNITS),e.MAX_TEXTURE_IMAGE_UNITS=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),e.MAX_VERTEX_ATTRIBS=i.getParameter(i.MAX_VERTEX_ATTRIBS),e.MAX_VERTEX_UNIFORM_VECTORS=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),e.MAX_FRAGMENT_UNIFORM_VECTORS=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),e.MAX_VARYING_VECTORS=i.getParameter(i.MAX_VARYING_VECTORS),e.SUPPORTED_EXTENSIONS={},i.getSupportedExtensions().forEach(function(t){e.SUPPORTED_EXTENSIONS[t]=!0}),e):e}(),this.stats={build:{version:t.version},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}},this._sceneIDMap=null,this._scene=null,this.scenes={},this._scenesRenderInfo={},this._superTypes={},this._taskQueue=new function(){var e=[],t=0,i=[],s=0;this.length=0,this.shift=function(){if(s>=t){var r=e;if(r.length=0,e=i,i=r,s=0,!(t=e.length))return}var a=e[s];return s<0?delete e[s++]:e[s++]=void 0,this.length--,a},this.push=function(e){return this.length++,i.push(e),this},this.unshift=function(t){return e[--s]=t,this.length++,this}};var e=this;!function(){var t,i,s,r,a,n={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},o=10,l=0,h=[],u=0,c=function(){t=Date.now(),l>0&&(u+=i=1e3/(t-l),h.push(i),h.length>=30&&(u-=h.shift()),e.stats.frame.fps=Math.round(u/h.length)),function(){s=Date.now();var t=e._runScheduledTasks(s+o),i=e._taskQueue.length;for(r in e.stats.frame.tasksRun=t,e.stats.frame.tasksScheduled=i,e.stats.frame.tasksBudget=o,n.time=s,e.scenes)e.scenes.hasOwnProperty(r)&&(a=e.scenes[r],n.sceneId=r,n.startTime=a.startTime,n.deltaTime=null!=n.prevTime?n.time-n.prevTime:0,a.fire("tick",n,!0));n.prevTime=s}(),function(){var t,i,s,a=e.scenes,n=e._scenesRenderInfo;for(r in a)a.hasOwnProperty(r)&&(t=a[r],i=n[r],s=t.ticksPerRender,i.ticksPerRender!==s&&(i.ticksPerRender=s,i.renderCountdown=s),0==--i.renderCountdown&&(t.render(!1),i.renderCountdown=s))}(),l=t,window.requestAnimationFrame(c)};window.requestAnimationFrame(c)}()};t.prototype={constructor:t,get scene(){return this._scene||(this._scene=new window.xeogl.Scene({id:"default.scene"}))},set scene(e){this._scene=e},_addScene:function(e){if(this._sceneIDMap=this._sceneIDMap||new window.xeogl.utils.Map,e.id){if(this.scenes[e.id])return void console.error("[ERROR] Scene "+t._inQuotes(e.id)+" already exists")}else e.id=this._sceneIDMap.addItem({});this.scenes[e.id]=e;var i=e.ticksPerRender;this._scenesRenderInfo[e.id]={ticksPerRender:i,renderCountdown:i},this.stats.components.scenes++;var s=this;e.on("destroyed",function(){s._sceneIDMap.removeItem(e.id),delete s.scenes[e.id],delete s._scenesRenderInfo[e.id],s.stats.components.scenes--})},scheduleTask:function(e,t){this._taskQueue.push(e),this._taskQueue.push(t)},deferTask:function(e,t){t?e.call(t):e()},_runScheduledTasks:function(e){for(var t,i,s=(new Date).getTime(),r=this._taskQueue,a=0;r.length>0&&s<e;)t=r.shift(),(i=r.shift())?t.call(i):t(),s=(new Date).getTime(),a++;return a},clear:function(){var e;for(var t in this.scenes)this.scenes.hasOwnProperty(t)&&(e=this.scenes[t],"default.scene"===t?e.clear():e.destroy());this.scenes={}},_isArray:function(e){return e&&!e.propertyIsEnumerable("length")&&"object"==typeof e&&"number"==typeof e.length},_isString:function(e){return"string"==typeof e||e instanceof String},_isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},_isID:function(e){return t.prototype._isString(e)||t.prototype._isNumeric(e)},_isSameComponent:function(e,i){return!(!e||!i)&&(t.prototype._isNumeric(e)||t.prototype._isString(e)?""+e:e.id)===(t.prototype._isNumeric(i)||t.prototype._isString(i)?""+i:i.id)},_isFunction:function(e){return"function"==typeof e},_isObject:(e={}.constructor,function(t){return!!t&&t.constructor===e}),_isComponentType:function(e,t){if(e===(t=t||"xeogl.Component"))return!0;var i=this._superTypes[e];if(!i)return!1;for(var s=i.length-1;s>=0;s--)if(i[s]===t)return!0;return!1},_copy:function(e){return this._apply(e,{})},_apply:function(e,t){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t},_apply2:function(e,t){for(var i in e)e.hasOwnProperty(i)&&void 0!==e[i]&&null!==e[i]&&(t[i]=e[i]);return t},_applyIf:function(e,t){for(var i in e)e.hasOwnProperty(i)&&(void 0!==t[i]&&null!==t[i]||(t[i]=e[i]));return t},_isEmptyObject:function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},_inQuotes:function(e){return this._isNumeric(e)?""+e:"'"+e+"'"},_concat:function(e,t){var i=new e.constructor(e.length+t.length);return i.set(e),i.set(t,e.length),i}},window.xeogl=window.xeogl=new t}();var Canvas2Image=function(){var e=document.createElement("canvas"),t=String.fromCharCode;if(!e.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var i=!!e.getContext("2d").getImageData,s=!!e.toDataURL,r=!!window.btoa,a=function(e){var i="",s=e.width,r=e.height;i+="BM";var a=s*r*4+54;i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),i+=t(0,0,0,0,54,0,0,0),i+=t(40,0,0,0);var n=s;i+=t(n%256),n=Math.floor(n/256),i+=t(n%256),n=Math.floor(n/256),i+=t(n%256),n=Math.floor(n/256),i+=t(n%256);var o=r;i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),i+=t(1,0,32,0),i+=t(0,0,0,0);var l=s*r*4;i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),i+=t(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var h,u,c,d,p=e.data,_="",f=r;do{for(c=s*(f-1)*4,d="",h=0;h<s;h++)d+=t(p[c+(u=4*h)+2],p[c+u+1],p[c+u],p[c+u+3]);_+=d}while(--f);return function(e){var i,s,r="";if("string"==typeof e)r=e;else for(s=e,i=0;i<s.length;i++)r+=t(s[i]);return btoa(r)}(i+_)},n=function(e){window.open(e)||(document.location.href=e)},o=function(e,t){return"data:"+t+";base64,"+e},l=function(e){var t=document.createElement("img");return t.src=e,t},h=function(e,t,i){if(t&&i){var s=document.createElement("canvas");return s.width=t,s.height=i,s.style.width=t+"px",s.style.height=i+"px",s.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,t),s}return e};return{saveAsPNG:function(e,t,i,r){if(!s)return!1;var a=h(e,i,r).toDataURL("image/png");return t?l(a):(n(a),!0)},saveAsJPEG:function(e,t,i,r){if(!s)return!1;var a=h(e,i,r).toDataURL("image/jpeg");return 5==a.indexOf("image/jpeg")&&(t?l(a):(n(a),!0))},saveAsBMP:function(e,t,u,c){if(!(s&&i&&r))return!1;var d=function(e){var t=parseInt(e.width),i=parseInt(e.height);return e.getContext("2d").getImageData(0,0,t,i)}(h(e,u,c)),p=a(d);return t?l(o(p,"image/bmp")):(n(o(p,"image/bmp")),!0)}}}();!function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(i){var s=this.prototype;e=!0;var r=new this;for(var a in e=!1,i)if("_props"!==a){var o=!!s[a],l="function"==typeof i[a],h="function"==typeof s[a];t.test(i[a]);if(o){if(l&&!h)throw"Can't override super class property with function: '"+a+"'";if(!l&&h)throw"Can't override super class function with property: '"+a+"'"}r[a]=l&&o?function(e,t){return function(){var i=this._super;this._super=s[e];var r=t.apply(this,arguments);return this._super=i,r}}(a,i[a]):i[a]}else{var u,c=i[a];for(var d in c)if(u=c[d],d.indexOf(",")>=0)for(var p=d.split(","),_=0,f=p.length;_<f;_++){var m=p[_].trim();u.set||function(){var e=m;u.set=function(){this.warn("Property '"+e+"' is read-only, ignoring assignment")}}(),u.enumerable=!0,Object.defineProperty(r,m,u)}else u.set||function(){var e=d;u.set=function(){this.warn("Property '"+e+"' is read-only, ignoring assignment")}}(),u.enumerable=!0,Object.defineProperty(r,d,u)}function g(){!e&&this.__init&&this.__init.apply(this,arguments)}return r.superTypes=s.superTypes?s.superTypes.concat(s.type):[],i.type?xeogl._superTypes[i.type]=r.superTypes:i.type=s.type+"_"+n(),g.prototype=r,g.prototype.constructor=g,g.extend=arguments.callee,window[i.type]=g,g};var i,s,r,a,n=(s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),r=new Array(36),a=0,function(){for(var e=0;e<36;e++)8===e||13===e||18===e||23===e?r[e]="-":14===e?r[e]="4":(a<=2&&(a=33554432+16777216*Math.random()|0),i=15&a,a>>=4,r[e]=s[19===e?3&i|8:i]);return r.join("")})}(),xeogl.utils=xeogl.utils||{},xeogl.utils.Map=function(e,t){this.items=e||[];var i=(t=t||0)+1;this.addItem=function(){var e;if(2===arguments.length){var t=arguments[0];if(e=arguments[1],this.items[t])throw"ID clash: '"+t+"'";return this.items[t]=e,t}for(e=arguments[0]||{};;){var s=i++;if(!this.items[s])return this.items[s]=e,s}},this.removeItem=function(e){var t=this.items[e];return delete this.items[e],t}},function(){"use strict";var e,t,i,s,r,a,n=new Float32Array(16),o=new Float32Array(16),l=new Float32Array(4),h=!1,u=[],c=0,d=xeogl.math={MAX_DOUBLE:Number.MAX_VALUE,MIN_DOUBLE:Number.MIN_VALUE,DEGTORAD:.0174532925,RADTODEG:57.295779513,openCache:function(){h=!0,c=0},cacheVec3:function(e){return e||(h?u[c++]||(u[c-1]=new Float32Array(3)):new Float32Array(3))},cacheVec4:function(e){return e||(h?u[vec4CacheLen++]||(u[vec4CacheLen-1]=new Float32Array(4)):new Float32Array(4))},closeCache:function(){h=!1},vec2:function(e){return new Float32Array(e||2)},vec3:function(e){return new Float32Array(e||3)},vec4:function(e){return new Float32Array(e||4)},mat3:function(e){return new Float32Array(e||9)},mat3ToMat4:function(e,t){return(t=t||new Float32Array(16))[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[3],t[5]=e[4],t[6]=e[5],t[7]=0,t[8]=e[6],t[9]=e[7],t[10]=e[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},mat4:function(e){return new Float32Array(e||16)},mat4ToMat3:function(e,t){},createUUID:function(){for(var e=[],t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);return function(){var t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]+"-"+e[255&i]+e[i>>8&255]+"-"+e[i>>16&15|64]+e[i>>24&255]+"-"+e[63&s|128]+e[s>>8&255]+"-"+e[s>>16&255]+e[s>>24&255]+e[255&r]+e[r>>8&255]+e[r>>16&255]+e[r>>24&255]}}(),clamp:function(e,t,i){return Math.max(t,Math.min(i,e))},fmod:function(e,t){if(e<t)return console.error("xeogl.math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),e;for(;t<=e;)e-=t;return e},negateVec4:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},addVec4:function(e,t,i){return i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i},addVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i},addVec3:function(e,t,i){return i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i},addVec3Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i},subVec4:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i},subVec3:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i},subVec2:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i},subVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i},subScalarVec4:function(e,t,i){return i||(i=e),i[0]=t-e[0],i[1]=t-e[1],i[2]=t-e[2],i[3]=t-e[3],i},mulVec4:function(e,t,i){return i||(i=e),i[0]=e[0]*t[0],i[1]=e[1]*t[1],i[2]=e[2]*t[2],i[3]=e[3]*t[3],i},mulVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i},mulVec3Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i},mulVec2Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i},divVec3:function(e,t,i){return i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i},divVec4:function(e,t,i){return i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i[3]=e[3]/t[3],i},divScalarVec3:function(e,t,i){return i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i},divVec3Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i},divVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i[3]=e[3]/t,i},divScalarVec4:function(e,t,i){return i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i[3]=e/t[3],i},dotVec4:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},cross3Vec4:function(e,t){var i=e[0],s=e[1],r=e[2],a=t[0],n=t[1],o=t[2];return[s*o-r*n,r*a-i*o,i*n-s*a,0]},cross3Vec3:function(e,t,i){i||(i=e);var s=e[0],r=e[1],a=e[2],n=t[0],o=t[1],l=t[2];return i[0]=r*l-a*o,i[1]=a*n-s*l,i[2]=s*o-r*n,i},sqLenVec4:function(e){return d.dotVec4(e,e)},lenVec4:function(e){return Math.sqrt(d.sqLenVec4(e))},dotVec3:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},dotVec2:function(e,t){return e[0]*t[0]+e[1]*t[1]},sqLenVec3:function(e){return d.dotVec3(e,e)},sqLenVec2:function(e){return d.dotVec2(e,e)},lenVec3:function(e){return Math.sqrt(d.sqLenVec3(e))},distVec3:(a=new Float32Array(3),function(e,t){return d.lenVec3(d.subVec3(e,t,a))}),lenVec2:function(e){return Math.sqrt(d.sqLenVec2(e))},distVec2:function(){var e=new Float32Array(2);return function(t,i){return d.lenVec2(d.subVec2(t,i,e))}}(),rcpVec3:function(e,t){return d.divScalarVec3(1,e,t)},normalizeVec4:function(e,t){var i=1/d.lenVec4(e);return d.mulVec4Scalar(e,i,t)},normalizeVec3:function(e,t){var i=1/d.lenVec3(e);return d.mulVec3Scalar(e,i,t)},normalizeVec2:function(e,t){var i=1/d.lenVec2(e);return d.mulVec2Scalar(e,i,t)},angleVec3:function(e,t){var i=xeogl.math.dotVec3(e,t)/Math.sqrt(xeogl.math.sqLenVec3(e)*xeogl.math.sqLenVec3(t));return i=i<-1?-1:i>1?1:i,Math.acos(i)},vec3FromMat4Scale:(r=new Float32Array(3),function(e,t){return r[0]=e[0],r[1]=e[1],r[2]=e[2],t[0]=d.lenVec3(r),r[0]=e[4],r[1]=e[5],r[2]=e[6],t[1]=d.lenVec3(r),r[0]=e[8],r[1]=e[9],r[2]=e[10],t[2]=d.lenVec3(r),t}),vecToArray:function(){function e(e){return Math.round(1e5*e)/1e5}return function(t){for(var i=0,s=(t=Array.prototype.slice.call(t)).length;i<s;i++)t[i]=e(t[i]);return t}}(),dupMat4:function(e){return e.slice(0,16)},mat4To3:function(e){return[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]]},m4s:function(e){return[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e]},setMat4ToZeroes:function(){return d.m4s(0)},setMat4ToOnes:function(){return d.m4s(1)},diagonalMat4v:function(e){return new Float32Array([e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,e[3]])},diagonalMat4c:function(e,t,i,s){return d.diagonalMat4v([e,t,i,s])},diagonalMat4s:function(e){return d.diagonalMat4c(e,e,e,e)},identityMat4:function(e){return(e=e||new Float32Array(16))[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},identityMat3:function(e){return(e=e||new Float32Array(9))[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},isIdentityMat4:function(e){return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]},negateMat4:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=-e[7],t[8]=-e[8],t[9]=-e[9],t[10]=-e[10],t[11]=-e[11],t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=-e[15],t},addMat4:function(e,t,i){return i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i[4]=e[4]+t[4],i[5]=e[5]+t[5],i[6]=e[6]+t[6],i[7]=e[7]+t[7],i[8]=e[8]+t[8],i[9]=e[9]+t[9],i[10]=e[10]+t[10],i[11]=e[11]+t[11],i[12]=e[12]+t[12],i[13]=e[13]+t[13],i[14]=e[14]+t[14],i[15]=e[15]+t[15],i},addMat4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i[4]=e[4]+t,i[5]=e[5]+t,i[6]=e[6]+t,i[7]=e[7]+t,i[8]=e[8]+t,i[9]=e[9]+t,i[10]=e[10]+t,i[11]=e[11]+t,i[12]=e[12]+t,i[13]=e[13]+t,i[14]=e[14]+t,i[15]=e[15]+t,i},addScalarMat4:function(e,t,i){return d.addMat4Scalar(t,e,i)},subMat4:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i[4]=e[4]-t[4],i[5]=e[5]-t[5],i[6]=e[6]-t[6],i[7]=e[7]-t[7],i[8]=e[8]-t[8],i[9]=e[9]-t[9],i[10]=e[10]-t[10],i[11]=e[11]-t[11],i[12]=e[12]-t[12],i[13]=e[13]-t[13],i[14]=e[14]-t[14],i[15]=e[15]-t[15],i},subMat4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i[4]=e[4]-t,i[5]=e[5]-t,i[6]=e[6]-t,i[7]=e[7]-t,i[8]=e[8]-t,i[9]=e[9]-t,i[10]=e[10]-t,i[11]=e[11]-t,i[12]=e[12]-t,i[13]=e[13]-t,i[14]=e[14]-t,i[15]=e[15]-t,i},subScalarMat4:function(e,t,i){return i||(i=t),i[0]=e-t[0],i[1]=e-t[1],i[2]=e-t[2],i[3]=e-t[3],i[4]=e-t[4],i[5]=e-t[5],i[6]=e-t[6],i[7]=e-t[7],i[8]=e-t[8],i[9]=e-t[9],i[10]=e-t[10],i[11]=e-t[11],i[12]=e-t[12],i[13]=e-t[13],i[14]=e-t[14],i[15]=e-t[15],i},mulMat4:function(e,t,i){i||(i=e);var s=e[0],r=e[1],a=e[2],n=e[3],o=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=e[9],p=e[10],_=e[11],f=e[12],m=e[13],g=e[14],v=e[15],x=t[0],M=t[1],y=t[2],b=t[3],w=t[4],A=t[5],E=t[6],C=t[7],P=t[8],S=t[9],D=t[10],T=t[11],F=t[12],B=t[13],L=t[14],R=t[15];return i[0]=x*s+M*o+y*c+b*f,i[1]=x*r+M*l+y*d+b*m,i[2]=x*a+M*h+y*p+b*g,i[3]=x*n+M*u+y*_+b*v,i[4]=w*s+A*o+E*c+C*f,i[5]=w*r+A*l+E*d+C*m,i[6]=w*a+A*h+E*p+C*g,i[7]=w*n+A*u+E*_+C*v,i[8]=P*s+S*o+D*c+T*f,i[9]=P*r+S*l+D*d+T*m,i[10]=P*a+S*h+D*p+T*g,i[11]=P*n+S*u+D*_+T*v,i[12]=F*s+B*o+L*c+R*f,i[13]=F*r+B*l+L*d+R*m,i[14]=F*a+B*h+L*p+R*g,i[15]=F*n+B*u+L*_+R*v,i},mulMat3:function(e,t,i){i||(i=new Float32Array(9));var s=e[0],r=e[3],a=e[6],n=e[1],o=e[4],l=e[7],h=e[2],u=e[5],c=e[8],d=t[0],p=t[3],_=t[6],f=t[1],m=t[4],g=t[7],v=t[2],x=t[5],M=t[8];return i[0]=s*d+r*f+a*v,i[3]=s*p+r*m+a*x,i[6]=s*_+r*g+a*M,i[1]=n*d+o*f+l*v,i[4]=n*p+o*m+l*x,i[7]=n*_+o*g+l*M,i[2]=h*d+u*f+c*v,i[5]=h*p+u*m+c*x,i[8]=h*_+u*g+c*M,i},mulMat4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i[4]=e[4]*t,i[5]=e[5]*t,i[6]=e[6]*t,i[7]=e[7]*t,i[8]=e[8]*t,i[9]=e[9]*t,i[10]=e[10]*t,i[11]=e[11]*t,i[12]=e[12]*t,i[13]=e[13]*t,i[14]=e[14]*t,i[15]=e[15]*t,i},mulMat4v4:function(e,t,i){i=i||d.vec4();var s=t[0],r=t[1],a=t[2],n=t[3];return i[0]=e[0]*s+e[4]*r+e[8]*a+e[12]*n,i[1]=e[1]*s+e[5]*r+e[9]*a+e[13]*n,i[2]=e[2]*s+e[6]*r+e[10]*a+e[14]*n,i[3]=e[3]*s+e[7]*r+e[11]*a+e[15]*n,i},transposeMat4:function(e,t){var i=e[4],s=e[14],r=e[8],a=e[13],n=e[12],o=e[9];if(!t||e===t){var l=e[1],h=e[2],u=e[3],c=e[6],d=e[7],p=e[11];return e[1]=i,e[2]=r,e[3]=n,e[4]=l,e[6]=o,e[7]=a,e[8]=h,e[9]=c,e[11]=s,e[12]=u,e[13]=d,e[14]=p,e}return t[0]=e[0],t[1]=i,t[2]=r,t[3]=n,t[4]=e[1],t[5]=e[5],t[6]=o,t[7]=a,t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=s,t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},transposeMat3:function(e,t){if(t===e){var i=e[1],s=e[2],r=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=s,t[7]=r}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},determinantMat4:function(e){var t=e[0],i=e[1],s=e[2],r=e[3],a=e[4],n=e[5],o=e[6],l=e[7],h=e[8],u=e[9],c=e[10],d=e[11],p=e[12],_=e[13],f=e[14],m=e[15];return p*u*o*r-h*_*o*r-p*n*c*r+a*_*c*r+h*n*f*r-a*u*f*r-p*u*s*l+h*_*s*l+p*i*c*l-t*_*c*l-h*i*f*l+t*u*f*l+p*n*s*d-a*_*s*d-p*i*o*d+t*_*o*d+a*i*f*d-t*n*f*d-h*n*s*m+a*u*s*m+h*i*o*m-t*u*o*m-a*i*c*m+t*n*c*m},inverseMat4:function(e,t){t||(t=e);var i=e[0],s=e[1],r=e[2],a=e[3],n=e[4],o=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],p=e[11],_=e[12],f=e[13],m=e[14],g=e[15],v=i*o-s*n,x=i*l-r*n,M=i*h-a*n,y=s*l-r*o,b=s*h-a*o,w=r*h-a*l,A=u*f-c*_,E=u*m-d*_,C=u*g-p*_,P=c*m-d*f,S=c*g-p*f,D=d*g-p*m,T=1/(v*D-x*S+M*P+y*C-b*E+w*A);return t[0]=(o*D-l*S+h*P)*T,t[1]=(-s*D+r*S-a*P)*T,t[2]=(f*w-m*b+g*y)*T,t[3]=(-c*w+d*b-p*y)*T,t[4]=(-n*D+l*C-h*E)*T,t[5]=(i*D-r*C+a*E)*T,t[6]=(-_*w+m*M-g*x)*T,t[7]=(u*w-d*M+p*x)*T,t[8]=(n*S-o*C+h*A)*T,t[9]=(-i*S+s*C-a*A)*T,t[10]=(_*b-f*M+g*v)*T,t[11]=(-u*b+c*M-p*v)*T,t[12]=(-n*P+o*E-l*A)*T,t[13]=(i*P-s*E+r*A)*T,t[14]=(-_*y+f*x-m*v)*T,t[15]=(u*y-c*x+d*v)*T,t},traceMat4:function(e){return e[0]+e[5]+e[10]+e[15]},translationMat4v:function(e,t){var i=t||d.identityMat4();return i[12]=e[0],i[13]=e[1],i[14]=e[2],i},translationMat3v:function(e,t){var i=t||d.identityMat3();return i[6]=e[0],i[7]=e[1],i},translationMat4c:(s=new Float32Array(3),function(e,t,i,r){return s[0]=e,s[1]=t,s[2]=i,d.translationMat4v(s,r)}),translationMat4s:function(e,t){return d.translationMat4c(e,e,e,t)},translateMat4v:function(e,t){return d.translateMat4c(e[0],e[1],e[2],t)},OLDtranslateMat4c:function(e,t,i,s){var r=s[12];s[0]+=r*e,s[4]+=r*t,s[8]+=r*i;var a=s[13];s[1]+=a*e,s[5]+=a*t,s[9]+=a*i;var n=s[14];s[2]+=n*e,s[6]+=n*t,s[10]+=n*i;var o=s[15];return s[3]+=o*e,s[7]+=o*t,s[11]+=o*i,s},translateMat4c:function(e,t,i,s){var r=s[3];s[0]+=r*e,s[1]+=r*t,s[2]+=r*i;var a=s[7];s[4]+=a*e,s[5]+=a*t,s[6]+=a*i;var n=s[11];s[8]+=n*e,s[9]+=n*t,s[10]+=n*i;var o=s[15];return s[12]+=o*e,s[13]+=o*t,s[14]+=o*i,s},rotationMat4v:function(e,t,i){var s,r,a,n,o,l,h=d.normalizeVec4([t[0],t[1],t[2],0],[]),u=Math.sin(e),c=Math.cos(e),p=1-c,_=h[0],f=h[1],m=h[2];return s=_*f,r=f*m,a=m*_,n=_*u,o=f*u,l=m*u,(i=i||d.mat4())[0]=p*_*_+c,i[1]=p*s+l,i[2]=p*a-o,i[3]=0,i[4]=p*s-l,i[5]=p*f*f+c,i[6]=p*r+n,i[7]=0,i[8]=p*a+o,i[9]=p*r-n,i[10]=p*m*m+c,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c:function(e,t,i,s,r){return d.rotationMat4v(e,[t,i,s],r)},scalingMat4v:function(e,t){return(t=t||d.identityMat4())[0]=e[0],t[5]=e[1],t[10]=e[2],t},scalingMat3v:function(e,t){return(t=t||d.identityMat3())[0]=e[0],t[4]=e[1],t},scalingMat4c:function(){var e=new Float32Array(3);return function(t,i,s,r){return e[0]=t,e[1]=i,e[2]=s,d.scalingMat4v(e,r)}}(),scaleMat4c:function(e,t,i,s){return s[0]*=e,s[4]*=t,s[8]*=i,s[1]*=e,s[5]*=t,s[9]*=i,s[2]*=e,s[6]*=t,s[10]*=i,s[3]*=e,s[7]*=t,s[11]*=i,s},scaleMat4v:function(e,t){var i=e[0],s=e[1],r=e[2];return t[0]*=i,t[4]*=s,t[8]*=r,t[1]*=i,t[5]*=s,t[9]*=r,t[2]*=i,t[6]*=s,t[10]*=r,t[3]*=i,t[7]*=s,t[11]*=r,t},scalingMat4s:function(e){return d.scalingMat4c(e,e,e)},rotationTranslationMat4:function(e,t,i){i=i||d.mat4();var s=e[0],r=e[1],a=e[2],n=e[3],o=s+s,l=r+r,h=a+a,u=s*o,c=s*l,p=s*h,_=r*l,f=r*h,m=a*h,g=n*o,v=n*l,x=n*h;return i[0]=1-(_+m),i[1]=c+x,i[2]=p-v,i[3]=0,i[4]=c-x,i[5]=1-(u+m),i[6]=f+g,i[7]=0,i[8]=p+v,i[9]=f-g,i[10]=1-(u+_),i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i},mat4ToEuler:function(e,t,i){i=i||d.vec4();var s=d.clamp,r=e[0],a=e[4],n=e[8],o=e[1],l=e[5],h=e[9],u=e[2],c=e[6],p=e[10];return"XYZ"===t?(i[1]=Math.asin(s(n,-1,1)),Math.abs(n)<.99999?(i[0]=Math.atan2(-h,p),i[2]=Math.atan2(-a,r)):(i[0]=Math.atan2(c,l),i[2]=0)):"YXZ"===t?(i[0]=Math.asin(-s(h,-1,1)),Math.abs(h)<.99999?(i[1]=Math.atan2(n,p),i[2]=Math.atan2(o,l)):(i[1]=Math.atan2(-u,r),i[2]=0)):"ZXY"===t?(i[0]=Math.asin(s(c,-1,1)),Math.abs(c)<.99999?(i[1]=Math.atan2(-u,p),i[2]=Math.atan2(-a,l)):(i[1]=0,i[2]=Math.atan2(o,r))):"ZYX"===t?(i[1]=Math.asin(-s(u,-1,1)),Math.abs(u)<.99999?(i[0]=Math.atan2(c,p),i[2]=Math.atan2(o,r)):(i[0]=0,i[2]=Math.atan2(-a,l))):"YZX"===t?(i[2]=Math.asin(s(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(-h,l),i[1]=Math.atan2(-u,r)):(i[0]=0,i[1]=Math.atan2(n,p))):"XZY"===t&&(i[2]=Math.asin(-s(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(c,l),i[1]=Math.atan2(n,r)):(i[0]=Math.atan2(-h,p),i[1]=0)),i},composeMat4:function(e,t,i,s){return s=s||d.mat4(),d.quaternionToRotationMat4(t,s),d.scaleMat4v(i,s),d.translateMat4v(e,s),s},decomposeMat4:function(){var e=new Float32Array(3),t=new Float32Array(16);return function(i,s,r,a){e[0]=i[0],e[1]=i[1],e[2]=i[2];var n=d.lenVec3(e);e[0]=i[4],e[1]=i[5],e[2]=i[6];var o=d.lenVec3(e);e[8]=i[8],e[9]=i[9],e[10]=i[10];var l=d.lenVec3(e);d.determinantMat4(i)<0&&(n=-n),s[0]=i[12],s[1]=i[13],s[2]=i[14],t.set(i);var h=1/n,u=1/o,c=1/l;return t[0]*=h,t[1]*=h,t[2]*=h,t[4]*=u,t[5]*=u,t[6]*=u,t[8]*=c,t[9]*=c,t[10]*=c,d.mat4ToQuaternion(t,r),a[0]=n,a[1]=o,a[2]=l,this}}(),lookAtMat4v:function(e,t,i,s){s||(s=d.mat4());var r,a,n,o,l,h,u,c,p,_,f=e[0],m=e[1],g=e[2],v=i[0],x=i[1],M=i[2],y=t[0],b=t[1],w=t[2];return f===y&&m===b&&g===w?d.identityMat4():(r=f-y,a=m-b,n=g-w,o=x*(n*=_=1/Math.sqrt(r*r+a*a+n*n))-M*(a*=_),l=M*(r*=_)-v*n,h=v*a-x*r,(_=Math.sqrt(o*o+l*l+h*h))?(o*=_=1/_,l*=_,h*=_):(o=0,l=0,h=0),u=a*h-n*l,c=n*o-r*h,p=r*l-a*o,(_=Math.sqrt(u*u+c*c+p*p))?(u*=_=1/_,c*=_,p*=_):(u=0,c=0,p=0),s[0]=o,s[1]=u,s[2]=r,s[3]=0,s[4]=l,s[5]=c,s[6]=a,s[7]=0,s[8]=h,s[9]=p,s[10]=n,s[11]=0,s[12]=-(o*f+l*m+h*g),s[13]=-(u*f+c*m+p*g),s[14]=-(r*f+a*m+n*g),s[15]=1,s)},lookAtMat4c:function(e,t,i,s,r,a,n,o,l){return d.lookAtMat4v([e,t,i],[s,r,a],[n,o,l],[])},orthoMat4c:function(e,t,i,s,r,a,n){n||(n=d.mat4());var o=t-e,l=s-i,h=a-r;return n[0]=2/o,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/l,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=-2/h,n[11]=0,n[12]=-(e+t)/o,n[13]=-(s+i)/l,n[14]=-(a+r)/h,n[15]=1,n},frustumMat4v:function(e,t,i){i||(i=d.mat4());var s=[e[0],e[1],e[2],0],r=[t[0],t[1],t[2],0];d.addVec4(r,s,n),d.subVec4(r,s,o);var a=2*s[2],l=o[0],h=o[1],u=o[2];return i[0]=a/l,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=a/h,i[6]=0,i[7]=0,i[8]=n[0]/l,i[9]=n[1]/h,i[10]=-n[2]/u,i[11]=-1,i[12]=0,i[13]=0,i[14]=-a*r[2]/u,i[15]=0,i},frustumMat4:function(e,t,i,s,r,a,n){n||(n=d.mat4());var o=t-e,l=s-i,h=a-r;return n[0]=2*r/o,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2*r/l,n[6]=0,n[7]=0,n[8]=(t+e)/o,n[9]=(s+i)/l,n[10]=-(a+r)/h,n[11]=-1,n[12]=0,n[13]=0,n[14]=-a*r*2/h,n[15]=0,n},perspectiveMat4:function(e,t,i,s,r){var a=[],n=[];return a[2]=i,n[2]=s,n[1]=a[2]*Math.tan(e/2),a[1]=-n[1],n[0]=n[1]*t,a[0]=-n[0],d.frustumMat4v(a,n,r)},transformPoint3:function(e,t,i){return(i=i||d.vec3())[0]=e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12],i[1]=e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13],i[2]=e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14],i},transformPoint4:function(e,t,i){return(i=i||d.vec4())[0]=e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],i[1]=e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],i[2]=e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],i[3]=e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3],i},transformPoints3:function(e,t,i){for(var s,r,a,n,o,l=i||[],h=t.length,u=e[0],c=e[1],d=e[2],p=e[3],_=e[4],f=e[5],m=e[6],g=e[7],v=e[8],x=e[9],M=e[10],y=e[11],b=e[12],w=e[13],A=e[14],E=e[15],C=0;C<h;++C)s=(n=t[C])[0],r=n[1],a=n[2],(o=l[C]||(l[C]=[0,0,0]))[0]=u*s+_*r+v*a+b,o[1]=c*s+f*r+x*a+w,o[2]=d*s+m*r+M*a+A,o[3]=p*s+g*r+y*a+E;return l.length=h,l},transformPositions3:function(e,t,i){var s;i=i||t;var r,a,n,o=t.length,l=e[0],h=e[1],u=e[2],c=e[3],d=e[4],p=e[5],_=e[6],f=e[7],m=e[8],g=e[9],v=e[10],x=e[11],M=e[12],y=e[13],b=e[14],w=e[15];for(s=0;s<o;s+=3)r=t[s+0],a=t[s+1],n=t[s+2],i[s+0]=l*r+d*a+m*n+M,i[s+1]=h*r+p*a+g*n+y,i[s+2]=u*r+_*a+v*n+b,i[s+3]=c*r+f*a+x*n+w;return i},transformPositions4:function(e,t,i){var s;i=i||t;var r,a,n,o=t.length,l=e[0],h=e[1],u=e[2],c=e[3],d=e[4],p=e[5],_=e[6],f=e[7],m=e[8],g=e[9],v=e[10],x=e[11],M=e[12],y=e[13],b=e[14],w=e[15];for(s=0;s<o;s+=4)r=t[s+0],a=t[s+1],n=t[s+2],i[s+0]=l*r+d*a+m*n+M,i[s+1]=h*r+p*a+g*n+y,i[s+2]=u*r+_*a+v*n+b,i[s+3]=c*r+f*a+x*n+w;return i},transformVec3:function(e,t,i){var s=t[0],r=t[1],a=t[2];return(i=i||this.vec3())[0]=e[0]*s+e[4]*r+e[8]*a,i[1]=e[1]*s+e[5]*r+e[9]*a,i[2]=e[2]*s+e[6]*r+e[10]*a,i},transformVec4:function(e,t,i){var s=t[0],r=t[1],a=t[2],n=t[3];return(i=i||d.vec4())[0]=e[0]*s+e[4]*r+e[8]*a+e[12]*n,i[1]=e[1]*s+e[5]*r+e[9]*a+e[13]*n,i[2]=e[2]*s+e[6]*r+e[10]*a+e[14]*n,i[3]=e[3]*s+e[7]*r+e[11]*a+e[15]*n,i},rotateVec3X:function(e,t,i,s){var r=[],a=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],a[0]=r[0],a[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),a[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),s[0]=a[0]+t[0],s[1]=a[1]+t[1],s[2]=a[2]+t[2],s},rotateVec3Y:function(e,t,i,s){var r=[],a=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],a[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),a[1]=r[1],a[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),s[0]=a[0]+t[0],s[1]=a[1]+t[1],s[2]=a[2]+t[2],s},rotateVec3Z:function(e,t,i,s){var r=[],a=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],a[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),a[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),a[2]=r[2],s[0]=a[0]+t[0],s[1]=a[1]+t[1],s[2]=a[2]+t[2],s},projectVec4:function(e,t){var i=1/e[3];return(t=t||d.vec2())[0]=v[0]*i,t[1]=v[1]*i,t},unprojectVec3:(e=new Float32Array(16),t=new Float32Array(16),i=new Float32Array(16),function(s,r,a,n){return this.transformVec3(this.mulMat4(this.inverseMat4(r,e),this.inverseMat4(a,t),i),s,n)}),lerpVec3:function(e,t,i,s,r,a){var n=a||d.vec3(),o=(e-t)/(i-t);return n[0]=s[0]+o*(r[0]-s[0]),n[1]=s[1]+o*(r[1]-s[1]),n[2]=s[2]+o*(r[2]-s[2]),n},flatten:function(e){var t,i,s,r,a,n=[];for(t=0,i=e.length;t<i;t++)for(s=0,r=(a=e[t]).length;s<r;s++)n.push(a[s]);return n},identityQuaternion:function(e){return(e=e||d.vec4())[0]=0,e[1]=0,e[2]=0,e[3]=1,e},eulerToQuaternion:function(e,t,i){i=i||d.vec4();var s=e[0]*d.DEGTORAD/2,r=e[1]*d.DEGTORAD/2,a=e[2]*d.DEGTORAD/2,n=Math.cos(s),o=Math.cos(r),l=Math.cos(a),h=Math.sin(s),u=Math.sin(r),c=Math.sin(a);return"XYZ"===t?(i[0]=h*o*l+n*u*c,i[1]=n*u*l-h*o*c,i[2]=n*o*c+h*u*l,i[3]=n*o*l-h*u*c):"YXZ"===t?(i[0]=h*o*l+n*u*c,i[1]=n*u*l-h*o*c,i[2]=n*o*c-h*u*l,i[3]=n*o*l+h*u*c):"ZXY"===t?(i[0]=h*o*l-n*u*c,i[1]=n*u*l+h*o*c,i[2]=n*o*c+h*u*l,i[3]=n*o*l-h*u*c):"ZYX"===t?(i[0]=h*o*l-n*u*c,i[1]=n*u*l+h*o*c,i[2]=n*o*c-h*u*l,i[3]=n*o*l+h*u*c):"YZX"===t?(i[0]=h*o*l+n*u*c,i[1]=n*u*l+h*o*c,i[2]=n*o*c-h*u*l,i[3]=n*o*l-h*u*c):"XZY"===t&&(i[0]=h*o*l-n*u*c,i[1]=n*u*l-h*o*c,i[2]=n*o*c+h*u*l,i[3]=n*o*l+h*u*c),i},mat4ToQuaternion:function(e,t){t=t||d.vec4();var i,s=e[0],r=e[4],a=e[8],n=e[1],o=e[5],l=e[9],h=e[2],u=e[6],c=e[10],p=s+o+c;return p>0?(i=.5/Math.sqrt(p+1),t[3]=.25/i,t[0]=(u-l)*i,t[1]=(a-h)*i,t[2]=(n-r)*i):s>o&&s>c?(i=2*Math.sqrt(1+s-o-c),t[3]=(u-l)/i,t[0]=.25*i,t[1]=(r+n)/i,t[2]=(a+h)/i):o>c?(i=2*Math.sqrt(1+o-s-c),t[3]=(a-h)/i,t[0]=(r+n)/i,t[1]=.25*i,t[2]=(l+u)/i):(i=2*Math.sqrt(1+c-s-o),t[3]=(n-r)/i,t[0]=(a+h)/i,t[1]=(l+u)/i,t[2]=.25*i),t},vec3PairToQuaternion:function(e,t,i){i=i||d.vec4();var s=Math.sqrt(d.dotVec3(e,e)*d.dotVec3(t,t)),r=s+d.dotVec3(e,t);return r<1e-8*s?(r=0,Math.abs(e[0])>Math.abs(e[2])?(i[0]=-e[1],i[1]=e[0],i[2]=0):(i[0]=0,i[1]=-e[2],i[2]=e[1])):d.cross3Vec3(e,t,i),i[3]=r,d.normalizeQuaternion(i)},angleAxisToQuaternion:function(e,t){t=t||d.vec4();var i=e[3]/2,s=Math.sin(i);return t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=Math.cos(i),t},quaternionToEuler:function(){var e=new Float32Array(16);return function(t,i,s){return s=s||d.vec3(),d.quaternionToRotationMat4(t,e),d.mat4ToEuler(e,i,s),s}}(),mulQuaternions:function(e,t,i){i=i||d.vec4();var s=e[0],r=e[1],a=e[2],n=e[3],o=t[0],l=t[1],h=t[2],u=t[3];return i[0]=n*o+s*u+r*h-a*l,i[1]=n*l+r*u+a*o-s*h,i[2]=n*h+a*u+s*l-r*o,i[3]=n*u-s*o-r*l-a*h,i},vec3ApplyQuaternion:function(e,t,i){i=i||d.vec3();var s=t[0],r=t[1],a=t[2],n=e[0],o=e[1],l=e[2],h=e[3],u=h*s+o*a-l*r,c=h*r+l*s-n*a,p=h*a+n*r-o*s,_=-n*s-o*r-l*a;return i[0]=u*h+_*-n+c*-l-p*-o,i[1]=c*h+_*-o+p*-n-u*-l,i[2]=p*h+_*-l+u*-o-c*-n,i},quaternionToMat4:function(e,t){t=d.identityMat4(t);var i=e[0],s=e[1],r=e[2],a=e[3],n=2*i,o=2*s,l=2*r,h=n*a,u=o*a,c=l*a,p=n*i,_=o*i,f=l*i,m=o*s,g=l*s,v=l*r;return t[0]=1-(m+v),t[1]=_+c,t[2]=f-u,t[4]=_-c,t[5]=1-(p+v),t[6]=g+h,t[8]=f+u,t[9]=g-h,t[10]=1-(p+m),t},quaternionToRotationMat4:function(e,t){var i=e[0],s=e[1],r=e[2],a=e[3],n=i+i,o=s+s,l=r+r,h=i*n,u=i*o,c=i*l,d=s*o,p=s*l,_=r*l,f=a*n,m=a*o,g=a*l;return t[0]=1-(d+_),t[4]=u-g,t[8]=c+m,t[1]=u+g,t[5]=1-(h+_),t[9]=p-f,t[2]=c-m,t[6]=p+f,t[10]=1-(h+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},normalizeQuaternion:function(e,t){t=t||e;var i=d.lenVec4([e[0],e[1],e[2],e[3]]);return t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i,t[3]=e[3]/i,t},conjugateQuaternion:function(e,t){return(t=t||e)[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},inverseQuaternion:function(e,t){return d.normalizeQuaternion(d.conjugateQuaternion(e,t))},quaternionToAngleAxis:function(e,t){t=t||d.vec4();var i=(e=d.normalizeQuaternion(e,l))[3],s=2*Math.acos(i),r=Math.sqrt(1-i*i);return r<.001?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=e[0]/r,t[1]=e[1]/r,t[2]=e[2]/r),t[3]=s,t},decompressPosition:function(e,t,i){i[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14]},decompressPositions:function(e,t,i){i=i||new Float32Array(e.length);for(var s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[12],i[s+1]=e[s+1]*t[5]+t[13],i[s+2]=e[s+2]*t[10]+t[14];return i},decompressUV:function(e,t,i){i[0]=e[0]*t[0]+t[6],i[1]=e[1]*t[4]+t[7]},decompressUVs:function(e,t,i){i=i||new Float32Array(e.length);for(var s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[6],i[s+1]=e[s+1]*t[4]+t[7];return i},octDecodeVec2:function(e,t){var i=e[0],s=e[1];i=(2*i+1)/255,s=(2*s+1)/255;var r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));var a=Math.sqrt(i*i+s*s+r*r);return t[0]=i/a,t[1]=s/a,t[2]=r/a,t},octDecodeVec2s:function(e,t){for(var i=0,s=0,r=e.length;i<r;i+=2){var a=e[i+0],n=e[i+1];a=(2*a+1)/255,n=(2*n+1)/255;var o=1-Math.abs(a)-Math.abs(n);o<0&&(a=(1-Math.abs(n))*(a>=0?1:-1),n=(1-Math.abs(a))*(n>=0?1:-1));var l=Math.sqrt(a*a+n*n+o*o);t[s+0]=a/l,t[s+1]=n/l,t[s+2]=o/l,s+=3}return t}}}(),function(){"use strict";var e,t,i,s,r=xeogl.math;r.AABB3=function(e){return new Float32Array(e||6)},r.AABB2=function(e){return new Float32Array(e||4)},r.OBB3=function(e){return new Float32Array(e||32)},r.OBB2=function(e){return new Float32Array(e||16)},r.transformOBB3=function(e,t,i){var s;i=i||t;var r,a,n,o=t.length,l=e[0],h=e[1],u=e[2],c=e[3],d=e[4],p=e[5],_=e[6],f=e[7],m=e[8],g=e[9],v=e[10],x=e[11],M=e[12],y=e[13],b=e[14],w=e[15];for(s=0;s<o;s+=4)r=t[s+0],a=t[s+1],n=t[s+2],i[s+0]=l*r+d*a+m*n+M,i[s+1]=h*r+p*a+g*n+y,i[s+2]=u*r+_*a+v*n+b,i[s+3]=c*r+f*a+x*n+w;return i},r.getAABB3Diag=(e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),function(s){return e[0]=s[0],e[1]=s[1],e[2]=s[2],t[0]=s[3],t[1]=s[4],t[2]=s[5],r.subVec3(t,e,i),Math.abs(r.lenVec3(i))}),r.getAABB3DiagPoint=function(){var e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3);return function(s,a){e[0]=s[0],e[1]=s[1],e[2]=s[2],t[0]=s[3],t[1]=s[4],t[2]=s[5];var n=r.subVec3(t,e,i),o=a[0]-s[0],l=s[3]-a[0],h=a[1]-s[1],u=s[4]-a[1],c=a[2]-s[2],d=s[5]-a[2];return n[0]+=o>l?o:l,n[1]+=h>u?h:u,n[2]+=c>d?c:d,Math.abs(r.lenVec3(n))}}(),r.getAABB3Center=function(e,t){var i=t||r.vec3();return i[0]=(e[0]+e[3])/2,i[1]=(e[1]+e[4])/2,i[2]=(e[2]+e[5])/2,i},r.getAABB2Center=function(e,t){var i=t||r.vec2();return i[0]=(e[2]+e[0])/2,i[1]=(e[3]+e[1])/2,i},r.collapseAABB3=function(e){return(e=e||r.AABB3())[0]=xeogl.math.MAX_DOUBLE,e[1]=xeogl.math.MAX_DOUBLE,e[2]=xeogl.math.MAX_DOUBLE,e[3]=-xeogl.math.MAX_DOUBLE,e[4]=-xeogl.math.MAX_DOUBLE,e[5]=-xeogl.math.MAX_DOUBLE,e},r.AABB3ToOBB3=function(e,t){return(t=t||r.OBB3())[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,t[4]=e[3],t[5]=e[1],t[6]=e[2],t[7]=1,t[8]=e[3],t[9]=e[4],t[10]=e[2],t[11]=1,t[12]=e[0],t[13]=e[4],t[14]=e[2],t[15]=1,t[16]=e[0],t[17]=e[1],t[18]=e[5],t[19]=1,t[20]=e[3],t[21]=e[1],t[22]=e[5],t[23]=1,t[24]=e[3],t[25]=e[4],t[26]=e[5],t[27]=1,t[28]=e[0],t[29]=e[4],t[30]=e[5],t[31]=1,t},r.positions3ToAABB3=(s=new Float32Array(3),function(e,t,i){t=t||r.AABB3();for(var a,n,o,l=xeogl.math.MAX_DOUBLE,h=xeogl.math.MAX_DOUBLE,u=xeogl.math.MAX_DOUBLE,c=-xeogl.math.MAX_DOUBLE,d=-xeogl.math.MAX_DOUBLE,p=-xeogl.math.MAX_DOUBLE,_=0,f=e.length;_<f;_+=3)i?(s[0]=e[_+0],s[1]=e[_+1],s[2]=e[_+2],r.decompressPosition(s,i,s),a=s[0],n=s[1],o=s[2]):(a=e[_+0],n=e[_+1],o=e[_+2]),a<l&&(l=a),n<h&&(h=n),o<u&&(u=o),a>c&&(c=a),n>d&&(d=n),o>p&&(p=o);return t[0]=l,t[1]=h,t[2]=u,t[3]=c,t[4]=d,t[5]=p,t}),r.OBB3ToAABB3=function(e,t){t=t||r.AABB3();for(var i,s,a,n=xeogl.math.MAX_DOUBLE,o=xeogl.math.MAX_DOUBLE,l=xeogl.math.MAX_DOUBLE,h=-xeogl.math.MAX_DOUBLE,u=-xeogl.math.MAX_DOUBLE,c=-xeogl.math.MAX_DOUBLE,d=0,p=e.length;d<p;d+=4)i=e[d+0],s=e[d+1],a=e[d+2],i<n&&(n=i),s<o&&(o=s),a<l&&(l=a),i>h&&(h=i),s>u&&(u=s),a>c&&(c=a);return t[0]=n,t[1]=o,t[2]=l,t[3]=h,t[4]=u,t[5]=c,t},r.points3ToAABB3=function(e,t){t=t||r.AABB3();for(var i,s,a,n=xeogl.math.MAX_DOUBLE,o=xeogl.math.MAX_DOUBLE,l=xeogl.math.MAX_DOUBLE,h=-xeogl.math.MAX_DOUBLE,u=-xeogl.math.MAX_DOUBLE,c=-xeogl.math.MAX_DOUBLE,d=0,p=e.length;d<p;d++)i=e[d][0],s=e[d][1],a=e[d][2],i<n&&(n=i),s<o&&(o=s),a<l&&(l=a),i>h&&(h=i),s>u&&(u=s),a>c&&(c=a);return t[0]=n,t[1]=o,t[2]=l,t[3]=h,t[4]=u,t[5]=c,t},r.points3ToSphere3=function(){var e=new Float32Array(3);return function(t,i){i=i||r.vec4();var s,a=0,n=0,o=0,l=t.length;for(s=0;s<l;s++)a+=t[s][0],n+=t[s][1],o+=t[s][2];i[0]=a/l,i[1]=n/l,i[2]=o/l;var h,u=0;for(s=0;s<l;s++)(h=Math.abs(r.lenVec3(r.subVec3(t[s],i,e))))>u&&(u=h);return i[3]=u,i}}(),r.OBB3ToSphere3=function(){var e=new Float32Array(3),t=new Float32Array(3);return function(i,s){s=s||r.vec4();var a,n=0,o=0,l=0,h=i.length,u=h/4;for(a=0;a<h;a+=4)n+=i[a+0],o+=i[a+1],l+=i[a+2];s[0]=n/u,s[1]=o/u,s[2]=l/u;var c,d=0;for(a=0;a<h;a+=4)e[0]=i[a+0],e[1]=i[a+1],e[2]=i[a+2],(c=Math.abs(r.lenVec3(r.subVec3(e,s,t))))>d&&(d=c);return s[3]=d,s}}(),r.getSphere3Center=function(e,t){return(t=t||r.vec3())[0]=e[0],t[1]=e[1],t[2]=e[2],t},r.expandAABB3=function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e[4]<t[4]&&(e[4]=t[4]),e[5]<t[5]&&(e[5]=t[5]),e},r.expandAABB3Point3=function(e,t){return e[0]<t[0]&&(e[0]=t[0]),e[1]<t[1]&&(e[1]=t[1]),e[2]<t[2]&&(e[2]=t[2]),e[3]>t[0]&&(e[3]=t[0]),e[4]>t[1]&&(e[4]=t[1]),e[5]>t[2]&&(e[5]=t[2]),e},r.collapseAABB2=function(e){return(e=e||r.AABB2())[0]=xeogl.math.MAX_DOUBLE,e[1]=xeogl.math.MAX_DOUBLE,e[2]=-xeogl.math.MAX_DOUBLE,e[3]=-xeogl.math.MAX_DOUBLE,e},r.OBB3ToAABB2=function(e,t){t=t||r.AABB2();for(var i,s,a,n=xeogl.math.MAX_DOUBLE,o=xeogl.math.MAX_DOUBLE,l=-xeogl.math.MAX_DOUBLE,h=-xeogl.math.MAX_DOUBLE,u=0,c=e.length;u<c;u+=4)i=e[u+0],s=e[u+1],s*=a=1/(e[u+3]||1),(i*=a)<n&&(n=i),s<o&&(o=s),i>l&&(l=i),s>h&&(h=s);return t[0]=n,t[1]=o,t[2]=l,t[3]=h,t},r.expandAABB2=function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e},r.expandAABB2Point2=function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1]),e},r.AABB2ToCanvas=function(e,t,i,s){s=s||e;var r=.5*(e[0]+1),a=.5*(e[1]+1),n=.5*(e[2]+1),o=.5*(e[3]+1);return s[0]=Math.floor(r*t),s[1]=i-Math.floor(o*i),s[2]=Math.floor(n*t),s[3]=i-Math.floor(a*i),s}}(),function(){"use strict";var e,t,i,s,r,a=xeogl.math;a.triangleNormal=function(e,t,i,s){s=s||a.vec3();var r=t[0]-e[0],n=t[1]-e[1],o=t[2]-e[2],l=i[0]-e[0],h=i[1]-e[1],u=i[2]-e[2],c=n*u-o*h,d=o*l-r*u,p=r*h-n*l,_=Math.sqrt(c*c+d*d+p*p);return 0===_?(s[0]=0,s[1]=0,s[2]=0):(s[0]=c/_,s[1]=d/_,s[2]=p/_),s},a.rayTriangleIntersect=(e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),r=new Float32Array(3),function(n,o,l,h,u,c){c=c||a.vec3();var d=a.subVec3(h,l,e),p=a.subVec3(u,l,t),_=a.cross3Vec3(o,p,i),f=a.dotVec3(d,_);if(f<1e-6)return null;var m=a.subVec3(n,l,s),g=a.dotVec3(m,_);if(g<0||g>f)return null;var v=a.cross3Vec3(m,d,r),x=a.dotVec3(o,v);if(x<0||g+x>f)return null;var M=a.dotVec3(p,v)/f;return c[0]=n[0]+M*o[0],c[1]=n[1]+M*o[1],c[2]=n[2]+M*o[2],c}),a.rayPlaneIntersect=function(){var e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3);return function(r,n,o,l,h,u){u=u||a.vec3(),n=a.normalizeVec3(n,e);var c=a.subVec3(l,o,t),d=a.subVec3(h,o,i),p=a.cross3Vec3(c,d,s);a.normalizeVec3(p,p);var _=-a.dotVec3(o,p),f=-(a.dotVec3(r,p)+_)/a.dotVec3(n,p);return u[0]=r[0]+f*n[0],u[1]=r[1]+f*n[1],u[2]=r[2]+f*n[2],u}}(),a.cartesianToBarycentric=function(){var e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3);return function(s,r,n,o,l){var h=a.subVec3(o,r,e),u=a.subVec3(n,r,t),c=a.subVec3(s,r,i),d=a.dotVec3(h,h),p=a.dotVec3(h,u),_=a.dotVec3(h,c),f=a.dotVec3(u,u),m=a.dotVec3(u,c),g=d*f-p*p;if(0===g)return null;var v=1/g,x=(f*_-p*m)*v,M=(d*m-p*_)*v;return l[0]=1-x-M,l[1]=M,l[2]=x,l}}(),a.barycentricInsideTriangle=function(e){var t=e[1],i=e[2];return i>=0&&t>=0&&i+t<1},a.barycentricToCartesian=function(e,t,i,s,r){r=r||a.vec3();var n=e[0],o=e[1],l=e[2];return r[0]=t[0]*n+i[0]*o+s[0]*l,r[1]=t[1]*n+i[1]*o+s[1]*l,r[2]=t[2]*n+i[2]*o+s[2]*l,r},a.mergeVertices=function(e,t,i,s){var r,a,n,o,l,h,u={},c=[],d=[],p=t?[]:null,_=i?[]:null,f=[],m=Math.pow(10,4),g=0;for(l=0,h=e.length;l<h;l+=3)r=e[l],a=e[l+1],n=e[l+2],void 0===u[o=Math.round(r*m)+"_"+Math.round(a*m)+"_"+Math.round(n*m)]&&(u[o]=d.length/3,d.push(r),d.push(a),d.push(n),t&&(p.push(t[l]),p.push(t[l+1]),p.push(t[l+2])),i&&(_.push(i[g]),_.push(i[g+1]))),c[l/3]=u[o],g+=2;for(l=0,h=s.length;l<h;l++)f[l]=c[s[l]];var v={positions:d,indices:f};return p&&(v.normals=p),_&&(v.uv=_),v}}(),function(){"use strict";var e,t,i,s,r,a,n,o,l,h,u,c,d,p=xeogl.math;p.buildNormals=(e=p.vec3(),t=p.vec3(),i=p.vec3(),s=p.vec3(),r=p.vec3(),a=p.vec3(),function(n,o,l){var h,u,c,d,_,f,m,g,v,x=new Array(n.length/3);for(h=0,u=o.length;h<u;h+=3){c=o[h],d=o[h+1],_=o[h+2],e[0]=n[3*c],e[1]=n[3*c+1],e[2]=n[3*c+2],t[0]=n[3*d],t[1]=n[3*d+1],t[2]=n[3*d+2],i[0]=n[3*_],i[1]=n[3*_+1],i[2]=n[3*_+2],p.subVec3(t,e,s),p.subVec3(i,e,r);var M=p.vec3();p.normalizeVec3(p.cross3Vec3(s,r,a),M),x[c]||(x[c]=[]),x[d]||(x[d]=[]),x[_]||(x[_]=[]),x[c].push(M),x[d].push(M),x[_].push(M)}for(l=l&&l.length===n.length?l:new Float32Array(n.length),h=0,u=x.length;h<u;h++){f=x[h].length,m=0,g=0,v=0;for(var y=0;y<f;y++)m+=x[h][y][0],g+=x[h][y][1],v+=x[h][y][2];l[3*h]=m/f,l[3*h+1]=g/f,l[3*h+2]=v/f}return l}),p.buildTangents=(n=new Float32Array(3),o=new Float32Array(3),l=new Float32Array(3),h=new Float32Array(3),u=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),function(e,t,i){for(var s=new Float32Array(e.length),r=0;r<t.length;r+=3){var a=t[r],_=e.subarray(3*a,3*a+3),f=i.subarray(2*a,2*a+2);a=t[r+1];var m=e.subarray(3*a,3*a+3),g=i.subarray(2*a,2*a+2);a=t[r+2];for(var v,x=e.subarray(3*a,3*a+3),M=i.subarray(2*a,2*a+2),y=p.subVec3(m,_,n),b=p.subVec3(x,_,o),w=p.subVec2(g,f,l),A=p.subVec2(M,f,h),E=1/(w[0]*A[1]-w[1]*A[0]),C=p.mulVec3Scalar(p.subVec3(p.mulVec3Scalar(y,A[1],u),p.mulVec3Scalar(b,w[1],c),d),E,c),P=0;P<3;P++)s[v=3*t[r+P]]+=C[0],s[v+1]+=C[1],s[v+2]+=C[2]}return s}),p.buildPickTriangles=function(e,t,i){for(var s,r,a,n,o,l=t.length,h=i?new Uint16Array(9*l):new Float32Array(9*l),u=new Uint8Array(12*l),c=0,d=0,p=0,_=0;_<l;_+=3)o=c>>24&255,n=c>>16&255,a=c>>8&255,r=255&c,s=3*t[_],h[d++]=e[s],h[d++]=e[s+1],h[d++]=e[s+2],u[p++]=r,u[p++]=a,u[p++]=n,u[p++]=o,s=3*t[_+1],h[d++]=e[s],h[d++]=e[s+1],h[d++]=e[s+2],u[p++]=r,u[p++]=a,u[p++]=n,u[p++]=o,s=3*t[_+2],h[d++]=e[s],h[d++]=e[s+1],h[d++]=e[s+2],u[p++]=r,u[p++]=a,u[p++]=n,u[p++]=o,c++;return{positions:h,colors:u}},p.faceToVertexNormals=function(e,t,i){var s,r,a,n,o,l,h,u,c,d,_,f=(i=i||{}).smoothNormalsAngleThreshold||20,m={},g=[],v={},x=Math.pow(10,4);for(h=0,c=e.length;h<c;h+=3){l=h/3,r=e[h],a=e[h+1],n=e[h+2],void 0===m[o=Math.round(r*x)+"_"+Math.round(a*x)+"_"+Math.round(n*x)]?m[o]=[l]:m[o].push(l);var M=p.normalizeVec3([t[h],t[h+1],t[h+2]]);g[l]=M,s=p.vec4([M[0],M[1],M[2],1]),v[l]=s}for(o in m)if(m.hasOwnProperty(o)){var y=m[o],b=y.length;for(h=0;h<b;h++){var w=y[h];for(s=v[w],u=0;u<b;u++)if(h!==u){var A=y[u];d=g[w],_=g[A],Math.abs(p.angleVec3(d,_)/p.DEGTORAD)<f&&(s[0]+=_[0],s[1]+=_[1],s[2]+=_[2],s[3]+=1)}}}for(h=0,c=t.length;h<c;h+=3)s=v[h/3],t[h+0]=s[0]/s[3],t[h+1]=s[1]/s[3],t[h+2]=s[2]/s[3]}}(),function(){"use strict";var e=xeogl.math;e.tangentQuadraticBezier=function(e,t,i,s){return 2*(1-e)*(i-t)+2*e*(s-i)},e.tangentQuadraticBezier=function(e,t,i,s,r){return-3*t*(1-e)*(1-e)+3*i*(1-e)*(1-e)-6*e*i*(1-e)+6*e*s*(1-e)-3*e*e*s+3*e*e*r},e.tangentSpline=function(e){return 6*e*e-6*e+(3*e*e-4*e+1)+(-6*e*e+6*e)+(3*e*e-2*e)},e.catmullRomInterpolate=function(e,t,i,s,r){var a=.5*(i-e),n=.5*(s-t),o=r*r;return(2*t-2*i+a+n)*(r*o)+(-3*t+3*i-2*a-n)*o+a*r+t},e.b2p0=function(e,t){var i=1-e;return i*i*t},e.b2p1=function(e,t){return 2*(1-e)*e*t},e.b2p2=function(e,t){return e*e*t},e.b2=function(e,t,i,s){return this.b2p0(e,t)+this.b2p1(e,i)+this.b2p2(e,s)},e.b3p0=function(e,t){var i=1-e;return i*i*i*t},e.b3p1=function(e,t){var i=1-e;return 3*i*i*e*t},e.b3p2=function(e,t){return 3*(1-e)*e*e*t},e.b3p3=function(e,t){return e*e*e*t},e.b3=function(e,t,i,s,r){return this.b3p0(e,t)+this.b3p1(e,i)+this.b3p2(e,s)+this.b3p3(e,r)}}(),function(){"use strict";var e,t,i,s,r,a,n,o,l=xeogl.math;l.canvasPosToWorldRay=(e=l.mat4(),t=l.mat4(),i=l.vec4(),s=l.vec4(),r=l.vec4(),a=l.vec4(),function(n,o,h,u){var c=n.scene.canvas.canvas,d=n.viewMatrix,p="ortho"===n.projection?n.ortho.matrix:n.perspective.matrix,_=l.mulMat4(p,d,e),f=l.inverseMat4(_,t),m=c.width,g=c.height,v=(o[0]-m/2)/(m/2),x=-(o[1]-g/2)/(g/2);i[0]=v,i[1]=x,i[2]=-1,i[3]=1,l.transformVec4(f,i,s),l.mulVec4Scalar(s,1/s[3]),r[0]=v,r[1]=x,r[2]=1,r[3]=1,l.transformVec4(f,r,a),l.mulVec4Scalar(a,1/a[3]),h[0]=a[0],h[1]=a[1],h[2]=a[2],l.subVec3(a,s,u),l.normalizeVec3(u)}),l.canvasPosToLocalRay=(n=l.vec3(),o=l.vec3(),function(e,t,i,s,r){l.canvasPosToWorldRay(e,i,n,o),l.worldRayToLocalRay(t,n,o,s,r)}),l.worldRayToLocalRay=function(){var e=l.mat4(),t=l.vec4(),i=l.vec4();return function(s,r,a,n,o){var h=s.worldMatrix||s.matrix,u=l.inverseMat4(h,e);t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=1,l.transformVec4(u,t,i),n[0]=i[0],n[1]=i[1],n[2]=i[2],l.transformVec3(u,a,o)}}()}(),function(){"use strict";var e=10,t=20;xeogl.math.buildKDTree=function(s,r){for(var a=s.length/3,n=new Array(a),o=0;o<a;++o)n[o]=o;return function s(r,a,n,o){var l=new Float32Array(6);var h={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:l};l[0]=l[1]=l[2]=Number.POSITIVE_INFINITY;l[3]=l[4]=l[5]=Number.NEGATIVE_INFINITY;var u,c;for(u=0,c=r.length;u<c;++u)for(var d=3*r[u],p=0;p<3;++p){var _=3*a[d+p];n[_]<l[0]&&(l[0]=n[_]),n[_]>l[3]&&(l[3]=n[_]),n[_+1]<l[1]&&(l[1]=n[_+1]),n[_+1]>l[4]&&(l[4]=n[_+1]),n[_+2]<l[2]&&(l[2]=n[_+2]),n[_+2]>l[5]&&(l[5]=n[_+2])}if(r.length<t||o>e)return h.triangles=r,h.leaf=!0,h;i[0]=l[3]-l[0];i[1]=l[4]-l[1];i[2]=l[5]-l[2];var f=0;i[1]>i[f]&&(f=1);i[2]>i[f]&&(f=2);h.splitDim=f;var m=(l[f]+l[f+3])/2;var g=new Array(r.length);var v=0;var x=new Array(r.length);var M=0;for(u=0,c=r.length;u<c;++u){var d=3*r[u],y=a[d],b=a[d+1],w=a[d+2],A=3*y,E=3*b,C=3*w;n[A+f]<=m||n[E+f]<=m||n[C+f]<=m?g[v++]=r[u]:x[M++]=r[u]}g.length=v;x.length=M;h.left=s(g,a,n,o+1);h.right=s(x,a,n,o+1);return h}(n,s,r,0)};var i=new Float32Array}(),xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Renderer=function(e,t,i){"use strict";i=i||{},e=e||{};var s=new xeogl.renderer.Frame,r=t.canvas.canvas,a=t.canvas.gl,n=!0===i.transparent,o=[],l=0,h=[],u=0,c=!0,d=!0,p=!0;this.imageForceDirty=!0;var _=!0,f=null,m=null;function g(){c&&(!function(){for(var e in l=0,t.meshes)t.meshes.hasOwnProperty(e)&&(o[l++]=t.meshes[e]);for(var i=l,s=o.length;i<s;i++)o[i]=null;o.length=l}(),c=!1,d=!0),d&&(o.sort(xeogl.Mesh._compareState),d=!1,p=!0)}this.meshListDirty=function(){c=!0,d=!0},this.needStateSort=function(){d=!0},this.shadowsDirty=function(){!0},this.imageDirty=function(){p=!0},this.setImageForceDirty=function(){this.imageForceDirty=!0},this.setBlendOneMinusSrcAlpha=function(e){_=e},this.webglContextLost=function(){},this.webglContextRestored=function(e){f&&f.webglContextRestored(e),m&&m.webglContextRestored(e),p=!0},this.clear=function(e){e=e||{};var i=t.viewport.boundary;if(a.viewport(i[0],i[1],i[2],i[3]),n)a.clearColor(0,0,0,0);else{var s=e.ambientColor||this.lights.getAmbientColor();a.clearColor(s[0],s[1],s[2],1)}a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT)},this.render=function(t){t=t||{},g(),(p||this.imageForceDirty||t.force)&&(q(t),e.frame.frameCount++,p=!1,this.imageForceDirty=!1)};var v,x,M,y,b,w,A,E,C,P,S,D,T,F,B,L,R,k,I,V,N,U,O,G,z,j,W,Y,X,H,q=(v=[],x=[],M=[],y=[],b=[],w=[],A=[],E=[],C=[],P=[],S=[],D=[],T=[],F=[],B=[],L=[],R=[],k=[],I=[],V=[],N=[],U=[],O=[],G=[],z=0,function(i){xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&a.getExtension("OES_element_index_uint"),xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_standard_derivatives&&a.getExtension("OES_standard_derivatives");var r=t._lightsState.getAmbientColor();s.reset(),s.pass=i.pass;var h,u,c,d,p,f=t.viewport.boundary;a.viewport(f[0],f[1],f[2],f[3]),n?a.clearColor(0,0,0,0):a.clearColor(r[0],r[1],r[2],1),a.enable(a.DEPTH_TEST),a.frontFace(a.CCW),a.enable(a.CULL_FACE),a.depthMask(!0);var m=Date.now();!1!==i.clear&&a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT);var g=0,j=0,W=0,Y=0,X=0,H=0,q=0,K=0,Q=0,Z=0,J=0,$=0,ee=0,te=0,ie=0,se=0,re=0,ae=0,ne=0,oe=0,le=0,he=0,ue=0;for(z=0,h=0,u=l;h<u;h++)if(d=(c=o[h])._state,p=c._material._state,!0!==d.culled&&!1!==d.visible&&0!==p.alpha){if(d.ghosted){var ce=c._ghostMaterial._state;ce.edges&&(ce.edgeAlpha<1?w[H++]=c:M[W++]=c),ce.vertices&&(ce.vertexAlpha<1?b[X++]=c:x[j++]=c),ce.fill&&(ce.fillAlpha<1?y[Y++]=c:v[g++]=c)}else 2===p.alphaMode||d.xray||d.colorize[3]<1?G[z++]=c:d.outlined?N[q++]=c:c._draw(s);if(d.selected){var de=c._selectedMaterial._state;de.edges&&(de.edgeAlpha<1?k[le++]=c:B[ae++]=c),de.vertices&&(de.vertexAlpha<1?R[oe++]=c:F[re++]=c),de.fill&&(de.fillAlpha<1?L[ne++]=c:T[se++]=c),d.selected&&(O[Q++]=c)}if(d.highlighted){var pe=c._highlightMaterial._state;pe.edges&&(pe.edgeAlpha<1?D[ie++]=c:C[$++]=c),pe.vertices&&(pe.vertexAlpha<1?S[te++]=c:E[J++]=c),pe.fill&&(pe.fillAlpha<1?P[ee++]=c:A[Z++]=c),d.highlighted&&(U[K++]=c)}d.edges&&(c._edgeMaterial._state.edgeAlpha<1?V[ue++]=c:I[he++]=c)}if(q>0){for(a.enable(a.STENCIL_TEST),a.stencilFunc(a.ALWAYS,1,1),a.stencilOp(a.KEEP,a.KEEP,a.REPLACE),a.stencilMask(1),a.clearStencil(0),a.clear(a.STENCIL_BUFFER_BIT),h=0;h<q;h++)N[h]._draw(s);for(a.stencilFunc(a.EQUAL,0,1),a.stencilOp(a.KEEP,a.KEEP,a.KEEP),a.stencilMask(0),a.disable(a.CULL_FACE),h=0;h<q;h++)N[h]._drawOutline(s);a.disable(a.STENCIL_TEST)}if(he>0)for(h=0;h<he;h++)I[h]._drawEdges(s);if(g>0)for(h=0;h<g;h++)v[h]._drawGhostFill(s);if(W>0)for(h=0;h<W;h++)M[h]._drawGhostEdges(s);if(j>0)for(h=0;h<j;h++)x[h]._drawGhostVertices(s);if(Y>0||H>0||X>0||z>0){if(a.enable(a.CULL_FACE),a.enable(a.BLEND),_?a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA):(a.blendEquation(a.FUNC_ADD),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA)),s.backfaces=!1,X>0)for(h=0;h<X;h++)b[h]._drawGhostVertices(s);if(H>0)for(h=0;h<H;h++)w[h]._drawGhostEdges(s);if(Y>0)for(h=0;h<Y;h++)y[h]._drawGhostFill(s);for(q=0,h=0;h<z;h++)(c=G[h])._state.outlined?N[q++]=c:c._draw(s);a.disable(a.BLEND)}if(Z>0||$>0||J>0){if(s.lastProgramId=null,a.clear(a.DEPTH_BUFFER_BIT),J>0)for(h=0;h<J;h++)E[h]._drawHighlightVertices(s);if($>0)for(h=0;h<$;h++)C[h]._drawHighlightEdges(s);if(Z>0)for(h=0;h<Z;h++)A[h]._drawHighlightFill(s)}if(ee>0||ie>0||te>0){if(s.lastProgramId=null,a.clear(a.DEPTH_BUFFER_BIT),a.enable(a.CULL_FACE),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),te>0)for(h=0;h<te;h++)S[h]._drawHighlightVertices(s);if(ie>0)for(h=0;h<ie;h++)D[h]._drawHighlightEdges(s);if(ee>0)for(h=0;h<ee;h++)P[h]._drawHighlightFill(s);a.disable(a.BLEND)}if(se>0||ae>0||re>0){if(s.lastProgramId=null,a.clear(a.DEPTH_BUFFER_BIT),re>0)for(h=0;h<re;h++)F[h]._drawSelectedVertices(s);if(ae>0)for(h=0;h<ae;h++)B[h]._drawSelectedEdges(s);if(se>0)for(h=0;h<se;h++)T[h]._drawSelectedFill(s)}if(ne>0||le>0||oe>0){if(s.lastProgramId=null,a.clear(a.DEPTH_BUFFER_BIT),a.enable(a.CULL_FACE),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),oe>0)for(h=0;h<oe;h++)R[h]._drawSelectedVertices(s);if(le>0)for(h=0;h<le;h++)k[h]._drawSelectedEdges(s);if(ne>0)for(h=0;h<ne;h++)L[h]._drawSelectedFill(s);a.disable(a.BLEND)}var _e=Date.now(),fe=e.frame;fe.renderTime=(_e-m)/1e3,fe.drawElements=s.drawElements,fe.drawElements=s.drawElements,fe.useProgram=s.useProgram,fe.bindTexture=s.bindTexture,fe.bindArray=s.bindArray;for(var me=xeogl.WEBGL_INFO.MAX_TEXTURE_UNITS,ge=0;ge<me;ge++)a.activeTexture(a.TEXTURE0+ge);a.bindTexture(a.TEXTURE_CUBE_MAP,null),a.bindTexture(a.TEXTURE_2D,null)});this.pick=(j=xeogl.math,W=j.vec3(),Y=j.mat4(),X=j.vec3([0,1,0]),H=j.frustumMat4(-1,1,-1,1,.1,1e4),function(e){var i,n,c,d,p;g(),xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&a.getExtension("OES_element_index_uint");var _=null,m=null;e.canvasPos?(i=e.canvasPos[0],n=e.canvasPos[1]):(c=e.origin||j.vec3([0,0,0]),d=e.direction||j.vec3([0,0,1]),p=j.addVec3(c,d,W),_=j.lookAtMat4v(c,p,X,Y),m=H,i=.5*r.clientWidth,n=.5*r.clientHeight),(f=f||new xeogl.renderer.RenderBuffer(r,a)).bind();var v=function(e,i,r,n,c){s.reset(),s.backfaces=!0,s.frontface=!0,s.pickViewMatrix=r,s.pickProjMatrix=n,s.pickMeshIndex=1;var d,p,_,m=t.viewport.boundary;a.viewport(m[0],m[1],m[2],m[3]),a.clearColor(0,0,0,0),a.enable(a.DEPTH_TEST),a.disable(a.CULL_FACE),a.disable(a.BLEND),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),u=0;var g=c.includeMeshIds,v=c.excludeMeshIds;for(d=0,p=l;d<p;d++)!0!==(_=o[d])._state.culled&&!1!==_._state.visible&&!1!==_._state.pickable&&(g&&!g[_.id]||v&&v[_.id]||(h[u++]=_,_._pickMesh(s)));var x=f.read(Math.round(e),Math.round(i)),M=x[0]+256*x[1]+256*x[2]*256+256*x[3]*256*256;return--M>=0?h[M]:null}(i,n,_,m,e);if(!v)return f.unbind(),null;var x={mesh:v};return e.pickSurface&&(x.primIndex=function(e,i,r,n,o){s.reset(),s.backfaces=!0,s.frontface=!0,s.pickViewMatrix=n,s.pickProjMatrix=o;var l=t.viewport.boundary;a.viewport(l[0],l[1],l[2],l[3]),a.clearColor(0,0,0,0),a.enable(a.DEPTH_TEST),a.disable(a.CULL_FACE),a.disable(a.BLEND),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),e._pickTriangle(s);var h=f.read(i,r),u=h[0]+256*h[1]+256*h[2]*256+256*h[3]*256*256;return u*=3}(v,i,n,_,m)),_&&(x.origin=c,x.direction=d),f.unbind(),x}),this.readPixels=function(e,t,i,s){var n,o,l,h;for((m=m||(m=new xeogl.renderer.RenderBuffer(r,a))).bind(),m.clear(),this.render({force:!0,opaqueOnly:s}),o=0;o<i;o++)l=2*o,h=4*o,n=m.read(e[l],e[l+1]),t[h]=n[0],t[h+1]=n[1],t[h+2]=n[2],t[h+3]=n[3];m.unbind(),p=!0},this.destroy=function(){f&&f.destroy(),m&&m.destroy()}},xeogl.renderer.webgl={enums:{funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"}},xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Frame=function(){this.reset()},xeogl.renderer.Frame.prototype.reset=function(){this.lastProgramId=null,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickmeshIndex=1},function(){"use strict";var e=new xeogl.utils.Map({});function t(e){for(var t,i,s=[],r=0,a=e.length;r<a;r++)(i=(t=e[r]).indexOf("/"))>0&&"/"===t.charAt(i+1)&&(t=t.substring(0,i)),s.push(t);return s.join("\n")}xeogl.renderer.Program=function(t,i){this.id=e.addItem({}),this.source=i,this.init(t)},xeogl.renderer.Program.prototype.init=function(e){var i,s,r,a,n;if(this.gl=e,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new xeogl.renderer.Shader(e,e.VERTEX_SHADER,t(this.source.vertex)),this._fragmentShader=new xeogl.renderer.Shader(e,e.FRAGMENT_SHADER,t(this.source.fragment)),this._vertexShader.allocated)if(this._fragmentShader.allocated)if(this.allocated=!0,this._vertexShader.compiled)if(this._fragmentShader.compiled)if(this.compiled=!0,this.handle=e.createProgram(),this.handle){if(e.attachShader(this.handle,this._vertexShader.handle),e.attachShader(this.handle,this._fragmentShader.handle),e.linkProgram(this.handle),this.linked=e.getProgramParameter(this.handle,e.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(e.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(shaderSource.vertex),this.errors.push("\nFragment shader:\n"),void(this.errors=this.errors.concat(shaderSource.fragment));var o=e.getProgramParameter(this.handle,e.ACTIVE_UNIFORMS);for(s=0;s<o;++s)(r=e.getActiveUniform(this.handle,s))&&("\0"===(a=r.name)[a.length-1]&&(a=a.substr(0,a.length-1)),n=e.getUniformLocation(this.handle,a),r.type===e.SAMPLER_2D||r.type===e.SAMPLER_CUBE||35682===r.type?this.samplers[a]=new xeogl.renderer.Sampler(e,n):this.uniforms[a]=n);var l=e.getProgramParameter(this.handle,e.ACTIVE_ATTRIBUTES);for(s=0;s<l;s++)(i=e.getActiveAttrib(this.handle,s))&&(n=e.getAttribLocation(this.handle,i.name),this.attributes[i.name]=new xeogl.renderer.Attribute(e,n));this.allocated=!0}else this.errors=["Failed to allocate program"];else this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors);else this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors);else this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors);else this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors)},xeogl.renderer.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},xeogl.renderer.Program.prototype.getLocation=function(e){if(this.allocated)return this.uniforms[e]},xeogl.renderer.Program.prototype.getAttribute=function(e){if(this.allocated)return this.attributes[e]},xeogl.renderer.Program.prototype.bindTexture=function(e,t,i){if(!this.allocated)return!1;var s=this.samplers[e];return!!s&&s.bindTexture(t,i)},xeogl.renderer.Program.prototype.destroy=function(){this.allocated&&(e.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}(),xeogl.renderer.Sampler=function(e,t){this.bindTexture=function(i,s){return!!i.bind(s)&&(e.uniform1i(t,s),!0)}},xeogl.renderer.Shader=function(e,t,i){if(this.allocated=!1,this.compiled=!1,this.handle=e.createShader(t),this.handle){if(this.allocated=!0,e.shaderSource(this.handle,i),e.compileShader(this.handle),this.compiled=e.getShaderParameter(this.handle,e.COMPILE_STATUS),!this.compiled&&!e.isContextLost()){for(var s=i.split("\n"),r=[],a=0;a<s.length;a++)r.push(a+1+": "+s[a]+"\n");this.errors=[],this.errors.push(""),this.errors.push(e.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(r.join(""))}}else this.errors=["Failed to allocate"]},xeogl.renderer.Shader.prototype.destroy=function(){},function(){var e=new xeogl.utils.Map({});xeogl.renderer.State=function(t){for(var i in this.id=e.addItem({}),t)t.hasOwnProperty(i)&&(this[i]=t[i])},xeogl.renderer.State.prototype.destroy=function(){e.removeItem(this.id)}}(),xeogl.renderer.Texture2D=function(e,t){this.gl=e,this.target=t||e.TEXTURE_2D,this.texture=e.createTexture(),this.setPreloadColor([0,0,0,0]),this.allocated=!0},xeogl.renderer.Texture2D.prototype.setPreloadColor=function(){var e=new Uint8Array([0,0,0,1]);return function(t){t?(e[0]=Math.floor(255*t[0]),e[1]=Math.floor(255*t[1]),e[2]=Math.floor(255*t[2]),e[3]=Math.floor(255*(void 0!==t[3]?t[3]:1))):(e[0]=0,e[1]=0,e[2]=0,e[3]=255);var i=this.gl;if(i.bindTexture(this.target,this.texture),i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,i.NEAREST),this.target===i.TEXTURE_CUBE_MAP)for(var s=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z],r=0,a=s.length;r<a;r++)i.texImage2D(s[r],0,i.RGBA,1,1,0,i.RGBA,i.UNSIGNED_BYTE,e);else i.texImage2D(this.target,0,i.RGBA,1,1,0,i.RGBA,i.UNSIGNED_BYTE,e);i.bindTexture(this.target,null)}}(),xeogl.renderer.Texture2D.prototype.setTarget=function(e){this.target=e||this.gl.TEXTURE_2D},xeogl.renderer.Texture2D.prototype.setImage=function(e,t){var i=this.gl;if(i.bindTexture(this.target,this.texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,t.flipY),this.target===i.TEXTURE_CUBE_MAP){if(xeogl._isArray(e))for(var s=e,r=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z],a=0,n=r.length;a<n;a++)i.texImage2D(r[a],0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,s[a])}else i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e);i.bindTexture(this.target,null)},xeogl.renderer.Texture2D.prototype.setProps=function(e){var t=this.gl;if(t.bindTexture(this.target,this.texture),e.minFilter){var i=this._getGLEnum(e.minFilter);i&&(t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,i),i!==t.NEAREST_MIPMAP_NEAREST&&i!==t.LINEAR_MIPMAP_NEAREST&&i!==t.NEAREST_MIPMAP_LINEAR&&i!==t.LINEAR_MIPMAP_LINEAR||t.generateMipmap(this.target))}if(e.magFilter){var s=this._getGLEnum(e.magFilter);s&&t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,s)}if(e.wrapS){var r=this._getGLEnum(e.wrapS);r&&t.texParameteri(this.target,t.TEXTURE_WRAP_S,r)}if(e.wrapT){var a=this._getGLEnum(e.wrapT);a&&t.texParameteri(this.target,t.TEXTURE_WRAP_T,a)}t.bindTexture(this.target,null)},xeogl.renderer.Texture2D.prototype._getGLEnum=function(e,t){if(void 0===e)return t;var i=xeogl.renderer.webgl.enums[e];return void 0===i?t:this.gl[i]},xeogl.renderer.Texture2D.prototype.bind=function(e){if(this.allocated){if(this.texture){var t=this.gl;return t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,this.texture),!0}return!1}},xeogl.renderer.Texture2D.prototype.unbind=function(e){if(this.allocated&&this.texture){var t=this.gl;t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,null)}},xeogl.renderer.Texture2D.prototype.destroy=function(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)},xeogl.renderer.clampImageSize=function(e,t){var i=e.width*e.height;if(i>t){var s=t/i,r=e.width*s,a=e.height*s,n=document.createElement("canvas");n.width=xeogl.renderer.nextHighestPowerOfTwo(r),n.height=xeogl.renderer.nextHighestPowerOfTwo(a),n.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,n.width,n.height),e=n}return e},xeogl.renderer.ensureImageSizePowerOfTwo=function(e){if(!xeogl.renderer.isPowerOfTwo(e.width)||!xeogl.renderer.isPowerOfTwo(e.height)){var t=document.createElement("canvas");t.width=xeogl.renderer.nextHighestPowerOfTwo(e.width),t.height=xeogl.renderer.nextHighestPowerOfTwo(e.height),t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e},xeogl.renderer.isPowerOfTwo=function(e){return 0==(e&e-1)},xeogl.renderer.nextHighestPowerOfTwo=function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1},xeogl.renderer.ArrayBuffer=function(e,t,i,s,r,a){switch(this._gl=e,this.type=t,this.allocated=!1,i.constructor){case Uint8Array:this.itemType=e.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=e.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=e.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=e.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=e.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=e.INT,this.itemByteSize=4;break;default:this.itemType=e.FLOAT,this.itemByteSize=4}this.usage=a,this.length=0,this.numItems=0,this.itemSize=r,this._allocate(i)},xeogl.renderer.ArrayBuffer.prototype._allocate=function(e){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,e,this.usage),this._gl.bindBuffer(this.type,null),this.length=e.length,this.numItems=this.length/this.itemSize,this.allocated=!0)},xeogl.renderer.ArrayBuffer.prototype.setData=function(e,t){this.allocated&&(e.length>this.length?(this.destroy(),this._allocate(e,e.length)):(this._gl.bindBuffer(this.type,this._handle),t||0===t?this._gl.bufferSubData(this.type,t*this.itemByteSize,e):this._gl.bufferData(this.type,e,this.usage),this._gl.bindBuffer(this.type,null)))},xeogl.renderer.ArrayBuffer.prototype.bind=function(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)},xeogl.renderer.ArrayBuffer.prototype.unbind=function(){this.allocated&&this._gl.bindBuffer(this.type,null)},xeogl.renderer.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)},xeogl.renderer.Attribute=function(e,t){this._gl=e,this.location=t},xeogl.renderer.Attribute.prototype.bindArrayBuffer=function(e,t){e&&(e.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,t===this._gl.BYTE?2:e.itemSize,t||this._gl.FLOAT,t===this._gl.BYTE,0,0))},xeogl.renderer.RenderBuffer=function(e,t,i){i=i||{},this.gl=t,this.allocated=!1,this.canvas=e,this.buffer=null,this.bound=!1,this.size=i.size},xeogl.renderer.RenderBuffer.prototype.setSize=function(e){this.size=e},xeogl.renderer.RenderBuffer.prototype.webglContextRestored=function(e){this.gl=e,this.buffer=null,this.allocated=!1,this.bound=!1},xeogl.renderer.RenderBuffer.prototype.bind=function(){if(this._touch(),!this.bound){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}},xeogl.renderer.RenderBuffer.prototype._touch=function(){var e,t,i=this.gl;if(this.size?(e=this.size[0],t=this.size[1]):(e=this.canvas.clientWidth,t=this.canvas.clientHeight),this.buffer){if(this.buffer.width===e&&this.buffer.height===t)return;i.deleteTexture(this.buffer.texture),i.deleteFramebuffer(this.buffer.framebuf),i.deleteRenderbuffer(this.buffer.renderbuf)}var s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);var r=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,r),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,t);var a=i.createFramebuffer();if(i.bindFramebuffer(i.FRAMEBUFFER,a),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,s,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,r),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,a),!i.isFramebuffer(a))throw"Invalid framebuffer";i.bindFramebuffer(i.FRAMEBUFFER,null);var n=i.checkFramebufferStatus(i.FRAMEBUFFER);switch(n){case i.FRAMEBUFFER_COMPLETE:break;case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case i.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+n}this.buffer={framebuf:a,renderbuf:r,texture:s,width:e,height:t},this.bound=!1},xeogl.renderer.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";var e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)},xeogl.renderer.RenderBuffer.prototype.read=function(e,t){var i=e,s=this.canvas.height-t,r=new Uint8Array(4),a=this.gl;return a.readPixels(i,s,1,1,a.RGBA,a.UNSIGNED_BYTE,r),r},xeogl.renderer.RenderBuffer.prototype.unbind=function(){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this.bound=!1},xeogl.renderer.RenderBuffer.prototype.getTexture=function(){var e=this;return{renderBuffer:this,bind:function(t){return!(!e.buffer||!e.buffer.texture)&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.texture),!0)},unbind:function(t){e.buffer&&e.buffer.texture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}}},xeogl.renderer.RenderBuffer.prototype.destroy=function(){if(this.allocated){var e=this.gl;e.deleteTexture(this.buffer.texture),e.deleteFramebuffer(this.buffer.framebuf),e.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}},function(){"use strict";var e=new xeogl.utils.Map({});xeogl.renderer.DrawRenderer=function(t,i){this.id=e.addItem({}),this._hash=t,this._scene=i.scene,this._useCount=0,this._shaderSource=new xeogl.renderer.DrawShaderSource(i),this._allocate(i)};var t={};xeogl.renderer.DrawRenderer.get=function(e){var i=e.scene,s=[i.canvas.canvas.id,(i.gammaInput?"gi;":";")+(i.gammaOutput?"go":""),i._lightsState.getHash(),i._clipsState.getHash(),e._geometry._state.hash,e._material._state.hash,e._state.hash].join(";"),r=t[s];if(!r){if((r=new xeogl.renderer.DrawRenderer(s,e)).errors)return console.log(r.errors.join("\n")),null;t[s]=r,xeogl.stats.memory.programs++}return r._useCount++,r},xeogl.renderer.DrawRenderer.prototype.put=function(){0==--this._useCount&&(e.removeItem(this.id),this._program&&this._program.destroy(),delete t[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.DrawRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.DrawRenderer.prototype.drawMesh=function(e,t){this._program||this._allocate(t);var i=xeogl.WEBGL_INFO.MAX_TEXTURE_UNITS,s=t.scene,r=t._material,a=s.canvas.gl,n=this._program,o=t._state,l=t._material._state,h=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),l.id!==this._lastMaterialId){e.textureUnit=this._baseTextureUnit;var u=l.backfaces;e.backfaces!==u&&(u?a.disable(a.CULL_FACE):a.enable(a.CULL_FACE),e.backfaces=u);var c=l.frontface;switch(e.frontface!==c&&(c?a.frontFace(a.CCW):a.frontFace(a.CW),e.frontface=c),e.lineWidth!==l.lineWidth&&(a.lineWidth(l.lineWidth),e.lineWidth=l.lineWidth),this._uPointSize&&a.uniform1f(this._uPointSize,l.pointSize),l.type){case"LambertMaterial":this._uMaterialAmbient&&a.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialColor&&a.uniform4f(this._uMaterialColor,l.color[0],l.color[1],l.color[2],l.alpha),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive);break;case"PhongMaterial":this._uMaterialShininess&&a.uniform1f(this._uMaterialShininess,l.shininess),this._uMaterialAmbient&&a.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialDiffuse&&a.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&a.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&a.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0),r._ambientMap&&r._ambientMap._state.texture&&this._uMaterialAmbientMap&&(n.bindTexture(this._uMaterialAmbientMap,r._ambientMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMaterialAmbientMapMatrix&&a.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,r._ambientMap._state.matrix)),r._diffuseMap&&r._diffuseMap._state.texture&&this._uDiffuseMap&&(n.bindTexture(this._uDiffuseMap,r._diffuseMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&a.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,r._diffuseMap._state.matrix)),r._specularMap&&r._specularMap._state.texture&&this._uSpecularMap&&(n.bindTexture(this._uSpecularMap,r._specularMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&a.uniformMatrix4fv(this._uSpecularMapMatrix,!1,r._specularMap._state.matrix)),r._emissiveMap&&r._emissiveMap._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,r._emissiveMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&a.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,r._emissiveMap._state.matrix)),r._alphaMap&&r._alphaMap._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,r._alphaMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&a.uniformMatrix4fv(this._uAlphaMapMatrix,!1,r._alphaMap._state.matrix)),r._reflectivityMap&&r._reflectivityMap._state.texture&&this._uReflectivityMap&&(n.bindTexture(this._uReflectivityMap,r._reflectivityMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._uReflectivityMapMatrix&&a.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,r._reflectivityMap._state.matrix)),r._normalMap&&r._normalMap._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,r._normalMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&a.uniformMatrix4fv(this._uNormalMapMatrix,!1,r._normalMap._state.matrix)),r._occlusionMap&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,r._occlusionMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&a.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,r._occlusionMap._state.matrix)),r._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&a.uniform1f(this._uDiffuseFresnelEdgeBias,r._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&a.uniform1f(this._uDiffuseFresnelCenterBias,r._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&a.uniform3fv(this._uDiffuseFresnelEdgeColor,r._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&a.uniform3fv(this._uDiffuseFresnelCenterColor,r._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&a.uniform1f(this._uDiffuseFresnelPower,r._diffuseFresnel.power)),r._specularFresnel&&(this._uSpecularFresnelEdgeBias&&a.uniform1f(this._uSpecularFresnelEdgeBias,r._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&a.uniform1f(this._uSpecularFresnelCenterBias,r._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&a.uniform3fv(this._uSpecularFresnelEdgeColor,r._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&a.uniform3fv(this._uSpecularFresnelCenterColor,r._specularFresnel.centerColor),this._uSpecularFresnelPower&&a.uniform1f(this._uSpecularFresnelPower,r._specularFresnel.power)),r._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&a.uniform1f(this._uAlphaFresnelEdgeBias,r._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&a.uniform1f(this._uAlphaFresnelCenterBias,r._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&a.uniform3fv(this._uAlphaFresnelEdgeColor,r._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&a.uniform3fv(this._uAlphaFresnelCenterColor,r._alphaFresnel.centerColor),this._uAlphaFresnelPower&&a.uniform1f(this._uAlphaFresnelPower,r._alphaFresnel.power)),r._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&a.uniform1f(this._uReflectivityFresnelEdgeBias,r._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&a.uniform1f(this._uReflectivityFresnelCenterBias,r._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&a.uniform3fv(this._uReflectivityFresnelEdgeColor,r._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&a.uniform3fv(this._uReflectivityFresnelCenterColor,r._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&a.uniform1f(this._uReflectivityFresnelPower,r._reflectivityFresnel.power)),r._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&a.uniform1f(this._uEmissiveFresnelEdgeBias,r._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&a.uniform1f(this._uEmissiveFresnelCenterBias,r._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&a.uniform3fv(this._uEmissiveFresnelEdgeColor,r._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&a.uniform3fv(this._uEmissiveFresnelCenterColor,r._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&a.uniform1f(this._uEmissiveFresnelPower,r._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&a.uniform3fv(this._uBaseColor,l.baseColor),this._uMaterialMetallic&&a.uniform1f(this._uMaterialMetallic,l.metallic),this._uMaterialRoughness&&a.uniform1f(this._uMaterialRoughness,l.roughness),this._uMaterialSpecularF0&&a.uniform1f(this._uMaterialSpecularF0,l.specularF0),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&a.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);var d=r._baseColorMap;d&&d._state.texture&&this._uBaseColorMap&&(n.bindTexture(this._uBaseColorMap,d._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uBaseColorMapMatrix&&a.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,d._state.matrix));var p=r._metallicMap;p&&p._state.texture&&this._uMetallicMap&&(n.bindTexture(this._uMetallicMap,p._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicMapMatrix&&a.uniformMatrix4fv(this._uMetallicMapMatrix,!1,p._state.matrix));var _=r._roughnessMap;_&&_._state.texture&&this._uRoughnessMap&&(n.bindTexture(this._uRoughnessMap,_._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uRoughnessMapMatrix&&a.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,_._state.matrix));var f=r._metallicRoughnessMap;f&&f._state.texture&&this._uMetallicRoughnessMap&&(n.bindTexture(this._uMetallicRoughnessMap,f._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicRoughnessMapMatrix&&a.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,f._state.matrix)),(x=r._emissiveMap)&&x._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,x._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&a.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,x._state.matrix)),(M=r._occlusionMap)&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,M._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&a.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,M._state.matrix)),(y=r._alphaMap)&&y._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,y._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&a.uniformMatrix4fv(this._uAlphaMapMatrix,!1,y._state.matrix)),(b=r._normalMap)&&b._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,b._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&a.uniformMatrix4fv(this._uNormalMapMatrix,!1,b._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&a.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&a.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialGlossiness&&a.uniform1f(this._uMaterialGlossiness,l.glossiness),this._uMaterialReflectivity&&a.uniform1f(this._uMaterialReflectivity,l.reflectivity),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&a.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);var m=r._diffuseMap;m&&m._state.texture&&this._uDiffuseMap&&(n.bindTexture(this._uDiffuseMap,m._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&a.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,m._state.matrix));var g=r._specularMap;g&&g._state.texture&&this._uSpecularMap&&(n.bindTexture(this._uSpecularMap,g._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&a.uniformMatrix4fv(this._uSpecularMapMatrix,!1,g._state.matrix));var v=r._glossinessMap;v&&v._state.texture&&this._uGlossinessMap&&(n.bindTexture(this._uGlossinessMap,v._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uGlossinessMapMatrix&&a.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,v._state.matrix));var x,M,y,b,w=r._specularGlossinessMap;w&&w._state.texture&&this._uSpecularGlossinessMap&&(n.bindTexture(this._uSpecularGlossinessMap,w._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularGlossinessMapMatrix&&a.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,w._state.matrix)),(x=r._emissiveMap)&&x._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,x._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&a.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,x._state.matrix)),(M=r._occlusionMap)&&M._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,M._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&a.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,M._state.matrix)),(y=r._alphaMap)&&y._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,y._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&a.uniformMatrix4fv(this._uAlphaMapMatrix,!1,y._state.matrix)),(b=r._normalMap)&&b._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,b._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&a.uniformMatrix4fv(this._uNormalMapMatrix,!1,b._state.matrix))}this._lastMaterialId=l.id}if(a.uniformMatrix4fv(this._uModelMatrix,a.FALSE,t.worldMatrix),this._uModelNormalMatrix&&a.uniformMatrix4fv(this._uModelNormalMatrix,a.FALSE,t.worldNormalMatrix),this._uClippable&&a.uniform1i(this._uClippable,o.clippable),this._uColorize){var A=o.colorize,E=this._lastColorize;E[0]===A[0]&&E[1]===A[1]&&E[2]===A[2]&&E[3]===A[3]||(a.uniform4fv(this._uColorize,A),E[0]=A[0],E[1]=A[1],E[2]=A[2],E[3]=A[3])}if(h.combined){var C=t._geometry._getVertexBufs();C.id!==this._lastVertexBufsId&&(C.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(C.positionsBuf,C.quantized?a.UNSIGNED_SHORT:a.FLOAT),e.bindArray++),C.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(C.normalsBuf,C.quantized?a.BYTE:a.FLOAT),e.bindArray++),C.uvBuf&&this._aUV&&(this._aUV.bindArrayBuffer(C.uvBuf,h.quantized?a.UNSIGNED_SHORT:a.FLOAT),e.bindArray++),C.colorsBuf&&this._aColor&&(this._aColor.bindArrayBuffer(C.colorsBuf),e.bindArray++),C.flagsBuf&&this._aFlags&&(this._aFlags.bindArrayBuffer(C.flagsBuf,a.UNSIGNED_SHORT),e.bindArray++),this._lastVertexBufsId=C.id)}h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),h.combined?h.indicesBufCombined&&(h.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf,h.quantized?a.UNSIGNED_SHORT:a.FLOAT),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(h.normalsBuf,h.quantized?a.BYTE:a.FLOAT),e.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(h.uvBuf,h.quantized?a.UNSIGNED_SHORT:a.FLOAT),e.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(h.colorsBuf),e.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(h.flagsBuf),e.bindArray++),h.indicesBuf?(h.indicesBuf.bind(),e.bindArray++):h.positions),this._lastGeometryId=h.id),h.combined?h.indicesBufCombined&&(a.drawElements(h.primitive,h.indicesBufCombined.numItems,h.indicesBufCombined.itemType,0),e.drawElements++):h.indicesBuf?(a.drawElements(h.primitive,h.indicesBuf.numItems,h.indicesBuf.itemType,0),e.drawElements++):h.positions&&(a.drawArrays(a.TRIANGLES,0,h.positions.numItems),e.drawArrays++)},xeogl.renderer.DrawRenderer.prototype._allocate=function(e){var t=e.scene.canvas.gl,i=e._material,s=e.scene._lightsState,r=e.scene._clipsState,a=e._material._state;if(this._program=new xeogl.renderer.Program(t,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var n=this._program;this._uPositionsDecodeMatrix=n.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=n.getLocation("uvDecodeMatrix"),this._uModelMatrix=n.getLocation("modelMatrix"),this._uModelNormalMatrix=n.getLocation("modelNormalMatrix"),this._uViewMatrix=n.getLocation("viewMatrix"),this._uViewNormalMatrix=n.getLocation("viewNormalMatrix"),this._uProjMatrix=n.getLocation("projMatrix"),this._uGammaFactor=n.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[];for(var o,l=s.lights,h=0,u=l.length;h<u;h++){switch((o=l[h]).type){case"ambient":this._uLightAmbient[h]=n.getLocation("lightAmbient");break;case"dir":this._uLightColor[h]=n.getLocation("lightColor"+h),this._uLightPos[h]=null,this._uLightDir[h]=n.getLocation("lightDir"+h);break;case"point":this._uLightColor[h]=n.getLocation("lightColor"+h),this._uLightPos[h]=n.getLocation("lightPos"+h),this._uLightDir[h]=null,this._uLightAttenuation[h]=n.getLocation("lightAttenuation"+h);break;case"spot":this._uLightColor[h]=n.getLocation("lightColor"+h),this._uLightPos[h]=n.getLocation("lightPos"+h),this._uLightDir[h]=n.getLocation("lightDir"+h),this._uLightAttenuation[h]=n.getLocation("lightAttenuation"+h)}o.shadow&&(this._uShadowViewMatrix[h]=n.getLocation("shadowViewMatrix"+h),this._uShadowProjMatrix[h]=n.getLocation("shadowProjMatrix"+h))}s.lightMaps.length>0&&(this._uLightMap="lightMap"),s.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uClips=[];for(h=0,u=r.clips.length;h<u;h++)this._uClips.push({active:n.getLocation("clipActive"+h),pos:n.getLocation("clipPos"+h),dir:n.getLocation("clipDir"+h)});switch(this._uPointSize=n.getLocation("pointSize"),a.type){case"LambertMaterial":this._uMaterialColor=n.getLocation("materialColor"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=n.getLocation("materialAmbient"),this._uMaterialDiffuse=n.getLocation("materialDiffuse"),this._uMaterialSpecular=n.getLocation("materialSpecular"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=n.getLocation("materialShininess"),i._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=n.getLocation("ambientMapMatrix")),i._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=n.getLocation("diffuseMapMatrix")),i._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=n.getLocation("specularMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),i._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=n.getLocation("reflectivityMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),i._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=n.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=n.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=n.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=n.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=n.getLocation("diffuseFresnelPower")),i._specularFresnel&&(this._uSpecularFresnelEdgeBias=n.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=n.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=n.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=n.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=n.getLocation("specularFresnelPower")),i._alphaFresnel&&(this._uAlphaFresnelEdgeBias=n.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=n.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=n.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=n.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=n.getLocation("alphaFresnelPower")),i._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=n.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=n.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=n.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=n.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=n.getLocation("reflectivityFresnelPower")),i._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=n.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=n.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=n.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=n.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=n.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=n.getLocation("materialBaseColor"),this._uMaterialMetallic=n.getLocation("materialMetallic"),this._uMaterialRoughness=n.getLocation("materialRoughness"),this._uMaterialSpecularF0=n.getLocation("materialSpecularF0"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),i._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=n.getLocation("baseColorMapMatrix")),i._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=n.getLocation("metallicMapMatrix")),i._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=n.getLocation("roughnessMapMatrix")),i._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=n.getLocation("metallicRoughnessMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=n.getLocation("materialDiffuse"),this._uMaterialSpecular=n.getLocation("materialSpecular"),this._uMaterialGlossiness=n.getLocation("materialGlossiness"),this._uMaterialReflectivity=n.getLocation("reflectivityFresnel"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),i._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=n.getLocation("diffuseMapMatrix")),i._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=n.getLocation("specularMapMatrix")),i._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=n.getLocation("glossinessMapMatrix")),i._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=n.getLocation("materialSpecularGlossinessMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix"))}this._aPosition=n.getAttribute("position"),this._aNormal=n.getAttribute("normal"),this._aUV=n.getAttribute("uv"),this._aColor=n.getAttribute("color"),this._aFlags=n.getAttribute("flags"),this._uClippable=n.getLocation("clippable"),this._uColorize=n.getLocation("colorize"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0}},xeogl.renderer.DrawRenderer.prototype._bindProgram=function(e){xeogl.math;var t,i=xeogl.WEBGL_INFO.MAX_TEXTURE_UNITS,s=this._scene,r=s.canvas.gl,a=s._lightsState,n=s._clipsState,o=(a.lights,this._program);o.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1;var l=s.camera,h=l._state;r.uniformMatrix4fv(this._uViewMatrix,!1,h.matrix),r.uniformMatrix4fv(this._uViewNormalMatrix,!1,h.normalMatrix),r.uniformMatrix4fv(this._uProjMatrix,!1,l._project._state.matrix);for(var u=0,c=a.lights.length;u<c;u++)if(t=a.lights[u],this._uLightAmbient[u])r.uniform4f(this._uLightAmbient[u],t.color[0],t.color[1],t.color[2],t.intensity);else if(this._uLightColor[u]&&r.uniform4f(this._uLightColor[u],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[u]&&(r.uniform3fv(this._uLightPos[u],t.pos),this._uLightAttenuation[u]&&r.uniform1f(this._uLightAttenuation[u],t.attenuation)),this._uLightDir[u]&&r.uniform3fv(this._uLightDir[u],t.dir),t.shadow){this._uShadowViewMatrix[u]&&r.uniformMatrix4fv(this._uShadowViewMatrix[u],!1,t.getShadowViewMatrix()),this._uShadowProjMatrix[u]&&r.uniformMatrix4fv(this._uShadowProjMatrix[u],!1,t.getShadowProjMatrix());var d=t.getShadowRenderBuf();d&&(o.bindTexture("shadowMap"+u,d.getTexture(),e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++)}if(a.lightMaps.length>0&&a.lightMaps[0].texture&&this._uLightMap&&(o.bindTexture(this._uLightMap,a.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++),a.reflectionMaps.length>0&&a.reflectionMaps[0].texture&&this._uReflectionMap&&(o.bindTexture(this._uReflectionMap,a.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++),n.clips.length>0){var p,_,f,m=s._clipsState.clips;for(u=0,c=this._uClips.length;u<c;u++)_=(p=this._uClips[u]).active,f=m[u],_&&r.uniform1i(_,f.active),p.pos&&r.uniform3fv(p.pos,f.pos),p.dir&&r.uniform3fv(p.dir,f.dir)}this._uGammaFactor&&r.uniform1f(this._uGammaFactor,s.gammaFactor),this._baseTextureUnit=e.textureUnit}}(),function(){"use strict";xeogl.renderer.DrawShaderSource=function(s){"LambertMaterial"===s._material._state.type?(this.vertex=function(e){var t,i,s,r=e.scene._clipsState,a=e.scene._lightsState,n=e._geometry._state,o=e._state.billboard,l=e._state.stationary,h=r.clips.length>0,u=!!n.quantized,c=[];c.push("// Lambertian drawing vertex shader"),c.push("attribute vec3 position;"),c.push("uniform mat4 modelMatrix;"),c.push("uniform mat4 viewMatrix;"),c.push("uniform mat4 projMatrix;"),c.push("uniform vec4 colorize;"),u&&c.push("uniform mat4 positionsDecodeMatrix;");h&&c.push("varying vec4 vWorldPosition;");if(c.push("uniform vec4 lightAmbient;"),c.push("uniform vec4 materialColor;"),n.normals){for(c.push("attribute vec3 normal;"),c.push("uniform mat4 modelNormalMatrix;"),c.push("uniform mat4 viewNormalMatrix;"),t=0,i=a.lights.length;t<i;t++)"ambient"!==(s=a.lights[t]).type&&(c.push("uniform vec4 lightColor"+t+";"),"dir"===s.type&&c.push("uniform vec3 lightDir"+t+";"),"point"===s.type&&c.push("uniform vec3 lightPos"+t+";"),"spot"===s.type&&(c.push("uniform vec3 lightPos"+t+";"),c.push("uniform vec3 lightDir"+t+";")));u&&(c.push("vec3 octDecode(vec2 oct) {"),c.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),c.push("    if (v.z < 0.0) {"),c.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),c.push("    }"),c.push("    return normalize(v);"),c.push("}"))}c.push("varying vec4 vColor;"),"points"===n.primitiveName&&c.push("uniform float pointSize;");"spherical"!==o&&"cylindrical"!==o||(c.push("void billboard(inout mat4 mat) {"),c.push("   mat[0][0] = 1.0;"),c.push("   mat[0][1] = 0.0;"),c.push("   mat[0][2] = 0.0;"),"spherical"===o&&(c.push("   mat[1][0] = 0.0;"),c.push("   mat[1][1] = 1.0;"),c.push("   mat[1][2] = 0.0;")),c.push("   mat[2][0] = 0.0;"),c.push("   mat[2][1] = 0.0;"),c.push("   mat[2][2] =1.0;"),c.push("}"));c.push("void main(void) {"),c.push("vec4 localPosition = vec4(position, 1.0); "),c.push("vec4 worldPosition;"),u&&c.push("localPosition = positionsDecodeMatrix * localPosition;");n.normals&&(u?c.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):c.push("vec4 localNormal = vec4(normal, 0.0); "),c.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),c.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));c.push("mat4 viewMatrix2 = viewMatrix;"),c.push("mat4 modelMatrix2 = modelMatrix;"),l&&c.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===o||"cylindrical"===o?(c.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),c.push("billboard(modelMatrix2);"),c.push("billboard(viewMatrix2);"),c.push("billboard(modelViewMatrix);"),n.normals&&(c.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),c.push("billboard(modelNormalMatrix2);"),c.push("billboard(viewNormalMatrix2);"),c.push("billboard(modelViewNormalMatrix);")),c.push("worldPosition = modelMatrix2 * localPosition;"),c.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(c.push("worldPosition = modelMatrix2 * localPosition;"),c.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));n.normals&&c.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(c.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),c.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),c.push("float lambertian = 1.0;"),n.normals)for(t=0,i=a.lights.length;t<i;t++)if("ambient"!==(s=a.lights[t]).type){if("dir"===s.type)"view"===s.space?c.push("viewLightDir = normalize(lightDir"+t+");"):c.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+t+", 0.0)).xyz);");else if("point"===s.type)"view"===s.space?c.push("viewLightDir = normalize(lightPos"+t+" - viewPosition.xyz);"):c.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+t+", 0.0)).xyz);");else{if("spot"!==s.type)continue;"view"===s.space?c.push("viewLightDir = normalize(lightDir"+t+");"):c.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+t+", 0.0)).xyz);")}c.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),c.push("reflectedColor += lambertian * (lightColor"+t+".rgb * lightColor"+t+".a);")}c.push("vColor = vec4((reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),h&&c.push("vWorldPosition = worldPosition;");"points"===n.primitiveName&&c.push("gl_PointSize = pointSize;");return c.push("   gl_Position = projMatrix * viewPosition;"),c.push("}"),c}(s),this.fragment=function(e){var t,i,s=e.scene,r=s._clipsState,a=(e._material._state,e._geometry._state),n=r.clips.length>0,o=!1,l=s.gammaOutput,h=[];if(h.push("// Lambertian drawing fragment shader"),h.push("precision lowp float;"),n)for(h.push("varying vec4 vWorldPosition;"),h.push("uniform bool clippable;"),t=0,i=r.clips.length;t<i;t++)h.push("uniform bool clipActive"+t+";"),h.push("uniform vec3 clipPos"+t+";"),h.push("uniform vec3 clipDir"+t+";");h.push("varying vec4 vColor;"),l&&(h.push("uniform float gammaFactor;"),h.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),h.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),h.push("}"));if(h.push("void main(void) {"),n){for(h.push("if (clippable) {"),h.push("  float dist = 0.0;"),t=0,i=r.clips.length;t<i;t++)h.push("if (clipActive"+t+") {"),h.push("   dist += clamp(dot(-clipDir"+t+".xyz, vWorldPosition.xyz - clipPos"+t+".xyz), 0.0, 1000.0);"),h.push("}");h.push("  if (dist > 0.0) { discard; }"),o&&(h.push("  if (gl_FrontFacing == false) {"),h.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),h.push("     return;"),h.push("  }")),h.push("}")}"points"===a.primitiveName&&(h.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),h.push("float r = dot(cxy, cxy);"),h.push("if (r > 1.0) {"),h.push("   discard;"),h.push("}"));l?h.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):h.push("gl_FragColor = vColor;");return h.push("}"),h}(s)):(this.vertex=function(e){var s,r,a,n=e.scene,o=e._material,l=e._state,h=n._clipsState,u=e._geometry._state,c=(e._material._state,n._lightsState),d=l.billboard,p=l.stationary,_=function(e){if(!e._geometry._state.uv)return!1;var t=e._material;return!!(t._ambientMap||t._occlusionMap||t._baseColorMap||t._diffuseMap||t._alphaMap||t._specularMap||t._glossinessMap||t._specularGlossinessMap||t._emissiveMap||t._metallicMap||t._roughnessMap||t._metallicRoughnessMap||t._reflectivityMap||t._normalMap)}(e),f=i(e),m=h.clips.length>0,g=t(e),v=!!u.quantized,x=[];f&&o._normalMap&&x.push("#extension GL_OES_standard_derivatives : enable");x.push("// Drawing vertex shader"),x.push("attribute  vec3 position;"),v&&x.push("uniform mat4 positionsDecodeMatrix;");x.push("uniform  mat4 modelMatrix;"),x.push("uniform  mat4 viewMatrix;"),x.push("uniform  mat4 projMatrix;"),x.push("varying  vec3 vViewPosition;"),m&&x.push("varying vec4 vWorldPosition;");c.lightMaps.length>0&&x.push("varying    vec3 vWorldNormal;");if(f){for(x.push("attribute  vec3 normal;"),x.push("uniform    mat4 modelNormalMatrix;"),x.push("uniform    mat4 viewNormalMatrix;"),x.push("varying    vec3 vViewNormal;"),s=0,r=c.lights.length;s<r;s++)"ambient"!==(a=c.lights[s]).type&&("dir"===a.type&&x.push("uniform vec3 lightDir"+s+";"),"point"===a.type&&x.push("uniform vec3 lightPos"+s+";"),"spot"===a.type&&(x.push("uniform vec3 lightPos"+s+";"),x.push("uniform vec3 lightDir"+s+";")),"dir"===a.type&&"view"===a.space||x.push("varying vec4 vViewLightReverseDirAndDist"+s+";"));v&&(x.push("vec3 octDecode(vec2 oct) {"),x.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),x.push("    if (v.z < 0.0) {"),x.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),x.push("    }"),x.push("    return normalize(v);"),x.push("}"))}_&&(x.push("attribute vec2 uv;"),x.push("varying vec2 vUV;"),v&&x.push("uniform mat3 uvDecodeMatrix;"));u.colors&&(x.push("attribute vec4 color;"),x.push("varying vec4 vColor;"));"points"===u.primitiveName&&x.push("uniform float pointSize;");"spherical"!==d&&"cylindrical"!==d||(x.push("void billboard(inout mat4 mat) {"),x.push("   mat[0][0] = 1.0;"),x.push("   mat[0][1] = 0.0;"),x.push("   mat[0][2] = 0.0;"),"spherical"===d&&(x.push("   mat[1][0] = 0.0;"),x.push("   mat[1][1] = 1.0;"),x.push("   mat[1][2] = 0.0;")),x.push("   mat[2][0] = 0.0;"),x.push("   mat[2][1] = 0.0;"),x.push("   mat[2][2] =1.0;"),x.push("}"));g&&x.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");x.push("void main(void) {"),x.push("vec4 localPosition = vec4(position, 1.0); "),x.push("vec4 worldPosition;"),v&&x.push("localPosition = positionsDecodeMatrix * localPosition;");f&&(v?x.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):x.push("vec4 localNormal = vec4(normal, 0.0); "),x.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),x.push("mat4 viewNormalMatrix2     = viewNormalMatrix;"));x.push("mat4 viewMatrix2           = viewMatrix;"),x.push("mat4 modelMatrix2          = modelMatrix;"),p&&x.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===d||"cylindrical"===d?(x.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),x.push("billboard(modelMatrix2);"),x.push("billboard(viewMatrix2);"),x.push("billboard(modelViewMatrix);"),f&&(x.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),x.push("billboard(modelNormalMatrix2);"),x.push("billboard(viewNormalMatrix2);"),x.push("billboard(modelViewNormalMatrix);")),x.push("worldPosition = modelMatrix2 * localPosition;"),x.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(x.push("worldPosition = modelMatrix2 * localPosition;"),x.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));if(f)for(x.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),c.lightMaps.length>0&&x.push("vWorldNormal = worldNormal;"),x.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),x.push("vec3 tmpVec3;"),x.push("float lightDist;"),s=0,r=c.lights.length;s<r;s++)"ambient"!==(a=c.lights[s]).type&&("dir"===a.type&&"world"===a.space&&(x.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+s+", 0.0) ).xyz;"),x.push("vViewLightReverseDirAndDist"+s+" = vec4(-tmpVec3, 0.0);")),"point"===a.type&&("world"===a.space?(x.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+s+", 1.0)).xyz - viewPosition.xyz;"),x.push("lightDist = abs(length(tmpVec3));")):(x.push("tmpVec3 = lightPos"+s+".xyz - viewPosition.xyz;"),x.push("lightDist = abs(length(tmpVec3));")),x.push("vViewLightReverseDirAndDist"+s+" = vec4(tmpVec3, lightDist);")));_&&(v?x.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):x.push("vUV = uv;"));u.colors&&x.push("vColor = color;");"points"===u.primitiveName&&x.push("gl_PointSize = pointSize;");m&&x.push("vWorldPosition = worldPosition;");if(x.push("   vViewPosition = viewPosition.xyz;"),x.push("   gl_Position = projMatrix * viewPosition;"),x.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),g)for(x.push("vec4 tempx; "),s=0,r=c.lights.length;s<r;s++)c.lights[s].shadow&&x.push("vShadowPosFromLight"+s+" = texUnitConverter * shadowProjMatrix"+s+" * (shadowViewMatrix"+s+" * worldPosition); ");return x.push("}"),x}(s),this.fragment=function(s){var r,a,n=s.scene,o=n.canvas.gl,l=s._material,h=s._geometry._state,u=s.scene._clipsState,c=s.scene._lightsState,d=s._material._state,p=u.clips.length>0,_=i(s),f=h.uv,m=!1,g="PhongMaterial"===d.type,v="MetallicMaterial"===d.type,x="SpecularMaterial"===d.type,M=t(s),y=(n.gammaInput,n.gammaOutput),b=[];b.push("// Fragment vertex shader"),_&&l._normalMap&&b.push("#extension GL_OES_standard_derivatives : enable");b.push("precision "+function(e){return e.getShaderPrecisionFormat?e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0?"highp":e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}(o)+" float;"),M&&(b.push("float unpackDepth (vec4 color) {"),b.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),b.push("  return dot(color, bitShift);"),b.push("}"));b.push("uniform float gammaFactor;"),b.push("vec4 linearToLinear( in vec4 value ) {"),b.push("  return value;"),b.push("}"),b.push("vec4 sRGBToLinear( in vec4 value ) {"),b.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),b.push("}"),b.push("vec4 gammaToLinear( in vec4 value) {"),b.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),b.push("}"),y&&(b.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),b.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),b.push("}"));if(p){b.push("varying vec4 vWorldPosition;"),b.push("uniform bool clippable;");for(var w=0;w<u.clips.length;w++)b.push("uniform bool clipActive"+w+";"),b.push("uniform vec3 clipPos"+w+";"),b.push("uniform vec3 clipDir"+w+";")}_&&(c.lightMaps.length>0&&(b.push("uniform samplerCube lightMap;"),b.push("uniform mat4 viewNormalMatrix;")),c.reflectionMaps.length>0&&b.push("uniform samplerCube reflectionMap;"),(c.lightMaps.length>0||c.reflectionMaps.length>0)&&b.push("uniform mat4 viewMatrix;"),b.push("#define PI 3.14159265359"),b.push("#define RECIPROCAL_PI 0.31830988618"),b.push("#define RECIPROCAL_PI2 0.15915494"),b.push("#define EPSILON 1e-6"),b.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),b.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),b.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),b.push("}"),b.push("struct IncidentLight {"),b.push("   vec3 color;"),b.push("   vec3 direction;"),b.push("};"),b.push("struct ReflectedLight {"),b.push("   vec3 diffuse;"),b.push("   vec3 specular;"),b.push("};"),b.push("struct Geometry {"),b.push("   vec3 position;"),b.push("   vec3 viewNormal;"),b.push("   vec3 worldNormal;"),b.push("   vec3 viewEyeDir;"),b.push("};"),b.push("struct Material {"),b.push("   vec3    diffuseColor;"),b.push("   float   specularRoughness;"),b.push("   vec3    specularColor;"),b.push("   float   shine;"),b.push("};"),g&&((c.lightMaps.length>0||c.reflectionMaps.length>0)&&(b.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),c.lightMaps.length>0&&(b.push("   vec3 irradiance = "+e[c.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),b.push("   irradiance *= PI;"),b.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),b.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),c.reflectionMaps.length>0&&(b.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),b.push("   vec3 radiance               = textureCube(reflectionMap, reflectVec).rgb * 0.2;"),b.push("   reflectedLight.specular     += radiance;")),b.push("}")),b.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),b.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),b.push("   vec3 irradiance = dotNL * directLight.color * PI;"),b.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),b.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),b.push("}")),(v||x)&&(b.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),b.push("   float r = ggxRoughness + 0.0001;"),b.push("   return (2.0 / (r * r) - 2.0);"),b.push("}"),b.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),b.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),b.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),b.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),b.push("}"),c.reflectionMaps.length>0&&(b.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),b.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),b.push("   vec3 envMapColor = "+e[c.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),b.push("  return envMapColor;"),b.push("}")),b.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),b.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),b.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),b.push("}"),b.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),b.push("   float a2 = ( alpha * alpha );"),b.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),b.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),b.push("   return 1.0 / ( gl * gv );"),b.push("}"),b.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),b.push("   float a2 = ( alpha * alpha );"),b.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),b.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),b.push("   return 0.5 / max( gv + gl, EPSILON );"),b.push("}"),b.push("float D_GGX(const in float alpha, const in float dotNH) {"),b.push("   float a2 = ( alpha * alpha );"),b.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),b.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),b.push("}"),b.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),b.push("   float alpha = ( roughness * roughness );"),b.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),b.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),b.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),b.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),b.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),b.push("   vec3  F = F_Schlick( specularColor, dotLH );"),b.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),b.push("   float D = D_GGX( alpha, dotNH );"),b.push("   return F * (G * D);"),b.push("}"),b.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),b.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),b.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),b.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),b.push("   vec4 r = roughness * c0 + c1;"),b.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),b.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),b.push("   return specularColor * AB.x + AB.y;"),b.push("}"),(c.lightMaps.length>0||c.reflectionMaps.length>0)&&(b.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),c.lightMaps.length>0&&(b.push("   vec3 irradiance = sRGBToLinear(textureCube(lightMap, geometry.worldNormal)).rgb;"),b.push("   irradiance *= PI;"),b.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),b.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),c.reflectionMaps.length>0&&(b.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),b.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),b.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),b.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),b.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),b.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),b.push("}")),b.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),b.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),b.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),b.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),b.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),b.push("}")));b.push("varying vec3 vViewPosition;"),h.colors&&b.push("varying vec4 vColor;");f&&(_&&l._normalMap||l._ambientMap||l._baseColorMap||l._diffuseMap||l._emissiveMap||l._metallicMap||l._roughnessMap||l._metallicRoughnessMap||l._specularMap||l._glossinessMap||l._specularGlossinessMap||l._occlusionMap||l._alphaMap)&&b.push("varying vec2 vUV;");_&&(c.lightMaps.length>0&&b.push("varying vec3 vWorldNormal;"),b.push("varying vec3 vViewNormal;"));d.ambient&&b.push("uniform vec3 materialAmbient;");d.baseColor&&b.push("uniform vec3 materialBaseColor;");void 0!==d.alpha&&null!==d.alpha&&b.push("uniform vec4 materialAlphaModeCutoff;");d.emissive&&b.push("uniform vec3 materialEmissive;");d.diffuse&&b.push("uniform vec3 materialDiffuse;");void 0!==d.glossiness&&null!==d.glossiness&&b.push("uniform float materialGlossiness;");void 0!==d.shininess&&null!==d.shininess&&b.push("uniform float materialShininess;");d.specular&&b.push("uniform vec3 materialSpecular;");void 0!==d.metallic&&null!==d.metallic&&b.push("uniform float materialMetallic;");void 0!==d.roughness&&null!==d.roughness&&b.push("uniform float materialRoughness;");void 0!==d.specularF0&&null!==d.specularF0&&b.push("uniform float materialSpecularF0;");f&&l._ambientMap&&(b.push("uniform sampler2D ambientMap;"),l._ambientMap._state.matrix&&b.push("uniform mat4 ambientMapMatrix;"));f&&l._baseColorMap&&(b.push("uniform sampler2D baseColorMap;"),l._baseColorMap._state.matrix&&b.push("uniform mat4 baseColorMapMatrix;"));f&&l._diffuseMap&&(b.push("uniform sampler2D diffuseMap;"),l._diffuseMap._state.matrix&&b.push("uniform mat4 diffuseMapMatrix;"));f&&l._emissiveMap&&(b.push("uniform sampler2D emissiveMap;"),l._emissiveMap._state.matrix&&b.push("uniform mat4 emissiveMapMatrix;"));_&&f&&l._metallicMap&&(b.push("uniform sampler2D metallicMap;"),l._metallicMap._state.matrix&&b.push("uniform mat4 metallicMapMatrix;"));_&&f&&l._roughnessMap&&(b.push("uniform sampler2D roughnessMap;"),l._roughnessMap._state.matrix&&b.push("uniform mat4 roughnessMapMatrix;"));_&&f&&l._metallicRoughnessMap&&(b.push("uniform sampler2D metallicRoughnessMap;"),l._metallicRoughnessMap._state.matrix&&b.push("uniform mat4 metallicRoughnessMapMatrix;"));_&&l._normalMap&&(b.push("uniform sampler2D normalMap;"),l._normalMap._state.matrix&&b.push("uniform mat4 normalMapMatrix;"),b.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),b.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),b.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),b.push("      vec2 st0 = dFdx( uv.st );"),b.push("      vec2 st1 = dFdy( uv.st );"),b.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),b.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),b.push("      vec3 N = normalize( surf_norm );"),b.push("      vec3 mapN = texture2D( normalMap, uv ).xyz * 2.0 - 1.0;"),b.push("      mat3 tsn = mat3( S, T, N );"),b.push("      return normalize( tsn * mapN );"),b.push("}"));f&&l._occlusionMap&&(b.push("uniform sampler2D occlusionMap;"),l._occlusionMap._state.matrix&&b.push("uniform mat4 occlusionMapMatrix;"));f&&l._alphaMap&&(b.push("uniform sampler2D alphaMap;"),l._alphaMap._state.matrix&&b.push("uniform mat4 alphaMapMatrix;"));_&&f&&l._specularMap&&(b.push("uniform sampler2D specularMap;"),l._specularMap._state.matrix&&b.push("uniform mat4 specularMapMatrix;"));_&&f&&l._glossinessMap&&(b.push("uniform sampler2D glossinessMap;"),l._glossinessMap._state.matrix&&b.push("uniform mat4 glossinessMapMatrix;"));_&&f&&l._specularGlossinessMap&&(b.push("uniform sampler2D materialSpecularGlossinessMap;"),l._specularGlossinessMap._state.matrix&&b.push("uniform mat4 materialSpecularGlossinessMapMatrix;"));_&&(l._diffuseFresnel||l._specularFresnel||l._alphaFresnel||l._emissiveFresnel||l._reflectivityFresnel)&&(b.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),b.push("    float fr = abs(dot(eyeDir, normal));"),b.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),b.push("    return pow(finalFr, power);"),b.push("}"),l._diffuseFresnel&&(b.push("uniform float  diffuseFresnelCenterBias;"),b.push("uniform float  diffuseFresnelEdgeBias;"),b.push("uniform float  diffuseFresnelPower;"),b.push("uniform vec3   diffuseFresnelCenterColor;"),b.push("uniform vec3   diffuseFresnelEdgeColor;")),l._specularFresnel&&(b.push("uniform float  specularFresnelCenterBias;"),b.push("uniform float  specularFresnelEdgeBias;"),b.push("uniform float  specularFresnelPower;"),b.push("uniform vec3   specularFresnelCenterColor;"),b.push("uniform vec3   specularFresnelEdgeColor;")),l._alphaFresnel&&(b.push("uniform float  alphaFresnelCenterBias;"),b.push("uniform float  alphaFresnelEdgeBias;"),b.push("uniform float  alphaFresnelPower;"),b.push("uniform vec3   alphaFresnelCenterColor;"),b.push("uniform vec3   alphaFresnelEdgeColor;")),l._reflectivityFresnel&&(b.push("uniform float  materialSpecularF0FresnelCenterBias;"),b.push("uniform float  materialSpecularF0FresnelEdgeBias;"),b.push("uniform float  materialSpecularF0FresnelPower;"),b.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),b.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),l._emissiveFresnel&&(b.push("uniform float  emissiveFresnelCenterBias;"),b.push("uniform float  emissiveFresnelEdgeBias;"),b.push("uniform float  emissiveFresnelPower;"),b.push("uniform vec3   emissiveFresnelCenterColor;"),b.push("uniform vec3   emissiveFresnelEdgeColor;")));if(b.push("uniform vec4   lightAmbient;"),_)for(w=0,r=c.lights.length;w<r;w++)"ambient"!==(a=c.lights[w]).type&&(b.push("uniform vec4 lightColor"+w+";"),"point"===a.type&&b.push("uniform vec3 lightAttenuation"+w+";"),"dir"===a.type&&"view"===a.space&&b.push("uniform vec3 lightDir"+w+";"),"point"===a.type&&"view"===a.space?b.push("uniform vec3 lightPos"+w+";"):b.push("varying vec4 vViewLightReverseDirAndDist"+w+";"));if(M)for(w=0,r=c.lights.length;w<r;w++)c.lights[w].shadow&&(b.push("varying vec4 vShadowPosFromLight"+w+";"),b.push("uniform sampler2D shadowMap"+w+";"));if(b.push("uniform vec4 colorize;"),b.push("void main(void) {"),p){b.push("if (clippable) {"),b.push("  float dist = 0.0;");for(var w=0;w<u.clips.length;w++)b.push("if (clipActive"+w+") {"),b.push("   dist += clamp(dot(-clipDir"+w+".xyz, vWorldPosition.xyz - clipPos"+w+".xyz), 0.0, 1000.0);"),b.push("}");b.push("  if (dist > 0.0) { discard; }"),m&&(b.push("  if (gl_FrontFacing == false) {"),b.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),b.push("     return;"),b.push("  }")),b.push("}")}"points"===h.primitiveName&&(b.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),b.push("float r = dot(cxy, cxy);"),b.push("if (r > 1.0) {"),b.push("   discard;"),b.push("}"));b.push("float occlusion = 1.0;"),d.ambient?b.push("vec3 ambientColor = materialAmbient;"):b.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);");d.diffuse?b.push("vec3 diffuseColor = materialDiffuse;"):d.baseColor?b.push("vec3 diffuseColor = materialBaseColor;"):b.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);");h.colors&&b.push("diffuseColor *= vColor.rgb;");d.emissive?b.push("vec3 emissiveColor = materialEmissive;"):b.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);");d.specular?b.push("vec3 specular = materialSpecular;"):b.push("vec3 specular = vec3(1.0, 1.0, 1.0);");void 0!==d.alpha?b.push("float alpha = materialAlphaModeCutoff[0];"):b.push("float alpha = 1.0;");h.colors&&b.push("alpha *= vColor.a;");void 0!==d.glossiness?b.push("float glossiness = materialGlossiness;"):b.push("float glossiness = 1.0;");void 0!==d.metallic?b.push("float metallic = materialMetallic;"):b.push("float metallic = 1.0;");void 0!==d.roughness?b.push("float roughness = materialRoughness;"):b.push("float roughness = 1.0;");void 0!==d.specularF0?b.push("float specularF0 = materialSpecularF0;"):b.push("float specularF0 = 1.0;");f&&(_&&l._normalMap||l._ambientMap||l._baseColorMap||l._diffuseMap||l._occlusionMap||l._emissiveMap||l._metallicMap||l._roughnessMap||l._metallicRoughnessMap||l._specularMap||l._glossinessMap||l._specularGlossinessMap||l._alphaMap)&&(b.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),b.push("vec2 textureCoord;"));f&&l._ambientMap&&(l._ambientMap._state.matrix?b.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec4 ambientTexel = texture2D(ambientMap, textureCoord).rgb;"),b.push("ambientTexel = "+e[l._ambientMap._state.encoding]+"(ambientTexel);"),b.push("ambientColor *= ambientTexel.rgb;"));f&&l._diffuseMap&&(l._diffuseMap._state.matrix?b.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec4 diffuseTexel = texture2D(diffuseMap, textureCoord);"),b.push("diffuseTexel = "+e[l._diffuseMap._state.encoding]+"(diffuseTexel);"),b.push("diffuseColor *= diffuseTexel.rgb;"),b.push("alpha *= diffuseTexel.a;"));f&&l._baseColorMap&&(l._baseColorMap._state.matrix?b.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec4 baseColorTexel = texture2D(baseColorMap, textureCoord);"),b.push("baseColorTexel = "+e[l._baseColorMap._state.encoding]+"(baseColorTexel);"),b.push("diffuseColor *= baseColorTexel.rgb;"),b.push("alpha *= baseColorTexel.a;"));f&&l._emissiveMap&&(l._emissiveMap._state.matrix?b.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec4 emissiveTexel = texture2D(emissiveMap, textureCoord);"),b.push("emissiveTexel = "+e[l._emissiveMap._state.encoding]+"(emissiveTexel);"),b.push("emissiveColor *= emissiveTexel.rgb;"));f&&l._alphaMap&&(l._alphaMap._state.matrix?b.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("alpha *= texture2D(alphaMap, textureCoord).r;"));f&&l._occlusionMap&&(l._occlusionMap._state.matrix?b.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("occlusion *= texture2D(occlusionMap, textureCoord).r;"));if(_&&(c.lights.length>0||c.lightMaps.length>0||c.reflectionMaps.length>0)){f&&l._normalMap?(l._normalMap._state.matrix?b.push("textureCoord = (normalMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):b.push("vec3 viewNormal = normalize(vViewNormal);"),f&&l._specularMap&&(l._specularMap._state.matrix?b.push("textureCoord = (specularMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("specular *= texture2D(specularMap, textureCoord).rgb;")),f&&l._glossinessMap&&(l._glossinessMap._state.matrix?b.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("glossiness *= texture2D(glossinessMap, textureCoord).r;")),f&&l._specularGlossinessMap&&(l._specularGlossinessMap._state.matrix?b.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec4 specGlossRGB = texture2D(materialSpecularGlossinessMap, textureCoord).rgba;"),b.push("specular *= specGlossRGB.rgb;"),b.push("glossiness *= specGlossRGB.a;")),f&&l._metallicMap&&(l._metallicMap._state.matrix?b.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("metallic *= texture2D(metallicMap, textureCoord).r;")),f&&l._roughnessMap&&(l._roughnessMap._state.matrix?b.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("roughness *= texture2D(roughnessMap, textureCoord).r;")),f&&l._metallicRoughnessMap&&(l._metallicRoughnessMap._state.matrix?b.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):b.push("textureCoord = texturePos.xy;"),b.push("vec3 metalRoughRGB = texture2D(metallicRoughnessMap, textureCoord).rgb;"),b.push("metallic *= metalRoughRGB.b;"),b.push("roughness *= metalRoughRGB.g;")),b.push("vec3 viewEyeDir = normalize(-vViewPosition);"),l._diffuseFresnel&&(b.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),b.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),l._specularFresnel&&(b.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),b.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),l._alphaFresnel&&(b.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),b.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),l._emissiveFresnel&&(b.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),b.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),b.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),b.push("   discard;"),b.push("}"),b.push("IncidentLight  light;"),b.push("Material       material;"),b.push("Geometry       geometry;"),b.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),b.push("vec3           viewLightDir;"),g&&(b.push("material.diffuseColor      = diffuseColor;"),b.push("material.specularColor     = specular;"),b.push("material.shine             = materialShininess;")),x&&(b.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),b.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),b.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),b.push("material.specularColor     = specular;")),v&&(b.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),b.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),b.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),b.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),b.push("geometry.position      = vViewPosition;"),c.lightMaps.length>0&&b.push("geometry.worldNormal   = normalize(vWorldNormal);"),b.push("geometry.viewNormal    = viewNormal;"),b.push("geometry.viewEyeDir    = viewEyeDir;"),g&&(c.lightMaps.length>0||c.reflectionMaps.length>0)&&b.push("computePhongLightMapping(geometry, material, reflectedLight);"),(x||v)&&(c.lightMaps.length>0||c.reflectionMaps.length>0)&&b.push("computePBRLightMapping(geometry, material, reflectedLight);"),b.push("float shadow = 1.0;"),b.push("float shadowAcneRemover = 0.0007;"),b.push("vec3 fragmentDepth;"),b.push("float texelSize = 1.0 / 1024.0;"),b.push("float amountInLight = 0.0;"),b.push("vec3 shadowCoord;"),b.push("vec4 rgbaDepth;"),b.push("float depth;");for(w=0,r=c.lights.length;w<r;w++)"ambient"!==(a=c.lights[w]).type&&("dir"===a.type&&"view"===a.space?b.push("viewLightDir = -normalize(lightDir"+w+");"):"point"===a.type&&"view"===a.space?b.push("viewLightDir = normalize(lightPos"+w+" - vViewPosition);"):b.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+w+".xyz);"),M&&a.shadow?(b.push("shadow = 0.0;"),b.push("fragmentDepth = vShadowPosFromLight"+w+".xyz;"),b.push("fragmentDepth.z -= shadowAcneRemover;"),b.push("for (int x = -3; x <= 3; x++) {"),b.push("  for (int y = -3; y <= 3; y++) {"),b.push("      float texelDepth = unpackDepth(texture2D(shadowMap"+w+", fragmentDepth.xy + vec2(x, y) * texelSize));"),b.push("      if (fragmentDepth.z < texelDepth) {"),b.push("          shadow += 1.0;"),b.push("      }"),b.push("  }"),b.push("}"),b.push("light.color =  lightColor"+w+".rgb * (lightColor"+w+".a * (shadow / 49.0));")):b.push("light.color =  lightColor"+w+".rgb * (lightColor"+w+".a );"),b.push("light.direction = viewLightDir;"),g&&b.push("computePhongLighting(light, geometry, material, reflectedLight);"),(x||v)&&b.push("computePBRLighting(light, geometry, material, reflectedLight);"));0,g?(b.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),b.push("vec3 outgoingLight =  ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;")):b.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (shadow * occlusion * reflectedLight.specular) + emissiveColor;")}else b.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),b.push("vec3 outgoingLight = emissiveColor + ambientColor;");b.push("gl_FragColor = vec4(outgoingLight, alpha) * colorize;"),y&&b.push("gl_FragColor = linearToGamma(gl_FragColor, gammaFactor);");return b.push("}"),b}(s))};const e={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"};function t(e){if(!e._state.receiveShadow)return!1;var t=e.scene._lightsState.lights;if(!t||0===t.length)return!1;for(var i=0,s=t.length;i<s;i++)if(t[i].shadow)return!0;return!1}function i(e){var t=e._geometry._state.primitiveName;return!(!e._geometry._state.autoVertexNormals&&!e._geometry._state.normals||"triangles"!==t&&"triangle-strip"!==t&&"triangle-fan"!==t)}}(),function(){"use strict";var e=new xeogl.utils.Map({});xeogl.renderer.OutlineRenderer=function(e,t){this._init(e,t)};var t={};xeogl.renderer.OutlineRenderer.get=function(e){var i=[e.scene.canvas.canvas.id,e.scene.gammaOutput?"go":"",e.scene._clipsState.getHash(),e._geometry._state.hash,e._state.hash].join(";"),s=t[i];return s||(s=new xeogl.renderer.OutlineRenderer(i,e),t[i]=s,xeogl.stats.memory.programs++),s._useCount++,s},xeogl.renderer.OutlineRenderer.prototype.put=function(){0==--this._useCount&&(e.removeItem(this.id),this._program.destroy(),delete t[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.OutlineRenderer.prototype._init=function(t,i){if(this.id=e.addItem({}),this._scene=i.scene,this._hash=t,this._shaderSource=new xeogl.renderer.OutlineShaderSource(i),this._program=new xeogl.renderer.Program(i.scene.canvas.gl,this._shaderSource),this._useCount=0,this._program.errors)this.errors=this._program.errors;else{var s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uClips=[];for(var r=0,a=i.scene._clipsState.clips.length;r<a;r++)this._uClips.push({active:s.getLocation("clipActive"+r),pos:s.getLocation("clipPos"+r),dir:s.getLocation("clipDir"+r)});this._uColor=s.getLocation("color"),this._uWidth=s.getLocation("width"),this._aPosition=s.getAttribute("position"),this._aNormal=s.getAttribute("normal"),this._uClippable=s.getLocation("clippable"),this._uGammaFactor=s.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},xeogl.renderer.OutlineRenderer.prototype._bindProgram=function(e){var t=this._scene,i=t.canvas.gl,s=this._program,r=t._clipsState;if(s.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,i.uniformMatrix4fv(this._uViewMatrix,!1,t.viewTransform.matrix),i.uniformMatrix4fv(this._uProjMatrix,!1,t.projTransform.matrix),r.clips.length>0)for(var a,n,o,l=0,h=this._uClips.length;l<h;l++)n=(a=this._uClips[l]).active,o=r.clips[l],n&&i.uniform1i(n,o.active),a.pos&&i.uniform3fv(a.pos,o.pos),a.dir&&i.uniform3fv(a.dir,o.dir);this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)},xeogl.renderer.OutlineRenderer.prototype.drawMesh=function(e,t){var i=this._scene.canvas.gl,s=t.outlineMaterial,r=t._state,a=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.id!==this._lastMaterialId){if(this._uWidth&&i.uniform1f(this._uWidth,s.width),this._uColor){var n=s.color,o=s.alpha;i.uniform4f(this._uColor,n[0],n[1],n[2],o)}this._lastMaterialId=s.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,t.worldMatrix),this._uModelNormalMatrix&&i.uniformMatrix4fv(this._uModelNormalMatrix,i.FALSE,t.worldNormalMatrix),this._uClippable&&i.uniform1i(this._uClippable,r.clippable),a.combined){var l=t._geometry._getVertexBufs();l.id!==this._lastVertexBufsId&&(l.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf,l.quantized?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),l.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(l.normalsBuf,l.quantized?i.BYTE:i.FLOAT),e.bindArray++),this._lastVertexBufsId=l.id)}a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._uUVDecodeMatrix&&i.uniformMatrix3fv(this._uUVDecodeMatrix,!1,a.uvDecodeMatrix),a.combined?a.indicesBufCombined&&(a.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.quantized?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(a.normalsBuf,a.quantized?i.BYTE:i.FLOAT),e.bindArray++),a.indicesBuf?(a.indicesBuf.bind(),e.bindArray++):a.positions),this._lastGeometryId=a.id),a.combined?a.indicesBufCombined&&(i.drawElements(a.primitive,a.indicesBufCombined.numItems,a.indicesBufCombined.itemType,0),e.drawElements++):a.indicesBuf?(i.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),e.drawElements++):a.positions&&(i.drawArrays(i.TRIANGLES,0,a.positions.numItems),e.drawArrays++)}}(),function(){"use strict";xeogl.renderer.OutlineShaderSource=function(e){this.vertex=function(e){var t=e.scene._clipsState.clips.length>0,i=!!e._geometry._state.quantized,s=function(e){var t=e._geometry._state.primitiveName;if((e._geometry._state.autoVertexNormals||e._geometry._state.normals)&&("triangles"===t||"triangle-strip"===t||"triangle-fan"===t))return!0;return!1}(e),r=e._state.billboard,a=e._state.stationary,n=[];n.push("// Outline effect vertex shader"),n.push("attribute vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform float width;"),i&&n.push("uniform mat4 positionsDecodeMatrix;");t&&n.push("varying vec4 vWorldPosition;");s&&(n.push("attribute vec3 normal;"),i&&(n.push("vec3 octDecode(vec2 oct) {"),n.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),n.push("    if (v.z < 0.0) {"),n.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),n.push("    }"),n.push("    return normalize(v);"),n.push("}")));"spherical"!==r&&"cylindrical"!==r||(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = 1.0;"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),"spherical"===r&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = 1.0;"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}"));n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),n.push("vec4 worldPosition;"),i&&n.push("localPosition = positionsDecodeMatrix * localPosition;");s&&(i?n.push("vec3 localNormal = octDecode(normal.xy); "):n.push("vec3 localNormal = normal; "),n.push("  localPosition.xyz += (normalize(normal) * (width * 0.0005));"));n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),a&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);"),n.push("billboard(modelViewMatrix);"),n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));t&&n.push("vWorldPosition = worldPosition;");return n.push("   gl_Position = projMatrix * viewPosition;"),n.push("}"),n}(e),this.fragment=function(e){var t=e.scene._clipsState,i=t.clips.length>0,s=[];if(s.push("precision lowp float;"),s.push("uniform vec4  color;"),i){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var r=0;r<t.clips.length;r++)s.push("uniform bool clipActive"+r+";"),s.push("uniform vec3 clipPos"+r+";"),s.push("uniform vec3 clipDir"+r+";")}if(s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(var r=0;r<t.clips.length;r++)s.push("if (clipActive"+r+") {"),s.push("   dist += clamp(dot(-clipDir"+r+".xyz, vWorldPosition.xyz - clipPos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = color;"),s.push("}"),s}(e)}}(),function(){"use strict";xeogl.renderer.PickMeshRenderer=function(e,t){this._hash=e,this._shaderSource=new xeogl.renderer.PickMeshShaderSource(t),this._scene=t.scene,this._useCount=0,this._allocate(t)};var e={};xeogl.renderer.PickMeshRenderer.get=function(t){var i=[t.scene.canvas.canvas.id,t.scene._clipsState.getHash(),t._geometry._state.hash,t._state.hash].join(";"),s=e[i];if(!s){if((s=new xeogl.renderer.PickMeshRenderer(i,t)).errors)return console.log(s.errors.join("\n")),null;e[i]=s,xeogl.stats.memory.programs++}return s._useCount++,s},xeogl.renderer.PickMeshRenderer.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete e[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.PickMeshRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.PickMeshRenderer.prototype.drawMesh=function(e,t){this._program||this._allocate(t);var i=this._scene.canvas.gl,s=t._material._state,r=(t._state,t._geometry._state);if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.id!==this._lastMaterialId){var a=s.backfaces;e.backfaces!==a&&(a?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=a);var n=s.frontface;e.frontface!==n&&(n?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=n),e.lineWidth!==s.lineWidth&&(i.lineWidth(s.lineWidth),e.lineWidth=s.lineWidth),this._uPointSize&&i.uniform1i(this._uPointSize,s.pointSize),this._lastMaterialId=s.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,t.worldMatrix),r.combined){var o=t._geometry._getVertexBufs();o.id!==this._lastVertexBufsId&&(o.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(o.positionsBuf,o.quantized?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),this._lastVertexBufsId=o.id)}this._uClippable&&i.uniform1i(this._uClippable,t._state.clippable),r.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,r.positionsDecodeMatrix),r.combined?r.indicesBufCombined&&(r.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(r.positionsBuf,r.quantized?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),r.indicesBuf&&(r.indicesBuf.bind(),e.bindArray++)),this._lastGeometryId=r.id);var l=e.pickmeshIndex>>24&255,h=e.pickmeshIndex>>16&255,u=e.pickmeshIndex>>8&255,c=255&e.pickmeshIndex;e.pickmeshIndex++,i.uniform4f(this._uPickColor,c/255,u/255,h/255,l/255),r.combined?r.indicesBufCombined&&(i.drawElements(r.primitive,r.indicesBufCombined.numItems,r.indicesBufCombined.itemType,0),e.drawElements++):r.indicesBuf?(i.drawElements(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0),e.drawElements++):r.positions&&i.drawArrays(i.TRIANGLES,0,r.positions.numItems)},xeogl.renderer.PickMeshRenderer.prototype._allocate=function(e){var t=e.scene.canvas.gl;if(this._program=new xeogl.renderer.Program(t,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uClips=[];for(var s=0,r=e.scene._clipsState.clips.length;s<r;s++)this._uClips.push({active:i.getLocation("clipActive"+s),pos:i.getLocation("clipPos"+s),dir:i.getLocation("clipDir"+s)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._uPickColor=i.getLocation("pickColor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},xeogl.renderer.PickMeshRenderer.prototype._bindProgram=function(e){this._program||this._allocate(mesh);var t=this._scene,i=t.canvas.gl,s=t._clipsState,r=t.camera,a=r._state;if(this._program.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,i.uniformMatrix4fv(this._uViewMatrix,!1,e.pickViewMatrix||a.matrix),i.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix||r.project._state.matrix),s.clips.length>0)for(var n,o,l,h=0,u=this._uClips.length;h<u;h++)o=(n=this._uClips[h]).active,l=s.clips[h],o&&i.uniform1i(o,l.active),n.pos&&i.uniform3fv(n.pos,l.pos),n.dir&&i.uniform3fv(n.dir,l.dir)}}(),function(){"use strict";xeogl.renderer.PickMeshShaderSource=function(e){this.vertex=function(e){var t=e.scene._clipsState.clips.length>0,i=!!e._geometry._state.quantized,s=e._state.billboard,r=e._state.stationary,a=[];a.push("// mesh picking vertex shader"),a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 viewNormalMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("varying vec4 vViewPosition;"),i&&a.push("uniform mat4 positionsDecodeMatrix;");t&&a.push("varying vec4 vWorldPosition;");"spherical"!==s&&"cylindrical"!==s||(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===s&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),i&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),r&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==s&&"cylindrical"!==s||(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"));a.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),a.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),t&&a.push("   vWorldPosition = worldPosition;");return a.push("   gl_Position = projMatrix * viewPosition;"),a.push("}"),a}(e),this.fragment=function(e){var t=e.scene._clipsState,i=t.clips.length>0,s=[];if(s.push("// mesh picking fragment shader"),s.push("precision lowp float;"),s.push("uniform vec4 pickColor;"),i){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var r=0;r<t.clips.length;r++)s.push("uniform bool clipActive"+r+";"),s.push("uniform vec3 clipPos"+r+";"),s.push("uniform vec3 clipDir"+r+";")}if(s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(var r=0;r<t.clips.length;r++)s.push("if (clipActive"+r+") {"),s.push("   dist += clamp(dot(-clipDir"+r+".xyz, vWorldPosition.xyz - clipPos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = pickColor; "),s.push("}"),s}(e)}}(),function(){"use strict";xeogl.renderer.PickTriangleRenderer=function(e,t){this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new xeogl.renderer.PickTriangleShaderSource(t),this._allocate(t)};var e={};xeogl.renderer.PickTriangleRenderer.get=function(t){var i=[t.scene.canvas.canvas.id,t.scene._clipsState.getHash(),t._geometry._state.quantized?"cp":"",t._state.hash].join(";"),s=e[i];if(!s){if((s=new xeogl.renderer.PickTriangleRenderer(i,t)).errors)return console.log(s.errors.join("\n")),null;e[i]=s,xeogl.stats.memory.programs++}return s._useCount++,s},xeogl.renderer.PickTriangleRenderer.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete e[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.PickTriangleRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.PickTriangleRenderer.prototype.drawMesh=function(e,t){this._program||this._allocate(t);var i=this._scene,s=i.canvas.gl,r=i._clipsState,a=t._material._state,n=(t._state,t._geometry),o=t._geometry._state,l=a.backfaces,h=a.frontface,u=n._getPickTrianglePositions(),c=n._getPickTriangleColors(),d=i.camera,p=d._state;if(this._program.bind(),e.useProgram++,s.uniformMatrix4fv(this._uViewMatrix,!1,e.pickViewMatrix||p.matrix),s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix||d.project._state.matrix),r.clips.length>0)for(var _,f,m,g=r.clips,v=0,x=this._uClips.length;v<x;v++)f=(_=this._uClips[v]).active,m=g[v],f&&s.uniform1i(f,m.active),_.pos&&s.uniform3fv(_.pos,m.pos),_.dir&&s.uniform3fv(_.dir,m.dir);e.backfaces!==l&&(l?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=l),e.frontface!==h&&(h?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=h),this._lastMaterialId=a.id,s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),this._uPositionsDecodeMatrix?(s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,o.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(u,o.quantized?s.UNSIGNED_SHORT:s.FLOAT)):this._aPosition.bindArrayBuffer(u),c.bind(),s.enableVertexAttribArray(this._aColor.location),s.vertexAttribPointer(this._aColor.location,c.itemSize,c.itemType,!0,0,0),s.drawArrays(o.primitive,0,u.numItems/3)},xeogl.renderer.PickTriangleRenderer.prototype._allocate=function(e){var t=e.scene.canvas.gl;if(this._program=new xeogl.renderer.Program(t,this._shaderSource),this._useCount=0,this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uClips=[];for(var s=0,r=e.scene._clipsState.clips.length;s<r;s++)this._uClips.push({active:i.getLocation("clipActive"+s),pos:i.getLocation("clipPos"+s),dir:i.getLocation("clipDir"+s)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._uClippable=i.getLocation("clippable")}}}(),function(){"use strict";xeogl.renderer.PickTriangleShaderSource=function(e){this.vertex=function(e){var t=e.scene._clipsState.clips.length>0,i=!!e._geometry._state.quantized,s=(e._state.billboard,e._state.stationary,[]);s.push("// Surface picking vertex shader"),s.push("attribute vec3 position;"),s.push("attribute vec4 color;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),t&&(s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;"));s.push("varying vec4 vColor;"),i&&s.push("uniform mat4 positionsDecodeMatrix;");s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),i&&s.push("localPosition = positionsDecodeMatrix * localPosition;");s.push("   vec4 worldPosition = modelMatrix * localPosition; "),s.push("   vec4 viewPosition = viewMatrix * worldPosition;"),t&&s.push("   vWorldPosition = worldPosition;");return s.push("   vColor = color;"),s.push("   gl_Position = projMatrix * viewPosition;"),s.push("}"),s}(e),this.fragment=function(e){var t=e.scene._clipsState,i=t.clips.length>0,s=[];if(s.push("// Surface picking fragment shader"),s.push("precision lowp float;"),s.push("varying vec4 vColor;"),i){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var r=0;r<t.clips.length;r++)s.push("uniform bool clipActive"+r+";"),s.push("uniform vec3 clipPos"+r+";"),s.push("uniform vec3 clipDir"+r+";")}if(s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(var r=0;r<t.clips.length;r++)s.push("if (clipActive"+r+") {"),s.push("   dist += clamp(dot(-clipDir"+r+".xyz, vWorldPosition.xyz - clipPos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vColor;"),s.push("}"),s}(e)}}(),function(){"use strict";xeogl.renderer.ShadowRenderer=function(e,t){if(this._hash=e,this._shaderSource=new xeogl.renderer.ShadowShaderSource(t),this._program=new xeogl.renderer.Program(t.scene.canvas.gl,this._shaderSource),this._scene=scene,this._useCount=0,this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uClips={};for(var s=0,r=t.scene._clipsState.clips.length;s<r;s++)this._uClips.push({active:i.getLocation("clipActive"+s),pos:i.getLocation("clipPos"+s),dir:i.getLocation("clipDir"+s)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}};var e={};xeogl.renderer.ShadowRenderer.get=function(t){var i=[t.scene.canvas.canvas.id,t.scene._clipsState.getHash(),t._geometry._state.hash,t._state.hash].join(";"),s=e[i];return s||(s=new xeogl.renderer.ShadowRenderer(i,t),e[i]=s),s._useCount++,s},xeogl.renderer.ShadowRenderer.prototype.put=function(){--this._useCount&&(this._program.destroy(),delete e[this._hash])},xeogl.renderer.ShadowRenderer.prototype._bindProgram=function(e){var t=this._scene,i=t.canvas.gl,s=t._clipsState;if(this._program.bind(),e.useProgram++,this._lastLightId=null,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.clips.length>0)for(var r,a,n,o=0,l=this._uClips.length;o<l;o++)a=(r=this._uClips[o]).active,n=s.clips[o],a&&i.uniform1i(a,n.active),r.pos&&i.uniform3fv(r.pos,n.pos),r.dir&&i.uniform3fv(r.dir,n.dir)},xeogl.renderer.ShadowRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.ShadowRenderer.prototype.drawMesh=function(e,t,i){var s=this._scene.canvas.gl,r=t._material._state,a=(t._state,t._geometry._state);if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),e.textureUnit=0,i.id!==this._lastLightId&&(s.uniformMatrix4fv(this._uViewMatrix,!1,i.getShadowViewMatrix()),s.uniformMatrix4fv(this._uProjMatrix,!1,i.getShadowProjMatrix()),this._lastLightId=i.id),r.id!==this._lastMaterialId){var n=r.backfaces;e.backfaces!==n&&(n?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=n);var o=r.frontface;e.frontface!==o&&(o?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=o),e.lineWidth!==r.lineWidth&&(s.lineWidth(r.lineWidth),e.lineWidth=r.lineWidth),this._uPointSize&&s.uniform1i(this._uPointSize,r.pointSize),this._lastMaterialId=r.id}if(s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),a.combined){var l=t.vertexBufs;l.id!==this._lastVertexBufsId&&(l.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf,l.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),this._lastVertexBufsId=l.id)}a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),a.combined?a.indicesBufCombined&&(a.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),a.indicesBuf&&(a.indicesBuf.bind(),e.bindArray++)),this._lastGeometryId=a.id),a.combined?a.indicesBufCombined&&(s.drawElements(a.primitive,a.indicesBufCombined.numItems,a.indicesBufCombined.itemType,0),e.drawElements++):a.indicesBuf?(s.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),e.drawElements++):a.positions&&(s.drawArrays(s.TRIANGLES,0,a.positions.numItems),e.drawArrays++)}}(),function(){"use strict";xeogl.renderer.ShadowShaderSource=function(e){this.vertex=function(e){scene.lights.lights;var t=e._state.billboard,i=[];i.push("// Shadow drawing vertex shader"),i.push("attribute vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),cfg.quantizedGeometry&&i.push("uniform mat4 positionsDecodeMatrix;");cfg.clipping&&i.push("varying vec4 vWorldPosition;");"points"===e._geometry._state.primitiveName&&i.push("uniform float pointSize;");"spherical"!==t&&"cylindrical"!==t||(i.push("void billboard(inout mat4 mat) {"),i.push("   mat[0][0] = 1.0;"),i.push("   mat[0][1] = 0.0;"),i.push("   mat[0][2] = 0.0;"),"spherical"===t&&(i.push("   mat[1][0] = 0.0;"),i.push("   mat[1][1] = 1.0;"),i.push("   mat[1][2] = 0.0;")),i.push("   mat[2][0] = 0.0;"),i.push("   mat[2][1] = 0.0;"),i.push("   mat[2][2] =1.0;"),i.push("}"));i.push("void main(void) {"),i.push("vec4 localPosition = vec4(position, 1.0); "),i.push("vec4 worldPosition;"),cfg.quantizedGeometry&&i.push("localPosition = positionsDecodeMatrix * localPosition;");i.push("mat4 viewMatrix2 = viewMatrix;"),i.push("mat4 modelMatrix2 = modelMatrix;"),e._state.stationary&&i.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===t||"cylindrical"===t?(i.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),i.push("billboard(modelMatrix2);"),i.push("billboard(viewMatrix2);"),i.push("billboard(modelViewMatrix);"),cfg.normals&&(i.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),i.push("billboard(modelNormalMatrix2);"),i.push("billboard(viewNormalMatrix2);"),i.push("billboard(modelViewNormalMatrix);")),i.push("worldPosition = modelMatrix2 * localPosition;"),i.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(i.push("worldPosition = modelMatrix2 * localPosition;"),i.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));cfg.clipping&&i.push("vWorldPosition = worldPosition;");"points"===e._geometry._state.primitiveName&&i.push("gl_PointSize = pointSize;");return i.push("   gl_Position = projMatrix * viewPosition;"),i.push("}"),i}(e),this.fragment=function(e){var t,i=[];if(i.push("// Shadow fragment shader"),i.push("precision "+function(e){return e.getShaderPrecisionFormat?e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0?"highp":e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}(gl)+" float;"),cfg.clipping)for(i.push("varying vec4 vWorldPosition;"),i.push("uniform bool clippable;"),t=0;t<scene.clips.clips.length;t++)i.push("uniform bool clipActive"+t+";"),i.push("uniform vec3 clipPos"+t+";"),i.push("uniform vec3 clipDir"+t+";");if(i.push("vec4 packDepth (float depth) {"),i.push("  const vec4 bitShift = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);"),i.push("  const vec4 bitMask = vec4(1.0/256.0, 1.0/256.0, 1.0/256.0, 0.0);"),i.push("  vec4 comp = fract(depth * bitShift);"),i.push("  comp -= comp.gbaa * bitMask;"),i.push("  return comp;"),i.push("}"),i.push("void main(void) {"),cfg.clipping){for(i.push("if (clippable) {"),i.push("  float dist = 0.0;"),t=0;t<scene.clips.clips.length;t++)i.push("if (clipActive"+t+") {"),i.push("   dist += clamp(dot(-clipDir"+t+".xyz, vWorldPosition.xyz - clipPos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),cfg.solid&&(i.push("  if (gl_FrontFacing == false) {"),i.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),i.push("     return;"),i.push("  }")),i.push("}")}"points"===e._geometry._state.primitiveName&&(i.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),i.push("float r = dot(cxy, cxy);"),i.push("if (r > 1.0) {"),i.push("   discard;"),i.push("}"));return i.push("gl_FragColor = packDepth(gl_FragCoord.z);"),i.push("}"),i}(e)}}(),function(){"use strict";var e=new xeogl.utils.Map({});xeogl.renderer.EmphasisFillRenderer=function(t,i){this.id=e.addItem({}),this._hash=t,this._scene=i.scene,this._useCount=0,this._shaderSource=new xeogl.renderer.EmphasisFillShaderSource(i),this._allocate(i)};var t={};xeogl.renderer.EmphasisFillRenderer.get=function(e){var i=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._clipsState.getHash(),e._geometry.normals?"n":"",e._geometry._state.quantized?"cp":"",e._state.hash].join(";"),s=t[i];return s||(s=new xeogl.renderer.EmphasisFillRenderer(i,e),t[i]=s,xeogl.stats.memory.programs++),s._useCount++,s},xeogl.renderer.EmphasisFillRenderer.prototype.put=function(){0==--this._useCount&&(e.removeItem(this.id),this._program&&this._program.destroy(),delete t[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.EmphasisFillRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.EmphasisFillRenderer.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);var s=this._scene.canvas.gl,r=0===i?t._ghostMaterial._state:1===i?t._highlightMaterial._state:t._selectedMaterial._state,a=t._state,n=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.id!==this._lastMaterialId){var o=r.fillColor,l=r.backfaces;e.backfaces!==l&&(l?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=l),s.uniform4f(this._uFillColor,o[0],o[1],o[2],r.fillAlpha),this._lastMaterialId=r.id}if(s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uModelNormalMatrix&&s.uniformMatrix4fv(this._uModelNormalMatrix,s.FALSE,t.worldNormalMatrix),this._uClippable&&s.uniform1i(this._uClippable,a.clippable),n.combined){var h=t._geometry._getVertexBufs();h.id!==this._lastVertexBufsId&&(h.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf,h.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),h.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(h.normalsBuf,h.quantized?s.BYTE:s.FLOAT),e.bindArray++),this._lastVertexBufsId=h.id)}n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._uUVDecodeMatrix&&s.uniformMatrix3fv(this._uUVDecodeMatrix,!1,n.uvDecodeMatrix),n.combined?n.indicesBufCombined&&(n.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(n.normalsBuf,n.quantized?s.BYTE:s.FLOAT),e.bindArray++),n.indicesBuf?(n.indicesBuf.bind(),e.bindArray++):n.positions),this._lastGeometryId=n.id),n.combined?n.indicesBufCombined&&(s.drawElements(n.primitive,n.indicesBufCombined.numItems,n.indicesBufCombined.itemType,0),e.drawElements++):n.indicesBuf?(s.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),e.drawElements++):n.positions&&(s.drawArrays(s.TRIANGLES,0,n.positions.numItems),e.drawArrays++)},xeogl.renderer.EmphasisFillRenderer.prototype._allocate=function(e){var t=e.scene._lightsState,i=e.scene._clipsState,s=e.scene.canvas.gl;if(this._program=new xeogl.renderer.Program(s,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uModelNormalMatrix=r.getLocation("modelNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var a=0,n=t.lights.length;a<n;a++){switch(t.lights[a].type){case"ambient":this._uLightAmbient[a]=r.getLocation("lightAmbient");break;case"dir":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=r.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a)}}this._uClips=[];for(a=0,n=i.clips.length;a<n;a++)this._uClips.push({active:r.getLocation("clipActive"+a),pos:r.getLocation("clipPos"+a),dir:r.getLocation("clipDir"+a)});this._uFillColor=r.getLocation("fillColor"),this._aPosition=r.getAttribute("position"),this._aNormal=r.getAttribute("normal"),this._uClippable=r.getLocation("clippable"),this._uGammaFactor=r.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},xeogl.renderer.EmphasisFillRenderer.prototype._bindProgram=function(e){var t,i=this._scene,s=i.canvas.gl,r=i._clipsState,a=i._lightsState,n=i.camera,o=n._state;this._program.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,s.uniformMatrix4fv(this._uViewMatrix,!1,o.matrix),s.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.normalMatrix),s.uniformMatrix4fv(this._uProjMatrix,!1,n.project._state.matrix);for(var l=0,h=a.lights.length;l<h;l++)t=a.lights[l],this._uLightAmbient[l]?s.uniform4f(this._uLightAmbient[l],t.color[0],t.color[1],t.color[2],t.intensity):(this._uLightColor[l]&&s.uniform4f(this._uLightColor[l],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[l]&&(s.uniform3fv(this._uLightPos[l],t.pos),this._uLightAttenuation[l]&&s.uniform1f(this._uLightAttenuation[l],t.attenuation)),this._uLightDir[l]&&s.uniform3fv(this._uLightDir[l],t.dir));if(r.clips.length>0){var u,c,d,p=i._clipsState.clips;for(l=0,h=this._uClips.length;l<h;l++)c=(u=this._uClips[l]).active,d=p[l],c&&s.uniform1i(c,d.active),u.pos&&s.uniform3fv(u.pos,d.pos),u.dir&&s.uniform3fv(u.dir,d.dir)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)}}(),function(){"use strict";xeogl.renderer.EmphasisFillShaderSource=function(e){this.vertex=function(e){var t,i,s,r=e.scene,a=r._lightsState,n=function(e){var t=e._geometry._state.primitiveName;if((e._geometry._state.autoVertexNormals||e._geometry._state.normals)&&("triangles"===t||"triangle-strip"===t||"triangle-fan"===t))return!0;return!1}(e),o=r._clipsState.clips.length>0,l=!!e._geometry._state.quantized,h=e._state.billboard,u=e._state.stationary,c=[];c.push("// EmphasisFillShaderSource vertex shader"),c.push("attribute vec3 position;"),c.push("uniform mat4 modelMatrix;"),c.push("uniform mat4 viewMatrix;"),c.push("uniform mat4 projMatrix;"),c.push("uniform vec4 colorize;"),l&&c.push("uniform mat4 positionsDecodeMatrix;");o&&c.push("varying vec4 vWorldPosition;");if(c.push("uniform vec4   lightAmbient;"),c.push("uniform vec4   fillColor;"),n){for(c.push("attribute vec3 normal;"),c.push("uniform mat4 modelNormalMatrix;"),c.push("uniform mat4 viewNormalMatrix;"),t=0,i=a.lights.length;t<i;t++)"ambient"!==(s=a.lights[t]).type&&(c.push("uniform vec4 lightColor"+t+";"),"dir"===s.type&&c.push("uniform vec3 lightDir"+t+";"),"point"===s.type&&c.push("uniform vec3 lightPos"+t+";"),"spot"===s.type&&c.push("uniform vec3 lightPos"+t+";"));l&&(c.push("vec3 octDecode(vec2 oct) {"),c.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),c.push("    if (v.z < 0.0) {"),c.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),c.push("    }"),c.push("    return normalize(v);"),c.push("}"))}c.push("varying vec4 vColor;"),("spherical"===h||"cylindrical"===h)&&(c.push("void billboard(inout mat4 mat) {"),c.push("   mat[0][0] = 1.0;"),c.push("   mat[0][1] = 0.0;"),c.push("   mat[0][2] = 0.0;"),"spherical"===h&&(c.push("   mat[1][0] = 0.0;"),c.push("   mat[1][1] = 1.0;"),c.push("   mat[1][2] = 0.0;")),c.push("   mat[2][0] = 0.0;"),c.push("   mat[2][1] = 0.0;"),c.push("   mat[2][2] =1.0;"),c.push("}"));c.push("void main(void) {"),c.push("vec4 localPosition = vec4(position, 1.0); "),c.push("vec4 worldPosition;"),l&&c.push("localPosition = positionsDecodeMatrix * localPosition;");n&&(l?c.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):c.push("vec4 localNormal = vec4(normal, 0.0); "),c.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),c.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));c.push("mat4 viewMatrix2 = viewMatrix;"),c.push("mat4 modelMatrix2 = modelMatrix;"),u&&c.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===h||"cylindrical"===h?(c.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),c.push("billboard(modelMatrix2);"),c.push("billboard(viewMatrix2);"),c.push("billboard(modelViewMatrix);"),n&&(c.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),c.push("billboard(modelNormalMatrix2);"),c.push("billboard(viewNormalMatrix2);"),c.push("billboard(modelViewNormalMatrix);")),c.push("worldPosition = modelMatrix2 * localPosition;"),c.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(c.push("worldPosition = modelMatrix2 * localPosition;"),c.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));n&&c.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(c.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),c.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),c.push("float lambertian = 1.0;"),n)for(t=0,i=a.lights.length;t<i;t++)if("ambient"!==(s=a.lights[t]).type){if("dir"===s.type)"view"===s.space?c.push("viewLightDir = normalize(lightDir"+t+");"):c.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+t+", 0.0)).xyz);");else{if("point"!==s.type)continue;"view"===s.space?c.push("viewLightDir = normalize(lightPos"+t+" - viewPosition.xyz);"):c.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+t+", 0.0)).xyz);")}c.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),c.push("reflectedColor += lambertian * (lightColor"+t+".rgb * lightColor"+t+".a);")}c.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),o&&c.push("vWorldPosition = worldPosition;");"points"===e._geometry._state.primitiveName&&c.push("gl_PointSize = pointSize;");return c.push("   gl_Position = projMatrix * viewPosition;"),c.push("}"),c}(e),this.fragment=function(e){var t,i,s=e.scene._clipsState,r=e.scene.gammaOutput,a=s.clips.length>0,n=[];n.push("// Lambertian drawing fragment shader"),n.push("precision lowp float;"),r&&(n.push("uniform float gammaFactor;"),n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}"));if(a)for(n.push("varying vec4 vWorldPosition;"),n.push("uniform bool clippable;"),t=0,i=s.clips.length;t<i;t++)n.push("uniform bool clipActive"+t+";"),n.push("uniform vec3 clipPos"+t+";"),n.push("uniform vec3 clipDir"+t+";");if(n.push("varying vec4 vColor;"),n.push("void main(void) {"),a){for(n.push("if (clippable) {"),n.push("  float dist = 0.0;"),t=0,i=s.clips.length;t<i;t++)n.push("if (clipActive"+t+") {"),n.push("   dist += clamp(dot(-clipDir"+t+".xyz, vWorldPosition.xyz - clipPos"+t+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}"points"===e._geometry._state.primitiveName&&(n.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),n.push("float r = dot(cxy, cxy);"),n.push("if (r > 1.0) {"),n.push("   discard;"),n.push("}"));n.push("gl_FragColor = vColor;"),r?n.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):n.push("gl_FragColor = vColor;");return n.push("}"),n}(e)}}(),function(){"use strict";var e=new xeogl.utils.Map({});xeogl.renderer.EmphasisVerticesRenderer=function(t,i){this.id=e.addItem({}),this._hash=t,this._scene=i.scene,this._shaderSource=new xeogl.renderer.EmphasisVerticesShaderSource(i),this._allocate(i)};var t={};xeogl.renderer.EmphasisVerticesRenderer.get=function(e){var i=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._clipsState.getHash(),e._geometry._state.quantized?"cp":"",e._state.hash].join(";"),s=t[i];return s||(s=new xeogl.renderer.EmphasisVerticesRenderer(i,e),t[i]=s,xeogl.stats.memory.programs++),s._useCount++,s},xeogl.renderer.EmphasisVerticesRenderer.prototype.put=function(){0==--this._useCount&&(this._scene.off(this._onWebglcontextrestored),e.removeItem(this.id),this._program&&this._program.destroy(),delete t[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.EmphasisVerticesRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.EmphasisVerticesRenderer.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);var s=this._scene.canvas.gl,r=0===i?t._ghostMaterial._state:1===i?t._highlightMaterial._state:t._selectedMaterial._state,a=t._state,n=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),r.id!==this._lastMaterialId){var o=r.backfaces;if(e.backfaces!==o&&(o?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=o),this._uVertexSize&&s.uniform1f(this._uVertexSize,r.vertexSize),this._uVertexColor){var l=r.vertexColor,h=r.vertexAlpha;s.uniform4f(this._uVertexColor,l[0],l[1],l[2],h)}this._lastMaterialId=r.id}if(s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uModelNormalMatrix&&s.uniformMatrix4fv(this._uModelNormalMatrix,s.FALSE,t.worldNormalMatrix),this._uClippable&&s.uniform1i(this._uClippable,a.clippable),n.combined){var u=t._geometry._getVertexBufs();u.id!==this._lastVertexBufsId&&(u.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(u.positionsBuf,u.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),this._lastVertexBufsId=u.id)}n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),n.combined?n.indicesBufCombined&&(n.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.quantized?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),n.indicesBuf?(n.indicesBuf.bind(),e.bindArray++):n.positions),this._lastGeometryId=n.id),n.combined?n.indicesBufCombined&&(s.drawElements(s.POINTS,n.indicesBufCombined.numItems,n.indicesBufCombined.itemType,0),e.drawElements++):n.indicesBuf?(s.drawElements(s.POINTS,n.indicesBuf.numItems,n.indicesBuf.itemType,0),e.drawElements++):n.positions&&(s.drawArrays(s.POINTS,0,n.positions.numItems),e.drawArrays++)},xeogl.renderer.EmphasisVerticesRenderer.prototype._allocate=function(e){var t=e.scene._clipsState,i=e.scene.canvas.gl;if(this._program=new xeogl.renderer.Program(i,this._shaderSource),this._useCount=0,this._program.errors)this.errors=this._program.errors;else{var s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uClips=[];for(var r=0,a=t.clips.length;r<a;r++)this._uClips.push({active:s.getLocation("clipActive"+r),pos:s.getLocation("clipPos"+r),dir:s.getLocation("clipDir"+r)});this._uVertexColor=s.getLocation("vertexColor"),this._uVertexSize=s.getLocation("vertexSize"),this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uGammaFactor=s.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},xeogl.renderer.EmphasisVerticesRenderer.prototype._bindProgram=function(e,t){var i=this._scene,s=i.canvas.gl,r=i._clipsState,a=this._program,n=i.camera,o=n._state;if(a.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.uniformMatrix4fv(this._uViewMatrix,!1,o.matrix),s.uniformMatrix4fv(this._uProjMatrix,!1,n.project._state.matrix),r.clips.length>0)for(var l,h,u,c=r.clips,d=0,p=this._uClips.length;d<p;d++)h=(l=this._uClips[d]).active,u=c[d],h&&s.uniform1i(h,u.active),l.pos&&s.uniform3fv(l.pos,u.pos),l.dir&&s.uniform3fv(l.dir,u.dir);this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)}}(),function(){"use strict";xeogl.renderer.EmphasisVerticesShaderSource=function(e){this.vertex=function(e){var t=e.scene._clipsState.clips.length>0,i=!!e._geometry._state.quantized,s=e._state.billboard,r=e._state.stationary,a=[];a.push("// Vertices drawing vertex shader"),a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec4 vertexColor;"),a.push("uniform float vertexSize;"),i&&a.push("uniform mat4 positionsDecodeMatrix;");t&&a.push("varying vec4 vWorldPosition;");a.push("varying vec4 vColor;"),("spherical"===s||"cylindrical"===s)&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===s&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),a.push("vec4 worldPosition;"),i&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),r&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===s||"cylindrical"===s?(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"),a.push("billboard(modelViewMatrix);"),a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));a.push("vColor = vertexColor;"),a.push("gl_PointSize = vertexSize;"),t&&a.push("vWorldPosition = worldPosition;");return a.push("   gl_Position = projMatrix * viewPosition;"),a.push("}"),a}(e),this.fragment=function(e){var t,i,s=e.scene._clipsState,r=e.scene.gammaOutput,a=s.clips.length>0,n=[];n.push("// Vertices drawing fragment shader"),n.push("precision lowp float;"),r&&(n.push("uniform float gammaFactor;"),n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}"));if(a)for(n.push("varying vec4 vWorldPosition;"),n.push("uniform bool clippable;"),t=0,i=s.clips.length;t<i;t++)n.push("uniform bool clipActive"+t+";"),n.push("uniform vec3 clipPos"+t+";"),n.push("uniform vec3 clipDir"+t+";");if(n.push("varying vec4 vColor;"),n.push("void main(void) {"),a){for(n.push("if (clippable) {"),n.push("  float dist = 0.0;"),t=0,i=s.clips.length;t<i;t++)n.push("if (clipActive"+t+") {"),n.push("   dist += clamp(dot(-clipDir"+t+".xyz, vWorldPosition.xyz - clipPos"+t+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}n.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),n.push("float r = dot(cxy, cxy);"),n.push("if (r > 1.0) {"),n.push("   discard;"),n.push("}"),n.push("gl_FragColor = vColor;"),r?n.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):n.push("gl_FragColor = vColor;");return n.push("}"),n}(e)}}(),function(){"use strict";var e=new xeogl.utils.Map({});xeogl.renderer.EmphasisEdgesRenderer=function(t,i){this.id=e.addItem({}),this._hash=t,this._scene=i.scene,this._useCount=0,this._shaderSource=new xeogl.renderer.EmphasisEdgesShaderSource(i),this._allocate(i)};var t={};xeogl.renderer.EmphasisEdgesRenderer.get=function(e){var i=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._clipsState.getHash(),e._geometry._state.quantized?"cp":"",e._state.hash].join(";"),s=t[i];return s||(s=new xeogl.renderer.EmphasisEdgesRenderer(i,e),t[i]=s,xeogl.stats.memory.programs++),s._useCount++,s},xeogl.renderer.EmphasisEdgesRenderer.prototype.put=function(){0==--this._useCount&&(e.removeItem(this.id),this._program&&this._program.destroy(),delete t[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.EmphasisEdgesRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.EmphasisEdgesRenderer.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);var s,r,a=this._scene.canvas.gl,n=t._state,o=t._geometry,l=o._state;switch(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),i){case 0:s=t._ghostMaterial._state;break;case 1:s=t._highlightMaterial._state;break;case 2:s=t._selectedMaterial._state;break;case 3:default:s=t._edgeMaterial._state}if(s.id!==this._lastMaterialId){var h=s.backfaces;if(e.backfaces!==h&&(h?a.disable(a.CULL_FACE):a.enable(a.CULL_FACE),e.backfaces=h),e.lineWidth!==s.edgeWidth&&(a.lineWidth(s.edgeWidth),e.lineWidth=s.edgeWidth),this._uEdgeColor){var u=s.edgeColor,c=s.edgeAlpha;a.uniform4f(this._uEdgeColor,u[0],u[1],u[2],c)}this._lastMaterialId=s.id}if(a.uniformMatrix4fv(this._uModelMatrix,a.FALSE,t.worldMatrix),this._uModelNormalMatrix&&a.uniformMatrix4fv(this._uModelNormalMatrix,a.FALSE,t.worldNormalMatrix),this._uClippable&&a.uniform1i(this._uClippable,n.clippable),l.combined){var d=t._geometry._getVertexBufs();d.id!==this._lastVertexBufsId&&(d.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(d.positionsBuf,d.quantized?a.UNSIGNED_SHORT:a.FLOAT),e.bindArray++),this._lastVertexBufsId=d.id)}l.primitive===a.TRIANGLES?r=o._getEdgesIndices():l.primitive===a.LINES&&(r=l.indicesBuf),r&&(l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),l.combined||this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf,l.quantized?a.UNSIGNED_SHORT:a.FLOAT),e.bindArray++),r.bind(),e.bindArray++,this._lastGeometryId=l.id),a.drawElements(a.LINES,r.numItems,r.itemType,0),e.drawElements++)},xeogl.renderer.EmphasisEdgesRenderer.prototype._allocate=function(e){var t=e.scene.canvas.gl,i=e.scene._clipsState;if(this._program=new xeogl.renderer.Program(t,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uClips=[];for(var r=0,a=i.clips.length;r<a;r++)this._uClips.push({active:s.getLocation("clipActive"+r),pos:s.getLocation("clipPos"+r),dir:s.getLocation("clipDir"+r)});this._uEdgeColor=s.getLocation("edgeColor"),this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uGammaFactor=s.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},xeogl.renderer.EmphasisEdgesRenderer.prototype._bindProgram=function(e){var t=this._program,i=this._scene,s=i.canvas.gl,r=i._clipsState,a=i.camera,n=a._state;if(t.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.uniformMatrix4fv(this._uViewMatrix,!1,n.matrix),s.uniformMatrix4fv(this._uProjMatrix,!1,a.project._state.matrix),r.clips.length>0)for(var o,l,h,u=r.clips,c=0,d=this._uClips.length;c<d;c++)l=(o=this._uClips[c]).active,h=u[c],l&&s.uniform1i(l,h.active),o.pos&&s.uniform3fv(o.pos,h.pos),o.dir&&s.uniform3fv(o.dir,h.dir);this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)}}(),function(){"use strict";xeogl.renderer.EmphasisEdgesShaderSource=function(e){this.vertex=function(e){var t=e.scene._clipsState.clips.length>0,i=!!e._geometry._state.quantized,s=e._state.billboard,r=e._state.stationary,a=[];a.push("// Edges drawing vertex shader"),a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec4 edgeColor;"),i&&a.push("uniform mat4 positionsDecodeMatrix;");t&&a.push("varying vec4 vWorldPosition;");a.push("varying vec4 vColor;"),("spherical"===s||"cylindrical"===s)&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===s&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),a.push("vec4 worldPosition;"),i&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),r&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===s||"cylindrical"===s?(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"),a.push("billboard(modelViewMatrix);"),a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));a.push("vColor = edgeColor;"),t&&a.push("vWorldPosition = worldPosition;");return a.push("   gl_Position = projMatrix * viewPosition;"),a.push("}"),a}(e),this.fragment=function(e){var t,i,s=e.scene._clipsState,r=e.scene.gammaOutput,a=s.clips.length>0,n=[];n.push("// Edges drawing fragment shader"),n.push("precision lowp float;"),r&&(n.push("uniform float gammaFactor;"),n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}"));if(a)for(n.push("varying vec4 vWorldPosition;"),n.push("uniform bool clippable;"),t=0,i=s.clips.length;t<i;t++)n.push("uniform bool clipActive"+t+";"),n.push("uniform vec3 clipPos"+t+";"),n.push("uniform vec3 clipDir"+t+";");if(n.push("varying vec4 vColor;"),n.push("void main(void) {"),a){for(n.push("if (clippable) {"),n.push("  float dist = 0.0;"),t=0,i=s.clips.length;t<i;t++)n.push("if (clipActive"+t+") {"),n.push("   dist += clamp(dot(-clipDir"+t+".xyz, vWorldPosition.xyz - clipPos"+t+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}n.push("gl_FragColor = vColor;"),r?n.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):n.push("gl_FragColor = vColor;");return n.push("}"),n}(e)}}(),function(){"use strict";xeogl.Component=Class.extend({__init:function(){var e={},t=arguments[0],i=arguments[1];this.scene=null,this._model=null;var s=null;"xeogl.Scene"===this.type?(this.scene=this,t&&(e=t)):(t?"xeogl.Scene"===t.type?(this.scene=t,s=this.scene,i&&(e=i)):t.isType&&t.isType("xeogl.Component")?(this.scene=t.scene,s=t,i&&(e=i)):(this.scene=xeogl.scene,s=this.scene,e=t):(this.scene=xeogl.scene,s=this.scene),this._renderer=this.scene._renderer),this.meta=e.meta||{},this.id=e.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._adoptees=null;var r="xeogl.Scene"===this.type;this.scene&&!r&&this.scene._addComponent(this),this._updateScheduled=!1,this._init&&this._init(e),s&&s._adopt(this)},type:"xeogl.Component",superTypes:[],_addedToModel:function(e){this._model=e},_removedFromModel:function(e){this._model=null},_props:{model:{get:function(){return this._model}}},isType:function(e){return!(!xeogl._isString(e)&&!(e=e.type))&&xeogl._isComponentType(this.type,e)},_init:function(e){},fire:function(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==i&&(this._events[e]=t||!0);var s,r=this._eventSubs[e];if(r)for(var a in r)r.hasOwnProperty(a)&&(s=r[a],this._eventCallDepth++,this._eventCallDepth<300?s.callback.call(s.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)},on:function(e,t,i){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new xeogl.utils.Map),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={});var s=this._eventSubs[e];s||(s={},this._eventSubs[e]=s);var r=this._subIdMap.addItem();s[r]={callback:t,scope:i||this},this._subIdEvents[r]=e;var a=this._events[e];return void 0!==a&&t.call(i||this,a),r},off:function(e){if(void 0!==e&&null!==e&&this._subIdEvents){var t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];var i=this._eventSubs[t];i&&delete i[e],this._subIdMap.removeItem(e)}}},once:function(e,t,i){var s=this,r=this.on(e,function(e){s.off(r),t(e)},i)},hasSubs:function(e){return this._eventSubs&&!!this._eventSubs[e]},log:function(e){e="[LOG]"+this._message(e),window.console.log(e),this.scene.fire("log",e)},_message:function(e){return" ["+this.type+" "+xeogl._inQuotes(this.id)+"]: "+e},warn:function(e){e="[WARN]"+this._message(e),window.console.warn(e),this.scene.fire("warn",e)},error:function(e){e="[ERROR]"+this._message(e),window.console.error(e),this.scene.fire("error",e)},_attach:function(e){var t=e.name;if(t){var i=e.component,s=e.sceneDefault,r=e.sceneSingleton,a=e.type,n=e.on,o=!1!==e.recompiles,l=!1;if(i)if(xeogl._isNumeric(i)||xeogl._isString(i)){var h=i;if(!(i=this.scene.components[h]))return void this.error("Component not found: "+xeogl._inQuotes(h))}else if(xeogl._isObject(i)){var u=i,c=u.type||a||"xeogl.Component",d=window[c];if(!d)return void this.error("Component type not found: "+c);if(a&&!xeogl._isComponentType(c,a))return void this.error("Expected a "+a+" type or subtype, not a "+c);i=new d(this.scene,u),l=!0}if(!i)if(!0===r){var p=this.scene.types[a];for(var _ in p)if(p.hasOwnProperty){i=p[_];break}if(!i)return this.error("Scene has no default component for '"+t+"'"),null}else if(!0===s&&!(i=this.scene[t]))return this.error("Scene has no default component for '"+t+"'"),null;if(i){if(i.scene.id!==this.scene.id)return void this.error("Not in same scene: "+i.type+" "+xeogl._inQuotes(i.id));if(a&&!i.isType(a))return void this.error("Expected a "+a+" type or subtype: "+i.type+" "+xeogl._inQuotes(i.id))}this._attachments||(this._attachments={});var f,m,g,v=this._attached[t];if(v){if(i&&v.id===i.id)return;var x=this._attachments[v.id];for(m=0,g=(f=x.subs).length;m<g;m++)v.off(f[m]);delete this._attached[t],delete this._attachments[v.id];var M=x.params.onDetached;M&&(xeogl._isFunction(M)?M(v):M.scope?M.callback.call(M.scope,v):M.callback(v)),x.managingLifecycle&&v.destroy()}if(i){var y={params:e,component:i,subs:[],managingLifecycle:l};y.subs.push(i.on("destroyed",function(){y.params.component=null,this._attach(y.params)},this)),o&&y.subs.push(i.on("dirty",function(){this.fire("dirty",this)},this)),this._attached[t]=i,this._attachments[i.id]=y;var b,w,A,E,C=e.onAttached;if(C&&(xeogl._isFunction(C)?C(i):C.scope?C.callback.call(C.scope,i):C.callback(i)),n)for(b in n)if(n.hasOwnProperty(b)){if(w=n[b],xeogl._isFunction(w)?(A=w,E=null):(A=w.callback,E=w.scope),!A)continue;y.subs.push(i.on(b,A,E))}}return o&&this.fire("dirty",this),this.fire(t,i),i}this.error("Component 'name' expected")},_checkComponent:function(e,t){if(xeogl._isObject(t)){if(t.type){if(!xeogl._isComponentType(t.type,e))return void this.error("Expected a "+e+" type or subtype: "+t.type+" "+xeogl._inQuotes(t.id))}else t.type=e;t=new window[t.type](this.scene,t)}else if(xeogl._isID(t)){var i=t;if(!(t=this.scene.components[i]))return void this.error("Component not found: "+xeogl._inQuotes(t.id))}if(t.scene.id===this.scene.id){if(t.isType(e))return t;this.error("Expected a "+e+" type or subtype: "+t.type+" "+xeogl._inQuotes(t.id))}else this.error("Not in same scene: "+t.type+" "+xeogl._inQuotes(t.id))},create:function(e){var t,i;if(xeogl._isObject(e)?(t=e.type||"xeogl.Component",i=xeogl[t.substring(6)]):xeogl._isString(e)?(t=e,i=xeogl[t.substring(6)]):(i=e,t=e.prototype.type),i){if(xeogl._isComponentType(t,"xeogl.Component")){e&&e.id&&this.components[e.id]&&(this.error("Component "+xeogl._inQuotes(e.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),e.id=void 0);var s=new i(this,e);return s&&this._adopt(s),s}this.error("Expected a xeogl.Component type or subtype")}else this.error("Component type not found: "+t)},_adopt:function(e){this._adoptees||(this._adoptees={}),this._adoptees[e.id]||(this._adoptees[e.id]=e),e.on("destroyed",function(){delete this._adoptees[e.id]},this)},_needUpdate:function(e){this._updateScheduled||(this._updateScheduled=!0,0===e?xeogl.deferTask(this._doUpdate,this):xeogl.scheduleTask(this._doUpdate,this))},_doUpdate:function(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())},_update:null,destroy:function(){if(!this.destroyed){var e,t,i,s,r,a;if(this._attachments)for(e in this._attachments)if(this._attachments.hasOwnProperty(e)){for(i=(t=this._attachments[e]).component,r=0,a=(s=t.subs).length;r<a;r++)i.off(s[r]);t.managingLifecycle&&i.destroy()}if(this._adoptees)for(e in this._adoptees)this._adoptees.hasOwnProperty(e)&&((i=this._adoptees[e]).destroy(),delete this._adoptees[e]);this._destroy&&this._destroy(),this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._adoptees=null,this._updateScheduled=!1,this.fire("destroyed",this.destroyed=!0)}},_destroy:function(){}})}(),function(){"use strict";var e;xeogl.Scene=xeogl.Component.extend({type:"xeogl.Scene",_init:function(e){var t=this,i=!!e.transparent;this.loading=0,this.startTime=(new Date).getTime(),this.models={},this.objects={},this.guidObjects={},this.entityTypes={},this.entities={},this.visibleEntities={},this.ghostedEntities={},this.highlightedEntities={},this.selectedEntities={},this._objectGUIDs=null,this._entityIds=null,this._visibleEntityIds=null,this._ghostedEntityIds=null,this._highlightedEntityIds=null,this._selectedEntityIds=null,this.meshes={},this._needRecompileMeshes=!1,this.types={},this.components={},this.rootObjects={},this.clips={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.canvas=new xeogl.Canvas(this,{canvas:e.canvas,transparent:i,backgroundColor:e.backgroundColor,backgroundImage:e.backgroundImage,webgl2:!1!==e.webgl2,contextAttr:e.contextAttr||{},simulateWebGLContextLost:e.simulateWebGLContextLost}),this.canvas.on("boundary",function(){t._renderer.imageDirty()}),this.canvas.on("webglContextFailed",function(){alert("xeogl failed to find WebGL!")}),this._renderer=new xeogl.renderer.Renderer(xeogl.stats,this,{transparent:i}),this._clipsState=new function(){this.clips=[];var e=null;this.getHash=function(){if(e)return e;var t=this.clips;if(0===t.length)return this.hash=";";for(var i=[],s=0,r=t.length;s<r;s++)t[s],i.push("cp");return i.push(";"),e=i.join("")},this.addClip=function(t){this.clips.push(t),e=null},this.removeClip=function(t){for(var i=0,s=this.clips.length;i<s;i++)if(this.clips[i].id===t.id)return this.clips.splice(i,1),void(e=null)}},this._lightsState=new function(){const e=xeogl.math.vec3([0,0,0]);var t=xeogl.math.vec3();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];var i=null,s=null;this.getHash=function(){if(i)return i;for(var e,t=[],s=this.lights,r=0,a=s.length;r<a;r++)e=s[r],t.push("/"),t.push(e.type),t.push("world"===e.space?"w":"v"),e.shadow&&t.push("sh");return this.lightMaps.length>0&&t.push("/lm"),this.reflectionMaps.length>0&&t.push("/rm"),t.push(";"),i=t.join("")},this.addLight=function(e){this.lights.push(e),s=null,i=null},this.removeLight=function(e){for(var t=0,r=this.lights.length;t<r;t++){if(this.lights[t].id===e.id)return this.lights.splice(t,1),s&&s.id===e.id&&(s=null),void(i=null)}},this.addReflectionMap=function(e){this.reflectionMaps.push(e),i=null},this.removeReflectionMap=function(e){for(var t=0,s=this.reflectionMaps.length;t<s;t++)if(this.reflectionMaps[t].id===e.id)return this.reflectionMaps.splice(t,1),void(i=null)},this.addLightMap=function(e){this.lightMaps.push(e),i=null},this.removeLightMap=function(e){for(var t=0,s=this.lightMaps.length;t<s;t++)if(this.lightMaps[t].id===e.id)return this.lightMaps.splice(t,1),void(i=null)},this.getAmbientColor=function(){if(!s)for(var i=0,r=this.lights.length;i<r;i++){var a=this.lights[i];if("ambient"===a.type){s=a;break}}if(s){var n=s.color,o=s.intensity;return t[0]=n[0]*o,t[1]=n[1]*o,t[2]=n[2]*o,t}return e}},this.input=new xeogl.Input(this,{element:this.canvas.canvas}),xeogl._addScene(this);var s=e.components;if(s)for(var r,a,n,o=0,l=s.length;o<l;o++)(a=(r=s[o]).type)&&(n=window[a])&&new n(this,r);this._initDefaults(),this._viewport=new xeogl.Viewport(this,{id:"default.viewport",autoBoundary:!0}),this._camera=new xeogl.Camera(this,{id:"default.camera"}),new xeogl.DirLight(this,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),new xeogl.DirLight(this,{dir:[-.8,-.4,-.4],color:[1,1,1],intensity:1,space:"view"}),new xeogl.DirLight(this,{dir:[.2,-.8,.8],color:[.6,.6,.6],intensity:1,space:"view"});this._viewport;var h=this._renderer;this._camera.on("dirty",function(){h.imageDirty()}),this.ticksPerRender=e.ticksPerRender,this.passes=e.passes,this.clearEachPass=e.clearEachPass,this.gammaInput=e.gammaInput,this.gammaOutput=e.gammaOutput,this.gammaFactor=e.gammaFactor},_initDefaults:function(){this.geometry,this.material,this.ghostMaterial,this.outlineMaterial},_addComponent:function(e){if(e.id&&this.components[e.id]&&(this.error("Component "+xeogl._inQuotes(e.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),e.id=null),!e.id)for(void 0===window.nextID&&(window.nextID=0),e.id="_"+window.nextID++;this.components[e.id];)e.id=xeogl.math.createUUID();this.components[e.id]=e;var t=e.type,i=this.types[e.type];i||(i=this.types[t]={}),i[e.id]=e},_removeComponent:function(e){delete this.components[e.id];var t=this.types[e.type];t&&(delete t[e.id],xeogl._isEmptyObject(t)&&delete this.types[e.type])},_clipCreated:function(e){this.clips[e.id]=e,this.scene._clipsState.addClip(e._state),this._needRecompileMeshes=!0},_lightCreated:function(e){this.lights[e.id]=e,this.scene._lightsState.addLight(e._state),this._needRecompileMeshes=!0},_lightMapCreated:function(e){this.lightMaps[e.id]=e,this.scene._lightsState.addLightMap(e._state),this._needRecompileMeshes=!0},_reflectionMapCreated:function(e){this.reflectionMaps[e.id]=e,this.scene._lightsState.addReflectionMap(e._state),this._needRecompileMeshes=!0},_objectCreated:function(e){this.objects[e.id]=e,e.guid&&(this.guidObjects[e.id]=e,this._objectGUIDs=null),e.parent||(this.rootObjects[e.id]=e),xeogl.stats.components.objects++},_meshCreated:function(e){this.meshes[e.id]=e,xeogl.stats.components.meshes++},_modelCreated:function(e){this.models[e.id]=e,xeogl.stats.components.models++},_clipDestroyed:function(e){delete this.clips[e.id],this.scene._clipsState.removeClip(e._state),this._needRecompileMeshes=!0},_lightDestroyed:function(e){delete this.lights[e.id],this.scene._lightsState.removeLight(e._state),this._needRecompileMeshes=!0},_lightMapDestroyed:function(e){delete this.lightMaps[e.id],this.scene._lightsState.removeLightMap(e._state),this._needRecompileMeshes=!0},_reflectionMapDestroyed:function(e){delete this.reflectionMaps[e.id],this.scene._lightsState.removeReflectionMap(e._state),this._needRecompileMeshes=!0},_objectDestroyed:function(e){delete this.objects[e.id],e.guid&&(delete this.guidObjects[e.guid],this._objectGUIDs=null),e.parent||delete this.rootObjects[e.id],xeogl.stats.components.objects--},_meshDestroyed:function(e){xeogl.stats.components.meshes--,delete this.meshes[e.id],xeogl.stats.components.meshes--},_modelDestroyed:function(e){this.models[e.id]=e,xeogl.stats.components.models++},_entityTypeAssigned:function(e,t){this.entities[e.id]=e;var i=this.entityTypes[t];i||(i={},this.entityTypes[t]=i),i[e.id]=e,this._entityIds=null,this._entityTypeIds=null},_entityTypeRemoved:function(e,t){delete this.entities[e.id];var i=this.entityTypes[t];i&&delete i[e.id],this._entityIds=null,this._entityTypeIds=null},_entityVisibilityUpdated:function(e,t){t?this.visibleEntities[e.id]=e:delete this.visibleEntities[e.id],this._visibleEntityIds=null},_entityGhostedUpdated:function(e,t){t?this.ghostedEntities[e.id]=e:delete this.ghostedEntities[e.id],this._ghostedEntityIds=null},_entityHighlightedUpdated:function(e,t){t?this.highlightedEntities[e.id]=e:delete this.highlightedEntities[e.id],this._highlightedEntityIds=null},_entitySelectedUpdated:function(e,t){t?this.selectedEntities[e.id]=e:delete this.selectedEntities[e.id],this._selectedEntityIds=null},_webglContextLost:function(){for(var e in this.canvas.spinner.processes++,this.components)if(this.components.hasOwnProperty(e)){var t=this.components[e];t._webglContextLost&&t._webglContextLost()}this._renderer.webglContextLost()},_webglContextRestored:function(){var e=this.canvas.gl;for(var t in this.components)if(this.components.hasOwnProperty(t)){var i=this.components[t];i._webglContextRestored&&i._webglContextRestored(e)}this._renderer.webglContextRestored(e),this.canvas.spinner.processes--},render:(e={sceneId:null,pass:0},function(t){if(this._needRecompileMeshes&&(this._recompileMeshes(),this._needRecompileMeshes=!1),this.loading>0||this.canvas.spinner.processes>0)this.canvas.canvas.style.opacity=0;else{var i=Number.parseFloat(this.canvas.canvas.style.opacity);i<1&&(i+=.1,this.canvas.canvas.style.opacity=i),e.sceneId=this.id;var s,r,a=this._passes,n=this._clearEachPass;for(s=0;s<a;s++)e.pass=s,this.fire("rendering",e,!0),r=n||0===s,this._renderer.render({pass:s,clear:r,force:t}),this.fire("rendered",e,!0);this._saveAmbientColor()}}),_recompileMeshes:function(){for(var e in this.meshes)this.meshes.hasOwnProperty(e)&&this.meshes[e]._compile()},_saveAmbientColor:function(){var e=this.canvas;if(e.transparent||e.backgroundImage||e.backgroundColor)this._lastAmbientColor=null;else{var t=this._lightsState.getAmbientColor();this._lastAmbientColor&&this._lastAmbientColor[0]===t[0]&&this._lastAmbientColor[1]===t[1]&&this._lastAmbientColor[2]===t[2]&&this._lastAmbientColor[3]===t[3]||(e.backgroundColor=t,this._lastAmbientColor||(this._lastAmbientColor=xeogl.math.vec4([0,0,0,1])),this._lastAmbientColor.set(t))}},_props:{objectGUIDs:{get:function(){return this._objectGUIDs||(this._objectGUIDs=Object.keys(this.guidObjects)),this._objectGUIDs}},entityTypeIds:{get:function(){return this._entityTypeIds||(this._entityTypeIds=Object.keys(this.entityTypes)),this._entityTypeIds}},entityIds:{get:function(){return this._entityIds||(this._entityIds=Object.keys(this.entities)),this._entityIds}},visibleEntityIds:{get:function(){return this._visibleEntityIds||(this._visibleEntityIds=Object.keys(this.visibleEntities)),this._visibleEntityIds}},ghostedEntityIds:{get:function(){return this._ghostedEntityIds||(this._ghostedEntityIds=Object.keys(this.ghostedEntities)),this._ghostedEntityIds}},highlightedEntityIds:{get:function(){return this._highlightedEntityIds||(this._highlightedEntityIds=Object.keys(this.highlightedEntities)),this._highlightedEntityIds}},selectedEntityIds:{get:function(){return this._selectedEntityIds||(this._selectedEntityIds=Object.keys(this.selectedEntities)),this._selectedEntityIds}},ticksPerRender:{set:function(e){void 0===e||null===e?e=1:(!xeogl._isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._ticksPerRender&&(this._ticksPerRender=e)},get:function(){return this._ticksPerRender}},passes:{set:function(e){void 0===e||null===e?e=1:(!xeogl._isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'passes': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._passes&&(this._passes=e,this._renderer.imageDirty())},get:function(){return this._passes}},clearEachPass:{set:function(e){(e=!!e)!==this._clearEachPass&&(this._clearEachPass=e,this._renderer.imageDirty())},get:function(){return this._clearEachPass}},gammaInput:{set:function(e){(e=!1!==e)!==this._renderer.gammaInput&&(this._renderer.gammaInput=e,this._needRecompileMeshes=!0)},get:function(){return this._renderer.gammaInput}},gammaOutput:{set:function(e){(e=!1!==e)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=e,this._needRecompileMeshes=!0)},get:function(){return this._renderer.gammaOutput}},gammaFactor:{set:function(e){(e=void 0===e||null===e?2.2:e)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=e,this._renderer.imageDirty())},get:function(){return this._renderer.gammaFactor}},geometry:{get:function(){return this.components["default.geometry"]||new xeogl.BoxGeometry(this,{id:"default.geometry",isDefault:!0})}},material:{get:function(){return this.components["default.material"]||new xeogl.PhongMaterial(this,{id:"default.material",isDefault:!0,emissive:[.4,.4,.4]})}},ghostMaterial:{get:function(){return this.components["default.ghostMaterial"]||new xeogl.EmphasisMaterial(this,{id:"default.ghostMaterial",preset:"sepia",isDefault:!0})}},highlightMaterial:{get:function(){return this.components["default.highlightMaterial"]||new xeogl.EmphasisMaterial(this,{id:"default.highlightMaterial",preset:"yellowHighlight",isDefault:!0})}},selectedMaterial:{get:function(){return this.components["default.selectedMaterial"]||new xeogl.EmphasisMaterial(this,{id:"default.selectedMaterial",preset:"greenSelected",isDefault:!0})}},edgeMaterial:{get:function(){return this.components["default.edgeMaterial"]||new xeogl.EdgeMaterial(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,isDefault:!0})}},outlineMaterial:{get:function(){return this.components["default.outlineMaterial"]||new xeogl.OutlineMaterial(this,{id:"default.outlineMaterial",isDefault:!0})}},viewport:{get:function(){return this._viewport}},camera:{get:function(){return this._camera}},center:{get:function(){if(this._aabbDirty||!this._center){this._center&&this._center||(this._center=xeogl.math.vec3());var e=this.aabb;this._center[0]=(e[0]+e[3])/2,this._center[1]=(e[1]+e[4])/2,this._center[2]=(e[2]+e[5])/2}return this._center}},aabb:{get:function(){if(this._aabbDirty){this._aabb||(this._aabb=xeogl.math.AABB3());var e,t,i=xeogl.math.MAX_DOUBLE,s=xeogl.math.MAX_DOUBLE,r=xeogl.math.MAX_DOUBLE,a=-xeogl.math.MAX_DOUBLE,n=-xeogl.math.MAX_DOUBLE,o=-xeogl.math.MAX_DOUBLE,l=this.meshes;for(var h in l)if(l.hasOwnProperty(h)){if(!(t=l[h]).collidable)continue;(e=t.aabb)[0]<i&&(i=e[0]),e[1]<s&&(s=e[1]),e[2]<r&&(r=e[2]),e[3]>a&&(a=e[3]),e[4]>n&&(n=e[4]),e[5]>o&&(o=e[5])}this._aabb[0]=i,this._aabb[1]=s,this._aabb[2]=r,this._aabb[3]=a,this._aabb[4]=n,this._aabb[5]=o,this._aabbDirty=!1}return this._aabb}}},_setBoundaryDirty:function(){this._aabbDirty=!0,this.fire("boundary")},pick:function(){var e=xeogl.math,t=e.vec3(),i=e.vec3(),s=e.vec3(),r=e.vec3(),a=e.vec3(),n=e.vec3(),o=e.vec4(),l=e.vec3(),h=e.vec3(),u=e.vec3(),c=e.vec3(),d=e.vec3(),p=e.vec3(),_=e.vec3(),f=e.vec3(),m=e.vec3(),g=e.vec4(),v=e.vec4(),x=e.vec4(),M=e.vec3(),y=e.vec3(),b=e.vec3(),w=e.vec3(),A=e.vec3(),E=e.vec3(),C=e.vec3(),P=e.vec3(),S=e.vec3(),D=e.vec3(),T=e.vec3();function F(e,t){for(var i,s={},r=0,a=t.length;r<a;r++)i=t[r],e.meshes[i]?s[i]=!0:e.warn("pick(): Mesh not found: "+i);return s}return function(B){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;(B=B||{}).pickSurface=B.pickSurface||B.rayPick,B.canvasPos||B.origin&&B.direction||this.warn("picking without canvasPos or ray origin and direction");var L=B.includeMeshes||B.include;L&&(B.includeMeshIds=F(this,L));var R=B.excludeMeshes||B.exclude;R&&(B.excludeMeshIds=F(this,R));var k=this._renderer.pick(B);if(k){if(k.object=k.mesh,B.pickSurface&&void 0!==k.primIndex&&k.primIndex>-1){var I=k.mesh.geometry._state;if("triangles"===I.primitiveName){k.primitive="triangle";var V,N,U,O,G=k.primIndex,z=I.indices,j=I.positions;if(z){var W=z[G+0],Y=z[G+1],X=z[G+2];n[0]=W,n[1]=Y,n[2]=X,k.indices=n,V=3*W,N=3*Y,U=3*X}else U=(N=(V=3*G)+3)+3;if(s[0]=j[V+0],s[1]=j[V+1],s[2]=j[V+2],r[0]=j[N+0],r[1]=j[N+1],r[2]=j[N+2],a[0]=j[U+0],a[1]=j[U+1],a[2]=j[U+2],I.quantized){var H=I.positionsDecodeMatrix;H&&(e.decompressPosition(s,H,s),e.decompressPosition(r,H,r),e.decompressPosition(a,H,a))}B.canvasPos?(O=B.canvasPos,k.canvasPos=B.canvasPos,e.canvasPosToLocalRay(this.camera,k.mesh,O,t,i)):B.origin&&B.direction&&e.worldRayToLocalRay(k.mesh,B.origin,B.direction,t,i),e.normalizeVec3(i),e.rayPlaneIntersect(t,i,s,r,a,o),k.localPos=o,k.position=o,g[0]=o[0],g[1]=o[1],g[2]=o[2],g[3]=1,e.transformVec4(k.mesh.worldMatrix,g,v),l[0]=v[0],l[1]=v[1],l[2]=v[2],k.worldPos=l,e.transformVec4(k.mesh.scene.camera.matrix,v,x),h[0]=x[0],h[1]=x[1],h[2]=x[2],k.viewPos=h,e.cartesianToBarycentric(o,s,r,a,u),k.bary=u;var q=I.normals;if(q){if(I.quantized){var K=2*W,Q=2*Y,Z=2*X;e.octDecodeVec2(q.subarray(K,K+2),c),e.octDecodeVec2(q.subarray(Q,Q+2),d),e.octDecodeVec2(q.subarray(Z,Z+2),p)}else c[0]=q[V],c[1]=q[V+1],c[2]=q[V+2],d[0]=q[N],d[1]=q[N+1],d[2]=q[N+2],p[0]=q[U],p[1]=q[U+1],p[2]=q[U+2];var J=e.addVec3(e.addVec3(e.mulVec3Scalar(c,u[0],M),e.mulVec3Scalar(d,u[1],y),b),e.mulVec3Scalar(p,u[2],w),A);k.normal=e.transformVec3(k.mesh.worldNormalMatrix,J,E)}var $=I.uv;if($){if(_[0]=$[2*W],_[1]=$[2*W+1],f[0]=$[2*Y],f[1]=$[2*Y+1],m[0]=$[2*X],m[1]=$[2*X+1],I.quantized){var ee=I.uvDecodeMatrix;ee&&(e.decompressUV(_,ee,_),e.decompressUV(f,ee,f),e.decompressUV(m,ee,m))}k.uv=e.addVec3(e.addVec3(e.mulVec2Scalar(_,u[0],C),e.mulVec2Scalar(f,u[1],P),S),e.mulVec2Scalar(m,u[2],D),T)}}}return k.mesh.fire("picked",k),k}}}(),getAABB:function(){var e,t=1e5,i=1e5,s=1e5,r=-1e5,a=-1e5,n=-1e5;function o(o){var l=o.aabb;l[0]<t&&(t=l[0]),l[1]<i&&(i=l[1]),l[2]<s&&(s=l[2]),l[3]>r&&(r=l[3]),l[4]>a&&(a=l[4]),l[5]>n&&(n=l[5]),e=!0}return function(l){if(void 0===l)return this.aabb;if(xeogl._isString(l)){var h=this.objects[l];if(h)return h.aabb;l=[l]}if(0===l.length)return this.aabb;if(t=1e5,i=1e5,s=1e5,r=-1e5,a=-1e5,n=-1e5,this.withObjects(l,o),e){var u=new xeogl.math.AABB3;return u[0]=t,u[1]=i,u[2]=s,u[3]=r,u[4]=a,u[5]=n,u}return this.aabb}}(),clear:function(){for(var e in this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this._initDefaults()},clearLights:function(){for(var e=Object.keys(this.lights),t=0,i=e.length;t<i;t++)this.lights[e[t]].destroy()},clearClips:function(){for(var e=Object.keys(this.clips),t=0,i=e.length;t<i;t++)this.clips[e[t]].destroy()},setVisible:function(){var e;function t(t){var i=t.visible!=e;return t.visible=e,i}return function(i,s){return e=s,this.withObjects(i,t)}}(),setCulled:function(){var e;function t(t){var i=t.culled!=e;return t.culled=e,i}return function(i,s){return e=s,this.withObjects(i,t)}}(),setSelected:function(){var e;function t(t){var i=t.selected!=e;return t.selected=e,i}return function(i,s){return e=s,this.withObjects(i,t)}}(),setHighlighted:function(){var e;function t(t){var i=t.highlighted!=e;return t.highlighted=e,i}return function(i,s){return e=s,this.withObjects(i,t)}}(),setGhosted:function(){var e;function t(t){var i=t.ghosted!=e;return t.ghosted=e,i}return function(i,s){return e=s,this.withObjects(i,t)}}(),setEdges:function(){var e;function t(t){var i=t.edges!=e;return t.edges=e,i}return function(i,s){return e=s,this.withObjects(i,t)}}(),setOutlined:void 0,setColorize:function(){var e;function t(t){t.colorize=e}return function(i,s){e=s,this.withObjects(i,t)}}(),setOpacity:function(){var e;function t(t){t.opacity=e}return function(i,s){e=s,this.withObjects(i,t)}}(),setPickable:function(){var e;function t(t){var i=t.pickable!=e;return t.pickable=e,i}return function(i,s){return e=s,this.withObjects(i,t)}}(),withObjects:function(e,t){xeogl._isString(e)&&(e=[e]);for(var i=!1,s=0,r=e.length;s<r;s++){var a=e[s],n=this.objects[a];if(n)i=t(n)||i;else if(n=this.guidObjects[a])i=t(n)||i;else{var o=this.entityTypes[a];if(o)for(var l in o)o.hasOwnProperty(l)&&(i=t(o[l])||i)}}return i},_destroy:function(){this.clear(),this.canvas.gl=null,this.models=null,this.objects=null,this.guidObjects=null,this.entityTypes=null,this.entities=null,this.visibleEntities=null,this.ghostedEntities=null,this.highlightedEntities=null,this.selectedEntities=null,this.clips=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectGUIDs=null,this._entityIds=null,this._visibleEntityIds=null,this._ghostedEntityIds=null,this._highlightedEntityIds=null,this._selectedEntityIds=null,this.meshes=null,this.types=null,this.components=null,this.rootObjects=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}})}(),xeogl.Object=xeogl.Component.extend({type:"xeogl.Object",_init:function(e){var t=xeogl.math;if(this._guid=e.guid,this._parent=null,this._childList=[],this._childMap={},this._childIDs=null,this._aabb=null,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._scale=t.vec3(),this._quaternion=t.identityQuaternion(),this._rotation=t.vec3(),this._position=t.vec3(),this._worldMatrix=t.identityMat4(),this._worldNormalMatrix=t.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0,e.matrix?this.matrix=e.matrix:(this.scale=e.scale,this.position=e.position,e.quaternion||(this.rotation=e.rotation)),e.entityType&&(this._entityType=e.entityType,this.scene._entityTypeAssigned(this,this._entityType)),this.visible=e.visible,this.culled=e.culled,this.pickable=e.pickable,this.clippable=e.clippable,this.collidable=e.collidable,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.outlined=e.outlined,this.solid=e.solid,this.ghosted=e.ghosted,this.highlighted=e.highlighted,this.selected=e.selected,this.edges=e.edges,this.aabbVisible=e.aabbVisible,this.layer=e.layer,this.colorize=e.colorize,this.opacity=e.opacity,e.children)for(var i=e.children,s=0,r=i.length;s<r;s++)this.addChild(i[s],e.inheritStates);e.parent&&e.parent.addChild(this),this.scene._objectCreated(this)},_setLocalMatrixDirty:function(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()},_setWorldMatrixDirty:function(){if(this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0,this._childList)for(var e=0,t=this._childList.length;e<t;e++)this._childList[e]._setWorldMatrixDirty()},_buildWorldMatrix:function(){var e=this.matrix;if(this._parent)xeogl.math.mulMat4(this._parent.worldMatrix,e,this._worldMatrix);else for(var t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1},_buildWorldNormalMatrix:function(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=xeogl.math.mat4()),xeogl.math.inverseMat4(this._worldMatrix,this._worldNormalMatrix),xeogl.math.transposeMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1},_setAABBDirty:function(){return function(){if(function e(t){if(t._aabbDirty=!0,t.fire("boundary",!0),t._childList)for(var i=0,s=t._childList.length;i<s;i++)e(t._childList[i])}(this),this.collidable)for(var e=this;e;e=e._parent)e._aabbDirty=!0,e.fire("boundary",!0)}}(),_updateAABB:function(){if(this.scene._aabbDirty=!0,this._aabb||(this._aabb=xeogl.math.AABB3()),this._buildMeshAABB)this._buildMeshAABB(this.worldMatrix,this._aabb);else{var e;xeogl.math.collapseAABB3(this._aabb);for(var t=0,i=this._childList.length;t<i;t++)(e=this._childList[t]).collidable&&xeogl.math.expandAABB3(this._aabb,e.aabb);this._aabbCenter||(this._aabbCenter=new Float32Array(3)),xeogl.math.getAABB3Center(this._aabb,this._aabbCenter)}this._aabbDirty=!1},addChild:function(e,t){if(xeogl._isNumeric(e)||xeogl._isString(e)){var i=e;if(!(e=this.scene.objects[i]))return void this.warn("Object not found: "+xeogl._inQuotes(i))}else if(xeogl._isObject(e)){throw"addChild( * ) not implemented"}else{if(!e.isType("xeogl.Object"))return void this.error("Not a xeogl.Object: "+e.id);if(e._parent){if(e._parent.id===this.id)return void this.warn("Already a child object: "+e.id);e._parent.removeChild(e)}}e.id;if(e.scene.id===this.scene.id)return delete this.scene.rootObjects[e.id],this._childList.push(e),this._childMap[e.id]=e,this._childIDs=null,e._parent=this,t&&(e.visible=this.visible,e.culled=this.culled,e.ghosted=this.ghosted,e.highlited=this.highlighted,e.selected=this.selected,e.edges=this.edges,e.outlined=this.outlined,e.clippable=this.clippable,e.pickable=this.pickable,e.collidable=this.collidable,e.castShadow=this.castShadow,e.receiveShadow=this.receiveShadow,e.colorize=this.colorize,e.opacity=this.opacity),e._setWorldMatrixDirty(),e._setAABBDirty(),e;this.error("Object not in same Scene: "+e.id)},removeChild:function(e){for(var t=0,i=this._childList.length;t<i;t++)if(this._childList[t].id===e.id)return e._parent=null,this._childList=this._childList.splice(t,1),delete this._childMap[e.id],this._childIDs=null,this.scene.rootObjects[e.id]=e,e._setWorldMatrixDirty(),e._setAABBDirty(),void this._setAABBDirty()},removeChildren:function(){for(var e,t=0,i=this._childList.length;t<i;t++)(e=this._childList[t])._parent=null,this.scene.rootObjects[e.id]=e,e._setWorldMatrixDirty(),e._setAABBDirty();this._childList=[],this._childMap={},this._childIDs=null,this._setAABBDirty()},rotate:function(){var e=new Float32Array(4),t=new Float32Array(4),i=new Float32Array(4);return function(s,r){return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=r*xeogl.math.DEGTORAD,xeogl.math.angleAxisToQuaternion(e,t),xeogl.math.mulQuaternions(this.quaternion,t,i),this.quaternion=i,this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty(),this}}(),rotateOnWorldAxis:function(){var e=new Float32Array(4),t=new Float32Array(4);return function(i,s){return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=s*xeogl.math.DEGTORAD,xeogl.math.angleAxisToQuaternion(e,t),xeogl.math.mulQuaternions(t,this.quaternion,t),this}}(),rotateX:function(){var e=new Float32Array([1,0,0]);return function(t){return this.rotate(e,t)}}(),rotateY:function(){var e=new Float32Array([0,1,0]);return function(t){return this.rotate(e,t)}}(),rotateZ:function(){var e=new Float32Array([0,0,1]);return function(t){return this.rotate(e,t)}}(),translate:function(){var e=new Float32Array(3),t=new Float32Array(3);return function(i,s){return xeogl.math.vec3ApplyQuaternion(this.quaternion,i,e),xeogl.math.mulVec3Scalar(e,s,t),xeogl.math.addVec3(this.position,t,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty(),this}}(),translateX:function(){var e=new Float32Array([1,0,0]);return function(t){return this.translate(e,t)}}(),translateY:function(){var e=new Float32Array([0,1,0]);return function(t){return this.translate(e,t)}}(),translateZ:function(){var e=new Float32Array([0,0,1]);return function(t){return this.translate(e,t)}}(),_props:{guid:{get:function(){return this._guid}},entityType:{get:function(){return this._entityType}},numChildren:{get:function(){return this._childList.length}},children:{get:function(){return this._childList}},childMap:{get:function(){return this._childMap}},childIDs:{get:function(){return this._childIDs||(this._childIDs=Object.keys(this._childMap)),this._childIDs}},parent:{set:function(e){if(xeogl._isNumeric(e)||xeogl._isString(e)){var t=e;if(!(e=this.scene.objects[t]))return void this.warn("Group not found: "+xeogl._inQuotes(t))}e.scene.id===this.scene.id?this._parent&&this._parent.id===e.id?this.warn("Already a child of Group: "+e.id):e.addChild(this):this.error("Group not in same Scene: "+e.id)},get:function(){return this._parent}},position:{set:function(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()},get:function(){return this._position}},rotation:{set:function(e){this._rotation.set(e||[0,0,0]),xeogl.math.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()},get:function(){return this._rotation}},quaternion:{set:function(e){this._quaternion.set(e||[0,0,0,1]),xeogl.math.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()},get:function(){return this._quaternion}},scale:{set:function(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()},get:function(){return this._scale}},matrix:{set:function(){var e=xeogl.math.identityMat4();return function(t){this.__localMatrix||(this.__localMatrix=xeogl.math.identityMat4()),this.__localMatrix.set(t||e),xeogl.math.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()}}(),get:function(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=xeogl.math.identityMat4()),xeogl.math.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix}},worldMatrix:{get:function(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}},worldNormalMatrix:{get:function(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}},aabb:{get:function(){return this._aabbDirty&&this._updateAABB(),this._aabb}},center:{get:function(){return this._aabbDirty&&this._updateAABB(),this._aabbCenter}},visible:{set:function(e){e=!1!==e,this._visible=e;for(var t=0,i=this._childList.length;t<i;t++)this._childList[t].visible=e;this._entityType&&this.scene._entityVisibilityUpdated(this,e)},get:function(){return this._visible}},highlighted:{set:function(e){e=!!e,this._highlighted=e;for(var t=0,i=this._childList.length;t<i;t++)this._childList[t].highlighted=e;this._entityType&&this.scene._entityHighlightedUpdated(this,e)},get:function(){return this._highlighted}},ghosted:{set:function(e){e=!!e,this._ghosted=e;for(var t=0,i=this._childList.length;t<i;t++)this._childList[t].ghosted=e;this._entityType&&this.scene._entityGhostedUpdated(this,e)},get:function(){return this._ghosted}},selected:{set:function(e){e=!!e,this._selected=e;for(var t=0,i=this._childList.length;t<i;t++)this._childList[t].selected=e;this._entityType&&this.scene._entitySelectedUpdated(this,e)},get:function(){return this._selected}},edges:{set:function(e){e=!!e,this._edges=e;for(var t=0,i=this._childList.length;t<i;t++)this._childList[t].edges=e},get:function(){return this._edges}},culled:{set:function(e){e=!!e,this._culled=e;for(var t=0,i=this._childList.length;t<i;t++)this._childList[t].culled=e},get:function(){return this._culled}},clippable:{set:function(e){e=!1!==e,this._clippable=e;for(var t=0,i=this._childList.length;t<i;t++)this._childList[t].clippable=e},get:function(){return this._clippable}},collidable:{set:function(e){e=!1!==e,this._collidable=e;for(var t=0,i=this._childList.length;t<i;t++)this._childList[t].collidable=e},get:function(){return this._collidable}},pickable:{set:function(e){e=!1!==e,this._pickable=e;for(var t=0,i=this._childList.length;t<i;t++)this._childList[t].pickable=e},get:function(){return this._pickable}},colorize:{set:function(e){var t=this._colorize;t||((t=this._colorize=new Float32Array(4))[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);for(var i=0,s=this._childList.length;i<s;i++)this._childList[i].colorize=t},get:function(){return this._colorize.slice(0,3)}},opacity:{set:function(e){var t=this._colorize;t||((t=this._colorize=new Float32Array(4))[0]=1,t[1]=1,t[2]=1),t[3]=null!==e&&void 0!==e?e:1;for(var i=0,s=this._childList.length;i<s;i++)this._childList[i].opacity=e},get:function(){return this._colorize[3]}},outlined:{set:function(e){e=!!e,this._outlined=e;for(var t=0,i=this._childList.length;t<i;t++)this._childList[t].outlined=e},get:function(){return this._outlined}},castShadow:{set:function(e){e=!!e,this._castShadow=e;for(var t=0,i=this._childList.length;t<i;t++)this._childList[t].castShadow=e},get:function(){return this._castShadow}},receiveShadow:{set:function(e){e=!!e,this._receiveShadow=e;for(var t=0,i=this._childList.length;t<i;t++)this._childList[t].receiveShadow=e},get:function(){return this._receiveShadow}},aabbVisible:{set:function(e){(e||this._aabbHelper)&&(this._aabbHelper||(this._aabbHelper=new xeogl.Mesh(this,{geometry:new xeogl.AABBGeometry(this,{target:this}),material:new xeogl.PhongMaterial(this,{diffuse:[.5,1,.5],emissive:[.5,1,.5],lineWidth:2})})),this._aabbHelper.visible=e)},get:function(){return!!this._aabbHelper&&this._aabbHelper.visible}}},_destroy:function(){if(this._super(),this._parent&&this._parent.removeChild(this),this._entityType){var e=this.scene;e._entityTypeRemoved(this,this._entityType),this._visible&&e._entityVisibilityUpdated(this,!1),this._ghosted&&e._entityGhostedUpdated(this,!1),this._selected&&e._entitySelectedUpdated(this,!1),this._highlighted&&e._entityHighlightedUpdated(this,!1)}if(this._childList.length)for(var t=this._childList.splice(),i=0,s=t.length;i<s;i++)t[i].destroy();this._childList=[],this._childMap={},this._childIDs=null,this._setAABBDirty(),this.scene._aabbDirty=!0,this.scene._objectDestroyed(this)}}),xeogl.Group=xeogl.Object.extend({type:"xeogl.Group",_init:function(e){this._super(e)}}),function(){"use strict";var e,t;xeogl.Mesh=xeogl.Object.extend({type:"xeogl.Mesh",_init:function(e){this._state=new xeogl.renderer.State({visible:!0,culled:!1,pickable:null,clippable:null,colorize:null,collidable:null,castShadow:null,receiveShadow:null,outlined:null,ghosted:!1,highlighted:!1,selected:!1,edges:!1,layer:null,billboard:this._checkBillboard(e.billboard),stationary:!!e.stationary,hash:""}),this._drawRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._emphasisVerticesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._worldPositions=null,this._worldPositionsDirty=!0,this._geometry=e.geometry?this._checkComponent("xeogl.Geometry",e.geometry):this.scene.geometry,this._vertexBufs=this._geometry._getVertexBufs(),this._material=e.material?this._checkComponent("xeogl.Material",e.material):this.scene.material,this._ghostMaterial=e.ghostMaterial?this._checkComponent("xeogl.EmphasisMaterial",e.ghostMaterial):this.scene.ghostMaterial,this._outlineMaterial=e.outlineMaterial?this._checkComponent("xeogl.EmphasisMaterial",e.outlineMaterial):this.scene.outlineMaterial,this._highlightMaterial=e.highlightMaterial?this._checkComponent("xeogl.EmphasisMaterial",e.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=e.selectedMaterial?this._checkComponent("xeogl.EmphasisMaterial",e.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=e.edgeMaterial?this._checkComponent("xeogl.EdgeMaterial",e.edgeMaterial):this.scene.edgeMaterial,this._compile(),this._super(e),this.scene._meshCreated(this)},_checkBillboard:function(e){return"spherical"!==(e=e||"none")&&"cylindrical"!==e&&"none"!==e&&(this.error("Unsupported value for 'billboard': "+e+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),e="none"),e},_compile:function(){this._putRenderers(),this._makeHash(),this._drawRenderer=xeogl.renderer.DrawRenderer.get(this),this._emphasisFillRenderer=xeogl.renderer.EmphasisFillRenderer.get(this),this._emphasisEdgesRenderer=xeogl.renderer.EmphasisEdgesRenderer.get(this),this._emphasisVerticesRenderer=xeogl.renderer.EmphasisVerticesRenderer.get(this),this._pickMeshRenderer=xeogl.renderer.PickMeshRenderer.get(this),this._renderer.meshListDirty()},_webglContextRestored:function(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._emphasisVerticesRenderer&&this._emphasisVerticesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored()},_makeHash:function(){var e=[],t=this._state;t.stationary&&e.push("/s"),"none"===t.billboard?e.push("/n"):"spherical"===t.billboard?e.push("/s"):"cylindrical"===t.billboard&&e.push("/c"),t.receiveShadow&&e.push("/rs"),e.push(";"),this._state.hash=e.join("")},_buildMeshAABB:(e=xeogl.math,t=e.OBB3(),function(i,s){e.transformOBB3(i,this._geometry.obb,t),e.OBB3ToAABB3(t,s)}),_getSceneHash:function(){return(this.scene.gammaInput?"gi;":";")+(this.scene.gammaOutput?"go":"")},_draw:function(e){(this._drawRenderer||(this._drawRenderer=xeogl.renderer.DrawRenderer.get(this)))&&this._drawRenderer.drawMesh(e,this)},_drawGhostFill:function(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=xeogl.renderer.EmphasisFillRenderer.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,0)},_drawGhostEdges:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=xeogl.renderer.EmphasisEdgesRenderer.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,0)},_drawGhostVertices:function(e){(this._emphasisVerticesRenderer||(this._emphasisVerticesRenderer=xeogl.renderer.EmphasisVerticesRenderer.get(this)))&&this._emphasisVerticesRenderer.drawMesh(e,this,0)},_drawHighlightFill:function(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=xeogl.renderer.EmphasisFillRenderer.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,1)},_drawHighlightEdges:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=xeogl.renderer.EmphasisEdgesRenderer.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,1)},_drawHighlightVertices:function(e){(this._emphasisVerticesRenderer||(this._emphasisVerticesRenderer=xeogl.renderer.EmphasisVerticesRenderer.get(this)))&&this._emphasisVerticesRenderer.drawMesh(e,this,1)},_drawSelectedFill:function(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=xeogl.renderer.EmphasisFillRenderer.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,2)},_drawSelectedEdges:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=xeogl.renderer.EmphasisEdgesRenderer.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,2)},_drawSelectedVertices:function(e){(this._emphasisVerticesRenderer||(this._emphasisVerticesRenderer=xeogl.renderer.EmphasisVerticesRenderer.get(this)))&&this._emphasisVerticesRenderer.drawMesh(e,this,2)},_drawEdges:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=xeogl.renderer.EmphasisEdgesRenderer.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)},_drawShadow:function(e,t){(this._shadowRenderer||(this._shadowRenderer=xeogl.renderer.ShadowRenderer.get(this)))&&this._shadowRenderer.drawMesh(e,this,t)},_drawOutline:function(e){(this._shadowRenderer||(this._outlineRenderer=xeogl.renderer.OutlineRenderer.get(this)))&&this._outlineRenderer.drawMesh(e,this)},_pickMesh:function(e){(this._pickMeshRenderer||(this._pickMeshRenderer=xeogl.renderer.PickMeshRenderer.get(this)))&&this._pickMeshRenderer.drawMesh(e,this)},_pickTriangle:function(e){(this._pickTriangleRenderer||(this._pickTriangleRenderer=xeogl.renderer.PickTriangleRenderer.get(this)))&&this._pickTriangleRenderer.drawMesh(e,this)},_pickVertex:function(e){(this._pickVertexRenderer||(this._pickVertexRenderer=xeogl.renderer.PickVertexRenderer.get(this)))&&this._pickVertexRenderer.drawMesh(e,this)},_getOutlineRenderer:function(){return this._outlineRenderer=xeogl.renderer.OutlineRenderer.get(this),!this._outlineRenderer.errors||(this.errors=(this.errors||[]).concat(this._outlineRenderer.errors),this.error(this._outlineRenderer.errors.join("\n")),!1)},_putRenderers:function(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null),this._emphasisVerticesRenderer&&(this._emphasisVerticesRenderer.put(),this._emphasisVerticesRenderer=null),this._outlineRenderer&&(this._outlineRenderer.put(),this._outlineRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null),this._pickVertexRenderer&&(this._pickVertexRenderer.put(),this._pickVertexRenderer=null)},_props:{worldPositions:{get:function(){if(this._worldPositionsDirty){var e=this._geometry.positions;this._worldPositions||(this._worldPositions=new Float32Array(e.length)),xeogl.math.transformPositions3(this.worldMatrix,e,this._worldPositions),this._worldPositionsDirty=!1}return this._worldPositions},set:function(e){(e=null===e)&&(this._worldPositions=null,this._worldPositionsDirty=!0)}},geometry:{get:function(){return this._geometry}},material:{get:function(){return this._material}},ghostMaterial:{get:function(){return this._ghostMaterial}},highlightMaterial:{get:function(){return this._highlightMaterial}},selectedMaterial:{get:function(){return this._selectedMaterial}},edgeMaterial:{get:function(){return this._edgeMaterial}},outlineMaterial:{get:function(){return this._outlineMaterial}},visible:{set:function(e){e=!1!==e,this._state.visible=e,this._entityType&&this.scene._entityVisibilityUpdated(this,e),this._renderer.imageDirty()},get:function(){return this._state.visible}},"ghosted,ghost":{set:function(e){e=!!e,this._state.ghosted!==e&&(this._state.ghosted=e,this._entityType&&this.scene._entityGhostedUpdated(this,e),this._renderer.imageDirty())},get:function(){return this._state.ghosted}},"highlight,highlighted":{set:function(e){(e=!!e)!==this._state.highlighted&&(this._state.highlighted=e,this._entityType&&this.scene._entityHighlightedUpdated(this,e),this._renderer.imageDirty())},get:function(){return this._state.highlighted}},selected:{set:function(e){(e=!!e)!==this._state.selected&&(this._state.selected=e,this._entityType&&this.scene._entitySelectedUpdated(this,e),this._renderer.imageDirty())},get:function(){return this._state.selected}},edges:{set:function(e){(e=!!e)!==this._state.edges&&(this._state.edges=e,this._renderer.imageDirty())},get:function(){return this._state.edges}},culled:{set:function(e){this._state.culled=!!e,this._renderer.imageDirty()},get:function(){return this._state.culled}},pickable:{set:function(e){e=!1!==e,this._state.pickable!==e&&(this._state.pickable=e)},get:function(){return this._state.pickable}},clippable:{set:function(e){e=!1!==e,this._state.clippable!==e&&(this._state.clippable=e,this._renderer.imageDirty())},get:function(){return this._state.clippable}},collidable:{set:function(e){(e=!1!==e)!==this._state.collidable&&(this._state.collidable=e)},get:function(){return this._state.collidable}},castShadow:{set:function(e){},get:function(){return this._state.castShadow}},receiveShadow:{set:function(e){},get:function(){return this._state.receiveShadow}},"outlined,outline":{set:function(e){(e=!!e)!==this._state.outlined&&(this._state.outlined=e,this._renderer.imageDirty())},get:function(){return this._state.outlined}},colorize:{set:function(e){var t=this._state.colorize;t||((t=this._state.colorize=new Float32Array(4))[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()},get:function(){return this._state.colorize}},opacity:{set:function(e){var t=this._state.colorize;t||((t=this._state.colorize=new Float32Array(4))[0]=1,t[1]=1,t[2]=1),t[3]=null!==e&&void 0!==e?e:1,this._renderer.imageDirty()},get:function(){return this._state.colorize[3]}},layer:{set:function(e){e=e||0,(e=Math.round(e))!==this._state.layer&&(this._state.layer=e,this._renderer.needStateSort())},get:function(){return this._state.layer}},stationary:{get:function(){return this._state.stationary}},billboard:{get:function(){return this._state.billboard}}},_destroy:function(){this._super(),this._putRenderers(),this._renderer.meshListDirty(),this.scene._meshDestroyed(this)}}),xeogl.Mesh._compareState=function(e,t){return e._state.layer-t._state.layer||e._drawRenderer.id-t._drawRenderer.id||e._material._state.id-t._material._state.id||e._vertexBufs.id-t._vertexBufs.id||e._geometry._state.id-t._geometry._state.id}}(),function(){"use strict";var e,t,i,s,r,a,n=xeogl.math;xeogl.CameraFlightAnimation=xeogl.Component.extend({type:"xeogl.CameraFlightAnimation",_init:function(e){this._aabbHelper=this.create({type:"xeogl.Mesh",geometry:this.create({type:"xeogl.AABBGeometry"}),material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[.5,1,.5],lineWidth:2}),visible:!1,collidable:!1}),this._obbHelper=this.create({type:"xeogl.Mesh",geometry:this.create({type:"xeogl.OBBGeometry",material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[.5,1,.5],lineWidth:2})}),visible:!1,collidable:!1}),this._look1=n.vec3(),this._eye1=n.vec3(),this._up1=n.vec3(),this._look2=n.vec3(),this._eye2=n.vec3(),this._up2=n.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingUp=!1,this._callback=null,this._callbackScope=null,this._onTick=null,this._time1=null,this._time2=null,this.easing=!1!==e.easing,this.duration=e.duration,this.fit=e.fit,this.fitFOV=e.fitFOV,this.trail=e.trail},flyTo:(a=n.vec3(),function(e,t,i){e=e||this.scene,this._flying&&this.stop(),this._flying=!1,this._callback=t,this._callbackScope=i;var s,r,o,l,h,u=this.scene.camera;if(this._eye1[0]=u.eye[0],this._eye1[1]=u.eye[1],this._eye1[2]=u.eye[2],this._look1[0]=u.look[0],this._look1[1]=u.look[1],this._look1[2]=u.look[2],this._up1[0]=u.up[0],this._up1[1]=u.up[1],this._up1[2]=u.up[2],this._orthoScale1=u.ortho.scale,this._orthoScale2=e.orthoScale||this._orthoScale1,e.aabb)s=e.aabb;else if(6===e.length)s=e;else if(e.eye&&e.look||e.up)r=e.eye,o=e.look,l=e.up;else if(e.eye)r=e.eye;else if(e.look)o=e.look;else{var c=e;if((xeogl._isNumeric(c)||xeogl._isString(c))&&(h=c,!(c=this.scene.components[h])))return this.error("Component not found: "+xeogl._inQuotes(h)),void(t&&(i?t.call(i):t()));s=c.aabb||this.scene.aabb}var d=e.poi;if(s){if(s[3]<s[0]||s[4]<s[1]||s[5]<s[2])return;if(s[3]===s[0]&&s[4]===s[1]&&s[5]===s[2])return;!1!==e.showAABB&&(this._aabbHelper.geometry.targetAABB=s),s=s.slice();var p=n.getAABB3Center(s);this._look2=d||p;var _=n.subVec3(this._eye1,this._look1,a),f=n.normalizeVec3(_),m=d?n.getAABB3DiagPoint(s,d):n.getAABB3Diag(s),g=e.fitFOV||this._fitFOV,v=Math.abs(m/Math.tan(g*xeogl.math.DEGTORAD));this._orthoScale2=1.1*m,this._eye2[0]=this._look2[0]+f[0]*v,this._eye2[1]=this._look2[1]+f[1]*v,this._eye2[2]=this._look2[2]+f[2]*v,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyEyeLookUp=!1}else(r||o||l)&&(this._flyEyeLookUp=!!r&&!!o&&!!l,this._flyingEye=!!r&&!o,this._flyingLook=!!o&&!r,o&&(this._look2[0]=o[0],this._look2[1]=o[1],this._look2[2]=o[2]),r&&(this._eye2[0]=r[0],this._eye2[1]=r[1],this._eye2[2]=r[2]),l&&(this._up2[0]=l[0],this._up2[1]=l[1],this._up2[2]=l[2]));this.fire("started",e,!0),this._time1=Date.now(),this._time2=this._time1+(e.duration?1e3*e.duration:this._duration),this._flying=!0,xeogl.scheduleTask(this._update,this)}),jumpTo:function(e){this._jumpTo(e)},_jumpTo:(e=n.vec3(),t=n.vec3(),i=n.vec3(),s=n.vec3(),r=n.vec3(),function(a){this._flying&&this.stop();var o,l,h=this.scene.camera;if(a.aabb)o=a.aabb;else if(6===a.length)o=a;else if(a.eye||a.look||a.up)e=a.eye,t=a.look,i=a.up;else{var u=a;if((xeogl._isNumeric(u)||xeogl._isString(u))&&(l=u,!(u=this.scene.components[l])))return void this.error("Component not found: "+xeogl._inQuotes(l));o=u.aabb||this.scene.aabb}var c=a.poi;if(o){if(o[3]<=o[0]||o[4]<=o[1]||o[5]<=o[2])return;var d,p=c?n.getAABB3DiagPoint(o,c):n.getAABB3Diag(o);t=c||n.getAABB3Center(o,t),this._trail?n.subVec3(h.look,t,s):n.subVec3(h.eye,h.look,s),n.normalizeVec3(s),d=(void 0!==a.fit?a.fit:this._fit)?Math.abs(p/Math.tan((a.fitFOV||this._fitFOV)*xeogl.math.DEGTORAD)):n.lenVec3(n.subVec3(h.eye,h.look,r)),n.mulVec3Scalar(s,d),h.eye=n.addVec3(t,s,e),h.look=t}else(e||t||i)&&(e&&(h.eye=e),t&&(h.look=t),i&&(h.up=i))}),_update:function(){var e=n.vec3(),t=n.vec3(),i=n.vec3(),s=n.vec3(),r=n.vec3();return function(){if(this._flying){var a=(Date.now()-this._time1)/(this._time2-this._time1),o=a>=1;a>1&&(a=1),a=this.easing?this._ease(a,0,1,1):a;var l=this.scene.camera;if(this._flyingEye||this._flyingLook)this._flyingEye?(n.subVec3(l.eye,l.look,e),l.eye=n.lerpVec3(a,0,1,this._eye1,this._eye2,t),l.look=n.subVec3(t,e,i)):this._flyingLook&&(l.look=n.lerpVec3(a,0,1,this._look1,this._look2,i),l.up=n.lerpVec3(a,0,1,this._up1,this._up2,s));else if(this._flyEyeLookUp)l.eye=n.lerpVec3(a,0,1,this._eye1,this._eye2,t),l.look=n.lerpVec3(a,0,1,this._look1,this._look2,i),l.up=n.lerpVec3(a,0,1,this._up1,this._up2,s);else{var h;n.lerpVec3(a,0,1,this._look1,this._look2,i),this._trail?n.subVec3(i,l.look,e):n.subVec3(l.eye,l.look,e),n.normalizeVec3(e),n.lerpVec3(a,0,1,this._eye1,this._eye2,t),n.subVec3(t,i,r),h=n.lenVec3(r),n.mulVec3Scalar(e,h),l.eye=n.addVec3(i,e,t),l.look=i}this.scene.camera.ortho.scale=this._orthoScale1+a*(this._orthoScale2-this._orthoScale1),o?this.stop():xeogl.scheduleTask(this._update,this)}}}(),_ease:function(e,t,i,s){return-i*(e/=s)*(e-2)+t},stop:function(){if(this._flying){this._aabbHelper.visible=!1,this._flying=!1,this._time1=null,this._time2=null;var e=this._callback;e&&(this._callback=null,this._callbackScope?e.call(this._callbackScope):e()),this.fire("stopped",!0,!0)}},cancel:function(){this._flying&&(this._aabbHelper.visible=!1,this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))},_props:{duration:{set:function(e){this._duration=e?1e3*e:500,this.stop()},get:function(){return this._duration/1e3}},fit:{set:function(e){this._fit=!1!==e},get:function(){return this._fit}},fitFOV:{set:function(e){this._fitFOV=e||45},get:function(){return this._fitFOV}},trail:{set:function(e){this._trail=!!e},get:function(){return this._trail}}},_destroy:function(){this.stop()}})}(),function(){"use strict";xeogl.Canvas=xeogl.Component.extend({type:"xeogl.Canvas",serializable:!1,_WEBGL_CONTEXT_NAMES:["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],_init:function(e){if(this.canvas=null,this.gl=null,this.webgl2=!1,this.transparent=!!e.transparent,this.contextAttr=e.contextAttr||{},this.contextAttr.alpha=this.transparent,void 0!==this.contextAttr.preserveDrawingBuffer&&null!==this.contextAttr.preserveDrawingBuffer||(this.contextAttr.preserveDrawingBuffer=!0),this.contextAttr.stencil=!1,this.contextAttr.antialias=!0,this.contextAttr.premultipliedAlpha=!1!==this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=!1!==this.contextAttr.antialias,e.canvas?xeogl._isString(e.canvas)?(this.canvas=document.getElementById(e.canvas),this.canvas||(this.error("Canvas element not found: "+xeogl._inQuotes(e.canvas)+" - creating default canvas instead."),this._createCanvas())):this.canvas=e.canvas:this._createCanvas(),this.canvas){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._createBackground(),e.simulateWebGLContextLost&&(window.WebGLDebugUtils?this.canvas=WebGLDebugUtils.makeLostContextSimulatingCanvas(this.canvas):this.error("To simulate context loss, please include WebGLDebugUtils")),this._initWebGL(e);var t=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(e){console.time("webglcontextrestored"),t.scene._webglContextLost(),t.fire("webglcontextlost"),e.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(e){t._initWebGL(),t.gl&&(t.scene._webglContextRestored(t.gl),t.fire("webglcontextrestored",t.gl),e.preventDefault()),console.timeEnd("webglcontextrestored")},!1);var i=null,s=null,r=null,a=null,n=null,o=null,l=null;this._tick=this.scene.on("tick",function(){var e=t.canvas,h=window.innerWidth!==i||window.innerHeight!==s,u=e.clientWidth!==r||e.clientHeight!==a,c=e.offsetLeft!==n||e.offsetTop!==o,d=e.parentElement;if(h||u||c||d!==l){if(t._spinner._adjustPosition(),u||c){var p=e.clientWidth,_=e.clientHeight;if(u){var f,m=0;for(var g in xeogl.scenes)xeogl.scenes.hasOwnProperty(g)&&(m+=(f=xeogl.scenes[g]).canvas.canvas.clientWidth*f.canvas.canvas.clientHeight);xeogl.stats.memory.pixels=m,e.width=e.clientWidth,e.height=e.clientHeight}var v=t.boundary;v[0]=e.offsetLeft,v[1]=e.offsetTop,v[2]=p,v[3]=_,t.fire("boundary",v),r=p,a=_}h&&(i=window.innerWidth,s=window.innerHeight),c&&(n=e.offsetLeft,o=e.offsetTop),l=d}}),this.canvas.oncontextmenu=function(e){e.preventDefault()},this._spinner=new xeogl.Spinner(this.scene,{canvas:this.canvas}),this.backgroundColor=e.backgroundColor,this.backgroundImage=e.backgroundImage}else this.error("Faied to create canvas")},_createCanvas:function(){var e="xeogl-canvas-"+xeogl.math.createUUID(),t=document.getElementsByTagName("body")[0],i=document.createElement("div"),s=i.style;s.height="100%",s.width="100%",s.padding="0",s.margin="0",s.background="rgba(0,0,0,0);",s.float="left",s.left="0",s.top="0",s.position="absolute",s.opacity="1.0",s["z-index"]="-10000",i.innerHTML+='<canvas id="'+e+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',t.appendChild(i),this.canvas=document.getElementById(e)},_createBackground:function(){var e=document.createElement("div"),t=e.style;t.padding="0",t.margin="0",t.background=null,t.backgroundImage=null,t.float="left",t.left="0",t.top="0",t.width="100%",t.height="100%",t.position="absolute",t.opacity=1,t["z-index"]="-20000",this.canvas.parentElement.appendChild(e),this._backgroundElement=e},_getElementXY:function(e){for(var t=0,i=0;e;)t+=e.offsetLeft-e.scrollLeft,i+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{x:t,y:i}},_initWebGL:function(e){if(!this.gl)for(var t=0;!this.gl&&t<this._WEBGL_CONTEXT_NAMES.length;t++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[t],this.contextAttr)}catch(e){}if(this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0)),this.gl)if(this.webgl2)this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST);else if(xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_standard_derivatives){var i=this.gl.getExtension("OES_standard_derivatives");this.gl.hint(i.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,this.gl.FASTEST)}},getSnapshot:function(e,t){if(!this.canvas)return this.error("Can't get snapshot - no canvas."),void t(null);if(!t)return this._getSnapshot(e);var i=this;requestAnimationFrame(function(){i.scene.render(!0),t(i._getSnapshot(e))})},_getSnapshot:function(e){var t,i=(e=e||{}).width||this.canvas.width,s=e.height||this.canvas.height,r=e.format||"jpeg";switch(r){case"jpeg":t=Canvas2Image.saveAsJPEG(this.canvas,!1,i,s);break;case"png":t=Canvas2Image.saveAsPNG(this.canvas,!0,i,s);break;case"bmp":t=Canvas2Image.saveAsBMP(this.canvas,!0,i,s);break;default:this.error("Unsupported snapshot format: '"+r+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),t=Canvas2Image.saveAsJPEG(this.canvas,!0,i,s)}return t.src},readPixels:function(e,t,i,s){return this.scene._renderer.readPixels(e,t,i,s)},loseWebGLContext:function(){this.canvas.loseContext&&this.canvas.loseContext()},_props:{backgroundColor:{set:function(e){if(e){if((this._backgroundColor=this._backgroundColor||new xeogl.math.vec4).set(e||[0,0,0,1]),!this._backgroundImageSrc){var t="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=t}}else this._backgroundColor=null},get:function(){return this._backgroundColor}},backgroundImage:{set:function(e){if(e)if(xeogl._isString(e)){if(e!==this._backgroundImageSrc&&(this._backgroundElement.style.backgroundImage="url('"+e+"')",this._backgroundImageSrc=e,!this._backgroundImageSrc)){var t="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=t}}else this.error("Value for 'backgroundImage' should be a string")},get:function(){return this._backgroundImageSrc}},spinner:{get:function(){return this._spinner}}},_destroy:function(){this.scene.off(this._tick),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.canvas=null}})}(),function(){"use strict";var e=!1;xeogl.Spinner=xeogl.Component.extend({type:"xeogl.Spinner",serializable:!1,_init:function(e){this._canvas=e.canvas,this._injectSpinnerCSS();var t=document.createElement("div"),i=t.style;i["z-index"]="9000",i.position="absolute",t.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(t),this._element=t,this._adjustPosition(),this.processes=0,this.textures=e.textures},_props:{textures:{set:function(e){e=!1!==e,this._textures=e},get:function(){return this._textures}},processes:{set:function(e){if(e=e||0,this._processes!==e&&!(e<0)){var t=this._processes;this._processes=e,this._element.style.visibility=this._processes>0?"visible":"hidden",this.fire("processes",this._processes),0===this._processes&&this._processes!==t&&this.fire("zeroProcesses",this._processes)}},get:function(){return this._processes}}},_adjustPosition:function(){if(this._canvas&&this._element){var e=this._canvas,t=this._element,i=t.style;i.left=e.offsetLeft+.5*e.clientWidth-.5*t.clientWidth+"px",i.top=e.offsetTop+.5*e.clientHeight-.5*t.clientHeight+"px"}},_injectSpinnerCSS:function(){if(!e){var t=document.createElement("style");t.innerHTML=this._spinnerCSS,document.body.appendChild(t),e=!0}},_spinnerCSS:".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }"})}(),function(){"use strict";xeogl.Clip=xeogl.Component.extend({type:"xeogl.Clip",_init:function(e){this._state=new xeogl.renderer.State({active:!0,pos:new Float32Array(3),dir:new Float32Array(3)}),this.active=e.active,this.pos=e.pos,this.dir=e.dir,this.scene._clipCreated(this)},_props:{active:{set:function(e){this._state.active=!1!==e,this._renderer.imageDirty(),this.fire("active",this._state.active)},get:function(){return this._state.active}},pos:{set:function(e){this._state.pos.set(e||[0,0,0]),this._renderer.imageDirty(),this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},dir:{set:function(e){this._state.dir.set(e||[0,0,-1]),this._renderer.imageDirty(),this.fire("dir",this._state.dir)},get:function(){return this._state.dir}}},_destroy:function(){this.scene._clipDestroyed(this)}})}(),function(){"use strict";xeogl.CameraControl=xeogl.Component.extend({type:"xeogl.CameraControl",_init:function(e){var t=this;this._boundaryHelper=new xeogl.Mesh(this,{geometry:new xeogl.AABBGeometry(this),material:new xeogl.PhongMaterial(this,{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,.6],lineWidth:4}),visible:!1,collidable:!1}),this._pivoter=new function(){var e,i,s,r,a,n=xeogl.math,o=t.scene,l=o.camera,h=o.canvas,u=new Float32Array(3),c=0,d=0,p=0,_=!1,f=document.createElement("div");f.innerText=" ",f.style.color="#ffffff",f.style.position="absolute",f.style.width="25px",f.style.height="25px",f.style.left="0px",f.style.top="0px",f.style["border-radius"]="15px",f.style.border="2px solid #ffffff",f.style.background="black",f.style.visibility="hidden",f.style["box-shadow"]="5px 5px 15px 1px #000000",f.style["z-index"]=0,f.style["pointer-events"]="none",document.body.appendChild(f),i=n.vec4(),s=n.vec4(),r=n.vec2(),a=!0,l.on("viewMatrix",function(){a=!0}),l.on("projMatrix",function(){a=!0}),o.on("tick",function(){if(_&&a){n.transformPoint3(l.viewMatrix,u,i),i[3]=1,n.transformPoint4(l.projMatrix,i,s);var e=h.boundary;r[0]=Math.floor((1+s[0]/s[3])*e[2]/2),r[1]=Math.floor((1-s[1]/s[3])*e[3]/2);var t=h.canvas.getBoundingClientRect();f.style.left=Math.floor(t.left+r[0])-12+"px",f.style.top=Math.floor(t.top+r[1])-12+"px",f.style.visibility="visible",a=!1}}),this.startPivot=function(t){t&&u.set(t);var i=n.lookAtMat4v(l.eye,l.look,l.worldUp);(e=n.transformPoint3(i,u))[2]+=n.distVec3(l.eye,u),i=n.inverseMat4(i);var s=n.transformVec3(i,e),r=n.vec3();if(n.subVec3(l.eye,u,r),n.addVec3(r,s),1===l.worldUp[2]){var a=r[1];r[1]=r[2],r[2]=a}p=n.lenVec3(r),d=Math.acos(r[1]/p),c=Math.atan2(r[0],r[2]),_=!0},this.getPivoting=function(){return _},this.getPivotPos=function(){return u},this.continuePivot=function(t,i){if(_&&(0!==t||0!==i)){1===l.worldUp[2]&&(s=-s);var s=-t;c+=.01*-s,d+=.01*-i,d=n.clamp(d,.001,Math.PI-.001);var r=[p*Math.sin(d)*Math.sin(c),p*Math.cos(d),p*Math.sin(d)*Math.cos(c)];if(1===l.worldUp[2]){var a=r[1];r[1]=r[2],r[2]=a}var o=n.lenVec3(n.subVec3(l.look,l.eye,n.vec3()));n.addVec3(r,u);var h=n.lookAtMat4v(r,u,l.worldUp);h=n.inverseMat4(h);var m=n.transformVec3(h,e);h[12]-=m[0],h[13]-=m[1],h[14]-=m[2];var g=[h[8],h[9],h[10]];l.eye=[h[12],h[13],h[14]],n.subVec3(l.eye,n.mulVec3Scalar(g,o),l.look),l.up=[h[4],h[5],h[6]],f.style.visibility="visible"}},this.endPivot=function(){f.style.visibility="hidden",_=!1}},this._cameraFlight=new xeogl.CameraFlightAnimation(this,{duration:.5}),this.firstPerson=e.firstPerson,this.walking=e.walking,this.keyboardLayout=e.keyboardLayout,this.doublePickFlyTo=e.doublePickFlyTo,this.active=e.active,this.pivoting=e.pivoting,this.panToPointer=e.panToPointer,this.panToPivot=e.panToPivot,this.inertia=e.inertia,this._initEvents()},_props:{active:{set:function(e){this._active=!1!==e},get:function(){return this._active}},pivoting:{set:function(e){this._pivoting=!!e},get:function(){return this._pivoting}},panToPointer:{set:function(e){this._panToPointer=!!e,this._panToPointer&&(this._panToPivot=!1)},get:function(){return this._panToPointer}},panToPivot:{set:function(e){this._panToPivot=!!e,this._panToPivot&&(this._panToPointer=!1)},get:function(){return this._panToPivot}},firstPerson:{set:function(e){this._firstPerson=!!e},get:function(){return this._firstPerson}},walking:{set:function(e){this._walking=!!e},get:function(){return this._walking}},doublePickFlyTo:{set:function(e){this._doublePickFlyTo=!1!==e},get:function(){return this._doublePickFlyTo}},inertia:{set:function(e){this._inertia=void 0===e?.5:e},get:function(){return this._inertia}},keyboardLayout:{set:function(e){this._keyboardLayout=e||"qwerty"},get:function(){return this._keyboardLayout}}},_destroy:function(){this.active=!1},_initEvents:function(){var e=this,t=this.scene,i=t.input,s=t.camera,r=xeogl.math,a=this.scene.canvas.canvas,n=!1;a.oncontextmenu=function(e){e.preventDefault()};var o,l,h,u,c,d,p,_,f,m,g,v,x,M,y,b,w,A,E=function(e,t){if(e){for(var i=e.target,s=0,r=0;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t[0]=e.x,t[1]=e.y;return t},C=[0,0],P=!1,S=!1,D=!1;function T(){if(P||S){if(!1,D=!1,l=S||e.hasSubs("hoverSurface")?t.pick({pickSurface:!0,canvasPos:C}):t.pick({canvasPos:C})){!0;var i=l.mesh.id;o!==i&&(void 0!==o&&e.fire("hoverOut",{mesh:t.meshes[o]}),e.fire("hoverEnter",l),o=i),e.fire("hover",l),l.worldPos&&(D=!0,e.fire("hoverSurface",l))}else void 0!==o&&(e.fire("hoverOut",{mesh:t.meshes[o]}),o=void 0),e.fire("hoverOff",{canvasPos:C});P=!1,S=!1}}t.on("tick",T),function(){var o,h,u,c,d,p,_,f,m,g,v,x,M,y=0,b=0,w=0,A=0,C=0,P=0,F=r.vec2(),B=!1,L=!1,R={},k=(o=new Float32Array(3),function(){return r.lenVec3(r.subVec3(s.look,s.eye,o))}),I=function(){var e=!0;s.on("projMatrix",function(){e=!0});var t=r.mat4();return function(){return e&&r.inverseMat4(s.projMatrix,t),t}}(),V=function(){var e=!0;s.on("projMatrix",function(){e=!0});var t=r.mat4();return function(){return e&&r.transposeMat4(s.projMatrix,t),t}}(),N=function(){var e=!0;s.on("viewMatrix",function(){e=!0});var t=r.mat4();return function(){return e&&r.inverseMat4(s.viewMatrix,t),t}}(),U=(h=!0,u=1,t.on("boundary",function(){h=!0}),function(){return h&&(u=r.getAABB3Diag(t.aabb)),u}),O=(c=r.vec4(),d=r.vec4(),p=r.vec4(),_=r.vec3(),function(e,i){var a=I(),n=N(),o=V(),l=o.subarray(8,12),h=o.subarray(12),u=[0,0,-U(),1];!function(e,i,s,a,n,o){var l=t.canvas.canvas,h=l.offsetWidth/2,u=l.offsetHeight/2;c[0]=(s[0]-h)/h,c[1]=(s[1]-u)/u,c[2]=a,c[3]=1,r.mulMat4v4(e,c,n),r.mulVec3Scalar(n,1/n[3]),n[3]=1,n[1]*=-1,r.mulMat4v4(i,n,o)}(a,n,e,r.dotVec4(u,l)/r.dotVec4(u,h),d,p),r.subVec3(p,s.eye,_),r.normalizeVec3(_);var f=_[0]*i,m=_[1]*i,g=_[2]*i,v=s.eye,x=s.look;s.eye=[v[0]+f,v[1]+m,v[2]+g],s.look=[x[0]+f,x[1]+m,x[2]+g]}),G=function(){var e=r.vec3();return function(t,i){r.subVec3(t,s.eye,e),r.normalizeVec3(e);var a=e[0]*i,n=e[1]*i,o=e[2]*i,l=s.eye,h=s.look;s.eye=[l[0]+a,l[1]+n,l[2]+o],s.look=[h[0]+a,h[1]+n,h[2]+o]}}();function z(){var e=t.aabb,i=e[3]-e[0],s=e[4]-e[1],r=e[5]-e[2],a=i>s?i:s;return(a=r>a?r:a)/30}t.on("tick",function(){var t=e._inertia;if(Math.abs(y)<.001&&(y=0),Math.abs(b)<.001&&(b=0),0===b&&0===y||(e._pivoter.getPivoting()?e._pivoter.continuePivot(b,y):(0!==y&&(e._firstPerson?s.pitch(-y):s.orbitPitch(y)),0!==b&&(e._firstPerson?s.yaw(b):s.orbitYaw(b))),y*=t,b*=t),Math.abs(w)<.001&&(w=0),Math.abs(A)<.001&&(A=0),Math.abs(C)<.001&&(C=0),0!==w||0!==A||0!==C){var i=k()/80;if(e._walking){var r=s.eye[1];s.pan([w*i,A*i,C*i]),(a=s.eye)[1]=r,s.eye=a}else s.pan([w*i,A*i,C*i])}if(w*=t,A*=t,C*=t,Math.abs(P)<.001&&(P=0),0!==P){var a;if(e._firstPerson){if(e._walking&&(r=s.eye[1]),B?O(F,2*-P):s.pan([0,0,P]),e._walking)(a=s.eye)[1]=r,s.eye=a}else e._panToPointer?(T(),D?G(l.worldPos,-P):s.zoom(P)):e._panToPivot?G(e._pivoter.getPivotPos(),-P):s.zoom(P),s.ortho.scale=s.ortho.scale+P;P*=t}}),document.addEventListener("keyDown",function(t){e._active&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.ctrlKey||17===t.keyCode||t.metaKey,t.altKey||18===t.keyCode,L=16===t.keyCode,R[t.keyCode]=!0)},!0),document.addEventListener("keyup",function(t){e._active&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&((t.ctrlKey||17===t.keyCode)&&!1,(t.altKey||18===t.keyCode)&&!1,16===t.keyCode&&(L=!1),R[t.keyCode]=!1)}),v=0,x=0,M=!1,a.addEventListener("mousedown",function(t){if(e._active)switch(n=!0,t.which){case 1:M=!0,v=0,x=0,E(t,F),f=F[0],m=F[1];break;case 2:break;case 3:g=!0,M=!0,v=0,x=0,E(t,F),f=F[0],m=F[1]}}),a.addEventListener("mouseup",function(t){if(e._active){switch(t.which){case 1:case 2:break;case 3:g=!1}M=!1,v=0,x=0}}),document.addEventListener("mouseup",function(t){if(e._active){switch(t.which){case 1:case 2:break;case 3:g=!1}M=!1,v=0,x=0}}),a.addEventListener("mouseenter",function(){e._active&&(n=!0,v=0,x=0)}),a.addEventListener("mouseleave",function(){e._active&&(n=!1,v=0,x=0)}),a.addEventListener("mousemove",function(t){if(e._active&&n&&(E(t,F),B=!0,M)){var i=F[0],s=F[1];v+=.4*(i-f),x+=.4*(s-m),f=i,m=s}}),t.on("tick",function(){e._active&&(0===Math.abs(v)&&0===Math.abs(x)||(L||g?(w=.4*v,A=.4*x):(b=.4*-v,y=.4*x),v=0,x=0))}),a.addEventListener("wheel",function(t){if(e._active){e._panToPointer&&(S=!0);var i=Math.max(-1,Math.min(1,40*-t.deltaY));if(0!==i){var s=i/Math.abs(i);P=-s*z()*.8,t.preventDefault()}}}),t.on("tick",function(t){if(e._active&&n){var s=t.deltaTime;if(!e.ctrlDown&&!e.altDown){var r=i.keyDown[i.KEY_ADD],a=i.keyDown[i.KEY_SUBTRACT];(r||a)&&(a?P=s*z()*.02:r&&(P=-s*z()*.02))}}}),t.on("tick",function(t){if(e._active&&n){var s,r,a,o,l,h,u=t.deltaTime;"azerty"==e._keyboardLayout?(s=i.keyDown[i.KEY_Z],r=i.keyDown[i.KEY_S],a=i.keyDown[i.KEY_Q],o=i.keyDown[i.KEY_D],l=i.keyDown[i.KEY_W],h=i.keyDown[i.KEY_X]):(s=i.keyDown[i.KEY_W],r=i.keyDown[i.KEY_S],a=i.keyDown[i.KEY_A],o=i.keyDown[i.KEY_D],l=i.keyDown[i.KEY_Z],h=i.keyDown[i.KEY_X]),(s||r||a||o||l||h)&&(h?A+=.02*u:l&&(A-=.02*-u),o?w+=.02*-u:a&&(w=.02*u),r?C=.02*u:s&&(C=.02*-u))}}),function(){var t,i=new Float32Array(2),s=[],n=0,o=new Float32Array(2),l=new Float32Array(2),h=50,u=0,c=u,d=Date.now();function p(e){var t=Date.now();return c===u?(c=e,!0):c===e?t-d>h:(c=e,d=t,!1)}a.addEventListener("touchstart",function(r){if(e._active){var a=r.touches,o=r.changedTouches;for(t=Date.now(),1===a.length&&1===o.length?(t,i[0]=a[0].pageX,i[1]=a[0].pageY):-1;s.length<a.length;)s.push(new Float32Array(2));for(var l=0,h=a.length;l<h;++l)s[l][0]=a[l].pageX,s[l][1]=a[l].pageY;c=u,n=a.length,r.stopPropagation()}},{passive:!0}),a.addEventListener("touchmove",function(t){if(e._active){var i=t.touches;if(1===n){var a=i[0];if(p(1)){var h=a.pageX-s[0][0],u=a.pageY-s[0][1];y=.3*u,b=-(.3*h)}}else if(2===n){a=i[0];var c=i[1];r.subVec2([a.pageX,a.pageY],s[0],o),r.subVec2([c.pageX,c.pageY],s[1],l);var d=r.dotVec2(o,l)>0;if(d&&p(2)&&(r.subVec2([a.pageX,a.pageY],s[0],o),w=.2*o[0],A=.2*o[1]),!d&&p(4)){var _=r.distVec2([a.pageX,a.pageY],[c.pageX,c.pageY]),f=r.distVec2(s[0],s[1]);P=(f-_)*z()*.05}}for(var m=0;m<n;++m)s[m][0]=i[m].pageX,s[m][1]=i[m].pageY;t.stopPropagation()}},{passive:!0})}(),t.on("tick",function(t){if(e._active&&n){var s=t.deltaTime,r=i.keyDown[i.KEY_LEFT_ARROW],a=i.keyDown[i.KEY_RIGHT_ARROW],o=i.keyDown[i.KEY_UP_ARROW],l=i.keyDown[i.KEY_DOWN_ARROW];(r||a||o||l)&&(a?b+=.02*-s:r&&(b+=.02*s),l?y+=.02*s:o&&(y+=.02*-s))}}),t.on("tick",function(t){if(e._active&&n){var s,r,a=t.deltaTime;"azerty"==e._keyboardLayout?(s=i.keyDown[i.KEY_A],r=i.keyDown[i.KEY_E]):(s=i.keyDown[i.KEY_Q],r=i.keyDown[i.KEY_E]),(r||s)&&(s?b+=.02*a:r&&(b+=.02*-a))}})}(),a.addEventListener("mousemove",function(t){e._active&&(E(t,C),(e.hasSubs("hover")||e.hasSubs("hoverOut")||e.hasSubs("hoverOff")||e.hasSubs("hoverSurface"))&&(P=!0))}),a.addEventListener("mousedown",function(t){e._active&&(h=t.clientX,u=t.clientY,c=C[0],d=C[1],S=e._pivoting,T(),e._pivoting&&(l?e._pivoter.startPivot(l.worldPos):e._pivoter.startPivot()))}),a.addEventListener("mouseup",(_=0,function(t){if(e._active&&(e._pivoter.endPivot(),!(Math.abs(t.clientX-h)>3||Math.abs(t.clientY-u)>3))){if(!(e._doublePickFlyTo||e.hasSubs("doublePicked")||e.hasSubs("doublePickedSurface")||e.hasSubs("doublePickedNothing")))return S=!!e.hasSubs("pickedSurface"),T(),void(l?(e.fire("picked",l),D&&e.fire("pickedSurface",l)):e.fire("pickedNothing"));1==++_?p=setTimeout(function(){P=e._doublePickFlyTo,S=P||!!e.hasSubs("pickedSurface"),C[0]=c,C[1]=d,T(),l?(e.fire("picked",l),D&&e.fire("pickedSurface",l)):e.fire("pickedNothing"),_=0},250):(clearTimeout(p),P=e._doublePickFlyTo,S=P&&!!e.hasSubs("doublePickedSurface"),T(),l?(e.fire("doublePicked",l),D&&e.fire("doublePickedSurface",l),e._doublePickFlyTo&&e._flyTo(l)):(e.fire("doublePickedNothing"),e._doublePickFlyTo&&e._flyTo()),_=0)}}),!1),m=[],g=new Float32Array(2),v=-1,x=-1,a.addEventListener("touchstart",function(t){if(e._active){var i=t.touches,s=t.changedTouches;for(f=Date.now(),1===i.length&&1===s.length?(v=f,g[0]=i[0].pageX,g[1]=i[0].pageY):v=-1;m.length<i.length;)m.push(new Float32Array(2));for(var r=0,a=i.length;r<a;++r)m[r][0]=i[r].pageX,m[r][1]=i[r].pageY;m.length=i.length,t.stopPropagation()}},{passive:!0}),a.addEventListener("touchend",function(t){if(e._active){var i=Date.now(),s=t.touches,r=t.changedTouches;0===s.length&&1===r.length&&v>-1&&i-v<150&&(x>-1&&v-x<325?(C[0]=Math.round(r[0].clientX),C[1]=Math.round(r[0].clientY),P=!0,S=!!e.hasSubs("pickedSurface"),T(),l?(e.fire("doublePicked",l),D&&e.fire("doublePickedSurface",l),e._doublePickFlyTo&&e._flyTo(l)):(e.fire("doublePickedNothing"),e._doublePickFlyTo&&e._flyTo()),x=-1):xeogl.math.distVec2(m[0],g)<4&&(C[0]=Math.round(r[0].clientX),C[1]=Math.round(r[0].clientY),P=!0,S=!!e.hasSubs("pickedSurface"),T(),l?(e.fire("picked",l),D&&e.fire("pickedSurface",l)):e.fire("pickedNothing"),x=i),v=-1),m.length=s.length;for(var a=0,n=s.length;a<n;++a)m[a][0]=s[a].pageX,m[a][1]=s[a].pageY;t.stopPropagation()}},{passive:!0}),M=new r.vec3,y=new r.vec3,b=new r.vec3,w=new r.vec3,A={eye:new Float32Array(3),look:new Float32Array(3),up:new Float32Array(3)},document.addEventListener("keydown",function(i){if(e._active&&n){var a=i.keyCode;if(49===a||50===a||51===a||52===a||53===a||54===a){var o=t.aabb,l=r.getAABB3Diag(o);M[0]=o[0]+o[3]/2,M[1]=o[1]+o[4]/2,M[2]=o[2]+o[5]/2;var h=Math.abs(l/Math.tan(e._cameraFlight.fitFOV/2));switch(a){case 49:A.eye.set(r.mulVec3Scalar(s.worldRight,h,y)),A.look.set(M),A.up.set(s.worldUp);break;case 50:A.eye.set(r.mulVec3Scalar(s.worldForward,h,y)),A.look.set(M),A.up.set(s.worldUp);break;case 51:A.eye.set(r.mulVec3Scalar(s.worldRight,-h,y)),A.look.set(M),A.up.set(s.worldUp);break;case 52:A.eye.set(r.mulVec3Scalar(s.worldForward,-h,y)),A.look.set(M),A.up.set(s.worldUp);break;case 53:A.eye.set(r.mulVec3Scalar(s.worldUp,h,y)),A.look.set(M),A.up.set(r.normalizeVec3(r.mulVec3Scalar(s.worldForward,1,b),w));break;case 54:A.eye.set(r.mulVec3Scalar(s.worldUp,-h,y)),A.look.set(M),A.up.set(r.normalizeVec3(r.mulVec3Scalar(s.worldForward,-1,b)));break;default:return}e._cameraFlight.duration>0?e._cameraFlight.flyTo(A):e._cameraFlight.jumpTo(A)}}})},_flyTo:function(e){var t;e&&e.worldPos&&(t=e.worldPos);var i=e?e.mesh.aabb:this.scene.aabb;if(this._boundaryHelper.geometry.targetAABB=i,t){var s=this.scene.camera;xeogl.math.subVec3(s.eye,s.look,[]);this._cameraFlight.flyTo({aabb:i},this._hideBoundary,this)}else this._cameraFlight.flyTo({aabb:i},this._hideBoundary,this)},_hideBoundary:function(){}})}(),function(){const e=i?Number.MAX_SAFE_INTEGER/6:256e3;var t=xeogl.stats.memory,i=xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint,s=(i?Uint32Array:Uint16Array,new xeogl.renderer.State({}));xeogl.SceneVertexBufs=function(r,a,n,o,l,h){var u=r.canvas.gl,c=!1,d={},p={},_=[],f={},m=!1,g=!1,v=[],x=[],M=[],y=[],b=null;function w(){var t,s;f={};var r=0;b=null;for(t in d)d.hasOwnProperty(t)&&(s=d[t],a&&s.positions.length,n&&s.normals.length,l&&s.uv.length,o&&s.uv.length);for(t in d)if(d.hasOwnProperty(t)){var c;if(s=d[t],(!b||v.length+s.positions.length>e)&&(b&&A(b),b=new xeogl.renderer.State({positionsBuf:null,normalsBuf:null,uvBuf:null,colorsBuf:null,quantized:h}),r=0),f[t]=b,a)for(var _=0,w=s.positions.length;_<w;_++)v.push(s.positions[_]);if(n)for(_=0,w=s.normals.length;_<w;_++)x.push(s.normals[_]);if(o)for(_=0,w=s.colors.length;_<w;_++)M.push(s.colors[_]);if(l)for(_=0,w=s.uv.length;_<w;_++)y.push(s.uv[_]);if(p[t]=r,r)for(_=0,w=(c=new(i?Uint32Array:Uint16Array)(s.indices)).length;_<w;_++)c[_]+=r,c[_]>e/3&&console.error("out of range: "+c[_]);else c=s.indices;s.indicesBufCombined?s.indicesBufCombined.setData(c):s.indicesBufCombined=new xeogl.renderer.ArrayBuffer(u,u.ELEMENT_ARRAY_BUFFER,c,c.length,1,u.STATIC_DRAW),r+=s.positions.length/3}b&&A(b),m=!1,g=!1}function A(e){var i,s=r.canvas.gl;a&&(i=h?new Uint16Array(v):new Float32Array(v),e.positionsBuf=new xeogl.renderer.ArrayBuffer(s,s.ARRAY_BUFFER,i,i.length,3,s.STATIC_DRAW),t.positions+=e.positionsBuf.numItems,v=[]),n&&(i=h?new Int8Array(x):new Float32Array(x),e.normalsBuf=new xeogl.renderer.ArrayBuffer(s,s.ARRAY_BUFFER,i,i.length,3,s.STATIC_DRAW),t.normals+=e.normalsBuf.numItems,x=[]),o&&(i=new Float32Array(M),e.colorsBuf=new xeogl.renderer.ArrayBuffer(s,s.ARRAY_BUFFER,i,i.length,4,s.STATIC_DRAW),t.colors+=e.colorsBuf.numItems,M=[]),l&&(i=h?new Uint16Array(y):new Float32Array(y),e.uvBuf=new xeogl.renderer.ArrayBuffer(s,s.ARRAY_BUFFER,i,i.length,2,s.STATIC_DRAW),t.uvs+=e.uvBuf.numItems,y=[])}this.addGeometry=function(e){e.positions&&e.indices?(d[e.id]=e,p[e.id]=0,_.push(e),g=!0):r.warn("Ignoring geometry with no positions or indices: "+e.id)},this.getIndicesOffset=function(e){return(m||g)&&w(),p[e.id]},this.getVertexBufs=function(e){return d[e.id]?((m||g)&&w(),f[e.id]):s},this.setPositions=function(e){var t=f[e.id];if(t&&e.positions){var i=t.positionsBuf;i&&i.setData(e.positions,3*p[e.id])}},this.setNormals=function(e){var t=f[e.id];if(t&&e.normals){var i=t.normalsBuf;i&&i.setData(e.normals,3*p[e.id])}},this.setUVs=function(e){var t=f[e.id];if(t&&e.uv){var i=t.uvBuf;i&&i.setData(e.uv,2*p[e.id])}},this.setColors=function(e){var t=f[e.id];if(t&&e.color){var i=t.colorsBuf;i&&i.setData(e.colors,4*p[e.id])}},this.removeGeometry=function(e){var t=e.id;d[t]&&(delete d[t],delete p[t],e.indicesBufCombined&&e.indicesBufCombined.destroy(),m=!0)},this.webglContextLost=function(){c=!0},this.webglContextRestored=function(){if(c){for(var e in d)d.hasOwnProperty(e)&&(d[e].indicesBufCombined=null);w(),c=!1}}},xeogl.SceneVertexBufs.get=function(e,t){var i=!!t.positions,s=!!t.quantized,r=!!t.normals,a=!!t.colors,n=!!t.uv,o=[e.id,i?"p":"",s?"c":"",r?"n":"",a?"c":"",n?"u":""].join(";");e._sceneVertexBufs||(e._sceneVertexBufs={});var l=e._sceneVertexBufs[o];return l||(l=new xeogl.SceneVertexBufs(e,i,r,a,n,s),e._sceneVertexBufs[o]=l),l}}(),function(){"use strict";i&&Number.MAX_SAFE_INTEGER;var e,t=xeogl.stats.memory,i=xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint,s=i?Uint32Array:Uint16Array,r=new xeogl.renderer.State({});function a(e,t){var i,s,r=new Float32Array(t),a=new Float32Array(t);for(i=0;i<t;i++)r[i]=Number.MAX_VALUE,a[i]=-Number.MAX_VALUE;for(i=0;i<e.length;i+=t)for(s=0;s<t;s++)r[s]=Math.min(r[s],e[i+s]),a[s]=Math.max(a[s],e[i+s]);return{min:r,max:a}}xeogl.Geometry=xeogl.Component.extend({type:"xeogl.Geometry",_init:function(e){this._state=new xeogl.renderer.State({combined:!!e.combined,quantized:!!e.quantized,autoVertexNormals:!!e.autoVertexNormals,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,indicesBufCombined:null,hash:""}),this._edgeThreshold=e.edgeThreshold||2,this._edgesIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._boundaryDirty=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;var r=this._state,n=this.scene.canvas.gl;switch(e.primitive=e.primitive||"triangles",e.primitive){case"points":r.primitive=n.POINTS,r.primitiveName=e.primitive;break;case"lines":r.primitive=n.LINES,r.primitiveName=e.primitive;break;case"line-loop":r.primitive=n.LINE_LOOP,r.primitiveName=e.primitive;break;case"line-strip":r.primitive=n.LINE_STRIP,r.primitiveName=e.primitive;break;case"triangles":r.primitive=n.TRIANGLES,r.primitiveName=e.primitive;break;case"triangle-strip":r.primitive=n.TRIANGLE_STRIP,r.primitiveName=e.primitive;break;case"triangle-fan":r.primitive=n.TRIANGLE_FAN,r.primitiveName=e.primitive;break;default:this.error("Unsupported value for 'primitive': '"+e.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),r.primitive=n.TRIANGLES,r.primitiveName=e.primitive}if(e.positions)if(this._state.quantized){var o=a(e.positions,3),l=h(e.positions,o.min,o.max);r.positions=l.quantized,r.positionsDecodeMatrix=l.decode}else r.positions=e.positions.constructor===Float32Array?e.positions:new Float32Array(e.positions);if(e.colors&&(r.colors=e.colors.constructor===Float32Array?e.colors:new Float32Array(e.colors)),e.uv)if(this._state.quantized){o=a(e.uv,2),l=u(e.uv,o.min,o.max);r.uv=l.quantized,r.uvDecodeMatrix=l.decode}else r.uv=e.uv.constructor===Float32Array?e.uv:new Float32Array(e.uv);if(e.normals&&(this._state.quantized?r.normals=function(e){var t,i,s,r,a,n,o,l=new Int8Array(2*e.length/3);for(n=0,o=0;n<e.length;n+=3,o+=2)s=t=c(e,n,"floor","floor"),i=d(t),r=a=p(e,n,i),t=c(e,n,"ceil","floor"),i=d(t),(r=p(e,n,i))>a&&(s=t,a=r),t=c(e,n,"floor","ceil"),i=d(t),(r=p(e,n,i))>a&&(s=t,a=r),t=c(e,n,"ceil","ceil"),i=d(t),(r=p(e,n,i))>a&&(s=t,a=r),l[o]=s[0],l[o+1]=s[1];return l}(e.normals):r.normals=e.normals.constructor===Float32Array?e.normals:new Float32Array(e.normals)),e.indices){if(!i&&e.indices.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");r.indices=e.indices.constructor===Uint32Array||e.indices.constructor===Uint16Array?e.indices:new s(e.indices)}r.indices&&(r.indicesBuf=new xeogl.renderer.ArrayBuffer(n,n.ELEMENT_ARRAY_BUFFER,r.indices,r.indices.length,1,n.STATIC_DRAW),t.indices+=r.indicesBuf.numItems),this._buildHash(),t.meshes++,this._state.combined&&(this._sceneVertexBufs=xeogl.SceneVertexBufs.get(this.scene,this._state),this._sceneVertexBufs.addGeometry(this._state)),this._buildVBOs(),this.fire("created",this.created=!0)},_buildVBOs:function(){var e=this._state,i=this.scene.canvas.gl;e.indices&&(e.indicesBuf=new xeogl.renderer.ArrayBuffer(i,i.ELEMENT_ARRAY_BUFFER,e.indices,e.indices.length,1,i.STATIC_DRAW),t.indices+=e.indicesBuf.numItems),e.combined?e.indices:(e.positions&&(e.positionsBuf=new xeogl.renderer.ArrayBuffer(i,i.ARRAY_BUFFER,e.positions,e.positions.length,3,i.STATIC_DRAW),t.positions+=e.positionsBuf.numItems),e.normals&&(e.normalsBuf=new xeogl.renderer.ArrayBuffer(i,i.ARRAY_BUFFER,e.normals,e.normals.length,3,i.STATIC_DRAW),t.normals+=e.normalsBuf.numItems),e.colors&&(e.colorsBuf=new xeogl.renderer.ArrayBuffer(i,i.ARRAY_BUFFER,e.colors,e.colors.length,4,i.STATIC_DRAW),t.colors+=e.colorsBuf.numItems),e.uv&&(e.uvBuf=new xeogl.renderer.ArrayBuffer(i,i.ARRAY_BUFFER,e.uv,e.uv.length,2,i.STATIC_DRAW),t.uvs+=e.uvBuf.numItems))},_buildHash:function(){var e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positions&&t.push("p"),e.colors&&t.push("c"),(e.normals||e.autoVertexNormals)&&t.push("n"),e.uv&&t.push("u"),e.quantized&&t.push("cp"),t.push(";"),e.hash=t.join("")},_getEdgesIndices:function(){return this._edgesIndicesBuf||this._buildEdgesIndices(),this._edgesIndicesBuf},_getPickTrianglePositions:function(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf},_getPickTriangleColors:function(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf},_buildEdgesIndices:function(){var e=this._state;if(e.positions&&e.indices){var i=this.scene.canvas.gl,s=_(e.positions,e.indices,e.positionsDecodeMatrix,this._edgeThreshold,e.combined);if(e.combined)for(var r=this._sceneVertexBufs.getIndicesOffset(e),a=0,n=s.length;a<n;a++)s[a]+=r;this._edgesIndicesBuf=new xeogl.renderer.ArrayBuffer(i,i.ELEMENT_ARRAY_BUFFER,s,s.length,1,i.STATIC_DRAW),t.indices+=this._edgesIndicesBuf.numItems}},_buildPickTriangleVBOs:function(){var e=this._state;if(e.positions&&e.indices){var i=this.scene.canvas.gl,s=xeogl.math.buildPickTriangles(e.positions,e.indices,e.quantized),r=s.positions,a=s.colors;this._pickTrianglePositionsBuf=new xeogl.renderer.ArrayBuffer(i,i.ARRAY_BUFFER,r,r.length,3,i.STATIC_DRAW),this._pickTriangleColorsBuf=new xeogl.renderer.ArrayBuffer(i,i.ARRAY_BUFFER,a,a.length,4,i.STATIC_DRAW,!0),t.positions+=this._pickTrianglePositionsBuf.numItems,t.colors+=this._pickTriangleColorsBuf.numItems}},_buildPickVertexVBOs:function(){},_webglContextLost:function(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()},_webglContextRestored:function(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgesIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null},_props:{primitive:{get:function(){return this._state.primitiveName}},quantized:{get:function(){return this._state.quantized}},combined:{get:function(){return this._state.combined}},positions:{get:function(){if(this._state.positions)return this._state.quantized?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),xeogl.math.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions},set:function(e){var t=this._state,i=t.positions;if(i)if(i.length===e.length){if(this._state.quantized){var s=a(e,3),r=h(e,s.min,s.max);e=r.quantized,t.positionsDecodeMatrix=r.decode}i.set(e),t.positionsBuf&&t.positionsBuf.setData(i),this._state.combined&&this._sceneVertexBufs.setPositions(t),this._setBoundaryDirty(),this._renderer.imageDirty()}else this.error("can't update geometry positions - new positions are wrong length");else this.error("can't update geometry positions - geometry has no positions")}},normals:{get:function(){if(this._state.normals){if(!this._state.quantized)return this._state.normals;if(!this._decompressedNormals){var e=this._state.normals.length,t=e+e/2;this._decompressedNormals=new Float32Array(t),xeogl.math.octDecodeVec2s(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}},set:function(e){if(this._state.quantized)this.error("can't update geometry normals - quantized geometry is immutable");else{var t=this._state,i=t.normals;i?i.length===e.length?(i.set(e),t.normalsBuf&&t.normalsBuf.setData(i),this._state.combined&&this._sceneVertexBufs.setNormals(t),this._renderer.imageDirty()):this.error("can't update geometry normals - new normals are wrong length"):this.error("can't update geometry normals - geometry has no normals")}}},uv:{get:function(){if(this._state.uv)return this._state.quantized?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),xeogl.math.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv},set:function(e){if(this._state.quantized)this.error("can't update geometry UVs - quantized geometry is immutable");else{var t=this._state,i=t.uv;i?i.length===e.length?(i.set(e),t.uvBuf&&t.uvBuf.setData(i),this._state.combined&&this._sceneVertexBufs.setUVs(t),this._renderer.imageDirty()):this.error("can't update geometry UVs - new UVs are wrong length"):this.error("can't update geometry UVs - geometry has no UVs")}}},colors:{get:function(){return this._state.colors},set:function(e){if(this._state.quantized)this.error("can't update geometry colors - quantized geometry is immutable");else{var t=this._state,i=t.colors;i?i.length===e.length?(i.set(e),t.colorsBuf&&t.colorsBuf.setData(i),this._state.combined&&this._sceneVertexBufs.setColors(t),this._renderer.imageDirty()):this.error("can't update geometry colors - new colors are wrong length"):this.error("can't update geometry colors - geometry has no colors")}}},indices:{get:function(){return this._state.indices}},aabb:{get:function(){return this._aabbDirty&&(this._aabb||(this._aabb=xeogl.math.AABB3()),xeogl.math.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}},obb:{get:(e=xeogl.math.AABB3(),function(){return this._obbDirty&&(this._obb||(this._obb=xeogl.math.OBB3()),xeogl.math.positions3ToAABB3(this._state.positions,e,this._state.positionsDecodeMatrix),xeogl.math.AABB3ToOBB3(e,this._obb),this._obbDirty=!1),this._obb})},kdtree:{get:function(){var e=this._state;if(e.indices&&e.positions)return this._kdtree||(this._kdtree=xeogl.math.buildKDTree(e.indices,e.positions,this._state.positionsDecodeMatrix)),this._kdtree;this.error("Can't provide a KD-tree: no indices/positions")}}},_setBoundaryDirty:function(){this._boundaryDirty||(this._boundaryDirty=!0,this._aabbDirty=!0,this._obbDirty=!0,this.fire("boundary"))},_getState:function(){return this._state},_getVertexBufs:function(){return this._state&&this._state.combined?this._sceneVertexBufs.getVertexBufs(this._state):r},_destroy:function(){var e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),this._edgesIndicesBuf&&this._edgesIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),this._state.combined&&this._sceneVertexBufs.removeGeometry(e),e.destroy(),t.meshes--}});var n,o,l,h=(n=xeogl.math,o=n.mat4(),l=n.mat4(),function(e,t,i){var s,r=new Uint16Array(e.length),a=new Float32Array([65535/(i[0]-t[0]),65535/(i[1]-t[1]),65535/(i[2]-t[2])]);for(s=0;s<e.length;s+=3)r[s+0]=Math.floor((e[s+0]-t[0])*a[0]),r[s+1]=Math.floor((e[s+1]-t[1])*a[1]),r[s+2]=Math.floor((e[s+2]-t[2])*a[2]);return n.identityMat4(o),n.translationMat4v(t,o),n.identityMat4(l),n.scalingMat4v([(i[0]-t[0])/65535,(i[1]-t[1])/65535,(i[2]-t[2])/65535],l),{quantized:r,decode:n.mulMat4(o,l,n.identityMat4())}}),u=function(){var e=xeogl.math,t=e.mat3(),i=e.mat3();return function(s,r,a){var n,o=new Uint16Array(s.length),l=new Float32Array([65535/(a[0]-r[0]),65535/(a[1]-r[1])]);for(n=0;n<s.length;n+=2)o[n+0]=Math.floor((s[n+0]-r[0])*l[0]),o[n+1]=Math.floor((s[n+1]-r[1])*l[1]);return e.identityMat3(t),e.translationMat3v(r,t),e.identityMat3(i),e.scalingMat3v([(a[0]-r[0])/65535,(a[1]-r[1])/65535],i),{quantized:o,decode:e.mulMat3(t,i,e.identityMat3())}}}();function c(e,t,i,s){var r=e[t]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2])),a=e[t+1]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2]));if(e[t+2]<0){var n,o;n=(1-Math.abs(a))*(r>=0?1:-1),o=(1-Math.abs(r))*(a>=0?1:-1),r=n,a=o}return new Int8Array([Math[i](127.5*r+(r<0?-1:0)),Math[s](127.5*a+(a<0?-1:0))])}function d(e){var t=e[0],i=e[1];t/=t<0?127:128,i/=i<0?127:128;var s=1-Math.abs(t)-Math.abs(i);s<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));var r=Math.sqrt(t*t+i*i+s*s);return[t/r,i/r,s/r]}function p(e,t,i){return e[t]*i[0]+e[t+1]*i[1]+e[t+2]*i[2]}var _=function(){var e=xeogl.math,t=[],i=[],s=[],r=[];var a=[],n=0,o=new Uint16Array(3),l=new Uint16Array(3),h=new Uint16Array(3),u=e.vec3(),c=e.vec3(),d=e.vec3(),p=e.vec3(),_=e.vec3(),f=e.vec3(),m=e.vec3();return function(g,v,x,M,y){!function(e,a){var n,o,l,h,u,c,d={},p=Math.pow(10,4),_=0;for(u=0,c=e.length;u<c;u+=3)n=e[u],o=e[u+1],l=e[u+2],void 0===d[h=Math.round(n*p)+"_"+Math.round(o*p)+"_"+Math.round(l*p)]&&(d[h]=_/3,t[_++]=n,t[_++]=o,t[_++]=l),i[u/3]=d[h];for(u=0,c=a.length;u<c;u++)r[u]=i[a[u]],s[r[u]]=a[u]}(g,v),function(i,s){n=0;for(var g=0,v=i;g<v;g+=3){var x=3*r[g],M=3*r[g+1],y=3*r[g+2];s?(o[0]=t[x],o[1]=t[x+1],o[2]=t[x+2],l[0]=t[M],l[1]=t[M+1],l[2]=t[M+2],h[0]=t[y],h[1]=t[y+1],h[2]=t[y+2],e.decompressPosition(o,s,u),e.decompressPosition(l,s,c),e.decompressPosition(h,s,d)):(u[0]=t[x],u[1]=t[x+1],u[2]=t[x+2],c[0]=t[M],c[1]=t[M+1],c[2]=t[M+2],d[0]=t[y],d[1]=t[y+1],d[2]=t[y+2]),e.subVec3(d,c,p),e.subVec3(u,c,_),e.cross3Vec3(p,_,f),e.normalizeVec3(f,m);var b=a[n]||(a[n]={normal:e.vec3()});b.normal[0]=m[0],b.normal[1]=m[1],b.normal[2]=m[2],n++}}(v.length,x);for(var b,w,A,E,C,P,S,D,T,F,B=[],L=Math.cos(xeogl.math.DEGTORAD*M),R={},k=!1,I=0,V=v.length;I<V;I+=3)for(var N=I/3,U=0;U<3;U++)b=r[I+U],w=r[I+(U+1)%3],void 0===R[C=(A=Math.min(b,w))+","+(E=Math.max(b,w))]?R[C]={index1:A,index2:E,face1:N,face2:void 0}:R[C].face2=N;for(C in R)void 0!==(P=R[C]).face2&&(S=a[P.face1].normal,D=a[P.face2].normal,e.dotVec3(S,D)>L)||(T=P.index1,F=P.index2,(!k&&T>65535||F>65535)&&(k=!0),B.push(s[T]),B.push(s[F]));return k||y?new Uint32Array(B):new Uint16Array(B)}}()}(),function(){"use strict";xeogl.BoxGeometry=xeogl.Geometry.extend({type:"xeogl.BoxGeometry",_init:function(e){var t=e.xSize||1;t<0&&(this.error("negative xSize not allowed - will invert"),t*=-1);var i=e.ySize||1;i<0&&(this.error("negative ySize not allowed - will invert"),i*=-1);var s=e.zSize||1;s<0&&(this.error("negative zSize not allowed - will invert"),s*=-1);var r=e.center,a=r?r[0]:0,n=r?r[1]:0,o=r?r[2]:0,l=-t+a,h=-i+n,u=-s+o,c=t+a,d=i+n,p=s+o;this._super(xeogl._apply(e,{positions:[c,d,p,l,d,p,l,h,p,c,h,p,c,d,p,c,h,p,c,h,u,c,d,u,c,d,p,c,d,u,l,d,u,l,d,p,l,d,p,l,d,u,l,h,u,l,h,p,l,h,u,c,h,u,c,h,p,l,h,p,c,h,u,l,h,u,l,d,u,c,d,u],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],tangents:null})),this.box=!0}})}(),function(){"use strict";xeogl.TorusGeometry=xeogl.Geometry.extend({type:"xeogl.TorusGeometry",_init:function(e){var t=e.radius||1;t<0&&(this.error("negative radius not allowed - will invert"),t*=-1),t*=.5;var i=e.tube||.3;i<0&&(this.error("negative tube not allowed - will invert"),i*=-1);var s=e.radialSegments||32;s<0&&(this.error("negative radialSegments not allowed - will invert"),s*=-1),s<4&&(s=4);var r=e.tubeSegments||24;r<0&&(this.error("negative tubeSegments not allowed - will invert"),r*=-1),r<4&&(r=4);var a=e.arc||2*Math.PI;a<0&&(this.warn("negative arc not allowed - will invert"),a*=-1),a>360&&(a=360);var n,o,l,h,u,c,d,p,_,f,m,g,v=e.center,x=v?v[0]:0,M=v?v[1]:0,y=v?v[2]:0,b=[],w=[],A=[],E=[];for(p=0;p<=r;p++)for(d=0;d<=s;d++)n=d/s*a,o=.785398+p/r*Math.PI*2,x=t*Math.cos(n),M=t*Math.sin(n),l=(t+i*Math.cos(o))*Math.cos(n),h=(t+i*Math.cos(o))*Math.sin(n),u=i*Math.sin(o),b.push(l+x),b.push(h+M),b.push(u+y),A.push(1-d/s),A.push(p/r),c=xeogl.math.normalizeVec3(xeogl.math.subVec3([l,h,u],[x,M,y],[]),[]),w.push(c[0]),w.push(c[1]),w.push(c[2]);for(p=1;p<=r;p++)for(d=1;d<=s;d++)_=(s+1)*p+d-1,f=(s+1)*(p-1)+d-1,m=(s+1)*(p-1)+d,g=(s+1)*p+d,E.push(_),E.push(f),E.push(m),E.push(m),E.push(g),E.push(_);this._super(xeogl._apply(e,{positions:b,normals:w,uv:A,indices:E}))}})}(),function(){"use strict";xeogl.SphereGeometry=xeogl.Geometry.extend({type:"xeogl.SphereGeometry",_init:function(e){var t=e.lod||1,i=e.center?e.center[0]:0,s=e.center?e.center[1]:0,r=e.center?e.center[2]:0,a=e.radius||1;a<0&&(this.warn("negative radius not allowed - will invert"),a*=-1);var n=e.heightSegments||18;n<0&&(this.warn("negative heightSegments not allowed - will invert"),n*=-1),(n=Math.floor(t*n))<18&&(n=18);var o=e.widthSegments||18;o<0&&(this.warn("negative widthSegments not allowed - will invert"),o*=-1),(o=Math.floor(t*o))<18&&(o=18);var l,h,u,c,d,p,_,f,m,g,v,x,M,y,b=[],w=[],A=[],E=[];for(l=0;l<=n;l++)for(u=l*Math.PI/n,c=Math.sin(u),d=Math.cos(u),h=0;h<=o;h++)p=2*h*Math.PI/o,_=Math.sin(p),f=Math.cos(p)*c,m=d,g=_*c,v=1-h/o,x=l/n,w.push(f),w.push(m),w.push(g),A.push(v),A.push(x),b.push(i+a*f),b.push(s+a*m),b.push(r+a*g);for(l=0;l<n;l++)for(h=0;h<o;h++)y=(M=l*(o+1)+h)+o+1,E.push(M+1),E.push(y+1),E.push(y),E.push(M+1),E.push(y),E.push(M);this._super(xeogl._apply(e,{positions:b,normals:w,uv:A,indices:E}))}})}(),function(){"use strict";xeogl.OBBGeometry=xeogl.Geometry.extend({type:"xeogl.OBBGeometry",_init:function(e){this._super(xeogl._apply(e,{combined:!0,quantized:!1,primitive:e.primitive||"lines",positions:e.positions||[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1],indices:[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]})),e.target?this.target=e.target:e.targetOBB&&(this.targetOBB=e.targetOBB)},_props:{target:{set:function(e){var t=!1,i=this;this._attach({name:"target",type:"xeogl.Component",component:e,sceneDefault:!1,on:{boundary:function(){t||(t=!0,xeogl.scheduleTask(function(){i._setPositionsFromOBB(i._attached.target.obb),t=!1}))}},onAttached:function(){i._setPositionsFromOBB(i._attached.target.obb)}})},get:function(){return this._attached.target}},targetOBB:{set:function(e){e&&(this._attached.target&&(this.target=null),this._setPositionsFromOBB(e))}}},_setPositionsFromOBB:function(e){this.positions=[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10],e[12],e[13],e[14],e[16],e[17],e[18],e[20],e[21],e[22],e[24],e[25],e[26],e[28],e[29],e[30]]}})}(),function(){"use strict";xeogl.AABBGeometry=xeogl.Geometry.extend({type:"xeogl.AABBGeometry",_init:function(e){this._super(xeogl._apply(e,{combined:!0,quantized:!0,primitive:e.primitive||"lines",indices:[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],positions:e.positions||[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]})),e.target?this.target=e.target:e.targetAABB&&(this.targetAABB=e.targetAABB)},_props:{target:{set:function(e){var t=!1,i=this;this._attach({name:"target",type:"xeogl.Component",component:e,sceneDefault:!1,on:{boundary:function(){t||(t=!0,xeogl.scheduleTask(function(){i._setPositionsFromAABB(i._attached.target.aabb),t=!1}))}},onAttached:function(){i._setPositionsFromAABB(i._attached.target.aabb)}})},get:function(){return this._attached.target}},targetAABB:{set:function(e){e&&(this._attached.target&&(this.target=null),this._setPositionsFromAABB(e))}}},_setPositionsFromAABB:function(e){this.positions=[e[3],e[4],e[5],e[3],e[1],e[5],e[0],e[1],e[5],e[0],e[4],e[5],e[3],e[4],e[2],e[3],e[1],e[2],e[0],e[1],e[2],e[0],e[4],e[2]]}})}(),xeogl.PathGeometry=xeogl.Geometry.extend({type:"xeogl.PathGeometry",_init:function(e){this._super(e),this.path=e.path,this.divisions=e.divisions},_update:function(){var e=this._attached.path;if(e){var t,i,s,r=e.getPoints(this._divisions),a=[];for(t=0,i=r.length;t<i;t++)s=r[t],a.push(s[0]),a.push(s[1]),a.push(s[2]);var n=[];for(t=0,i=r.length-1;t<i;t++)n.push(t),n.push(t+1);this.primitive="lines",this.positions=a,this.indices=n,this.normals=null,this.uv=null}},_props:{path:{set:function(e){this._attach({name:"path",type:"xeogl.Curve",component:e,sceneDefault:!1,on:{curves:{callback:this._needUpdate,scope:this}}})},get:function(){return this._attached.path}},divisions:{set:function(e){e=e||6,this._divisions=e,this._needUpdate()},get:function(){return this._divisions}}}}),function(){"use strict";xeogl.CylinderGeometry=xeogl.Geometry.extend({type:"xeogl.CylinderGeometry",_init:function(e){var t=e.radiusTop||1;t<0&&(this.error("negative radiusTop not allowed - will invert"),t*=-1);var i=e.radiusBottom||1;i<0&&(this.error("negative radiusBottom not allowed - will invert"),i*=-1);var s=e.height||1;s<0&&(this.error("negative height not allowed - will invert"),s*=-1);var r=e.radialSegments||32;r<0&&(this.error("negative radialSegments not allowed - will invert"),r*=-1),r<3&&(r=3);var a=e.heightSegments||1;a<0&&(this.error("negative heightSegments not allowed - will invert"),a*=-1),a<1&&(a=1);var n,o,l,h,u,c,d,p,_,f,m,g=!!e.openEnded,v=e.center,x=v?v[0]:0,M=v?v[1]:0,y=v?v[2]:0,b=s/2,w=s/a,A=2*Math.PI/r,E=1/r,C=(t-i)/a,P=[],S=[],D=[],T=[],F=(90-180*Math.atan(s/(i-t))/Math.PI)/90;for(n=0;n<=a;n++)for(u=t-n*C,c=b-n*w,o=0;o<=r;o++)l=Math.sin(o*A),h=Math.cos(o*A),S.push(u*l),S.push(F),S.push(u*h),D.push(o*E),D.push(1*n/a),P.push(u*l+x),P.push(c+M),P.push(u*h+y);for(n=0;n<a;n++)for(o=0;o<=r;o++)p=(d=n*(r+1)+o)+r,T.push(d),T.push(p),T.push(p+1),T.push(d),T.push(p+1),T.push(d+1);if(!g&&t>0){for(_=P.length/3,S.push(0),S.push(1),S.push(0),D.push(.5),D.push(.5),P.push(0+x),P.push(b+M),P.push(0+y),o=0;o<=r;o++)l=Math.sin(o*A),h=Math.cos(o*A),f=.5*Math.sin(o*A)+.5,m=.5*Math.cos(o*A)+.5,S.push(t*l),S.push(1),S.push(t*h),D.push(f),D.push(m),P.push(t*l+x),P.push(b+M),P.push(t*h+y);for(o=0;o<r;o++)v=_,d=_+1+o,T.push(d),T.push(d+1),T.push(v)}if(!g&&i>0){for(_=P.length/3,S.push(0),S.push(-1),S.push(0),D.push(.5),D.push(.5),P.push(0+x),P.push(0-b+M),P.push(0+y),o=0;o<=r;o++)l=Math.sin(o*A),h=Math.cos(o*A),f=.5*Math.sin(o*A)+.5,m=.5*Math.cos(o*A)+.5,S.push(i*l),S.push(-1),S.push(i*h),D.push(f),D.push(m),P.push(i*l+x),P.push(0-b+M),P.push(i*h+y);for(o=0;o<r;o++)v=_,d=_+1+o,T.push(v),T.push(d+1),T.push(d)}this._super(xeogl._apply(e,{positions:P,normals:S,uv:D,indices:T}))}})}(),function(){"use strict";xeogl.PlaneGeometry=xeogl.Geometry.extend({type:"xeogl.PlaneGeometry",_init:function(e){var t=e.xSize||1;t<0&&(this.error("negative xSize not allowed - will invert"),t*=-1);var i=e.zSize||1;i<0&&(this.error("negative zSize not allowed - will invert"),i*=-1);var s=e.xSegments||1;s<0&&(this.error("negative xSegments not allowed - will invert"),s*=-1),s<1&&(s=1);var r=e.xSegments||1;r<0&&(this.error("negative zSegments not allowed - will invert"),r*=-1),r<1&&(r=1);var a,n,o,l,h,u,c,d=e.center,p=d?d[0]:0,_=d?d[1]:0,f=d?d[2]:0,m=t/2,g=i/2,v=Math.floor(s)||1,x=Math.floor(r)||1,M=v+1,y=x+1,b=t/v,w=i/x,A=new Float32Array(M*y*3),E=new Float32Array(M*y*3),C=new Float32Array(M*y*2),P=0,S=0;for(a=0;a<y;a++){var D=a*w-g;for(n=0;n<M;n++)o=n*b-m,A[P]=o+p,A[P+1]=_,A[P+2]=-D+f,E[P+2]=-1,C[S]=(v-n)/v,C[S+1]=(x-a)/x,P+=3,S+=2}P=0;var T=new(A.length/3>65535?Uint32Array:Uint16Array)(v*x*6);for(a=0;a<x;a++)for(n=0;n<v;n++)l=n+M*a,h=n+M*(a+1),u=n+1+M*(a+1),c=n+1+M*a,T[P]=c,T[P+1]=h,T[P+2]=l,T[P+3]=c,T[P+4]=u,T[P+5]=h,P+=6;this._super(xeogl._apply(e,{positions:A,normals:E,uv:C,indices:T}))}})}(),function(){"use strict";xeogl.Input=xeogl.Component.extend({type:"xeogl.Input",serializable:!1,_init:function(e){var t,i,s,r,a,n,o,l,h,u,c=this;this._element=e.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.mouseover=!1,document.addEventListener("keydown",this._keyDownListener=function(e){c.enabled&&("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.ctrlKey?c.ctrlDown=!0:e.altKey?c.altDown=!0:(c.keyDown[e.keyCode]=!0,c.fire("keydown",e.keyCode,!0))),c.mouseover&&e.preventDefault())},!0),document.addEventListener("keyup",this._keyUpListener=function(e){c.enabled&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.ctrlKey?c.ctrlDown=!1:e.altKey?c.altDown=!1:(c.keyDown[e.keyCode]=!1,c.fire("keyup",e.keyCode,!0)))}),e.element.addEventListener("mouseenter",this._mouseEnterListener=function(e){if(c.enabled){c.mouseover=!0;var t=c._getClickCoordsWithinElement(e);c.fire("mouseenter",t,!0)}}),e.element.addEventListener("mouseleave",this._mouseLeaveListener=function(e){if(c.enabled){c.mouseover=!1;var t=c._getClickCoordsWithinElement(e);c.fire("mouseleave",t,!0)}}),e.element.addEventListener("mousedown",this._mouseDownListener=function(t){if(c.enabled){switch(t.which){case 1:c.mouseDownLeft=!0;break;case 2:c.mouseDownMiddle=!0;break;case 3:c.mouseDownRight=!0}var i=c._getClickCoordsWithinElement(t);e.element.focus(),c.fire("mousedown",i,!0),c.mouseover&&t.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=function(e){if(c.enabled){switch(e.which){case 1:c.mouseDownLeft=!1;break;case 2:c.mouseDownMiddle=!1;break;case 3:c.mouseDownRight=!1}var t=c._getClickCoordsWithinElement(e);c.fire("mouseup",t,!0),c.mouseover&&e.preventDefault()}},!0),document.addEventListener("dblclick",this._dblClickListener=function(e){if(c.enabled){switch(e.which){case 1:c.mouseDownLeft=!1,c.mouseDownRight=!1;break;case 2:c.mouseDownMiddle=!1;break;case 3:c.mouseDownLeft=!1,c.mouseDownRight=!1}var t=c._getClickCoordsWithinElement(e);c.fire("dblclick",t,!0),c.mouseover&&e.preventDefault()}}),e.element.addEventListener("mousemove",this._mouseMoveListener=function(e){if(c.enabled){var t=c._getClickCoordsWithinElement(e);c.fire("mousemove",t,!0),c.mouseover&&e.preventDefault()}}),e.element.addEventListener("wheel",this._mouseWheelListener=function(e,t){if(c.enabled){var i=Math.max(-1,Math.min(1,40*-e.deltaY));c.fire("mousewheel",i,!0)}},{passive:!0}),c.on("mousedown",function(e){t=e[0],i=e[1]}),c.on("mouseup",function(e){t>=e[0]-2&&t<=e[0]+2&&i>=e[1]-2&&i<=e[1]+2&&c.fire("mouseclicked",e,!0)}),a={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0},n=xeogl.math.vec3(),o=xeogl.math.vec3(),l={orientation:null,orientationAngle:0},h={orientationAngle:0,acceleration:null,accelerationIncludingGravity:o,rotationRate:xeogl.math.vec3(),interval:0},u={alpha:0,beta:0,gamma:0,absolute:!1},window.OrientationChangeEvent&&window.addEventListener("orientationchange",c._orientationchangedListener=function(){s=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,r=s&&a[s]||0,l.orientation=s,l.orientationAngle=r,c.fire("orientationchange",l)},!1),window.DeviceMotionEvent&&window.addEventListener("devicemotion",c._deviceMotionListener=function(e){h.interval=e.interval,h.orientationAngle=r;var t=e.acceleration;t?(n[0]=t.x,n[1]=t.y,n[2]=t.z,h.acceleration=n):h.acceleration=null;var i=e.accelerationIncludingGravity;i?(o[0]=i.x,o[1]=i.y,o[2]=i.z,h.accelerationIncludingGravity=o):h.accelerationIncludingGravity=null,h.rotationRate=e.rotationRate,c.fire("devicemotion",h)},!1),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",c._deviceOrientListener=function(e){u.gamma=e.gamma,u.beta=e.beta,u.alpha=e.alpha,u.absolute=e.absolute,c.fire("deviceorientation",u)},!1)},_getClickCoordsWithinElement:function(e){var t=[0,0];if(e){for(var i=e.target,s=0,r=0;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t.x=e.x,t.y=e.y;return t},setEnabled:function(e){this.enabled!==e&&this.fire("enabled",this.enabled=e)},KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_NUM_0:48,KEY_NUM_1:49,KEY_NUM_2:50,KEY_NUM_3:51,KEY_NUM_4:52,KEY_NUM_5:53,KEY_NUM_6:54,KEY_NUM_7:55,KEY_NUM_8:56,KEY_NUM_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW:91,KEY_RIGHT_WINDOW:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_SPACE:32,_destroy:function(){document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener),this._element.removeEventListener("mouseenter",this._mouseEnterListener),this._element.removeEventListener("mouseleave",this._mouseLeaveListener),this._element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("dblclick",this._dblClickListener),this._element.removeEventListener("mousemove",this._mouseMoveListener),this._element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",this._deviceOrientListener)}})}(),function(){"use strict";xeogl.AmbientLight=xeogl.Component.extend({type:"xeogl.AmbientLight",_init:function(e){this._state={type:"ambient",color:xeogl.math.vec3([.7,.7,.7]),intensity:1},this.color=e.color,this.intensity=e.intensity,this.scene._lightCreated(this)},_props:{color:{set:function(e){this._state.color.set(e||[.7,.7,.8]),this._renderer.setImageForceDirty()},get:function(){return this._state.color}},intensity:{set:function(e){this._state.intensity=void 0!==e?e:1,this._renderer.setImageForceDirty()},get:function(){return this._state.intensity}}},_destroy:function(){this.scene._lightDestroyed(this)}})}(),function(){"use strict";var e=xeogl.math;xeogl.DirLight=xeogl.Component.extend({type:"xeogl.DirLight",_init:function(t){var i=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new xeogl.renderer.State({type:"dir",dir:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,space:t.space||"view",shadow:!1,shadowDirty:!0,getShadowViewMatrix:function(){e.vec3();var t=e.vec3([0,1,0]);return function(){if(i._shadowViewMatrixDirty){i._shadowViewMatrix||(i._shadowViewMatrix=e.identityMat4());var s=i._state.dir;e.lookAtMat4v([-s[0],-s[1],-s[2]],[0,0,0],t,i._shadowViewMatrix),i._shadowViewMatrixDirty=!1}return i._shadowViewMatrix}}(),getShadowProjMatrix:function(){return i._shadowProjMatrixDirty&&(i._shadowProjMatrix||(i._shadowProjMatrix=e.identityMat4()),xeogl.math.orthoMat4c(-10,10,-10,10,0,1e3,i._shadowProjMatrix),i._shadowProjMatrixDirty=!1),i._shadowProjMatrix},getShadowRenderBuf:function(){return i._shadowRenderBuf||(i._shadowRenderBuf=new xeogl.renderer.RenderBuffer(i.scene.canvas.canvas,i.scene.canvas.gl)),i._shadowRenderBuf}}),this.dir=t.dir,this.color=t.color,this.intensity=t.intensity,this.shadow=t.shadow,this.scene._lightCreated(this)},_props:{dir:{set:function(e){this._state.dir.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty()},get:function(){return this._state.dir}},color:{set:function(e){this._state.color.set(e||[.7,.7,.8]),this._renderer.imageDirty()},get:function(){return this._state.color}},intensity:{set:function(e){e=void 0!==e?e:1,this._state.intensity=e,this._renderer.imageDirty()},get:function(){return this._state.intensity}},shadow:{set:function(e){e=!!e,this._state.shadow!==e&&(this._state.shadow=e,this._shadowViewMatrixDirty=!0,this._renderer.imageDirty())},get:function(){return this._state.shadow}}},_destroy:function(){this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this)}})}(),function(){"use strict";var e=xeogl.math;xeogl.PointLight=xeogl.Component.extend({type:"xeogl.PointLight",_init:function(t){var i,s,r=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new xeogl.renderer.State({type:"point",pos:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:t.space||"view",shadow:!1,shadowDirty:!0,getShadowViewMatrix:(i=e.vec3([0,0,0]),s=e.vec3([0,1,0]),function(){return r._shadowViewMatrixDirty&&(r._shadowViewMatrix||(r._shadowViewMatrix=e.identityMat4()),e.lookAtMat4v(r._state.pos,i,s,r._shadowViewMatrix),r._shadowViewMatrixDirty=!1),r._shadowViewMatrix}),getShadowProjMatrix:function(){if(r._shadowProjMatrixDirty){r._shadowProjMatrix||(r._shadowProjMatrix=e.identityMat4());var t=r.scene.canvas.canvas;e.perspectiveMat4(Math.PI/180*70,t.clientWidth/t.clientHeight,.1,500,r._shadowProjMatrix),r._shadowProjMatrixDirty=!1}return r._shadowProjMatrix},getShadowRenderBuf:function(){return r._shadowRenderBuf||(r._shadowRenderBuf=new xeogl.renderer.RenderBuffer(r.scene.canvas.canvas,r.scene.canvas.gl)),r._shadowRenderBuf}}),this.pos=t.pos,this.color=t.color,this.intensity=t.intensity,this.constantAttenuation=t.constantAttenuation,this.linearAttenuation=t.linearAttenuation,this.quadraticAttenuation=t.quadraticAttenuation,this.shadow=t.shadow,this.scene._lightCreated(this)},_props:{pos:{set:function(e){this._state.pos.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty()},get:function(){return this._state.pos}},color:{set:function(e){this._state.color.set(e||[.7,.7,.8]),this._renderer.imageDirty()},get:function(){return this._state.color}},intensity:{set:function(e){e=void 0!==e?e:1,this._state.intensity=e,this._renderer.imageDirty()},get:function(){return this._state.intensity}},constantAttenuation:{set:function(e){this._state.attenuation[0]=e||0,this._renderer.imageDirty()},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(e){this._state.attenuation[1]=e||0,this._renderer.imageDirty()},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(e){this._state.attenuation[2]=e||0,this._renderer.imageDirty()},get:function(){return this._state.attenuation[2]}},shadow:{set:function(e){e=!!e,this._state.shadow!==e&&(this._state.shadow=e,this._shadowViewMatrixDirty=!0,this._renderer.imageDirty())},get:function(){return this._state.shadow}}},_destroy:function(){this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this)}})}(),function(){"use strict";var e=xeogl.math;xeogl.SpotLight=xeogl.Component.extend({type:"xeogl.SpotLight",_init:function(t){var i,s,r=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new xeogl.renderer.State({type:"spot",pos:e.vec3([1,1,1]),dir:e.vec3([0,-1,0]),color:e.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:t.space||"view",shadow:!1,shadowDirty:!0,getShadowViewMatrix:(i=e.vec3(),s=e.vec3([0,1,0]),function(){return r._shadowViewMatrixDirty&&(r._shadowViewMatrix||(r._shadowViewMatrix=e.identityMat4()),e.addVec3(r._state.pos,r._state.dir,i),e.lookAtMat4v(r._state.pos,i,s,r._shadowViewMatrix),r._shadowViewMatrixDirty=!1),r._shadowViewMatrix}),getShadowProjMatrix:function(){if(r._shadowProjMatrixDirty){r._shadowProjMatrix||(r._shadowProjMatrix=e.identityMat4());var t=r.scene.canvas.canvas;e.perspectiveMat4(Math.PI/180*60,t.clientWidth/t.clientHeight,.1,400,r._shadowProjMatrix),r._shadowProjMatrixDirty=!1}return r._shadowProjMatrix},getShadowRenderBuf:function(){return r._shadowRenderBuf||(r._shadowRenderBuf=new xeogl.renderer.RenderBuffer(r.scene.canvas.canvas,r.scene.canvas.gl)),r._shadowRenderBuf}}),this.pos=t.pos,this.color=t.color,this.intensity=t.intensity,this.constantAttenuation=t.constantAttenuation,this.linearAttenuation=t.linearAttenuation,this.quadraticAttenuation=t.quadraticAttenuation,this.shadow=t.shadow,this.scene._lightCreated(this)},_props:{pos:{set:function(e){this._state.pos.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty()},get:function(){return this._state.pos}},dir:{set:function(e){this._state.dir.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty()},get:function(){return this._state.dir}},color:{set:function(e){this._state.color.set(e||[.7,.7,.8]),this._renderer.imageDirty()},get:function(){return this._state.color}},intensity:{set:function(e){e=void 0!==e?e:1,this._state.intensity=e,this._renderer.imageDirty()},get:function(){return this._state.intensity}},constantAttenuation:{set:function(e){this._state.attenuation[0]=e||0,this._renderer.imageDirty()},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(e){this._state.attenuation[1]=e||0,this._renderer.imageDirty()},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(e){this._state.attenuation[2]=e||0,this._renderer.imageDirty()},get:function(){return this._state.attenuation[2]}},shadow:{set:function(e){e=!!e,this._state.shadow!==e&&(this._state.shadow=e,this._shadowViewMatrixDirty=!0,this._renderer.imageDirty(),this.fire("dirty",!0))},get:function(){return this._state.shadow}}},_destroy:function(){this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this)}})}(),function(){"use strict";xeogl.CubeTexture=xeogl.Component.extend({type:"xeogl.CubeTexture",_init:function(e){var t=this.scene.canvas.gl;this._state=new xeogl.renderer.State({texture:new xeogl.renderer.Texture2D(t,t.TEXTURE_CUBE_MAP),flipY:this._checkFlipY(e.minFilter),encoding:this._checkEncoding(e.encoding),minFilter:"linearMipmapLinear",magFilter:"linear",wrapS:"clampToEdge",wrapT:"clampToEdge",mipmaps:!0}),this._src=e.src,this._images=[],this._loadSrc(e.src),xeogl.stats.memory.textures++},_checkFlipY:function(e){return!!e},_checkEncoding:function(e){return"linear"!==(e=e||"linear")&&"sRGB"!==e&&"gamma"!==e&&(this.error("Unsupported value for 'encoding': '"+e+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),e="linear"),e},_webglContextRestored:function(){this.scene.canvas.gl;this._state.texture=null,this._src&&this._loadSrc(this._src)},_loadSrc:function(e){var t=this,i=this.scene.canvas.gl;this._images=[];for(var s=!1,r=0,a=0;a<e.length;a++){var n=new Image;n.onload=function(){var e=n,o=a;return function(){if(!s&&(e=xeogl.renderer.ensureImageSizePowerOfTwo(e),t._images[o]=e,6===++r)){var a=t._state.texture;a||(a=new xeogl.renderer.Texture2D(i,i.TEXTURE_CUBE_MAP),t._state.texture=a),a.setImage(t._images,t._state),a.setProps(t._state),t.fire("loaded",t._src)}}}(),n.onerror=function(){s=!0},n.src=e[a]}},_destroy:function(){this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.LightMap=xeogl.CubeTexture.extend({type:"xeogl.LightMap",_init:function(e){this._super(e),this.scene._lightMapCreated(this)},_destroy:function(){this._super(),this.scene._lightMapDestroyed(this)}})}(),function(){"use strict";xeogl.ReflectionMap=xeogl.CubeTexture.extend({type:"xeogl.ReflectionMap",_init:function(e){this._super(e),this.scene._lightsState.addReflectionMap(this._state),this.scene._reflectionMapCreated(this)},_destroy:function(){this._super(),this.scene._reflectionMapDestroyed(this)}})}(),function(){"use strict";xeogl.Shadow=xeogl.Component.extend({type:"xeogl.Shadow",_init:function(e){this._state={resolution:xeogl.math.vec3([1e3,1e3]),intensity:1},this.resolution=e.resolution,this.intensity=e.intensity},_props:{resolution:{set:function(e){this._state.resolution.set(e||[1e3,1e3]),this._renderer.imageDirty(),this.fire("resolution",this._state.resolution)},get:function(){return this._state.resolution}},intensity:{set:function(e){e=void 0!==e?e:1,this._state.intensity=e,this._renderer.imageDirty(),this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}}}})}(),function(){"use strict";xeogl.Model=xeogl.Group.extend({type:"xeogl.Model",_init:function(e){this.components={},this.numComponents=0,this.types={},this.objects={},this.guidObjects={},this.meshes={},this.entities={},this.entityTypes={},this._objectGUIDs=null,this._entityIds=null,this._super(e),this.scene._modelCreated(this)},_addComponent:function(e){var t;if(xeogl._isNumeric(e)||xeogl._isString(e)){if(!(e=this.scene.components[e]))return void this.warn("Component not found: "+xeogl._inQuotes(e))}else if(xeogl._isObject(e)){var i=e.type||"xeogl.Component";if(!xeogl._isComponentType(i))return void this.error("Not a xeogl component type: "+i);e=new window[i](this.scene,e)}if(e.scene===this.scene){if(!this.components[e.id]){if(e.model&&e.model.id!==this.id&&e.model._removeComponent(e),this.components[e.id]=e,(t=this.types[e.type])||(t=this.types[e.type]={}),t[e.id]=e,e.isType("xeogl.Object")){var s=e;if(this.objects[s.id]=s,s.entityType){this.entities[s.id]=s;var r=this.entityTypes[s.entityType];r||(r={},this.entityTypes[s.entityType]=r),r[s.id]=s,this._entityIds=null,this._entityTypeIds=null}s.guid&&(this.guidObjects[s.id]=s,this._objectGUIDs=null),e.isType("xeogl.Mesh")&&(this.meshes[e.id]=e)}return this.numComponents++,e._addedToModel(this),e}}else this.error("Attempted to add component from different xeogl.Scene: "+xeogl._inQuotes(e.id))},_removeComponent:function(e){var t=e.id;if(delete this.components[t],delete this.meshes[t],delete this.objects[t],e.entityType){delete this.entities[t];var i=this.entityTypes[e.entityType];i&&delete i[t],this._entityIds=null,this._entityTypeIds=null}e.guid&&(delete this.guidObjects[e.guid],this._objectGUIDs=null)},clear:function(){for(var e in this.meshes)this.meshes.hasOwnProperty(e)&&this.meshes[e].destroy();for(var e in this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this.components={},this.numComponents=0,this.types={},this.objects={},this.meshes={},this.entities={}},_props:{objectGUIDs:{get:function(){return this._objectGUIDs||(this._objectGUIDs=Object.keys(this.guidObjects)),this._objectGUIDs}},entityTypeIds:{get:function(){return this._entityTypeIds||(this._entityTypeIds=Object.keys(this.entityTypes)),this._entityTypeIds}},entityIds:{get:function(){return this._entityIds||(this._entityIds=Object.keys(this.entities)),this._entityIds}}},destroyAll:function(){this.clear()},_destroy:function(){this._super(),this.clear(),this.scene._modelDestroyed(this)}})}(),function(){"use strict";xeogl.Material=xeogl.Component.extend({type:"xeogl.Material",_init:function(){xeogl.stats.memory.materials++},_destroy:function(){xeogl.stats.memory.materials--}})}(),function(){"use strict";var e,t;xeogl.PhongMaterial=xeogl.Material.extend({type:"xeogl.PhongMaterial",_init:function(e){this._super(e),this._state=new xeogl.renderer.State({type:"PhongMaterial",ambient:xeogl.math.vec3([1,1,1]),diffuse:xeogl.math.vec3([1,1,1]),specular:xeogl.math.vec3([1,1,1]),emissive:xeogl.math.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=e.ambient,this.diffuse=e.diffuse,this.specular=e.specular,this.emissive=e.emissive,this.alpha=e.alpha,this.shininess=e.shininess,this.reflectivity=e.reflectivity,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,e.ambientMap&&(this._ambientMap=this._checkComponent("xeogl.Texture",e.ambientMap)),e.diffuseMap&&(this._diffuseMap=this._checkComponent("xeogl.Texture",e.diffuseMap)),e.specularMap&&(this._specularMap=this._checkComponent("xeogl.Texture",e.specularMap)),e.emissiveMap&&(this._emissiveMap=this._checkComponent("xeogl.Texture",e.emissiveMap)),e.alphaMap&&(this._alphaMap=this._checkComponent("xeogl.Texture",e.alphaMap)),e.reflectivityMap&&(this._reflectivityMap=this._checkComponent("xeogl.Texture",e.reflectivityMap)),e.normalMap&&(this._normalMap=this._checkComponent("xeogl.Texture",e.normalMap)),e.occlusionMap&&(this._occlusionMap=this._checkComponent("xeogl.Texture",e.occlusionMap)),e.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("xeogl.Fresnel",e.diffuseFresnel)),e.specularFresnel&&(this._specularFresnel=this._checkComponent("xeogl.Fresnel",e.specularFresnel)),e.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("xeogl.Fresnel",e.emissiveFresnel)),e.alphaFresnel&&(this._alphaFresnel=this._checkComponent("xeogl.Fresnel",e.alphaFresnel)),e.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("xeogl.Fresnel",e.reflectivityFresnel)),this.alphaMode=e.alphaMode,this.alphaCutoff=e.alphaCutoff,this.backfaces=e.backfaces,this.frontface=e.frontface,this._makeHash()},_makeHash:function(){var e=this._state,t=["/p"];this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._ambientMap&&(t.push("/am"),this._ambientMap.hasMatrix&&t.push("/mat"),t.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat"),t.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),this._reflectivityMap&&(t.push("/rm"),this._reflectivityMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._diffuseFresnel&&t.push("/df"),this._specularFresnel&&t.push("/sf"),this._emissiveFresnel&&t.push("/ef"),this._alphaFresnel&&t.push("/of"),this._reflectivityFresnel&&t.push("/rf"),t.push(";"),e.hash=t.join("")},_props:{ambient:{set:function(e){var t=this._state.ambient;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.ambient=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.ambient}},diffuse:{set:function(e){var t=this._state.diffuse;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.diffuse=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()},get:function(){return this._state.diffuse}},specular:{set:function(e){var t=this._state.specular;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.specular=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()},get:function(){return this._state.specular}},emissive:{set:function(e){var t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this._renderer.imageDirty()},get:function(){return this._state.emissive}},alpha:{set:function(e){e=void 0!==e&&null!==e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this._renderer.imageDirty())},get:function(){return this._state.alpha}},shininess:{set:function(e){this._state.shininess=void 0!==e?e:80,this._renderer.imageDirty()},get:function(){return this._state.shininess}},lineWidth:{set:function(e){this._state.lineWidth=e||1,this._renderer.imageDirty()},get:function(){return this._state.lineWidth}},pointSize:{set:function(e){this._state.pointSize=e||1,this._renderer.imageDirty()},get:function(){return this._state.pointSize}},reflectivity:{set:function(e){this._state.reflectivity=void 0!==e?e:1,this._renderer.imageDirty()},get:function(){return this._state.reflectivity}},normalMap:{get:function(){return this._normalMap}},ambientMap:{get:function(){return this._ambientMap}},diffuseMap:{get:function(){return this._diffuseMap}},specularMap:{get:function(){return this._specularMap}},emissiveMap:{get:function(){return this._emissiveMap}},alphaMap:{get:function(){return this._alphaMap}},reflectivityMap:{get:function(){return this._reflectivityMap}},occlusionMap:{get:function(){return this._occlusionMap}},diffuseFresnel:{get:function(){return this._diffuseFresnel}},specularFresnel:{get:function(){return this._specularFresnel}},emissiveFresnel:{get:function(){return this._emissiveFresnel}},alphaFresnel:{get:function(){return this._alphaFresnel}},reflectivityFresnel:{get:function(){return this._reflectivityFresnel}},alphaMode:(e={opaque:0,mask:1,blend:2},t=["opaque","mask","blend"],{set:function(t){var i=e[t=t||"opaque"];void 0===i&&(this.error("Unsupported value for 'alphaMode': "+t+" - defaulting to 'opaque'"),i="opaque"),this._state.alphaMode!==i&&(this._state.alphaMode=i,this._renderer.imageDirty())},get:function(){return t[this._state.alphaMode]}}),alphaCutoff:{set:function(e){null!==e&&void 0!==e||(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)},get:function(){return this._state.alphaCutoff}},backfaces:{set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},frontface:{set:function(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this._renderer.imageDirty())},get:function(){return this._state.frontface?"ccw":"cw"}}},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";xeogl.LambertMaterial=xeogl.Material.extend({type:"xeogl.LambertMaterial",_init:function(e){this._super(e),this._state=new xeogl.renderer.State({type:"LambertMaterial",ambient:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([1,1,1]),emissive:xeogl.math.vec3([0,0,0]),alpha:null,alphaMode:0,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:"/lam;"}),this.ambient=e.ambient,this.color=e.color,this.emissive=e.emissive,this.alpha=e.alpha,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,this.backfaces=e.backfaces,this.frontface=e.frontface},_props:{ambient:{set:function(e){var t=this._state.ambient;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.ambient=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.ambient}},color:{set:function(e){var t=this._state.color;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.color=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()},get:function(){return this._state.color}},emissive:{set:function(e){var t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this._renderer.imageDirty()},get:function(){return this._state.emissive}},alpha:{set:function(e){e=void 0!==e&&null!==e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this._state.alphaMode=e<1?2:0,this._renderer.imageDirty())},get:function(){return this._state.alpha}},lineWidth:{set:function(e){this._state.lineWidth=e||1,this._renderer.imageDirty()},get:function(){return this._state.lineWidth}},pointSize:{set:function(e){this._state.pointSize=e||1,this._renderer.imageDirty()},get:function(){return this._state.pointSize}},backfaces:{set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},frontface:{set:function(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this._renderer.imageDirty())},get:function(){return this._state.frontface?"ccw":"cw"}}},_getState:function(){return this._state},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";var e,t;xeogl.SpecularMaterial=xeogl.Material.extend({type:"xeogl.SpecularMaterial",_init:function(e){this._super(e),this._state=new xeogl.renderer.State({type:"SpecularMaterial",diffuse:xeogl.math.vec3([1,1,1]),emissive:xeogl.math.vec3([0,0,0]),specular:xeogl.math.vec3([1,1,1]),glossiness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.diffuse=e.diffuse,this.specular=e.specular,this.glossiness=e.glossiness,this.specularF0=e.specularF0,this.emissive=e.emissive,this.alpha=e.alpha,e.diffuseMap&&(this._diffuseMap=this._checkComponent("xeogl.Texture",e.diffuseMap)),e.emissiveMap&&(this._emissiveMap=this._checkComponent("xeogl.Texture",e.emissiveMap)),e.specularMap&&(this._specularMap=this._checkComponent("xeogl.Texture",e.specularMap)),e.glossinessMap&&(this._glossinessMap=this._checkComponent("xeogl.Texture",e.glossinessMap)),e.specularGlossinessMap&&(this._specularGlossinessMap=this._checkComponent("xeogl.Texture",e.specularGlossinessMap)),e.occlusionMap&&(this._occlusionMap=this._checkComponent("xeogl.Texture",e.occlusionMap)),e.alphaMap&&(this._alphaMap=this._checkComponent("xeogl.Texture",e.alphaMap)),e.normalMap&&(this._normalMap=this._checkComponent("xeogl.Texture",e.normalMap)),this.alphaMode=e.alphaMode,this.alphaCutoff=e.alphaCutoff,this.backfaces=e.backfaces,this.frontface=e.frontface,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,this._makeHash()},_makeHash:function(){var e=this._state,t=["/spe"];this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat")),this._glossinessMap&&(t.push("/gm"),this._glossinessMap.hasMatrix&&t.push("/mat")),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._specularGlossinessMap&&(t.push("/sgm"),this._specularGlossinessMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),t.push(";"),e.hash=t.join("")},_props:{diffuse:{set:function(e){var t=this._state.diffuse;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.diffuse=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()},get:function(){return this._state.diffuse}},diffuseMap:{get:function(){return this._diffuseMap}},specular:{set:function(e){var t=this._state.specular;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.specular=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()},get:function(){return this._state.specular}},specularMap:{get:function(){return this._specularMap}},specularGlossinessMap:{get:function(){return this._specularGlossinessMap}},glossiness:{set:function(e){e=void 0!==e&&null!==e?e:1,this._state.glossiness!==e&&(this._state.glossiness=e,this._renderer.imageDirty())},get:function(){return this._state.glossiness}},glossinessMap:{get:function(){return this._glossinessMap}},specularF0:{set:function(e){e=void 0!==e&&null!==e?e:0,this._state.specularF0!==e&&(this._state.specularF0=e,this._renderer.imageDirty())},get:function(){return this._state.specularF0}},emissive:{set:function(e){var t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this._renderer.imageDirty()},get:function(){return this._state.emissive}},emissiveMap:{get:function(){return this._emissiveMap}},alpha:{set:function(e){e=void 0!==e&&null!==e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this._renderer.imageDirty())},get:function(){return this._state.alpha}},alphaMap:{get:function(){return this._alphaMap}},normalMap:{get:function(){return this._normalMap}},occlusionMap:{get:function(){return this._occlusionMap}},alphaMode:(e={opaque:0,mask:1,blend:2},t=["opaque","mask","blend"],{set:function(t){var i=e[t=t||"opaque"];void 0===i&&(this.error("Unsupported value for 'alphaMode': "+t+" defaulting to 'opaque'"),i="opaque"),this._state.alphaMode!==i&&(this._state.alphaMode=i,this._renderer.imageDirty())},get:function(){return t[this._state.alphaMode]}}),alphaCutoff:{set:function(e){null!==e&&void 0!==e||(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)},get:function(){return this._state.alphaCutoff}},backfaces:{set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},frontface:{set:function(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this._renderer.imageDirty())},get:function(){return this._state.frontface?"ccw":"cw"}},lineWidth:{set:function(e){this._state.lineWidth=e||1,this._renderer.imageDirty()},get:function(){return this._state.lineWidth}},pointSize:{set:function(e){this._state.pointSize=e||1,this._renderer.imageDirty()},get:function(){return this._state.pointSize}}},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";var e,t;xeogl.MetallicMaterial=xeogl.Material.extend({type:"xeogl.MetallicMaterial",_init:function(e){this._super(e),this._state=new xeogl.renderer.State({type:"MetallicMaterial",baseColor:xeogl.math.vec4([1,1,1]),emissive:xeogl.math.vec4([0,0,0]),metallic:null,roughness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.baseColor=e.baseColor,this.metallic=e.metallic,this.roughness=e.roughness,this.specularF0=e.specularF0,this.emissive=e.emissive,this.alpha=e.alpha,e.baseColorMap&&(this._baseColorMap=this._checkComponent("xeogl.Texture",e.baseColorMap)),e.metallicMap&&(this._metallicMap=this._checkComponent("xeogl.Texture",e.metallicMap)),e.roughnessMap&&(this._roughnessMap=this._checkComponent("xeogl.Texture",e.roughnessMap)),e.metallicRoughnessMap&&(this._metallicRoughnessMap=this._checkComponent("xeogl.Texture",e.metallicRoughnessMap)),e.emissiveMap&&(this._emissiveMap=this._checkComponent("xeogl.Texture",e.emissiveMap)),e.occlusionMap&&(this._occlusionMap=this._checkComponent("xeogl.Texture",e.occlusionMap)),e.alphaMap&&(this._alphaMap=this._checkComponent("xeogl.Texture",e.alphaMap)),e.normalMap&&(this._normalMap=this._checkComponent("xeogl.Texture",e.normalMap)),this.alphaMode=e.alphaMode,this.alphaCutoff=e.alphaCutoff,this.backfaces=e.backfaces,this.frontface=e.frontface,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,this._makeHash()},_makeHash:function(){var e=this._state,t=["/met"];this._baseColorMap&&(t.push("/bm"),this._baseColorMap._state.hasMatrix&&t.push("/mat"),t.push("/"+this._baseColorMap._state.encoding)),this._metallicMap&&(t.push("/mm"),this._metallicMap._state.hasMatrix&&t.push("/mat")),this._roughnessMap&&(t.push("/rm"),this._roughnessMap._state.hasMatrix&&t.push("/mat")),this._metallicRoughnessMap&&(t.push("/mrm"),this._metallicRoughnessMap._state.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap._state.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap._state.hasMatrix&&t.push("/mat")),this._alphaMap&&(t.push("/am"),this._alphaMap._state.hasMatrix&&t.push("/mat")),this._normalMap&&(t.push("/nm"),this._normalMap._state.hasMatrix&&t.push("/mat")),t.push(";"),e.hash=t.join("")},_props:{baseColor:{set:function(e){var t=this._state.baseColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.baseColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this._renderer.imageDirty()},get:function(){return this._state.baseColor}},baseColorMap:{get:function(){return this._baseColorMap}},metallic:{set:function(e){e=void 0!==e&&null!==e?e:1,this._state.metallic!==e&&(this._state.metallic=e,this._renderer.imageDirty())},get:function(){return this._state.metallic}},metallicMap:{get:function(){return this._attached.metallicMap}},roughness:{set:function(e){e=void 0!==e&&null!==e?e:1,this._state.roughness!==e&&(this._state.roughness=e,this._renderer.imageDirty())},get:function(){return this._state.roughness}},roughnessMap:{get:function(){return this._attached.roughnessMap}},metallicRoughnessMap:{get:function(){return this._attached.metallicRoughnessMap}},specularF0:{set:function(e){e=void 0!==e&&null!==e?e:0,this._state.specularF0!==e&&(this._state.specularF0=e,this._renderer.imageDirty())},get:function(){return this._state.specularF0}},emissive:{set:function(e){var t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this._renderer.imageDirty()},get:function(){return this._state.emissive}},emissiveMap:{get:function(){return this._attached.emissiveMap}},occlusionMap:{get:function(){return this._attached.occlusionMap}},alpha:{set:function(e){e=void 0!==e&&null!==e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this._renderer.imageDirty())},get:function(){return this._state.alpha}},alphaMap:{get:function(){return this._attached.alphaMap}},normalMap:{get:function(){return this._attached.normalMap}},alphaMode:(e={opaque:0,mask:1,blend:2},t=["opaque","mask","blend"],{set:function(t){var i=e[t=t||"opaque"];void 0===i&&(this.error("Unsupported value for 'alphaMode': "+t+" defaulting to 'opaque'"),i="opaque"),this._state.alphaMode!==i&&(this._state.alphaMode=i,this._renderer.imageDirty())},get:function(){return t[this._state.alphaMode]}}),alphaCutoff:{set:function(e){null!==e&&void 0!==e||(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)},get:function(){return this._state.alphaCutoff}},backfaces:{set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},frontface:{set:function(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this._renderer.imageDirty())},get:function(){return this._state.frontface?"ccw":"cw"}},lineWidth:{set:function(e){this._state.lineWidth=e||1,this._renderer.imageDirty()},get:function(){return this._state.lineWidth}},pointSize:{set:function(e){this._state.pointSize=e||1,this._renderer.imageDirty()},get:function(){return this._state.pointSize}}},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";xeogl.EmphasisMaterial=xeogl.Material.extend({type:"xeogl.EmphasisMaterial",_init:function(e){this._super(e),this._state=new xeogl.renderer.State({type:"EmphasisMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,vertices:null,vertexColor:null,vertexAlpha:null,vertexSize:null,fill:null,fillColor:null,fillAlpha:null,backfaces:!0}),this._preset="default",e.preset?(this.preset=e.preset,void 0!==e.edges&&(this.edges=e.edges),e.edgeColor&&(this.edgeColor=e.edgeColor),void 0!==e.edgeAlpha&&(this.edgeAlpha=e.edgeAlpha),void 0!==e.edgeWidth&&(this.edgeWidth=e.edgeWidth),void 0!==e.vertices&&(this.vertices=e.vertices),e.vertexColor&&(this.vertexColor=e.vertexColor),void 0!==e.vertexAlpha&&(this.vertexAlpha=e.vertexAlpha),e.vertexSize&&(this.vertexSize=e.vertexSize),void 0!==e.fill&&(this.fill=e.fill),e.fillColor&&(this.fillColor=e.fillColor),void 0!==e.fillAlpha&&(this.fillAlpha=e.fillAlpha),void 0!==e.backfaces&&(this.backfaces=e.backfaces)):(this.edges=e.edges,this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this.vertices=e.vertices,this.vertexColor=e.vertexColor,this.vertexAlpha=e.vertexAlpha,this.vertexSize=e.vertexSize,this.fill=e.fill,this.fillColor=e.fillColor,this.fillAlpha=e.fillAlpha,this.backfaces=e.backfaces)},_props:{edges:{set:function(e){e=!1!==e,this._state.edges!==e&&(this._state.edges=e,this._renderer.imageDirty())},get:function(){return this._state.edges}},edgeColor:{set:function(e){var t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.edgeColor}},edgeAlpha:{set:function(e){e=void 0!==e&&null!==e?e:.5,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this._renderer.imageDirty())},get:function(){return this._state.edgeAlpha}},edgeWidth:{set:function(e){this._state.edgeWidth=e||1,this._renderer.imageDirty()},get:function(){return this._state.edgeWidth}},vertices:{set:function(e){e=!!e,this._state.vertices!==e&&(this._state.vertices=e,this._renderer.imageDirty())},get:function(){return this._state.vertices}},vertexColor:{set:function(e){var t=this._state.vertexColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.vertexColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.4,t[1]=.4,t[2]=.4),this._renderer.imageDirty()},get:function(){return this._state.vertexColor}},vertexAlpha:{set:function(e){e=void 0!==e&&null!==e?e:.7,this._state.vertexAlpha!==e&&(this._state.vertexAlpha=e,this._renderer.imageDirty())},get:function(){return this._state.vertexAlpha}},vertexSize:{set:function(e){this._state.vertexSize=e||4,this._renderer.imageDirty()},get:function(){return this._state.vertexSize}},fill:{set:function(e){e=!1!==e,this._state.fill!==e&&(this._state.fill=e,this._renderer.imageDirty())},get:function(){return this._state.fill}},fillColor:{set:function(e){var t=this._state.fillColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.fillColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.4,t[1]=.4,t[2]=.4),this._renderer.imageDirty()},get:function(){return this._state.fillColor}},fillAlpha:{set:function(e){e=void 0!==e&&null!==e?e:.2,this._state.fillAlpha!==e&&(this._state.fillAlpha=e,this._renderer.imageDirty())},get:function(){return this._state.fillAlpha}},backfaces:{set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},preset:{set:function(e){if(e=e||"default",this._preset!==e){var t=xeogl.EmphasisMaterial.presets[e];t?(this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.vertices=t.vertices,this.vertexColor=t.vertexColor,this.vertexAlpha=t.vertexAlpha,this.vertexSize=t.vertexSize,this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(xeogl.EmphasisMaterial.presets).join(", "))}},get:function(){return this._preset}}},_destroy:function(){this._super(),this._state.destroy()}}),xeogl.EmphasisMaterial.presets={default:{edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[1,1,1],fillAlpha:.6},defaultLightBG:{edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2},defaultDarkBG:{edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2},phosphorous:{edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:1,fill:!0,fillColor:[0,0,0],fillAlpha:.4},sunset:{edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:1,fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2},vectorscope:{edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2,vertices:!0,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:8,fill:!0,fillColor:[0,0,0],fillAlpha:.7},battlezone:{edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3,vertices:!1,vertexColor:[.8,1,.8],vertexAlpha:.9,vertexSize:8,fill:!0,fillColor:[0,0,0],fillAlpha:1},sepia:{edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4},yellowHighlight:{edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[1,1,0],fillAlpha:.5},greenSelected:{edges:!0,edgeColor:[.4577854573726654,.529411792755127,.4100345969200134],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[0,1,0],fillAlpha:.5},gamegrid:{edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9}},xeogl.GhostMaterial=xeogl.EmphasisMaterial}(),function(){"use strict";xeogl.EdgeMaterial=xeogl.Material.extend({type:"xeogl.EdgeMaterial",_init:function(e){this._super(e),this._state=new xeogl.renderer.State({type:"EdgeMaterial",edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",e.preset?(this.preset=e.preset,e.edgeColor&&(this.edgeColor=e.edgeColor),void 0!==e.edgeAlpha&&(this.edgeAlpha=e.edgeAlpha),void 0!==e.edgeWidth&&(this.edgeWidth=e.edgeWidth)):(this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth)},_props:{edgeColor:{set:function(e){var t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.edgeColor}},edgeAlpha:{set:function(e){e=void 0!==e&&null!==e?e:1,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this._renderer.imageDirty())},get:function(){return this._state.edgeAlpha}},edgeWidth:{set:function(e){this._state.edgeWidth=e||1,this._renderer.imageDirty()},get:function(){return this._state.edgeWidth}},preset:{set:function(e){if(e=e||"default",this._preset!==e){var t=xeogl.EdgeMaterial.presets[e];t?(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(xeogl.EdgeMaterial.presets).join(", "))}},get:function(){return this._preset}}},_destroy:function(){this._super(),this._state.destroy()}}),xeogl.EdgeMaterial.presets={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}}}(),function(){"use strict";xeogl.OutlineMaterial=xeogl.Material.extend({type:"xeogl.OutlineMaterial",_init:function(e){this._super(e),this._state=new xeogl.renderer.State({type:"OutlineMaterial",color:null,alpha:null,width:null}),this.color=e.color,this.alpha=e.alpha,this.width=e.width},_props:{color:{set:function(e){var t=this._state.color;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.color=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=.2,t[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.color}},alpha:{set:function(e){e=void 0!==e&&null!==e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this._renderer.imageDirty())},get:function(){return this._state.alpha}},width:{set:function(e){this._state.width=e||4,this._renderer.imageDirty()},get:function(){return this._state.width}}},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";xeogl.Texture=xeogl.Component.extend({type:"xeogl.Texture",_init:function(e){this._state=new xeogl.renderer.State({texture:new xeogl.renderer.Texture2D(this.scene.canvas.gl),matrix:xeogl.math.identityMat4(),hasMatrix:e.translate&&(0!==e.translate[0]||0!==e.translate[1])||!!e.rotate||e.scale&&(0!==e.scale[0]||0!==e.scale[1]),minFilter:this._checkMinFilter(e.minFilter),magFilter:this._checkMagFilter(e.minFilter),wrapS:this._checkWrapS(e.wrapS),wrapT:this._checkWrapT(e.wrapT),flipY:this._checkFlipY(e.flipY),encoding:this._checkEncoding(e.encoding)}),this._src=null,this._image=null,this._translate=xeogl.math.vec2([0,0]),this._scale=xeogl.math.vec2([1,1]),this._rotate=xeogl.math.vec2([0,0]),this._matrixDirty=!1,this.translate=e.translate,this.scale=e.scale,this.rotate=e.rotate,e.src?this.src=e.src:e.image&&(this.image=e.image),xeogl.stats.memory.textures++},_checkMinFilter:function(e){return"linear"!==(e=e||"linearMipmapLinear")&&"linearMipmapNearest"!==e&&"linearMipmapLinear"!==e&&"nearestMipmapLinear"!==e&&"nearestMipmapNearest"!==e&&(this.error("Unsupported value for 'minFilter': '"+e+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),e="linearMipmapLinear"),e},_checkMagFilter:function(e){return"linear"!==(e=e||"linear")&&"nearest"!==e&&(this.error("Unsupported value for 'magFilter': '"+e+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),e="linear"),e},_checkFilter:function(e){return"linear"!==(e=e||"linear")&&"nearest"!==e&&(this.error("Unsupported value for 'magFilter': '"+e+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),e="linear"),e},_checkWrapS:function(e){return"clampToEdge"!==(e=e||"repeat")&&"mirroredRepeat"!==e&&"repeat"!==e&&(this.error("Unsupported value for 'wrapS': '"+e+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),e="repeat"),e},_checkWrapT:function(e){return"clampToEdge"!==(e=e||"repeat")&&"mirroredRepeat"!==e&&"repeat"!==e&&(this.error("Unsupported value for 'wrapT': '"+e+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),e="repeat"),e},_checkFlipY:function(e){return!!e},_checkEncoding:function(e){return"linear"!==(e=e||"linear")&&"sRGB"!==e&&"gamma"!==e&&(this.error("Unsupported value for 'encoding': '"+e+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),e="linear"),e},_webglContextRestored:function(){this._state.texture=new xeogl.renderer.Texture2D(this.scene.canvas.gl),this._image?this.image=this._image:this._src&&(this.src=this._src)},_update:function(){var e,t,i=this._state;this._matrixDirty&&(0===this._translate[0]&&0===this._translate[1]||(e=xeogl.math.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),1===this._scale[0]&&1===this._scale[1]||(t=xeogl.math.scalingMat4v([this._scale[0],this._scale[1],1]),e=e?xeogl.math.mulMat4(e,t):t),0!==this._rotate&&(t=xeogl.math.rotationMat4v(.0174532925*this._rotate,[0,0,1]),e=e?xeogl.math.mulMat4(e,t):t),e&&(i.matrix=e),this._matrixDirty=!1);this._renderer.imageDirty()},_props:{image:{set:function(e){this._image=xeogl.renderer.ensureImageSizePowerOfTwo(e),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._state.texture.setProps(this._state),this._src=null,this._renderer.imageDirty()},get:function(){return this._image}},src:{set:function(e){this.scene.loading++,this.scene.canvas.spinner.processes++;var t=this,i=new Image;i.onload=function(){i=xeogl.renderer.ensureImageSizePowerOfTwo(i),t._state.texture.setImage(i,t._state),t._state.texture.setProps(t._state),t.scene.loading--,t.scene.canvas.spinner.processes--,t._renderer.imageDirty()},i.src=e,this._src=e,this._image=null},get:function(){return this._src}},translate:{set:function(e){this._translate.set(e||[0,0]),this._matrixDirty=!0,this._needUpdate()},get:function(){return this._translate}},scale:{set:function(e){this._scale.set(e||[1,1]),this._matrixDirty=!0,this._needUpdate()},get:function(){return this._scale}},rotate:{set:function(e){e=e||0,this._rotate!==e&&(this._rotate=e,this._matrixDirty=!0,this._needUpdate())},get:function(){return this._rotate}}},_destroy:function(){this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.Fresnel=xeogl.Component.extend({type:"xeogl.Fresnel",_init:function(e){this._state=new xeogl.renderer.State({edgeColor:xeogl.math.vec3([0,0,0]),centerColor:xeogl.math.vec3([1,1,1]),edgeBias:0,centerBias:1,power:1}),this.edgeColor=e.edgeColor,this.centerColor=e.centerColor,this.edgeBias=e.edgeBias,this.centerBias=e.centerBias,this.power=e.power},_props:{edgeColor:{set:function(e){this._state.edgeColor.set(e||[0,0,0]),this._renderer.imageDirty()},get:function(){return this._state.edgeColor}},centerColor:{set:function(e){this._state.centerColor.set(e||[1,1,1]),this._renderer.imageDirty()},get:function(){return this._state.centerColor}},edgeBias:{set:function(e){this._state.edgeBias=e||0,this._renderer.imageDirty()},get:function(){return this._state.edgeBias}},centerBias:{set:function(e){this._state.centerBias=void 0!==e&&null!==e?e:1,this._renderer.imageDirty()},get:function(){return this._state.centerBias}},power:{set:function(e){this._state.power=void 0!==e&&null!==e?e:1,this._renderer.imageDirty()},get:function(){return this._state.power}}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Viewport=xeogl.Component.extend({type:"xeogl.Viewport",_init:function(e){this._state=new xeogl.renderer.State({boundary:[0,0,100,100]}),this.boundary=e.boundary,this.autoBoundary=e.autoBoundary},_props:{boundary:{set:function(e){if(!this._autoBoundary){if(!e){var t=this.scene.canvas.boundary;e=[0,0,t[2],t[3]]}this._state.boundary=e,this._renderer.imageDirty(),this.fire("boundary",this._state.boundary)}},get:function(){return this._state.boundary}},autoBoundary:{set:function(e){(e=!!e)!==this._autoBoundary&&(this._autoBoundary=e,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",function(e){var t=e[2],i=e[3];this._state.boundary=[0,0,t,i],this._renderer.imageDirty(),this.fire("boundary",this._state.boundary)},this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))},get:function(){return this._autoBoundary}}},_getState:function(){return this._state}})}(),function(){"use strict";var e,t,i,s,r,a,n,o=xeogl.math,l=o.vec3(),h=o.vec3(),u=o.vec3(),c=o.vec3(),d=o.vec3(),p=o.vec3();xeogl.Camera=xeogl.Component.extend({type:"xeogl.Camera",_init:function(e){this._state=new xeogl.renderer.State({deviceMatrix:o.mat4(),hasDeviceMatrix:!1,matrix:o.mat4(),normalMatrix:o.mat4()}),this._perspective=new xeogl.Perspective(this),this._ortho=new xeogl.Ortho(this),this._frustum=new xeogl.Frustum(this),this._customProjection=new xeogl.CustomProjection(this),this._project=this._perspective;var t=this;this._eye=o.vec3([0,0,10]),this._look=o.vec3([0,0,0]),this._up=o.vec3([0,1,0]),this._worldUp=o.vec3([0,1,0]),this._worldRight=o.vec3([1,0,0]),this._worldForward=o.vec3([0,0,-1]),this.deviceMatrix=e.deviceMatrix,this.eye=e.eye,this.look=e.look,this.up=e.up,this.worldAxis=e.worldAxis,this.gimbalLock=e.gimbalLock,this.constrainPitch=e.constrainPitch,this.projection=e.projection,this._perspective.on("matrix",function(){"perspective"===t._projectionType&&t.fire("projMatrix",t._perspective.matrix)}),this._ortho.on("matrix",function(){"ortho"===t._projectionType&&t.fire("projMatrix",t._ortho.matrix)}),this._frustum.on("matrix",function(){"frustum"===t._projectionType&&t.fire("projMatrix",t._frustum.matrix)}),this._customProjection.on("matrix",function(){"customProjection"===t._projectionType&&t.fire("projMatrix",t._customProjection.matrix)})},_update:(i=o.vec3(),s=o.vec3(),r=o.vec3(),a=o.vec3(),n=o.mat4(),function(){var e,t=this._state;"ortho"===this.projection?(o.subVec3(this._eye,this._look,i),o.normalizeVec3(i,s),o.mulVec3Scalar(s,1e3,r),o.addVec3(this._look,r,a),e=a):e=this._eye,t.hasDeviceMatrix?(o.lookAtMat4v(e,this._look,this._up,n),o.mulMat4(t.deviceMatrix,n,t.matrix)):o.lookAtMat4v(e,this._look,this._up,t.matrix),o.inverseMat4(this._state.matrix,this._state.normalMatrix),o.transposeMat4(this._state.normalMatrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}),orbitYaw:(t=o.mat4(),function(e){var i=o.subVec3(this._eye,this._look,l);o.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,t),i=o.transformPoint3(t,i,h),this.eye=o.addVec3(this._look,i,u),this.up=o.transformPoint3(t,this._up,c)}),orbitPitch:function(){var e=o.mat4();return function(t){var i=o.subVec3(this._eye,this._look,l),s=o.cross3Vec3(o.normalizeVec3(i,h),o.normalizeVec3(this._up,u));o.rotationMat4v(.0174532925*t,s,e),i=o.transformPoint3(e,i,c);var r=o.transformPoint3(e,this._up,d);if(this._constrainPitch&&(t=o.dotVec3(r,this._worldUp)/o.DEGTORAD)<1)return;this.up=r,this.eye=o.addVec3(i,this._look,p)}}(),yaw:function(){var e=o.mat4();return function(t){var i=o.subVec3(this._look,this._eye,l);o.rotationMat4v(.0174532925*t,this._gimbalLock?this._worldUp:this._up,e),i=o.transformPoint3(e,i,h),this.look=o.addVec3(i,this._eye,u),this._gimbalLock&&(this.up=o.transformPoint3(e,this._up,c))}}(),pitch:function(){var e=o.mat4();return function(t){var i=o.subVec3(this._look,this._eye,l),s=o.cross3Vec3(o.normalizeVec3(i,h),o.normalizeVec3(this._up,u));o.rotationMat4v(.0174532925*t,s,e);var r=o.transformPoint3(e,this._up,p);if(this._constrainPitch&&(t=o.dotVec3(r,this._worldUp)/o.DEGTORAD)<1)return;this.up=r,i=o.transformPoint3(e,i,c),this.look=o.addVec3(i,this._eye,d)}}(),pan:function(e){var t,i=o.subVec3(this._eye,this._look,l),s=[0,0,0];if(0!==e[0]){var r=o.cross3Vec3(o.normalizeVec3(i,[]),o.normalizeVec3(this._up,h));t=o.mulVec3Scalar(r,e[0]),s[0]+=t[0],s[1]+=t[1],s[2]+=t[2]}0!==e[1]&&(t=o.mulVec3Scalar(o.normalizeVec3(this._up,u),e[1]),s[0]+=t[0],s[1]+=t[1],s[2]+=t[2]),0!==e[2]&&(t=o.mulVec3Scalar(o.normalizeVec3(i,c),e[2]),s[0]+=t[0],s[1]+=t[1],s[2]+=t[2]),this.eye=o.addVec3(this._eye,s,d),this.look=o.addVec3(this._look,s,p)},zoom:function(e){var t=o.subVec3(this._eye,this._look,l),i=Math.abs(o.lenVec3(t,h)),s=Math.abs(i+e);if(!(s<.5)){var r=o.normalizeVec3(t,u);this.eye=o.addVec3(this._look,o.mulVec3Scalar(r,s),c)}},_props:{eye:{set:function(e){this._eye.set(e||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)},get:function(){return this._eye}},look:{set:function(e){this._look.set(e||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)},get:function(){return this._look}},up:{set:function(e){this._up.set(e||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)},get:function(){return this._up}},deviceMatrix:{set:function(e){this._state.deviceMatrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!e,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)},get:function(){return this._state.deviceMatrix}},worldAxis:{set:function(e){e=e||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(e):this._worldAxis=new Float32Array(e),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)},get:function(){return this._worldAxis}},worldUp:{get:function(){return this._worldUp}},worldRight:{get:function(){return this._worldRight}},worldForward:{get:function(){return this._worldForward}},gimbalLock:{set:function(e){this._gimbalLock=!1!==e,this.fire("gimbalLock",this._gimbalLock)},get:function(){return this._gimbalLock}},constrainPitch:{set:function(e){this._constrainPitch=!!e,this.fire("constrainPitch",this._constrainPitch)},get:function(){return this._constrainPitch}},eyeLookDist:{get:(e=new Float32Array(3),function(){return o.lenVec3(o.subVec3(this._look,this._eye,e))})},matrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},viewMatrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},normalMatrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}},viewNormalMatrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}},projMatrix:{get:function(){return this[this.projection].matrix}},perspective:{get:function(){return this._perspective}},ortho:{get:function(){return this._ortho}},frustum:{get:function(){return this._frustum}},customProjection:{get:function(){return this._customProjection}},projection:{set:function(e){e=e||"perspective",this._projectionType!==e&&("perspective"===e?this._project=this._perspective:"ortho"===e?this._project=this._ortho:"frustum"===e?this._project=this._frustum:"customProjection"===e?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+e+" defaulting to 'perspective'"),this._project=this._perspective,e="perspective"),this._projectionType=e,this._renderer.imageDirty(),this._update(),this.fire("dirty"))},get:function(){return this._projectionType}},project:{get:function(){return this._project}},view:{get:function(){return this}}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Frustum=xeogl.Component.extend({type:"xeogl.Frustum",_init:function(e){this._state=new xeogl.renderer.State({matrix:xeogl.math.mat4()}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._near=.1,this._far=5e3,this.left=e.left,this.right=e.right,this.bottom=e.bottom,this.top=e.top,this.near=e.near,this.far=e.far},_update:function(){xeogl.math.frustumMat4(this._left,this._right,this._bottom,this._top,this._near,this._far,this._state.matrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix)},_props:{left:{set:function(e){this._left=void 0!==e&&null!==e?e:-1,this._needUpdate(),this.fire("left",this._left)},get:function(){return this._left}},right:{set:function(e){this._right=void 0!==e&&null!==e?e:1,this._needUpdate(),this.fire("right",this._right)},get:function(){return this._right}},top:{set:function(e){this._top=void 0!==e&&null!==e?e:1,this._needUpdate(),this.fire("top",this._top)},get:function(){return this._top}},bottom:{set:function(e){this._bottom=void 0!==e&&null!==e?e:-1,this._needUpdate(),this.fire("bottom",this._bottom)},get:function(){return this._bottom}},near:{set:function(e){this._near=void 0!==e&&null!==e?e:.1,this._needUpdate(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(e){this._far=void 0!==e&&null!==e?e:1e4,this._needUpdate(),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Ortho=xeogl.Component.extend({type:"xeogl.Ortho",_init:function(e){this._state=new xeogl.renderer.State({matrix:xeogl.math.mat4()}),this.scale=e.scale,this.near=e.near,this.far=e.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)},_update:function(){var e,t,i,s,r=this.scene,a=.5*this._scale,n=r.viewport.boundary,o=n[2],l=n[3],h=o/l;o>l?(e=-a,t=a,i=a/h,s=-a/h):(e=-a*h,t=a*h,i=a,s=-a),xeogl.math.orthoMat4c(e,t,s,i,this._near,this._far,this._state.matrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix)},_props:{scale:{set:function(e){void 0!==e&&null!==e||(e=1),e<=0&&(e=.01),this._scale=e,this._needUpdate(),this.fire("scale",this._scale)},get:function(){return this._scale}},near:{set:function(e){this._near=void 0!==e&&null!==e?e:.1,this._needUpdate(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(e){this._far=void 0!==e&&null!==e?e:1e4,this._needUpdate(),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}}},_destroy:function(){this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}})}(),function(){"use strict";xeogl.Perspective=xeogl.Component.extend({type:"xeogl.Perspective",_init:function(e){this._state=new xeogl.renderer.State({matrix:xeogl.math.mat4()}),this._dirty=!1,this._fov=60,this._near=.1,this._far=1e4,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=e.fov,this.fovAxis=e.fovAxis,this.near=e.near,this.far=e.far},_update:function(){var e=this.scene.viewport.boundary,t=e[2]/e[3],i=this._fov,s=this._fovAxis;("x"==s||"min"==s&&t<1||"max"==s&&t>1)&&(i/=t),i=Math.min(i,120),xeogl.math.perspectiveMat4(i*(Math.PI/180),t,this._near,this._far,this._state.matrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix)},_props:{fov:{set:function(e){this._fov=void 0!==e&&null!==e?e:60,this._needUpdate(0),this.fire("fov",this._fov)},get:function(){return this._fov}},fovAxis:{set:function(e){e=e||"min",this._fovAxis!==e&&("x"!==e&&"y"!==e&&"min"!==e&&(this.error("Unsupported value for 'fovAxis': "+e+" - defaulting to 'min'"),e="min"),this._fovAxis=e,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))},get:function(){return this._fovAxis}},near:{set:function(e){this._near=void 0!==e&&null!==e?e:.1,this._needUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(e){this._far=void 0!==e&&null!==e?e:1e4,this._needUpdate(0),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}}},_destroy:function(){this._state.destroy(),this.scene.canvas.off(this._canvasResized)}})}(),function(){"use strict";xeogl.CustomProjection=xeogl.Component.extend({type:"xeogl.CustomProjection",_init:function(e){this._state=new xeogl.renderer.State({matrix:xeogl.math.mat4()}),this.matrix=e.matrix},_props:{matrix:{set:function(e){this._state.matrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.fire("far",this._state.matrix)},get:function(){return this._state.matrix}}},_destroy:function(){this._state.destroy()}})}(),xeogl.version="0.8.0";